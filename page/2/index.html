<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="MineTing">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="MineTing">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Fei">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>MineTing</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">MineTing</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/17/Redis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MineTing">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/17/Redis/" class="post-title-link" itemprop="url">Redis</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-17 00:00:00" itemprop="dateCreated datePublished" datetime="2023-03-17T00:00:00+08:00">2023-03-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-22 16:31:15" itemprop="dateModified" datetime="2023-03-22T16:31:15+08:00">2023-03-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <div align="center"><font size="70"><b>Redis</b></font></div>

<h1 id="NSQL-概述"><a href="#NSQL-概述" class="headerlink" title="NSQL 概述"></a>NSQL 概述</h1><h2 id="技术发展"><a href="#技术发展" class="headerlink" title="技术发展"></a>技术发展</h2><p>技术的分类</p>
<ol>
<li><p>解决功能性的问题：Java、Jsp、RDBMS、Tomcat、HTML、Linux、JDBC、SVN</p>
</li>
<li><p>解决扩展性的问题：Struts、Spring、SpringMVC、Hibernate、Mybatis</p>
</li>
<li><p>解决性能的问题：NoSQL、Java线程、Hadoop、Nginx、MQ、ElasticSearchs</p>
</li>
</ol>
<h3 id="Web1-0-时代"><a href="#Web1-0-时代" class="headerlink" title="Web1.0 时代"></a>Web1.0 时代</h3><p>​		Web1.0的时代，数据访问量很有限，用一夫当关的高性能的单点服务器可以解决大部分问题。</p>
<h3 id="Web2-0-时代"><a href="#Web2-0-时代" class="headerlink" title="Web2.0 时代"></a><strong>Web2.0</strong> 时代</h3><p>​		随着 Web2.0 的时代的到来，用户访问量大幅度提升，同时产生了大量的用户数据。加上后来的智能移动设备的普及，所有的互联网平台都面临了巨大的性能挑战。</p>
<h3 id="解决CPU及内存压力"><a href="#解决CPU及内存压力" class="headerlink" title="解决CPU及内存压力"></a><strong>解决CPU及内存压力</strong></h3><img src="/2023/03/17/Redis/Java\Document\Redis\Redis.assets\image-20221009000626519.png" alt="image-20221009000626519" style="zoom:80%;">

<h3 id="解决IO压力"><a href="#解决IO压力" class="headerlink" title="解决IO压力"></a><strong>解决IO压力</strong></h3><img src="/2023/03/17/Redis/Java\Document\Redis\Redis.assets\image-20221009000730414.png" alt="image-20221009000730414" style="zoom:80%;">

<h2 id="NoSQL数据库"><a href="#NoSQL数据库" class="headerlink" title="NoSQL数据库"></a>NoSQL数据库</h2><p>NoSQL（NoSQL &#x3D; <strong>Not Only SQL</strong> ），意即“不仅仅是SQL”，泛指<strong>非关系型的数据库</strong>。 </p>
<p>NoSQL 不依赖业务逻辑方式存储，而以简单的key-value模式存储。因此大大的增加了数据库的扩展能力。</p>
<ul>
<li>不遵循SQL标准。</li>
<li>不支持ACID。</li>
<li>远超于SQL的性能。</li>
</ul>
<h3 id="NoSQL适用场景"><a href="#NoSQL适用场景" class="headerlink" title="NoSQL适用场景"></a>NoSQL适用场景</h3><ul>
<li>对数据高并发的读写</li>
<li>海量数据的读写</li>
<li>对数据高可扩展性的</li>
</ul>
<h3 id="NoSQL不适用场景"><a href="#NoSQL不适用场景" class="headerlink" title="NoSQL不适用场景"></a>NoSQL不适用场景</h3><ul>
<li>需要事务支持</li>
<li>基于sql的结构化查询存储，处理复杂的关系，需要即席查询（用不着sql的和用了sql也不行的情况，请考虑用NoSql）</li>
</ul>
<h3 id="Memcache"><a href="#Memcache" class="headerlink" title="Memcache"></a>Memcache</h3><ol>
<li>数据都在内存中，一般不持久化</li>
<li>支持简单的 key-value 模式，支持类型单一</li>
<li>一般是作为缓存数据库辅助持久化的数据库</li>
</ol>
<h3 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h3><ol>
<li>几乎覆盖了Memcached的绝大部分功能</li>
<li>数据都在内存中，支持持久化，主要用作备份恢复</li>
<li>除了支持简单的key-value模式，还支持多种数据结构的存储，比如 list、set、hash、zset等。</li>
<li>一般是作为缓存数据库辅助持久化的数据库</li>
</ol>
<h3 id="MongoDB"><a href="#MongoDB" class="headerlink" title="MongoDB"></a>MongoDB</h3><ol>
<li>高性能、开源、模式自由(schema free)的<strong>文档型数据库</strong></li>
<li>数据都在内存中， 如果内存不足，把不常用的数据保存到硬盘</li>
<li>虽然是key-value模式，但是对value（尤其是<strong>json</strong>）提供了丰富的查询功能</li>
<li>支持二进制数据及大型对象</li>
<li>可以根据数据的特点<strong>替代RDBMS</strong> ，成为独立的数据库。或者配合RDBMS，存储特定的数据。</li>
</ol>
<h2 id="行式存储数据库（大数据时代）"><a href="#行式存储数据库（大数据时代）" class="headerlink" title="行式存储数据库（大数据时代）"></a><strong>行式存储数据库（大数据时代）</strong></h2><h3 id="行式数据库"><a href="#行式数据库" class="headerlink" title="行式数据库"></a><strong>行式数据库</strong></h3><img src="/2023/03/17/Redis/Java\Document\Redis\Redis.assets\image-20221009001250886.png" alt="image-20221009001250886" style="zoom:80%;">

<h3 id="列式数据库"><a href="#列式数据库" class="headerlink" title="列式数据库"></a><strong>列式数据库</strong></h3><img src="/2023/03/17/Redis/Java\Document\Redis\Redis.assets\image-20221009001329709.png" alt="image-20221009001329709" style="zoom:80%;">

<h3 id="Hbase"><a href="#Hbase" class="headerlink" title="Hbase"></a><strong>Hbase</strong></h3><p>HBase 是 <strong>Hadoop</strong> 项目中的数据库。它用于需要对大量的数据进行随机、实时的读写操作的场景中。</p>
<p>HBase 的目标就是处理数据量<strong>非常庞大</strong>的表，可以用<strong>普通的计算机</strong>处理超过<strong>10</strong>亿行数据<strong>，还可处理有数百万</strong>列元素的数据表。</p>
<h2 id="图关系型数据库"><a href="#图关系型数据库" class="headerlink" title="图关系型数据库"></a><strong>图关系型数据库</strong></h2><p>主要应用：社会关系，公共交通网络，地图及网络拓谱(n*(n-1)&#x2F;2)</p>
<h2 id="DB-Engines-数据库排名"><a href="#DB-Engines-数据库排名" class="headerlink" title="DB-Engines 数据库排名"></a><strong>DB-Engines</strong> <strong>数据库排名</strong></h2><blockquote>
<p><a target="_blank" rel="noopener" href="http://db-engines.com/en/ranking"><strong>http://db-engines.com/en/ranking</strong></a></p>
</blockquote>
<h1 id="Redis概述"><a href="#Redis概述" class="headerlink" title="Redis概述"></a>Redis概述</h1><p>官网地址：<a target="_blank" rel="noopener" href="http://redis.io/"><strong>http://redis.io</strong></a></p>
<p>中文地址：<a target="_blank" rel="noopener" href="http://redis.cn/">http://redis.cn/</a></p>
<h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><ol>
<li><p><strong>配合关系型数据库做高速缓存</strong></p>
<p> 高频次，热门访问的数据，降低数据库IO</p>
<p> 分布式架构，做session共享</p>
</li>
<li><p><strong>多样的数据结构存储持久化数据</strong></p>
<p> 最新N个数据：通过List实现按自然时间排序的数据</p>
<p> 排行榜，TopN：利用 zset 有序集合</p>
<p> 时效性的数据，如：手机验证码：Expire 过期</p>
<p> 计数器，秒杀：原子性，自增方法INCRE、DECRE</p>
<p> 取出大量数据中的重复数据：利用 Set 集合</p>
<p> 构建队列：利用 List 集合</p>
<p> 发布订阅系统：pub&#x2F;sub模式</p>
</li>
</ol>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p><img src="/2023/03/17/Redis/Java\Document\Redis\Redis.assets\image-20220513090502331.png" alt="image-20220513090502331"></p>
<p>安装版本：redis-6.2.1.tar.gz</p>
<h3 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h3><ol>
<li><p>安装 gcc编译器</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost /]# yum install -y centos-release-scl scl-utils-build</span><br><span class="line">[root@localhost /]# yum install -y devtoolset-8-toolchain</span><br><span class="line">[root@localhost /]# scl enable devtoolset-8 bash</span><br><span class="line">[root@localhost /]# gcc --version</span><br><span class="line">gcc (GCC) 8.3.1 20190311 (Red Hat 8.3.1-3)</span><br><span class="line">Copyright (C) 2018 Free Software Foundation, Inc.</span><br><span class="line">This is free software; see the source for copying conditions.  There is NO</span><br><span class="line">warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span><br></pre></td></tr></table></figure>
</li>
<li><p>下载 redis-6.2.1.tar.gz 放在 &#x2F;opt 目录并解压</p>
</li>
<li><p>进入 <strong>redis-6.2.1</strong>目录使用 make 编译</p>
</li>
<li><p><strong>跳过make test 继续执行: make install</strong></p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost redis]# cd /opt/redis</span><br><span class="line">[root@localhost redis]# tar -zxvf redis-6.2.1.tar.gz</span><br><span class="line">[root@localhost redis]# ls</span><br><span class="line">redis-6.2.1  redis-6.2.1.tar.gz</span><br><span class="line">[root@localhost redis]# cd redis-6.2.1</span><br><span class="line">[root@localhost redis-6.2.1]# make &amp;&amp; make install</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>如果报错</p>
<p> <strong>如果没有准备好C语言编译环境，make 会报错—Jemalloc&#x2F;jemalloc.h：没有那个文件</strong></p>
<p> 解决方案：<strong>运行 make distclean</strong>，<strong>再次执行make命令</strong></p>
</li>
</ol>
<h3 id="安装目录：-x2F-usr-x2F-local-x2F-bin"><a href="#安装目录：-x2F-usr-x2F-local-x2F-bin" class="headerlink" title="安装目录：&#x2F;usr&#x2F;local&#x2F;bin"></a>安装目录：&#x2F;usr&#x2F;local&#x2F;bin</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost redis-6.2.1]# ll /usr/local/bin</span><br><span class="line">总用量 19136</span><br><span class="line">-rwxr-xr-x. 1 root root 4833352 5月  13 09:20 redis-benchmark</span><br><span class="line">lrwxrwxrwx. 1 root root      12 5月  13 09:20 redis-check-aof -&gt; redis-server</span><br><span class="line">lrwxrwxrwx. 1 root root      12 5月  13 09:20 redis-check-rdb -&gt; redis-server</span><br><span class="line">-rwxr-xr-x. 1 root root 5003368 5月  13 09:20 redis-cli</span><br><span class="line">lrwxrwxrwx. 1 root root      12 5月  13 09:20 redis-sentinel -&gt; redis-server</span><br><span class="line">-rwxr-xr-x. 1 root root 9450208 5月  13 09:20 redis-server</span><br></pre></td></tr></table></figure>

<p>查看默认安装目录：</p>
<ol>
<li>redis-benchmark：性能测试工具</li>
<li>redis-check-aof：修复有问题的AOF文件</li>
<li>redis-check-dump：修复有问题的dump.rdb文件</li>
<li>redis-sentinel：Redis集群使用</li>
<li>redis-server：Redis服务器启动命令</li>
<li>redis-cli：客户端工具</li>
</ol>
<p><strong>对于 &#x2F;usr&#x2F;local&#x2F;bin 目录说明</strong></p>
<p>该目录下的可执行命令已经作为环境变量而存在，可以直接使用。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost nginx]# echo $PATH</span><br><span class="line">/usr/local/nginx/sbin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin</span><br></pre></td></tr></table></figure>



<h3 id="前台启动"><a href="#前台启动" class="headerlink" title="前台启动"></a>前台启动</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost redis-6.2.1]# cd /usr/local/bin</span><br><span class="line">[root@localhost bin]# ./redis-server</span><br><span class="line">97713:C 13 May 2022 09:22:05.617 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span><br><span class="line">97713:C 13 May 2022 09:22:05.617 # Redis version=6.2.1, bits=64, commit=00000000, modified=0, pid=97713, just started</span><br><span class="line">97713:C 13 May 2022 09:22:05.617 # Warning: no config file specified, using the default config. In order to specify a config file use ./redis-server /path/to/redis.conf</span><br><span class="line">97713:M 13 May 2022 09:22:05.618 * Increased maximum number of open files to 10032 (it was originally set to 1024).</span><br><span class="line">97713:M 13 May 2022 09:22:05.618 * monotonic clock: POSIX clock_gettime</span><br><span class="line">                _._</span><br><span class="line">           _.-``__ &#x27;&#x27;-._</span><br><span class="line">      _.-``    `.  `_.  &#x27;&#x27;-._           Redis 6.2.1 (00000000/0) 64 bit</span><br><span class="line">  .-`` .-```.  ```\/    _.,_ &#x27;&#x27;-._</span><br><span class="line"> (    &#x27;      ,       .-`  | `,    )     Running in standalone mode</span><br><span class="line"> |`-._`-...-` __...-.``-._|&#x27;` _.-&#x27;|     Port: 6379</span><br><span class="line"> |    `-._   `._    /     _.-&#x27;    |     PID: 97713</span><br><span class="line">  `-._    `-._  `-./  _.-&#x27;    _.-&#x27;</span><br><span class="line"> |`-._`-._    `-.__.-&#x27;    _.-&#x27;_.-&#x27;|</span><br><span class="line"> |    `-._`-._        _.-&#x27;_.-&#x27;    |           http://redis.io</span><br><span class="line">  `-._    `-._`-.__.-&#x27;_.-&#x27;    _.-&#x27;</span><br><span class="line"> |`-._`-._    `-.__.-&#x27;    _.-&#x27;_.-&#x27;|</span><br><span class="line"> |    `-._`-._        _.-&#x27;_.-&#x27;    |</span><br><span class="line">  `-._    `-._`-.__.-&#x27;_.-&#x27;    _.-&#x27;</span><br><span class="line">      `-._    `-.__.-&#x27;    _.-&#x27;</span><br><span class="line">          `-._        _.-&#x27;</span><br><span class="line">              `-.__.-&#x27;</span><br><span class="line"></span><br><span class="line">97713:M 13 May 2022 09:22:05.621 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span><br><span class="line">97713:M 13 May 2022 09:22:05.621 # Server initialized</span><br><span class="line">97713:M 13 May 2022 09:22:05.621 # WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add &#x27;vm.overcommit_memory = 1&#x27; to /etc/sysctl.conf and then reboot or run the command &#x27;sysctl vm.overcommit_memory=1&#x27; for this to take effect.</span><br><span class="line">97713:M 13 May 2022 09:22:05.621 * Ready to accept connections</span><br><span class="line">^C97713:signal-handler (1652404933) Received SIGINT scheduling shutdown...</span><br><span class="line">97713:M 13 May 2022 09:22:13.266 # User requested shutdown...</span><br><span class="line">97713:M 13 May 2022 09:22:13.266 * Saving the final RDB snapshot before exiting.</span><br><span class="line">97713:M 13 May 2022 09:22:13.271 * DB saved on disk</span><br><span class="line">97713:M 13 May 2022 09:22:13.271 # Redis is now ready to exit, bye bye...</span><br></pre></td></tr></table></figure>

<h3 id="后台启动"><a href="#后台启动" class="headerlink" title="后台启动"></a>后台启动</h3><p>备份 redis.conf，或者拷贝到 &#x2F;etc 等其他目录中。</p>
<p><strong>后台启动设置daemonize no改成yes</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost bin]# cp /opt/redis-6.2.1/redis.conf /etc</span><br><span class="line">[root@localhost bin]# vim /etc/redis.conf</span><br><span class="line">[root@localhost bin]# redis-server /etc/redis.conf</span><br><span class="line">[root@localhost bin]# ps -ef |grep redis</span><br><span class="line">root      97843      1  0 09:30 ?        00:00:00 redis-server 127.0.0.1:6379</span><br><span class="line">root      97849  93182  0 09:30 pts/1    00:00:00 grep --color=auto redis</span><br><span class="line">[root@localhost ~]# ps -aux|grep redis|grep -v grep</span><br><span class="line">root      18370  0.4  0.2 162540  2644 ?        Ssl  12:26   0:00 redis-server 127.0.0.1:6379</span><br></pre></td></tr></table></figure>

<p>多个端口启动可以：redis-cli -p6379</p>
<h3 id="客户端远程连接"><a href="#客户端远程连接" class="headerlink" title="客户端远程连接"></a>客户端远程连接</h3><p>禁用 Linux 的防火墙：Linux(CentOS7) 里执行命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop/disable firewalld.service</span><br></pre></td></tr></table></figure>

<p>或者开放端口 6379</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看开放的端口号</span></span><br><span class="line">firewall-cmd --list-all</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置开放的端口号</span></span><br><span class="line">firewall-cmd --add-service=redis --permanent</span><br><span class="line">firewall-cmd --add-port=6379/tcp --permanent</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启防火墙</span></span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<p>redis.conf 中注释掉 bind 127.0.0.1，并且设置： protected-mode no</p>
<p>【<strong>改配置前必须关掉 redis，否则不生效</strong>】</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-DENIED Redis is running in protected mode because protected mode is enabled, no bind address was specified, no authentication password is requested to clients. In this mode connections are only accepted from the loopback interface. If you want to connect from external computers to Redis you may adopt one of the following solutions: </span><br><span class="line">1) Just disable protected mode sending the command &#x27;CONFIG SET protected-mode no&#x27; from the loopback interface by connecting to Redis from the same host the server is running, however MAKE SURE Redis is not publicly accessible from internet if you do so. Use CONFIG REWRITE to make this change permanent. </span><br><span class="line">2) Alternatively you can just disable the protected mode by editing the Redis configuration file, and setting the protected mode option to &#x27;no&#x27;, and then restarting the server. </span><br><span class="line">3) If you started the server manually just for testing, restart it with the &#x27;--protected-mode no&#x27; option. </span><br><span class="line">4) Setup a bind address or an authentication password. </span><br><span class="line">NOTE: You only need to do one of the above things in order for the server to start accepting connections from the outside. </span><br></pre></td></tr></table></figure>

<p>使用客户端工具 redis-cli 访问</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost bin]# redis-cli</span><br><span class="line">127.0.0.1:6379&gt; ping</span><br><span class="line">PONG</span><br></pre></td></tr></table></figure>

<h3 id="关闭连接"><a href="#关闭连接" class="headerlink" title="关闭连接"></a>关闭连接</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">redis-cli shutdown</span></span><br><span class="line">[root@localhost bin]# ps -ef |grep redis|grep -v grep</span><br><span class="line">root      97843      1  0 09:30 ?        00:00:00 redis-server 127.0.0.1:6379</span><br><span class="line">[root@localhost bin]# redis-cli shutdown</span><br><span class="line">[root@localhost bin]# ps -ef |grep redis</span><br><span class="line">root      97884  93182  0 09:33 pts/1    00:00:00 grep --color=auto redis</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Redis相关知识"><a href="#Redis相关知识" class="headerlink" title="Redis相关知识"></a>Redis相关知识</h2><p>​		端口6379：Alessia  Merz</p>
<ol>
<li>默认16个数据库，类似数组下标从0开始，初始默认使用0号库</li>
<li>使用命令 select  <dbid>来切换数据库。如: select 8 </dbid></li>
<li>统一密码管理，所有库同样密码。</li>
<li>dbsize 查看当前数据库的 key 的数量</li>
<li>flushdb 清空当前库</li>
<li>flushall 通杀全部库</li>
</ol>
<p><strong>Redis是单线程 + 多路IO复用技术</strong></p>
<p>​		多路复用是指使用一个线程来检查多个文件描述符（Socket）的就绪状态，比如调用select和poll函数，传入多个文件描述符，如果有一个文件描述符就绪，则返回，否则阻塞直到超时。得到就绪状态后进行真正的操作可以在同一个线程里执行，也可以启动线程执行（比如使用线程池）</p>
<p>串行  vs  多线程+锁（memcached） vs  单线程+多路IO复用（Redis）</p>
<p>（与Memcache三点不同：支持多数据类型，支持持久化，单线程+多路IO复用）</p>
<h1 id="常用五大数据类型"><a href="#常用五大数据类型" class="headerlink" title="常用五大数据类型"></a><strong>常用五大数据类型</strong></h1><p>redis常见数据类型操作命令：<a target="_blank" rel="noopener" href="http://www.redis.cn/commands.html">http://www.redis.cn/commands.html</a></p>
<h2 id="Redis键（key）"><a href="#Redis键（key）" class="headerlink" title="Redis键（key）"></a><strong>Redis键（key）</strong></h2><ol>
<li><p>keys * 查看当前库所有key  (匹配：keys * 1)，*** 作为通配符存在。**</p>
</li>
<li><p>exists key 判断某个key是否存在</p>
</li>
<li><p>type key 查看你的key是什么类型</p>
</li>
<li><p>del key    删除指定的key数据</p>
</li>
<li><p>unlink key  根据value选择非阻塞删除</p>
<p> 仅将keys从keyspace元数据中删除，真正的删除会在后续异步操作。</p>
</li>
<li><p>expire key 10  10秒钟：为给定的key设置过期时间</p>
</li>
<li><p>ttl key 查看还有多少秒过期，-1表示永不过期，-2表示已过期</p>
</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set k1 v1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set k2 v2</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set k3 v3</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) &quot;k3&quot;</span><br><span class="line">2) &quot;k2&quot;</span><br><span class="line">3) &quot;k1&quot;</span><br><span class="line">127.0.0.1:6379&gt; dbsize</span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:6379&gt; exists k2</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; type k1</span><br><span class="line">string</span><br><span class="line">127.0.0.1:6379&gt; expire k3 10</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; ttl k3</span><br><span class="line">(integer) 7</span><br><span class="line">127.0.0.1:6379&gt; ttl k3</span><br><span class="line">(integer) 4</span><br><span class="line">127.0.0.1:6379&gt; ttl k3</span><br><span class="line">(integer) -2</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) &quot;k2&quot;</span><br><span class="line">2) &quot;k1&quot;</span><br><span class="line">127.0.0.1:6379&gt; del k2</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) &quot;k1&quot;</span><br></pre></td></tr></table></figure>



<h2 id="Redis字符串-String"><a href="#Redis字符串-String" class="headerlink" title="Redis字符串**(String)**"></a><strong>Redis</strong>字符串**(String)**</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>String 是 Redis 最基本的类型，你可以理解成与 Memcached 一模一样的类型，一个 key 对应一个 value。</p>
<p>String 类型是二进制安全的。意味着 Redis 的 String 可以包含任何数据。比如 jpg 图片或者序列化的对象。</p>
<p>String 类型是 Redis 最基本的数据类型，一个 Redis 中字符串 value 最多可以是512M</p>
<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><ol>
<li>set  <key><value>添加键值对</value></key></li>
</ol>
<ul>
<li><p>*NX：当数据库中key不存在时，可以将key-value添加数据库</p>
</li>
<li><p>*XX：当数据库中key存在时，可以将key-value添加数据库，与NX参数互斥</p>
</li>
<li><p>*EX：key的超时秒数，setex k2 10 v2</p>
</li>
<li><p>*PX：key的超时毫秒数，与EX互斥</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> <span class="keyword">set</span> k1 v1</span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> setnx k1 v11</span><br><span class="line">(<span class="type">integer</span>) <span class="number">0</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> setex k2 <span class="number">10</span> v2</span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> ttl k2</span><br><span class="line">(<span class="type">integer</span>) <span class="number">7</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> ttl k2</span><br><span class="line">(<span class="type">integer</span>) <span class="number">3</span></span><br></pre></td></tr></table></figure></li>
</ul>
<ol start="2">
<li><p>get  <key>查询对应键值</key></p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> <span class="keyword">get</span> k1</span><br><span class="line">&quot;v1&quot;</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> <span class="keyword">get</span> k2</span><br><span class="line">(nil)</span><br></pre></td></tr></table></figure>
</li>
<li><p>append <key><value>将给定的<value> 追加到原值的末尾</value></value></key></p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> append k1 v1v1</span><br><span class="line">(<span class="type">integer</span>) <span class="number">6</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> <span class="keyword">get</span> k1</span><br><span class="line">&quot;v1v1v1&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>strlen <key>获得值的长度</key></p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> strlen k1</span><br><span class="line">(<span class="type">integer</span>) <span class="number">6</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>setnx <key><value>只有在 key 不存在时  设置 key 的值</value></key></p>
</li>
<li><p>incr <key>  将 key 中储存的数字值增1，只能对数字值操作，如果为空，新增值为 1</key></p>
</li>
<li><p>decr <key> 将 key 中储存的数字值减1，只能对数字值操作，如果为空，新增值为 -1</key></p>
</li>
<li><p>incrby &#x2F; decrby <key>&lt;步长&gt; 将 key 中储存的数字值增减。自定义步长。</key></p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> <span class="keyword">get</span> k1</span><br><span class="line">v1</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> incr k1</span><br><span class="line">(error) ERR <span class="keyword">value</span> <span class="keyword">is</span> <span class="keyword">not</span> an <span class="type">integer</span> <span class="keyword">or</span> <span class="keyword">out</span> <span class="keyword">of</span> <span class="keyword">range</span></span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> <span class="keyword">set</span> k2 <span class="number">2</span></span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> incr k2</span><br><span class="line">(<span class="type">integer</span>) <span class="number">3</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> incr k2</span><br><span class="line">(<span class="type">integer</span>) <span class="number">4</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> <span class="keyword">get</span> k2</span><br><span class="line">&quot;4&quot;</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> decr k2</span><br><span class="line">(<span class="type">integer</span>) <span class="number">3</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> incrby k2 <span class="number">3</span></span><br><span class="line">(<span class="type">integer</span>) <span class="number">6</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> incrby k2 <span class="number">3</span></span><br><span class="line">(<span class="type">integer</span>) <span class="number">9</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> decrby k2 <span class="number">1</span></span><br><span class="line">(<span class="type">integer</span>) <span class="number">8</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> <span class="keyword">get</span> k2</span><br><span class="line">&quot;8&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>mset <key1><value1><key2><value2>  同时设置一个或多个 key-value对 </value2></key2></value1></key1></p>
</li>
<li><p>mget <key1><key2><key3>  同时获取一个或多个 value </key3></key2></key1></p>
</li>
<li><p>msetnx <key1><value1><key2><value2>  同时设置一个或多个 key-value 对，当且仅当所有给定 key 都不存在。</value2></key2></value1></key1></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> mset k1 v1 k2 v2</span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> mget k1 k2</span><br><span class="line"><span class="number">1</span>) &quot;v1&quot;</span><br><span class="line"><span class="number">2</span>) &quot;v2&quot;</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> msetnx k3 v3 k4 v4</span><br><span class="line">(<span class="type">integer</span>) <span class="number">1</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> msetnx k3 k33 k5 v5</span><br><span class="line">(<span class="type">integer</span>) <span class="number">0</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> <span class="keyword">get</span> k5</span><br><span class="line">(nil)</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>原子性，有一个失败则都失败</strong></p>
<ol start="12">
<li><p>getrange <key>&lt;起始位置&gt;&lt;结束位置&gt;  获得值的范围，类似 substring，<strong>前包，后包</strong></key></p>
</li>
<li><p>setrange <key>&lt;起始位置&gt;<value> 用 <value> 覆写<key>所储存的字符串值，从&lt;起始位置&gt;开始（索引从0开始）。</key></value></value></key></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> <span class="keyword">set</span> k1 abcdefg</span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> getrange k1 <span class="number">2</span> <span class="number">4</span></span><br><span class="line">&quot;cde&quot;</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> setrange k1 <span class="number">1</span> xxx</span><br><span class="line">(<span class="type">integer</span>) <span class="number">7</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> <span class="keyword">get</span> k1</span><br><span class="line">&quot;axxxefg&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>setex <key>&lt;过期时间&gt;<value> 设置键值的同时，设置过期时间，单位秒。</value></key></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> setex k2 <span class="number">10</span> v2</span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> ttl k2</span><br><span class="line">(<span class="type">integer</span>) <span class="number">7</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>getset <key><value> 以新换旧，设置了新值同时获得旧值。</value></key></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> <span class="keyword">set</span> k3 v3</span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> getset k3 v33</span><br><span class="line">&quot;v3&quot;</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> <span class="keyword">get</span> k3</span><br><span class="line">&quot;v33&quot;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>原子性：</p>
<p>所谓 <strong>原子操作</strong> 是指不会被线程调度机制打断的操作；</p>
<p>这种操作一旦开始，就一直运行到结束，中间不会有任何 context switch （切换到另一个线程）。</p>
<p>（1）在单线程中， 能够在单条指令中完成的操作都可以认为是 “原子操作”，因为中断只能发生于指令之间。</p>
<p>（2）在多线程中，不能被其它进程（线程）打断的操作就叫原子操作。</p>
<p>Redis单命令的原子性主要得益于 Redis 的单线程。</p>
<p><mark> Redis 中的 incr&#x2F;decr 是原子操作</mark></p>
<p><strong>案例：</strong></p>
<p>java中的 i++ 是否是原子操作？<strong>不是</strong></p>
<p>i&#x3D;0;两个线程分别对 i 进行 ++100次，值是多少？【2-200】</p>
<p><img src="/2023/03/17/Redis/Java\Document\Redis\Redis.assets\image-20220513101000926.png" alt="image-20220513101000926"></p>
<p>说明：</p>
<p>i++ 的操作分为三步：取值，++，再赋值</p>
<p>a 线程加到 99 但未赋值，被 b 线程打断并进行加 1 操作，此时 a线程执行赋值操作 i&#x3D;1，b 线程打断并加到 99，i++ 后 i &#x3D; 100，a 线程打断，再次 i++ ，最终值为 2，两个线程都执行了100次，所以最终的范围是 [2, 200]</p>
<h3 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h3><p>​		String 的数据结构为简单动态字符串（Simple Dynamic String，缩写SDS）。是可以修改的字符串，内部结构实现上类似于Java的ArrayList，<strong>采用预分配冗余空间的方式来减少内存的频繁分配。</strong></p>
<p><img src="/2023/03/17/Redis/Java\Document\Redis\Redis.assets\image-20220513095346071.png" alt="image-20220513095346071"></p>
<p>​		如图中所示，内部为当前字符串实际分配的空间capacity一般要高于实际字符串长度len。当字符串长度小于1M时，扩容都是加倍现有的空间，如果超过1M，扩容时一次只会多扩1M的空间。需要注意的是字符串最大长度为512M。</p>
<h2 id="Redis列表（List）"><a href="#Redis列表（List）" class="headerlink" title="Redis列表（List）"></a>Redis列表（List）</h2><h3 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h3><p>单键多值</p>
<p>​		Redis 列表是简单的字符串列表，按照插入顺序排序。你可以添加一个元素到列表的头部（左边）或者尾部（右边）。它的底层实际是个双向链表，对两端的操作性能很高，通过索引下标的操作中间的节点性能会较差。</p>
<p><img src="/2023/03/17/Redis/Java\Document\Redis\Redis.assets\image-20220513101420250.png" alt="image-20220513101420250"></p>
<h3 id="常用命令-1"><a href="#常用命令-1" class="headerlink" title="常用命令"></a>常用命令</h3><ol>
<li><p>lpush&#x2F;rpush <key><value1><value2><value3> …. 从左边&#x2F;右边插入一个或多个值。</value3></value2></value1></key></p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> lpush code java go c<span class="operator">+</span><span class="operator">+</span></span><br><span class="line">(<span class="type">integer</span>) <span class="number">3</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> lrange code <span class="number">0</span> <span class="number">-1</span></span><br><span class="line"><span class="number">1</span>) &quot;c++&quot;</span><br><span class="line"><span class="number">2</span>) &quot;go&quot;</span><br><span class="line"><span class="number">3</span>) &quot;java&quot;</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> rpush code python scala</span><br><span class="line">(<span class="type">integer</span>) <span class="number">5</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> lrange code <span class="number">0</span> <span class="number">-1</span></span><br><span class="line"><span class="number">1</span>) &quot;c++&quot;</span><br><span class="line"><span class="number">2</span>) &quot;go&quot;</span><br><span class="line"><span class="number">3</span>) &quot;java&quot;</span><br><span class="line"><span class="number">4</span>) &quot;python&quot;</span><br><span class="line"><span class="number">5</span>) &quot;scala&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>lrange <key><start><stop></stop> 按照索引下标获得元素(从左到右)，（0-1表示获取所有）</start></key></p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> lrange code <span class="number">0</span> <span class="number">2</span></span><br><span class="line"><span class="number">1</span>) &quot;c++&quot;</span><br><span class="line"><span class="number">2</span>) &quot;go&quot;</span><br><span class="line"><span class="number">3</span>) &quot;java&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>lpop&#x2F;rpop <key> <count>从左边&#x2F;右边弹出一个或多个值。</count></key></p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> lpop code</span><br><span class="line">&quot;c++&quot;</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> rpop code <span class="number">2</span></span><br><span class="line"><span class="number">1</span>) &quot;scala&quot;</span><br><span class="line"><span class="number">2</span>) &quot;python&quot;</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> lrange code <span class="number">0</span> <span class="number">-1</span></span><br><span class="line"><span class="number">1</span>) &quot;go&quot;</span><br><span class="line"><span class="number">2</span>) &quot;java&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>rpoplpush <key1><key2>从<key1>列表右边弹出一个值，插到<key2>列表左边。</key2></key1></key2></key1></p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> rpush list01 A B C</span><br><span class="line">(<span class="type">integer</span>) <span class="number">3</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> rpush list02 D E F</span><br><span class="line">(<span class="type">integer</span>) <span class="number">3</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> rpoplpush list01 list02</span><br><span class="line">&quot;C&quot;</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> lrange list01 <span class="number">0</span> <span class="number">-1</span></span><br><span class="line"><span class="number">1</span>) &quot;A&quot;</span><br><span class="line"><span class="number">2</span>) &quot;B&quot;</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> lrange list02 <span class="number">0</span> <span class="number">-1</span></span><br><span class="line"><span class="number">1</span>) &quot;C&quot;</span><br><span class="line"><span class="number">2</span>) &quot;D&quot;</span><br><span class="line"><span class="number">3</span>) &quot;E&quot;</span><br><span class="line"><span class="number">4</span>) &quot;F&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>lindex <key><index>按照索引下标获得元素(从左到右)</index></key></p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> lrange list02 <span class="number">0</span> <span class="number">-1</span></span><br><span class="line"><span class="number">1</span>) &quot;C&quot;</span><br><span class="line"><span class="number">2</span>) &quot;D&quot;</span><br><span class="line"><span class="number">3</span>) &quot;E&quot;</span><br><span class="line"><span class="number">4</span>) &quot;F&quot;</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> lindex list02 <span class="number">2</span></span><br><span class="line">&quot;E&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>llen <key>获得列表长度 </key></p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> llen list02</span><br><span class="line">(<span class="type">integer</span>) <span class="number">4</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>linsert <key> before <value><newvalue>在<value>的后面插入<newvalue>插入值</newvalue></value></newvalue></value></key></p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> rpush list A B C D</span><br><span class="line">(<span class="type">integer</span>) <span class="number">4</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> linsert list before C X</span><br><span class="line">(<span class="type">integer</span>) <span class="number">5</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> lrange list <span class="number">0</span> <span class="number">-1</span></span><br><span class="line"><span class="number">1</span>) &quot;A&quot;</span><br><span class="line"><span class="number">2</span>) &quot;B&quot;</span><br><span class="line"><span class="number">3</span>) &quot;X&quot;</span><br><span class="line"><span class="number">4</span>) &quot;C&quot;</span><br><span class="line"><span class="number">5</span>) &quot;D&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>lrem <key><n><value>从左边删除 n 个 value (从左到右)</value></n></key></p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> rpush list A B B B C D</span><br><span class="line">(<span class="type">integer</span>) <span class="number">6</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> lrem list <span class="number">2</span> B</span><br><span class="line">(<span class="type">integer</span>) <span class="number">2</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> lrange list <span class="number">0</span> <span class="number">-1</span></span><br><span class="line"><span class="number">1</span>) &quot;A&quot;</span><br><span class="line"><span class="number">2</span>) &quot;B&quot;</span><br><span class="line"><span class="number">3</span>) &quot;C&quot;</span><br><span class="line"><span class="number">4</span>) &quot;D&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>lset<key><index><value>将列表key下标为index的值替换成value</value></index></key></p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> lset list <span class="number">2</span> CC</span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> lrange list <span class="number">0</span> <span class="number">-1</span></span><br><span class="line"><span class="number">1</span>) &quot;A&quot;</span><br><span class="line"><span class="number">2</span>) &quot;B&quot;</span><br><span class="line"><span class="number">3</span>) &quot;CC&quot;</span><br><span class="line"><span class="number">4</span>) &quot;D&quot;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="数据结构-1"><a href="#数据结构-1" class="headerlink" title="数据结构"></a>数据结构</h3><p>List的数据结构为快速链表 quickList。</p>
<p>首先在列表元素较少的情况下会使用一块连续的内存存储，这个结构是 ziplist，也即是压缩列表。</p>
<p>它将所有的元素紧挨着一起存储，分配的是一块连续的内存。</p>
<p>当数据量比较多的时候才会改成 quicklist。</p>
<p>因为普通的链表需要的附加指针空间太大，会比较浪费空间。比如这个列表里存的只是 int 类型的数据，结构上还需要两个额外的指针 prev 和 next。</p>
<p><img src="/2023/03/17/Redis/Java\Document\Redis\Redis.assets\image-20220513101547127.png" alt="image-20220513101547127"></p>
<p>Redis 将链表和 ziplist 结合起来组成了 quicklist。也就是将多个 ziplist 使用双向指针串起来使用。这样既满足了快速的插入删除性能，又不会出现太大的空间冗余。</p>
<h2 id="Redis集合（Set）"><a href="#Redis集合（Set）" class="headerlink" title="Redis集合（Set）"></a>Redis集合（Set）</h2><h3 id="简介-2"><a href="#简介-2" class="headerlink" title="简介"></a>简介</h3><p>​		Redis Set 对外提供的功能与 List 类似是一个列表的功能，特殊之处在于 Set 是可以<strong>自动排重</strong>的，当你需要存储一个列表数据，又不希望出现重复数据时，Set 是一个很好的选择，并且 Set 提供了判断某个成员是否在一个 Set 集合内的重要接口，这个也是 List 所不能提供的。</p>
<p>​		Redis 的 Set 是 String 类型的无序集合。它底层其实是一个 value 为null 的 hash 表，所以添加，删除，查找的<strong>复杂度都是</strong>O(1)。一个算法，随着数据的增加，执行时间的长短，如果是O(1)，数据增加，查找数据的时间不变。</p>
<h3 id="常用命令-2"><a href="#常用命令-2" class="headerlink" title="常用命令"></a>常用命令</h3><ol>
<li><p>sadd <key><value1><value2> 将一个或多个 member 元素加入到集合 key 中，已存在的 member 元素将被忽略</value2></value1></key></p>
</li>
<li><p>smembers <key>  取出该集合的所有值。</key></p>
</li>
<li><p>sismember <key><value>  判断集合<key>是否为含有该<value>值，有1，没有0</value></key></value></key></p>
</li>
<li><p>scard<key>  返回该集合的元素个数。</key></p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> sadd set01 A A B C C</span><br><span class="line">(<span class="type">integer</span>) <span class="number">3</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> smembers set01</span><br><span class="line"><span class="number">1</span>) &quot;B&quot;</span><br><span class="line"><span class="number">2</span>) &quot;C&quot;</span><br><span class="line"><span class="number">3</span>) &quot;A&quot;</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> sismember set01 C</span><br><span class="line">(<span class="type">integer</span>) <span class="number">1</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> scard set01</span><br><span class="line">(<span class="type">integer</span>) <span class="number">3</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>srem <key><value1><value2>  删除集合中的某个元素。</value2></value1></key></p>
</li>
<li><p>spop <key>  <strong>随机从该集合中弹出一个值。</strong></key></p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> smembers set01</span><br><span class="line"><span class="number">1</span>) &quot;F&quot;</span><br><span class="line"><span class="number">2</span>) &quot;B&quot;</span><br><span class="line"><span class="number">3</span>) &quot;E&quot;</span><br><span class="line"><span class="number">4</span>) &quot;A&quot;</span><br><span class="line"><span class="number">5</span>) &quot;C&quot;</span><br><span class="line"><span class="number">6</span>) &quot;D&quot;</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> srem set01 D</span><br><span class="line">(<span class="type">integer</span>) <span class="number">1</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> smembers set01</span><br><span class="line"><span class="number">1</span>) &quot;F&quot;</span><br><span class="line"><span class="number">2</span>) &quot;B&quot;</span><br><span class="line"><span class="number">3</span>) &quot;E&quot;</span><br><span class="line"><span class="number">4</span>) &quot;A&quot;</span><br><span class="line"><span class="number">5</span>) &quot;C&quot;</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> spop set01 <span class="number">2</span></span><br><span class="line"><span class="number">1</span>) &quot;A&quot;</span><br><span class="line"><span class="number">2</span>) &quot;C&quot;</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> smembers set01</span><br><span class="line"><span class="number">1</span>) &quot;F&quot;</span><br><span class="line"><span class="number">2</span>) &quot;B&quot;</span><br><span class="line"><span class="number">3</span>) &quot;E&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>srandmember <key><n> 随机从该集合中取出n个值。不会从集合中删除 。</n></key></p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> sadd set01  A B C D E F</span><br><span class="line">(<span class="type">integer</span>) <span class="number">6</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> srandmember set01 <span class="number">2</span></span><br><span class="line"><span class="number">1</span>) &quot;E&quot;</span><br><span class="line"><span class="number">2</span>) &quot;C&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>smove <source><destination>  value  把集合中一个值从一个集合移动到另一个集合。</destination></p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> sadd set01 A B C</span><br><span class="line">(<span class="type">integer</span>) <span class="number">3</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> smove set01 set02 A</span><br><span class="line">(<span class="type">integer</span>) <span class="number">1</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> smembers set02</span><br><span class="line"><span class="number">1</span>) &quot;A&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>sinter <key1><key2>  返回两个集合的交集元素。</key2></key1></p>
</li>
<li><p>sunion <key1><key2>返回两个集合的并集元素。</key2></key1></p>
</li>
<li><p>sdiff <key1><key2>    返回两个集合的<strong>差集</strong>元素（key1中的，不包含key2中的）。</key2></key1></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> sadd set01 A C D</span><br><span class="line">(<span class="type">integer</span>) <span class="number">3</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> sadd set02 B C E</span><br><span class="line">(<span class="type">integer</span>) <span class="number">3</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> sinter set01 set02</span><br><span class="line"><span class="number">1</span>) &quot;C&quot;</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> sunion set01 set02</span><br><span class="line"><span class="number">1</span>) &quot;A&quot;</span><br><span class="line"><span class="number">2</span>) &quot;C&quot;</span><br><span class="line"><span class="number">3</span>) &quot;D&quot;</span><br><span class="line"><span class="number">4</span>) &quot;B&quot;</span><br><span class="line"><span class="number">5</span>) &quot;E&quot;</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> sdiff set01 set02</span><br><span class="line"><span class="number">1</span>) &quot;A&quot;</span><br><span class="line"><span class="number">2</span>) &quot;D&quot;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="数据结构-2"><a href="#数据结构-2" class="headerlink" title="数据结构"></a>数据结构</h3><p>Set 数据结构是 dict 字典，字典是用哈希表实现的。</p>
<p>​		Java中 HashSet 的内部实现使用的是 HashMap，只不过所有的 value 都指向同一个对象。Redis 的 Set 结构也是一样，它的内部也使用 hash 结构，所有的 value 都指向同一个内部值。</p>
<h2 id="Redis哈希（Hash）"><a href="#Redis哈希（Hash）" class="headerlink" title="Redis哈希（Hash）"></a>Redis哈希（Hash）</h2><h3 id="简介-3"><a href="#简介-3" class="headerlink" title="简介"></a>简介</h3><p>Redis hash 是一个键值对集合。</p>
<p>Redis hash 是一个 String 类型的 field 和 value 的映射表，<mark>hash特别适合用于存储对象。</mark></p>
<p>类似 Java 里面的 Map&lt;String, Object&gt;</p>
<h3 id="常用命令-3"><a href="#常用命令-3" class="headerlink" title="常用命令"></a>常用命令</h3><ol>
<li><p>hset <key><field><value>    给<key>集合中的 <field>键赋值<value></value></field></key></value></field></key></p>
</li>
<li><p>hget <key1><field>                 从<key1>集合<field>取出 value </field></key1></field></key1></p>
</li>
<li><p>hmset <key1><field1><value1><field2><value2>                批量设置hash的值</value2></field2></value1></field1></key1></p>
</li>
<li><p>hexists<key1><field>             查看哈希表 key 中，给定域 field 是否存在。 </field></key1></p>
</li>
<li><p>hkeys <key>                               列出该hash集合的所有field</key></p>
</li>
<li><p>hvals <key>                                列出该hash集合的所有value</key></p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> hset hash01 id <span class="number">1</span></span><br><span class="line">(<span class="type">integer</span>) <span class="number">1</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> hget hash01 id</span><br><span class="line">&quot;1&quot;</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> hmset hash02 name tom age <span class="number">12</span> gender man</span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> hexists hash02 birth</span><br><span class="line">(<span class="type">integer</span>) <span class="number">0</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> hkeys hash02</span><br><span class="line"><span class="number">1</span>) &quot;name&quot;</span><br><span class="line"><span class="number">2</span>) &quot;age&quot;</span><br><span class="line"><span class="number">3</span>) &quot;gender&quot;</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> hvals hash02</span><br><span class="line"><span class="number">1</span>) &quot;tom&quot;</span><br><span class="line"><span class="number">2</span>) &quot;12&quot;</span><br><span class="line"><span class="number">3</span>) &quot;man&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>hincrby <key><field><increment>      为哈希表 key 中的域 field 的值加上增量 1  -1</increment></field></key></p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> hget hash02 age</span><br><span class="line">&quot;12&quot;</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> hincrby hash02 age <span class="number">2</span></span><br><span class="line">(<span class="type">integer</span>) <span class="number">14</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> hget hash02 age</span><br><span class="line">&quot;14&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>hsetnx <key><field><value>                将哈希表 key 中的域 field 的值设置为 value ，当且仅当域 field 不存在。</value></field></key></p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> hkeys hash02</span><br><span class="line"><span class="number">1</span>) &quot;name&quot;</span><br><span class="line"><span class="number">2</span>) &quot;age&quot;</span><br><span class="line"><span class="number">3</span>) &quot;gender&quot;</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> hsetnx hash02 age <span class="number">10</span></span><br><span class="line">(<span class="type">integer</span>) <span class="number">0</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> hsetnx hash02 birth <span class="number">1997</span><span class="operator">/</span><span class="number">01</span><span class="operator">/</span><span class="number">20</span></span><br><span class="line">(<span class="type">integer</span>) <span class="number">1</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="数据结构-3"><a href="#数据结构-3" class="headerlink" title="数据结构"></a>数据结构</h3><p>​		Hash类型对应的数据结构是两种：ziplist（压缩列表），hashtable（哈希表）。当 field-value 长度较短且个数较少时，使用ziplist，否则使用hashtable。</p>
<h2 id="Redis有序集合Zset（Sorted-set）"><a href="#Redis有序集合Zset（Sorted-set）" class="headerlink" title="Redis有序集合Zset（Sorted set）"></a>Redis有序集合Zset（Sorted set）</h2><h3 id="简介-4"><a href="#简介-4" class="headerlink" title="简介"></a>简介</h3><p>Redis 有序集合 Sorted Set 与普通集合 set 非常相似，是一个没有重复元素的字符串集合。</p>
<p>不同之处是有序集合的每个成员都关联了一个<strong>评分（score）</strong>，这个评分（score）被用来按照从最低分到最高分的方式排序集合中的成员。集合的成员是唯一的，但是评分可以重复 。</p>
<p>因为元素是有序的， 所以可以很快的根据评分（score）或者次序（position）来获取一个范围的元素。</p>
<p>访问有序集合的中间元素也是非常快的，因此你能够使用有序集合作为一个没有重复成员的智能列表。</p>
<h3 id="常用命令-4"><a href="#常用命令-4" class="headerlink" title="常用命令"></a>常用命令</h3><ol>
<li><p>zadd <key><score1><value1><score2><value2></value2></score2></value1></score1></key></p>
<p> 将一个或多个 member 元素及其 score 值加入到有序集 key 当中。</p>
</li>
<li><p><strong>zrange <key><start><stop></stop> [WITHSCORES]</start></key></strong>  </p>
<p> 返回有序集 key 中，<mark>下标在<start><stop></stop>之间的元素</start></mark>，带WITHSCORES，可以让分数一起和值返回到结果集。</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> zadd zset01 <span class="number">30</span> A <span class="number">40</span> B <span class="number">10</span> C</span><br><span class="line">(<span class="type">integer</span>) <span class="number">3</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> zrange zset01 <span class="number">0</span> <span class="number">-1</span></span><br><span class="line"><span class="number">1</span>) &quot;C&quot;</span><br><span class="line"><span class="number">2</span>) &quot;A&quot;</span><br><span class="line"><span class="number">3</span>) &quot;B&quot;</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> zrange zset01 <span class="number">0</span> <span class="number">-1</span> withscores</span><br><span class="line"><span class="number">1</span>) &quot;C&quot;</span><br><span class="line"><span class="number">2</span>) &quot;10&quot;</span><br><span class="line"><span class="number">3</span>) &quot;A&quot;</span><br><span class="line"><span class="number">4</span>) &quot;30&quot;</span><br><span class="line"><span class="number">5</span>) &quot;B&quot;</span><br><span class="line"><span class="number">6</span>) &quot;40&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>zrangebyscore key minmax [withscores] [limit offset count]</p>
<p> 返回有序集 key 中，<mark>所有 score 值介于 min 和 max 之间</mark>（包括等于 min 或 max ）成员。有序集成员按 score 值递增（从小到大）次序排列。 </p>
</li>
<li><p>zrevrangebyscore key maxmin [withscores] [limit offset count]      同上，改为从大到小排列。 </p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> zrangebyscore zset01 <span class="number">20</span> <span class="number">40</span> withscores</span><br><span class="line"><span class="number">1</span>) &quot;A&quot;</span><br><span class="line"><span class="number">2</span>) &quot;30&quot;</span><br><span class="line"><span class="number">3</span>) &quot;B&quot;</span><br><span class="line"><span class="number">4</span>) &quot;40&quot;</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> zrevrangebyscore zset01 <span class="number">30</span> <span class="number">10</span>  withscores</span><br><span class="line"><span class="number">1</span>) &quot;A&quot;</span><br><span class="line"><span class="number">2</span>) &quot;30&quot;</span><br><span class="line"><span class="number">3</span>) &quot;C&quot;</span><br><span class="line"><span class="number">4</span>) &quot;10&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>zincrby <key><increment><value>   为元素的score加上增量</value></increment></key></p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> zincrby zset01 <span class="number">10</span> B</span><br><span class="line">&quot;50&quot;</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> zrange zset01 <span class="number">0</span> <span class="number">-1</span> withscores</span><br><span class="line"><span class="number">1</span>) &quot;C&quot;</span><br><span class="line"><span class="number">2</span>) &quot;10&quot;</span><br><span class="line"><span class="number">3</span>) &quot;A&quot;</span><br><span class="line"><span class="number">4</span>) &quot;30&quot;</span><br><span class="line"><span class="number">5</span>) &quot;B&quot;</span><br><span class="line"><span class="number">6</span>) &quot;50&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>zcount <key><min><max>统计该集合，分数区间内的元素个数 </max></min></key></p>
</li>
<li><p>zrank <key><value>返回该值在集合中的排名，从0开始。</value></key></p>
</li>
<li><p>zrem <key><value>删除该集合下，指定值的元素</value></key></p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> zcount zset01 <span class="number">10</span> <span class="number">50</span></span><br><span class="line">(<span class="type">integer</span>) <span class="number">3</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> zrank zset01 A</span><br><span class="line">(<span class="type">integer</span>) <span class="number">1</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> zrem zset01 C</span><br><span class="line">(<span class="type">integer</span>) <span class="number">1</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span><span class="operator">&gt;</span> zrange zset01 <span class="number">0</span> <span class="number">-1</span></span><br><span class="line"><span class="number">1</span>) &quot;A&quot;</span><br><span class="line"><span class="number">2</span>) &quot;B&quot;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="数据结构-4"><a href="#数据结构-4" class="headerlink" title="数据结构"></a>数据结构</h3><p>​		SortedSet（zset）是Redis提供的一个非常特别的数据结构，一方面它等价于Java的数据结构Map&lt;String, Double&gt;，可以给每一个元素value赋予一个权重score，另一方面它又类似于TreeSet，内部的元素会按照权重score进行排序，可以得到每个元素的名次，还可以通过score的范围来获取元素的列表。</p>
<p>zset 底层使用了两个数据结构：</p>
<p>（1）hash，hash的作用就是关联元素 value 和权重 score，保障元素 value 的唯一性，可以通过元素value找到相应的score值。</p>
<p>（2）跳跃表，<mark>跳跃表的目的在于给元素value排序，根据score的范围获取元素列表。</mark></p>
<h3 id="跳跃表"><a href="#跳跃表" class="headerlink" title="跳跃表"></a>跳跃表</h3><ol>
<li>简介</li>
</ol>
<p>​		有序集合在生活中比较常见，例如根据成绩对学生排名，根据得分对玩家排名等。对于有序集合的底层实现，可以用数组、平衡树、链表等。数组不便元素的插入、删除；平衡树或红黑树虽然效率高但结构复杂；链表查询需要遍历所有效率低。Redis采用的是跳跃表。跳跃表效率堪比红黑树，实现远比红黑树简单。</p>
<ol start="2">
<li>实例</li>
</ol>
<p>​		对比有序链表和跳跃表，从链表中查询出51。</p>
<p>​	2.1 有序链表</p>
<p><img src="/2023/03/17/Redis/Java\Document\Redis\Redis.assets\image-20220513110841045.png" alt="image-20220513110841045"></p>
<p>​		要查找值为51的元素，需要从第一个元素开始依次查找、比较才能找到，共需要6次比较。</p>
<p>​	2.2 跳跃表</p>
<p><img src="/2023/03/17/Redis/Java\Document\Redis\Redis.assets\image-20220513110851298.png" alt="image-20220513110851298"></p>
<ol>
<li>从第2层开始，1节点比51节点小，向后比较。</li>
<li>21节点比51节点小，继续向后比较，后面就是NULL了，所以从21节点向下到第1层</li>
<li>在第1层，41节点比51节点小，继续向后，61节点比51节点大，所以从41向下</li>
<li>在第0层，51节点为要查找的节点，节点被找到，共查找4次。</li>
<li>从此可以看出跳跃表比有序链表效率要高。</li>
</ol>
<h1 id="Redis-配置文件介绍"><a href="#Redis-配置文件介绍" class="headerlink" title="Redis 配置文件介绍"></a>Redis 配置文件介绍</h1><p>&#x2F;etc&#x2F;redis.conf</p>
<h2 id="Units单位"><a href="#Units单位" class="headerlink" title="Units单位"></a>Units单位</h2><p>配置大小单位，开头定义了一些基本的度量单位，只支持bytes，不支持bit，大小写不敏感。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> 1  # Redis configuration file example.</span><br><span class="line"> 4  # started with the file path as first argument:</span><br><span class="line"> 6  # ./redis-server /path/to/redis.conf</span><br><span class="line"> 8  # Note on units: when memory size is needed, it is possible to specify</span><br><span class="line"> 9  # it in the usual form of 1k 5GB 4M and so forth:</span><br><span class="line">10  #</span><br><span class="line">11  # 1k =&gt; 1000 bytes</span><br><span class="line">12  # 1kb =&gt; 1024 bytes</span><br><span class="line">13  # 1m =&gt; 1000000 bytes</span><br><span class="line">14  # 1mb =&gt; 1024*1024 bytes</span><br><span class="line">15  # 1g =&gt; 1000000000 bytes</span><br><span class="line">16  # 1gb =&gt; 1024*1024*1024 bytes</span><br><span class="line">17  #</span><br><span class="line">18  # units are case insensitive so 1GB 1Gb 1gB are all the same.</span><br></pre></td></tr></table></figure>

<h2 id="INCLUDES包含"><a href="#INCLUDES包含" class="headerlink" title="INCLUDES包含"></a>INCLUDES包含</h2><p>引入其他配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">20	################################## INCLUDES ###################################</span><br><span class="line">21	</span><br><span class="line">22	# Include one or more other config files here.  This is useful if you</span><br><span class="line">23	# have a standard template that goes to all Redis servers but also need</span><br><span class="line">24	# to customize a few per-server settings.  Include files can include</span><br><span class="line">25	# other files, so use this wisely.</span><br><span class="line">26	#</span><br><span class="line">27	# Note that option &quot;include&quot; won&#x27;t be rewritten by command &quot;CONFIG REWRITE&quot;</span><br><span class="line">28	# from admin or Redis Sentinel. Since Redis always uses the last processed</span><br><span class="line">29	# line as value of a configuration directive, you&#x27;d better put includes</span><br><span class="line">30	# at the beginning of this file to avoid overwriting config change at runtime.</span><br><span class="line">31	#</span><br><span class="line">32	# If instead you are interested in using includes to override configuration</span><br><span class="line">33	# options, it is better to use include as the last line.</span><br><span class="line">34	#</span><br><span class="line">35	# include /path/to/local.conf</span><br><span class="line">36	# include /path/to/other.conf</span><br></pre></td></tr></table></figure>

<h2 id="网络相关配置"><a href="#网络相关配置" class="headerlink" title="网络相关配置"></a>网络相关配置</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"> 46	################################## NETWORK #####################################</span><br><span class="line"> 47	</span><br><span class="line"> 48	# By default, if no &quot;bind&quot; configuration directive is specified, Redis listens</span><br><span class="line"> 49	# for connections from all available network interfaces on the host machine.</span><br><span class="line"> 50	# It is possible to listen to just one or multiple selected interfaces using</span><br><span class="line"> 51	# the &quot;bind&quot; configuration directive, followed by one or more IP addresses.</span><br><span class="line"> 52	# Each address can be prefixed by &quot;-&quot;, which means that redis will not fail to</span><br><span class="line"> 53	# start if the address is not available. Being not available only refers to</span><br><span class="line"> 54	# addresses that does not correspond to any network interfece. Addresses that</span><br><span class="line"> 55	# are already in use will always fail, and unsupported protocols will always BE</span><br><span class="line"> 56	# silently skipped.</span><br><span class="line"> 57	#</span><br><span class="line"> 58	# Examples:</span><br><span class="line"> 59	#</span><br><span class="line"> 60	# bind 192.168.1.100 10.0.0.1     # listens on two specific IPv4 addresses</span><br><span class="line"> 61	# bind 127.0.0.1 ::1              # listens on loopback IPv4 and IPv6</span><br><span class="line"> 62	# bind * -::*                     # like the default, all available interfaces</span><br><span class="line"> 63	#</span><br><span class="line"> 64	# ~~~ WARNING ~~~ If the computer running Redis is directly exposed to the</span><br><span class="line"> 65	# internet, binding to all the interfaces is dangerous and will expose the</span><br><span class="line"> 66	# instance to everybody on the internet. So by default we uncomment the</span><br><span class="line"> 67	# following bind directive, that will force Redis to listen only on the</span><br><span class="line"> 68	# IPv4 and IPv6 (if available) loopback interface addresses (this means Redis</span><br><span class="line"> 69	# will only be able to accept client connections from the same host that it is</span><br><span class="line"> 70	# running on).</span><br><span class="line"> 71	#</span><br><span class="line"> 72	# IF YOU ARE SURE YOU WANT YOUR INSTANCE TO LISTEN TO ALL THE INTERFACES</span><br><span class="line"> 73	# JUST COMMENT OUT THE FOLLOWING LINE.</span><br><span class="line"> 74	# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line"> 75	bind 127.0.0.1 -::1</span><br><span class="line"> 76	</span><br><span class="line"> 77	# Protected mode is a layer of security protection, in order to avoid that</span><br><span class="line"> 78	# Redis instances left open on the internet are accessed and exploited.</span><br><span class="line"> 79	#</span><br><span class="line"> 80	# When protected mode is on and if:</span><br><span class="line"> 81	#</span><br><span class="line"> 82	# 1) The server is not binding explicitly to a set of addresses using the</span><br><span class="line"> 83	#    &quot;bind&quot; directive.</span><br><span class="line"> 84	# 2) No password is configured.</span><br><span class="line"> 85	#</span><br><span class="line"> 86	# The server only accepts connections from clients connecting from the</span><br><span class="line"> 87	# IPv4 and IPv6 loopback addresses 127.0.0.1 and ::1, and from Unix domain</span><br><span class="line"> 88	# sockets.</span><br><span class="line"> 89	#</span><br><span class="line"> 90	# By default protected mode is enabled. You should disable it only if</span><br><span class="line"> 91	# you are sure you want clients from other hosts to connect to Redis</span><br><span class="line"> 92	# even if no authentication is configured, nor a specific set of interfaces</span><br><span class="line"> 93	# are explicitly listed using the &quot;bind&quot; directive.</span><br><span class="line"> 94	protected-mode yes</span><br><span class="line"> 95	</span><br><span class="line"> 96	# Accept connections on the specified port, default is 6379 (IANA #815344).</span><br><span class="line"> 97	# If port 0 is specified Redis will not listen on a TCP socket.</span><br><span class="line"> 98	port 6379</span><br><span class="line"> 99	</span><br><span class="line">100	# TCP listen() backlog.</span><br><span class="line">101	#</span><br><span class="line">102	# In high requests-per-second environments you need a high backlog in order</span><br><span class="line">103	# to avoid slow clients connection issues. Note that the Linux kernel</span><br><span class="line">104	# will silently truncate it to the value of /proc/sys/net/core/somaxconn so</span><br><span class="line">105	# make sure to raise both the value of somaxconn and tcp_max_syn_backlog</span><br><span class="line">106	# in order to get the desired effect.</span><br><span class="line">107	tcp-backlog 511</span><br><span class="line">108	</span><br><span class="line">109	# Unix socket.</span><br><span class="line">110	#</span><br><span class="line">111	# Specify the path for the Unix socket that will be used to listen for</span><br><span class="line">112	# incoming connections. There is no default, so Redis will not listen</span><br><span class="line">113	# on a unix socket when not specified.</span><br><span class="line">114	#</span><br><span class="line">115	# unixsocket /run/redis.sock</span><br><span class="line">116	# unixsocketperm 700</span><br><span class="line">117	</span><br><span class="line">118	# Close the connection after a client is idle for N seconds (0 to disable)</span><br><span class="line">119	timeout 0</span><br><span class="line">120	</span><br><span class="line">121	# TCP keepalive.</span><br><span class="line">122	#</span><br><span class="line">123	# If non-zero, use SO_KEEPALIVE to send TCP ACKs to clients in absence</span><br><span class="line">124	# of communication. This is useful for two reasons:</span><br><span class="line">125	#</span><br><span class="line">126	# 1) Detect dead peers.</span><br><span class="line">127	# 2) Force network equipment in the middle to consider the connection to be</span><br><span class="line">128	#    alive.</span><br><span class="line">129	#</span><br><span class="line">130	# On Linux, the specified value (in seconds) is the period used to send ACKs.</span><br><span class="line">131	# Note that to close the connection the double of the time is needed.</span><br><span class="line">132	# On other kernels the period depends on the kernel configuration.</span><br><span class="line">133	#</span><br><span class="line">134	# A reasonable value for this option is 300 seconds, which is the new</span><br><span class="line">135	# Redis default starting with Redis 3.2.1.</span><br><span class="line">136	tcp-keepalive 300</span><br></pre></td></tr></table></figure>

<h3 id="bind"><a href="#bind" class="headerlink" title="bind"></a>bind</h3><p>默认情况 bind&#x3D;127.0.0.1 只能接受本机的访问请求，不写的情况下，无限制接受任何ip地址的访问。</p>
<p>生产环境肯定要写应用服务器的地址；服务器是需要远程访问的，所以需要将其注释掉。</p>
<p>如果开启了 protected-mode，那么在没有设定 bind ip且没有设密码的情况下，Redis只允许接受本机的响应。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost bin]# ps -ef |grep redis|grep -v grep</span><br><span class="line">root      97989      1  0 09:43 ?        00:00:31 redis-server 127.0.0.1:6379</span><br></pre></td></tr></table></figure>

<p>注释掉bind</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost bin]# redis-server /etc/redis.conf</span><br><span class="line">[root@localhost bin]# ps -ef |grep redis|grep -v grep</span><br><span class="line">root      99498      1  0 11:39 ?        00:00:00 redis-server *:6379</span><br></pre></td></tr></table></figure>

<h3 id="protected-mode"><a href="#protected-mode" class="headerlink" title="protected-mode"></a>protected-mode</h3><p>本机访问保护模式</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protected-mode no</span><br></pre></td></tr></table></figure>

<h3 id="port"><a href="#port" class="headerlink" title="port"></a>port</h3><p>端口默认6379</p>
<h3 id="tcp-backlog"><a href="#tcp-backlog" class="headerlink" title="tcp-backlog"></a>tcp-backlog</h3><p>设置 tcp 的 backlog，backlog 其实是一个连接队列，backlog 队列总和 &#x3D; 未完成三次握手队列 + 已经完成三次握手队列。</p>
<p>在高并发环境下你需要一个高 backlog 值来避免慢客户端连接问题。</p>
<p>注意 Linux 内核会将这个值减小到 &#x2F;proc&#x2F;sys&#x2F;net&#x2F;core&#x2F;somaxconn 的值（128），所以需要确认增大 &#x2F;proc&#x2F;sys&#x2F;net&#x2F;core&#x2F;somaxconn 和 &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_max_syn_backlog（128）两个值来达到想要的效果</p>
<h3 id="timeout"><a href="#timeout" class="headerlink" title="timeout"></a>timeout</h3><p>一个空闲的客户端维持多少秒会关闭，0表示关闭该功能。即永不关闭。</p>
<h3 id="tcp-keepalive"><a href="#tcp-keepalive" class="headerlink" title="tcp-keepalive"></a>tcp-keepalive</h3><p>对访问客户端的一种心跳检测，每隔 n 秒检测一次。</p>
<p>单位为秒，如果设置为0，则不会进行Keepalive检测，建议设置成60 。</p>
<h2 id="GENERAL通用"><a href="#GENERAL通用" class="headerlink" title="GENERAL通用"></a>GENERAL通用</h2><h3 id="daemonize"><a href="#daemonize" class="headerlink" title="daemonize"></a>daemonize</h3><p>是否为后台进程，设置为yes</p>
<h3 id="pidfile"><a href="#pidfile" class="headerlink" title="pidfile"></a>pidfile</h3><p>存放pid文件的位置，每个实例会产生一个不同的pid文件</p>
<h3 id="loglevel"><a href="#loglevel" class="headerlink" title="loglevel"></a>loglevel</h3><p>指定日志记录级别，Redis 总共支持四个级别：debug、verbose、notice、warning，默认为<strong>notice</strong></p>
<p>四个级别根据使用阶段来选择，生产环境选择notice 或者warning</p>
<h3 id="logfile"><a href="#logfile" class="headerlink" title="logfile"></a>logfile</h3><p>日志文件名称</p>
<h3 id="database-16"><a href="#database-16" class="headerlink" title="database  16"></a>database  16</h3><p>设定库的数量 默认16，默认数据库为0，可以使用SELECT <dbid>命令在连接上指定数据库id</dbid></p>
<h2 id="SECURITY安全"><a href="#SECURITY安全" class="headerlink" title="SECURITY安全"></a>SECURITY安全</h2><h3 id="设置密码"><a href="#设置密码" class="headerlink" title="设置密码"></a>设置密码</h3><p>访问密码的查看、设置和取消</p>
<p>在命令中设置密码，只是临时的。重启 redis 服务器，密码就还原了。</p>
<p>永久设置，需要再配置文件中进行设置。</p>
<h2 id="LIMIT限制"><a href="#LIMIT限制" class="headerlink" title="LIMIT限制"></a>LIMIT限制</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">946 ############################## MEMORY MANAGEMENT ################################</span><br><span class="line"> 947</span><br><span class="line"> 948 # Set a memory usage limit to the specified amount of bytes.</span><br><span class="line"> 949 # When the memory limit is reached Redis will try to remove keys</span><br><span class="line"> 950 # according to the eviction policy selected (see maxmemory-policy).</span><br><span class="line"> 951 #</span><br><span class="line"> 952 # If Redis can&#x27;t remove keys according to the policy, or if the policy is</span><br><span class="line"> 953 # set to &#x27;noeviction&#x27;, Redis will start to reply with errors to commands</span><br><span class="line"> 954 # that would use more memory, like SET, LPUSH, and so on, and will continue</span><br><span class="line"> 955 # to reply to read-only commands like GET.</span><br><span class="line"> 956 #</span><br><span class="line"> 957 # This option is usually useful when using Redis as an LRU or LFU cache, or to</span><br><span class="line"> 958 # set a hard memory limit for an instance (using the &#x27;noeviction&#x27; policy).</span><br><span class="line"> 959 #</span><br><span class="line"> 960 # WARNING: If you have replicas attached to an instance with maxmemory on,</span><br><span class="line"> 961 # the size of the output buffers needed to feed the replicas are subtracted</span><br><span class="line"> 962 # from the used memory count, so that network problems / resyncs will</span><br><span class="line"> 963 # not trigger a loop where keys are evicted, and in turn the output</span><br><span class="line"> 964 # buffer of replicas is full with DELs of keys evicted triggering the deletion</span><br><span class="line"> 965 # of more keys, and so forth until the database is completely emptied.</span><br><span class="line"> 966 #</span><br><span class="line"> 967 # In short... if you have replicas attached it is suggested that you set a lower</span><br><span class="line"> 968 # limit for maxmemory so that there is some free RAM on the system for replica</span><br><span class="line"> 969 # output buffers (but this is not needed if the policy is &#x27;noeviction&#x27;).</span><br><span class="line"> 970 #</span><br><span class="line"> 971 # maxmemory &lt;bytes&gt;</span><br><span class="line"> 972</span><br><span class="line"> 973 # MAXMEMORY POLICY: how Redis will select what to remove when maxmemory</span><br><span class="line"> 974 # is reached. You can select one from the following behaviors:</span><br><span class="line"> 975 #</span><br><span class="line"> 976 # volatile-lru -&gt; Evict using approximated LRU, only keys with an expire set.</span><br><span class="line"> 977 # allkeys-lru -&gt; Evict any key using approximated LRU.</span><br><span class="line"> 978 # volatile-lfu -&gt; Evict using approximated LFU, only keys with an expire set.</span><br><span class="line"> 979 # allkeys-lfu -&gt; Evict any key using approximated LFU.</span><br><span class="line"> 980 # volatile-random -&gt; Remove a random key having an expire set.</span><br><span class="line"> 981 # allkeys-random -&gt; Remove a random key, any key.</span><br><span class="line"> 982 # volatile-ttl -&gt; Remove the key with the nearest expire time (minor TTL)</span><br><span class="line"> 983 # noeviction -&gt; Don&#x27;t evict anything, just return an error on write operations.</span><br><span class="line"> 984 #</span><br><span class="line"> 985 # LRU means Least Recently Used</span><br><span class="line"> 986 # LFU means Least Frequently Used</span><br><span class="line"> 987 #</span><br><span class="line"> 988 # Both LRU, LFU and volatile-ttl are implemented using approximated</span><br><span class="line"> 989 # randomized algorithms.</span><br><span class="line"> 990 #</span><br><span class="line"> 991 # Note: with any of the above policies, when there are no suitable keys for</span><br><span class="line"> 992 # eviction, Redis will return an error on write operations that require</span><br><span class="line"> 993 # more memory. These are usually commands that create new keys, add data or</span><br><span class="line"> 994 # modify existing keys. A few examples are: SET, INCR, HSET, LPUSH, SUNIONSTORE,</span><br><span class="line"> 995 # SORT (due to the STORE argument), and EXEC (if the transaction includes any</span><br><span class="line"> 996 # command that requires memory).</span><br><span class="line"> 997 #</span><br><span class="line"> 998 # The default is:</span><br><span class="line"> 999 #</span><br><span class="line">1000 # maxmemory-policy noeviction</span><br><span class="line">1001</span><br><span class="line">1002 # LRU, LFU and minimal TTL algorithms are not precise algorithms but approximated</span><br><span class="line">1003 # algorithms (in order to save memory), so you can tune it for speed or</span><br><span class="line">1004 # accuracy. By default Redis will check five keys and pick the one that was</span><br><span class="line">1005 # used least recently, you can change the sample size using the following</span><br><span class="line">1006 # configuration directive.</span><br><span class="line">1007 #</span><br><span class="line">1008 # The default of 5 produces good enough results. 10 Approximates very closely</span><br><span class="line">1009 # true LRU but costs more CPU. 3 is faster but not very accurate.</span><br><span class="line">1010 #</span><br><span class="line">1011 # maxmemory-samples 5</span><br><span class="line">1012</span><br><span class="line">1013 # Eviction processing is designed to function well with the default setting.</span><br><span class="line">1014 # If there is an unusually large amount of write traffic, this value may need to</span><br><span class="line">1015 # be increased.  Decreasing this value may reduce latency at the risk of</span><br><span class="line">1016 # eviction processing effectiveness</span><br><span class="line">1017 #   0 = minimum latency, 10 = default, 100 = process without regard to latency</span><br><span class="line">1018 #</span><br><span class="line">1019 # maxmemory-eviction-tenacity 10</span><br><span class="line">1020</span><br><span class="line">1021 # Starting from Redis 5, by default a replica will ignore its maxmemory setting</span><br><span class="line">1022 # (unless it is promoted to master after a failover or manually). It means</span><br><span class="line">1023 # that the eviction of keys will be just handled by the master, sending the</span><br><span class="line">1024 # DEL commands to the replica as keys evict in the master side.</span><br></pre></td></tr></table></figure>

<h3 id="maxclients"><a href="#maxclients" class="headerlink" title="maxclients"></a>maxclients</h3><ol>
<li>设置 redis 同时可以与多少个客户端进行连接。</li>
<li>默认情况下为 10000 个客户端。</li>
<li>如果达到了此限制，redis 则会拒绝新的连接请求，并且向这些连接请求方发出 “max number of clients reached” 以作回应。</li>
</ol>
<h3 id="maxmemory"><a href="#maxmemory" class="headerlink" title="maxmemory"></a>maxmemory</h3><ol>
<li><p>建议<strong>必须设置</strong>，否则，将内存占满，造成服务器宕机</p>
</li>
<li><p>设置 redis 可以使用的内存量。一旦到达内存使用上限，redis 将会试图移除内部数据，移除规则可以通过maxmemory-policy 来指定。</p>
</li>
<li><p>如果 redis 无法根据移除规则来移除内存中的数据，或者设置了“不允许移除”，那么 redis 则会针对那些需要申请内存的指令返回错误信息，比如 SET、LPUSH 等。</p>
</li>
<li><p>但是对于无内存申请的指令，仍然会正常响应，比如 GET 等。如果你的 redis 是主 redis（说明你的redis有从redis），那么在设置内存使用上限时，需要在系统中留出一些内存空间给同步队列缓存，只有在你设置的是“不移除”的情况下，才不用考虑这个因素。</p>
</li>
</ol>
<h3 id="maxmemory-policy"><a href="#maxmemory-policy" class="headerlink" title="maxmemory-policy"></a>maxmemory-policy</h3><ol>
<li>volatile-lru：使用 LRU 算法移除 key，只对设置了过期时间的键；（最近最少使用）</li>
<li>allkeys-lru：在所有集合key中，使用LRU算法移除key</li>
<li>volatile-random：在过期集合中移除随机的key，只对设置了过期时间的键</li>
<li>allkeys-random：在所有集合key中，移除随机的key</li>
<li>volatile-ttl：移除那些TTL值最小的key，即那些最近要过期的key</li>
<li>noeviction：不进行移除。针对写操作，只是返回错误信息</li>
</ol>
<h3 id="maxmemory-samples"><a href="#maxmemory-samples" class="headerlink" title="maxmemory-samples"></a>maxmemory-samples</h3><ol>
<li><p>设置样本数量，LRU算法和最小TTL算法都并非是精确的算法，而是估算值，所以你可以设置样本的大小，redis 默认会检查这么多个 key 并选择其中 LRU 的那个。</p>
</li>
<li><p>一般设置 3 到 7 的数字，数值越小样本越不准确，但性能消耗越小。</p>
</li>
</ol>
<h1 id="Redis的发布和订阅"><a href="#Redis的发布和订阅" class="headerlink" title="Redis的发布和订阅"></a>Redis的发布和订阅</h1><h2 id="发布和订阅"><a href="#发布和订阅" class="headerlink" title="发布和订阅"></a>发布和订阅</h2><p>Redis 发布订阅 (pub&#x2F;sub) 是一种消息通信模式：发送者 (pub) 发送消息，订阅者 (sub) 接收消息。</p>
<p>Redis 客户端可以订阅任意数量的频道。</p>
<h2 id="Redis的发布和订阅-1"><a href="#Redis的发布和订阅-1" class="headerlink" title="Redis的发布和订阅"></a>Redis的发布和订阅</h2><ol>
<li><p>客户端可以订阅频道如下图，当给这个频道发布消息后，消息就会发送给订阅的客户端。</p>
<p> <img src="/2023/03/17/Redis/Java\Document\Redis\Redis.assets\image-20220513115243769.png" alt="image-20220513115243769"></p>
</li>
<li><p>示例</p>
<ol>
<li><p>打开一个客户端订阅 channel1</p>
</li>
<li><p>打开另一个客户端，给channel1发布消息hello，返回的1是订阅者数量</p>
</li>
<li><p>打开第一个客户端可以看到发送的消息</p>
</li>
<li><p>注意：发布的消息没有持久化，如果在订阅的客户端收不到hello，只能收到订阅后发布的消息</p>
</li>
</ol>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; subscribe channel01</span><br><span class="line">Reading messages... (press Ctrl-C to quit)</span><br><span class="line">1) &quot;subscribe&quot;</span><br><span class="line">2) &quot;channel01&quot;</span><br><span class="line">3) (integer) 1</span><br></pre></td></tr></table></figure>

 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# redis-cli</span><br><span class="line">127.0.0.1:6379&gt; publish channel01 hello redis</span><br><span class="line">(error) ERR wrong number of arguments for &#x27;publish&#x27; command</span><br><span class="line">127.0.0.1:6379&gt; publish channel01 &quot;hello redis&quot;</span><br><span class="line">(integer) 1</span><br></pre></td></tr></table></figure>

 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; subscribe channel01</span><br><span class="line">Reading messages... (press Ctrl-C to quit)</span><br><span class="line">1) &quot;subscribe&quot;</span><br><span class="line">2) &quot;channel01&quot;</span><br><span class="line">3) (integer) 1</span><br><span class="line">1) &quot;message&quot;</span><br><span class="line">2) &quot;channel01&quot;</span><br><span class="line">3) &quot;hello redis&quot;</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="Redis新数据类型"><a href="#Redis新数据类型" class="headerlink" title="Redis新数据类型"></a>Redis新数据类型</h1><h2 id="Bitmaps"><a href="#Bitmaps" class="headerlink" title="Bitmaps"></a>Bitmaps</h2><h3 id="简介-5"><a href="#简介-5" class="headerlink" title="简介"></a>简介</h3><p>​		现代计算机用二进制（位） 作为信息的基础单位， 1个字节等于8位， 例如“abc”字符串是由3个字节组成， 但实际在计算机存储时将其用二进制表示， “abc”分别对应的ASCII码分别是97、 98、 99， 对应的二进制分别是01100001、 01100010和01100011，如下图：</p>
<img src="/2023/03/17/Redis/Java\Document\Redis\Redis.assets\image-20221009163649599.png" alt="image-20221009163649599" style="zoom:80%;">

<p>合理地使用操作位能够有效地提高内存使用率和开发效率。</p>
<p>Redis提供了Bitmaps这个“数据类型”可以实现对位的操作：</p>
<p>（1）  Bitmaps本身不是一种数据类型， 实际上它就是字符串（key-value） ， 但是它可以对字符串的位进行操作。</p>
<p>（2）  Bitmaps单独提供了一套命令， 所以在Redis中使用Bitmaps和使用字符串的方法不太相同。 可以把Bitmaps想象成一个以位为单位的数组， 数组的每个单元只能存储0和1， 数组的下标在 Bitmaps 中叫做偏移量。</p>
<h3 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h3><ol>
<li><p>setbit</p>
<p> ​	setbit<key><offset><value></value></offset></key></p>
<p> ​	设置Bitmaps中某个偏移量的值（0或1），*offset：偏移量从0开始</p>
</li>
</ol>
<blockquote>
<p>示例：</p>
<p>​		每个独立用户是否访问过网站存放在Bitmaps中， 将访问的用户记做1， 没有访问的用户记做0， 用偏移量作为用户的id。设置键的第offset个位的值（从0算起） ， 假设现在有20个用户，userid&#x3D;1， 6， 11， 15， 19的用户对网站进行了访问， 那么当前Bitmaps初始化结果如图：</p>
<img src="/2023/03/17/Redis/Java\Document\Redis\Redis.assets\image-20221009171946723.png" alt="image-20221009171946723" style="zoom:80%;">

<p>unique:users:20201106代表2020-11-06这天的独立访问用户的Bitmaps</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; setbit unique:user:20220202 1 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit unique:user:20220202 6 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit unique:user:20220202 11 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit unique:user:20220202 15 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit unique:user:20220202 19 1</span><br><span class="line">(integer) 0</span><br></pre></td></tr></table></figure>

<p>注意：</p>
<p>​		很多应用的用户 id 以一个指定数字（例如10000） 开头， 直接将用户 id 和 Bitmaps 的偏移量对应势必会造成一定的浪费， 通常的做法是每次做 setbit 操作时将用户 id 减去这个指定数字。</p>
<p>在第一次初始化Bitmaps时， 假如偏移量非常大， 那么整个初始化过程执行会比较慢， 可能会造成Redis的阻塞。</p>
</blockquote>
<p>（2）getbit</p>
<p>​		getbit<key><offset></offset></key></p>
<p>​		获取Bitmaps中某个偏移量的值（获取键的第offset位的值（从0开始算））</p>
<blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; getbit unique:user:20220202 1</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; getbit unique:user:20220202 3</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; getbit unique:user:20220202 6</span><br><span class="line">(integer) 1</span><br></pre></td></tr></table></figure>
</blockquote>
<p>（3）bitcount</p>
<p>​		bitcount<key>[start end] </key></p>
<p>​		统计字符串<strong>从 start 字节到 end 字节</strong>比特值为1的数量</p>
<blockquote>
<p>​		统计<strong>字符串</strong>被设置为1的bit数。一般情况下，给定的整个字符串都会被进行计数，通过指定额外的 start 或 end 参数，可以让计数只在特定的位上进行。start 和 end 参数的设置，都可以使用负数值：比如 -1 表示最后一个位，而 -2 表示倒数第二个位，start、end 是指bit组的字节的下标数，二者皆包含。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; bitcount unique:user:20220202</span><br><span class="line">(integer) 5</span><br><span class="line">127.0.0.1:6379&gt; bitcount unique:user:20220202 1 3</span><br><span class="line">(integer) 3</span><br></pre></td></tr></table></figure>

<p>start 和 end 代表起始和结束字节数， 下面操作计算用户id在第1个字节到第3个字节之间的独立访问用户数， 对应的用户id是11， 15， 19。</p>
<p>说明：</p>
<p>举例： K1 【01000001 01000000 00000000 00100001】，对应【0，1，2，3】</p>
<p>bitcount K1 1 2 ： 统计下标1、2字节组中bit&#x3D;1的个数，即01000000 00000000  结果为1</p>
<p>bitcount K1 1 3 ： 统计下标1、2字节组中bit&#x3D;1的个数，即01000000 00000000 00100001  结果为3</p>
<p>bitcount K1 0 -2 ： 统计下标0到下标倒数第2，字节组中bit&#x3D;1的个数，即01000001 01000000  00000000 结果为3</p>
<p> 注意：redis的setbit设置或清除的是bit位置，而bitcount计算的是byte位置。</p>
</blockquote>
<p>（4）bitop</p>
<p>​		bitop and(or&#x2F;not&#x2F;xor) <destkey> [key…]</destkey></p>
<p>​		bitop是一个复合操作， 它可以做多个Bitmaps的 <strong>and（交集） 、 or（并集） 、 not（非） 、 xor（异或）</strong> 操作并将结果保存在destkey中。</p>
<blockquote>
<p>2022-02-02 日访问网站的userid&#x3D;1, 2, 5, 9。</p>
<p>setbit unique:users:20220202 1 1</p>
<p>setbit unique:users:20220202 2 1</p>
<p>setbit unique:users:20220202 5 1</p>
<p>setbit unique:users:20220202 9 1</p>
<p>2022-02-03 日访问网站的userid&#x3D;0, 1, 4, 9。</p>
<p>setbit unique:users:20220203 0 1</p>
<p>setbit unique:users:20220203 1 1</p>
<p>setbit unique:users:20220203 4 1</p>
<p>setbit unique:users:20220203 9 1</p>
<p>计算出两天都访问过网站的用户数量：</p>
<p>bitop	and	unique:users:and:20220202_03	unique:users:20220203	unique:users:20220202</p>
<p>计算出任意一天都访问过网站的用户数量（例如月活跃就是类似这种） ， 可以使用or求并集</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; BITOP and unique:users:and:20220202_03 unique:users:20220203 unique:users:20220202</span><br><span class="line">(integer) 2</span><br><span class="line">127.0.0.1:6379&gt; BITOP or unique:users:and:20220202_03 unique:users:20220203 unique:users:20220202</span><br><span class="line">(integer) 2</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="Bitmaps与set对比"><a href="#Bitmaps与set对比" class="headerlink" title="Bitmaps与set对比"></a>Bitmaps与set对比</h3><p>假设网站有1亿用户， 每天独立访问的用户有5千万， 如果每天用集合类型和Bitmaps分别存储活跃用户可以得到表：</p>
<table>
<thead>
<tr>
<th>set和Bitmaps存储一天活跃用户对比</th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>数据  类型</td>
<td>每个用户id占用空间</td>
<td>需要存储的用户量</td>
<td>全部内存量</td>
</tr>
<tr>
<td>集合  类型</td>
<td>64位</td>
<td>50000000</td>
<td>64位*50000000 &#x3D; 400MB</td>
</tr>
<tr>
<td>Bitmaps</td>
<td>1位</td>
<td>100000000</td>
<td>1位*100000000 &#x3D; 12.5MB</td>
</tr>
</tbody></table>
<p>很明显， 这种情况下使用Bitmaps能节省很多的内存空间， 尤其是随着时间推移节省的内存还是非常可观的。</p>
<table>
<thead>
<tr>
<th>set和Bitmaps存储独立用户空间对比</th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>数据类型</td>
<td>一天</td>
<td>一个月</td>
<td>一年</td>
</tr>
<tr>
<td>集合类型</td>
<td>400MB</td>
<td>12GB</td>
<td>144GB</td>
</tr>
<tr>
<td>Bitmaps</td>
<td>12.5MB</td>
<td>375MB</td>
<td>4.5GB</td>
</tr>
</tbody></table>
<p>但Bitmaps并不是万金油， 假如该网站每天的独立访问用户很少， 例如只有10万（大量的僵尸用户） ， 那么两者的对比如下表所示， 很显然， 这时候使用Bitmaps就不太合适了， 因为基本上大部分位都是0。</p>
<table>
<thead>
<tr>
<th>set和Bitmaps存储一天活跃用户对比 独立用户比较少）</th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>数据类型</td>
<td>每个userid占用空间</td>
<td>需要存储的用户量</td>
<td>全部内存量</td>
</tr>
<tr>
<td>集合类型</td>
<td>64位</td>
<td>100000</td>
<td>64位*100000 &#x3D; 800KB</td>
</tr>
<tr>
<td>Bitmaps</td>
<td>1位</td>
<td>100000000</td>
<td>1位*100000000 &#x3D; 12.5MB</td>
</tr>
</tbody></table>
<h2 id="HyperLogLog"><a href="#HyperLogLog" class="headerlink" title="HyperLogLog"></a><strong>HyperLogLog</strong></h2><h3 id="简介-6"><a href="#简介-6" class="headerlink" title="简介"></a>简介</h3><p>​		在工作当中，我们经常会遇到与统计相关的功能需求，比如统计网站PV（PageView页面访问量）,可以使用Redis的incr、incrby轻松实现。</p>
<p>​		但像UV（UniqueVisitor，独立访客）、独立IP数、搜索记录数等需要去重和计数的问题如何解决？这种求集合中不重复元素个数的问题称为基数问题。</p>
<p>解决基数问题有很多种方案：</p>
<p>（1）数据存储在MySQL表中，使用distinct count计算不重复个数</p>
<p>（2）使用Redis提供的hash、set、bitmaps等数据结构来处理</p>
<p>以上的方案结果精确，但随着数据不断增加，导致占用空间越来越大，对于非常大的数据集是不切实际的。</p>
<p>能否能够降低一定的精度来平衡存储空间？Redis推出了HyperLogLog</p>
<p>Redis HyperLogLog 是用来做基数统计的算法，HyperLogLog 的优点是，在输入元素的数量或者体积非常非常大时，计算基数所需的空间总是固定的、并且是很小的。</p>
<p>在 Redis 里面，每个 HyperLogLog 键只需要花费 12 KB 内存，就可以计算接近 2^64 个不同元素的基数。这和计算基数时，元素越多耗费内存就越多的集合形成鲜明对比。</p>
<p>但是，因为 HyperLogLog 只会根据输入元素来计算基数，而不会储存输入元素本身，所以 HyperLogLog 不能像集合那样，返回输入的各个元素。</p>
<p>什么是基数?</p>
<p>比如数据集 {1, 3, 5, 7, 5, 7, 8}， 那么这个数据集的基数集为 {1, 3, 5 ,7, 8}, 基数(不重复元素)为5。 基数估计就是在误差可接受的范围内，快速计算基数。</p>
<h3 id="命令-1"><a href="#命令-1" class="headerlink" title="命令"></a>命令</h3><p>（1）pfadd</p>
<p>​		pfadd <key>&lt; element&gt; [element …]  </key></p>
<p>​		添加指定元素到 HyperLogLog 中</p>
<blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; pfadd hll1 &quot;redis&quot;</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; pfadd hll1 &quot;mysql&quot;</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; pfadd hll1 &quot;redis&quot;</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<p>​		将所有元素添加到指定HyperLogLog数据结构中。如果执行命令后HLL估计的近似基数发生变化，则返回1，否则返回0。</p>
</blockquote>
<p>（2）pfcount</p>
<p>​		pfcount<key> [key …] </key></p>
<p>​		计算HLL的近似基数，可以计算多个HLL，比如用HLL存储每天的UV，计算一周的UV可以使用7天的UV合并计算即可</p>
<blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; pfadd hll1 &quot;redis&quot;</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; pfadd hll1 &quot;mysql&quot;</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; pfadd hll1 &quot;redis&quot;</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; pfcount hll1</span><br><span class="line">(integer) 2</span><br><span class="line">127.0.0.1:6379&gt; pfadd hll2 &quot;kafka&quot;</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; pfadd hll2 &quot;nginx&quot;</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; pfcount hll1 hll2</span><br><span class="line">(integer) 4</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>（3）pfmerge</p>
<p>​		pfmerge<destkey><sourcekey> [sourcekey …] </sourcekey></destkey></p>
<p>​		将一个或多个HLL合并后的结果存储在另一个HLL中，比如每月活跃用户可以使用每天的活跃用户来合并计算可得</p>
<blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; pfcount hll1 hll2</span><br><span class="line">(integer) 4</span><br><span class="line">127.0.0.1:6379&gt; pfmerge hll3 hll1 hll2</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; pfcount hll3</span><br><span class="line">(integer) 4</span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="Geospatial"><a href="#Geospatial" class="headerlink" title="Geospatial"></a><strong>Geospatial</strong></h2><h3 id="简介-7"><a href="#简介-7" class="headerlink" title="简介"></a>简介</h3><p>​		Redis 3.2 中增加了对GEO类型的支持。GEO，Geographic，地理信息的缩写。该类型，就是元素的二维坐标，在地图上就是经纬度。redis基于该类型，提供了经纬度设置，查询，范围查询，距离查询，经纬度Hash等常见操作。</p>
<h3 id="命令-2"><a href="#命令-2" class="headerlink" title="命令"></a>命令</h3><p>（1）geoadd</p>
<p>​		geoadd<key>&lt; longitude&gt;<latitude><member> [longitude latitude member…]  </member></latitude></key></p>
<p>​		添加地理位置（经度，纬度，名称）</p>
<blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geoadd china:city 121.47 31.23 shanghai</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; geoadd china:city 106.50 29.53 chongqing 114.05 22.52 shenzhen 116.38 39.90 beijing</span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:6379&gt; geoadd china:city 121.47 31.23 shanghai</span><br><span class="line">(integer) 0</span><br></pre></td></tr></table></figure>

<ul>
<li>两极无法直接添加，一般会下载城市数据，直接通过 Java 程序一次性导入。</li>
<li>有效的经度从 -180 度到 180 度。有效的纬度从 -85.05112878 度到 85.05112878 度。</li>
<li>当坐标位置超出指定范围时，该命令将会返回一个错误。</li>
<li><strong>已经添加的数据，是无法再次往里面添加的。</strong></li>
</ul>
</blockquote>
<p>（2）geopos </p>
<p>​		geopos <key><member> [member…]</member></key></p>
<p>​		获得指定地区的坐标值</p>
<blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geopos china:city shanghai</span><br><span class="line">1) 1) &quot;121.47000163793563843&quot;</span><br><span class="line">   2) &quot;31.22999903975783553&quot;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>（3）geodist</p>
<p>​		geodist<key><member1><member2> [m|km|ft|mi ] </member2></member1></key></p>
<p>​		获取两个位置之间的直线距离</p>
<blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geodist china:city beijing shanghai</span><br><span class="line">&quot;1068153.5181&quot;</span><br><span class="line">127.0.0.1:6379&gt; geodist china:city beijing shanghai km</span><br><span class="line">&quot;1068.1535&quot;</span><br></pre></td></tr></table></figure>

<p>单位：</p>
<ul>
<li><p>m 表示单位为米[默认值]。</p>
</li>
<li><p>km 表示单位为千米。</p>
</li>
<li><p>mi 表示单位为英里。</p>
</li>
<li><p>ft 表示单位为英尺。</p>
<p>  如果用户没有显式地指定单位参数， 那么 GEODIST 默认使用米作为单位</p>
</li>
</ul>
</blockquote>
<p>（4）georadius</p>
<p>​		georadius<key>&lt; longitude&gt;<latitude>radius m|km|ft|mi </latitude></key></p>
<p>​		以给定的经纬度为中心，找出某一半径内的元素</p>
<blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; georadius china:city 110 30 1000 km</span><br><span class="line">1) &quot;chongqing&quot;</span><br><span class="line">2) &quot;shenzhen&quot;</span><br></pre></td></tr></table></figure>
</blockquote>
<h1 id="Jedis连接Redis"><a href="#Jedis连接Redis" class="headerlink" title="Jedis连接Redis"></a>Jedis连接Redis</h1><h2 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="连接-Redis-注意事项"><a href="#连接-Redis-注意事项" class="headerlink" title="连接 Redis 注意事项"></a>连接 Redis 注意事项</h2><p>禁用Linux的防火墙：Linux(CentOS7)里执行命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop/disable firewalld.service</span><br></pre></td></tr></table></figure>

<p>或者开放端口 6379</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看开放的端口号</span></span><br><span class="line">firewall-cmd --list-all</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置开放的端口号</span></span><br><span class="line">firewall-cmd --add-service=redis --permanent</span><br><span class="line">firewall-cmd --add-port=6379/tcp --permanent</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启防火墙</span></span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<p>redis.conf 中注释掉 bind 127.0.0.1，并且设置： protected-mode no</p>
<p>【<strong>改配置前必须关掉 redis，否则不生效</strong>】</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-DENIED Redis is running in protected mode because protected mode is enabled, no bind address was specified, no authentication password is requested to clients. In this mode connections are only accepted from the loopback interface. If you want to connect from external computers to Redis you may adopt one of the following solutions: </span><br><span class="line">1) Just disable protected mode sending the command &#x27;CONFIG SET protected-mode no&#x27; from the loopback interface by connecting to Redis from the same host the server is running, however MAKE SURE Redis is not publicly accessible from internet if you do so. Use CONFIG REWRITE to make this change permanent. </span><br><span class="line">2) Alternatively you can just disable the protected mode by editing the Redis configuration file, and setting the protected mode option to &#x27;no&#x27;, and then restarting the server. </span><br><span class="line">3) If you started the server manually just for testing, restart it with the &#x27;--protected-mode no&#x27; option. </span><br><span class="line">4) Setup a bind address or an authentication password. </span><br><span class="line">NOTE: You only need to do one of the above things in order for the server to start accepting connections from the outside. </span><br></pre></td></tr></table></figure>

<h2 id="测试连接"><a href="#测试连接" class="headerlink" title="测试连接"></a>测试连接</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JedisTest</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REDIS_HOST</span> <span class="operator">=</span> <span class="string">&quot;192.168.248.100&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">REDIS_PORT</span> <span class="operator">=</span> <span class="number">6379</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jedis</span>(REDIS_HOST, REDIS_PORT);</span><br><span class="line">        <span class="type">String</span> <span class="variable">pong</span> <span class="operator">=</span> jedis.ping(<span class="string">&quot;Hello Redis!&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;pong: &quot;</span> + pong);</span><br><span class="line">        jedis.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="测试数据类型"><a href="#测试数据类型" class="headerlink" title="测试数据类型"></a>测试数据类型</h2><h3 id="key"><a href="#key" class="headerlink" title="key"></a>key</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JedisTest</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REDIS_HOST</span> <span class="operator">=</span> <span class="string">&quot;192.168.248.100&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">REDIS_PORT</span> <span class="operator">=</span> <span class="number">6379</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        jedis = <span class="keyword">new</span> <span class="title class_">Jedis</span>(REDIS_HOST, REDIS_PORT);</span><br><span class="line">        jedis.flushDB();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">        jedis.close();</span><br><span class="line">    &#125;  </span><br><span class="line">	<span class="comment">// 测试 key</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testKey</span><span class="params">()</span> &#123;</span><br><span class="line">        jedis.set(<span class="string">&quot;k1&quot;</span>, <span class="string">&quot;v1&quot;</span>);</span><br><span class="line">        jedis.set(<span class="string">&quot;k2&quot;</span>, <span class="string">&quot;v2&quot;</span>);</span><br><span class="line">        jedis.set(<span class="string">&quot;k3&quot;</span>, <span class="string">&quot;v3&quot;</span>);</span><br><span class="line">        Set&lt;String&gt; keys = jedis.keys(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">        keys.forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">        System.out.println(jedis.exists(<span class="string">&quot;k1&quot;</span>));</span><br><span class="line">        System.out.println(jedis.ttl(<span class="string">&quot;k1&quot;</span>));</span><br><span class="line">        System.out.println(jedis.get(<span class="string">&quot;k1&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="string"><a href="#string" class="headerlink" title="string"></a>string</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 测试 string</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testString</span><span class="params">()</span> &#123;</span><br><span class="line">    jedis.mset(<span class="string">&quot;k1&quot;</span>, <span class="string">&quot;v1&quot;</span>, <span class="string">&quot;k2&quot;</span>, <span class="string">&quot;v2&quot;</span>, <span class="string">&quot;k3&quot;</span>, <span class="string">&quot;v3&quot;</span>);</span><br><span class="line">    System.out.println(jedis.mget(<span class="string">&quot;k1&quot;</span>, <span class="string">&quot;k2&quot;</span>, <span class="string">&quot;k3&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="list"><a href="#list" class="headerlink" title="list"></a>list</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 测试 list</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testList</span><span class="params">()</span> &#123;</span><br><span class="line">    jedis.rpush(<span class="string">&quot;list01&quot;</span>, <span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>);</span><br><span class="line">    System.out.println(jedis.lrange(<span class="string">&quot;list01&quot;</span>, <span class="number">0</span>, -<span class="number">1</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="set"><a href="#set" class="headerlink" title="set"></a>set</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 测试 set</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSet</span><span class="params">()</span> &#123;</span><br><span class="line">    jedis.sadd(<span class="string">&quot;set01&quot;</span>, <span class="string">&quot;A&quot;</span>, <span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>);</span><br><span class="line">    System.out.println(jedis.smembers(<span class="string">&quot;set01&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="hash"><a href="#hash" class="headerlink" title="hash"></a>hash</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 测试 hash</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testHash</span><span class="params">()</span> &#123;</span><br><span class="line">    Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, String&gt;();</span><br><span class="line">    map.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;tom&quot;</span>);</span><br><span class="line">    map.put(<span class="string">&quot;address&quot;</span>, <span class="string">&quot;NewYork&quot;</span>);</span><br><span class="line">    map.put(<span class="string">&quot;age&quot;</span>, <span class="string">&quot;12&quot;</span>);</span><br><span class="line">    jedis.hmset(<span class="string">&quot;hash01&quot;</span>, map);</span><br><span class="line">    System.out.println(jedis.hmget(<span class="string">&quot;hash01&quot;</span>, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;address&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="zset"><a href="#zset" class="headerlink" title="zset"></a>zset</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 测试 zset</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testZset</span><span class="params">()</span> &#123;</span><br><span class="line">    jedis.zadd(<span class="string">&quot;zset01&quot;</span>, <span class="number">30</span>, <span class="string">&quot;A&quot;</span>);</span><br><span class="line">    jedis.zadd(<span class="string">&quot;zset01&quot;</span>, <span class="number">40</span>, <span class="string">&quot;B&quot;</span>);</span><br><span class="line">    jedis.zadd(<span class="string">&quot;zset01&quot;</span>, <span class="number">10</span>, <span class="string">&quot;C&quot;</span>);</span><br><span class="line">    System.out.println(jedis.zrange(<span class="string">&quot;zset01&quot;</span>, <span class="number">0</span>, -<span class="number">1</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Jedis-验证码示例"><a href="#Jedis-验证码示例" class="headerlink" title="Jedis 验证码示例"></a>Jedis 验证码示例</h2><p>需求：</p>
<ol>
<li><p>输入手机号，点击发送后随机生成 6 位数字码，2分钟有效</p>
</li>
<li><p>输入验证码，点击验证，返回成功或失败</p>
</li>
<li><p>每个手机号每天只能输入3次</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1. 输入手机号，点击发送后随机生成6位数字码，2分钟有效</span></span><br><span class="line"><span class="comment"> * 2. 输入验证码，点击验证，返回成功或失败</span></span><br><span class="line"><span class="comment"> * 3. 每个手机号每天只能输入3次</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VerifyCode</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REDIS_HOST</span> <span class="operator">=</span> <span class="string">&quot;192.168.100.100&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">REDIS_PORT</span> <span class="operator">=</span> <span class="number">6379</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">char</span>[] srcArr = <span class="string">&quot;abcdefghijklmnopqrstuvwxyz1234567890&quot;</span>.toCharArray();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送验证码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> phone</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendCodeToClient</span><span class="params">(String phone)</span> &#123;</span><br><span class="line">        jedis = <span class="keyword">new</span> <span class="title class_">Jedis</span>(REDIS_HOST, REDIS_PORT);</span><br><span class="line">        <span class="type">String</span> <span class="variable">phoneCountKey</span> <span class="operator">=</span> <span class="string">&quot;code:&quot;</span> + phone + <span class="string">&quot;:count&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">phoneCount</span> <span class="operator">=</span> jedis.get(phoneCountKey);</span><br><span class="line">        <span class="comment">// 校验发送次数</span></span><br><span class="line">        <span class="keyword">if</span> (phoneCount == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 设置发送次数为 1</span></span><br><span class="line">            jedis.setex(phoneCountKey, <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Integer.parseInt(phoneCount) &lt;= <span class="number">2</span>) &#123;</span><br><span class="line">            jedis.incr(phoneCountKey);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;验证码已经发送三次...&quot;</span>);</span><br><span class="line">            jedis.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 创建并发送验证码</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> createCode();</span><br><span class="line">        System.out.println(<span class="string">&quot;code: &quot;</span> + code);</span><br><span class="line">        <span class="type">String</span> <span class="variable">phoneCodeKey</span> <span class="operator">=</span> <span class="string">&quot;code:&quot;</span> + phone + <span class="string">&quot;:code&quot;</span>;</span><br><span class="line">        jedis.setex(phoneCodeKey, <span class="number">60</span> * <span class="number">2</span>, code);</span><br><span class="line">        jedis.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建验证码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">createCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">6</span>; i++) &#123;</span><br><span class="line">            sb.append(srcArr[random.nextInt(srcArr.length)]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkCode</span><span class="params">(String phone, String code)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (phone == <span class="literal">null</span> || code == <span class="literal">null</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;参数校验出错...&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            jedis = <span class="keyword">new</span> <span class="title class_">Jedis</span>(REDIS_HOST, REDIS_PORT);</span><br><span class="line">            <span class="type">String</span> <span class="variable">redisCode</span> <span class="operator">=</span> jedis.get(<span class="string">&quot;code:&quot;</span> + phone + <span class="string">&quot;:code&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (code.equals(redisCode)) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;验证码正确...&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;验证码错误...&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">VerifyCode</span> <span class="variable">verify</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VerifyCode</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">phone</span> <span class="operator">=</span> <span class="string">&quot;18220549581&quot;</span>;</span><br><span class="line">        verify.sendCodeToClient(phone);</span><br><span class="line">        <span class="comment">// verify.checkCode(phone,&quot;grnddt&quot;);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="SpringBoot整合Redis"><a href="#SpringBoot整合Redis" class="headerlink" title="SpringBoot整合Redis"></a>SpringBoot整合Redis</h1><h2 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h2><p>创建SpringBoot工程，引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- spring2.X集成redis所需common-pool2，可以不用引入--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--注意该版本应该由spring boot仲裁--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;version&gt;2.6.0&lt;/version&gt;--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>application.properties</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Redis服务器地址</span></span><br><span class="line"><span class="attr">spring.redis.host</span>=<span class="string">192.168.248.100</span></span><br><span class="line"><span class="comment">#Redis服务器连接端口</span></span><br><span class="line"><span class="attr">spring.redis.port</span>=<span class="string">6379</span></span><br><span class="line"><span class="comment">#Redis数据库索引（默认为0）</span></span><br><span class="line"><span class="attr">spring.redis.database</span>= <span class="string">0</span></span><br><span class="line"><span class="comment">#连接超时时间（毫秒）</span></span><br><span class="line"><span class="attr">spring.redis.timeout</span>=<span class="string">1800000</span></span><br><span class="line"><span class="comment">#连接池最大连接数（使用负值表示没有限制）</span></span><br><span class="line"><span class="attr">spring.redis.lettuce.pool.max-active</span>=<span class="string">20</span></span><br><span class="line"><span class="comment">#最大阻塞等待时间(负数表示没限制)</span></span><br><span class="line"><span class="attr">spring.redis.lettuce.pool.max-wait</span>=<span class="string">-1</span></span><br><span class="line"><span class="comment">#连接池中的最大空闲连接</span></span><br><span class="line"><span class="attr">spring.redis.lettuce.pool.max-idle</span>=<span class="string">5</span></span><br><span class="line"><span class="comment">#连接池中的最小空闲连接</span></span><br><span class="line"><span class="attr">spring.redis.lettuce.pool.min-idle</span>=<span class="string">0</span></span><br></pre></td></tr></table></figure>

<p>配置类 RedisConfig</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonAutoDetect;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.PropertyAccessor;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.CacheManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.CachingConfigurerSupport;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.EnableCaching;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.cache.RedisCacheConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.cache.RedisCacheManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.RedisSerializationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.RedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.Duration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> <span class="keyword">extends</span> <span class="title class_">CachingConfigurerSupport</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(RedisConnectionFactory factory)</span> &#123;</span><br><span class="line">        RedisTemplate&lt;String, Object&gt; template = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line">        RedisSerializer&lt;String&gt; redisSerializer = <span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>();</span><br><span class="line">        <span class="type">Jackson2JsonRedisSerializer</span> <span class="variable">jackson2JsonRedisSerializer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jackson2JsonRedisSerializer</span>(Object.class);</span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">om</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class="line">        om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);</span><br><span class="line">        jackson2JsonRedisSerializer.setObjectMapper(om);</span><br><span class="line">        template.setConnectionFactory(factory);</span><br><span class="line">        <span class="comment">//key序列化方式</span></span><br><span class="line">        template.setKeySerializer(redisSerializer);</span><br><span class="line">        <span class="comment">//value序列化</span></span><br><span class="line">        template.setValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line">        <span class="comment">//value hashmap序列化</span></span><br><span class="line">        template.setHashValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CacheManager <span class="title function_">cacheManager</span><span class="params">(RedisConnectionFactory factory)</span> &#123;</span><br><span class="line">        RedisSerializer&lt;String&gt; redisSerializer = <span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>();</span><br><span class="line">        <span class="type">Jackson2JsonRedisSerializer</span> <span class="variable">jackson2JsonRedisSerializer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jackson2JsonRedisSerializer</span>(Object.class);</span><br><span class="line"><span class="comment">//解决查询缓存转换异常的问题</span></span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">om</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class="line">        om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);</span><br><span class="line">        jackson2JsonRedisSerializer.setObjectMapper(om);</span><br><span class="line"><span class="comment">// 配置序列化（解决乱码的问题）,过期时间600秒</span></span><br><span class="line">        <span class="type">RedisCacheConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> RedisCacheConfiguration.defaultCacheConfig()</span><br><span class="line">                .entryTtl(Duration.ofSeconds(<span class="number">600</span>))</span><br><span class="line">                .serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(redisSerializer))</span><br><span class="line">                .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(jackson2JsonRedisSerializer))</span><br><span class="line">                .disableCachingNullValues();</span><br><span class="line">        <span class="type">RedisCacheManager</span> <span class="variable">cacheManager</span> <span class="operator">=</span> RedisCacheManager.builder(factory)</span><br><span class="line">                .cacheDefaults(config)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">return</span> cacheManager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>RedisTestController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.redis.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisTestController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, String&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/string&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">stringTest</span><span class="params">()</span> &#123;</span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;str&quot;</span>, <span class="string">&quot;Java&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForValue().get(<span class="string">&quot;str&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/set&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Set <span class="title function_">setTest</span><span class="params">()</span> &#123;</span><br><span class="line">        redisTemplate.opsForSet().add(<span class="string">&quot;set&quot;</span>, <span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;A&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForSet().members(<span class="string">&quot;set&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Redis事务与锁"><a href="#Redis事务与锁" class="headerlink" title="Redis事务与锁"></a>Redis事务与锁</h1><h2 id="Redis事务定义"><a href="#Redis事务定义" class="headerlink" title="Redis事务定义"></a>Redis事务定义</h2><p>​		Redis 事务是一个单独的隔离操作：事务中的所有命令都会序列化、按顺序地执行。事务在执行的过程中，不会被其他客户端发送来的命令请求所打断。<mark>Redis事务的主要作用就是串联多个命令防止别的命令插队。</mark></p>
<h2 id="Multi、Exec、discard"><a href="#Multi、Exec、discard" class="headerlink" title="Multi、Exec、discard"></a>Multi、Exec、discard</h2><p>​		从输入 Multi 命令开始，输入的命令都会依次进入命令队列中，但不会执行，直到输入 Exec 后，Redis 会将之前的命令队列中的命令依次执行。<mark>组队的过程中可以通过discard来放弃组队。</mark></p>
<p><img src="/2023/03/17/Redis/Java\Document\Redis\Redis.assets\image-20220513194048072.png" alt="image-20220513194048072"></p>
<p>事务示例：</p>
<ol>
<li><p>组队成功，提交成功</p>
<blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379(TX)&gt; set k1 v1</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; set k2 v2</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; exec</span><br><span class="line">1) OK</span><br><span class="line">2) OK</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>组队阶段报错，提交失败</p>
<blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379(TX)&gt; set k1 v1</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; set k2</span><br><span class="line">(error) ERR wrong number of arguments for &#x27;set&#x27; command</span><br><span class="line">127.0.0.1:6379(TX)&gt; exec</span><br><span class="line">(error) EXECABORT Transaction discarded because of previous errors.</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>组队成功，提交有成功有失败情况</p>
<blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379(TX)&gt; set k1 v1</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; set k2 v2</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; incr k2</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; exec</span><br><span class="line">1) OK</span><br><span class="line">2) OK</span><br><span class="line">3) (error) ERR value is not an integer or out of range</span><br><span class="line">127.0.0.1:6379&gt; get k1</span><br><span class="line">&quot;v1&quot;</span><br><span class="line">127.0.0.1:6379&gt; get k2</span><br><span class="line">&quot;v2&quot;</span><br></pre></td></tr></table></figure></blockquote>
</li>
</ol>
<h2 id="事务的错误处理"><a href="#事务的错误处理" class="headerlink" title="事务的错误处理"></a>事务的错误处理</h2><p>组队中某个命令出现了报告错误，执行时整个的所有队列都会被取消。</p>
<p>如果执行阶段某个命令报错，则只有报错的命令不会被执行，而其他的命令都会执行，不会回滚。</p>
<h2 id="事务冲突"><a href="#事务冲突" class="headerlink" title="事务冲突"></a>事务冲突</h2><h3 id="悲观锁"><a href="#悲观锁" class="headerlink" title="悲观锁"></a><strong>悲观锁</strong></h3><p><img src="/2023/03/17/Redis/Java\Document\Redis\Redis.assets\image-20221007171853393.png" alt="image-20221007171853393"></p>
<p>​		<strong>悲观锁(Pessimistic Lock)</strong>, 顾名思义，就是很悲观，每次去拿数据的时候都认为别人会修改，所以每次在拿数据的时候都会上锁，这样别人想拿这个数据就会block直到它拿到锁。<strong>传统的关系型数据库里边就用到了很多这种锁机制</strong>，比如<strong>行锁</strong>，<strong>表锁</strong>等，<strong>读锁</strong>，<strong>写锁</strong>等，都是在做操作之前先上锁。</p>
<h3 id="乐观锁"><a href="#乐观锁" class="headerlink" title="乐观锁"></a><strong>乐观锁</strong></h3><p><img src="/2023/03/17/Redis/Java\Document\Redis\Redis.assets\image-20221007172000166.png" alt="image-20221007172000166"></p>
<p>​		<strong>乐观锁(Optimistic Lock)，顾名思义，就是很乐观，每次去拿数据的时候都认为别人不会修改，所以不会上锁，但是在更新的时候会判断一下在此期间别人有没有去更新这个数据，可以使用版本号等机制。</strong>乐观锁适用于多读的应用类型，这样可以提高吞吐量。Redis 就是利用这种 check-and-set 机制实现事务的。</p>
<h3 id="WATCH-key"><a href="#WATCH-key" class="headerlink" title="WATCH key"></a><strong>WATCH</strong> <strong>key</strong></h3><p>​		在执行 multi 之前，先执行 watch key1 [key2]，可以监视一个(或多个) key ，<strong>如果在事务执行之前这个(或这些) key被其他命令所改动，那么事务将被打断。</strong></p>
<p>示例：开启两个客户端测试</p>
<p>客户端一：</p>
<blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; watch balance</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379(TX)&gt; decrby balance 20</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; exec</span><br><span class="line">1) (integer) 80</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>客户端二：</p>
<blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; watch balance</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379(TX)&gt; incrby balance 10</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; exec</span><br><span class="line">(nil)</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<p>客户端二 exec 时，不会执行操作，返回 nil。</p>
</blockquote>
<h3 id="unwatch"><a href="#unwatch" class="headerlink" title="unwatch"></a><strong>unwatch</strong></h3><p>取消 WATCH 命令对所有 key 的监视。</p>
<p>如果在执行 WATCH 命令之后，EXEC 命令或DISCARD 命令先被执行了的话，那么就不需要再执行UNWATCH 了。</p>
<p><a target="_blank" rel="noopener" href="http://doc.redisfans.com/transaction/exec.html">http://doc.redisfans.com/transaction/exec.html</a></p>
<h2 id="Redis-事务三特性"><a href="#Redis-事务三特性" class="headerlink" title="**Redis **事务三特性"></a>**Redis **事务三特性</h2><ol>
<li><p>单独的隔离操作 </p>
<p> ​	事务中的所有命令都会序列化、按顺序地执行。事务在执行的过程中，不会被其他客户端发送来的命令请求所打断。 </p>
</li>
<li><p>没有隔离级别的概念 </p>
<p> ​	队列中的命令没有提交之前都不会实际被执行，因为事务提交前任何指令都不会被实际执行</p>
</li>
<li><p>不保证原子性 </p>
<p> ​	事务中如果有一条命令执行失败，其后的命令仍然会被执行，没有回滚</p>
</li>
</ol>
<h2 id="Redis事务：秒杀示例"><a href="#Redis事务：秒杀示例" class="headerlink" title="Redis事务：秒杀示例"></a>Redis事务：秒杀示例</h2><p>将库存信息以及秒杀成功用户放入Redis</p>
<h3 id="基本代码"><a href="#基本代码" class="headerlink" title="基本代码"></a>基本代码</h3><p>Idea 建立 web 工程：</p>
<p>index.jsp</p>
<blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot;</span><br><span class="line">         pageEncoding=&quot;UTF-8&quot; %&gt;</span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;</span> <span class="string">&quot;http://www.w3.org/TR/html4/loose.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Insert title here<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>商品秒杀！！！<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">&quot;msform&quot;</span> <span class="attr">action</span>=<span class="string">&quot;$&#123;pageContext.request.contextPath&#125;/doseckill&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;application/x-www-form-urlencoded&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">id</span>=<span class="string">&quot;prodid&quot;</span> <span class="attr">name</span>=<span class="string">&quot;prodId&quot;</span> <span class="attr">value</span>=<span class="string">&quot;0101&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">id</span>=<span class="string">&quot;miaosha_btn&quot;</span> <span class="attr">name</span>=<span class="string">&quot;seckill_btn&quot;</span> <span class="attr">value</span>=<span class="string">&quot;点击秒杀&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;$&#123;pageContext.request.contextPath&#125;/script/jquery/jquery-3.1.0.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    $(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        $(<span class="string">&quot;#miaosha_btn&quot;</span>).<span class="title function_">click</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> url = $(<span class="string">&quot;#msform&quot;</span>).<span class="title function_">attr</span>(<span class="string">&quot;action&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">            $.<span class="title function_">post</span>(url, $(<span class="string">&quot;#msform&quot;</span>).<span class="title function_">serialize</span>(), <span class="keyword">function</span> (<span class="params">data</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span> (data == <span class="string">&quot;false&quot;</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">alert</span>(<span class="string">&quot;抢光了&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                    $(<span class="string">&quot;#miaosha_btn&quot;</span>).<span class="title function_">attr</span>(<span class="string">&quot;disabled&quot;</span>, <span class="literal">true</span>);</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">    &#125;)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>servlet：</p>
<blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.servlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecondKillServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="built_in">this</span>.doPost(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用 ab 工具模拟测试：</span></span><br><span class="line"><span class="comment">     * vim postfile</span></span><br><span class="line"><span class="comment">     *      prodId=0101&amp;</span></span><br><span class="line"><span class="comment">     * ab -n 2000 -c 200 -p ~/postfile -T application/x-www-form-urlencoded http://192.168.50.211:8080/seckill/doseckill</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">50000</span>) + <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">prodId</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;prodId&quot;</span>);</span><br><span class="line">        <span class="comment">// 模拟库存：set sc:0101:qt 10</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> SecondKill_redis.doSecondKill(userId, prodId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<p><strong>连接池：使用连接池解决请求数量过多时造成的连接超时问题。</strong></p>
<p>连接池参数：</p>
<ul>
<li>MaxTotal：控制一个pool可分配多少个jedis实例，通过pool.getResource()来获取；如果赋值为-1，则表示不限制；如果pool已经分配了MaxTotal个jedis实例，则此时pool的状态为exhausted。</li>
<li>maxIdle：控制一个pool最多有多少个状态为idle(空闲)的jedis实例。</li>
<li>MaxWaitMillis：表示当borrow一个jedis实例时，最大的等待毫秒数，如果超过等待时间，则直接抛JedisConnectionException。</li>
<li>testOnBorrow：获得一个jedis实例的时候是否检查连接可用性（ping()）；如果为true，则得到的jedis实例均是可用的。</li>
</ul>
<blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.servlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPool;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPoolConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JedisPoolUtil</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> JedisPool jedisPool;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">JedisPoolUtil</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> JedisPool <span class="title function_">getJedisPoolInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (jedisPool == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (JedisPoolUtil.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (jedisPool == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="type">JedisPoolConfig</span> <span class="variable">poolConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JedisPoolConfig</span>();</span><br><span class="line">                    poolConfig.setMaxTotal(<span class="number">200</span>);</span><br><span class="line">                    poolConfig.setMaxIdle(<span class="number">32</span>);</span><br><span class="line">                    poolConfig.setMaxWaitMillis(<span class="number">100</span> * <span class="number">1000</span>);</span><br><span class="line">                    poolConfig.setBlockWhenExhausted(<span class="literal">true</span>);</span><br><span class="line">                    poolConfig.setTestOnBorrow(<span class="literal">true</span>);</span><br><span class="line">                    jedisPool = <span class="keyword">new</span> <span class="title class_">JedisPool</span>(poolConfig, <span class="string">&quot;192.168.100.100&quot;</span>, <span class="number">6379</span>, <span class="number">60000</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> jedisPool;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">release</span><span class="params">(JedisPool jedisPool, Jedis jedis)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (jedis != <span class="literal">null</span>) &#123;</span><br><span class="line">            jedisPool.returnResource(jedis);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>秒杀代码：</p>
<blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.servlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPool;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecondKill_redis</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">doSecondKill</span><span class="params">(String userId, String prodId)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (userId == <span class="literal">null</span> || prodId == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">JedisPool</span> <span class="variable">jedisPool</span> <span class="operator">=</span> JedisPoolUtil.getJedisPoolInstance();</span><br><span class="line">        <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> jedisPool.getResource();</span><br><span class="line">        <span class="type">String</span> <span class="variable">kcKey</span> <span class="operator">=</span> <span class="string">&quot;sk:&quot;</span> + prodId + <span class="string">&quot;:qt&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">userKey</span> <span class="operator">=</span> <span class="string">&quot;sk:&quot;</span> + prodId + <span class="string">&quot;:user&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">kc</span> <span class="operator">=</span> jedis.get(kcKey);</span><br><span class="line">        <span class="keyword">if</span> (kc == <span class="literal">null</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;秒杀还没开始，请等待...&quot;</span>);</span><br><span class="line">            jedis.close();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (jedis.sismember(userKey, userId)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;秒杀已经成功，不能重复秒杀...&quot;</span>);</span><br><span class="line">            jedis.close();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (Integer.parseInt(kc) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;秒杀已经结束...&quot;</span>);</span><br><span class="line">            jedis.close();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        jedis.decr(kcKey);</span><br><span class="line">        jedis.sadd(userKey, userId);</span><br><span class="line">        System.out.println(<span class="string">&quot;秒杀成功...&quot;</span>);</span><br><span class="line">        jedis.close();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>测试：</p>
<p>redis 设置商品库存：set sk:0101:qt 10</p>
<h3 id="ab-工具使用"><a href="#ab-工具使用" class="headerlink" title="ab 工具使用"></a>ab 工具使用</h3><p>使用 ab 工具模拟并发操作。</p>
<p>CentOS6 默认安装</p>
<p>CentOS7 需要手动安装：yum install httpd-tools</p>
<p><strong>无网络</strong></p>
<p>（1） 进入cd &#x2F;run&#x2F;media&#x2F;root&#x2F;CentOS 7 x86_64&#x2F;Packages（路径跟centos6不同）</p>
<p>（2） 顺序安装</p>
<ul>
<li>apr-1.4.8-3.el7.x86_64.rpm</li>
<li>apr-util-1.5.2-6.el7.x86_64.rpm</li>
<li>httpd-tools-2.4.6-67.el7.centos.x86_64.rpm</li>
</ul>
<p>ab 命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ab -n 2000 -c 200 -p ~/postfile -T application/x-www-form-urlencoded http://192.168.50.211:8080/seckill/doseckill</span><br></pre></td></tr></table></figure>

<p>-n	请求数量</p>
<p>-c	并发数量</p>
<p>-T	application&#x2F;x-www-form-urlencoded </p>
<p>-p	post请求文件，需要创建该文件</p>
<p>​		vim postfile 模拟表单提交参数，以&amp;符号结尾;存放当前目录。</p>
<p>​		内容：prodId&#x3D;0101&amp;</p>
<p>测试：</p>
<p>出现超卖问题：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; get sk:0101:qt</span><br><span class="line">&quot;-4&quot;127.0.0.1:6379&gt; SMEMBERS sk:0101:user</span><br><span class="line"> 1) &quot;311&quot;</span><br><span class="line"> 2) &quot;1862&quot;</span><br><span class="line"> 3) &quot;4314&quot;</span><br><span class="line"> 4) &quot;7396&quot;</span><br><span class="line"> 5) &quot;21514&quot;</span><br><span class="line"> 6) &quot;22009&quot;</span><br><span class="line"> 7) &quot;24781&quot;</span><br><span class="line"> 8) &quot;24884&quot;</span><br><span class="line"> 9) &quot;29747&quot;</span><br><span class="line">10) &quot;33970&quot;</span><br><span class="line">11) &quot;35109&quot;</span><br><span class="line">12) &quot;35508&quot;</span><br><span class="line">13) &quot;36228&quot;</span><br><span class="line">14) &quot;49708&quot;</span><br><span class="line">127.0.0.1:6379&gt; get sk:0101:qt</span><br><span class="line">&quot;-&quot;</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>



<h3 id="超卖问题"><a href="#超卖问题" class="headerlink" title="超卖问题"></a>超卖问题</h3><img src="/2023/03/17/Redis/Java\Document\Redis\Redis.assets\image-20221009174213877.png" alt="image-20221009174213877" style="zoom:80%;">

<p><strong>利用乐观锁淘汰用户，解决超卖问题。</strong>【watch multi exec】</p>
<p>修改代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.servlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPool;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Transaction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecondKill_redis_chaomai</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">doSecondKill</span><span class="params">(String userId, String prodId)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (userId == <span class="literal">null</span> || prodId == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">JedisPool</span> <span class="variable">jedisPool</span> <span class="operator">=</span> JedisPoolUtil.getJedisPoolInstance();</span><br><span class="line">        <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> jedisPool.getResource();</span><br><span class="line">        <span class="type">String</span> <span class="variable">kcKey</span> <span class="operator">=</span> <span class="string">&quot;sk:&quot;</span> + prodId + <span class="string">&quot;:qt&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">userKey</span> <span class="operator">=</span> <span class="string">&quot;sk:&quot;</span> + prodId + <span class="string">&quot;:user&quot;</span>;</span><br><span class="line">        <span class="comment">// 监视库存</span></span><br><span class="line">        jedis.watch(kcKey);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">kc</span> <span class="operator">=</span> jedis.get(kcKey);</span><br><span class="line">        <span class="keyword">if</span> (kc == <span class="literal">null</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;秒杀还没开始，请等待...&quot;</span>);</span><br><span class="line">            jedis.close();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (jedis.sismember(userKey, userId)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;秒杀已经成功，不能重复秒杀...&quot;</span>);</span><br><span class="line">            jedis.close();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (Integer.parseInt(kc) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;秒杀已经结束...&quot;</span>);</span><br><span class="line">            jedis.close();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 使用事务</span></span><br><span class="line">        <span class="type">Transaction</span> <span class="variable">multi</span> <span class="operator">=</span> jedis.multi();</span><br><span class="line">        multi.decr(kcKey);</span><br><span class="line">        multi.sadd(userKey, userId);</span><br><span class="line">        List&lt;Object&gt; exec = multi.exec();</span><br><span class="line">        <span class="keyword">if</span> (exec == <span class="literal">null</span> || exec.size() == <span class="number">0</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;秒杀失败....&quot;</span>);</span><br><span class="line">            jedis.close();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;秒杀成功...&quot;</span>);</span><br><span class="line">        jedis.close();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再次测试，没有超卖问题。</p>
<p>修改库存数量：set sk:0101:qt 500</p>
<p>出现了库存遗留问题：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set sk:0101:qt 500</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get sk:0101:qt</span><br><span class="line">&quot;463&quot;</span><br></pre></td></tr></table></figure>

<h3 id="库存遗留问题"><a href="#库存遗留问题" class="headerlink" title="库存遗留问题"></a>库存遗留问题</h3><p>库存遗留问题是由于乐观锁产生的。</p>
<p>使用乐观锁时，会锁定当前操作的数据版本，其他请求不会处理，造成库存遗留。</p>
<p>解决方案：<strong>LUA</strong>脚本</p>
<p>Lua 是一个小巧的 <a target="_blank" rel="noopener" href="http://baike.baidu.com/item/%E8%84%9A%E6%9C%AC%E8%AF%AD%E8%A8%80">脚本语言</a>，Lua脚本可以很容易的被C&#x2F;C++ 代码调用，也可以反过来调用C&#x2F;C++的函数，Lua并没有提供强大的库，一个完整的Lua解释器不过200k，所以Lua不适合作为开发独立应用程序的语言，而是作为嵌入式脚本语言。</p>
<p>很多应用程序、游戏使用LUA作为自己的嵌入式脚本语言，以此来实现可配置性、可扩展性。</p>
<p><a target="_blank" rel="noopener" href="https://www.w3cschool.cn/lua/">https://www.w3cschool.cn/lua/</a></p>
<p><strong>Lua 脚本处理库存遗留问题：</strong></p>
<p><strong>将复杂的或者多步的 redis 操作，写为一个脚本，一次提交给 redis 执行，减少反复连接 redis 的次数。提升性能。</strong></p>
<p>LUA 脚本是类似 redis 事务，有一定的原子性，不会被其他命令插队，可以完成一些 redis 事务性的操作。</p>
<p>但是注意 redis 的 lua 脚本功能，只有在 Redis 2.6 以上的版本才可以使用。</p>
<p>利用 lua 脚本淘汰用户，解决超卖问题。</p>
<p>redis 2.6 版本以后，通过 lua 脚本解决<strong>争抢问题</strong>，实际上是 <strong>redis</strong> <strong>利用其单线程的特性，用任务队列的方式解决多任务并发问题</strong>。</p>
<p>Lua：</p>
<blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">local userid=KEYS[1]; </span><br><span class="line">local prodid=KEYS[2];</span><br><span class="line">local qtkey=&quot;sk:&quot;..prodid..&quot;:qt&quot;;</span><br><span class="line">local usersKey=&quot;sk:&quot;..prodid.&quot;:usr&#x27;; </span><br><span class="line">local userExists=redis.call(&quot;sismember&quot;,usersKey,userid);</span><br><span class="line">if tonumber(userExists)==1 then </span><br><span class="line">  return 2;</span><br><span class="line">end</span><br><span class="line">local num= redis.call(&quot;get&quot; ,qtkey);</span><br><span class="line">if tonumber(num)&lt;=0 then </span><br><span class="line">  return 0; </span><br><span class="line">else </span><br><span class="line">  redis.call(&quot;decr&quot;,qtkey);</span><br><span class="line">  redis.call(&quot;sadd&quot;,usersKey,userid);</span><br><span class="line">end</span><br><span class="line">return 1;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>代码修改：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.servlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPool;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecondKill_Redis_LuaScript</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="type">String</span> <span class="variable">secKillScript</span> <span class="operator">=</span> <span class="string">&quot;local userId=KEYS[1];\r\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;local prodId=KEYS[2];\r\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;local qtkey=&#x27;sk:&#x27;..prodId..\&quot;:qt\&quot;;\r\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;local usersKey=&#x27;sk:&#x27;..prodId..\&quot;:usr\&quot;;\r\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;local userExists=redis.call(\&quot;sismember\&quot;,usersKey,userId);\r\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;if tonumber(userExists)==1 then \r\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;   return 2;\r\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;end\r\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;local num= redis.call(\&quot;get\&quot; ,qtkey);\r\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;if tonumber(num)&lt;=0 then \r\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;   return 0;\r\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;else \r\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;   redis.call(\&quot;decr\&quot;,qtkey);\r\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;   redis.call(\&quot;sadd\&quot;,usersKey,userId);\r\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;end\r\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;return 1&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="type">String</span> <span class="variable">secKillScript2</span> <span class="operator">=</span></span><br><span class="line">            <span class="string">&quot;local userExists=redis.call(\&quot;sismember\&quot;,\&quot;&#123;sk&#125;:0101:usr\&quot;,userid);\r\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; return 1&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">doSecKill</span><span class="params">(String userId, String prodId)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">JedisPool</span> <span class="variable">jedispool</span> <span class="operator">=</span> JedisPoolUtil.getJedisPoolInstance();</span><br><span class="line">        <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> jedispool.getResource();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//String sha1=  .secKillScript;</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">sha1</span> <span class="operator">=</span> jedis.scriptLoad(secKillScript);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> jedis.evalsha(sha1, <span class="number">2</span>, userId, prodId);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">reString</span> <span class="operator">=</span> String.valueOf(result);</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;0&quot;</span>.equals(reString)) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;已抢空！！&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;1&quot;</span>.equals(reString)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;抢购成功！！！！&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;2&quot;</span>.equals(reString)) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;该用户已抢过！！&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;抢购异常！！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        jedis.close();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="Redis-持久化"><a href="#Redis-持久化" class="headerlink" title="Redis 持久化"></a>Redis 持久化</h1><p>Redis 提供了2个不同形式的持久化方式。</p>
<ul>
<li>RDB（Redis DataBase）</li>
<li>AOF（Append Of File）</li>
</ul>
<p><img src="/2023/03/17/Redis/Java\Document\Redis\Redis.assets\image-20221008145146719.png" alt="image-20221008145146719"></p>
<h2 id="RDB-Redis-DataBase"><a href="#RDB-Redis-DataBase" class="headerlink" title="RDB (Redis DataBase)"></a>RDB (Redis DataBase)</h2><h3 id="官网介绍"><a href="#官网介绍" class="headerlink" title="官网介绍"></a>官网介绍</h3><p><img src="/2023/03/17/Redis/Java\Document\Redis\Redis.assets\image-20221008151537055.png" alt="image-20221008151537055"></p>
<h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>​		在指定的时间间隔内将内存中的数据集快照写入磁盘， 即 Snapshot 快照，它恢复时是将快照文件直接读到内存里。</p>
<h3 id="备份文件的执行"><a href="#备份文件的执行" class="headerlink" title="备份文件的执行"></a>备份文件的执行</h3><p>​		Redis会单独创建（fork）一个子进程来进行持久化，会先将数据写入到 一个临时文件中，待持久化过程都结束了，再用这个临时文件替换上次持久化好的文件（防止中间出现宕机导致数据丢失）。 整个过程中，主进程是不进行任何 IO 操作的，这就确保了极高的性能。<strong>如果需要进行大规模数据的恢复，且对于数据恢复的完整性不是非常敏感，那RDB方式要比AOF方式更加的高效。RDB的缺点是最后一次持久化后的数据可能丢失。</strong></p>
<h3 id="Fork"><a href="#Fork" class="headerlink" title="Fork"></a>Fork</h3><ol>
<li><p>Fork的作用是复制一个与当前进程一样的进程。新进程的所有数据（变量、环境变量、程序计数器等） 数值都和原进程一致，但是是一个全新的进程，并作为原进程的子进程。</p>
</li>
<li><p>在Linux程序中，fork()会产生一个和父进程完全相同的子进程，但子进程在此后多会exec系统调用，出于效率考虑，Linux中引入了<strong>写时复制技术</strong></p>
</li>
<li><p><strong>一般情况父进程和子进程会共用同一段物理内存</strong>，只有进程空间的各段的内容要发生变化时，才会将父进程的内容复制一份给子进程。</p>
</li>
</ol>
<h3 id="RDB-持久化流程"><a href="#RDB-持久化流程" class="headerlink" title="RDB 持久化流程"></a><strong>RDB</strong> 持久化流程</h3><p><img src="/2023/03/17/Redis/Java\Document\Redis\Redis.assets\image-20221008151945129.png" alt="image-20221008151945129"></p>
<h3 id="rdb-文件配置"><a href="#rdb-文件配置" class="headerlink" title="rdb 文件配置"></a>rdb 文件配置</h3><p>​		在 redis.conf 中配置文件名称，默认为 dump.rdb。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">406 # Enables or disables full sanitation checks for ziplist and listpack etc when</span><br><span class="line">407 # loading an RDB or RESTORE payload. This reduces the chances of a assertion or</span><br><span class="line">408 # crash later on while processing commands.</span><br><span class="line">409 # Options:</span><br><span class="line">410 #   no         - Never perform full sanitation</span><br><span class="line">411 #   yes        - Always perform full sanitation</span><br><span class="line">412 #   clients    - Perform full sanitation only for user connections.</span><br><span class="line">413 #                Excludes: RDB files, RESTORE commands received from the master</span><br><span class="line">414 #                connection, and client connections which have the</span><br><span class="line">415 #                skip-sanitize-payload ACL flag.</span><br><span class="line">416 # The default should be &#x27;clients&#x27; but since it currently affects cluster</span><br><span class="line">417 # resharding via MIGRATE, it is temporarily set to &#x27;no&#x27; by default.</span><br><span class="line">418 #</span><br><span class="line">419 # sanitize-dump-payload no</span><br><span class="line">420</span><br><span class="line">421 # The filename where to dump the DB</span><br><span class="line">422 dbfilename dump.rdb</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The working directory.</span></span><br><span class="line">438 #</span><br><span class="line">439 # The DB will be written inside this directory, with the filename specified</span><br><span class="line">440 # above using the &#x27;dbfilename&#x27; configuration directive.</span><br><span class="line">441 #</span><br><span class="line">442 # The Append Only File will also be created inside this directory.</span><br><span class="line">443 #</span><br><span class="line">444 # Note that you must specify a directory here, not a file name.</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认当前启动目录下的 dump.rdb</span></span><br><span class="line">445 dir ./</span><br></pre></td></tr></table></figure>

<h3 id="RDB-快照触发"><a href="#RDB-快照触发" class="headerlink" title="RDB 快照触发"></a>RDB 快照触发</h3><h4 id="默认配置"><a href="#默认配置" class="headerlink" title="默认配置"></a>默认配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">351 ################################ SNAPSHOTTING  ################################</span><br><span class="line">352</span><br><span class="line">353 # Save the DB to disk.</span><br><span class="line">354 #</span><br><span class="line">355 # save &lt;seconds&gt; &lt;changes&gt;</span><br><span class="line">356 #</span><br><span class="line">357 # Redis will save the DB if both the given number of seconds and the given</span><br><span class="line">358 # number of write operations against the DB occurred.</span><br><span class="line">359 #</span><br><span class="line">360 # Snapshotting can be completely disabled with a single empty string argument</span><br><span class="line">361 # as in following example:</span><br><span class="line">362 #</span><br><span class="line">363 # save &quot;&quot;</span><br><span class="line">364 #</span><br><span class="line">365 # Unless specified otherwise, by default Redis will save the DB:</span><br><span class="line">366 #   * After 3600 seconds (an hour) if at least 1 key changed</span><br><span class="line">367 #   * After 300 seconds (5 minutes) if at least 100 keys changed</span><br><span class="line">368 #   * After 60 seconds if at least 10000 keys changed</span><br><span class="line">369 #</span><br><span class="line">370 # You can set these explicitly by uncommenting the three following lines.</span><br><span class="line">371 #</span><br><span class="line">372 # save 3600 1</span><br><span class="line">373 # save 300 100</span><br><span class="line">374 # save 60 10000</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<p>默认1小时内至少有个key发生改变</p>
<p>5分钟内至少有100个key发生改变</p>
<p>1分钟内至少有10000个key发生改变。</p>
<p>格式：save 秒钟 写操作次数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">改变的越频繁，备份的间隔时间越小。</span></span><br><span class="line">save 20 3</span><br></pre></td></tr></table></figure>

<p>RDB是整个内存的压缩过的Snapshot，RDB的数据结构，可以配置复合的快照触发条件。</p>
<p>不设置 save 指令，或者给 save 传入空字符串：save “”</p>
<h4 id="save-与-bgsave-命令"><a href="#save-与-bgsave-命令" class="headerlink" title="save 与 bgsave 命令"></a>save 与 bgsave 命令</h4><p>save ：save时只管保存，其它不管，全部阻塞。手动保存。不建议。</p>
<p><strong>bgsave</strong>：Redis会在后台异步进行快照操作，快照同时还可以响应客户端请求。</p>
<p>可以通过 lastsave 命令获取最后一次成功执行快照的时间</p>
<h4 id="flushall-命令"><a href="#flushall-命令" class="headerlink" title="flushall 命令"></a>flushall 命令</h4><p>​		执行flushall命令，也会产生 dump.rdb 文件，但里面是空的，无意义</p>
<h4 id="stop-writes-on-bgsave-error"><a href="#stop-writes-on-bgsave-error" class="headerlink" title="stop-writes-on-bgsave-error"></a>stop-writes-on-bgsave-error</h4><p>​		当Redis无法写入磁盘的话，直接关掉Redis的写操作。推荐yes</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">376 # By default Redis will stop accepting writes if RDB snapshots are enabled</span><br><span class="line">377 # (at least one save point) and the latest background save failed.</span><br><span class="line">378 # This will make the user aware (in a hard way) that data is not persisting</span><br><span class="line">379 # on disk properly, otherwise chances are that no one will notice and some</span><br><span class="line">380 # disaster will happen.</span><br><span class="line">381 #</span><br><span class="line">382 # If the background saving process will start working again Redis will</span><br><span class="line">383 # automatically allow writes again.</span><br><span class="line">384 #</span><br><span class="line">385 # However if you have setup your proper monitoring of the Redis server</span><br><span class="line">386 # and persistence, you may want to disable this feature so that Redis will</span><br><span class="line">387 # continue to work as usual even if there are problems with disk,</span><br><span class="line">388 # permissions, and so forth.</span><br><span class="line">389 stop-writes-on-bgsave-error yes</span><br></pre></td></tr></table></figure>

<p><strong>rdbcompression</strong> <strong>压缩文件</strong></p>
<p>对于存储到磁盘中的快照，可以设置是否进行压缩存储。如果是的话，redis会采用LZF算法进行压缩。</p>
<p>如果你不想消耗CPU来进行压缩的话，可以设置为关闭此功能。推荐yes。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">391 # Compress string objects using LZF when dump .rdb databases?</span><br><span class="line">392 # By default compression is enabled as it&#x27;s almost always a win.</span><br><span class="line">393 # If you want to save some CPU in the saving child set it to &#x27;no&#x27; but</span><br><span class="line">394 # the dataset will likely be bigger if you have compressible values or keys.</span><br><span class="line">395 rdbcompression yes</span><br></pre></td></tr></table></figure>

<p><strong>rdbchecksum 检查完整性</strong></p>
<p>​		在存储快照后，还可以让redis使用CRC64算法来进行数据校验，但是这样做会增加大约10%的性能消耗，如果希望获取到最大的性能提升，可以关闭此功能，推荐yes。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">391 # Compress string objects using LZF when dump .rdb databases?</span><br><span class="line">392 # By default compression is enabled as it&#x27;s almost always a win.</span><br><span class="line">393 # If you want to save some CPU in the saving child set it to &#x27;no&#x27; but</span><br><span class="line">394 # the dataset will likely be bigger if you have compressible values or keys.</span><br><span class="line">395 rdbcompression yes</span><br></pre></td></tr></table></figure>

<h4 id="rdb-的备份"><a href="#rdb-的备份" class="headerlink" title="**rdb **的备份"></a>**rdb **的备份</h4><p>先通过config get dir 查询rdb文件的目录 ，将 *.rdb 的文件拷贝到别的地方。</p>
<p>rdb的恢复</p>
<ul>
<li>关闭Redis</li>
<li>先把备份的文件拷贝到工作目录下 cp dump2.rdb dump.rdb</li>
<li>启动Redis, 备份数据会直接加载</li>
</ul>
<h3 id="RDB-优势"><a href="#RDB-优势" class="headerlink" title="RDB 优势"></a>RDB 优势</h3><ol>
<li>适合大规模数据的恢复</li>
<li>对数据的完整性和一致性要求不高时适合使用</li>
<li>节省磁盘空间（相比较于AOF，没有命令存储）</li>
<li>恢复速度快</li>
</ol>
<h3 id="RDB-劣势"><a href="#RDB-劣势" class="headerlink" title="RDB 劣势"></a>RDB <strong>劣势</strong></h3><ol>
<li>Fork的时候，内存中的数据被克隆了一份，大致2倍的膨胀性需要考虑</li>
</ol>
<p>l Fork的时候，内存中的数据被克隆了一份，大致2倍的膨胀性需要考虑</p>
<ol start="2">
<li><p>虽然Redis在fork时使用了<strong>写时拷贝技术</strong>，但是如果数据庞大时还是比较消耗性能。</p>
</li>
<li><p>在备份周期在一定间隔时间做一次备份，所以如果Redis意外down掉的话，就会丢失最后一次快照后的所有修改。</p>
</li>
</ol>
<h3 id="动态停止RDB"><a href="#动态停止RDB" class="headerlink" title="动态停止RDB"></a>动态停止RDB</h3><p>动态停止RDB：redis-cli config set save “” #save后给空值，表示禁用保存策略</p>
<h3 id="RDB-总结"><a href="#RDB-总结" class="headerlink" title="RDB 总结"></a>RDB 总结</h3><p><img src="/2023/03/17/Redis/Java\Document\Redis\Redis.assets\image-20221008153853024.png" alt="image-20221008153853024"></p>
<h2 id="AOF（Append-Only-File）"><a href="#AOF（Append-Only-File）" class="headerlink" title="AOF（Append Only File）"></a>AOF（Append Only File）</h2><h3 id="定义-1"><a href="#定义-1" class="headerlink" title="定义"></a>定义</h3><p>​		以<strong>日志</strong>的形式来记录每个写操作（增量保存），将Redis执行过的所有写指令记录下来（<strong>读操作不记录</strong>）， <strong>只许追加文件但不可以改写文件</strong>，redis启动之初会读取该文件重新构建数据，换言之，redis 重启的话就根据日志文件的内容将写指令从前到后执行一次以完成数据的恢复工作。</p>
<h3 id="AOF持久化流程"><a href="#AOF持久化流程" class="headerlink" title="AOF持久化流程"></a><strong>AOF</strong>持久化流程</h3><p>（1）客户端的请求写命令会被append追加到AOF缓冲区内</p>
<p>（2）AOF缓冲区根据AOF持久化策略[always,everysec,no]将操作sync同步到磁盘的AOF文件中</p>
<p>（3）AOF文件大小超过重写策略或手动重写时，会对AOF文件rewrite重写，压缩AOF文件容量</p>
<p>（4）Redis服务重启时，会重新load加载AOF文件中的写操作达到数据恢复的目的</p>
<img src="/2023/03/17/Redis/Java\Document\Redis\Redis.assets\image-20221008154119947.png" alt="image-20221008154119947" style="zoom:67%;">

<h3 id="AOF-默认配置"><a href="#AOF-默认配置" class="headerlink" title="AOF 默认配置"></a>AOF 默认配置</h3><p>在 redis.conf 中配置文件名称，默认为 appendonly.aof，AOF文件的保存路径，同RDB的路径一致。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">1211 ############################## APPEND ONLY MODE ###############################</span><br><span class="line">1212</span><br><span class="line">1213 # By default Redis asynchronously dumps the dataset on disk. This mode is</span><br><span class="line">1214 # good enough in many applications, but an issue with the Redis process or</span><br><span class="line">1215 # a power outage may result into a few minutes of writes lost (depending on</span><br><span class="line">1216 # the configured save points).</span><br><span class="line">1217 #</span><br><span class="line">1218 # The Append Only File is an alternative persistence mode that provides</span><br><span class="line">1219 # much better durability. For instance using the default data fsync policy</span><br><span class="line">1220 # (see later in the config file) Redis can lose just one second of writes in a</span><br><span class="line">1221 # dramatic event like a server power outage, or a single write if something</span><br><span class="line">1222 # wrong with the Redis process itself happens, but the operating system is</span><br><span class="line">1223 # still running correctly.</span><br><span class="line">1224 #</span><br><span class="line">1225 # AOF and RDB persistence can be enabled at the same time without problems.</span><br><span class="line">1226 # If the AOF is enabled on startup Redis will load the AOF, that is the file</span><br><span class="line">1227 # with the better durability guarantees.</span><br><span class="line">1228 #</span><br><span class="line">1229 # Please check http://redis.io/topics/persistence for more information.</span><br><span class="line">1230</span><br><span class="line">1231 appendonly no</span><br><span class="line">1232</span><br><span class="line">1233 # The name of the append only file (default: &quot;appendonly.aof&quot;)</span><br><span class="line">1234</span><br><span class="line">1235 appendfilename &quot;appendonly.aof&quot;</span><br></pre></td></tr></table></figure>

<h3 id="AOF和-RDB-同时开启"><a href="#AOF和-RDB-同时开启" class="headerlink" title="AOF和 RDB 同时开启"></a><strong>AOF</strong>和 RDB 同时开启</h3><p><strong>AOF 和 RDB 同时开启，系统默认取AOF的数据（数据不会存在丢失）</strong>，如果 aof 文件为空，则重启后的redis没有数据。</p>
<p>示例：</p>
<h3 id="AOF启动、恢复"><a href="#AOF启动、恢复" class="headerlink" title="AOF启动、恢复"></a><strong>AOF</strong>启动、恢复</h3><p>AOF 的备份机制和性能虽然和 RDB 不同, 但是备份和恢复的操作同 RDB一样，都是拷贝备份文件，需要恢复时再拷贝到Redis工作目录下，启动系统即加载。</p>
<p>正常恢复</p>
<ul>
<li>​	修改默认的appendonly no，改为yes</li>
<li>​	将有数据的aof文件复制一份保存到对应目录(查看目录：config get dir)</li>
<li>​	恢复：重启redis然后重新加载</li>
</ul>
<p>异常恢复</p>
<ul>
<li>​		修改默认的appendonly no，改为yes</li>
<li>​		如遇到<strong>AOF</strong>文件损坏**，通过 &#x2F;usr&#x2F;local&#x2F;bin&#x2F;**redis-check-aof–fix appendonly.aof –fixed 进行恢复</li>
<li>​		备份被写坏的AOF文件</li>
<li>​		恢复：重启redis，然后重新加载</li>
</ul>
<p>示例：</p>
<h3 id="AOF-同步频率设置"><a href="#AOF-同步频率设置" class="headerlink" title="AOF 同步频率设置"></a><strong>AOF</strong> 同步频率设置</h3><ol>
<li><p>appendfsync	always</p>
<p> ​	始终同步，每次Redis的写入都会立刻记入日志；性能较差但数据完整性比较好</p>
</li>
<li><p>appendfsync everysec</p>
<p> ​	每秒同步，每秒记入日志一次，如果宕机，本秒的数据可能丢失。</p>
</li>
<li><p>appendfsync no</p>
<p> ​	redis不主动进行同步，把同步时机交给操作系统。</p>
</li>
</ol>
<h3 id="Rewrite压缩"><a href="#Rewrite压缩" class="headerlink" title="Rewrite压缩"></a><strong>Rewrite</strong>压缩</h3><h4 id="定义-2"><a href="#定义-2" class="headerlink" title="定义"></a>定义</h4><p>​		AOF采用文件追加方式，文件会越来越大为避免出现此种情况，新增了重写机制, 当AOF文件的大小超过所设定的阈值时，Redis就会启动AOF文件的内容压缩， 只保留可以恢复数据的最小指令集.可以使用命令 bgrewriteaof</p>
<h4 id="重写原理，如何实现重写"><a href="#重写原理，如何实现重写" class="headerlink" title="重写原理，如何实现重写"></a>重写原理，如何实现重写</h4><p>AOF文件持续增长而过大时，会fork出一条新进程来将文件重写(也是先写临时文件最后再rename)，redis4.0版本后的重写，是指上就是把rdb 的快照，以二级制的形式附在新的aof头部，作为已有的历史数据，替换掉原来的流水账操作。</p>
<p><strong>no-appendfsync-on-rewrite：</strong></p>
<p>如果 no-appendfsync-on-rewrite&#x3D;yes ,不写入aof文件只写入缓存，用户请求不会阻塞，但是在这段时间如果宕机会丢失这段时间的缓存数据。（降低数据安全性，提高性能）</p>
<p>如果 no-appendfsync-on-rewrite&#x3D;no, 还是会把数据往磁盘里刷，但是遇到重写操作，可能会发生阻塞。（数据安全，但是性能降低）</p>
<h4 id="触发机制，何时重写"><a href="#触发机制，何时重写" class="headerlink" title="触发机制，何时重写"></a>触发机制，何时重写</h4><p>Redis会记录上次重写时的AOF大小，默认配置是当AOF文件大小是上次rewrite后大小的一倍且文件大于64M时触发</p>
<p>重写虽然可以节约大量磁盘空间，减少恢复时间。但是每次重写还是有一定的负担的，因此设定Redis要满足一定条件才会进行重写。 </p>
<p>auto-aof-rewrite-percentage：设置重写的基准值，文件达到100%时开始重写（文件是原来重写后文件的2倍时触发）</p>
<p>auto-aof-rewrite-min-size：设置重写的基准值，最小文件64MB。达到这个值开始重写。</p>
<p>例如：文件达到70MB开始重写，降到50MB，下次什么时候开始重写？100MB</p>
<p>系统载入时或者上次重写完毕时，Redis会记录此时AOF大小，设为base_size,</p>
<p>如果Redis的AOF当前大小&gt;&#x3D; base_size +base_size*100% (默认)且当前大小&gt;&#x3D;64mb(默认)的情况下，Redis会对AOF进行重写。 </p>
<h4 id="重写流程"><a href="#重写流程" class="headerlink" title="重写流程"></a>重写流程</h4><p>（1）bgrewriteaof触发重写，判断是否当前有bgsave或bgrewriteaof在运行，如果有，则等待该命令结束后再继续执行。</p>
<p>（2）主进程fork出子进程执行重写操作，保证主进程不会阻塞。</p>
<p>（3）子进程遍历redis内存中数据到临时文件，客户端的写请求同时写入aof_buf缓冲区和aof_rewrite_buf重写缓冲区保证原AOF文件完整以及新AOF文件生成期间的新的数据修改动作不会丢失。</p>
<p>（4）子进程写完新的AOF文件后，向主进程发信号，父进程更新统计信息。2).主进程把aof_rewrite_buf中的数据写入到新的AOF文件。</p>
<p>（5）使用新的AOF文件覆盖旧的AOF文件，完成AOF重写。</p>
<p><img src="/2023/03/17/Redis/Java\Document\Redis\Redis.assets\image-20221008155125490.png" alt="image-20221008155125490"></p>
<h3 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h3><ol>
<li><p>备份机制更稳健，丢失数据概率更低。</p>
</li>
<li><p>可读的日志文本，通过操作AOF稳健，可以处理误操作。</p>
</li>
</ol>
<h3 id="劣势"><a href="#劣势" class="headerlink" title="劣势"></a><strong>劣势</strong></h3><ul>
<li>比起RDB占用更多的磁盘空间。</li>
<li>恢复备份速度要慢。</li>
<li>每次读写都同步的话，有一定的性能压力。</li>
<li>存在个别Bug，造成恢复不能。</li>
</ul>
<p><img src="/2023/03/17/Redis/Java\Document\Redis\Redis.assets\image-20221008155241481.png" alt="image-20221008155241481"></p>
<h2 id="应该使用那个策略"><a href="#应该使用那个策略" class="headerlink" title="应该使用那个策略"></a>应该使用那个策略</h2><h3 id="官方推荐"><a href="#官方推荐" class="headerlink" title="官方推荐"></a>官方推荐</h3><ul>
<li>官方推荐两个都启用。</li>
<li>如果对数据不敏感，可以选单独用RDB。</li>
<li>不建议单独用 AOF，因为可能会出现Bug。</li>
<li>如果只是做纯内存缓存，可以都不用。</li>
</ul>
<p><img src="/2023/03/17/Redis/Java\Document\Redis\Redis.assets\image-20221008155404670.png" alt="image-20221008155404670"></p>
<ul>
<li>RDB持久化方式能够在指定的时间间隔能对你的数据进行快照存储</li>
<li>AOF持久化方式记录每次对服务器写的操作,当服务器重启的时候会重新执行这些命令来恢复原始的数据,AOF命令以redis协议追加保存每次写的操作到文件末尾. </li>
<li>Redis还能对AOF文件进行后台重写,使得AOF文件的体积不至于过大</li>
<li>只做缓存：如果你只希望你的数据在服务器运行的时候存在,你也可以不使用任何持久化方式.</li>
<li>同时开启两种持久化方式</li>
<li>在这种情况下,当redis重启的时候会优先载入AOF文件来恢复原始的数据, 因为在通常情况下AOF文件保存的数据集要比RDB文件保存的数据集要完整.</li>
<li>RDB的数据不实时，同时使用两者时服务器重启也只会找AOF文件。那要不要只使用AOF呢？ </li>
<li>建议不要，因为RDB更适合用于备份数据库(AOF在不断变化不好备份)， 快速重启，而且不会有AOF可能潜在的bug，留着作为一个万一的手段。</li>
</ul>
<h3 id="性能建议"><a href="#性能建议" class="headerlink" title="性能建议"></a>性能建议</h3><ol>
<li><p>因为RDB文件只用作后备用途，建议只在Slave上持久化RDB文件，而且只要15分钟备份一次即可，只保留save 900 1这条规则。</p>
</li>
<li><p>如果使用AOF，好处是在最恶劣情况下也只会丢失不超过两秒数据，启动脚本较简单只load自己的AOF文件就可以了。 代价,一是带来了持续的IO，二是AOF rewrite的最后将rewrite过程中产生的新数据写到新文件造成的阻塞几乎是不可避免的。  </p>
</li>
<li><p><strong>只要硬盘许可，应该尽量减少AOF  rewrite的频率</strong>，AOF重写的基础大小默认值64M太小了，可以设到5G以上。  默认超过原大小100%大小时重写可以改到适当的数值。</p>
</li>
</ol>
<h1 id="Redis主从复制"><a href="#Redis主从复制" class="headerlink" title="Redis主从复制"></a><strong>Redis</strong>主从复制</h1><h2 id="定义-3"><a href="#定义-3" class="headerlink" title="定义"></a>定义</h2><p>​		主机数据更新后根据配置和策略， 自动同步到备机的master&#x2F;slaver机制，<strong>Master</strong>以写为主，Slave以读为主。</p>
<h2 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h2><ol>
<li><p>读写分离，性能扩展</p>
</li>
<li><p>容灾快速恢复</p>
</li>
</ol>
<img src="/2023/03/17/Redis/Java\Document\Redis\Redis.assets\image-20221008155953090.png" alt="image-20221008155953090" style="zoom:50%;">



<h2 id="搭建主从复制"><a href="#搭建主从复制" class="headerlink" title="搭建主从复制"></a>搭建主从复制</h2><p>拷贝多份 redis.conf 文件，使用 include 命令引入 &#x2F;etc&#x2F;redis.conf</p>
<ul>
<li>开启daemonize yes</li>
<li>Pid文件名字pidfile</li>
<li>指定端口port</li>
<li>Log文件名字</li>
<li>dump.rdb名字dbfilename</li>
<li>Appendonly 关掉或者换名字</li>
</ul>
<h3 id="第一步：新建配置文件"><a href="#第一步：新建配置文件" class="headerlink" title="第一步：新建配置文件"></a>第一步：新建配置文件</h3><p>在 &#x2F;opt&#x2F;redis&#x2F;redisConf 下新建配置文件 redis6379.conf，redis6380.conf，redis6381.conf</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">include /etc/redis.conf</span><br><span class="line">pidfile /var/run/redis_6381.pid</span><br><span class="line">port 6381</span><br><span class="line">dbfilename dump6381.rdb</span><br></pre></td></tr></table></figure>

<h3 id="第二步：启动三台Redis，查看进程"><a href="#第二步：启动三台Redis，查看进程" class="headerlink" title="第二步：启动三台Redis，查看进程"></a>第二步：启动三台Redis，查看进程</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost redis]# redis-server /opt/redis/redisConf/redis6379.conf</span><br><span class="line">[root@localhost redis]# redis-server /opt/redis/redisConf/redis6380.conf</span><br><span class="line">[root@localhost redis]# redis-server /opt/redis/redisConf/redis6381.conf</span><br><span class="line">[root@localhost redis]# ps -ef|grep redis</span><br><span class="line">root       1279      1  0 15:22 ?        00:00:12 redis-server *:6379</span><br><span class="line">root       1365      1  0 16:12 ?        00:00:00 redis-server *:6380</span><br><span class="line">root       1371      1  1 16:12 ?        00:00:00 redis-server *:6381</span><br><span class="line">root       1377   1254  0 16:12 pts/0    00:00:00 grep --color=auto redis</span><br></pre></td></tr></table></figure>

<h3 id="第三步：使用-info-replication-打印主从复制信息"><a href="#第三步：使用-info-replication-打印主从复制信息" class="headerlink" title="第三步：使用 info replication 打印主从复制信息"></a>第三步：使用 info replication 打印主从复制信息</h3><p>使用命令 redis-cli -p 6379 连接，此时三台Redis 没有相关性：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost redis]# redis-cli -p 6379</span><br><span class="line">127.0.0.1:6379&gt; info replication</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:b000a8297805ddb0f87b16a334ac5192fc090a9b</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:0</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:0</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:0</span><br><span class="line">repl_backlog_histlen:0</span><br></pre></td></tr></table></figure>

<h3 id="第四步：配置主机和从机"><a href="#第四步：配置主机和从机" class="headerlink" title="第四步：配置主机和从机"></a>第四步：配置主机和从机</h3><p>使用 slaveof <ip><port> 命令，在从机上配置它的主机。</port></ip></p>
<p>redis6379：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost redis]# redis-cli -p 6379</span><br><span class="line">127.0.0.1:6379&gt; info replication</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:2</span><br><span class="line">slave0:ip=127.0.0.1,port=6380,state=online,offset=56,lag=0</span><br><span class="line">slave1:ip=127.0.0.1,port=6381,state=online,offset=56,lag=0</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:8c04d0a2552ad18119aa3b0d037e957646a294ac</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:56</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:56</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<p>redis6380：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# redis-cli -p 6380</span><br><span class="line">127.0.0.1:6380&gt; slaveof 127.0.0.1 6379</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6380&gt; info replication</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Replication</span></span><br><span class="line">role:slave</span><br><span class="line">master_host:127.0.0.1</span><br><span class="line">master_port:6379</span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:2</span><br><span class="line">master_sync_in_progress:0</span><br><span class="line">slave_repl_offset:56</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:8c04d0a2552ad18119aa3b0d037e957646a294ac</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:56</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:56</span><br><span class="line">127.0.0.1:6380&gt;</span><br></pre></td></tr></table></figure>

<p>redis6381：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# redis-cli -p 6381</span><br><span class="line">127.0.0.1:6381&gt; slaveof 127.0.0.1 6379</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6381&gt; info replication</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Replication</span></span><br><span class="line">role:slave</span><br><span class="line">master_host:127.0.0.1</span><br><span class="line">master_port:6379</span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:2</span><br><span class="line">master_sync_in_progress:0</span><br><span class="line">slave_repl_offset:42</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:8c04d0a2552ad18119aa3b0d037e957646a294ac</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:42</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:29</span><br><span class="line">repl_backlog_histlen:14</span><br><span class="line">127.0.0.1:6381&gt;</span><br></pre></td></tr></table></figure>

<h3 id="第五步：读写数据"><a href="#第五步：读写数据" class="headerlink" title="第五步：读写数据"></a>第五步：读写数据</h3><p>在主机上写，在从机上可以读取数据，在从机上写数据报错：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# redis-cli -p 6381</span><br><span class="line">127.0.0.1:6381&gt; get k1</span><br><span class="line">&quot;v1&quot;</span><br><span class="line">127.0.0.1:6381&gt; set k1 v2</span><br><span class="line">(error) READONLY You can&#x27;t write against a read only replica.</span><br><span class="line">127.0.0.1:6381&gt;</span><br></pre></td></tr></table></figure>

<h3 id="第六步：主机挂掉，重启仍是master"><a href="#第六步：主机挂掉，重启仍是master" class="headerlink" title="第六步：主机挂掉，重启仍是master"></a>第六步：主机挂掉，重启仍是master</h3><h3 id="第七步：从机重启，需要重设：slaveof-127-0-0-1-6379"><a href="#第七步：从机重启，需要重设：slaveof-127-0-0-1-6379" class="headerlink" title="第七步：从机重启，需要重设：slaveof 127.0.0.1 6379"></a>第七步：从机重启，需要重设：slaveof 127.0.0.1 6379</h3><p>可以将配置增加到文件中。永久生效。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ps -ef |grep redis</span><br><span class="line">root       1459      1  0 16:19 ?        00:00:02 redis-server *:6379</span><br><span class="line">root       1466      1  0 16:19 ?        00:00:02 redis-server *:6380</span><br><span class="line">root       1472      1  0 16:20 ?        00:00:02 redis-server *:6381</span><br><span class="line">root       1483   1254  0 16:25 pts/0    00:00:00 redis-cli -p 6379</span><br><span class="line">root       1485   1386  0 16:25 pts/2    00:00:00 redis-cli -p 6380</span><br><span class="line">root       1492   1424  0 16:28 pts/1    00:00:00 grep --color=auto redis</span><br><span class="line">[root@localhost ~]# kill -9 1466</span><br><span class="line">[root@localhost ~]# redis-server /opt/redis/redisConf/redis6380.conf</span><br><span class="line">[root@localhost ~]# redis-cli -p 6380</span><br><span class="line">127.0.0.1:6380&gt; info replication</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:8628d72c430b24fa92275794735788802033a865</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:0</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:0</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:0</span><br><span class="line">repl_backlog_histlen:0</span><br></pre></td></tr></table></figure>



<h2 id="主从复制原理"><a href="#主从复制原理" class="headerlink" title="主从复制原理"></a><strong>主从复制原理</strong></h2><ol>
<li>Slave 启动成功连接到 master 后会发送一个 sync 命令</li>
<li>Master接到命令启动后台的存盘进程，同时收集所有接收到的用于修改数据集命令， 在后台进程执行完毕之后，master将传送整个数据文件到 slave，以完成一次完全同步</li>
<li>全量复制：而slave服务在接收到数据库文件数据后，将其存盘并加载到内存中</li>
<li>增量复制：Master继续将新的所有收集到的修改命令依次传给 slave，完成同步</li>
<li><strong>但是只要是重新连接 master，一次完全同步（全量复制）将被自动执行</strong></li>
</ol>
<h2 id="问题：主机从机宕机数据复制问题"><a href="#问题：主机从机宕机数据复制问题" class="headerlink" title="问题：主机从机宕机数据复制问题"></a>问题：主机从机宕机数据复制问题</h2><ol>
<li>从机 slave 是全量赋值，从头开始复制，新增的键会重新复制</li>
<li>从机 slave 可以只能读，不能写</li>
<li>主机 shutdown 后，从机原地待命，不会变为主机</li>
<li>主机 shutdown 后，又重新启动，从机仍能接受数据</li>
<li>从机 shutdown 后，重新启动，会重头开始启动</li>
</ol>
<p>示例：</p>
<h2 id="问题：Slave也可以是-Master"><a href="#问题：Slave也可以是-Master" class="headerlink" title="问题：Slave也可以是 Master"></a>问题：Slave也可以是 Master</h2><p>上一个 Slave 可以是下一个 Slave 的 Master，Slave 同样可以接收其他 Slaves 的连接和同步请求，那么该 Slave 作为了链条中下一个的 Master, 可以有效减轻 Master 的写压力，去中心化降低风险。</p>
<p>用 Slaveof <ip><port></port></ip></p>
<p>中途变更转向：会清除之前的数据，重新建立拷贝最新的</p>
<p>风险是一旦某个 Slave 宕机，后面的 Slave 都没法备份</p>
<p>主机挂了，从机还是从机，无法写数据了</p>
<h2 id="问题：Master宕机后，从机变为主机"><a href="#问题：Master宕机后，从机变为主机" class="headerlink" title="问题：Master宕机后，从机变为主机"></a>问题：Master宕机后，从机变为主机</h2><p>当一个master宕机后，使用 slaveof no one  将从机变为主机。</p>
<p>后面的slave可以立刻升为master，其后面的slave不用做任何修改。</p>
<h2 id="哨兵模式（sentinel）"><a href="#哨兵模式（sentinel）" class="headerlink" title="哨兵模式（sentinel）"></a><strong>哨兵模式</strong>（sentinel）</h2><p>主机 shutdown 后，在从机中选出主机。</p>
<p>通过哨兵能够后台监控主机是否故障，如果出现故障，则根据投票数自动将从库转换为主库。</p>
<h3 id="第一步：新建-sentinel-conf-文件"><a href="#第一步：新建-sentinel-conf-文件" class="headerlink" title="第一步：新建 sentinel.conf 文件"></a>第一步：新建 sentinel.conf 文件</h3><p><strong>文件名必须匹配</strong></p>
<h3 id="第二步：配置文件内容"><a href="#第二步：配置文件内容" class="headerlink" title="第二步：配置文件内容"></a>第二步：配置文件内容</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mymaster: 主机别名，1：至少有多少个哨兵同意迁移的数量。</span> </span><br><span class="line">sentinel monitor mymaster 127.0.0.1 6379 1</span><br></pre></td></tr></table></figure>

<h3 id="第三步：启动哨兵"><a href="#第三步：启动哨兵" class="headerlink" title="第三步：启动哨兵"></a>第三步：启动哨兵</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost redis]# vim redisConf/sentinel.conf</span><br><span class="line">sentinel monitor mymaster 127.0.0.1 6379 1</span><br><span class="line">[root@localhost redis]# ls /usr/local/bin/</span><br><span class="line">redis-benchmark  redis-check-aof  redis-check-rdb  redis-cli  redis-sentinel  redis-server</span><br><span class="line">[root@localhost redis]# redis-sentinel /opt/redis/redisConf/sentinel.conf</span><br></pre></td></tr></table></figure>

<p><img src="/2023/03/17/Redis/Java\Document\Redis\Redis.assets\image-20221008170523011.png" alt="image-20221008170523011"></p>
<h3 id="第四步：当主机挂掉，从机选举中产生新的主机"><a href="#第四步：当主机挂掉，从机选举中产生新的主机" class="headerlink" title="第四步：当主机挂掉，从机选举中产生新的主机"></a>第四步：当主机挂掉，从机选举中产生新的主机</h3><p>选举原则：根据优先级别：slave-priority ，原主机重启后会变为从机。</p>
<p>slave-priority 默认100，数值越小，优先级越高。</p>
<p><img src="/2023/03/17/Redis/Java\Document\Redis\Redis.assets\image-20221008171004905.png" alt="image-20221008171004905"></p>
<h3 id="复制延时"><a href="#复制延时" class="headerlink" title="复制延时"></a><strong>复制延时</strong></h3><p>由于所有的写操作都是先在Master上操作，然后同步更新到Slave上，所以从Master同步到Slave机器有一定的延迟，当系统很繁忙的时候，延迟问题会更加严重，Slave机器数量的增加也会使这个问题更加严重。</p>
<h3 id="故障恢复"><a href="#故障恢复" class="headerlink" title="故障恢复"></a>故障恢复</h3><h4 id="选择条件"><a href="#选择条件" class="headerlink" title="选择条件"></a>选择条件</h4><p>选择优先级高的，偏移量大的，runid 最小的服务。</p>
<ul>
<li>优先级在 redis.conf 中默认：slave-priority 100，值越小优先级越高</li>
<li>偏移量：指获得原主机数据最全的</li>
<li>每个 redis 实例启动后都会随机生成一个40位的 runid</li>
</ul>
<p>挑选出新的主服务后，sentinel会向原主服务的从服务发送 slaveof 新主机的命令，复制新的 master。</p>
<p>当原主机重新上线后，sentinel 同样会发送 slaveof 命令，让其成为新主机的从机。</p>
<h2 id="Java代码实现主从复制"><a href="#Java代码实现主从复制" class="headerlink" title="Java代码实现主从复制"></a>Java代码实现主从复制</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> JedisSentinelPool jedisSentinelPool=<span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span>  Jedis <span class="title function_">getJedisFromSentinel</span><span class="params">()</span>&#123;</span><br><span class="line"><span class="keyword">if</span>(jedisSentinelPool==<span class="literal">null</span>)&#123;</span><br><span class="line">            Set&lt;String&gt; sentinelSet=<span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">            sentinelSet.add(<span class="string">&quot;192.168.100.100:26379&quot;</span>);</span><br><span class="line">            <span class="type">JedisPoolConfig</span> <span class="variable">jedisPoolConfig</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">JedisPoolConfig</span>();</span><br><span class="line">            jedisPoolConfig.setMaxTotal(<span class="number">10</span>); <span class="comment">//最大可用连接数</span></span><br><span class="line">jedisPoolConfig.setMaxIdle(<span class="number">5</span>); <span class="comment">//最大闲置连接数</span></span><br><span class="line">jedisPoolConfig.setMinIdle(<span class="number">5</span>); <span class="comment">//最小闲置连接数</span></span><br><span class="line">jedisPoolConfig.setBlockWhenExhausted(<span class="literal">true</span>); <span class="comment">//连接耗尽是否等待</span></span><br><span class="line">jedisPoolConfig.setMaxWaitMillis(<span class="number">2000</span>); <span class="comment">//等待时间</span></span><br><span class="line">jedisPoolConfig.setTestOnBorrow(<span class="literal">true</span>); <span class="comment">//取连接的时候进行一下测试 ping pong</span></span><br><span class="line"></span><br><span class="line">jedisSentinelPool=<span class="keyword">new</span> <span class="title class_">JedisSentinelPool</span>(<span class="string">&quot;mymaster&quot;</span>,sentinelSet,jedisPoolConfig);</span><br><span class="line"><span class="keyword">return</span> jedisSentinelPool.getResource();</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">return</span> jedisSentinelPool.getResource();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="Redis-集群"><a href="#Redis-集群" class="headerlink" title="Redis 集群"></a><strong>Redis</strong> 集群</h1><h2 id="解决的问题"><a href="#解决的问题" class="headerlink" title="解决的问题"></a>解决的问题</h2><ul>
<li><p>容量不够，Redis 扩容问题</p>
</li>
<li><p>并发写操作， Redis 分摊操作</p>
<p>  如不同的请求数据会放在不同的 Redis 中进行缓存，可以通过代理主机进行解决。但是 Redis3.0 中提供了解决方案。就是无中心化集群配置：每一个 Redis 服务都会转发给其他的 Redis。</p>
</li>
</ul>
<h2 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h2><p>Redis 集群实现了对 Redis 的水平扩容，即启动 N 个 redis 节点，将整个数据库分布存储在这 N 个节点中，每个节点存储总数据的1&#x2F;N。</p>
<p><strong>Redis 集群通过分区（partition）来提供一定程度的可用性（availability）</strong>： 即使集群中有一部分节点失效或者无法进行通讯， 集群也可以继续处理命令请求。</p>
<h2 id="搭建集群环境"><a href="#搭建集群环境" class="headerlink" title="搭建集群环境"></a>搭建集群环境</h2><h3 id="第一步：新建配置文件-1"><a href="#第一步：新建配置文件-1" class="headerlink" title="第一步：新建配置文件"></a>第一步：新建配置文件</h3><p>在 &#x2F;opt&#x2F;redis&#x2F;redisClusterConf 下新建 redis6379.conf 配置</p>
<p>使用端口：6379	6380	6381	6389	6390	6391</p>
<p><strong>配置信息：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">include /etc/redis.conf</span><br><span class="line">pidfile /var/run/redis_6379.pid</span><br><span class="line">port 6379</span><br><span class="line">dbfilename dump6379.rdb</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">打开集群模式</span></span><br><span class="line">cluster-enabled yes</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设定节点配置文件名</span></span><br><span class="line">cluster-config-file nodes-6379.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设定节点失联时间，超过该时间（毫秒），集群自动进行主从切换。</span></span><br><span class="line">cluster-node-timeout 15000</span><br></pre></td></tr></table></figure>

<p>拷贝多份文件，并在 vim 中使用命令替换：%s&#x2F;6379&#x2F;6380 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost redisClusterConf]# ll</span><br><span class="line">总用量 24</span><br><span class="line">-rw-r--r--. 1 root root 318 10月  8 17:40 redis6379.conf</span><br><span class="line">-rw-r--r--. 1 root root 318 10月  8 17:42 redis6380.conf</span><br><span class="line">-rw-r--r--. 1 root root 318 10月  8 17:42 redis6381.conf</span><br><span class="line">-rw-r--r--. 1 root root 318 10月  8 17:42 redis6389.conf</span><br><span class="line">-rw-r--r--. 1 root root 318 10月  8 17:43 redis6390.conf</span><br><span class="line">-rw-r--r--. 1 root root 318 10月  8 17:44 redis6391.conf</span><br></pre></td></tr></table></figure>

<h3 id="第二步：启动6个实例"><a href="#第二步：启动6个实例" class="headerlink" title="第二步：启动6个实例"></a>第二步：启动6个实例</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost redisClusterConf]# redis-server /opt/redis/redisClusterConf/redis6379.conf</span><br><span class="line">[root@localhost redisClusterConf]# redis-server /opt/redis/redisClusterConf/redis6380.conf</span><br><span class="line">[root@localhost redisClusterConf]# redis-server /opt/redis/redisClusterConf/redis6381.conf</span><br><span class="line">[root@localhost redisClusterConf]# redis-server /opt/redis/redisClusterConf/redis6389.conf</span><br><span class="line">[root@localhost redisClusterConf]# redis-server /opt/redis/redisClusterConf/redis6390.conf</span><br><span class="line">[root@localhost redisClusterConf]# redis-server /opt/redis/redisClusterConf/redis6391.conf</span><br><span class="line">[root@localhost redisClusterConf]# ps -ef|grep redis</span><br><span class="line">root       1620      1  0 17:58 ?        00:00:00 redis-server *:6379 [cluster]</span><br><span class="line">root       1626      1  0 17:58 ?        00:00:00 redis-server *:6380 [cluster]</span><br><span class="line">root       1632      1  0 17:58 ?        00:00:00 redis-server *:6381 [cluster]</span><br><span class="line">root       1638      1  1 17:58 ?        00:00:00 redis-server *:6389 [cluster]</span><br><span class="line">root       1644      1  1 17:58 ?        00:00:00 redis-server *:6390 [cluster]</span><br><span class="line">root       1650      1  1 17:58 ?        00:00:00 redis-server *:6391 [cluster]</span><br><span class="line">root       1656   1254  0 17:59 pts/0    00:00:00 grep --color=auto redis</span><br><span class="line">[root@localhost redisClusterConf]#</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="第三步：启动集群"><a href="#第三步：启动集群" class="headerlink" title="第三步：启动集群"></a>第三步：启动集群</h3><p>命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost redisClusterConf]# redis-cli --cluster create --cluster-replicas 1 192.168.100.100:6379 192.168.100.100:6380 192.168.100.100:6381 192.168.100.100:6389 192.168.100.100:6390 192.168.100.100:6391</span><br></pre></td></tr></table></figure>

<p>注意：此处不要用127.0.0.1， 请用真实IP地址，**–replicas 1 采用最简单的方式配置集群，一台主机，一台从机，正好三组。**</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost redisClusterConf]# redis-cli --cluster create --cluster-replicas 1 192.168.100.100:6379 192.168.100.100:6380 192.168.100.100:6381 192.168.100.100:6389 192.168.100.100:6390 192.168.100.100:6391</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Performing <span class="built_in">hash</span> slots allocation on 6 nodes...</span></span><br><span class="line">Master[0] -&gt; Slots 0 - 5460</span><br><span class="line">Master[1] -&gt; Slots 5461 - 10922</span><br><span class="line">Master[2] -&gt; Slots 10923 - 16383</span><br><span class="line">Adding replica 192.168.100.100:6390 to 192.168.100.100:6379</span><br><span class="line">Adding replica 192.168.100.100:6391 to 192.168.100.100:6380</span><br><span class="line">Adding replica 192.168.100.100:6389 to 192.168.100.100:6381</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Trying to optimize slaves allocation <span class="keyword">for</span> anti-affinity</span></span><br><span class="line">[WARNING] Some slaves are in the same host as their master</span><br><span class="line">M: a0db3d6715900a287d3222ae4b40cc43f8857a95 192.168.100.100:6379</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">M: e37ee97bc6f1479f01515f51dc595ede9a21a0de 192.168.100.100:6380</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">M: 622309a93a73692b81b62481c89c5098da6232f4 192.168.100.100:6381</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">S: 2a7798be8210b18bac7bbdbaed7a51d76e9a0a59 192.168.100.100:6389</span><br><span class="line">   replicates 622309a93a73692b81b62481c89c5098da6232f4</span><br><span class="line">S: d265240801f512f9df68562029dc6df65afe6ddc 192.168.100.100:6390</span><br><span class="line">   replicates a0db3d6715900a287d3222ae4b40cc43f8857a95</span><br><span class="line">S: dc245aad961e75cb71d0ff86de5f83aa3c4bee22 192.168.100.100:6391</span><br><span class="line">   replicates e37ee97bc6f1479f01515f51dc595ede9a21a0de</span><br><span class="line">Can I set the above configuration? (type &#x27;yes&#x27; to accept): yes</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Nodes configuration updated</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Assign a different config epoch to each node</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Sending CLUSTER MEET messages to <span class="built_in">join</span> the cluster</span></span><br><span class="line">Waiting for the cluster to join</span><br><span class="line">.</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Performing Cluster Check (using node 192.168.100.100:6379)</span></span><br><span class="line">M: a0db3d6715900a287d3222ae4b40cc43f8857a95 192.168.100.100:6379</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: dc245aad961e75cb71d0ff86de5f83aa3c4bee22 192.168.100.100:6391</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates e37ee97bc6f1479f01515f51dc595ede9a21a0de</span><br><span class="line">S: 2a7798be8210b18bac7bbdbaed7a51d76e9a0a59 192.168.100.100:6389</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 622309a93a73692b81b62481c89c5098da6232f4</span><br><span class="line">M: 622309a93a73692b81b62481c89c5098da6232f4 192.168.100.100:6381</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: d265240801f512f9df68562029dc6df65afe6ddc 192.168.100.100:6390</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates a0db3d6715900a287d3222ae4b40cc43f8857a95</span><br><span class="line">M: e37ee97bc6f1479f01515f51dc595ede9a21a0de 192.168.100.100:6380</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check <span class="keyword">for</span> open slots...</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check slots coverage...</span></span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line">[root@localhost redisClusterConf]#</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="第四步：登录"><a href="#第四步：登录" class="headerlink" title="第四步：登录"></a>第四步：登录</h3><h4 id="普通方式登录"><a href="#普通方式登录" class="headerlink" title="普通方式登录"></a>普通方式登录</h4><p>​		可能直接进入读主机，存储数据时，会出现 MOVED 重定向操作。应该以集群方式登录。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost redisClusterConf]# redis-cli -p 6379</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">(empty array)</span><br><span class="line">127.0.0.1:6379&gt; set k1 v1</span><br><span class="line">(error) MOVED 12706 192.168.100.100:6381</span><br></pre></td></tr></table></figure>

<h4 id="集群方式登录"><a href="#集群方式登录" class="headerlink" title="集群方式登录"></a>集群方式登录</h4><p> <strong>-c</strong>	<strong>采用集群策略连接，设置数据会自动切换到相应的写主机</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# redis-cli -c -p 6379</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">(empty array)</span><br><span class="line">127.0.0.1:6379&gt; set k1 v1</span><br><span class="line"><span class="meta prompt_">-&gt; </span><span class="language-bash">Redirected to slot [12706] located at 192.168.100.100:6381</span></span><br><span class="line">OK</span><br><span class="line">192.168.100.100:6381&gt;</span><br></pre></td></tr></table></figure>

<p>连接集群，写入数据时，会将数据放入slot 为 12706中，并重定向到该主机。</p>
<h3 id="查看集群信息"><a href="#查看集群信息" class="headerlink" title="查看集群信息"></a><strong>查看集群信息</strong></h3><p>通过 cluster nodes 命令查看集群信息：</p>
<p><img src="/2023/03/17/Redis/Java\Document\Redis\Redis.assets\image-20221008192527530.png" alt="image-20221008192527530"></p>
<h3 id="redis-cluster-节点分配"><a href="#redis-cluster-节点分配" class="headerlink" title="redis cluster 节点分配"></a><strong>redis cluster 节点分配</strong></h3><p>一个集群至少要有三个主节点。</p>
<p>选项 <strong>–cluster-replicas 1</strong> 表示我们希望为集群中的每个主节点创建一个从节点。</p>
<p>分配原则尽量保证每个主数据库运行在不同的IP地址，每个从库和主库不在一个IP地址上。</p>
<h2 id="slots"><a href="#slots" class="headerlink" title="slots"></a>slots</h2><blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check <span class="keyword">for</span> open slots...</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check slots coverage...</span></span><br><span class="line">[OK] All 16384 slots covered.</span><br></pre></td></tr></table></figure>
</blockquote>
<ol>
<li><p>一个 Redis 集群包含 16384 个插槽（hash slot）， 数据库中的每个键都属于这 16384 个插槽的其中一个。 </p>
</li>
<li><p>集群使用公式 CRC16(key) % 16384 来计算键 key 属于哪个槽，  CRC16(key) 语句用于计算键 key 的 CRC16 校验和 </p>
</li>
<li><p>集群中的每个节点负责处理一部分插槽。 如一个集群中：</p>
<p> 节点 A 负责处理 0 号至 5460 号插槽。</p>
<p> 节点 B 负责处理 5461 号至 10922 号插槽。</p>
<p> 节点 C 负责处理 10923 号至 16383 号插槽。</p>
</li>
</ol>
<h2 id="集群中读写数据"><a href="#集群中读写数据" class="headerlink" title="集群中读写数据"></a>集群中读写数据</h2><p>​		在 redis-cli 每次录入、查询键值，redis 都会计算出该 key 应该送往的插槽，如果不是该客户端对应服务器的插槽，redis 会报错，并告知应前往的 redis 实例地址和端口。</p>
<p>redis-cli 客户端提供了 –c 参数实现自动重定向。</p>
<p>如 redis-cli -c –p 6379 登入后，再录入、查询键值对可以自动重定向。</p>
<p>不在一个 slot 下的键值，是不能使用 mget，mset 等多键操作，但可以通过 { } 来定义组的概念，从而使key中 { } 内相同内容的键值对放到一个 slot 中去。</p>
<p>CLUSTER GETKEYSINSLOT <slot><count> 	返回 count 个 slot 槽中的键。</count></slot></p>
<p><strong>注意：各客户端只能看自己插槽范围内的值。</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; mset k1 v1 k2 v2 k3 v3</span><br><span class="line">(error) CROSSSLOT Keys in request don&#x27;t hash to the same slot</span><br><span class="line">127.0.0.1:6379&gt; mset k1&#123;cust&#125; v1 k2&#123;cust&#125; v2 k3&#123;cust&#125; v3</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; cluster keyslot k1</span><br><span class="line">(integer) 12706</span><br><span class="line">127.0.0.1:6379&gt; CLUSTER COUNTKEYSINSLOT 12706</span><br><span class="line">(integer) 0</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; cluster keyslot cust</span><br><span class="line">(integer) 4847</span><br><span class="line">127.0.0.1:6379&gt; cluster countKeysinslot 4847</span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:6379&gt; CLUSTER GETKEYSINSLOT 4847 5</span><br><span class="line">1) &quot;k1&#123;cust&#125;&quot;</span><br><span class="line">2) &quot;k2&#123;cust&#125;&quot;</span><br><span class="line">3) &quot;k3&#123;cust&#125;&quot;</span><br><span class="line">127.0.0.1:6379&gt; get k1&#123;cust&#125;</span><br><span class="line">&quot;v1&quot;</span><br><span class="line">127.0.0.1:6379&gt; get k1</span><br><span class="line"><span class="meta prompt_">-&gt; </span><span class="language-bash">Redirected to slot [12706] located at 192.168.100.100:6381</span></span><br><span class="line">&quot;v1&quot;</span><br><span class="line">192.168.100.100:6381&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="故障恢复-1"><a href="#故障恢复-1" class="headerlink" title="故障恢复"></a>故障恢复</h2><p>如果主节点下线，从节点会升为主节点，主节点恢复后，主节点会变为从机。</p>
<p>示例：关掉 6380</p>
<p><img src="/2023/03/17/Redis/Java\Document\Redis\Redis.assets\image-20221008192932653.png" alt="image-20221008192932653"></p>
<p>如果所有某一段插槽的主从节点都宕掉，redis服务是否还能继续?</p>
<p>如果某一段插槽的主从都挂掉，而 cluster-require-full-coverage 为 yes ，那么整个集群都挂掉</p>
<p>如果某一段插槽的主从都挂掉，而 cluster-require-full-coverage 为 no ，那么该插槽数据全都不能使用，也无法存储。</p>
<p><strong>redis.conf</strong> 中的参数 <strong>cluster-require-full-coverage</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">By default Redis Cluster nodes stop accepting queries <span class="keyword">if</span> they detect there</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">is at least a <span class="built_in">hash</span> slot uncovered (no available node is serving it).</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This way <span class="keyword">if</span> the cluster is partially down (<span class="keyword">for</span> example a range of <span class="built_in">hash</span> slots</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">are no longer covered) all the cluster becomes, eventually, unavailable.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">It automatically returns available as soon as all the slots are covered again.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># However sometimes you want the subset of the cluster which is working,</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">to <span class="built_in">continue</span> to accept queries <span class="keyword">for</span> the part of the key space that is still</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">covered. In order to <span class="keyword">do</span> so, just <span class="built_in">set</span> the cluster-require-full-coverage</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">option to no.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># cluster-require-full-coverage yes</span></span></span><br></pre></td></tr></table></figure>

<h2 id="集群的-Jedis-开发"><a href="#集群的-Jedis-开发" class="headerlink" title="集群的 Jedis 开发"></a>集群的 Jedis 开发</h2><p>即使连接的不是主机，集群会自动切换主机存储。主机写，从机读。</p>
<p>无中心化主从集群。无论从哪台主机写的数据，其他主机上都能读到数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.HostAndPort;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisCluster;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Redis 集群测试：关闭防火墙</span></span><br><span class="line"><span class="comment"> * 即使连接的不是主机，集群会自动切换主机存储。主机写，从机读。</span></span><br><span class="line"><span class="comment"> * 无中心化主从集群。无论从哪台主机写的数据，其他主机上都能读到数据。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JedisClusterTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        HashSet&lt;HostAndPort&gt; set = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        set.add(<span class="keyword">new</span> <span class="title class_">HostAndPort</span>(<span class="string">&quot;192.168.100.100&quot;</span>,<span class="number">6379</span>));</span><br><span class="line">        <span class="type">JedisCluster</span> <span class="variable">jedisCluster</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JedisCluster</span>(set);</span><br><span class="line">        jedisCluster.set(<span class="string">&quot;k&quot;</span>,<span class="string">&quot;v&quot;</span>);</span><br><span class="line">        System.out.println(jedisCluster.get(<span class="string">&quot;k&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Redis-集群优点"><a href="#Redis-集群优点" class="headerlink" title="Redis 集群优点"></a><strong>Redis</strong> 集群优点</h2><ul>
<li>实现扩容</li>
<li>分摊压力</li>
<li>无中心配置相对简单</li>
</ul>
<h2 id="Redis-集群的不足"><a href="#Redis-集群的不足" class="headerlink" title="Redis 集群的不足"></a><strong>Redis</strong> <strong>集群的不足</strong></h2><ul>
<li>多键操作是不被支持的 </li>
<li>多键的Redis事务是不被支持的。lua脚本不被支持</li>
<li>由于集群方案出现较晚，很多公司已经采用了其他的集群方案，而代理或者客户端分片的方案想要迁移至redis cluster，需要整体迁移而不是逐步过渡，复杂度较大。</li>
</ul>
<h1 id="Redis-应用问题"><a href="#Redis-应用问题" class="headerlink" title="Redis 应用问题"></a>Redis 应用问题</h1><h2 id="缓存穿透"><a href="#缓存穿透" class="headerlink" title="缓存穿透"></a>缓存穿透</h2><h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>​		key 对应的数据在数据源并不存在，每次针对此 key 的请求从缓存获取不到，请求都会压到数据源，从而可能压垮数据源。比如用一个不存在的用户 id 获取用户信息，不论缓存还是数据库都没有，若黑客利用此漏洞进行攻击可能压垮数据库。</p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>​		一个一定不存在缓存及查询不到的数据，由于缓存是不命中时被动写的，并且出于容错考虑，如果从存储层查不到数据则不写入缓存，这将导致这个不存在的数据每次请求都要到存储层去查询，失去了缓存的意义。</p>
<p>解决方案：</p>
<p>（1）  <strong>对空值缓存：</strong>如果一个查询返回的数据为空（不管是数据是否不存在），我们仍然把这个空结果（null）进行缓			存，设置空结果的过期时间会很短，最长不超过五分钟</p>
<p>（2）  <strong>设置可访问的名单（白名单）：</strong></p>
<p>​			使用 bitmaps 类型定义一个可以访问的名单，名单 id 作为 bitmaps 的偏移量，每次访问和 bitmap 里面的 id 进行			比较，如果访问 id 不在 bitmaps 里面，进行拦截，不允许访问。</p>
<p>（3）  <strong>采用布隆过滤器</strong>：(布隆过滤器（Bloom Filter）是1970年由布隆提出的。它实际上是一个很长的二进制向量(位图)			和一系列随机映射函数（哈希函数）。</p>
<p>​			布隆过滤器可以用于检索一个元素是否在一个集合中。它的优点是空间效率和查询时间都远远超过一般的算法，缺			点是有一定的误识别率和删除困难。)</p>
<p>​			将所有可能存在的数据哈希到一个足够大的 bitmaps 中，一个一定不存在的数据会被这个 bitmaps 拦截掉，从而			避免了对底层存储系统的查询压力。</p>
<p><strong>（4）</strong>  <strong>进行实时监控：</strong>当发现 Redis 的命中率开始急速降低，需要排查访问对象和访问的数据，和运维人员配合，可以设			置黑名单限制服务。</p>
<h2 id="缓存击穿"><a href="#缓存击穿" class="headerlink" title="缓存击穿"></a>缓存击穿</h2><h3 id="问题描述-1"><a href="#问题描述-1" class="headerlink" title="问题描述"></a>问题描述</h3><p>​		key 对应的数据存在，但在 redis 中过期，此时若有大量并发请求过来，这些请求发现缓存过期一般都会从后端DB加载数据并回设到缓存，这个时候大并发的请求可能会瞬间把后端DB压垮。</p>
<h3 id="解决方案-1"><a href="#解决方案-1" class="headerlink" title="解决方案"></a>解决方案</h3><p>​		key 可能会在某些时间点被超高并发地访问，是一种非常 “热点” 的数据。这个时候，需要考虑一个问题：缓存被 “击穿” 的问题。</p>
<p>解决问题：</p>
<p>（1）预先设置热门数据：在redis高峰访问之前，把一些热门数据提前存入到redis里面，加大这些热门数据key的时长</p>
<p>（2）实时调整：现场监控哪些数据热门，实时调整 key 的过期时长</p>
<p>（3）使用锁：</p>
<ul>
<li>就是在缓存失效的时候（判断拿出来的值为空），不是立即去load db。</li>
<li>先使用缓存工具的某些带成功操作返回值的操作（比如 Redis 的 SETNX）去set一个mutex key</li>
<li>当操作返回成功时，再进行load db的操作，并回设缓存，最后删除 mutex key；</li>
<li>当操作返回失败，证明有线程在load db，当前线程睡眠一段时间再重试整个 get 缓存的方法。</li>
</ul>
<img src="/2023/03/17/Redis/Java\Document\Redis\Redis.assets\image-20221008200000951.png" alt="image-20221008200000951" style="zoom:67%;">

<h2 id="缓存雪崩"><a href="#缓存雪崩" class="headerlink" title="缓存雪崩"></a>缓存雪崩</h2><h3 id="问题描述-2"><a href="#问题描述-2" class="headerlink" title="问题描述"></a>问题描述</h3><p>​		key 对应的数据存在，但在 redis 中过期，此时若有大量并发请求过来，这些请求发现缓存过期一般都会从后端DB加载数据并回设到缓存，这个时候大并发的请求可能会瞬间把后端DB压垮。</p>
<p><strong>缓存雪崩与缓存击穿的区别在于这里针对很多key缓存，前者则是某一个key。</strong></p>
<h3 id="解决方案-2"><a href="#解决方案-2" class="headerlink" title="解决方案"></a>解决方案</h3><p>缓存失效时的雪崩效应对底层系统的冲击非常可怕！</p>
<p>解决方案：</p>
<p><strong>（1）</strong>  <strong>构建多级缓存架构：</strong>nginx缓存 + redis缓存 +其他缓存（ehcache等）</p>
<p><strong>（2）</strong>  <strong>使用锁或队列：</strong></p>
<p>​		用加锁或者队列的方式保证来保证不会有大量的线程对数据库一次性进行读写，从而避免失效时大量的并发请求落到		底层存储系统上。不适用高并发情况。</p>
<p><strong>（3）</strong>  <strong>设置过期标志更新缓存：</strong></p>
<p>​		记录缓存数据是否过期（设置提前量），如果过期会触发通知另外的线程在后台去更新实际key的缓存。</p>
<p><strong>（4）</strong>  <strong>将缓存失效时间分散开：</strong></p>
<p>​		比如我们可以在原有的失效时间基础上增加一个随机值，比如1-5分钟随机，这样每一个缓存的过期时间的重复率就会		降低，就很难引发集体失效的事件。</p>
<h2 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h2><p>​		随着业务发展的需要，原单体单机部署的系统被演化成分布式集群系统后，由于分布式系统多线程、多进程并且分布在不同机器上，这将使原单机部署情况下的并发控制锁策略失效，单纯的 Java API 并不能提供分布式锁的能力。为了解决这个问题就需要一种跨 JVM 的互斥机制来控制共享资源的访问，这就是分布式锁要解决的问题。</p>
<p>分布式锁主流的实现方案：</p>
<ol>
<li><p>基于数据库实现分布式锁</p>
</li>
<li><p>基于缓存（Redis等）</p>
</li>
<li><p>基于Zookeeper</p>
</li>
</ol>
<p>每一种分布式锁解决方案都有各自的优缺点：</p>
<ol>
<li><p>性能：redis最高</p>
</li>
<li><p>可靠性：zookeeper最高</p>
<p> 这里，我们就基于 redis 实现分布式锁。</p>
</li>
</ol>
<h3 id="Redis实现分布式锁"><a href="#Redis实现分布式锁" class="headerlink" title="Redis实现分布式锁"></a>Redis实现分布式锁</h3><h3 id="设置锁的过期时间"><a href="#设置锁的过期时间" class="headerlink" title="设置锁的过期时间"></a>设置锁的过期时间</h3><p>命令：set	k	v	nx	px	10000</p>
<p>以上可以保证原子性，如果 Setnx 后在 expire，中间 Server 宕机不能保证原子性。</p>
<p>EX second </p>
<p>​		设置键的过期时间为 Second 秒。 SET key value EX second 效果等同于 SETEX key second value 。</p>
<p>PX millisecond</p>
<p>​		设置键的过期时间为 millisecond 毫秒。 SET key value PX millisecond 效果等同于 PSETEX key millisecond value </p>
<p>NX		只在键不存在时，才对键进行设置操作。 SET key value NX 效果等同于 SETNX key value 。</p>
<p>XX		只在键已经存在时，才对键进行设置操作。</p>
<p>示例：</p>
<ol>
<li><p>多个客户端同时获取锁（setnx）</p>
</li>
<li><p>获取成功，执行业务逻辑{从db获取数据，放入缓存}，执行完成释放锁（del）</p>
</li>
<li><p>其他客户端等待重试</p>
</li>
</ol>
<p>代码示例：</p>
<p>application.properties：注意集群版和单机版的区别</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Redis: 单机配置</span></span><br><span class="line"><span class="comment">#spring.redis.host=192.168.100.100</span></span><br><span class="line"><span class="comment">##Redis服务器连接端口</span></span><br><span class="line"><span class="comment">#spring.redis.port=6379</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Redis集群配置</span></span><br><span class="line"><span class="attr">spring.redis.cluster.nodes</span>=<span class="string">192.168.100.100:6379</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#Redis数据库索引（默认为0）</span></span><br><span class="line"><span class="attr">spring.redis.database</span>= <span class="string">0</span></span><br><span class="line"><span class="comment">#连接超时时间（毫秒）</span></span><br><span class="line"><span class="attr">spring.redis.timeout</span>=<span class="string">1800000</span></span><br><span class="line"><span class="comment">#连接池最大连接数（使用负值表示没有限制）</span></span><br><span class="line"><span class="attr">spring.redis.lettuce.pool.max-active</span>=<span class="string">20</span></span><br><span class="line"><span class="comment">#最大阻塞等待时间(负数表示没限制)</span></span><br><span class="line"><span class="attr">spring.redis.lettuce.pool.max-wait</span>=<span class="string">-1</span></span><br><span class="line"><span class="comment">#连接池中的最大空闲连接</span></span><br><span class="line"><span class="attr">spring.redis.lettuce.pool.max-idle</span>=<span class="string">5</span></span><br><span class="line"><span class="comment">#连接池中的最小空闲连接</span></span><br><span class="line"><span class="attr">spring.redis.lettuce.pool.min-idle</span>=<span class="string">0</span></span><br></pre></td></tr></table></figure>

<p>controller：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.redis.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试Redis分布式锁：</span></span><br><span class="line"><span class="comment"> * 提前设置 num 值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/test&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LockController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/testLock&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testLock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 获取锁</span></span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">lock</span> <span class="operator">=</span> redisTemplate.opsForValue().setIfAbsent(<span class="string">&quot;lock&quot;</span>, <span class="string">&quot;001&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (lock) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;获得锁：&quot;</span>+lock);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> redisTemplate.opsForValue().get(<span class="string">&quot;num&quot;</span>);</span><br><span class="line">            <span class="comment">// 判空</span></span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isEmpty(value)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 业务逻辑</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> Integer.parseInt(String.valueOf(value));</span><br><span class="line">            redisTemplate.opsForValue().set(<span class="string">&quot;num&quot;</span>, ++num);</span><br><span class="line">            <span class="comment">// 释放锁</span></span><br><span class="line">            <span class="type">Boolean</span> <span class="variable">released</span> <span class="operator">=</span> redisTemplate.delete(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;释放锁：&quot;</span>+released);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 获取锁失败，每隔0.1秒再试</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                testLock();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<p>先设置 num 的值 set num 0</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">192.168.100.100:6391&gt; set num 0</span><br><span class="line"><span class="meta prompt_">-&gt; </span><span class="language-bash">Redirected to slot [2765] located at 192.168.100.100:6379</span></span><br><span class="line">OK</span><br><span class="line">192.168.100.100:6379&gt;</span><br></pre></td></tr></table></figure>

<p>使用 <a target="_blank" rel="noopener" href="http://192.168.25.211:8080/test/testLock">http://192.168.25.211:8080/test/testLock</a> 测试。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">192.168.100.100:6379&gt; get num</span><br><span class="line">&quot;1000&quot;</span><br></pre></td></tr></table></figure>



<p>问题：</p>
<p>如果上锁之后出现异常，锁无法释放，锁应该设置一个过期时间。</p>
<p>修改代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Boolean</span> <span class="variable">lock</span> <span class="operator">=</span> redisTemplate.opsForValue().setIfAbsent(<span class="string">&quot;lock&quot;</span>, <span class="string">&quot;001&quot;</span>,<span class="number">3</span>, TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure>

<h3 id="UUID防止误删"><a href="#UUID防止误删" class="headerlink" title="UUID防止误删"></a>UUID防止误删</h3><p>问题：每一个线程都应该有自己的一把锁</p>
<img src="/2023/03/17/Redis/Java\Document\Redis\Redis.assets\image-20221008220617532.png" alt="image-20221008220617532" style="zoom:50%;">

<p>代码修改：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.redis.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试Redis分布式锁：</span></span><br><span class="line"><span class="comment"> * 提前设置 num 值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/test&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LockController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/testLock&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testLock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 获取锁</span></span><br><span class="line">        <span class="comment">// Boolean lock = redisTemplate.opsForValue().setIfAbsent(&quot;lock&quot;, &quot;001&quot;,3, TimeUnit.SECONDS);</span></span><br><span class="line">        <span class="comment">// 使用 UUID 优化防止误删</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">uuid</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">lock</span> <span class="operator">=</span> redisTemplate.opsForValue().setIfAbsent(<span class="string">&quot;lock&quot;</span>, uuid, <span class="number">3</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">if</span> (lock) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;获得锁：&quot;</span> + lock);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> redisTemplate.opsForValue().get(<span class="string">&quot;num&quot;</span>);</span><br><span class="line">            <span class="comment">// 判空</span></span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isEmpty(value)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 业务逻辑</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> Integer.parseInt(String.valueOf(value));</span><br><span class="line">            redisTemplate.opsForValue().set(<span class="string">&quot;num&quot;</span>, ++num);</span><br><span class="line">            <span class="comment">// 释放锁: 判断UUID是否相同</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">lockUuid</span> <span class="operator">=</span> redisTemplate.opsForValue().get(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (uuid.equals(String.valueOf(lockUuid))) &#123;</span><br><span class="line">                <span class="type">Boolean</span> <span class="variable">released</span> <span class="operator">=</span> redisTemplate.delete(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;释放锁：&quot;</span> + released);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 获取锁失败，每隔0.1秒再试</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                testLock();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Lua-脚本优化：原子性问题"><a href="#Lua-脚本优化：原子性问题" class="headerlink" title="Lua 脚本优化：原子性问题"></a>Lua 脚本优化：原子性问题</h3><p>​		在判断UUID是否相同后，该锁对象过期时间结束，自动释放锁，此时其他线程拿到锁，之后当前线程再次通过手动释放锁，判断相等的过程已经结束，释放的是其他线程的锁，该过程应该是原子性的，使用Lua脚本确保原子性。</p>
<img src="/2023/03/17/Redis/Java\Document\Redis\Redis.assets\image-20221008224023193.png" alt="image-20221008224023193" style="zoom:50%;">

<p>代码修改：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;testLockLua&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testLockLua</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 声明一个uuid ,将做为一个value 放入我们的key所对应的值中</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">uuid</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">    <span class="comment">// 定义一个锁：lua 脚本可以使用同一把锁，来实现删除！</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">skuId</span> <span class="operator">=</span> <span class="string">&quot;25&quot;</span>; <span class="comment">// 访问skuId 为25号的商品 100008348542</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">locKey</span> <span class="operator">=</span> <span class="string">&quot;lock:&quot;</span> + skuId; <span class="comment">// 锁住的是每个商品的数据</span></span><br><span class="line">    <span class="comment">// 获取锁</span></span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">lock</span> <span class="operator">=</span> redisTemplate.opsForValue().setIfAbsent(locKey, uuid, <span class="number">3</span>, TimeUnit.SECONDS);</span><br><span class="line">    <span class="keyword">if</span> (lock) &#123;</span><br><span class="line">        <span class="comment">// 执行的业务逻辑开始</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> redisTemplate.opsForValue().get(<span class="string">&quot;num&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(value)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 不是空 如果说在这出现了异常！ 那么delete 就删除失败！ 也就是说锁永远存在！</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> Integer.parseInt(value + <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="comment">// 使num 每次+1 放入缓存</span></span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;num&quot;</span>, String.valueOf(++num));</span><br><span class="line">        <span class="comment">/*使用lua脚本来锁*/</span></span><br><span class="line">        <span class="comment">// 定义lua 脚本</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;if redis.call(&#x27;get&#x27;, KEYS[1]) == ARGV[1] then return redis.call(&#x27;del&#x27;, KEYS[1]) else return 0 end&quot;</span>;</span><br><span class="line">        <span class="comment">// 使用redis执行lua执行</span></span><br><span class="line">        DefaultRedisScript&lt;Long&gt; redisScript = <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;();</span><br><span class="line">        redisScript.setScriptText(script);</span><br><span class="line">        <span class="comment">// 设置一下返回值类型为 Long</span></span><br><span class="line">        <span class="comment">// 因为删除判断的时候，返回的0, 给其封装为数据类型。</span></span><br><span class="line">        <span class="comment">// 如果不封装那么默认返回String 类型，那么返回字符串与 0 会有发生错误。</span></span><br><span class="line">        redisScript.setResultType(Long.class);</span><br><span class="line">        <span class="comment">// 第一个要是script 脚本 ，第二个需要判断的key，第三个就是key所对应的值。</span></span><br><span class="line">        redisTemplate.execute(redisScript, Arrays.asList(locKey), uuid);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            testLockLua();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>为了确保分布式锁可用，我们至少要确保锁的实现同时<strong>满足以下四个条件</strong>：</p>
<ol>
<li>互斥性。在任意时刻，只有一个客户端能持有锁。</li>
<li>不会发生死锁。即使有一个客户端在持有锁的期间崩溃而没有主动解锁，也能保证后续其他客户端能加锁。</li>
<li>解铃还须系铃人。加锁和解锁必须是同一个客户端，客户端自己不能把别人加的锁给解了。</li>
<li>加锁和解锁必须具有原子性。</li>
</ol>
<h1 id="Redis6-新功能"><a href="#Redis6-新功能" class="headerlink" title="Redis6 新功能"></a>Redis6 新功能</h1><h2 id="ACL"><a href="#ACL" class="headerlink" title="ACL"></a>ACL</h2><h3 id="简介-8"><a href="#简介-8" class="headerlink" title="简介"></a>简介</h3><p>​		Redis ACL是Access Control List（访问控制列表）的缩写，该功能允许根据可以执行的命令和可以访问的键来限制某些连接。在Redis 5版本之前，Redis 安全规则只有密码控制，还有通过 rename 来调整高危命令比如 flushdb ， KEYS* ， shutdown 等。Redis 6 则提供ACL的功能对用户进行更细粒度的权限控制 ：</p>
<p>（1）接入权限：用户名和密码 </p>
<p>（2）可以执行的命令 </p>
<p>（3）可以操作的 KEY</p>
<p>参考官网：<a target="_blank" rel="noopener" href="https://redis.io/topics/acl">https://redis.io/topics/acl</a></p>
<h3 id="命令-3"><a href="#命令-3" class="headerlink" title="命令"></a>命令</h3><ol>
<li>使用 acl list 命令展现用户权限列表</li>
</ol>
<p>（1）数据说明</p>
<p>​	user	用户名	是否启用	没有密码	可操作的Key	可执行的命令</p>
<p><img src="/2023/03/17/Redis/Java\Document\Redis\Redis.assets\image-20221008234251310.png" alt="image-20221008234251310"></p>
<ol start="2">
<li><p>使用 acl whoami 命令查看当前用户</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; ACL WHOAMI</span><br><span class="line">&quot;default&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 acl cat 命令</p>
</li>
</ol>
<p>（1）查看添加权限指令类别</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">192.168.100.100:6391&gt; acl cat</span><br><span class="line"> 1) &quot;keyspace&quot;</span><br><span class="line"> 2) &quot;read&quot;</span><br><span class="line"> 3) &quot;write&quot;</span><br><span class="line"> 4) &quot;set&quot;</span><br><span class="line"> 5) &quot;sortedset&quot;</span><br><span class="line"> 6) &quot;list&quot;</span><br><span class="line"> 7) &quot;hash&quot;</span><br><span class="line"> 8) &quot;string&quot;</span><br><span class="line"> 9) &quot;bitmap&quot;</span><br><span class="line">10) &quot;hyperloglog&quot;</span><br><span class="line">11) &quot;geo&quot;</span><br><span class="line">12) &quot;stream&quot;</span><br><span class="line">13) &quot;pubsub&quot;</span><br><span class="line">14) &quot;admin&quot;</span><br><span class="line">15) &quot;fast&quot;</span><br><span class="line">16) &quot;slow&quot;</span><br><span class="line">17) &quot;blocking&quot;</span><br><span class="line">18) &quot;dangerous&quot;</span><br><span class="line">19) &quot;connection&quot;</span><br><span class="line">20) &quot;transaction&quot;</span><br><span class="line">21) &quot;scripting&quot;</span><br></pre></td></tr></table></figure>

<p>（2）加参数类型名可以查看类型下具体命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; acl cat string</span><br><span class="line"> 1) &quot;msetnx&quot;</span><br><span class="line"> 2) &quot;setrange&quot;</span><br><span class="line"> 3) &quot;get&quot;</span><br><span class="line"> 4) &quot;getrange&quot;</span><br><span class="line"> 5) &quot;setnx&quot;</span><br><span class="line"> 6) &quot;getset&quot;</span><br><span class="line"> 7) &quot;decrby&quot;</span><br><span class="line"> 8) &quot;getex&quot;</span><br><span class="line"> 9) &quot;mset&quot;</span><br><span class="line">10) &quot;substr&quot;</span><br><span class="line">11) &quot;stralgo&quot;</span><br><span class="line">12) &quot;incr&quot;</span><br><span class="line">13) &quot;setex&quot;</span><br><span class="line">14) &quot;set&quot;</span><br><span class="line">15) &quot;incrby&quot;</span><br><span class="line">16) &quot;decr&quot;</span><br><span class="line">17) &quot;append&quot;</span><br><span class="line">18) &quot;incrbyfloat&quot;</span><br><span class="line">19) &quot;strlen&quot;</span><br><span class="line">20) &quot;mget&quot;</span><br><span class="line">21) &quot;psetex&quot;</span><br><span class="line">22) &quot;getdel&quot;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>使用  aclsetuser  命令创建和编辑用户ACL</li>
</ol>
<p>（1）ACL规则</p>
<p>​		下面是有效ACL规则的列表。某些规则只是用于激活或删除标志，或对用户ACL执行给定更改的单个单词。其他规则是字符前缀，它们与命令或类别名称、键模式等连接在一起。</p>
<table>
<thead>
<tr>
<th>ACL规则</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>类型</td>
<td>参数</td>
<td>说明</td>
</tr>
<tr>
<td>启动和禁用用户</td>
<td><strong>on</strong></td>
<td>激活某用户账号</td>
</tr>
<tr>
<td><strong>off</strong></td>
<td>禁用某用户账号。注意，已验证的连接仍然可以工作。如果默认用户被标记为off，则新连接将在未进行身份验证的情况下启动，并要求用户使用AUTH选项发送AUTH或HELLO，以便以某种方式进行身份验证。</td>
<td></td>
</tr>
<tr>
<td>权限的添加删除</td>
<td><strong>+<command></strong></td>
<td>将指令添加到用户可以调用的指令列表中</td>
</tr>
<tr>
<td><strong>-<command></strong></td>
<td>从用户可执行指令列表移除指令</td>
<td></td>
</tr>
<tr>
<td><strong>+@<category></category></strong></td>
<td>添加该类别中用户要调用的所有指令，有效类别为@admin、@set、@sortedset…等，通过调用ACL CAT命令查看完整列表。特殊类别@all表示所有命令，包括当前存在于服务器中的命令，以及将来将通过模块加载的命令。</td>
<td></td>
</tr>
<tr>
<td>-@<actegory></actegory></td>
<td>从用户可调用指令中移除类别</td>
<td></td>
</tr>
<tr>
<td><strong>allcommands</strong></td>
<td>+@all的别名</td>
<td></td>
</tr>
<tr>
<td><strong>nocommand</strong></td>
<td>-@all的别名</td>
<td></td>
</tr>
<tr>
<td>可操作键的添加或删除</td>
<td><strong>~<pattern></pattern></strong></td>
<td>添加可作为用户可操作的键的模式。例如~*允许所有的键</td>
</tr>
</tbody></table>
<p>（2）通过命令创建新用户默认权限</p>
<p>​	acl setuser user1</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; acl setuser user01</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; acl list</span><br><span class="line">1) &quot;user default on nopass ~* &amp;* +@all&quot;</span><br><span class="line">2) &quot;user user01 off &amp;* -@all&quot;</span><br></pre></td></tr></table></figure>

<p>​		上述示例中，如果用户不存在，这将使用 just created 的默认属性来创建用户。如果用户已经存在，则上面的命令将不执行任何操作。</p>
<p>（3）设置有用户名、密码、ACL权限、并启用的用户</p>
<p>​		acl setuser user02 on &gt;password ~cached:* +get</p>
<p>​		<em><em>&gt;后接密码(password即为密码)，~cached:</em>	以cached开头的键可以被操作	+get	只能使用get命令</em>*</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; acl setuser user02 on &gt;password ~cached:* +get</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; acl list</span><br><span class="line">1) &quot;user default on nopass ~* &amp;* +@all&quot;</span><br><span class="line">2) &quot;user user01 off &amp;* -@all&quot;</span><br><span class="line">3) &quot;user user02 on #5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8 ~cached:* &amp;* -@all +get&quot;</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<p>（4）切换用户，验证权限</p>
<p>​	auth user02 password</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# redis-cli -c -p 6379</span><br><span class="line">127.0.0.1:6379&gt; acl whoami</span><br><span class="line">&quot;default&quot;</span><br><span class="line">127.0.0.1:6379&gt; acl list</span><br><span class="line">1) &quot;user default on nopass ~* &amp;* +@all&quot;</span><br><span class="line">2) &quot;user user01 off &amp;* -@all&quot;</span><br><span class="line">3) &quot;user user02 on #5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8 ~cached:* &amp;* -@all +get&quot;</span><br><span class="line">127.0.0.1:6379&gt; auth user02 password</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set k1 v1</span><br><span class="line">(error) NOPERM this user has no permissions to run the &#x27;set&#x27; command or its subcommand</span><br><span class="line">127.0.0.1:6379&gt; get k1</span><br><span class="line">(error) NOPERM this user has no permissions to access one of the keys used as arguments</span><br><span class="line">127.0.0.1:6379&gt; get cached:001</span><br><span class="line"><span class="meta prompt_">-&gt; </span><span class="language-bash">Redirected to slot [8807] located at 192.168.100.100:6391</span></span><br><span class="line">(nil)</span><br><span class="line">192.168.100.100:6391&gt;</span><br></pre></td></tr></table></figure>

<h2 id="IO-多线程"><a href="#IO-多线程" class="headerlink" title="IO 多线程"></a><strong>IO</strong> 多线程</h2><h3 id="简介-9"><a href="#简介-9" class="headerlink" title="简介"></a><strong>简介</strong></h3><p>Redis6终于支持多线程了，告别单线程了吗？</p>
<p>IO多线程其实指 <strong>客户端交互部分</strong>的<strong>网络IO</strong> 交互处理模块<strong>多线程</strong>，而非<strong>执行命令多线程</strong>。Redis6执行命令依然是单线程。</p>
<h3 id="原理架构"><a href="#原理架构" class="headerlink" title="原理架构"></a><strong>原理架构</strong></h3><p>​		Redis 6 加入多线程，但跟 Memcached 这种从 IO处理到数据访问多线程的实现模式有些差异。<strong>Redis 的多线程部分只是用来处理网络数据的读写和协议解析，执行命令仍然是单</strong>线程。之所以这么设计是不想因为多线程而变得复杂，需要去控制 key、lua、事务，LPUSH&#x2F;LPOP 等等的并发问题。整体的设计大体如下：</p>
<img src="/2023/03/17/Redis/Java\Document\Redis\Redis.assets\image-20221008233535092.png" alt="image-20221008233535092" style="zoom:80%;">

<p>另外，多线程IO默认也是不开启的，需要再配置文件中配置</p>
<ul>
<li>​	io-threads 4</li>
<li>​	io-threads-do-reads yes</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">1141 # So for instance if you have a four cores boxes, try to use 2 or 3 I/O</span><br><span class="line">1142 # threads, if you have a 8 cores, try to use 6 threads. In order to</span><br><span class="line">1143 # enable I/O threads use the following configuration directive:</span><br><span class="line">1144 #</span><br><span class="line">1145 # io-threads 4</span><br><span class="line">1146 #</span><br><span class="line">1147 # Setting io-threads to 1 will just use the main thread as usual.</span><br><span class="line">1148 # When I/O threads are enabled, we only use threads for writes, that is</span><br><span class="line">1149 # to thread the write(2) syscall and transfer the client buffers to the</span><br><span class="line">1150 # socket. However it is also possible to enable threading of reads and</span><br><span class="line">1151 # protocol parsing using the following configuration directive, by setting</span><br><span class="line">1152 # it to yes:</span><br><span class="line">1153 #</span><br><span class="line">1154 # io-threads-do-reads no</span><br><span class="line">1155 #</span><br><span class="line">1156 # Usually threading reads doesn&#x27;t help much.</span><br><span class="line">1157 #</span><br><span class="line">1158 # NOTE 1: This configuration directive cannot be changed at runtime via</span><br><span class="line">1159 # CONFIG SET. Aso this feature currently does not work when SSL is</span><br><span class="line">1160 # enabled.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="工具支持-Cluster"><a href="#工具支持-Cluster" class="headerlink" title="工具支持 Cluster"></a><strong>工具支持</strong> <strong>Cluster</strong></h2><p>之前老版 Redis 想要搭集群需要单独安装 ruby 环境，Redis 5 将 redis-trib.rb 的功能集成到 redis-cli 。另外官方 redis-benchmark 工具开始支持 cluster 模式了，通过多线程的方式对多个分片进行压测。</p>
<h2 id="Redis-新功能持续关注"><a href="#Redis-新功能持续关注" class="headerlink" title="Redis 新功能持续关注"></a><strong>Redis</strong> 新功能持续关注</h2><p>Redis6 新功能还有：</p>
<ol>
<li><p>RESP3 新的 Redis 通信协议：优化服务端与客户端之间通信</p>
</li>
<li><p>Client Side Caching 客户端缓存：基于 RESP3 协议实现的客户端缓存功能。为了进一步提升缓存的性能，将客户端经常访问的数据 Cache 到客户端，减少TCP网络交互。</p>
</li>
<li><p>Proxy集群代理模式：Proxy 功能，让 Cluster 拥有像单实例一样的接入方式，降低大家使用 Cluster 的门槛。不过需要注意的是代理不改变 Cluster 的功能限制，不支持的命令还是不会支持，比如跨 Slot 的多Key操作。</p>
</li>
<li><p>Modules API</p>
<p> ​	Redis 6 中模块API开发进展非常大，因为 Redis Labs 为了开发复杂的功能，从一开始就用上 Redis 模块。Redis可以变成一个框架，利用 Modules 来构建不同系统，而不需要从头开始写然后还要 BSD 许可。Redis一开始就是一个向编写各种系统开放的平台。</p>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/16/Zookeeper/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MineTing">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/16/Zookeeper/" class="post-title-link" itemprop="url">Zookeeper</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-16 00:00:00" itemprop="dateCreated datePublished" datetime="2023-03-16T00:00:00+08:00">2023-03-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-22 16:30:53" itemprop="dateModified" datetime="2023-03-22T16:30:53+08:00">2023-03-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <div align="center"><font size="70"><b>Zookeeper</b></font></div>

<h1 id="Zookeeper-概述"><a href="#Zookeeper-概述" class="headerlink" title="Zookeeper 概述"></a>Zookeeper 概述</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Zookeeper 是一个开源的分布式的，为分布式框架提供协调服务的 Apache 项目。</p>
<p>官网：<a target="_blank" rel="noopener" href="https://zookeeper.apache.org/">https://zookeeper.apache.org/</a></p>
<h2 id="Zookeeper-工作机制"><a href="#Zookeeper-工作机制" class="headerlink" title="Zookeeper 工作机制"></a>Zookeeper 工作机制</h2><p>​		是一个基于观察者模式设计的分布式服务管理框架，它负责存储和管理大家都关心的数据，然后接受观察者的注册，一旦这些数据的状态发生变化，Zookeeper 就将负责通知已经在 Zookeeper 上注册的那些观察者做出相应的反应。</p>
<p>Zookeeper &#x3D; 文件系统 + 通知机制</p>
<h2 id="Zookeeper-特点"><a href="#Zookeeper-特点" class="headerlink" title="Zookeeper 特点"></a>Zookeeper 特点</h2><p><img src="/2023/03/16/Zookeeper/Java\Document\Zookeeper\Zookeeper.assets\image-20220927215643357.png" alt="image-20220927215643357"></p>
<ol>
<li>Zookeeper：一个领导者（Leader），多个跟随者（Follower）组成的集群。</li>
<li>集群中只要有半数以上节点存活，Zookeeper 集群就能正常服务。所以 Zookeeper 适合安装奇数台服务器。</li>
<li>全局数据一致：每个 Server 保存一份相同的数据副本，Client无论连接到哪个 Server，数据都是一致的。</li>
<li>更新请求顺序执行，来自同一个 Client 的更新请求按其发送顺序依次执行。</li>
<li>数据更新原子性，一次数据更新要么成功，要么失败。</li>
<li>实时性，在一定时间范围内，Client 能读到最新数据。</li>
</ol>
<h2 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h2><p>​		ZooKeeper 数据模型的结构与 Unix 文件系统很类似，整体上可以看作是一棵树，每个 节点称做一个 ZNode。每一个 ZNode 默认能够存储 1MB 的数据，每个 ZNode 都可以通过其路径唯一标识。</p>
<p><img src="/2023/03/16/Zookeeper/Java\Document\Zookeeper\Zookeeper.assets\image-20220927173947210.png" alt="image-20220927173947210"></p>
<h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>提供的服务包括：统一命名服务、统一配置管理、统一集群管理、服务器节点动态上下线、软负载均衡等。</p>
<h3 id="统一命名服务"><a href="#统一命名服务" class="headerlink" title="统一命名服务"></a>统一命名服务</h3><p>​		在分布式环境下，经常需要对应用 &#x2F; 服务进行统一命名，便于识别。</p>
<h3 id="统一配置管理"><a href="#统一配置管理" class="headerlink" title="统一配置管理"></a>统一配置管理</h3><p>分布式环境中，一般要求一个集群中，所有节点的配置信息是一致的，比如 Kafka 集群，对配置文件修改后，希望能够快速同步到各个节点上。</p>
<p>Zookeeper 可实现该功能，可以将配置信息写入 Zookeeper 的一个 Znode，各个客户端服务器监听这个 Znode，一 旦Znode中的数据被修改，ZooKeeper将通知各个客户端服务器。</p>
<p><img src="/2023/03/16/Zookeeper/Java\Document\Zookeeper\Zookeeper.assets\image-20220927175059036.png" alt="image-20220927175059036"></p>
<h3 id="统一集群管理"><a href="#统一集群管理" class="headerlink" title="统一集群管理"></a>统一集群管理</h3><p>分布式环境中，实时掌握每个节点的状态是必要的，可根据节点实时状态做出一些调整。</p>
<p>ZooKeeper可以实现实时监控节点状态变化：</p>
<p>​	1. 可将节点信息写入ZooKeeper上的一个ZNode</p>
<p>​	2. 监听这个ZNode可获取它的实时状态变化</p>
<h3 id="服务器动态上下线"><a href="#服务器动态上下线" class="headerlink" title="服务器动态上下线"></a>服务器动态上下线</h3><p>​		客户端能实时洞察到服务 器上下线的变化</p>
<p><img src="/2023/03/16/Zookeeper/Java\Document\Zookeeper\Zookeeper.assets\image-20220927175315238.png" alt="image-20220927175315238"></p>
<h3 id="软负载均衡"><a href="#软负载均衡" class="headerlink" title="软负载均衡"></a>软负载均衡</h3><p>在 Zookeeper 中记录每台服务器的访问数，让访问数最少的服务器去处理最新的客户端请求</p>
<h1 id="Zookeeper-本地安装"><a href="#Zookeeper-本地安装" class="headerlink" title="Zookeeper 本地安装"></a>Zookeeper 本地安装</h1><h2 id="安装说明"><a href="#安装说明" class="headerlink" title="安装说明"></a>安装说明</h2><p>地址：<a target="_blank" rel="noopener" href="https://zookeeper.apache.org/releases.html">https://zookeeper.apache.org/releases.html</a></p>
<p>下载安装包：apache-zookeeper-3.5.7-bin.tar.gz</p>
<p>安装准备：安装 JDK，解压至 &#x2F;opt&#x2F;zookeeper&#x2F;，重命名文件夹名称</p>
<p>配置 Java 环境变量：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">java</span></span><br><span class="line">export JAVA_HOME=/opt/java/jdk1.8.0_131</span><br><span class="line">export JRE_HOME=/opt/java/jdk1.8.0_131/jre</span><br><span class="line">export CLASSPATH=.:%JAVA_HOME%/lib:%JAVA_HOME%/lib</span><br><span class="line">export PATH=$JAVA_HOME/bin:$PATH</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">zookeeper</span></span><br><span class="line">export ZOOKEEPER_HOME=/opt/zookeeper/zookeeper-3.5.7</span><br><span class="line">export PATH=$ZOOKEEPER_HOME/bin:$PATH</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">source /etc/profile</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">或者修改 ~/.bash_profile， <span class="built_in">source</span> ~/.bash_profile</span></span><br></pre></td></tr></table></figure>

<p>解压 Zookeeper：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@root zookeeper]# ll zookeeper-3.5.7/</span><br><span class="line">总用量 32</span><br><span class="line">drwxr-xr-x. 2  502 games   232 2月  10 2020 bin</span><br><span class="line">drwxr-xr-x. 2  502 games    77 2月   7 2020 conf</span><br><span class="line">drwxr-xr-x. 5  502 games  4096 2月  10 2020 docs</span><br><span class="line">drwxr-xr-x. 2 root root   4096 9月  27 18:40 lib</span><br><span class="line">-rw-r--r--. 1  502 games 11358 9月  13 2018 LICENSE.txt</span><br><span class="line">-rw-r--r--. 1  502 games   432 2月  10 2020 NOTICE.txt</span><br><span class="line">-rw-r--r--. 1  502 games  1560 2月   7 2020 README.md</span><br><span class="line">-rw-r--r--. 1  502 games  1347 2月   7 2020 README_packaging.txt</span><br></pre></td></tr></table></figure>

<p>修改配置：将 conf 路径下 zoo_sample.cfg 修改为 zoo.cfg，并修改文件中 dataDir 的路径，一般设置为安装目录下的 					zkData（mkdir  zkData）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@root conf]# mv zoo_sample.cfg zoo.cfg</span><br><span class="line">[root@root conf]# vim zoo.cfg</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The number of milliseconds of each tick</span></span><br><span class="line">tickTime=2000</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The number of ticks that the initial</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">synchronization phase can take</span></span><br><span class="line">initLimit=10</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The number of ticks that can pass between</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">sending a request and getting an acknowledgement</span></span><br><span class="line">syncLimit=5</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">the directory <span class="built_in">where</span> the snapshot is stored.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="keyword">do</span> not use /tmp <span class="keyword">for</span> storage, /tmp here is just</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">example sakes.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">dataDir=/tmp/zookeeper</span></span><br><span class="line">dataDir=/opt/zookeeper/zookeeper-3.5.7/zkData</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">the port at <span class="built_in">which</span> the clients will connect</span></span><br><span class="line">clientPort=2181</span><br></pre></td></tr></table></figure>

<p>操作 Zookeeper：</p>
<p>​		启动Zookeeper：zkServer.sh  start</p>
<p>​		查看进程是否启动：jps </p>
<p>​		查看状态：zkServer.sh  status</p>
<p>​		启动客户端：zkCli.sh</p>
<p>​		退出客户端：quit</p>
<p>​		停止 Zookeeper：zkServer.sh  stop</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@root zookeeper-3.5.7]# cd bin</span><br><span class="line">[root@root bin]# zkServer.sh start</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /opt/zookeeper/zookeeper-3.5.7/bin/../conf/zoo.cfg</span><br><span class="line">Starting zookeeper ... STARTED</span><br><span class="line">[root@root bin]# jps</span><br><span class="line">5191 Jps</span><br><span class="line">5160 QuorumPeerMain</span><br><span class="line">[root@root bin]# zkServer.sh status</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /opt/zookeeper/zookeeper-3.5.7/bin/../conf/zoo.cfg</span><br><span class="line">Client port found: 2181. Client address: localhost.</span><br><span class="line">Mode: standalone</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">退出</span></span><br><span class="line">[root@root bin]# zkServer.sh stop</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@root bin]# zkCli.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">.....</span></span><br><span class="line">2022-09-27 19:09:18,427 [myid:localhost:2181] - INFO  [main-SendThread(localhost:2181):ClientCnxn$SendThread@1394] - Session establishment complete on server localhost/127.0.0.1:2181, sessionid = 0x10000be49f20002, negotiated timeout = 30000</span><br><span class="line"></span><br><span class="line">WATCHER::</span><br><span class="line"></span><br><span class="line">WatchedEvent state:SyncConnected type:None path:null</span><br><span class="line">[zk: localhost:2181(CONNECTED) 0] ls /</span><br><span class="line">[zookeeper]</span><br></pre></td></tr></table></figure>



<h2 id="配置参数解读"><a href="#配置参数解读" class="headerlink" title="配置参数解读"></a>配置参数解读</h2><p>配置文件 zoo.cfg 中参数含义：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The number of milliseconds of each tick</span></span><br><span class="line">tickTime=2000</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The number of ticks that the initial</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">synchronization phase can take</span></span><br><span class="line">initLimit=10</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The number of ticks that can pass between</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">sending a request and getting an acknowledgement</span></span><br><span class="line">syncLimit=5</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">the directory <span class="built_in">where</span> the snapshot is stored.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="keyword">do</span> not use /tmp <span class="keyword">for</span> storage, /tmp here is just</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">example sakes.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">dataDir=/tmp/zookeeper</span></span><br><span class="line">dataDir=/opt/zookeeper/zookeeper-3.5.7/zkData</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">the port at <span class="built_in">which</span> the clients will connect</span></span><br><span class="line">clientPort=2181</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">the maximum number of client connections.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">increase this <span class="keyword">if</span> you need to handle more clients</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">maxClientCnxns=60</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Be sure to read the maintenance section of the</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">administrator guide before turning on autopurge.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># The number of snapshots to retain in dataDir</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">autopurge.snapRetainCount=3</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Purge task interval <span class="keyword">in</span> hours</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Set to <span class="string">&quot;0&quot;</span> to <span class="built_in">disable</span> auto purge feature</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">autopurge.purgeInterval=1</span></span><br></pre></td></tr></table></figure>

<p>tickTime &#x3D; 2000：通信心跳时间，Zookeeper服务器与客户端心跳时间，单位毫秒</p>
<p>initLimit &#x3D; 10：LF 初始通信时限，Leader和Follower初始连接时能容忍的最多心跳数<strong>（tickTime的数量）</strong></p>
<p>syncLimit &#x3D; 5：LF 同步通信时限，Leader和Follower之间通信时间如果超过syncLimit * tickTime，Leader认为Follwer死 						掉，从服务器列表中删除Follwer。</p>
<p>dataDir：保存Zookeeper中的数据，默认的tmp目录，容易被Linux系统定期删除，所以一般不用默认的tmp目录。</p>
<p>clientPort &#x3D; 2181：客户端连接端口，通常不做修改。</p>
<p>maxClientCnxns&#x3D;60：客户端最大连接数量</p>
<p>参数说明：<a target="_blank" rel="noopener" href="https://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance">https://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance</a></p>
<h1 id="Zookeeper-集群操作"><a href="#Zookeeper-集群操作" class="headerlink" title="Zookeeper 集群操作"></a>Zookeeper 集群操作</h1><h2 id="集群安装"><a href="#集群安装" class="headerlink" title="集群安装"></a>集群安装</h2><ol>
<li><p>在三台机器上安装 Zookeeper</p>
</li>
<li><p>配置服务器编号：<strong>在安装目录配置 zkData，在 zkData 下创建 myid 文件，在文件中添加与 server 对应的编号</strong></p>
</li>
<li><p>分发 zookeeper 至其他机器</p>
</li>
<li><p>配置 zoo.cfg文件，增加如下配置：</p>
<p> server.1&#x3D;192.168.100.100:2888:3888</p>
<p> server.2&#x3D;192.168.100.110:2888:3888</p>
<p> server.3&#x3D;192.168.100.120:2888:3888</p>
<p> 配置参数说明：</p>
<p> server.A&#x3D;B:C:D</p>
<p> A 表示集群模式下，配置一个文件 myid 中的机器编号，Zookeeper 启动时读取此文件，拿到里面的数据与 zoo.cfg 里	面的配置信息比较从而判断到底是哪个 server。</p>
<p> B 是服务器的地址</p>
<p> C 是这个服务器 Follower 与集群中的 Leader 服务器交换信息的端口</p>
<p> D 是用来执行选举时服务器相互通信的端口。</p>
</li>
<li><p>同步配置文件</p>
<blockquote>
<p>批量进行跨机器间的文件（含文件夹）传输</p>
<ul>
<li>创建脚本 xsync.sh，传入要传输的目录名</li>
<li>shell 脚本要求具有执行权限：chmod +x xsync.sh</li>
<li>shell 脚本保存在 &#x2F;usr&#x2F;bin 这样的目录下，以使命令全局有效</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">判断参数个数</span></span><br><span class="line">if [ $# -lt 1 ]</span><br><span class="line">then</span><br><span class="line">	echo &quot;Not  Enough Arguments&quot;</span><br><span class="line">	exit</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">遍历所有主机</span></span><br><span class="line">for host in 192.168.100.100 192.168.100.110 192.168.100.120</span><br><span class="line">do</span><br><span class="line">	echo ========$host========</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">遍历所有目录</span></span><br><span class="line">	for file in $@</span><br><span class="line">	do</span><br><span class="line">		if [ -e $file ]</span><br><span class="line">		then</span><br><span class="line"><span class="meta prompt_">			# </span><span class="language-bash">如果文件存在，获取父目录，</span></span><br><span class="line"><span class="meta prompt_">			# </span><span class="language-bash"><span class="built_in">pwd</span> -P：如果目录是链接时，显示出实际路径，而非使用连接（<span class="built_in">link</span>）路径。<span class="built_in">pwd</span>防止传入相对路径</span></span><br><span class="line"><span class="meta prompt_">			# </span><span class="language-bash"><span class="built_in">cd</span> -P:如果目录是链接时，切换到实际路径的目录。</span></span><br><span class="line">			pdir=$(cd -P $(dirname $file);pwd)</span><br><span class="line"><span class="meta prompt_">			# </span><span class="language-bash">获取文件名称</span></span><br><span class="line">			filename=$(basename $file)</span><br><span class="line">			ssh $host &quot;mkdir -p $pdir&quot;</span><br><span class="line">			rsync -av $pdir/$filename $host:$pdir</span><br><span class="line">		else</span><br><span class="line">			echo $file not exist!</span><br><span class="line">		fi</span><br><span class="line">	done</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
</blockquote>
<p> <strong>同步完成后，修改配置文件内容。</strong></p>
</li>
<li><p>启动 Zookeeper 并查看状态</p>
<blockquote>
<p>启动 Zookeeper 集群，脚本位置：&#x2F;home&#x2F;xxxx&#x2F;bin</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">case $1 in</span><br><span class="line">&quot;start&quot;)&#123;</span><br><span class="line">	for host in 192.168.100.100 192.168.100.110 192.168.100.120</span><br><span class="line">	do</span><br><span class="line">		echo &quot;========zookeeper $host start========&quot;</span><br><span class="line">		ssh $host &quot;/opt/zookeeper/zookeeper-3.5.7/bin/zkServer.sh start&quot;</span><br><span class="line">	done</span><br><span class="line">&#125;</span><br><span class="line">;;</span><br><span class="line">&quot;status&quot;)&#123;</span><br><span class="line">	for host in 192.168.100.100 192.168.100.110 192.168.100.120</span><br><span class="line">	do</span><br><span class="line">		echo &quot;========zookeeper $host status========&quot;</span><br><span class="line">		ssh $host &quot;/opt/zookeeper/zookeeper-3.5.7/bin/zkServer.sh status&quot;</span><br><span class="line">	done</span><br><span class="line">&#125;</span><br><span class="line">;;</span><br><span class="line">&quot;stop&quot;)&#123;</span><br><span class="line">	for host in 192.168.100.100 192.168.100.110 192.168.100.120</span><br><span class="line">	do</span><br><span class="line">		echo &quot;========zookeeper $host stop========&quot;</span><br><span class="line">		ssh $host &quot;/opt/zookeeper/zookeeper-3.5.7/bin/zkServer.sh stop&quot;</span><br><span class="line">	done</span><br><span class="line">&#125;</span><br><span class="line">;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>

<p>设置免密登陆：</p>
</blockquote>
</li>
</ol>
<blockquote>
</blockquote>
<pre><code>&gt; 安装 sshpass 工具： yum -y install sshpass
</code></pre>
<blockquote>
</blockquote>
<pre><code>&gt; 修改：
&gt;
&gt; <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">case $1 in</span><br><span class="line">&quot;start&quot;)&#123;</span><br><span class="line">	for host in 192.168.100.100 192.168.100.110 192.168.100.120</span><br><span class="line">	do</span><br><span class="line">		echo &quot;========zookeeper $host start========&quot;</span><br><span class="line">		sshpass -p root ssh -o StrictHostKeyChecking=no $host &quot;/opt/zookeeper/zookeeper-3.5.7/bin/zkServer.sh start&quot;</span><br><span class="line">	done</span><br><span class="line">&#125;</span><br><span class="line">;;</span><br><span class="line">&quot;status&quot;)&#123;</span><br><span class="line">	for host in 192.168.100.100 192.168.100.110 192.168.100.120</span><br><span class="line">	do</span><br><span class="line">		echo &quot;========zookeeper $host status========&quot;</span><br><span class="line">		sshpass -p root ssh -o StrictHostKeyChecking=no $host &quot;/opt/zookeeper/zookeeper-3.5.7/bin/zkServer.sh status&quot;</span><br><span class="line">	done</span><br><span class="line">&#125;</span><br><span class="line">;;</span><br><span class="line">&quot;stop&quot;)&#123;</span><br><span class="line">	for host in 192.168.100.100 192.168.100.110 192.168.100.120</span><br><span class="line">	do</span><br><span class="line">		echo &quot;========zookeeper $host stop========&quot;</span><br><span class="line">		sshpass -p root ssh -o StrictHostKeyChecking=no $host &quot;/opt/zookeeper/zookeeper-3.5.7/bin/zkServer.sh stop&quot;</span><br><span class="line">	done</span><br><span class="line">&#125;</span><br><span class="line">;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>
</code></pre>
<blockquote>
</blockquote>
<pre><code>&gt; linux 设置免密登陆：略

注意报错：

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果报错：Error: JAVA_HOME is not <span class="built_in">set</span> and java could not be found <span class="keyword">in</span> PATH.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">单机启动没有问题，但集群启动报错</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解决：在 zookeeper/bin/zkEnv.sh 头部手动添加 JAVA_HOME=/opt/java/jdk1.8.0_131</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改完成后，重新分发</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">    [root@root zookeeper-3.5.7]# zkServer.sh status</span><br><span class="line">    ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /opt/zookeeper/zookeeper-3.5.7/bin/../conf/zoo.cfg</span><br><span class="line">    Client port found: 2181. Client address: localhost.</span><br><span class="line">Error contacting service. It is probably not running.</span><br></pre></td></tr></table></figure>

原因：

  1. Leader 和 Follower 未选出，或无法连接

  2. 只启动不到一半数量的集群，或者防火墙未关闭

     防火墙：

     CentOS7：

     <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl status firewalld.service</span><br><span class="line">systemctl stop firewalld.service	#关闭</span><br><span class="line">systemctl disabled firewalld.service	# 禁用</span><br></pre></td></tr></table></figure>

     CentOS6：

     <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">service iptables status</span><br><span class="line">service iptables stop</span><br><span class="line">chkconfig iptables off</span><br></pre></td></tr></table></figure>

启动结果：
</code></pre>
<blockquote>
<p>查看 jps 进程，脚本 jpsall.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">for host in 192.168.100.100 192.168.100.110 192.168.100.120</span><br><span class="line">do</span><br><span class="line">    echo ========$host========</span><br><span class="line">    ssh $host  &quot;source /etc/profile &amp;&amp; jps | grep -v jps &quot;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

</blockquote>
<pre><code>查看状态：

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@root zookeeper-3.5.7]# zk.sh status</span><br><span class="line">========zookeeper 192.168.100.100 status========</span><br><span class="line">Warning: Permanently added &#x27;192.168.100.100&#x27; (ECDSA) to the list of known hosts.</span><br><span class="line">root@192.168.100.100&#x27;s password:</span><br><span class="line">/usr/bin/java</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /opt/zookeeper/zookeeper-3.5.7/bin/../conf/zoo.cfg</span><br><span class="line">Client port found: 2181. Client address: localhost.</span><br><span class="line">Mode: follower</span><br><span class="line">========zookeeper 192.168.100.110 status========</span><br><span class="line">Warning: Permanently added &#x27;192.168.100.110&#x27; (ECDSA) to the list of known hosts.</span><br><span class="line">root@192.168.100.110&#x27;s password:</span><br><span class="line">/usr/bin/java</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /opt/zookeeper/zookeeper-3.5.7/bin/../conf/zoo.cfg</span><br><span class="line">Client port found: 2181. Client address: localhost.</span><br><span class="line">Mode: leader</span><br><span class="line">========zookeeper 192.168.100.120 status========</span><br><span class="line">Warning: Permanently added &#x27;192.168.100.120&#x27; (ECDSA) to the list of known hosts.</span><br><span class="line">root@192.168.100.120&#x27;s password:</span><br><span class="line">/usr/bin/java</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /opt/zookeeper/zookeeper-3.5.7/bin/../conf/zoo.cfg</span><br><span class="line">Client port found: 2181. Client address: localhost.</span><br><span class="line">Mode: follower</span><br><span class="line">[root@root zookeeper-3.5.7]#</span><br></pre></td></tr></table></figure>

说明：此时已经选举出 leader 和 follower
</code></pre>
<h2 id="选举机制"><a href="#选举机制" class="headerlink" title="选举机制"></a>选举机制</h2><h3 id="第一次启动"><a href="#第一次启动" class="headerlink" title="第一次启动"></a>第一次启动</h3><p><img src="/2023/03/16/Zookeeper/Java\Document\Zookeeper\Zookeeper.assets\image-20220927215757995.png" alt="image-20220927215757995"></p>
<ol>
<li><p>服务器1启 动，发起一次选举。服务器1投自己一票。此时服务器1票数一票，不够半数以上（3票），选举无法完成，服务器1状态保持为 LOOKING。</p>
</li>
<li><p>服务器2启动，再发起一次选举。服务器1和2分别投自己一票并交换选票信息：此时服务器 1 发现服务器 2 的myid 比自己目前投票推举的（服务器1） 大，更改选票为推举服务器2。此时服务器1票数0票，服务器2票数2票，没有半数以上结果，选举无法完成，服务器1，2状态保持LOOKING。</p>
</li>
<li><p>服务器3启动，发起一次选举。此时服务器1和2都会更改选票为服务器3。此次投票结果：服务器1为0票，服务器2为 0 票，服务器3为3票。此时服务器3的票数已经超过半数，服务器3当选Leader。服务器1，2 更改状态为FOLLOWING，服务器3更改状态为 LEADING</p>
</li>
<li><p>服务器4启动，发起一次选举。此时服务器1，2，3已经不是LOOKING状态，不会更改选票信息。交换选票信息结果：服务器3为3票，服务器4为 1票。此时服务器4服从多数，更改选票信息为服务器3，并更改状态为 FOLLOWING；</p>
</li>
<li><p>服务器5启动，同服务器4一样作为follwer。</p>
</li>
</ol>
<p><strong>注意：客户端的每次写操作都有 事务id（zxid）</strong></p>
<p>SID：服务器ID。用来唯一标识一台 ZooKeeper 集群中的机器，每台机器不能重复，和myid一致。</p>
<p>ZXID：事务ID。ZXID是一个事务ID，用来标识一次服务器状态的变更。在某一时刻， 集群中的每台机器的 ZXID 值不一		定完全一 致，这和 ZooKeeper 服务器对于客户端 “更新请求” 的处理逻辑有关。</p>
<p>Epoch：每个Leader任期的代号。没有 Leader时同一轮投票过程中的逻辑时钟值是相同的。每投完一次票这个数据就会		增加。</p>
<h3 id="非第一次启动"><a href="#非第一次启动" class="headerlink" title="非第一次启动"></a>非第一次启动</h3><p><img src="/2023/03/16/Zookeeper/Java\Document\Zookeeper\Zookeeper.assets\image-20220927220711206.png" alt="image-20220927220711206"></p>
<p>当 ZooKeeper 集群中的一台服务器出现以下两种情况之一时，就会开始进入 Leader 选举：</p>
<ul>
<li><p>服务器初始化启动</p>
</li>
<li><p>服务器运行期间无法和Leader保持连接，此时需要进行选举。</p>
</li>
</ul>
<p>而当一台机器进入Leader选举流程时，当前集群也可能会处于以下两种状态：</p>
<ol>
<li><p>集群中本来就已经存在一个Leader。 对于第一种已经存在Leader的情况，机器试图去选举Leader时，会被告知当前服务器的Leader信息，对于该机器来说，仅仅需要和Leader机器建立连 接，并进行状态同步即可。</p>
</li>
<li><p>集群中确实不存在Leader（宕机）。</p>
<p> 假设ZooKeeper由5台服务器组成，SID分别为1、2、3、4、5，ZXID分别为8、8、8、7、7，并且此时SID为3的服务器是Leader。某一时刻， 3和5服务器出现故障，因此开始进行Leader选举。</p>
</li>
</ol>
<p>​												（EPOCH，ZXID，SID ）	 （EPOCH，ZXID，SID ）	（EPOCH，ZXID，SID ）</p>
<p>SID为1、2、4的机器投票情况：		(1, 8, 1)								（1，8，2） 							（1，7，4）</p>
<p>选举Leader规则： ① EPOCH大的直接胜出		② EPOCH相同，事务id大的胜出		③  事务id相同，服务器id大的胜出</p>
<h2 id="客户端命令行操作"><a href="#客户端命令行操作" class="headerlink" title="客户端命令行操作"></a>客户端命令行操作</h2><h3 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h3><table>
<thead>
<tr>
<th>命令</th>
<th>描述信息</th>
</tr>
</thead>
<tbody><tr>
<td>ls [-s] [-w] [-R] path</td>
<td>查看当前节点的 znode 节点，-w ：监听子节点变化，-s：附加层级信息</td>
</tr>
<tr>
<td>create [-s] [-e] [-c] [-t ttl] path [data] [acl]</td>
<td>创建节点，-s：含有序列，-e：临时节点（重启或超时消失）</td>
</tr>
<tr>
<td>get [-s] [-w] path</td>
<td>获得节点的值 [可监听] -w 监听节点内容变化 -s 附加次级信息</td>
</tr>
<tr>
<td>set [-s] [-v version] path data</td>
<td>设置节点的具体值</td>
</tr>
<tr>
<td>stat [-w] path</td>
<td>查看节点状态</td>
</tr>
<tr>
<td>delete [-v version] path</td>
<td>删除节点</td>
</tr>
<tr>
<td>deleteall path</td>
<td>递归删除节点</td>
</tr>
</tbody></table>
<h3 id="znode-节点数据信息"><a href="#znode-节点数据信息" class="headerlink" title="znode 节点数据信息"></a>znode 节点数据信息</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 17] ls /</span><br><span class="line">[zookeeper]</span><br><span class="line">[zk: localhost:2181(CONNECTED) 18] ls -s /</span><br><span class="line">[zookeeper]cZxid = 0x0</span><br><span class="line">ctime = Thu Jan 01 08:00:00 CST 1970</span><br><span class="line">mZxid = 0x0</span><br><span class="line">mtime = Thu Jan 01 08:00:00 CST 1970</span><br><span class="line">pZxid = 0x0</span><br><span class="line">cversion = -1</span><br><span class="line">dataVersion = 0</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x0</span><br><span class="line">dataLength = 0</span><br><span class="line">numChildren = 1</span><br><span class="line">[zk: localhost:2181(CONNECTED) 19]</span><br></pre></td></tr></table></figure>

<ul>
<li>czxid：创建节点的事务 zxid</li>
</ul>
<p>​		每次修改 ZooKeeper 状态都会产生一个 ZooKeeper 事务 ID。事务 ID 是 ZooKeeper 中所有修改总的次序。每次修		改都有唯一的 zxid，如果 zxid1 小于 zxid2，那么 zxid1 在 zxid2 之前发生。</p>
<ul>
<li><p>ctime：znode 被创建的毫秒数（从 1970 年开始）</p>
</li>
<li><p>mzxid：znode 最后更新的事务 zxid</p>
</li>
<li><p>mtime：znode 最后修改的毫秒数（从 1970 年开始）</p>
</li>
<li><p>pZxid：znode 最后更新的子节点 zxid</p>
</li>
<li><p>cversion：znode 子节点变化号，znode 子节点修改次数</p>
</li>
<li><p>dataversion：znode 数据变化号</p>
</li>
<li><p>aclVersion：znode 访问控制列表的变化号</p>
</li>
<li><p>ephemeralOwner：如果是临时节点，这个是 znode 拥有者的 session id。如果不是 临时节点则是 0。</p>
</li>
<li><p>dataLength：znode 的数据长度</p>
</li>
<li><p>numChildren：znode 子节点数量</p>
</li>
</ul>
<h3 id="节点类型（持久-x2F-短暂-x2F-有序号-x2F-无序号）"><a href="#节点类型（持久-x2F-短暂-x2F-有序号-x2F-无序号）" class="headerlink" title="节点类型（持久&#x2F;短暂&#x2F;有序号&#x2F;无序号）"></a>节点类型（持久&#x2F;短暂&#x2F;有序号&#x2F;无序号）</h3><p>持久（Persistent）：客户端和服务器端断开连接后，创建的节点不删除</p>
<p>短暂（Ephemeral）：客户端和服务器端断开连接后，创建的节点自己删除</p>
<p>顺序：创建 znode 时设置顺序标识，znode 名称后会附加一个值，顺序号是一个单调递增的计数器，由父节点维护</p>
<p>​			在分布式系统中，顺序号可以被用于为所有的事件进行全局排序，这样客户端可以通过顺序号推断事件的顺序</p>
<ol>
<li><p>分别创建2个普通节点（永久节点 + 不带序号）</p>
<blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 14] create /node01 &quot;server01&quot;</span><br><span class="line">Created /node01</span><br><span class="line">[zk: localhost:2181(CONNECTED) 15] create /node02/node03 &quot;server03&quot;</span><br><span class="line">Node does not exist: /node02/node03</span><br><span class="line">[zk: localhost:2181(CONNECTED) 16] create /node02 &quot;server02&quot;</span><br><span class="line">Created /node02</span><br><span class="line">[zk: localhost:2181(CONNECTED) 17] create /node02/node03 &quot;server03&quot;</span><br><span class="line">Created /node02/node03</span><br><span class="line">[zk: localhost:2181(CONNECTED) 18] create /node04</span><br><span class="line">Created /node04</span><br></pre></td></tr></table></figure>

<p>注意：创建节点时要赋值（否则为null），<strong>且不能创建多级节点</strong></p>
</blockquote>
</li>
<li><p>获取节点的值</p>
<blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 19] get -s /node01</span><br><span class="line">server01</span><br><span class="line">cZxid = 0x200000016</span><br><span class="line">ctime = Tue Sep 27 23:18:29 CST 2022</span><br><span class="line">mZxid = 0x200000016</span><br><span class="line">mtime = Tue Sep 27 23:18:29 CST 2022</span><br><span class="line">pZxid = 0x200000016</span><br><span class="line">cversion = 0</span><br><span class="line">dataVersion = 0</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x0</span><br><span class="line">dataLength = 8</span><br><span class="line">numChildren = 0</span><br><span class="line">[zk: localhost:2181(CONNECTED) 20] get -s /node02</span><br><span class="line">server02</span><br><span class="line">cZxid = 0x200000018</span><br><span class="line">ctime = Tue Sep 27 23:18:56 CST 2022</span><br><span class="line">mZxid = 0x200000018</span><br><span class="line">mtime = Tue Sep 27 23:18:56 CST 2022</span><br><span class="line">pZxid = 0x200000019</span><br><span class="line">cversion = 1</span><br><span class="line">dataVersion = 0</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x0</span><br><span class="line">dataLength = 8</span><br><span class="line">numChildren = 1</span><br><span class="line">[zk: localhost:2181(CONNECTED) 21] get -s /node04</span><br><span class="line">null</span><br><span class="line">cZxid = 0x20000001a</span><br><span class="line">ctime = Tue Sep 27 23:19:23 CST 2022</span><br><span class="line">mZxid = 0x20000001a</span><br><span class="line">mtime = Tue Sep 27 23:19:23 CST 2022</span><br><span class="line">pZxid = 0x20000001a</span><br><span class="line">cversion = 0</span><br><span class="line">dataVersion = 0</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x0</span><br><span class="line">dataLength = 0</span><br><span class="line">numChildren = 0</span><br><span class="line">[zk: localhost:2181(CONNECTED) 22]</span><br></pre></td></tr></table></figure>


</blockquote>
</li>
<li><p>创建带序号的节点（永久节点 + 带序号）</p>
<p> ​	<strong>如果原来没有节点，序号从 0 开始依次递增。如果原节点下已有 2 个节点，则再排序时从 2 开始，以此类推。</strong></p>
<blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 10] create /nodeA &quot;serverA&quot;</span><br><span class="line">Created /nodeA</span><br><span class="line">[zk: localhost:2181(CONNECTED) 11] create /nodeA/nodeB &quot;serverB&quot;</span><br><span class="line">Created /nodeA/nodeB</span><br><span class="line">[zk: localhost:2181(CONNECTED) 12] create -s /nodeA/nodeC &quot;serverC&quot;</span><br><span class="line">Created /nodeA/nodeC0000000001</span><br><span class="line">[zk: localhost:2181(CONNECTED) 13] create -s /nodeA/nodeD &quot;serverD&quot;</span><br><span class="line">Created /nodeA/nodeD0000000002</span><br><span class="line">[zk: localhost:2181(CONNECTED) 14] create -s /nodeA/nodeC &quot;serverCC&quot;</span><br><span class="line">Created /nodeA/nodeC0000000003</span><br><span class="line">[zk: localhost:2181(CONNECTED) 15] get -s /nodeA/nodeC</span><br><span class="line">org.apache.zookeeper.KeeperException$NoNodeException: KeeperErrorCode = NoNode for /nodeA/nodeC</span><br><span class="line">[zk: localhost:2181(CONNECTED) 19] ls /nodeA</span><br><span class="line">[nodeB, nodeC0000000001, nodeC0000000003, nodeD0000000002]</span><br><span class="line">[zk: localhost:2181(CONNECTED) 21] create -s /nodeA/nodeB/nodeE &quot;serverE&quot;</span><br><span class="line">Created /nodeA/nodeB/nodeE0000000000</span><br><span class="line">[zk: localhost:2181(CONNECTED) 20] create -s /nodeE &quot;serverE&quot;</span><br><span class="line">Created /nodeE0000000010</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>创建短暂节点（短暂节点 + 不带序号 &#x2F; 带序号）</p>
<blockquote>
<p>退出当前客户端然后再重启客户端，短暂节点已经删除</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 6] create -s /tempNode &quot;tempServer&quot;</span><br><span class="line">Created /tempNode0000000012</span><br><span class="line">[zk: localhost:2181(CONNECTED) 7] create -s -e /tempNode &quot;tempServer&quot;</span><br><span class="line">Created /tempNode0000000013</span><br><span class="line">[zk: localhost:2181(CONNECTED) 1] quit</span><br><span class="line"></span><br><span class="line">WATCHER::</span><br><span class="line"></span><br><span class="line">WatchedEvent state:Closed type:None path:null</span><br><span class="line">2022-09-27 23:45:59,221 [myid:] - INFO  [main:ZooKeeper@1422] - Session: 0x1000132016c0008 closed</span><br><span class="line">2022-09-27 23:45:59,228 [myid:] - INFO  [main-EventThread:ClientCnxn$EventThread@524] - EventThread shut down for session: 0x1000132016c0008</span><br><span class="line">[root@root ~]# zkCli.sh</span><br><span class="line">[zk: localhost:2181(CONNECTED) 1] get -s /tempNode0000000013</span><br><span class="line">org.apache.zookeeper.KeeperException$NoNodeException: KeeperErrorCode = NoNode for /tempNode0000000013</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>修改节点数据值</p>
<blockquote>
<p>dataVersion 会改变</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 1] get -s /nodeA</span><br><span class="line">serverA</span><br><span class="line">cZxid = 0x200000025</span><br><span class="line">ctime = Tue Sep 27 23:27:02 CST 2022</span><br><span class="line">mZxid = 0x200000025</span><br><span class="line">mtime = Tue Sep 27 23:27:02 CST 2022</span><br><span class="line">pZxid = 0x200000029</span><br><span class="line">cversion = 4</span><br><span class="line">dataVersion = 0</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x0</span><br><span class="line">dataLength = 7</span><br><span class="line">numChildren = 4</span><br><span class="line">[zk: localhost:2181(CONNECTED) 2] set /nodeA &quot;mserverA&quot;</span><br><span class="line">[zk: localhost:2181(CONNECTED) 3] get -s /nodeA</span><br><span class="line">mserverA</span><br><span class="line">cZxid = 0x200000025</span><br><span class="line">ctime = Tue Sep 27 23:27:02 CST 2022</span><br><span class="line">mZxid = 0x200000035</span><br><span class="line">mtime = Tue Sep 27 23:44:19 CST 2022</span><br><span class="line">pZxid = 0x200000029</span><br><span class="line">cversion = 4</span><br><span class="line">dataVersion = 1</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x0</span><br><span class="line">dataLength = 8</span><br><span class="line">numChildren = 4</span><br><span class="line">[zk: localhost:2181(CONNECTED) 4]</span><br></pre></td></tr></table></figure></blockquote>
</li>
</ol>
<h3 id="监听器原理"><a href="#监听器原理" class="headerlink" title="监听器原理"></a>监听器原理</h3><p>​		客户端注册监听它关心的目录节点，当目录节点发生变化（数据改变、节点删除、子目 录节点增加删除）时，ZooKeeper 会通知客户端。监听机制保证 ZooKeeper 保存的任何的数 据的任何改变都能快速的响应到监听了该节点的应用程序。</p>
<p>原理详解：</p>
<ol>
<li><p>在main线程中创建Zookeeper客户端，这时就会创建两个线程，一个负责网络连接通信（connet），一个负责监听（listener）。</p>
</li>
<li><p>通过 connect 线程将注册的监听事件发送给 Zookeeper。</p>
</li>
<li><p>在 Zookeeper 的注册监听器列表中将注册的监听事件添加到列表中。</p>
</li>
<li><p>Zookeeper 监听到有数据或路径变化，就会将这个消息发送给 listener 线程。</p>
</li>
<li><p>listener 线程内部调用了 process() 方法。</p>
<blockquote>
<p><img src="/2023/03/16/Zookeeper/Java\Document\Zookeeper\Zookeeper.assets\image-20220927234552567.png" alt="image-20220927234552567"></p>
</blockquote>
</li>
</ol>
<p>常见的监听：</p>
<p>监听节点数据的变化：get path [watch]</p>
<p>监听子节点增减的变化：ls path [watch]</p>
<p>（1）节点的值变化监听：</p>
<blockquote>
<p>在 192.168.100.100 上监听节点的值，在192.168.100.110 上修改节点的值</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 10] create /node01 &quot;server01&quot;</span><br><span class="line">Created /node01</span><br><span class="line">[zk: localhost:2181(CONNECTED) 11] get -w /node01</span><br><span class="line">server01</span><br><span class="line">[zk: localhost:2181(CONNECTED) 12]</span><br><span class="line">WATCHER::</span><br><span class="line"></span><br><span class="line">WatchedEvent state:SyncConnected type:NodeDataChanged path:/node01</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 0] ls /</span><br><span class="line">[node01, zookeeper]</span><br><span class="line">[zk: localhost:2181(CONNECTED) 1] set /node01 &quot;node02&quot;</span><br><span class="line">[zk: localhost:2181(CONNECTED) 2] set /node01 &quot;node03&quot;</span><br></pre></td></tr></table></figure>

<p>注意：注册一次，只能监听一次。</p>
</blockquote>
<p>（2）节点的子节点变化监听（路径变化）</p>
<blockquote>
<p>在 192.168.100.100 上监听节点的值，在192.168.100.110 上修改节点的值</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 0] ls /</span><br><span class="line">[node01, zookeeper]</span><br><span class="line">[zk: localhost:2181(CONNECTED) 1] ls -w /node01</span><br><span class="line">[]</span><br><span class="line">[zk: localhost:2181(CONNECTED) 2]</span><br><span class="line">WATCHER::</span><br><span class="line"></span><br><span class="line">WatchedEvent state:SyncConnected type:NodeChildrenChanged path:/node01</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 0] create /node01/node02</span><br><span class="line">Created /node01/node02</span><br><span class="line">[zk: localhost:2181(CONNECTED) 1] create /node01/node03</span><br><span class="line">Created /node01/node03</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="节点删除与查看"><a href="#节点删除与查看" class="headerlink" title="节点删除与查看"></a>节点删除与查看</h3><blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 1] ls /node01</span><br><span class="line">[node02, node03]</span><br><span class="line">[zk: localhost:2181(CONNECTED) 2] deleteall /node01</span><br><span class="line">[zk: localhost:2181(CONNECTED) 3] ls /</span><br><span class="line">[zookeeper]</span><br><span class="line">[zk: localhost:2181(CONNECTED) 4] stat /zookeeper</span><br><span class="line">cZxid = 0x0</span><br><span class="line">ctime = Thu Jan 01 08:00:00 CST 1970</span><br><span class="line">mZxid = 0x0</span><br><span class="line">mtime = Thu Jan 01 08:00:00 CST 1970</span><br><span class="line">pZxid = 0x0</span><br><span class="line">cversion = -2</span><br><span class="line">dataVersion = 0</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x0</span><br><span class="line">dataLength = 0</span><br><span class="line">numChildren = 2</span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="客户端-API-操作"><a href="#客户端-API-操作" class="headerlink" title="客户端 API 操作"></a>客户端 API 操作</h2><h3 id="创建工程"><a href="#创建工程" class="headerlink" title="创建工程"></a>创建工程</h3><blockquote>
<p>pom.xml</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;junit&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;junit&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;RELEASE&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;log4j-core&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.8.2&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.zookeeper&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;zookeeper&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;3.5.7&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>

<p>log4j.properties</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">log4j.rootLogger=INFO, stdout</span><br><span class="line">log4j.appender.stdout=org.apache.log4j.ConsoleAppender</span><br><span class="line">log4j.appender.stdout.layout=org.apache.log4j.PatternLayout</span><br><span class="line">log4j.appender.stdout.layout.ConversionPattern=%d %p [%c] - %m%n</span><br><span class="line">log4j.appender.logfile=org.apache.log4j.FileAppender</span><br><span class="line">log4j.appender.logfile.File=target/spring.log</span><br><span class="line">log4j.appender.logfile.layout=org.apache.log4j.PatternLayout</span><br><span class="line">log4j.appender.logfile.layout.ConversionPattern=%d %p [%c] - %m%n</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="创建-ZooKeeper-客户端"><a href="#创建-ZooKeeper-客户端" class="headerlink" title="创建 ZooKeeper 客户端"></a>创建 ZooKeeper 客户端</h3><p><strong>使用客户端 API 连接时，sessionTimeout 应该设置大些，否则报错：</strong></p>
<p>org.apache.zookeeper.KeeperException$ConnectionLossException: KeeperErrorCode &#x3D; ConnectionLoss for &#x2F;node01</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ZkClient</span> &#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="type">ZooKeeper</span> <span class="variable">zooKeeper</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">connectString</span> <span class="operator">=</span> <span class="string">&quot;192.168.100.100:2181,192.168.100.110:2181,192.168.100.120:2181&quot;</span>;</span><br><span class="line">    <span class="comment">// 注意，该值在确保网络，防火墙关闭的情况下，值应该设置大一点</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">sessionTimeout</span> <span class="operator">=</span> <span class="number">100000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建 ZooKeeper 客户端</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            zooKeeper = <span class="keyword">new</span> <span class="title class_">ZooKeeper</span>(connectString, sessionTimeout, <span class="keyword">new</span> <span class="title class_">Watcher</span>() &#123;</span><br><span class="line">                <span class="comment">// 监听节点变化（值/路径），收到事件后的回调函数</span></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(WatchedEvent watchedEvent)</span> &#123;</span><br><span class="line">                    System.out.println(watchedEvent.getType() + <span class="string">&quot; :: &quot;</span> + watchedEvent.getPath());</span><br><span class="line">                    <span class="comment">// 再次监听</span></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">for</span> (String child : zooKeeper.getChildren(<span class="string">&quot;/&quot;</span>, <span class="literal">true</span>)) &#123;</span><br><span class="line">                            System.out.println(<span class="string">&quot;child: &quot;</span> + child);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (KeeperException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="创建节点"><a href="#创建节点" class="headerlink" title="创建节点"></a>创建节点</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建节点</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testCreate</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 参数 1：要创建的节点的路径；参数 2：节点数据 ；参数 3：节点权限 ；参数 4：节点的类型</span></span><br><span class="line">    zooKeeper.create(<span class="string">&quot;/node01&quot;</span>,</span><br><span class="line">            <span class="string">&quot;server01&quot;</span>.getBytes(StandardCharsets.UTF_8),</span><br><span class="line">            ZooDefs.Ids.OPEN_ACL_UNSAFE,</span><br><span class="line">            CreateMode.PERSISTENT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="监听子节点变化"><a href="#监听子节点变化" class="headerlink" title="监听子节点变化"></a>监听子节点变化</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取子节点并监听节点变化</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testGetChildren</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    List&lt;String&gt; children = zooKeeper.getChildren(<span class="string">&quot;/&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">for</span> (String child : children) &#123;</span><br><span class="line">        System.out.println(child);</span><br><span class="line">    &#125;</span><br><span class="line">    System.in.read();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="判断节点是否存在"><a href="#判断节点是否存在" class="headerlink" title="判断节点是否存在"></a>判断节点是否存在</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 判断节点是否存在</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testExists</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Stat</span> <span class="variable">stat</span> <span class="operator">=</span> zooKeeper.exists(<span class="string">&quot;/node01&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">    System.out.println(stat == <span class="literal">null</span> ? <span class="string">&quot;not exist&quot;</span> : <span class="string">&quot;exist&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="客户端向服务端写数据流程"><a href="#客户端向服务端写数据流程" class="headerlink" title="客户端向服务端写数据流程"></a>客户端向服务端写数据流程</h2><h3 id="写入请求直接发送给Leader节点"><a href="#写入请求直接发送给Leader节点" class="headerlink" title="写入请求直接发送给Leader节点"></a>写入请求直接发送给Leader节点</h3><p>客户端请求 leader，leader 自己写数据并发送数据给 follower，follower 写数据完成，发送 ack 给leader，此时写入数据的机器已经超过半数，leader 发送 ack 给 Client，之后 leader 再写数据给其他 follower。</p>
<p><img src="/2023/03/16/Zookeeper/Java\Document\Zookeeper\Zookeeper.assets\image-20220928110608916.png" alt="image-20220928110608916"></p>
<h3 id="写入请求发送给follower节点"><a href="#写入请求发送给follower节点" class="headerlink" title="写入请求发送给follower节点"></a>写入请求发送给follower节点</h3><p>客户端请求 follower，follower 没有写的权限，将请求发送给 leader，leader 自己写数据完成，并写数据给 follower，follower 写数据完成，发送 ack 给 leader，此时 leader 判断写入数据的机器已经超过半数，leader 发送 ack 给 follower（follower 和 Client 建立连接），之后 leader 再写数据给其他 follower。</p>
<p><img src="/2023/03/16/Zookeeper/Java\Document\Zookeeper\Zookeeper.assets\image-20220928110637290.png" alt="image-20220928110637290"></p>
<h2 id="服务器动态上下线监听案例"><a href="#服务器动态上下线监听案例" class="headerlink" title="服务器动态上下线监听案例"></a>服务器动态上下线监听案例</h2><p>要求：某分布式系统中，主节点可以有多台，可以动态上下线，任意一台客户端都能实时感知到主节点服务器的上下线。</p>
<p><img src="/2023/03/16/Zookeeper/Java\Document\Zookeeper\Zookeeper.assets\image-20220928111752756.png" alt="image-20220928111752756"></p>
<h3 id="服务端注册"><a href="#服务端注册" class="headerlink" title="服务端注册"></a>服务端注册</h3><p>在集群上创建 &#x2F;servers 节点</p>
<p><strong>注意删除时，要写全路径。</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 8] create /servers &quot;servers&quot;</span><br><span class="line">Created /servers</span><br><span class="line">[zk: localhost:2181(CONNECTED) 9] ls /</span><br><span class="line">[servers, zookeeper]</span><br></pre></td></tr></table></figure>

<p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.zookeeper.watchdemo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WatchOnOffLineServer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">ZooKeeper</span> <span class="variable">zooKeeper</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">connectString</span> <span class="operator">=</span> <span class="string">&quot;192.168.100.100:2181,192.168.100.110:2181,192.168.100.120:2181&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">sessionTimeout</span> <span class="operator">=</span> <span class="number">100000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">parentNode</span> <span class="operator">=</span> <span class="string">&quot;/servers&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        String[] hostnameArray = args.length &gt; <span class="number">0</span> ? args : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;192.168.100.100&quot;</span>, <span class="string">&quot;192.168.100.110&quot;</span>&#125;;</span><br><span class="line">        <span class="type">WatchOnOffLineServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WatchOnOffLineServer</span>();</span><br><span class="line">        server.getConnection();</span><br><span class="line">        <span class="keyword">for</span> (String hostname : hostnameArray) &#123;</span><br><span class="line">            server.registServer(hostname);</span><br><span class="line">            server.business(hostname);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">business</span><span class="params">(String hostname)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        System.out.println(hostname + <span class="string">&quot; is working ...&quot;</span>);</span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 向Zookeeper注册服务器信息，数据为$&#123;hostname&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> hostname</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> KeeperException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">registServer</span><span class="params">(String hostname)</span> <span class="keyword">throws</span> InterruptedException, KeeperException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">created</span> <span class="operator">=</span> zooKeeper.create(</span><br><span class="line">                parentNode + <span class="string">&quot;/server&quot;</span>,</span><br><span class="line">                hostname.getBytes(StandardCharsets.UTF_8),</span><br><span class="line">                ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT_SEQUENTIAL);</span><br><span class="line">        System.out.println(hostname + <span class="string">&quot; online ...&quot;</span> + created);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        zooKeeper = <span class="keyword">new</span> <span class="title class_">ZooKeeper</span>(connectString, sessionTimeout, <span class="keyword">new</span> <span class="title class_">Watcher</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(WatchedEvent watchedEvent)</span> &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="客户端监听"><a href="#客户端监听" class="headerlink" title="客户端监听"></a>客户端监听</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">package com.example.zookeeper.watchdemo;</span><br><span class="line"></span><br><span class="line">import org.apache.zookeeper.*;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.nio.charset.StandardCharsets;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line">public class WatchOnOffLineClient &#123;</span><br><span class="line">    private ZooKeeper zooKeeper = null;</span><br><span class="line">    private String connectString = &quot;192.168.100.100:2181,192.168.100.110:2181,192.168.100.120:2181&quot;;</span><br><span class="line">    private static int sessionTimeout = 100000;</span><br><span class="line">    private String parentNode = &quot;/servers&quot;;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        WatchOnOffLineClient client = new WatchOnOffLineClient();</span><br><span class="line">        client.getConnection();</span><br><span class="line">        client.getServerList();</span><br><span class="line">        client.business();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void getConnection() throws IOException &#123;</span><br><span class="line">        zooKeeper = new ZooKeeper(connectString, sessionTimeout, new Watcher() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void process(WatchedEvent watchedEvent) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    getServerList();</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void getServerList() throws InterruptedException, KeeperException &#123;</span><br><span class="line">        List&lt;String&gt; children = zooKeeper.getChildren(parentNode, true);</span><br><span class="line">        // 存储服务器信息列表</span><br><span class="line">        List&lt;String&gt; servers = new ArrayList&lt;&gt;();</span><br><span class="line">        // 遍历所有节点，获取节点中的主机名称信息</span><br><span class="line">        for (String child : children) &#123;</span><br><span class="line">            byte[] data = zooKeeper.getData(parentNode + &quot;/&quot; + child, false, null);</span><br><span class="line">            servers.add(new String(data, StandardCharsets.UTF_8));</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(&quot;servers: &quot; + servers);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void business() throws IOException &#123;</span><br><span class="line">        System.out.println(&quot;client is working ...&quot;);</span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="ZooKeeper-分布式锁实现"><a href="#ZooKeeper-分布式锁实现" class="headerlink" title="ZooKeeper 分布式锁实现"></a>ZooKeeper 分布式锁实现</h1><h2 id="实现过程"><a href="#实现过程" class="headerlink" title="实现过程"></a>实现过程</h2><p>分布式锁：分布式系统中多个进程能够有序访问临界资源的锁即为分布式锁。</p>
<p><img src="/2023/03/16/Zookeeper/Java\Document\Zookeeper\Zookeeper.assets\image-20221009235930879.png" alt="image-20221009235930879"></p>
<p>通过创建有序的临时节点实现分布式锁，该节点作为分布式锁。</p>
<p>客户端判断获取到的节点是否为最小节点，如果是则该节点作为锁，，如果不是，则监听上一个节点，对于每一个节点，处理完业务后，需要释放锁，其他的节点得到锁。</p>
<h2 id="原生Zookeeper实现分布式锁"><a href="#原生Zookeeper实现分布式锁" class="headerlink" title="原生Zookeeper实现分布式锁"></a>原生Zookeeper实现分布式锁</h2><p>分布式锁：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.zookeeper.lock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.data.Stat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DistributedLock</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">connectString</span> <span class="operator">=</span> <span class="string">&quot;192.168.100.100:2181,192.168.100.110:2181,192.168.100.120:2181&quot;</span>;</span><br><span class="line">    <span class="comment">// 注意，该值在确保网络，防火墙关闭的情况下，值应该设置大一点</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">sessionTimeout</span> <span class="operator">=</span> <span class="number">100000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">ZooKeeper</span> <span class="variable">zooKeeper</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">rootNode</span> <span class="operator">=</span> <span class="string">&quot;/locks&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">subNodePrefix</span> <span class="operator">=</span> <span class="string">&quot;/seq-&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">CountDownLatch</span> <span class="variable">connectLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="type">CountDownLatch</span> <span class="variable">waitLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">currentNode</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">waitNode</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建节点</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DistributedLock</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException, KeeperException &#123;</span><br><span class="line">        zooKeeper = <span class="keyword">new</span> <span class="title class_">ZooKeeper</span>(connectString, sessionTimeout, <span class="keyword">new</span> <span class="title class_">Watcher</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(WatchedEvent watchedEvent)</span> &#123;</span><br><span class="line">                <span class="comment">// 监听连接事件</span></span><br><span class="line">                <span class="keyword">if</span> (watchedEvent.getState() == Event.KeeperState.SyncConnected) &#123;</span><br><span class="line">                    connectLatch.countDown();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 监听上一个节点</span></span><br><span class="line">                <span class="keyword">if</span> (watchedEvent.getType() == Event.EventType.NodeDeleted &amp;&amp; watchedEvent.getPath().equals(waitNode)) &#123;</span><br><span class="line">                    waitLatch.countDown();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 等待连接完成，创建节点</span></span><br><span class="line">        connectLatch.await();</span><br><span class="line">        <span class="comment">// 判断节点是否存在</span></span><br><span class="line">        <span class="type">Stat</span> <span class="variable">exists</span> <span class="operator">=</span> zooKeeper.exists(rootNode, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (exists == <span class="literal">null</span>) &#123;</span><br><span class="line">            zooKeeper.create(rootNode, rootNode.getBytes(StandardCharsets.UTF_8), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加锁：即创建临时有序的子节点，如果有多个，则排序等待前一个释放锁</span></span><br><span class="line"><span class="comment">     * 释放锁：删除该子节点</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">zkLock</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, KeeperException &#123;</span><br><span class="line">        currentNode = zooKeeper.create(rootNode + subNodePrefix, <span class="literal">null</span>,</span><br><span class="line">                ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL_SEQUENTIAL);</span><br><span class="line">        <span class="comment">// 方便测试</span></span><br><span class="line">        Thread.sleep(<span class="number">10</span>);</span><br><span class="line">        List&lt;String&gt; children = zooKeeper.getChildren(rootNode, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (children.size() == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Collections.sort(children);</span><br><span class="line">            <span class="type">String</span> <span class="variable">thisNode</span> <span class="operator">=</span> currentNode.substring(rootNode.length() + <span class="number">1</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;thisNode: &quot;</span> + thisNode);</span><br><span class="line">            <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> children.indexOf(thisNode);</span><br><span class="line">            <span class="keyword">if</span> (index == -<span class="number">1</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;数据异常&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (index == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                waitNode = rootNode + <span class="string">&quot;/&quot;</span> + children.get(index - <span class="number">1</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;waitNode: &quot;</span> + waitNode);</span><br><span class="line">                zooKeeper.getData(waitNode, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">Stat</span>());</span><br><span class="line">                waitLatch.await();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解锁</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">zkUnlock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 删除节点，设置版本</span></span><br><span class="line">            zooKeeper.delete(<span class="built_in">this</span>.currentNode, -<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException | KeeperException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试分布式锁：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.zookeeper.lock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.KeeperException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DistributedLockTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, InterruptedException, KeeperException &#123;</span><br><span class="line">        <span class="type">DistributedLock</span> <span class="variable">distributedLock01</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DistributedLock</span>();</span><br><span class="line">        <span class="type">DistributedLock</span> <span class="variable">distributedLock02</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DistributedLock</span>();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    distributedLock01.zkLock();</span><br><span class="line">                    System.out.println(<span class="string">&quot;Thread01 上锁...&quot;</span>);</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                    distributedLock01.zkUnlock();</span><br><span class="line">                    System.out.println(<span class="string">&quot;Thread01 解锁...&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException | KeeperException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;Thread01&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    distributedLock02.zkLock();</span><br><span class="line">                    System.out.println(<span class="string">&quot;Thread02 上锁...&quot;</span>);</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                    distributedLock02.zkUnlock();</span><br><span class="line">                    System.out.println(<span class="string">&quot;Thread02 解锁...&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException | KeeperException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;Thread02&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试结果：</p>
<p>Thread02 上锁…</p>
<p>Thread02 解锁…</p>
<p>Thread01 上锁…</p>
<p>Thread01 解锁…</p>
<h2 id="Curator-框架实现分布式锁"><a href="#Curator-框架实现分布式锁" class="headerlink" title="Curator 框架实现分布式锁"></a>Curator 框架实现分布式锁</h2><h3 id="原生的-Java-API-开发存在的问题"><a href="#原生的-Java-API-开发存在的问题" class="headerlink" title="原生的 Java API 开发存在的问题"></a>原生的 Java API 开发存在的问题</h3><p>（1）会话连接是异步的，需要自己去处理。比如使用 CountDownLatch</p>
<p> （2）Watch 需要重复注册，不然就不能生效 </p>
<p>（3）开发的复杂性还是比较高的 </p>
<p>（4）不支持多节点删除和创建。需要自己去递归</p>
<blockquote>
<p>Curator 是一个专门解决分布式锁的框架，解决了原生 JavaAPI 开发分布式遇到的问题。 </p>
<p>详情请查看官方文档：<a target="_blank" rel="noopener" href="https://curator.apache.org/index.html">https://curator.apache.org/index.html</a></p>
</blockquote>
<h3 id="Curator-示例"><a href="#Curator-示例" class="headerlink" title="Curator 示例"></a>Curator 示例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.zookeeper.lock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFramework;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFrameworkFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.locks.InterProcessMutex;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.retry.ExponentialBackoffRetry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CuratorLockTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 创建分布式锁1</span></span><br><span class="line">        <span class="type">InterProcessMutex</span> <span class="variable">lock1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InterProcessMutex</span>(getCuratorFramework(), <span class="string">&quot;/locks&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建分布式锁2</span></span><br><span class="line">        <span class="type">InterProcessMutex</span> <span class="variable">lock2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InterProcessMutex</span>(getCuratorFramework(), <span class="string">&quot;/locks&quot;</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    lock1.acquire();</span><br><span class="line">                    System.out.println(<span class="string">&quot;线程1 获取到锁&quot;</span>);</span><br><span class="line">                    lock1.acquire();</span><br><span class="line">                    System.out.println(<span class="string">&quot;线程1 再次获取到锁(可重入锁)&quot;</span>);</span><br><span class="line">                    Thread.sleep(<span class="number">2</span> * <span class="number">1000</span>);</span><br><span class="line">                    lock1.release();</span><br><span class="line">                    System.out.println(<span class="string">&quot;线程1 释放锁&quot;</span>);</span><br><span class="line">                    lock1.release();</span><br><span class="line">                    System.out.println(<span class="string">&quot;线程1 再次释放锁&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    lock2.acquire();</span><br><span class="line">                    System.out.println(<span class="string">&quot;线程2 获取到锁&quot;</span>);</span><br><span class="line">                    lock2.acquire();</span><br><span class="line">                    System.out.println(<span class="string">&quot;线程2 再次获取到锁&quot;</span>);</span><br><span class="line">                    Thread.sleep(<span class="number">2</span> * <span class="number">1000</span>);</span><br><span class="line">                    lock2.release();</span><br><span class="line">                    System.out.println(<span class="string">&quot;线程2 释放锁&quot;</span>);</span><br><span class="line">                    lock2.release();</span><br><span class="line">                    System.out.println(<span class="string">&quot;线程2  再次释放锁&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> CuratorFramework <span class="title function_">getCuratorFramework</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 3秒连接不上重试</span></span><br><span class="line">        <span class="type">ExponentialBackoffRetry</span> <span class="variable">policy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExponentialBackoffRetry</span>(<span class="number">3000</span>, <span class="number">3</span>);</span><br><span class="line">        <span class="type">CuratorFramework</span> <span class="variable">client</span> <span class="operator">=</span> CuratorFrameworkFactory</span><br><span class="line">                .builder()</span><br><span class="line">                .connectString(<span class="string">&quot;192.168.100.100:2181,192.168.100.110:2181,192.168.100.120:2181&quot;</span>)</span><br><span class="line">                .connectionTimeoutMs(<span class="number">2000</span>)</span><br><span class="line">                .sessionTimeoutMs(<span class="number">2000</span>)</span><br><span class="line">                .retryPolicy(policy).build();</span><br><span class="line">        <span class="comment">// 启动客户端</span></span><br><span class="line">        client.start();</span><br><span class="line">        System.out.println(<span class="string">&quot;zookeeper 启动成功&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> client;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试结果：</p>
<p>线程2 获取到锁<br>线程2 再次获取到锁<br>线程2 释放锁<br>线程2  再次释放锁<br>线程1 获取到锁<br>线程1 再次获取到锁(可重入锁)<br>线程1 释放锁<br>线程1 再次释放锁</p>
<h1 id="两个问题"><a href="#两个问题" class="headerlink" title="两个问题"></a>两个问题</h1><h2 id="选举机制-1"><a href="#选举机制-1" class="headerlink" title="选举机制"></a>选举机制</h2><p>半数机制，超过半数的投票通过，即通过。 </p>
<p>（1）第一次启动选举规则： 投票过半数时，服务器 id 大的胜出 </p>
<p>（2）第二次启动选举规则： </p>
<ul>
<li>​	EPOCH 大的直接胜出 </li>
<li>​	EPOCH 相同，事务 id 大的胜出 </li>
<li>​	事务 id 相同，服务器 id 大的胜出</li>
</ul>
<h2 id="生产集群安装多少-zk-合适？"><a href="#生产集群安装多少-zk-合适？" class="headerlink" title="生产集群安装多少 zk 合适？"></a>生产集群安装多少 zk 合适？</h2><p>安装奇数台。 </p>
<p>生产经验： </p>
<p>10 台服务器：3 台 zk； </p>
<p>20 台服务器：5 台 zk； </p>
<p>100 台服务器：11 台 zk； </p>
<p>200 台服务器：11 台 zk ；</p>
<p><strong>服务器台数多：好处，提高可靠性；坏处：提高通信延时</strong></p>
<h1 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h1><h2 id="Zookeeper-是如何保证数据一致性的？"><a href="#Zookeeper-是如何保证数据一致性的？" class="headerlink" title="Zookeeper 是如何保证数据一致性的？"></a>Zookeeper 是如何保证数据一致性的？</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/15/Nginx/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MineTing">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/15/Nginx/" class="post-title-link" itemprop="url">Nginx</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-15 00:00:00" itemprop="dateCreated datePublished" datetime="2023-03-15T00:00:00+08:00">2023-03-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-22 16:30:24" itemprop="dateModified" datetime="2023-03-22T16:30:24+08:00">2023-03-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <div align="center"><font size="70"><b>Nginx</b></font></div>

<h1 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h1><h1 id="nginx简介"><a href="#nginx简介" class="headerlink" title="nginx简介"></a>nginx简介</h1><p>地址：<a target="_blank" rel="noopener" href="http://nginx.org/">http://nginx.org/</a></p>
<p>​		Nginx (engine x) 是一个高性能的 HTTP 和反向代理 Web 服务器，同时也提供了 IMAP&#x2F;POP3&#x2F;SMTP 服务。Nginx 是由伊戈尔·赛索耶夫为俄罗斯访问量第二的 Rambler.ru站点（俄文：Рамблер）开发的，第一个公开版本0.1.0发布于2004年10月4日。</p>
<p>​		Nginx采用 C 进行编写，Nginx 是一个安装非常的简单、配置文件非常简洁（还能够支持perl语法）、Bug非常少的服务。Nginx 启动特别容易，并且几乎可以做到 7*24 不间断运行，即使运行数个月也不需要重新启动。你还能够不间断服务的情况下进行软件版本的<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%8D%87%E7%BA%A7/8358284">升级</a>。处理高并发能力是十分强大的，能经受高负载的考验,有报告表明能支持高达 50,000 个并发连接数。</p>
<h1 id="Nginx相关概念"><a href="#Nginx相关概念" class="headerlink" title="Nginx相关概念"></a>Nginx相关概念</h1><h2 id="正向代理"><a href="#正向代理" class="headerlink" title="正向代理"></a>正向代理</h2><p>正向代理：如果把局域网外的 Internet 想象成一个巨大的资源库，则局域网中的客户端要访问 Internet，则需要通过代理服务器来访问，这种代理服务就称为正向代理。</p>
<p><strong>需要在客户端配置代理服务器进行指定网站访问。</strong></p>
<p><img src="/2023/03/15/Nginx/Java\Document\Nginx\Nginx.assets\image-20220425165532060.png" alt="image-正向代理"></p>
<h2 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h2><p>​		反向代理，其实客户端对代理是无感知的，因为客户端不需要任何配置就可以访问，我们只需要将请求发送到反向代理服务器，由反向代理服务器去选择目标服务器获取数据后，在返回给客户端，此时反向代理服务器和目标服务器对外就是一个服务器，<strong>暴露的是代理服务器地址，隐藏了真实服务器 IP 地址</strong>。</p>
<p><img src="/2023/03/15/Nginx/Java\Document\Nginx\Nginx.assets\image-20220425165945076.png" alt="image-反向代理"></p>
<h2 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h2><p>​		提高单个机器的性能配置也无法解决高并发的问题，因此增加服务器的数量，然后将请求分发到各个服务器上，将原先请求集中到单个服务器上的情况改为将请求分发到多个服务器上，将负载分发到不同的服务器，也就是我们所说的负载均衡。</p>
<p><img src="/2023/03/15/Nginx/Java\Document\Nginx\Nginx.assets\image-20220425170207764.png" alt="image-负载均衡"></p>
<h2 id="动静分离"><a href="#动静分离" class="headerlink" title="动静分离"></a>动静分离</h2><p>​		为了加快网站的解析速度，可以把动态页面和静态页面由不同的服务器来解析，加快解析速度。降低原来单个服务器的压力。</p>
<p><img src="/2023/03/15/Nginx/Java\Document\Nginx\Nginx.assets\image-20220425170549236.png" alt="image-动静分离"></p>
<h1 id="nginx的安装"><a href="#nginx的安装" class="headerlink" title="nginx的安装"></a>nginx的安装</h1><p>nginx下载地址：<strong><a target="_blank" rel="noopener" href="http://nginx.org/en/download.html">http://nginx.org/en/download.html</a></strong></p>
<h2 id="nginx安装步骤"><a href="#nginx安装步骤" class="headerlink" title="nginx安装步骤"></a>nginx安装步骤</h2><h3 id="安装编译工具以及库文件"><a href="#安装编译工具以及库文件" class="headerlink" title="安装编译工具以及库文件"></a>安装编译工具以及库文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install make zlib zlib-devel gcc-c++ libtool  openssl openssl-devel</span><br></pre></td></tr></table></figure>

<h3 id="安装-pcre"><a href="#安装-pcre" class="headerlink" title="安装 pcre"></a>安装 pcre</h3><p>PCRE 作用：让 Nginx 支持 Rewrite 功能。</p>
<p>下载地址： <a target="_blank" rel="noopener" href="http://downloads.sourceforge.net/project/pcre/pcre/8.35/pcre-8.35.tar.gz">http://downloads.sourceforge.net/project/pcre/pcre/8.35/pcre-8.35.tar.gz</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost src]# cd /usr/local/src</span><br><span class="line">[root@localhost src]# wget  http://downloads.sourceforge.net/project/pcre/pcre/8.35/pcre-8.35.tar.gz</span><br></pre></td></tr></table></figure>

<p>解压并进入pcre目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost src]# tar zxvf pcre-8.35.tar.gz</span><br><span class="line">[root@localhost src]# cd pcre-8.35</span><br></pre></td></tr></table></figure>

<p>编译安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost pcre-8.35]# ./configure</span><br><span class="line">[root@localhost pcre-8.35]# make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<p>查看pcre版本：pcre-config –version</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost pcre-8.35]# pcre-config --version</span><br><span class="line">8.35</span><br></pre></td></tr></table></figure>

<h3 id="安装-nginx"><a href="#安装-nginx" class="headerlink" title="安装 nginx"></a>安装 nginx</h3><p>下载 nginx：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost pcre-8.35]# cd /usr/local/src/</span><br><span class="line">[root@localhost src]# wget http://nginx.org/download/nginx-1.16.1.tar.gz</span><br></pre></td></tr></table></figure>

<p>解压并进入nginx目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost src]# tar zxvf nginx-1.16.1.tar.gz</span><br><span class="line">[root@localhost src]# cd nginx-1.16.1/</span><br></pre></td></tr></table></figure>

<p>编译并安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost nginx-1.16.1]# ./configure</span><br><span class="line">[root@localhost nginx-1.16.1]# make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<p>查看安装版本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost nginx-1.16.1]# /usr/local/nginx/sbin/nginx -v</span><br><span class="line">nginx version: nginx/1.16.1</span><br></pre></td></tr></table></figure>

<p>命令位置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost local]# ll /usr/local/nginx/</span><br><span class="line">总用量 4</span><br><span class="line">drwxr-xr-x. 2 root root 4096 10月  9 00:43 conf</span><br><span class="line">drwxr-xr-x. 2 root root   40 10月  9 00:43 html</span><br><span class="line">drwxr-xr-x. 2 root root    6 10月  9 00:43 logs</span><br><span class="line">drwxr-xr-x. 2 root root   19 10月  9 00:43 sbin</span><br><span class="line">[root@localhost local]# cd /usr/local/nginx/</span><br><span class="line">[root@localhost nginx]# ll sbin</span><br><span class="line">总用量 3740</span><br><span class="line">-rwxr-xr-x. 1 root root 3826240 10月  9 00:43 nginx</span><br><span class="line">[root@localhost nginx]# ll conf/</span><br><span class="line">总用量 68</span><br><span class="line">-rw-r--r--. 1 root root 1077 10月  9 00:43 fastcgi.conf</span><br><span class="line">-rw-r--r--. 1 root root 1077 10月  9 00:43 fastcgi.conf.default</span><br><span class="line">-rw-r--r--. 1 root root 1007 10月  9 00:43 fastcgi_params</span><br><span class="line">-rw-r--r--. 1 root root 1007 10月  9 00:43 fastcgi_params.default</span><br><span class="line">-rw-r--r--. 1 root root 2837 10月  9 00:43 koi-utf</span><br><span class="line">-rw-r--r--. 1 root root 2223 10月  9 00:43 koi-win</span><br><span class="line">-rw-r--r--. 1 root root 5231 10月  9 00:43 mime.types</span><br><span class="line">-rw-r--r--. 1 root root 5231 10月  9 00:43 mime.types.default</span><br><span class="line">-rw-r--r--. 1 root root 2656 10月  9 00:43 nginx.conf</span><br><span class="line">-rw-r--r--. 1 root root 2656 10月  9 00:43 nginx.conf.default</span><br><span class="line">-rw-r--r--. 1 root root  636 10月  9 00:43 scgi_params</span><br><span class="line">-rw-r--r--. 1 root root  636 10月  9 00:43 scgi_params.default</span><br><span class="line">-rw-r--r--. 1 root root  664 10月  9 00:43 uwsgi_params</span><br><span class="line">-rw-r--r--. 1 root root  664 10月  9 00:43 uwsgi_params.default</span><br><span class="line">-rw-r--r--. 1 root root 3610 10月  9 00:43 win-utf</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>配置文件位置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost conf]# pwd</span><br><span class="line">/usr/local/nginx/conf</span><br><span class="line">[root@localhost conf]# ls |grep nginx.conf</span><br><span class="line">nginx.conf</span><br><span class="line">nginx.conf.default</span><br></pre></td></tr></table></figure>

<h2 id="开放80端口"><a href="#开放80端口" class="headerlink" title="开放80端口"></a>开放80端口</h2><p>对于CentOS7：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看开放的端口号</span></span><br><span class="line">firewall-cmd --list-all</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置开放的端口号</span></span><br><span class="line">firewall-cmd --add-service=http --permanent</span><br><span class="line">firewall-cmd --add-port=80/tcp --permanent</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启防火墙</span></span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<p>示例：开放端口</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost local]# firewall-cmd --list-all</span><br><span class="line">public (active)</span><br><span class="line">  target: default</span><br><span class="line">  icmp-block-inversion: no</span><br><span class="line">  interfaces: ens33</span><br><span class="line">  sources:</span><br><span class="line">  services: dhcpv6-client ssh</span><br><span class="line">  ports:</span><br><span class="line">  protocols:</span><br><span class="line">  masquerade: no</span><br><span class="line">  forward-ports:</span><br><span class="line">  source-ports:</span><br><span class="line">  icmp-blocks:</span><br><span class="line">  rich rules:</span><br><span class="line">[root@localhost local]# firewall-cmd --add-service=http --permanent</span><br><span class="line">success</span><br><span class="line">[root@localhost local]# firewall-cmd --add-port=80/tcp --permanent</span><br><span class="line">success</span><br><span class="line">[root@localhost local]# firewall-cmd --reload</span><br><span class="line">success</span><br><span class="line">[root@localhost local]# firewall-cmd --list-all</span><br><span class="line">public (active)</span><br><span class="line">  target: default</span><br><span class="line">  icmp-block-inversion: no</span><br><span class="line">  interfaces: ens33</span><br><span class="line">  sources:</span><br><span class="line">  services: dhcpv6-client http ssh</span><br><span class="line">  ports: 80/tcp</span><br><span class="line">  protocols:</span><br><span class="line">  masquerade: no</span><br><span class="line">  forward-ports:</span><br><span class="line">  source-ports:</span><br><span class="line">  icmp-blocks:</span><br><span class="line">  rich rules:</span><br><span class="line">[root@localhost local]#</span><br></pre></td></tr></table></figure>

<h2 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h2><h3 id="临时修改"><a href="#临时修改" class="headerlink" title="临时修改"></a>临时修改</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost conf]# export PATH=$PATH:/usr/local/nginx/sbin</span><br><span class="line">[root@localhost conf]# nginx -v</span><br><span class="line">nginx version: nginx/1.16.1</span><br></pre></td></tr></table></figure>

<h3 id="永久修改"><a href="#永久修改" class="headerlink" title="永久修改"></a>永久修改</h3><p>修改 &#x2F;etc&#x2F;profile文件</p>
<p>source &#x2F;etc&#x2F;profile</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim /etc/profile</span><br><span class="line">......</span><br><span class="line">unset i</span><br><span class="line">unset -f pathmunge</span><br><span class="line"></span><br><span class="line">export NGINX_HOME=/usr/local/nginx</span><br><span class="line">export PATH=$&#123;NGINX_HOME&#125;/sbin:$&#123;PATH&#125;</span><br><span class="line">[root@localhost ~]# source /etc/profile</span><br><span class="line">[root@localhost ~]# echo $PATH</span><br><span class="line">/usr/local/nginx/sbin:/usr/local/nginx/sbin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin</span><br><span class="line">[root@localhost ~]# nginx -s reload</span><br></pre></td></tr></table></figure>

<h2 id="Nginx服务自启动"><a href="#Nginx服务自启动" class="headerlink" title="Nginx服务自启动"></a>Nginx服务自启动</h2><p>CentOS7中：</p>
<p>​		1. 关闭 nginx 进程 </p>
<p>​		2. 在 &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F; 目录下，创建nginx.service文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# cd /usr/lib/systemd/system</span><br><span class="line">[root@localhost system]# vim nginx.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=nginx service</span><br><span class="line">After=network.target </span><br><span class="line"> </span><br><span class="line">[Service] </span><br><span class="line">Type=forking</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">路径对应安装路径</span></span><br><span class="line">ExecStart=/usr/local/nginx/sbin/nginx</span><br><span class="line">ExecReload=/usr/local/nginx/sbin/nginx -s reload</span><br><span class="line">ExecStop=/usr/local/nginx/sbin/nginx -s quit</span><br><span class="line">PrivateTmp=true </span><br><span class="line"> </span><br><span class="line">[Install] </span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">必须重新加载</span></span><br><span class="line">[root@localhost ~]# systemctl daemon-reload</span><br><span class="line">[root@localhost system]# systemctl start nginx</span><br><span class="line">[root@localhost system]# systemctl status nginx</span><br><span class="line">● nginx.service - nginx</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/nginx.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since 一 2022-04-25 19:59:11 CST; 9s ago</span><br><span class="line">  Process: 3922 ExecStart=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf (code=exited, status=0/SUCCESS)</span><br><span class="line"> Main PID: 3925 (nginx)</span><br><span class="line">    Tasks: 2</span><br><span class="line">   CGroup: /system.slice/nginx.service</span><br><span class="line">           ├─3925 nginx: master process /usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf</span><br><span class="line">           └─3926 nginx: worker process</span><br><span class="line"></span><br><span class="line">4月 25 19:59:11 localhost.localdomain systemd[1]: Starting nginx...</span><br><span class="line">4月 25 19:59:11 localhost.localdomain systemd[1]: Started nginx.</span><br></pre></td></tr></table></figure>



<h1 id="Nginx-常用命令"><a href="#Nginx-常用命令" class="headerlink" title="Nginx 常用命令"></a>Nginx 常用命令</h1><p>查看版本：.&#x2F;nginx -v</p>
<p>启动：.&#x2F;nginx</p>
<p>重载配置文件：.&#x2F;nginx -s reload</p>
<p>停止：.&#x2F;nginx -s stop</p>
<p>特定配置文件启动 nginx：.&#x2F;nginx  -c  path  &#x2F;nginx.conf</p>
<p>测试当前配置文件是否正确：.&#x2F;nginx -t</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost sbin]# pwd</span><br><span class="line">/usr/local/nginx/sbin</span><br><span class="line">[root@localhost sbin]# ./nginx -v</span><br><span class="line">nginx version: nginx/1.6.2</span><br><span class="line">[root@localhost sbin]# ./nginx</span><br><span class="line">[root@localhost sbin]# ps -ef|grep nginx</span><br><span class="line">root      64001      1  0 17:43 ?        00:00:00 nginx: master process ./nginx</span><br><span class="line">nobody    64002  64001  0 17:43 ?        00:00:00 nginx: worker process</span><br><span class="line">root      64004  56888  0 17:43 pts/0    00:00:00 grep --color=auto nginx</span><br><span class="line">[root@localhost sbin]# ./nginx -s reload</span><br><span class="line">[root@localhost sbin]# ./nginx -s stop</span><br></pre></td></tr></table></figure>

<p><strong>注意：nginx会启动两个进程</strong></p>
<h1 id="ngin配置文件"><a href="#ngin配置文件" class="headerlink" title="ngin配置文件"></a>ngin配置文件</h1><h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost conf]# cat -n nginx.conf</span><br><span class="line">     1</span><br><span class="line">     2  #user  nobody;</span><br><span class="line">     3  worker_processes  1;</span><br><span class="line">     4</span><br><span class="line">     5  #error_log  logs/error.log;</span><br><span class="line">     6  #error_log  logs/error.log  notice;</span><br><span class="line">     7  #error_log  logs/error.log  info;</span><br><span class="line">     8</span><br><span class="line">     9  #pid        logs/nginx.pid;</span><br><span class="line">    11</span><br><span class="line">    12  events &#123;</span><br><span class="line">    13      worker_connections  1024;</span><br><span class="line">    14  &#125;</span><br><span class="line">    15</span><br><span class="line">    17  http &#123;</span><br><span class="line">    18      include       mime.types;</span><br><span class="line">    19      default_type  application/octet-stream;</span><br><span class="line">    20</span><br><span class="line">    21      #log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">    22      #                  &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">    23      #                  &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line">    24</span><br><span class="line">    25      #access_log  logs/access.log  main;</span><br><span class="line">    26</span><br><span class="line">    27      sendfile        on;</span><br><span class="line">    28      #tcp_nopush     on;</span><br><span class="line">    29</span><br><span class="line">    30      #keepalive_timeout  0;</span><br><span class="line">    31      keepalive_timeout  65;</span><br><span class="line">    32</span><br><span class="line">    33      #gzip  on;</span><br><span class="line">    34</span><br><span class="line">    35      server &#123;</span><br><span class="line">    36          listen       80;</span><br><span class="line">    37          server_name  localhost;</span><br><span class="line">    38</span><br><span class="line">    39          #charset koi8-r;</span><br><span class="line">    40</span><br><span class="line">    41          #access_log  logs/host.access.log  main;</span><br><span class="line">    42</span><br><span class="line">    43          location / &#123;</span><br><span class="line">    44              root   html;</span><br><span class="line">    45              index  index.html index.htm;</span><br><span class="line">    46          &#125;</span><br><span class="line">    47</span><br><span class="line">    48          #error_page  404              /404.html;</span><br><span class="line">    49</span><br><span class="line">    50          # redirect server error pages to the static page /50x.html</span><br><span class="line">    51          #</span><br><span class="line">    52          error_page   500 502 503 504  /50x.html;</span><br><span class="line">    53          location = /50x.html &#123;</span><br><span class="line">    54              root   html;</span><br><span class="line">    55          &#125;</span><br><span class="line">    56</span><br><span class="line">    57          # proxy the PHP scripts to Apache listening on 127.0.0.1:80</span><br><span class="line">    58          #</span><br><span class="line">    59          #location ~ \.php$ &#123;</span><br><span class="line">    60          #    proxy_pass   http://127.0.0.1;</span><br><span class="line">    61          #&#125;</span><br><span class="line">    62</span><br><span class="line">    63          # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span><br><span class="line">    64          #</span><br><span class="line">    65          #location ~ \.php$ &#123;</span><br><span class="line">    66          #    root           html;</span><br><span class="line">    67          #    fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">    68          #    fastcgi_index  index.php;</span><br><span class="line">    69          #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span><br><span class="line">    70          #    include        fastcgi_params;</span><br><span class="line">    71          #&#125;</span><br><span class="line">    72</span><br><span class="line">    73          # deny access to .htaccess files, if Apache&#x27;s document root</span><br><span class="line">    74          # concurs with nginx&#x27;s one</span><br><span class="line">    75          #</span><br><span class="line">    76          #location ~ /\.ht &#123;</span><br><span class="line">    77          #    deny  all;</span><br><span class="line">    78          #&#125;</span><br><span class="line">    79      &#125;</span><br><span class="line">    81</span><br><span class="line">    82      # another virtual host using mix of IP-, name-, and port-based configuration</span><br><span class="line">    83      #</span><br><span class="line">    84      #server &#123;</span><br><span class="line">    85      #    listen       8000;</span><br><span class="line">    86      #    listen       somename:8080;</span><br><span class="line">    87      #    server_name  somename  alias  another.alias;</span><br><span class="line">    88</span><br><span class="line">    89      #    location / &#123;</span><br><span class="line">    90      #        root   html;</span><br><span class="line">    91      #        index  index.html index.htm;</span><br><span class="line">    92      #    &#125;</span><br><span class="line">    93      #&#125;</span><br><span class="line">    94</span><br><span class="line">    96      # HTTPS server</span><br><span class="line">    97      #</span><br><span class="line">    98      #server &#123;</span><br><span class="line">    99      #    listen       443 ssl;</span><br><span class="line">   100      #    server_name  localhost;</span><br><span class="line">   101</span><br><span class="line">   102      #    ssl_certificate      cert.pem;</span><br><span class="line">   103      #    ssl_certificate_key  cert.key;</span><br><span class="line">   104</span><br><span class="line">   105      #    ssl_session_cache    shared:SSL:1m;</span><br><span class="line">   106      #    ssl_session_timeout  5m;</span><br><span class="line">   107</span><br><span class="line">   108      #    ssl_ciphers  HIGH:!aNULL:!MD5;</span><br><span class="line">   109      #    ssl_prefer_server_ciphers  on;</span><br><span class="line">   110</span><br><span class="line">   111      #    location / &#123;</span><br><span class="line">   112      #        root   html;</span><br><span class="line">   113      #        index  index.html index.htm;</span><br><span class="line">   114      #    &#125;</span><br><span class="line">   115      #&#125;</span><br><span class="line">   116</span><br><span class="line">   117  &#125;</span><br></pre></td></tr></table></figure>

<p>配置文件说明：</p>
<p>​		可以将 nginx.conf 配置文件分为三部分。</p>
<h2 id="第一部分：全局块"><a href="#第一部分：全局块" class="headerlink" title="第一部分：全局块"></a>第一部分：全局块</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">3  worker_processes  1;</span><br></pre></td></tr></table></figure>

<p>​	从配置文件开始到 events 块之间的内容，主要会设置一些影响 nginx 服务器整体运行的配置指令，主要包括配置运行 Nginx 服务器的用户（组）、允许生成的 worker process 数，进程 PID 存放路径、日志存放路径和类型以及配置文件的引入等。</p>
<p>​		这是 Nginx 服务器并发处理服务的关键配置，worker_processes 值越大，可以支持的并发处理量也越多，但是会受到硬件、软件等设备的制约。</p>
<h2 id="第二部分：events-块"><a href="#第二部分：events-块" class="headerlink" title="第二部分：events 块"></a>第二部分：events 块</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">12  events &#123;</span><br><span class="line">13      worker_connections  1024;</span><br><span class="line">14  &#125;</span><br></pre></td></tr></table></figure>

<p>​		events 块涉及的指令主要影响 Nginx 服务器与用户的网络连接，常用的设置包括是否开启对多 work process 下的网络连接进行序列化，是否允许同时接收多个网络连接，选取哪种事件驱动模型来处理连接请求，每个 word process 可以同时支持的最大连接数等。 上述例子就表示每个 work process 支持的最大连接数为 1024。这部分的配置对 Nginx 的性能影响较大，在实际中应该灵活配置。</p>
<h2 id="第三部分：http块"><a href="#第三部分：http块" class="headerlink" title="第三部分：http块"></a>第三部分：http块</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">17  http &#123;</span><br><span class="line">18      include       mime.types;</span><br><span class="line">19      default_type  application/octet-stream;</span><br><span class="line">21      #log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">22      #                  &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">23      #                  &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line">25      #access_log  logs/access.log  main;</span><br><span class="line">27      sendfile        on;</span><br><span class="line">28      #tcp_nopush     on;</span><br><span class="line">30      #keepalive_timeout  0;</span><br><span class="line">31      keepalive_timeout  65;</span><br><span class="line">33      #gzip  on;</span><br><span class="line">35      server &#123;</span><br><span class="line">36          listen       80;</span><br><span class="line">37          server_name  localhost;</span><br><span class="line">39          #charset koi8-r;</span><br><span class="line">41          #access_log  logs/host.access.log  main;</span><br><span class="line">43          location / &#123;</span><br><span class="line">44              root   html;</span><br><span class="line">45              index  index.html index.htm;</span><br><span class="line">46          &#125;</span><br></pre></td></tr></table></figure>

<p>​		该部分是Nginx 服务器配置中最频繁的部分，代理、缓存和日志定义等绝大多数功能和第三方模块的配置都在这里。 需要注意的是：http 块也可以包括 http 全局块、server 块。</p>
<h3 id="http-全局块"><a href="#http-全局块" class="headerlink" title="http 全局块"></a>http 全局块</h3><p>​		http 全局块配置的指令包括文件引入、MIME-TYPE 定义、日志自定义、连接超时时间、单链接请求数上限等。</p>
<h3 id="server-块"><a href="#server-块" class="headerlink" title="server 块"></a>server 块</h3><p>​		这块和虚拟主机有密切关系，虚拟主机从用户角度看，和一台独立的硬件主机是完全一样的，该技术的产生是为了 节省互联网服务器硬件成本。 <strong>每个 http 块可以包括多个 server 块，而每个 server 块就相当于一个虚拟主机。</strong> 而每个 server 块也分为全局 server 块，以及可以同时包含多个 location 块。</p>
<ol>
<li><p>全局 server 块：最常见的配置是本虚拟机主机的监听配置和本虚拟主机的名称或 IP 配置。</p>
</li>
<li><p>location 块：一个 server 块可以配置多个 location 块。 这块的主要作用是基于 Nginx 服务器接收到的请求字符串（例如 server_name&#x2F;uri-string），对虚拟主机名称 （也可以是 IP 别名）之外的字符串（例如 前面的 &#x2F;uri-string）进行匹配，对特定的请求进行处理。地址定向、数据缓 存和应答控制等功能，还有许多第三方模块的配置也在这里进行。</p>
</li>
</ol>
<h1 id="配置实例"><a href="#配置实例" class="headerlink" title="配置实例"></a>配置实例</h1><h2 id="示例一：反向代理"><a href="#示例一：反向代理" class="headerlink" title="示例一：反向代理"></a>示例一：反向代理</h2><p>​		在浏览器地址栏输入地址 <strong><a target="_blank" rel="noopener" href="http://www.123.com/">www.123.com</a></strong>，跳转到 linux 系统 tomcat 主页。</p>
<p>第一步：修改 <a target="_blank" rel="noopener" href="http://www.123.com/">www.123.com</a> 和IP的映射关系</p>
<p>修改文件：C:\Windows\System32\drivers\etc\hosts，配置域名和IP的对应关系。</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.100.100		www.123.com</span><br></pre></td></tr></table></figure>

<p>第二步：配置 server 块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">35     server &#123;</span><br><span class="line">36         listen       80;</span><br><span class="line">		   # 修改地址</span><br><span class="line">37         server_name  192.168.100.100;</span><br><span class="line">38</span><br><span class="line">39         #charset koi8-r;</span><br><span class="line">40</span><br><span class="line">41         #access_log  logs/host.access.log  main;</span><br><span class="line">43         location / &#123;</span><br><span class="line">44             root   html;</span><br><span class="line">			    # 添加 proxy_pass</span><br><span class="line">45             proxy_pass http://192.168.100.100:8080;</span><br><span class="line">46             index  index.html index.htm;</span><br><span class="line">47         &#125;</span><br></pre></td></tr></table></figure>

<p>第三步：配置 tomcat 环境变量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/profile</span><br><span class="line">export NGINX_HOME=/usr/local/nginx</span><br><span class="line">export TOMCAT_HOME=/opt/tomcat/apache-tomcat-8.5.78/bin</span><br><span class="line">export PATH=$&#123;NGINX_HOME&#125;/sbin:$&#123;TOMCAT_HOME&#125;:$&#123;PATH&#125;</span><br><span class="line"></span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>

<p>第四步：开放端口8080</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看开放的端口号</span></span><br><span class="line">firewall-cmd --list-all</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置开放的端口号</span></span><br><span class="line">firewall-cmd --add-service=http --permanent</span><br><span class="line">firewall-cmd --add-port=8080/tcp --permanent</span><br><span class="line">firewall-cmd --add-port=8081/tcp --permanent</span><br><span class="line">firewall-cmd --add-port=9001/tcp --permanent</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启防火墙</span></span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>



<p>启动tomcat，浏览器输入地址 <a target="_blank" rel="noopener" href="http://www.123.com/">www.123.com</a> 进行测试。</p>
<p><img src="/2023/03/15/Nginx/Java\Document\Nginx\Nginx.assets\image-20220425200236256.png" alt="image-tomcat主页面"></p>
<p>第四步：查看tomcat日志文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tail -f logs/catalina.out</span><br></pre></td></tr></table></figure>

<h2 id="示例二：反向代理"><a href="#示例二：反向代理" class="headerlink" title="示例二：反向代理"></a>示例二：反向代理</h2><p>​		使用 nginx 反向代理，根据访问的路径跳转到不同端口的服务中 nginx 监听端口为 9001。</p>
<p>​		访问 <a target="_blank" rel="noopener" href="http://192.168.100.100:9001/edu/">http://192.168.100.100:9001/edu/</a> 直接跳转到 192.168.100.100:8080 </p>
<p>​		访问 http:&#x2F;&#x2F; 192.168.100.100:9001&#x2F;vod&#x2F; 直接跳转到 192.168.100.100:8081</p>
<p>第一步：准备两个tomcat，端口分别为 8080 和 8081。</p>
<p><strong>【注意】启动两个 Tomcat 时，直接在 tomcat&#x2F;bin 目录启动，如果配置了 Tomcat 的环境变量，应该配置多个，要么就不配。</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost tomcat]# pwd</span><br><span class="line">/opt/tomcat</span><br><span class="line">[root@localhost tomcat]# mkdir tomcat8081</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注意拷贝多级目录时需要加递归参数 -r，否则不生效，提示：<span class="built_in">cp</span>: 略过目录<span class="string">&quot;apache-tomcat-8.5.70&quot;</span></span></span><br><span class="line">[root@localhost tomcat]# cp -r apache-tomcat-8.5.78/. tomcat8081/</span><br><span class="line">[root@localhost tomcat]# vim tomcat8081/conf/server.xml</span><br><span class="line"> ......</span><br><span class="line"><span class="meta prompt_"> # </span><span class="language-bash">修改8005</span></span><br><span class="line"> 22 &lt;Server port=&quot;8015&quot; shutdown=&quot;SHUTDOWN&quot;&gt;</span><br><span class="line"> 23   &lt;Listener className=&quot;org.apache.catalina.startup.VersionLoggerListener&quot; /&gt;</span><br><span class="line"><span class="meta prompt_"> # </span><span class="language-bash">修改8081以及8443</span></span><br><span class="line"> 69     &lt;Connector port=&quot;8081&quot; protocol=&quot;HTTP/1.1&quot;</span><br><span class="line"> 70                connectionTimeout=&quot;20000&quot;</span><br><span class="line"> 71                redirectPort=&quot;8444&quot; /&gt;</span><br><span class="line"> ......</span><br></pre></td></tr></table></figure>

<p>第二步：测试页面 test.html</p>
<p>cd 	&#x2F;opt&#x2F;tomcat&#x2F;apache-tomcat-8.5.78&#x2F;webapps&#x2F;edu</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span></span><br><span class="line">    tomcat 8080</span><br><span class="line"><span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>cd 	&#x2F;opt&#x2F;tomcat&#x2F;tomcat8081&#x2F;webapps&#x2F;vod</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span></span><br><span class="line">    tomcat 8081</span><br><span class="line"><span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>将测试页面分别放在 webapps 下面的某一个具体目录，如果直接放在 webapps 下是不会访问的（404）。</strong></p>
<p>第三步：配置Nginx</p>
<p>可以配置多个 server 块。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">85     server &#123;</span><br><span class="line">86         listen       9001;</span><br><span class="line">87         # server_name:主机名，hostname</span><br><span class="line">88         server_name  192.168.100.100;</span><br><span class="line">89</span><br><span class="line">90         location ~ /edu/ &#123;</span><br><span class="line">91                 proxy_pass http://192.168.100.100:8080;</span><br><span class="line">93         &#125;</span><br><span class="line">94</span><br><span class="line">95         location ~ /vod/ &#123;</span><br><span class="line">96                 proxy_pass http://192.168.100.100:8081;</span><br><span class="line">97         &#125;</span><br><span class="line">98     &#125;</span><br></pre></td></tr></table></figure>

<p>如果未启动 tomcat，则会报错：502 Bad GateWay</p>
<p>第四步：启动 nginx 和 tomcat 测试</p>
<p>​		<a target="_blank" rel="noopener" href="http://192.168.100.100:9001/vod/test.html">http://192.168.100.100:9001/vod/test.html</a></p>
<p>​		<a target="_blank" rel="noopener" href="http://192.168.100.100:9001/edu/test.html">http://192.168.100.100:9001/edu/test.html</a></p>
<h2 id="示例三：负载均衡"><a href="#示例三：负载均衡" class="headerlink" title="示例三：负载均衡"></a>示例三：负载均衡</h2><p>​		浏览器地址栏输入地址 <a target="_blank" rel="noopener" href="http://192.168.100.100edu/test.html%EF%BC%8C%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%95%88%E6%9E%9C%EF%BC%8C%E5%B9%B3%E5%9D%87">http://192.168.100.100edu/test.html，负载均衡效果，平均</a> 8080 和 8081 端口中。</p>
<p>第一步：在两个tomcat中创建edu目录，放入test.html</p>
<p>第二步：在 nginx.conf 中的 http 块进行负载均衡配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">34     # 负载均衡配置</span><br><span class="line">35     upstream myserver&#123;</span><br><span class="line">36         server  192.168.100.100:8080;</span><br><span class="line">37         server  192.168.100.100:8081;</span><br><span class="line">38     &#125;</span><br><span class="line">39</span><br><span class="line">40     server &#123;</span><br><span class="line">41         listen       80;</span><br><span class="line">42         server_name  192.168.100.100;</span><br><span class="line">43</span><br><span class="line">44         #charset koi8-r;</span><br><span class="line">45</span><br><span class="line">46         #access_log  logs/host.access.log  main;</span><br><span class="line">47</span><br><span class="line">48         location / &#123;</span><br><span class="line">49             root   html;</span><br><span class="line">50             proxy_pass http://myserver;</span><br><span class="line">51             index  index.html index.htm;</span><br><span class="line">52         &#125;</span><br></pre></td></tr></table></figure>

<p>第三步：测试 <a target="_blank" rel="noopener" href="http://192.168.100.100/edu/test.html">http://192.168.100.100/edu/test.html</a></p>
<h2 id="nginx-分配服务器策略"><a href="#nginx-分配服务器策略" class="headerlink" title="nginx 分配服务器策略"></a>nginx 分配服务器策略</h2><p>第一种 轮询（默认） </p>
<p>​		每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器 down 掉，能自动剔除。</p>
<p>第二种</p>
<p>​		weight weight 代表权重默认为 1，权重越高被分配的客户端越多</p>
<p>第三种</p>
<p>​		ip_hash 每个请求按访问 ip 的 hash 结果分配，这样每个访客固定访问一个后端服务器</p>
<p>第四种</p>
<p>​		fair（第三方） 按后端服务器的响应时间来分配请求，响应时间短的优先分配。</p>
<h2 id="示例四：动静分离"><a href="#示例四：动静分离" class="headerlink" title="示例四：动静分离"></a>示例四：动静分离</h2><p>​		通过 location 指定不同的后缀名实现不同的请求转发。通过 expires 参数设置，可以使浏览器缓存过期时间，减少与服务器之前的请求和流量。</p>
<p>​		具体 Expires 定义：是给一个资源设定一个过期时间，也就是说无需去服务端验证，直接通过浏览器自身确认是否过期即可， 所以不会产生额外的流量。此种方法非常适合不经常变动的资源。（如果经常更新的文件， 不建议使用 Expires 来缓存），我这里设置 3d，表示在这 3 天之内访问这个 URL，发送一 个请求，比对服务器该文件最后更新时间没有变化，则不会从服务器抓取，返回状态码 304， 如果有修改，则直接从服务器重新下载，返回状态码 200。</p>
<p>第一步：在 &#x2F;opt&#x2F;nginxData 目录下准备两个文件夹 image 和 www，分别存储静态资源</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost tomcat]# cd /opt/</span><br><span class="line">[root@localhost opt]# mkdir nginxData</span><br><span class="line">[root@localhost opt]# cd nginxData/</span><br><span class="line">[root@localhost nginxData]# mkdir image www</span><br><span class="line">[root@localhost nginxData]# ls</span><br><span class="line">image  www</span><br></pre></td></tr></table></figure>

<p>第二步：配置 nginx.conf，并重新加载配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">40     server &#123;</span><br><span class="line">41         listen       80;</span><br><span class="line">42         server_name  192.168.100.100;</span><br><span class="line">43</span><br><span class="line">44         #charset koi8-r;</span><br><span class="line">45</span><br><span class="line">46         #access_log  logs/host.access.log  main;</span><br><span class="line">47         location /image/&#123;</span><br><span class="line">48            root /opt/nginxData/;</span><br><span class="line">			  # 在页面以列表的形式列出文件</span><br><span class="line">49            autoindex  on;</span><br><span class="line">50         &#125;</span><br><span class="line">51</span><br><span class="line">52         location /www/&#123;</span><br><span class="line">53            root /opt/nginxData/;</span><br><span class="line">54            index index.html index.htm;</span><br><span class="line">55         &#125;</span><br></pre></td></tr></table></figure>

<p>第三步：测试</p>
<p>​		<a target="_blank" rel="noopener" href="http://192.168.100.100/image/girl01.webp">http://192.168.100.100/image/girl01.webp</a></p>
<p>​		<a target="_blank" rel="noopener" href="http://192.168.100.100/www/test.html">http://192.168.100.100/www/test.html</a></p>
<p><img src="/2023/03/15/Nginx/Java\Document\Nginx\Nginx.assets\image-20220425220015488.png" alt="image-autoindex"></p>
<h1 id="配置高可用集群"><a href="#配置高可用集群" class="headerlink" title="配置高可用集群"></a>配置高可用集群</h1><h2 id="基本介绍"><a href="#基本介绍" class="headerlink" title="基本介绍"></a>基本介绍</h2><p><img src="/2023/03/15/Nginx/Java\Document\Nginx\Nginx.assets\image-20220425220609428.png" alt="image-nginx高可用集群"></p>
<h2 id="高可用配置"><a href="#高可用配置" class="headerlink" title="高可用配置"></a>高可用配置</h2><h3 id="第一步：克隆当前虚拟机"><a href="#第一步：克隆当前虚拟机" class="headerlink" title="第一步：克隆当前虚拟机"></a>第一步：克隆当前虚拟机</h3><p>​		注意克隆后网卡丢失的情况</p>
<h3 id="第二步：安装-keepalived"><a href="#第二步：安装-keepalived" class="headerlink" title="第二步：安装 keepalived"></a>第二步：安装 keepalived</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# yum install keepalived –y</span><br><span class="line">......</span><br><span class="line">[root@centos7-slaver ~]# ls /etc|grep keepalived</span><br><span class="line">keepalived</span><br></pre></td></tr></table></figure>

<p>安装完成后会在 &#x2F;etc 目录下生成 keepalived 目录</p>
<h3 id="第三步：配置-keepalived-conf"><a href="#第三步：配置-keepalived-conf" class="headerlink" title="第三步：配置 keepalived.conf"></a>第三步：配置 keepalived.conf</h3><p>​		备份 &#x2F;etc&#x2F;keepalived&#x2F;keepalivec.conf 配置文件，使用下面的文件替换</p>
<p>​	注意：</p>
<blockquote>
<ol>
<li><p>虚拟IP地址 virtual_ipaddress 需要和主机在同一网段。</p>
<pre><code>               2. global_defs 中 smtp_server 为主机地址 192.168.100.100
               3. 检测脚本的位置：script &quot;/usr/local/src/nginx_check.sh&quot;
               4. 从机只需要修改 state BACKUP
</code></pre>
</li>
</ol>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">global_defs &#123;</span><br><span class="line">	notification_email &#123;</span><br><span class="line">		acassen@firewall.loc</span><br><span class="line">		failover@firewall.loc</span><br><span class="line">		sysadmin@firewall.loc</span><br><span class="line">	&#125;</span><br><span class="line">	notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">	smtp_server 192.168.100.100</span><br><span class="line">	smtp_connect_timeout 30</span><br><span class="line">	router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_http_port &#123;</span><br><span class="line">	script &quot;/usr/local/src/nginx_check.sh&quot;</span><br><span class="line">	interval 2 #（检测脚本执行的间隔）</span><br><span class="line">	weight 2</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">	state MASTER # 备份服务器上将 MASTER 改为 BACKUP</span><br><span class="line">	interface ens33 # 网卡</span><br><span class="line">	virtual_router_id 51 # 主、备机的 virtual_router_id 必须相同</span><br><span class="line">	priority 90 # 主、备机取不同的优先级，主机值较大，备份机值较小</span><br><span class="line">	advert_int 1</span><br><span class="line">	authentication &#123;</span><br><span class="line">		auth_type PASS</span><br><span class="line">		auth_pass 1111</span><br><span class="line">	&#125;</span><br><span class="line">	virtual_ipaddress &#123;</span><br><span class="line">		192.168.100.50 # VRRP H 虚拟地址</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="第四步：新建检测脚本-nginx-check-sh"><a href="#第四步：新建检测脚本-nginx-check-sh" class="headerlink" title="第四步：新建检测脚本 nginx_check.sh"></a>第四步：新建检测脚本 nginx_check.sh</h3><p>​		在 &#x2F;usr&#x2F;local&#x2F;src 下创建检测脚本 nginx_check.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">A=`ps -C nginx --no-header |wc -l`</span><br><span class="line">if [ $A -eq 0 ];then</span><br><span class="line">        /usr/local/nginx/sbin/nginx</span><br><span class="line">        sleep 2</span><br><span class="line">        if [ `ps -C nginx --no-header |wc -l` -eq 0 ];then</span><br><span class="line">                killall keepalived</span><br><span class="line">        fi</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<h3 id="第五步：启动-nginx-和-keepalived"><a href="#第五步：启动-nginx-和-keepalived" class="headerlink" title="第五步：启动 nginx 和 keepalived"></a>第五步：启动 nginx 和 keepalived</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost keepalived]# nginx</span><br><span class="line">[root@localhost keepalived]# systemctl start keepalived.service</span><br></pre></td></tr></table></figure>

<p>查看绑定到ens33的虚拟IP：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost keepalived]# ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:50:56:3b:fb:0d brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.100.100/24 brd 192.168.100.255 scope global ens33</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       # ======192.168.100.50绑定在ens33上面=======</span><br><span class="line">    inet 192.168.100.50/32 scope global ens33</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::250:56ff:fe3b:fb0d/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default qlen 1000</span><br><span class="line">    link/ether 52:54:00:16:52:0a brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc pfifo_fast master virbr0 state DOWN group default qlen 1000</span><br><span class="line">    link/ether 52:54:00:16:52:0a brd ff:ff:ff:ff:ff:ff</span><br><span class="line">[root@localhost keepalived]#</span><br></pre></td></tr></table></figure>

<h3 id="第六步：测试"><a href="#第六步：测试" class="headerlink" title="第六步：测试"></a>第六步：测试</h3><p>​		在浏览器地址栏输入虚拟IP：192.168.100.50</p>
<p>​		停止192.168.100.100的nginx，页面依然能够访问</p>
<h2 id="nginx-原理与优化参数配置"><a href="#nginx-原理与优化参数配置" class="headerlink" title="nginx 原理与优化参数配置"></a>nginx 原理与优化参数配置</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p><img src="/2023/03/15/Nginx/Java\Document\Nginx\Nginx.assets\image-20220426101753602.png" alt="image-master-worker"></p>
<p><img src="/2023/03/15/Nginx/Java\Document\Nginx\Nginx.assets\image-20220426101823774.png" alt="image-nginx争抢机制"></p>
<p>master-workers 的机制的好处</p>
<p>​		首先，对于每个 worker 进程来说，独立的进程，不需要加锁，所以省掉了锁带来的开销， 同时在编程以及问题查找时，也会方便很多。</p>
<p>​		其次，采用独立的进程，可以让互相之间不会 影响，一个进程退出后，其它进程还在工作，服务不会中断，master 进程则很快启动新的 worker 进程。当然，worker 进程的异常退出，肯定是程序有 bug 了，异常退出，会导致当前 worker 上的所有请求失败，不过不会影响到所有请求，所以降低了风险。</p>
<p>需要设置多少个 worker</p>
<p>​		<strong>Nginx 同 redis 类似都采用了 io 多路复用机制</strong>【Linux支持IO多路复用，window无法发挥IO多路复用的功能】，每个 worker 都是一个独立的进程，但每个进 程里只有一个主线程，通过异步非阻塞的方式来处理请求， 即使是千上万个请求也不在话 下。每个 worker 的线程可以把一个 cpu 的性能发挥到极致。所以 worker 数和服务器的 cpu 数相等是最为适宜的。设少了会浪费 cpu，设多了会造成 cpu 频繁切换上下文带来的损耗。</p>
<p>设置 worker 数量</p>
<p>​		worker_processes 4 #work 绑定 cpu(4 work 绑定 4cpu)。 worker_cpu_affinity 0001 0010 0100 1000 #work 绑定 cpu (4 work 绑定 8cpu 中的 4 个) 。 worker_cpu_affinity 0000001 00000010 00000100 00001000</p>
<p>连接数 worker_connection </p>
<p>​		这个值是表示每个 worker 进程所能建立连接的最大值，所以，一个 nginx 能建立的最大连接 数，应该是 worker_connections * worker_processes。当然，这里说的是最大连接数，对于 HTTP 请 求 本 地 资 源 来 说 ， 能 够 支 持 的 最 大 并 发 数 量 是 worker_connections * worker_processes，如果是支持 http1.1 的浏览器每次访问要占两个连接，所以普通的静态访 问最大并发数是： worker_connections * worker_processes &#x2F;2，而如果是 HTTP 作 为反向代 理来说，最大并发数量应该是 worker_connections * worker_processes&#x2F;4。因为作为反向代理服务器，每个并发会建立与客户端的连接和与后端服 务的连接，会占用两个连接。</p>
<p><img src="/2023/03/15/Nginx/Java\Document\Nginx\Nginx.assets\image-20220426102041889.png" alt="image-nginx.conf结构"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/14/SpringBoot2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MineTing">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/14/SpringBoot2/" class="post-title-link" itemprop="url">SpringBoot</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-14 00:00:00" itemprop="dateCreated datePublished" datetime="2023-03-14T00:00:00+08:00">2023-03-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-22 16:30:01" itemprop="dateModified" datetime="2023-03-22T16:30:01+08:00">2023-03-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <div align="center"><font size="70"><b>SpringBoot2</b></font></div>

<blockquote>
<p>【Refer】</p>
<p>官网：<a target="_blank" rel="noopener" href="https://spring.io/">https://spring.io</a></p>
<p>文档在线地址：<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/index.html">https://docs.spring.io/spring-boot/docs/current/reference/html/index.html</a></p>
<p>文档下载地址：<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/">https://docs.spring.io/spring-boot/docs/current/reference/</a></p>
<p>WiKi：<a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-boot/wiki">https://github.com/spring-projects/spring-boot/wiki</a></p>
</blockquote>
<h1 id="SpringBoot-概述"><a href="#SpringBoot-概述" class="headerlink" title="SpringBoot 概述"></a>SpringBoot 概述</h1><blockquote>
<p>SpringBoot是整合Spring技术栈的一站式框架</p>
<p>SpringBoot是简化Spring技术栈的快速开发脚手架</p>
<p>Spring Boot helps you to create stand-alone, production-grade Spring-based applications that you can run. We take an opinionated view of the Spring platform and third-party libraries, so that you can get started with minimum fuss. Most Spring Boot applications need very little Spring configuration.</p>
<p>You can use Spring Boot to create Java applications that can be started by using <code>java -jar</code> or more traditional war deployments.</p>
<p>Our primary goals are:</p>
<ul>
<li>Provide a radically faster and widely accessible getting-started experience for all Spring development.</li>
<li>Be opinionated out of the box but get out of the way quickly as requirements start to diverge from the defaults.</li>
<li>Provide a range of non-functional features that are common to large classes of projects (such as embedded servers, security, metrics, health checks, and externalized configuration).</li>
<li>Absolutely no code generation (when not targeting native image) and no requirement for XML configuration.</li>
</ul>
</blockquote>
<h2 id="SpringBoot-优点"><a href="#SpringBoot-优点" class="headerlink" title="SpringBoot 优点"></a>SpringBoot 优点</h2><ul>
<li><p>Create stand-alone Spring applications</p>
<ul>
<li>创建独立Spring应用</li>
</ul>
</li>
<li><p>Embed Tomcat, Jetty or Undertow directly (no need to deploy WAR files)</p>
<ul>
<li>内嵌web服务器</li>
</ul>
</li>
<li><p>Provide opinionated ‘starter’ dependencies to simplify your build configuration</p>
<ul>
<li>自动starter依赖，简化构建配置</li>
</ul>
</li>
<li><p>Automatically configure Spring and 3rd party libraries whenever possible</p>
<ul>
<li>自动配置Spring以及第三方功能</li>
</ul>
</li>
<li><p>Provide production-ready features such as metrics, health checks, and externalized configuration</p>
<ul>
<li>提供生产级别的监控、健康检查及外部化配置</li>
</ul>
</li>
<li><p>Absolutely no code generation and no requirement for XML configuration</p>
<ul>
<li>无代码生成、无需编写XML</li>
</ul>
</li>
</ul>
<p>SpringBoot 是整合 Spring 技术栈的一站式框架，SpringBoot 是简化 Spring 技术栈的快速开发脚手架</p>
<h2 id="SpringBoot缺点"><a href="#SpringBoot缺点" class="headerlink" title="SpringBoot缺点"></a>SpringBoot缺点</h2><ul>
<li>迭代快，需要时刻关注变化</li>
<li>内部原理复杂，不容易精通</li>
</ul>
<h2 id="System-Requirements"><a href="#System-Requirements" class="headerlink" title="System Requirements"></a>System Requirements</h2><p>Spring Boot 3.0.4 requires <a target="_blank" rel="noopener" href="https://www.java.com/">Java 17</a> and is compatible up to and including Java 19. <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/6.0.6/reference/html/">Spring Framework 6.0.6</a> or above is also required.</p>
<p>Explicit build support is provided for the following build tools:</p>
<table>
<thead>
<tr>
<th align="left">Build Tool</th>
<th align="left">Version</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Maven</td>
<td align="left">3.5+</td>
</tr>
<tr>
<td align="left">Gradle</td>
<td align="left">7.x (7.5 or later) and 8.x</td>
</tr>
</tbody></table>
<h3 id="Servlet-Containers"><a href="#Servlet-Containers" class="headerlink" title="Servlet Containers"></a>Servlet Containers</h3><p>Spring Boot supports the following embedded servlet containers:</p>
<table>
<thead>
<tr>
<th align="left">Name</th>
<th align="left">Servlet Version</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Tomcat 10.0</td>
<td align="left">5.0</td>
</tr>
<tr>
<td align="left">Jetty 11.0</td>
<td align="left">5.1</td>
</tr>
<tr>
<td align="left">Undertow 2.2 (Jakarta EE 9 variant)</td>
<td align="left">5.0</td>
</tr>
</tbody></table>
<p>You can also deploy Spring Boot applications to any servlet 5.0+ compatible container.</p>
<h3 id="GraalVM-Native-Images"><a href="#GraalVM-Native-Images" class="headerlink" title="GraalVM Native Images"></a>GraalVM Native Images</h3><p>Spring Boot applications can be <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/native-image.html#native-image.introducing-graalvm-native-images">converted into a Native Image</a> using GraalVM 22.3 or above.</p>
<p>Images can be created using the <a target="_blank" rel="noopener" href="https://github.com/graalvm/native-build-tools">native build tools</a> Gradle&#x2F;Maven plugins or <code>native-image</code> tool provided by GraalVM. You can also create native images using the <a target="_blank" rel="noopener" href="https://github.com/paketo-buildpacks/native-image">native-image Paketo buildpack</a>.</p>
<p>The following versions are supported:</p>
<table>
<thead>
<tr>
<th align="left">Name</th>
<th align="left">Version</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GraalVM Community</td>
<td align="left">22.3</td>
</tr>
<tr>
<td align="left">Native Build Tools</td>
<td align="left">0.9.20</td>
</tr>
</tbody></table>
<h2 id="What-Spring-can-do"><a href="#What-Spring-can-do" class="headerlink" title="What Spring can do"></a>What Spring can do</h2><p>![What Can Spring Do.png](SpringBoot2&#x2F;What Can Spring Do.png)</p>
<h2 id="Spring-生态"><a href="#Spring-生态" class="headerlink" title="Spring 生态"></a>Spring 生态</h2><ul>
<li>Spring Boot</li>
<li>Spring Framework</li>
<li>Spring Data</li>
<li>Spring Cloud</li>
<li>Spring Cloud Data Flow</li>
<li>Spring Security</li>
<li>Spring Authorization Server</li>
<li>Spring for GraphQL</li>
<li>Spring Session</li>
<li>Spring Integration</li>
<li>Spring HATEOAS</li>
<li>Spring REST Docs</li>
<li>Spring Batch</li>
<li>Spring AMQP</li>
<li>Spring CredHub</li>
<li>Spring Flo</li>
<li>Spring for Apache Kafka</li>
<li>Spring LDAP</li>
<li>Spring Shell</li>
<li>Spring Statemachine</li>
<li>Spring Vault</li>
<li>Spring Web Flow</li>
<li>Spring Web Services</li>
</ul>
<h1 id="时代背景"><a href="#时代背景" class="headerlink" title="时代背景"></a>时代背景</h1><h2 id="微服务简介"><a href="#微服务简介" class="headerlink" title="微服务简介"></a>微服务简介</h2><p><a target="_blank" rel="noopener" href="https://martinfowler.com/articles/microservices.html">James Lewis and Martin Fowler (2014)</a>  提出微服务完整概念。<a target="_blank" rel="noopener" href="https://martinfowler.com/microservices/">https://martinfowler.com/microservices/</a></p>
<p>In short, the <strong>microservice architectural style</strong> is an approach to developing a single application as a <strong>suite of small services</strong>, each <strong>running in its own process</strong> and communicating with <strong>lightweight</strong> mechanisms, often an <strong>HTTP</strong> resource API. These services are <strong>built around business capabilities</strong> and <strong>independently deployable</strong> by fully <strong>automated deployment</strong> machinery. There is a <strong>bare minimum of centralized management</strong> of these services, which may be <strong>written in different programming languages</strong> and use different data storage technologies.– <a target="_blank" rel="noopener" href="https://martinfowler.com/articles/microservices.html">James Lewis and Martin Fowler (2014)</a></p>
<ul>
<li>微服务是一种架构风格</li>
<li>一个应用拆分为一组小型服务</li>
<li>每个服务运行在自己的进程内，也就是可独立部署和升级</li>
<li>服务之间使用轻量级 HTTP 交互</li>
<li>服务围绕业务功能拆分</li>
<li>可以由全自动部署机制独立部署</li>
<li>去中心化，服务自治，服务可以使用不同的语言、不同的存储技术</li>
</ul>
<h2 id="分布式"><a href="#分布式" class="headerlink" title="分布式"></a>分布式</h2><h3 id="分布式的困难"><a href="#分布式的困难" class="headerlink" title="分布式的困难"></a>分布式的困难</h3><ul>
<li><p>远程调用</p>
<p>不同语言编写的服务通过 HTTP 调用</p>
</li>
<li><p>服务发现</p>
<p>获取所有可用的服务</p>
</li>
<li><p>负载均衡</p>
<p>均衡的将请求分发到各个服务的集群上</p>
</li>
<li><p>服务容错</p>
<p>服务调用出错的解决</p>
</li>
<li><p>配置管理</p>
<p>统一管理配置而不是重新部署</p>
</li>
<li><p>服务监控</p>
<p>服务之间资源使用情况</p>
</li>
<li><p>链路追踪</p>
<p>服务调用失败后的链路追踪</p>
</li>
<li><p>日志管理</p>
<p>多个服务的、每个服务的多台机器的日志管理</p>
</li>
<li><p>任务调度</p>
<p>如定时任务的解决方案</p>
</li>
</ul>
<h3 id="分布式问题的解决"><a href="#分布式问题的解决" class="headerlink" title="分布式问题的解决"></a>分布式问题的解决</h3><ul>
<li>SpringBoot + SpringCloud</li>
</ul>
<h2 id="云原生"><a href="#云原生" class="headerlink" title="云原生"></a>云原生</h2><p>原生应用如何上云。 Cloud Native</p>
<h3 id="上云的困难"><a href="#上云的困难" class="headerlink" title="上云的困难"></a>上云的困难</h3><ul>
<li><p>服务自愈</p>
<p>一个服务失败，能否即时的重新启动一个服务</p>
</li>
<li><p>弹性伸缩</p>
<p>应对流量峰值</p>
</li>
<li><p>服务隔离</p>
<p>不同的服务之间互不影响</p>
</li>
<li><p>自动化部署</p>
<p>自动发布机制</p>
</li>
<li><p>灰度发布</p>
<p>应用升级逐步替换生产环境</p>
</li>
<li><p>流量治理</p>
<p>不同的机器应对的流量不同</p>
</li>
</ul>
<h1 id="SpringBoot2-入门"><a href="#SpringBoot2-入门" class="headerlink" title="SpringBoot2 入门"></a>SpringBoot2 入门</h1><blockquote>
<p><strong>参考文档：</strong></p>
<p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/getting-started.html#getting-started.first-application">https://docs.spring.io/spring-boot/docs/current/reference/html/getting-started.html#getting-started.first-application</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/getting-started.html#getting-started">https://docs.spring.io/spring-boot/docs/current/reference/html/getting-started.html#getting-started</a></p>
<p>SpringBoot 依赖的版本号：<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/dependency-versions.html#appendix.dependency-versions">Dependency Versions (spring.io)</a></p>
</blockquote>
<h2 id="前置要求"><a href="#前置要求" class="headerlink" title="前置要求"></a>前置要求</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.java.com/">Java 8</a> &amp; 兼容 java14</li>
<li>Maven 3.3+</li>
<li>idea 2021.1.2</li>
</ul>
<h3 id="Maven-设置"><a href="#Maven-设置" class="headerlink" title="Maven 设置"></a>Maven 设置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirrors</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>nexus-aliyun<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>Nexus aliyun<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mirrors</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">  <span class="tag">&lt;<span class="name">profiles</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">id</span>&gt;</span>jdk-1.8<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">activation</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">activeByDefault</span>&gt;</span>true<span class="tag">&lt;/<span class="name">activeByDefault</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">jdk</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">jdk</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">maven.compiler.compilerVersion</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.compilerVersion</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h2><p>访问 localhost:8080&#x2F;hello，响应 Hello，Spring Boot 2 !</p>
<h3 id="创建-Maven-工程"><a href="#创建-Maven-工程" class="headerlink" title="创建 Maven 工程"></a>创建 Maven 工程</h3><p>创建工程 <code>SpringBoot2-GettingStarted</code></p>
<h3 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="创建主程序"><a href="#创建主程序" class="headerlink" title="创建主程序"></a>创建主程序</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 主程序类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@SpringBootApplication</span>：这是一个SpringBoot应用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(MainApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="编写业务"><a href="#编写业务" class="headerlink" title="编写业务"></a>编写业务</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/&quot;)</span></span><br><span class="line">    String <span class="title function_">home</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello World!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello SpringBoot2!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>直接运行 main 方法，访问 localhost:8080&#x2F;hello，响应 Hello，Spring Boot 2 !</p>
<h3 id="简化配置"><a href="#简化配置" class="headerlink" title="简化配置"></a>简化配置</h3><p>application.properties</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server.port=<span class="number">8888</span></span><br></pre></td></tr></table></figure>

<h3 id="简化部署"><a href="#简化部署" class="headerlink" title="简化部署"></a>简化部署</h3><p>把项目打成 jar 包，直接在目标服务器执行即可。</p>
<p>java -jar SpringBoot2-GettingStarted-1.0-SNAPSHOT.jar</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="SpringBoot-特点"><a href="#SpringBoot-特点" class="headerlink" title="SpringBoot 特点"></a>SpringBoot 特点</h1><h2 id="依赖管理"><a href="#依赖管理" class="headerlink" title="依赖管理"></a>依赖管理</h2><ul>
<li><p>父项目：依赖管理</p>
<blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>它的父项目：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>它的父项目：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">activemq.version</span>&gt;</span>5.16.5<span class="tag">&lt;/<span class="name">activemq.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">antlr2.version</span>&gt;</span>2.7.7<span class="tag">&lt;/<span class="name">antlr2.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">appengine-sdk.version</span>&gt;</span>1.9.98<span class="tag">&lt;/<span class="name">appengine-sdk.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artemis.version</span>&gt;</span>2.19.1<span class="tag">&lt;/<span class="name">artemis.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">aspectj.version</span>&gt;</span>1.9.7<span class="tag">&lt;/<span class="name">aspectj.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">assertj.version</span>&gt;</span>3.22.0<span class="tag">&lt;/<span class="name">assertj.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">atomikos.version</span>&gt;</span>4.0.6<span class="tag">&lt;/<span class="name">atomikos.version</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>该项目几乎声明了所有开发中常用的依赖的版本号，<code>自动版本仲裁机制</code></p>
<p>在使用时直接引入依赖即可：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>自定义依赖版本：（在子项目中修改默认版本号）</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mysql.version</span>&gt;</span>5.1.48<span class="tag">&lt;/<span class="name">mysql.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>开发导入 starter 场景启动器</p>
<blockquote>
<ol>
<li><p>spring-boot-starter-* ： *：表示某种场景</p>
</li>
<li><p>只要引入 starter，这个场景的所有常规依赖都会自动引入</p>
<p> <img src="/2023/03/14/SpringBoot2/spring-boot-starter-web.png" alt="spring-boot-starter-web.png"></p>
</li>
<li><p>SpringBoot 所支持的场景</p>
<p> <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/using-spring-boot.html#using-boot-starter">https://docs.spring.io/spring-boot/docs/current/reference/html/using-spring-boot.html#using-boot-starter</a></p>
</li>
<li><p>引入第三方场景启动器：*-spring-boot-starter，如 mybatis-spring-boot-starter</p>
</li>
<li><p>所有场景启动器最底层的依赖</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
</blockquote>
</li>
</ul>
<h2 id="自动配置"><a href="#自动配置" class="headerlink" title="自动配置"></a>自动配置</h2><p>SpringBoot 会根据引入的场景，自动配置好相应的组件。</p>
<blockquote>
<ul>
<li><p>自动配置好 Tomcat</p>
  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>自动配置好 SpringMVC 以及常用组件</p>
</li>
<li><p>默认的包结构：</p>
<ol>
<li><p>主程序所在包及其下面的所有子包里面的组件都会被默认扫描进来，无需配置Spring的包扫描</p>
<p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/using.html#using.structuring-your-code">https://docs.spring.io/spring-boot/docs/current/reference/html/using.html#using.structuring-your-code</a></p>
</li>
<li><p>可以通过注解属性改变扫描路径：@SpringBootApplication(scanBasePackages&#x3D;”com.example”)</p>
</li>
<li><p>或者通过 @ComponentScan 指定扫描路径【@ComponentScan 是不重复注解】</p>
</li>
</ol>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">com</span><br><span class="line"> +- example</span><br><span class="line">     +- myapplication</span><br><span class="line">         +- MyApplication.java</span><br><span class="line">         |</span><br><span class="line">         +- customer</span><br><span class="line">         |   +- Customer.java</span><br><span class="line">         |   +- CustomerController.java</span><br><span class="line">         |   +- CustomerService.java</span><br><span class="line">         |   +- CustomerRepository.java</span><br><span class="line">         |</span><br><span class="line">         +- order</span><br><span class="line">             +- Order.java</span><br><span class="line">             +- OrderController.java</span><br><span class="line">             +- OrderService.java</span><br><span class="line">             +- OrderRepository.java</span><br></pre></td></tr></table></figure>
</li>
<li><p>各种配置拥有默认值</p>
<p>  默认值会绑定到某个配置类</p>
</li>
<li><p>按需加载所有自动配置项</p>
<p>  项目引入了那种场景启动器，该启动器的自动配置就会开启。</p>
<p>  SpringBoot 所有的自动配置功能都在 spring-boot-autoconfigure 包里面</p>
</li>
</ul>
</blockquote>
<h1 id="容器功能"><a href="#容器功能" class="headerlink" title="容器功能"></a>容器功能</h1><h2 id="组件添加"><a href="#组件添加" class="headerlink" title="组件添加"></a>组件添加</h2><h3 id="Configuration"><a href="#Configuration" class="headerlink" title="@Configuration"></a>@Configuration</h3><blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Configuration &#123;</span><br><span class="line"> <span class="meta">@AliasFor(</span></span><br><span class="line"><span class="meta">     annotation = Component.class</span></span><br><span class="line"><span class="meta"> )</span></span><br><span class="line"> String <span class="title function_">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"> <span class="type">boolean</span> <span class="title function_">proxyBeanMethods</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Full模式与Lite模式</strong></p>
<p><strong>无论是 Full 还是 Lite ，从容器中获取的都是单实例。</strong></p>
<ol>
<li>Full Mode（proxyBeanMethods &#x3D; true）：<ul>
<li>保证每个@Bean方法被调用多少次（由配置类调用，如 myConfig.person( )）返回的组件都是单实例</li>
<li>此时从容器中获取的 MyConfig 是代理类，@Bean 方法是由配置类调用还有从容器中获取，都是同一个对象</li>
<li>由代理对象调用方法，SpringBoot 总会检查这个组件是否在容器中，如果有则直接获取（组件依赖问题）</li>
</ul>
</li>
<li>Lite Mode（proxyBeanMethods &#x3D; false）：<ul>
<li>每个 @Bean 方法被调用多少次返回的组件都是新创建的</li>
</ul>
</li>
</ol>
<p><strong>使用场景</strong></p>
<ul>
<li>配置类组件之间无依赖关系用 Lite 模式加速容器启动过程，减少判断</li>
<li>配置类组件之间有依赖关系，方法会被调用得到之前单实例组件，用 Full 模式</li>
<li>如果确定该组件不被其他组件依赖，则使用 false，可以提高应用启动效率</li>
</ul>
<p>【组件依赖必须使用 Full 模式默认。其他默认 Lite 模式】</p>
<p><strong>应用示例</strong></p>
<p>bean：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.springboot2.bean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Pet pet;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span> &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String name, Integer age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(Integer age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Pet <span class="title function_">getPet</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> pet;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPet</span><span class="params">(Pet pet)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.pet = pet;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Person&#123;&quot;</span> + <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&quot;, age=&quot;</span> + age + <span class="string">&quot;, pet=&quot;</span> + pet + <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.springboot2.bean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Pet</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Pet</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Pet</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Pet&#123;&quot;</span> + <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.springboot2.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.springboot2.bean.Person;</span><br><span class="line"><span class="keyword">import</span> com.example.springboot2.bean.Pet;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配置类也是组件</span></span><br><span class="line"><span class="comment"> * proxyBeanMethods: 代理bean的方法</span></span><br><span class="line"><span class="comment"> *      Full(proxyBeanMethods = true)：</span></span><br><span class="line"><span class="comment"> *          保证每个<span class="doctag">@Bean</span>方法被调用多少次返回的组件都是单实例</span></span><br><span class="line"><span class="comment"> *          此时从容器中获取的MyConfig是代理类，<span class="doctag">@Bean</span>方法是由配置类调用还有从容器中获取，都是同一个对象</span></span><br><span class="line"><span class="comment"> *          由代理对象调用方法，SpringBoot总会检查这个组件是否在容器中，如果有则直接获取</span></span><br><span class="line"><span class="comment"> *      Lite(proxyBeanMethods = false)：每个<span class="doctag">@Bean</span>方法被调用多少次返回的组件都是新创建的</span></span><br><span class="line"><span class="comment"> *      使用场景：如果确定该组件不被其他组件依赖，则使用false，可以提高应用启动效率</span></span><br><span class="line"><span class="comment"> *      【组件依赖必须使用Full模式默认。其他默认是否Lite模式】</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfig</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 给容器中添加组件，方法名作为组件的id，返回类型作为组件类型，可以传入自定义的组件名</span></span><br><span class="line"><span class="comment">     * 使用 <span class="doctag">@Bean</span> 标注在方法上给容器注册组件，默认是单实例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Person <span class="title function_">person</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;Jack&quot;</span>, <span class="number">12</span>);</span><br><span class="line">        <span class="comment">// 组件依赖</span></span><br><span class="line">        person.setPet(tomcat());</span><br><span class="line">        <span class="keyword">return</span> person;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Pet <span class="title function_">tomcat</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Pet</span>(<span class="string">&quot;tomcat&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.springboot2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.springboot2.bean.Person;</span><br><span class="line"><span class="keyword">import</span> com.example.springboot2.bean.Pet;</span><br><span class="line"><span class="keyword">import</span> com.example.springboot2.config.MyConfig;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ConfigurableApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 主程序类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@SpringBootApplication</span>：这是一个SpringBoot应用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ConfigurableApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> SpringApplication.run(MainApplication.class, args);</span><br><span class="line">        <span class="keyword">for</span> (String beanDefinitionName : context.getBeanDefinitionNames()) &#123;</span><br><span class="line">            System.out.println(beanDefinitionName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Pet</span> <span class="variable">tomcat</span> <span class="operator">=</span> context.getBean(<span class="string">&quot;tomcat&quot;</span>, Pet.class);</span><br><span class="line">        <span class="type">Pet</span> <span class="variable">tomcat01</span> <span class="operator">=</span> context.getBean(<span class="string">&quot;tomcat&quot;</span>, Pet.class);</span><br><span class="line">        System.out.println(<span class="string">&quot;tomcat == tomcat01: &quot;</span> + (tomcat == tomcat01));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 配置类本身也是组件</span></span><br><span class="line">        <span class="type">MyConfig</span> <span class="variable">myConfig</span> <span class="operator">=</span> context.getBean(MyConfig.class);</span><br><span class="line">        System.out.println(<span class="string">&quot;MyConfig: &quot;</span> + myConfig);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            @Configuration(proxyBeanMethods = true)：</span></span><br><span class="line"><span class="comment">                MyConfig: com.example.springboot.config.MyConfig$$EnhancerBySpringCGLIB$$c71c463c@3fbfa96</span></span><br><span class="line"><span class="comment">            @Configuration(proxyBeanMethods = false)：</span></span><br><span class="line"><span class="comment">                MyConfig: com.example.springboot.config.MyConfig@726a6b94</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> myConfig.person();</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person01</span> <span class="operator">=</span> context.getBean(<span class="string">&quot;person&quot;</span>, Person.class);</span><br><span class="line">        System.out.println(<span class="string">&quot;person == person01: &quot;</span> + (person == person01));</span><br><span class="line">        System.out.println(person01.getPet() == tomcat);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>使用场景</strong></p>
<ul>
<li>配置类组件之间无依赖关系用 Lite 模式加速容器启动过程，减少判断</li>
<li>配置类组件之间有依赖关系，方法会被调用得到之前单实例组件，用 Full 模式</li>
</ul>
</blockquote>
<h3 id="Bean、-Component、-Controller、-Service、-Repository、-ComponentScan"><a href="#Bean、-Component、-Controller、-Service、-Repository、-ComponentScan" class="headerlink" title="@Bean、@Component、@Controller、@Service、@Repository、@ComponentScan"></a>@Bean、@Component、@Controller、@Service、@Repository、@ComponentScan</h3><h3 id="Import"><a href="#Import" class="headerlink" title="@Import"></a>@Import</h3><blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Import &#123;</span><br><span class="line"> Class&lt;?&gt;[] value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>给容器中自动创建出相应类型的组件、组件的默认名就是全类名</p>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Spring</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Summer</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Import</span>(&#123;User.class, Pet.class&#125;)</span></span><br><span class="line"><span class="comment"> * 给容器中自动创建出相应类型的组件、组件的默认名就是全类名：com.example.springboot.bean.user</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Import(value = &#123;Spring.class, Summer.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfig</span> &#123; </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String[] beanNamesForType = context.getBeanNamesForType(Spring.class);</span><br><span class="line">Arrays.stream(beanNamesForType).forEach(System.out::println);</span><br><span class="line"><span class="comment">// com.example.springboot.bean.Spring</span></span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="Conditional"><a href="#Conditional" class="headerlink" title="@Conditional"></a>@Conditional</h3><blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Conditional &#123;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * All &#123;<span class="doctag">@link</span> Condition&#125; classes that must &#123;<span class="doctag">@linkplain</span> Condition#matches match&#125;</span></span><br><span class="line"><span class="comment">	 * in order for the component to be registered.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	Class&lt;? <span class="keyword">extends</span> <span class="title class_">Condition</span>&gt;[] vlue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/03/14/SpringBoot2/Conditional.png" alt="Conditional.png"></p>
<p>条件装配：满足 Conditional 指定的条件，则进行组件注入</p>
<p>可以标注在方法上，如果标注在类上，则对该类下所有 @Bean 的方法都生效</p>
<p>示例：</p>
<p>标注在方法上：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(name = &quot;tom&quot;)</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">user</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;Jack&quot;</span>, <span class="number">12</span>);</span><br><span class="line">    <span class="comment">// 组件依赖</span></span><br><span class="line">    user.setPet(tomcat());</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// @Bean(&quot;tom&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Pet <span class="title function_">tomcat</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Pet</span>(<span class="string">&quot;tomcat&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>标注在类上：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = true)</span></span><br><span class="line"><span class="meta">@Import(&#123;User.class, Pet.class&#125;)</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(name = &quot;tom&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfig</span> &#123;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="variable">containsTom</span> <span class="operator">=</span> context.containsBean(<span class="string">&quot;tom&quot;</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;containsTom: &quot;</span> + containsTom);  <span class="comment">//false</span></span><br><span class="line"></span><br><span class="line"><span class="type">boolean</span> <span class="variable">containsPerson</span> <span class="operator">=</span> context.containsBean(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;containsPerson: &quot;</span> + containsPerson); <span class="comment">//true</span></span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="ImportResource"><a href="#ImportResource" class="headerlink" title="@ImportResource"></a>@ImportResource</h3><blockquote>
<p>导入原生的 *.xml 配置文件，如有的第三方 Jar 使用了xml。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ImportResource &#123;</span><br><span class="line">    </span><br><span class="line">	<span class="meta">@AliasFor(&quot;locations&quot;)</span></span><br><span class="line">	String[] value() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    </span><br><span class="line">	<span class="meta">@AliasFor(&quot;value&quot;)</span></span><br><span class="line">	String[] locations() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    </span><br><span class="line">	Class&lt;? <span class="keyword">extends</span> <span class="title class_">BeanDefinitionReader</span>&gt; reader() <span class="keyword">default</span> BeanDefinitionReader.class;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>bean.xml：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">    http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"> <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;ua&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.example.springboot.bean.User&quot;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;ua&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;age&quot;</span> <span class="attr">value</span>=<span class="string">&quot;18&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;pa&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.example.springboot.bean.Pet&quot;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;tomcat&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ImportResource(&quot;classpath:bean.xml&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfig</span> &#123;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="配置绑定-ConfigurationProperties、-EnableConfigurationProperties"><a href="#配置绑定-ConfigurationProperties、-EnableConfigurationProperties" class="headerlink" title="配置绑定 @ConfigurationProperties、@EnableConfigurationProperties"></a>配置绑定 @ConfigurationProperties、@EnableConfigurationProperties</h3><blockquote>
<ol>
<li><p>方式一：@ConfigurationProperties + @Component</p>
<p> 在 Bean 上添加这两个注解，完成配置文件与 Bean 的属性绑定</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;mycar&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Car</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String brand;</span><br><span class="line">    <span class="keyword">private</span> Integer price;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<p> application.properties：</p>
 <figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置自动绑定</span></span><br><span class="line"><span class="attr">mycar.brand</span>=<span class="string">BYD</span></span><br><span class="line"><span class="attr">mycar.price</span>=<span class="string">10000</span></span><br></pre></td></tr></table></figure>

<p> 测试：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    Car car;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/car&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Car <span class="title function_">car</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> car;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>方式二：@ConfigurationProperties + @EnableConfigurationProperties</p>
<p> @EnableConfigurationProperties({Car.class})的两个作用：<strong>绑定配置，将Bean放入容器中。</strong></p>
<ul>
<li>在配置类上添加 @EnableConfigurationProperties({Car.class})</li>
<li>在 Bean 上添加 @ConfigurationProperties(prefix&#x3D;”mycar”)</li>
<li>使用场景：使用与第三方 Bean，没有使用 @Component时，可以使用该方式</li>
</ul>
<p> Bean：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;mycar&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Car</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String brand;</span><br><span class="line">    <span class="keyword">private</span> Integer price;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p> 配置类：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableConfigurationProperties(&#123;Car.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfig</span> &#123;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
</blockquote>
<h1 id="自动配置原理"><a href="#自动配置原理" class="headerlink" title="自动配置原理"></a>自动配置原理</h1><h2 id="引导加载自动配置类"><a href="#引导加载自动配置类" class="headerlink" title="引导加载自动配置类"></a>引导加载自动配置类</h2><h2 id="SpringBootApplication"><a href="#SpringBootApplication" class="headerlink" title="@SpringBootApplication"></a>@SpringBootApplication</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootConfiguration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@ComponentScan(excludeFilters = &#123; @Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),</span></span><br><span class="line"><span class="meta">		@Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootApplication &#123;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<h3 id="SpringBootConfiguration"><a href="#SpringBootConfiguration" class="headerlink" title="@SpringBootConfiguration"></a>@SpringBootConfiguration</h3><p>该注解使用 @Configuration ，仅作为一个配置类使用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Indexed</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootConfiguration &#123;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="ComponentScan"><a href="#ComponentScan" class="headerlink" title="@ComponentScan"></a>@ComponentScan</h3><p>​	只做包扫描使用</p>
<h3 id="EnableAutoConfiguration【核心注解】"><a href="#EnableAutoConfiguration【核心注解】" class="headerlink" title="@EnableAutoConfiguration【核心注解】"></a>@EnableAutoConfiguration【核心注解】</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoConfigurationPackage</span></span><br><span class="line"><span class="meta">@Import(AutoConfigurationImportSelector.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableAutoConfiguration &#123;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="AutoConfigurationPackage"><a href="#AutoConfigurationPackage" class="headerlink" title="@AutoConfigurationPackage"></a>@AutoConfigurationPackage</h4><p>​	<strong>指定了默认的包扫描规则</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Import(AutoConfigurationPackages.Registrar.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> AutoConfigurationPackage &#123;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>AutoConfigurationPackages.Registrar：</p>
<p>new PackageImports(metadata).getPackageNames() 得到的是主启动类所在的包名</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> ImportBeanDefinitionRegistrar&#125; to store the base package from the importing</span></span><br><span class="line"><span class="comment"> * configuration.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Registrar</span> <span class="keyword">implements</span> <span class="title class_">ImportBeanDefinitionRegistrar</span>, DeterminableImports &#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerBeanDefinitions</span><span class="params">(AnnotationMetadata metadata, BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">           <span class="comment">// new PackageImports(metadata).getPackageNames()得到的是主启动类所在的包名</span></span><br><span class="line">		register(registry, <span class="keyword">new</span> <span class="title class_">PackageImports</span>(metadata).getPackageNames().toArray(<span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">0</span>]));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> Set&lt;Object&gt; <span class="title function_">determineImports</span><span class="params">(AnnotationMetadata metadata)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> Collections.singleton(<span class="keyword">new</span> <span class="title class_">PackageImports</span>(metadata));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Import-AutoConfigurationImportSelector-class"><a href="#Import-AutoConfigurationImportSelector-class" class="headerlink" title="@Import(AutoConfigurationImportSelector.class)"></a>@Import(AutoConfigurationImportSelector.class)</h4><h5 id="核心功能"><a href="#核心功能" class="headerlink" title="核心功能"></a><strong>核心功能</strong></h5><blockquote>
<ol>
<li>利用 getAutoConfigurationEntry(annotationMetadata); 给容器中批量导入一些组件。</li>
<li>调用 List<String> configurations &#x3D; getCandidateConfigurations(annotationMetadata, attributes) 获取到所有需要导入到容器中的配置类。</String></li>
<li>利用工厂加载 Map&lt;String, List<String>&gt; loadSpringFactories(@Nullable ClassLoader classLoader)；得到所有的组件。</String></li>
<li>从 <strong>META-INF&#x2F;spring.factories</strong> 位置来加载一个文件。<br> 默认扫描我们当前系统里面所有 <strong>META-INF&#x2F;spring.factories</strong> 位置的文件里面的配置类，如： spring-boot-autoconfigure-2.3.4.RELEASE.jar 包里面有 META-INF&#x2F;spring.factories；但是这些配置类并不是都会生效的，而是<code>按需开启</code>。</li>
</ol>
</blockquote>
<h5 id="源码示例"><a href="#源码示例" class="headerlink" title="源码示例"></a>源码示例</h5><blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AutoConfigurationImportSelector</span> <span class="keyword">implements</span> <span class="title class_">DeferredImportSelector</span>, BeanClassLoaderAware,</span><br><span class="line">		ResourceLoaderAware, BeanFactoryAware, EnvironmentAware, Ordered &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">            </span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> String[] selectImports(AnnotationMetadata annotationMetadata) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!isEnabled(annotationMetadata)) &#123;</span><br><span class="line">			<span class="keyword">return</span> NO_IMPORTS;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">AutoConfigurationEntry</span> <span class="variable">autoConfigurationEntry</span> <span class="operator">=</span> </span><br><span class="line">            						getAutoConfigurationEntry(annotationMetadata);</span><br><span class="line">		<span class="keyword">return</span> StringUtils.toStringArray(autoConfigurationEntry.getConfigurations());</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//  给容器中批量导入一些组件</span></span><br><span class="line">    <span class="keyword">protected</span> AutoConfigurationEntry <span class="title function_">getAutoConfigurationEntry</span><span class="params">(AnnotationMetadata annotationMetadata)</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (!isEnabled(annotationMetadata)) &#123;</span><br><span class="line">			<span class="keyword">return</span> EMPTY_ENTRY;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">AnnotationAttributes</span> <span class="variable">attributes</span> <span class="operator">=</span> getAttributes(annotationMetadata);</span><br><span class="line">        <span class="comment">// 获取到所有需要导入到容器中的配置类</span></span><br><span class="line">		List&lt;String&gt; configurations = getCandidateConfigurations(annotationMetadata, attributes);</span><br><span class="line">		configurations = removeDuplicates(configurations);</span><br><span class="line">		Set&lt;String&gt; exclusions = getExclusions(annotationMetadata, attributes);</span><br><span class="line">		checkExcludedClasses(configurations, exclusions);</span><br><span class="line">		configurations.removeAll(exclusions);</span><br><span class="line">		configurations = getConfigurationClassFilter().filter(configurations);</span><br><span class="line">		fireAutoConfigurationImportEvents(configurations, exclusions);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AutoConfigurationEntry</span>(configurations, exclusions);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>根据注解得到需要加载的配置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> List&lt;String&gt; <span class="title function_">getCandidateConfigurations</span><span class="params">(AnnotationMetadata metadata, AnnotationAttributes attributes)</span> &#123;</span><br><span class="line">		List&lt;String&gt; configurations = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(</span><br><span class="line">				SpringFactoriesLoader.loadFactoryNames(getSpringFactoriesLoaderFactoryClass(), getBeanClassLoader()));</span><br><span class="line">		ImportCandidates.load(AutoConfiguration.class, getBeanClassLoader()).forEach(configurations::add);</span><br><span class="line">		Assert.notEmpty(configurations,</span><br><span class="line">				<span class="string">&quot;No auto configuration classes found in META-INF/spring.factories nor in META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports. If you &quot;</span></span><br><span class="line">						+ <span class="string">&quot;are using a custom packaging, make sure that file is correct.&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> configurations;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>SpringFactoriesLoader.loadFactoryNames：</p>
<p>|—-SpringFactoriesLoader</p>
<p>其中：Enumeration<URL> urls &#x3D; classLoader.getResources(FACTORIES_RESOURCE_LOCATION);</URL></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public static final String FACTORIES_RESOURCE_LOCATION = &quot;META-INF/spring.factories&quot;;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, List&lt;String&gt;&gt; <span class="title function_">loadSpringFactories</span><span class="params">(ClassLoader classLoader)</span> &#123;</span><br><span class="line">	Map&lt;String, List&lt;String&gt;&gt; result = cache.get(classLoader);</span><br><span class="line">	<span class="keyword">if</span> (result != <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line">	result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		Enumeration&lt;URL&gt; urls = </span><br><span class="line">               			classLoader.getResources(FACTORIES_RESOURCE_LOCATION);</span><br><span class="line">		<span class="keyword">while</span> (urls.hasMoreElements()) &#123;</span><br><span class="line">			<span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> urls.nextElement();</span><br><span class="line">			<span class="type">UrlResource</span> <span class="variable">resource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UrlResource</span>(url);</span><br><span class="line">			<span class="type">Properties</span> <span class="variable">properties</span> <span class="operator">=</span> PropertiesLoaderUtils.loadProperties(resource);</span><br><span class="line">			<span class="keyword">for</span> (Map.Entry&lt;?, ?&gt; entry : properties.entrySet()) &#123;</span><br><span class="line">				<span class="type">String</span> <span class="variable">factoryTypeName</span> <span class="operator">=</span> ((String) entry.getKey()).trim();</span><br><span class="line">				String[] factoryImplementationNames =</span><br><span class="line">						StringUtils.commaDelimitedListToStringArray((String) entry.getValue());</span><br><span class="line">				<span class="keyword">for</span> (String factoryImplementationName : factoryImplementationNames) &#123;</span><br><span class="line">					result.computeIfAbsent(factoryTypeName, key -&gt; <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;())</span><br><span class="line">							.add(factoryImplementationName.trim());</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Replace all lists with unmodifiable lists containing unique elements</span></span><br><span class="line">		result.replaceAll((factoryType, implementations) -&gt; </span><br><span class="line">                             				implementations.stream().distinct()</span><br><span class="line">				.collect(Collectors.collectingAndThen(Collectors.toList(), Collections::unmodifiableList)));</span><br><span class="line">		cache.put(classLoader, result);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Unable to load factories from location [&quot;</span> +</span><br><span class="line">				FACTORIES_RESOURCE_LOCATION + <span class="string">&quot;]&quot;</span>, ex);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</blockquote>
<h5 id="META-INF-x2F-spring-factories"><a href="#META-INF-x2F-spring-factories" class="headerlink" title="META-INF&#x2F;spring.factories"></a>META-INF&#x2F;spring.factories</h5><blockquote>
<p>注意：高版本的 XXXXAutoConfiguration 在</p>
<p> META-INF&#x2F;spring&#x2F;org.springframework.boot.autoconfigure.AutoConfiguration.imports</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.aop.AopAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.amqp.RabbitAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.batch.BatchAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.cache.CacheAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.cassandra.CassandraAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.context.ConfigurationPropertiesAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.context.LifecycleAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.context.MessageSourceAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.context.PropertyPlaceholderAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.couchbase.CouchbaseAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.dao.PersistenceExceptionTranslationAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.data.cassandra.CassandraDataAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.data.cassandra.CassandraReactiveDataAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.data.cassandra.CassandraReactiveRepositoriesAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.data.cassandra.CassandraRepositoriesAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.data.couchbase.CouchbaseDataAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.data.couchbase.CouchbaseReactiveDataAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.data.couchbase.CouchbaseReactiveRepositoriesAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.data.couchbase.CouchbaseRepositoriesAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.data.elasticsearch.ElasticsearchDataAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.data.elasticsearch.ElasticsearchRepositoriesAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.data.elasticsearch.ReactiveElasticsearchRepositoriesAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.data.elasticsearch.ReactiveElasticsearchRestClientAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.data.jdbc.JdbcRepositoriesAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.data.jpa.JpaRepositoriesAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.data.ldap.LdapRepositoriesAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.data.mongo.MongoDataAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.data.mongo.MongoReactiveDataAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.data.mongo.MongoReactiveRepositoriesAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.data.mongo.MongoRepositoriesAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.data.neo4j.Neo4jDataAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.data.neo4j.Neo4jReactiveDataAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.data.neo4j.Neo4jReactiveRepositoriesAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.data.neo4j.Neo4jRepositoriesAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.data.r2dbc.R2dbcDataAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.data.r2dbc.R2dbcRepositoriesAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.data.redis.RedisAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.data.redis.RedisReactiveAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.data.redis.RedisRepositoriesAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.data.rest.RepositoryRestMvcAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.data.web.SpringDataWebAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.elasticsearch.ElasticsearchRestClientAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.flyway.FlywayAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.freemarker.FreeMarkerAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.graphql.GraphQlAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.graphql.data.GraphQlReactiveQueryByExampleAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.graphql.data.GraphQlReactiveQuerydslAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.graphql.data.GraphQlQueryByExampleAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.graphql.data.GraphQlQuerydslAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.graphql.reactive.GraphQlWebFluxAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.graphql.rsocket.GraphQlRSocketAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.graphql.rsocket.RSocketGraphQlClientAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.graphql.security.GraphQlWebFluxSecurityAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.graphql.security.GraphQlWebMvcSecurityAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.graphql.servlet.GraphQlWebMvcAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.groovy.template.GroovyTemplateAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.gson.GsonAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.h2.H2ConsoleAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.hateoas.HypermediaAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.hazelcast.HazelcastAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.hazelcast.HazelcastJpaDependencyAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.http.HttpMessageConvertersAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.http.codec.CodecsAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.influx.InfluxDbAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.info.ProjectInfoAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.integration.IntegrationAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.jackson.JacksonAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.jdbc.JdbcTemplateAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.jdbc.JndiDataSourceAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.jdbc.XADataSourceAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.jdbc.DataSourceTransactionManagerAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.jms.JmsAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.jmx.JmxAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.jms.JndiConnectionFactoryAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.jms.activemq.ActiveMQAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.jms.artemis.ArtemisAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.jersey.JerseyAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.jooq.JooqAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.jsonb.JsonbAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.kafka.KafkaAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.availability.ApplicationAvailabilityAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.ldap.embedded.EmbeddedLdapAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.ldap.LdapAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.liquibase.LiquibaseAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.mail.MailSenderAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.mail.MailSenderValidatorAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.mongo.embedded.EmbeddedMongoAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.mongo.MongoAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.mongo.MongoReactiveAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.mustache.MustacheAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.neo4j.Neo4jAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.netty.NettyAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.orm.jpa.HibernateJpaAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.quartz.QuartzAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.r2dbc.R2dbcAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.r2dbc.R2dbcTransactionManagerAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.rsocket.RSocketMessagingAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.rsocket.RSocketRequesterAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.rsocket.RSocketServerAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.rsocket.RSocketStrategiesAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.security.servlet.SecurityAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.security.servlet.UserDetailsServiceAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.security.servlet.SecurityFilterAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.security.reactive.ReactiveSecurityAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.security.reactive.ReactiveUserDetailsServiceAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.security.rsocket.RSocketSecurityAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.security.saml2.Saml2RelyingPartyAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.sendgrid.SendGridAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.session.SessionAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.security.oauth2.client.servlet.OAuth2ClientAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.security.oauth2.client.reactive.ReactiveOAuth2ClientAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.security.oauth2.resource.servlet.OAuth2ResourceServerAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.security.oauth2.resource.reactive.ReactiveOAuth2ResourceServerAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.solr.SolrAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.sql.init.SqlInitializationAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.task.TaskExecutionAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.task.TaskSchedulingAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.thymeleaf.ThymeleafAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.transaction.TransactionAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.transaction.jta.JtaAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.validation.ValidationAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.web.client.RestTemplateAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.web.embedded.EmbeddedWebServerFactoryCustomizerAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.web.reactive.HttpHandlerAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.web.reactive.ReactiveMultipartAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.web.reactive.ReactiveWebServerFactoryAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.web.reactive.WebFluxAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.web.reactive.WebSessionIdResolverAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.web.reactive.error.ErrorWebFluxAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.web.reactive.function.client.ClientHttpConnectorAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.web.reactive.function.client.WebClientAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.web.servlet.DispatcherServletAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.web.servlet.ServletWebServerFactoryAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.web.servlet.error.ErrorMvcAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.web.servlet.HttpEncodingAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.web.servlet.MultipartAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.web.servlet.WebMvcAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.websocket.reactive.WebSocketReactiveAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.websocket.servlet.WebSocketServletAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.websocket.servlet.WebSocketMessagingAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.webservices.WebServicesAutoConfiguration</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.webservices.client.WebServiceTemplateAutoConfiguration</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="按需开启自动配置项"><a href="#按需开启自动配置项" class="headerlink" title="按需开启自动配置项"></a>按需开启自动配置项</h2><blockquote>
<p>虽然所有自动配置启动的时候默认全部加载。但是 XXXXAutoConfiguration 只会按照条件装配规则（@Conditional），最终会按需配置。</p>
</blockquote>
<h3 id="示例一：AopAutoConfiguration"><a href="#示例一：AopAutoConfiguration" class="headerlink" title="示例一：AopAutoConfiguration"></a>示例一：AopAutoConfiguration</h3><blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoConfiguration</span></span><br><span class="line"><span class="comment">// ==========该条件生效，默认配置matchIfMissing = true==========</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(prefix = &quot;spring.aop&quot;, name = &quot;auto&quot;, havingValue = &quot;true&quot;, matchIfMissing = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AopAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line">    <span class="comment">// ==========没有引入 Advice，该类不会配置==========</span></span><br><span class="line">	<span class="meta">@ConditionalOnClass(Advice.class)</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">AspectJAutoProxyingConfiguration</span> &#123;</span><br><span class="line">		<span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line">		<span class="meta">@EnableAspectJAutoProxy(proxyTargetClass = false)</span></span><br><span class="line">		<span class="meta">@ConditionalOnProperty(prefix = &quot;spring.aop&quot;, name = &quot;proxy-target-class&quot;, havingValue = &quot;false&quot;)</span></span><br><span class="line">		<span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">JdkDynamicAutoProxyConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line">		<span class="meta">@EnableAspectJAutoProxy(proxyTargetClass = true)</span></span><br><span class="line">		<span class="meta">@ConditionalOnProperty(prefix = &quot;spring.aop&quot;, name = &quot;proxy-target-class&quot;, havingValue = &quot;true&quot;,</span></span><br><span class="line"><span class="meta">				matchIfMissing = true)</span></span><br><span class="line">		<span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CglibAutoProxyConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line">    <span class="comment">// ==========生效，但配置的只是一个简单版的AOP==========</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingClass(&quot;org.aspectj.weaver.Advice&quot;)</span></span><br><span class="line">	<span class="meta">@ConditionalOnProperty(prefix = &quot;spring.aop&quot;, name = &quot;proxy-target-class&quot;, havingValue = &quot;true&quot;,</span></span><br><span class="line"><span class="meta">			matchIfMissing = true)</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ClassProxyingConfiguration</span> &#123;</span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">		<span class="keyword">static</span> BeanFactoryPostProcessor <span class="title function_">forceAutoProxyCreatorToUseClassProxying</span><span class="params">()</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> (beanFactory) -&gt; &#123;</span><br><span class="line">				<span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> BeanDefinitionRegistry) &#123;</span><br><span class="line">					<span class="type">BeanDefinitionRegistry</span> <span class="variable">registry</span> <span class="operator">=</span> (BeanDefinitionRegistry) beanFactory;</span><br><span class="line">					AopConfigUtils.registerAutoProxyCreatorIfNecessary(registry);</span><br><span class="line">					AopConfigUtils.forceAutoProxyCreatorToUseClassProxying(registry);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="示例二：DispatcherServletAutoConfiguration"><a href="#示例二：DispatcherServletAutoConfiguration" class="headerlink" title="示例二：DispatcherServletAutoConfiguration"></a>示例二：DispatcherServletAutoConfiguration</h3><blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoConfigureOrder(Ordered.HIGHEST_PRECEDENCE)</span></span><br><span class="line"><span class="meta">@AutoConfiguration(after = ServletWebServerFactoryAutoConfiguration.class)</span></span><br><span class="line"><span class="comment">// ==========是否为servlet环境==========</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication(type = Type.SERVLET)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(DispatcherServlet.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DispatcherServletAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_DISPATCHER_SERVLET_BEAN_NAME</span> <span class="operator">=</span> <span class="string">&quot;dispatcherServlet&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_DISPATCHER_SERVLET_REGISTRATION_BEAN_NAME</span> <span class="operator">=</span> <span class="string">&quot;dispatcherServletRegistration&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line">	<span class="meta">@Conditional(DefaultDispatcherServletCondition.class)</span></span><br><span class="line">	<span class="meta">@ConditionalOnClass(ServletRegistration.class)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ==========使用@EnableConfigurationProperties为WebMvcProperties绑定配置==========</span></span><br><span class="line">    <span class="comment">// ==========@EnableConfigurationProperties：绑定配置、放入容器==========</span></span><br><span class="line">	<span class="meta">@EnableConfigurationProperties(WebMvcProperties.class)</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">DispatcherServletConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Bean(name = DEFAULT_DISPATCHER_SERVLET_BEAN_NAME)</span></span><br><span class="line">        <span class="comment">// ==========@Bean方法中的参数会从容器中拿值==========</span></span><br><span class="line">		<span class="keyword">public</span> DispatcherServlet <span class="title function_">dispatcherServlet</span><span class="params">(WebMvcProperties webMvcProperties)</span> &#123;</span><br><span class="line">			<span class="type">DispatcherServlet</span> <span class="variable">dispatcherServlet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DispatcherServlet</span>();</span><br><span class="line">			dispatcherServlet.setDispatchOptionsRequest(webMvcProperties.isDispatchOptionsRequest());</span><br><span class="line">dispatcherServlet.setDispatchTraceRequest(webMvcProperties.isDispatchTraceRequest());</span><br><span class="line">dispatcherServlet.setThrowExceptionIfNoHandlerFound(webMvcProperties.isThrowExceptionIfNoHandlerFound());</span><br><span class="line">dispatcherServlet.setPublishEvents(webMvcProperties.isPublishRequestHandledEvents());</span><br><span class="line">dispatcherServlet.setEnableLoggingRequestDetails(webMvcProperties.isLogRequestDetails());</span><br><span class="line">			<span class="keyword">return</span> dispatcherServlet;</span><br><span class="line">		&#125;</span><br><span class="line">        </span><br><span class="line">		<span class="comment">// ==========该@Bean相当于规范了Bean的名称：如果有组件MultipartResolver但名字不是multipartResolver的Bean，会重新规范命名==========</span></span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">		<span class="meta">@ConditionalOnBean(MultipartResolver.class)</span></span><br><span class="line">		<span class="meta">@ConditionalOnMissingBean(name = DispatcherServlet.MULTIPART_RESOLVER_BEAN_NAME)</span></span><br><span class="line">		<span class="keyword">public</span> MultipartResolver <span class="title function_">multipartResolver</span><span class="params">(MultipartResolver resolver)</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> resolver;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="示例三：HttpEncodingAutoConfiguration"><a href="#示例三：HttpEncodingAutoConfiguration" class="headerlink" title="示例三：HttpEncodingAutoConfiguration"></a>示例三：HttpEncodingAutoConfiguration</h3><blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoConfiguration</span></span><br><span class="line"><span class="comment">// ==========为ServerProperties绑定了配置==========</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(ServerProperties.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication(type = ConditionalOnWebApplication.Type.SERVLET)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(CharacterEncodingFilter.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(prefix = &quot;server.servlet.encoding&quot;, value = &quot;enabled&quot;, matchIfMissing = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpEncodingAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Encoding properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">HttpEncodingAutoConfiguration</span><span class="params">(ServerProperties properties)</span> &#123;</span><br><span class="line">   <span class="built_in">this</span>.properties = properties.getServlet().getEncoding();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line"><span class="keyword">public</span> CharacterEncodingFilter <span class="title function_">characterEncodingFilter</span><span class="params">()</span> &#123;</span><br><span class="line">   <span class="type">CharacterEncodingFilter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderedCharacterEncodingFilter</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ==========通过有参构造获取配置文件中的值==========</span></span><br><span class="line">   filter.setEncoding(<span class="built_in">this</span>.properties.getCharset().name());</span><br><span class="line">   filter.setForceRequestEncoding(<span class="built_in">this</span>.properties.shouldForce(Encoding.Type.REQUEST));</span><br><span class="line">   filter.setForceResponseEncoding(<span class="built_in">this</span>.properties.shouldForce(Encoding.Type.RESPONSE));</span><br><span class="line">   <span class="keyword">return</span> filter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ServerProperties：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;server&quot;, ignoreUnknownFields = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServerProperties</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Server HTTP port.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> Integer port;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Network address to which the server should bind.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> InetAddress address;</span><br><span class="line">    </span><br><span class="line">   	<span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Servlet</span> <span class="variable">servlet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Servlet</span>();</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Servlet</span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * Servlet context init parameters.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, String&gt; contextParameters = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * Context path of the application.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">private</span> String contextPath;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * Display name of the application.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">private</span> <span class="type">String</span> <span class="variable">applicationDisplayName</span> <span class="operator">=</span> <span class="string">&quot;application&quot;</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * Whether to register the default Servlet with the container.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">registerDefaultServlet</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@NestedConfigurationProperty</span></span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Encoding</span> <span class="variable">encoding</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Encoding</span>();</span><br></pre></td></tr></table></figure>

<p>“级联写法”：server.servlet.encoding.charset &#x3D; utf-8</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Encoding</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Default HTTP encoding for Servlet applications.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Charset</span> <span class="variable">DEFAULT_CHARSET</span> <span class="operator">=</span> StandardCharsets.UTF_8;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Charset of HTTP requests and responses. Added to the &quot;Content-Type&quot; header if not</span></span><br><span class="line"><span class="comment">	 * set explicitly.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="type">Charset</span> <span class="variable">charset</span> <span class="operator">=</span> DEFAULT_CHARSET;</span><br></pre></td></tr></table></figure>

<p>application.properties：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.servlet.encoding.charset</span>=<span class="string">utf-8</span></span><br></pre></td></tr></table></figure>
</blockquote>
<h1 id="最佳实践：总结"><a href="#最佳实践：总结" class="headerlink" title="最佳实践：总结"></a>最佳实践：总结</h1><ul>
<li><p>引入场景依赖</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/using-spring-boot.html#using-boot-starter">https://docs.spring.io/spring-boot/docs/current/reference/html/using-spring-boot.html#using-boot-starter</a></li>
</ul>
</li>
<li><p>查看自动配置了哪些属性</p>
<ul>
<li>自己分析，引入场景对应的自动配置一般都生效</li>
<li>配置文件中 <strong>debug&#x3D;true</strong> 开启自动配置报告。Negative（不生效）、Positive（生效）</li>
</ul>
</li>
<li><p>是否需要修改</p>
<ul>
<li><p>参照文档修改配置项</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/appendix-application-properties.html#common-application-properties">https://docs.spring.io/spring-boot/docs/current/reference/html/appendix-application-properties.html#common-application-properties</a></p>
</li>
</ul>
</li>
<li><p>自己分析，xxxxProperties 绑定了配置文件的哪些属性。</p>
</li>
<li><p>自定义加入或者替换组件</p>
<ul>
<li><p>@Bean、@Component 等</p>
</li>
<li><p>自定义器  <strong>XXXXXCustomizer</strong>；</p>
</li>
<li><p>示例：修改SpringBoot启动的 banner</p>
</li>
<li><p>&#96;&#96;&#96;properties<br>  spring.banner.image.location&#x3D;classpath:bug.jpg</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 几个开发中的插件</span><br><span class="line"></span><br><span class="line">## lombok</span><br><span class="line"></span><br><span class="line">简化 get/set 等其他方法的手动编写。</span><br><span class="line"></span><br><span class="line">```xml</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Accessors(chain = true)</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode</span></span><br><span class="line"><span class="comment">//日志</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Car</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String brand;</span><br><span class="line">    <span class="keyword">private</span> Integer price;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="dev-tools"><a href="#dev-tools" class="headerlink" title="dev-tools"></a>dev-tools</h2><p>热更新，类似重启，对于静态页面建议使用，对于源代码会重新编译加载。</p>
<p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/using.html#using.devtools">https://docs.spring.io/spring-boot/docs/current/reference/html/using.html#using.devtools</a></p>
<p>引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>修改页面，使用 CTRL +F9 重新编译（类似重启）</p>
<h2 id="SpringInitializer"><a href="#SpringInitializer" class="headerlink" title="SpringInitializer"></a>SpringInitializer</h2><p>​		自动引入依赖、创建目录结构、编写主配置类</p>
<p>创建工程：<code>SpringBoot-YamlConfig</code></p>
<h1 id="配置文件：yaml"><a href="#配置文件：yaml" class="headerlink" title="配置文件：yaml"></a>配置文件：yaml</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>​		YAML 是 “YAML Ain’t Markup Language”（YAML 不是一种标记语言）的递归缩写。在开发的这种语言时，YAML 的意思其实是：”Yet Another Markup Language”（仍是一种标记语言）。 适合用来做以数据为中心的配置文件。</p>
<h2 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h2><ul>
<li>key: value；kv 之间有空格</li>
<li>大小写敏感</li>
<li>使用缩进表示层级关系</li>
<li>缩进不允许使用 tab，只允许空格（IDE会处理 tab）</li>
<li>缩进的空格数不重要，只要相同层级的元素左对齐即可</li>
<li>‘#’ 表示注释</li>
<li>字符串无需加引号，如果要加，’ ‘ 与 “ “ ：单引号会被转义（\n 原样输出），双引号不会转义（\n 会换行）</li>
</ul>
<h2 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h2><ul>
<li><p>字面量</p>
<p>  单个的、不可再分的值。date、boolean、string、number、null</p>
  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">K:</span> <span class="string">v</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>对象：键值对的集合。map、hash、set、object </p>
  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">行内写法：</span>  <span class="attr">k:</span> &#123;<span class="string">k1:v1</span>,<span class="string">k2:v2</span>,<span class="string">k3:v3</span>&#125;</span><br><span class="line"><span class="comment">#或</span></span><br><span class="line"><span class="attr">k:</span> </span><br><span class="line">  <span class="attr">k1:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">k2:</span> <span class="string">v2</span></span><br><span class="line">  <span class="attr">k3:</span> <span class="string">v3</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>数组：一组按次序排列的值。array、list、queue</p>
  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">行内写法：</span>  <span class="attr">k:</span> [<span class="string">v1</span>,<span class="string">v2</span>,<span class="string">v3</span>]</span><br><span class="line"><span class="comment">#或者</span></span><br><span class="line"><span class="attr">k:</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">v1</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">v2</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">v3</span></span><br></pre></td></tr></table></figure>

<p>  示例：</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;person&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">    <span class="keyword">private</span> Boolean boss;</span><br><span class="line">    <span class="keyword">private</span> Date birth;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> Pet pet;</span><br><span class="line">    <span class="keyword">private</span> String[] interests;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; animal;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; score;</span><br><span class="line">    <span class="keyword">private</span> Set&lt;Double&gt; salary;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, List&lt;Pet&gt;&gt; allPets;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;pet&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Pet</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Double weight;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">person:</span></span><br><span class="line">  <span class="attr">userName:</span> <span class="string">&quot;mineting \n minefei&quot;</span></span><br><span class="line">  <span class="comment"># 注意：双引号中的\n会换行，和普通字符串一样，单引号则会原样输出</span></span><br><span class="line">  <span class="comment"># userName可以写作user-name</span></span><br><span class="line">  <span class="attr">boss:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">birth:</span> <span class="number">1997</span><span class="string">/01/20</span> <span class="number">08</span><span class="string">:00:00</span></span><br><span class="line">  <span class="attr">age:</span> <span class="number">24</span></span><br><span class="line">  <span class="comment">#pet: &#123; name:tomcat,weight:24.0 &#125;</span></span><br><span class="line">  <span class="attr">pet:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">tomcat</span></span><br><span class="line">    <span class="attr">weight:</span> <span class="number">24.0</span></span><br><span class="line">  <span class="attr">interests:</span> [ <span class="string">Java</span>,<span class="string">Go</span>,<span class="string">Python</span> ]</span><br><span class="line">  <span class="attr">animal:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">tom</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">jerry</span></span><br><span class="line">  <span class="attr">score:</span></span><br><span class="line">    <span class="attr">english:</span></span><br><span class="line">      <span class="attr">first:</span> <span class="number">100</span></span><br><span class="line">      <span class="attr">second:</span> <span class="number">90</span></span><br><span class="line">      <span class="attr">third:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">math:</span> [ <span class="number">100</span>,<span class="number">99</span>,<span class="number">98</span> ]</span><br><span class="line">  <span class="attr">salary:</span> [ <span class="number">10.0</span>,<span class="number">10.1</span>,<span class="number">10.2</span> ]</span><br><span class="line">  <span class="attr">allPets:</span></span><br><span class="line">    <span class="attr">sick:</span></span><br><span class="line">      <span class="bullet">-</span> &#123; <span class="attr">name:</span> <span class="string">tom</span> &#125;</span><br><span class="line">      <span class="bullet">-</span> &#123; <span class="attr">name:</span> <span class="string">jerry</span>,<span class="string">weight:12.0</span> &#125;</span><br><span class="line">    <span class="attr">health:</span> [ &#123; <span class="attr">name:</span> <span class="string">jerry</span>,<span class="attr">weight:</span> <span class="number">2.0</span> &#125; ]</span><br></pre></td></tr></table></figure>

  <figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#如果yaml和properties都配置，以properties为准</span></span><br><span class="line"><span class="attr">person.userName</span>=<span class="string">minefei</span></span><br></pre></td></tr></table></figure>

<p>  测试：</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    Person person;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/yaml&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Person <span class="title function_">person</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(person.getUserName());</span><br><span class="line">        <span class="keyword">return</span> person;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="配置绑定提示"><a href="#配置绑定提示" class="headerlink" title="配置绑定提示"></a>配置绑定提示</h2><p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/configuration-metadata.html#appendix.configuration-metadata.format.propert">https://docs.spring.io/spring-boot/docs/current/reference/html/configuration-metadata.html#appendix.configuration-metadata.format.propert</a></p>
<p>自定义Bean属性绑定提示：<br>引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>打包时略过该插件：</p>
<blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">proc</span>&gt;</span>none<span class="tag">&lt;/<span class="name">proc</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>或者（建议）</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">exclude</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>


</blockquote>
<h1 id="Web开发"><a href="#Web开发" class="headerlink" title="Web开发"></a>Web开发</h1><p>SpringBoot 基于 SpringMVC 做了自动配置。</p>
<h2 id="SpringMVC自动配置概览"><a href="#SpringMVC自动配置概览" class="headerlink" title="SpringMVC自动配置概览"></a>SpringMVC自动配置概览</h2><p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/web.html#web.servlet.spring-mvc.auto-configuration">https://docs.spring.io/spring-boot/docs/current/reference/html/web.html#web.servlet.spring-mvc.auto-configuration</a></p>
<blockquote>
<h4 id="Spring-MVC-Auto-configuration"><a href="#Spring-MVC-Auto-configuration" class="headerlink" title="Spring MVC Auto-configuration"></a>Spring MVC Auto-configuration</h4><p>Spring Boot provides auto-configuration for Spring MVC that works well with most applications.</p>
<p>The auto-configuration adds the following features on top of Spring’s defaults:</p>
<ul>
<li><p>Inclusion of <code>ContentNegotiatingViewResolver</code> and <code>BeanNameViewResolver</code> beans.</p>
</li>
<li><p>内容协商视图解析器和BeanName视图解析器</p>
</li>
<li><p>Support for serving static resources, including support for WebJars (covered <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#web.servlet.spring-mvc.static-content">later in this document</a>).</p>
</li>
<li><p>静态资源（包括webjars）</p>
</li>
<li><p>Automatic registration of <code>Converter</code>, <code>GenericConverter</code>, and <code>Formatter</code> beans.</p>
<p>  自动注册 <code>Converter，GenericConverter，Formatter</code></p>
</li>
<li><p>Support for <code>HttpMessageConverters</code> (covered <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#web.servlet.spring-mvc.message-converters">later in this document</a>).</p>
</li>
<li><p>支持 <code>HttpMessageConverters</code> （后来我们配合内容协商理解原理）</p>
</li>
<li><p>Automatic registration of <code>MessageCodesResolver</code> (covered <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#web.servlet.spring-mvc.message-codes">later in this document</a>).</p>
</li>
<li><p>自动注册 <code>MessageCodesResolver</code> （国际化用）</p>
</li>
<li><p>Static <code>index.html</code> support.</p>
</li>
<li><p>静态index.html 页支持</p>
</li>
<li><p>Automatic use of a <code>ConfigurableWebBindingInitializer</code> bean (covered <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#web.servlet.spring-mvc.binding-initializer">later in this document</a>).</p>
</li>
<li><p>自动使用 <code>ConfigurableWebBindingInitializer</code> ，（DataBinder负责将请求数据绑定到JavaBean上）</p>
</li>
</ul>
<p>If you want to keep those Spring Boot MVC customizations and make more <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/5.3.23/reference/html/web.html#mvc">MVC customizations</a> (interceptors, formatters, view controllers, and other features), you can add your own <code>@Configuration</code> class of type <code>WebMvcConfigurer</code> but <strong>without</strong> <code>@EnableWebMvc</code>.</p>
<p><strong>不用@EnableWebMvc注解。使用</strong> <code>@Configuration</code> <strong>+</strong> <code>WebMvcConfigurer</code> <strong>自定义规则</strong></p>
<p>If you want to provide custom instances of <code>RequestMappingHandlerMapping</code>, <code>RequestMappingHandlerAdapter</code>, or <code>ExceptionHandlerExceptionResolver</code>, and still keep the Spring Boot MVC customizations, you can declare a bean of type <code>WebMvcRegistrations</code> and use it to provide custom instances of those components.</p>
<p><strong>声明</strong> <code>WebMvcRegistrations</code> <strong>改变默认底层组件</strong></p>
<p>If you want to take complete control of Spring MVC, you can add your own <code>@Configuration</code> annotated with <code>@EnableWebMvc</code>, or alternatively add your own <code>@Configuration</code>-annotated <code>DelegatingWebMvcConfiguration</code> as described in the Javadoc of <code>@EnableWebMvc</code>.</p>
<p><strong>使用</strong> <code>@EnableWebMvc+@Configuration+DelegatingWebMvcConfiguration 全面接管SpringMVC</code></p>
</blockquote>
<h2 id="静态资源规则与定制"><a href="#静态资源规则与定制" class="headerlink" title="静态资源规则与定制"></a>静态资源规则与定制</h2><h3 id="静态资源访问"><a href="#静态资源访问" class="headerlink" title="静态资源访问"></a>静态资源访问</h3><h4 id="静态资源目录"><a href="#静态资源目录" class="headerlink" title="静态资源目录"></a>静态资源目录</h4><blockquote>
<p>By default, Spring Boot serves static content from a directory called <code>/static</code> (or <code>/public</code> or <code>/resources</code> or <code>/META-INF/resources</code>) in the classpath or from the root of the <code>ServletContext</code></p>
<p>默认在类路径下：<code>/static	/public	/resources	/META-INF/resources</code> 的静态资源都能访问。</p>
<p>访问路径：localhost:8080&#x2F;git.jpg</p>
<p>配置默认静态资源路径：</p>
<p>You can also customize the static resource locations by using the <code>spring.web.resources.static-locations</code> property (replacing the default values with a list of directory locations). The root servlet context path, <code>&quot;/&quot;</code>, is automatically added as a location as well.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">    <span class="comment">#静态资源存放位置</span></span><br><span class="line">     <span class="attr">resources:</span></span><br><span class="line">       <span class="attr">static-locations:</span> [<span class="string">classpath:/test</span>]</span><br></pre></td></tr></table></figure>

<p>此时访问路径：localhost:8080&#x2F;git.jpg</p>
<p>此时静态资源放在类路径 &#x2F;test 目录下。</p>
</blockquote>
<h4 id="静态资源访问前缀"><a href="#静态资源访问前缀" class="headerlink" title="静态资源访问前缀"></a>静态资源访问前缀</h4><blockquote>
<p>By default, resources are mapped on <code>/**</code>, but you can tune that with the <code>spring.mvc.static-path-pattern</code> property. For instance, relocating all resources to <code>/resources/**</code> can be achieved as follows:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">    <span class="attr">mvc:</span></span><br><span class="line">       <span class="attr">static-path-pattern:</span> <span class="string">/resources/**</span></span><br></pre></td></tr></table></figure>

<p>此时访问路径：localhost:8080&#x2F;resources&#x2F;git.jpg</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line"></span><br><span class="line">    	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 静态资源映射的是 /**</span></span><br><span class="line"><span class="comment">     * 请求先去找Controller看能不能处理，如果不能，再交给静态资源处理器</span></span><br><span class="line"><span class="comment">     * 如果静态资源Handler不能处理，则报404</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;1.jpg&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello StaticContent!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</blockquote>
<h4 id="webjar"><a href="#webjar" class="headerlink" title="webjar"></a>webjar</h4><blockquote>
<p><strong>webjars 放在 META-INF&#x2F;resources 目录下。</strong></p>
<p>将静态资源以 maven 的形式引入依赖</p>
<p><a target="_blank" rel="noopener" href="https://www.webjars.org/">https://www.webjars.org/</a></p>
<p>To use version agnostic URLs for Webjars, add the <code>webjars-locator-core</code> dependency. Then declare your Webjar. Using jQuery as an example, adding <code>&quot;/webjars/jquery/jquery.min.js&quot;</code> results in <code>&quot;/webjars/jquery/x.y.z/jquery.min.js&quot;</code> where <code>x.y.z</code> is the Webjar version.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.webjars.npm<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jquery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.6.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>重启项目后，访问路径：<a target="_blank" rel="noopener" href="http://localhost:8080/webjars/jquery/3.6.0/dist/jquery.js">http://localhost:8080/webjars/jquery/3.6.0/dist/jquery.js</a></p>
</blockquote>
<h3 id="欢迎页支持"><a href="#欢迎页支持" class="headerlink" title="欢迎页支持"></a>欢迎页支持</h3><blockquote>
<p>Spring Boot supports both static and templated welcome pages. It first looks for an <code>index.html</code> file in the configured static content locations. If one is not found, it then looks for an <code>index</code> template. If either is found, it is automatically used as the welcome page of the application.</p>
</blockquote>
<p>静态资源路径下添加 index.html</p>
<p>注意：</p>
<ul>
<li>可以配置静态资源路径</li>
<li>但是不可以配置静态资源的访问前缀，否则导致 index.html 不能被默认访问</li>
</ul>
<h3 id="自定义-Favicon"><a href="#自定义-Favicon" class="headerlink" title="自定义 Favicon"></a>自定义 Favicon</h3><blockquote>
<p>As with other static resources, Spring Boot checks for a <code>favicon.ico</code> in the configured static content locations. If such a file is present, it is automatically used as the favicon of the application.</p>
</blockquote>
<p>favicon.ico 放在静态资源目录下。</p>
<p>注意：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">mvc:</span></span><br><span class="line">    <span class="comment"># 静态资源访问前缀</span></span><br><span class="line">    <span class="comment"># 这个会导致welcome page和favicon.ico失效</span></span><br><span class="line">    <span class="attr">static-path-pattern:</span> <span class="string">/resources/**</span></span><br></pre></td></tr></table></figure>

<h3 id="静态资源配置原理"><a href="#静态资源配置原理" class="headerlink" title="静态资源配置原理"></a>静态资源配置原理</h3><ul>
<li>SpringBoot 启动默认加载 XXXXAutoConfiguration 自动配置类</li>
<li>SpringMVC 功能的自动配置类 <code>WebMvcAutoConfiguration</code> 生效</li>
</ul>
<blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoConfiguration(after = &#123; DispatcherServletAutoConfiguration.class, TaskExecutionAutoConfiguration.class,</span></span><br><span class="line"><span class="meta">		ValidationAutoConfiguration.class &#125;)</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication(type = Type.SERVLET)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(&#123; Servlet.class, DispatcherServlet.class, WebMvcConfigurer.class &#125;)</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(WebMvcConfigurationSupport.class)</span></span><br><span class="line"><span class="meta">@AutoConfigureOrder(Ordered.HIGHEST_PRECEDENCE + 10)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebMvcAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line">	<span class="meta">@Import(EnableWebMvcConfiguration.class)</span></span><br><span class="line"> <span class="comment">// ==========绑定了两个属性配置类==========</span></span><br><span class="line">	<span class="meta">@EnableConfigurationProperties(&#123; WebMvcProperties.class, WebProperties.class &#125;)</span></span><br><span class="line">	<span class="meta">@Order(0)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">WebMvcAutoConfigurationAdapter</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span>, </span><br><span class="line"> ServletContextAware &#123;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>WebMvcProperties：spring.mvc，WebProperties：spring.web</strong></p>
<p><strong>注意版本差异：WebMvcProperties.class, ResourceProperties.class</strong> </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">mvc:</span></span><br><span class="line">   <span class="comment"># 静态资源访问前缀</span></span><br><span class="line">   <span class="comment"># 这个会导致welcome page和favicon.ico失效</span></span><br><span class="line">   <span class="attr">static-path-pattern:</span> <span class="string">/resources/**</span></span><br><span class="line">   </span><br><span class="line">   <span class="attr">resources:</span></span><br><span class="line">     <span class="comment"># 静态资源访问路径</span></span><br><span class="line">     <span class="attr">static-locations:</span> [<span class="string">classpath:/test</span>]</span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="配置类只有一个有参构造器"><a href="#配置类只有一个有参构造器" class="headerlink" title="配置类只有一个有参构造器"></a>配置类只有一个有参构造器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 有参构造器所有参数的值都会从容器中确定</span></span><br><span class="line"><span class="comment">//方法参数说明：</span></span><br><span class="line"><span class="comment">// WebProperties webProperties：获取和spring.web绑定的所有的值的对象</span></span><br><span class="line"><span class="comment">// WebMvcProperties mvcProperties：获取和spring.mvc绑定的所有的值的对象</span></span><br><span class="line"><span class="comment">// ListableBeanFactory beanFactory：Spring的beanFactory</span></span><br><span class="line"><span class="comment">// HttpMessageConverters：HttpMessageConverters</span></span><br><span class="line"><span class="comment">// ResourceHandlerRegistrationCustomizer：资源处理器的自定义器。</span></span><br><span class="line"><span class="comment">// DispatcherServletPath：servlet路径</span></span><br><span class="line"><span class="comment">// ServletRegistrationBean：给应用注册Servlet、Filter....</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">WebMvcAutoConfigurationAdapter</span><span class="params">(</span></span><br><span class="line"><span class="params">    WebProperties webProperties, WebMvcProperties mvcProperties,</span></span><br><span class="line"><span class="params">    ListableBeanFactory beanFactory, </span></span><br><span class="line"><span class="params">    ObjectProvider&lt;HttpMessageConverters&gt; messageConvertersProvider,</span></span><br><span class="line"><span class="params">    ObjectProvider&lt;ResourceHandlerRegistrationCustomizer&gt; 			resourceHandlerRegistrationCustomizerProvider,</span></span><br><span class="line"><span class="params">    ObjectProvider&lt;DispatcherServletPath&gt; dispatcherServletPath,</span></span><br><span class="line"><span class="params">    ObjectProvider&lt;ServletRegistrationBean&lt;?&gt;&gt; servletRegistrations)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.resourceProperties = webProperties.getResources();</span><br><span class="line">    <span class="built_in">this</span>.mvcProperties = mvcProperties;</span><br><span class="line">    <span class="built_in">this</span>.beanFactory = beanFactory;</span><br><span class="line">    <span class="built_in">this</span>.messageConvertersProvider = messageConvertersProvider;</span><br><span class="line">    <span class="built_in">this</span>.resourceHandlerRegistrationCustomizer = resourceHandlerRegistrationCustomizerProvider.getIfAvailable();</span><br><span class="line">    <span class="built_in">this</span>.dispatcherServletPath = dispatcherServletPath;</span><br><span class="line">    <span class="built_in">this</span>.servletRegistrations = servletRegistrations;</span><br><span class="line">    <span class="built_in">this</span>.mvcProperties.checkConfiguration();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="资源处理的默认规则"><a href="#资源处理的默认规则" class="headerlink" title="资源处理的默认规则"></a>资源处理的默认规则</h4><blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addResourceHandlers</span><span class="params">(ResourceHandlerRegistry registry)</span> &#123;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">// ==========是否禁用静态资源映射规则：spring.web.resources.add-mappings: false==========</span></span><br><span class="line"> <span class="keyword">if</span> (!<span class="built_in">this</span>.resourceProperties.isAddMappings()) &#123;</span><br><span class="line">     logger.debug(<span class="string">&quot;Default resource handling disabled&quot;</span>);</span><br><span class="line">     <span class="keyword">return</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">// ==========webjars的处理规则==========</span></span><br><span class="line"> addResourceHandler(registry, <span class="string">&quot;/webjars/**&quot;</span>, <span class="string">&quot;classpath:/META-INF/resources/webjars/&quot;</span>);</span><br><span class="line"> </span><br><span class="line"> <span class="comment">// ==========静态资源/**的处理规则==========</span></span><br><span class="line"> addResourceHandler(registry, <span class="built_in">this</span>.mvcProperties.getStaticPathPattern(),</span><br><span class="line">                    (registration) -&gt; &#123;</span><br><span class="line">     <span class="comment">// ==========静态资源默认路径：static-locations: [classpath:/test]==========</span></span><br><span class="line">     registration.addResourceLocations(<span class="built_in">this</span>.resourceProperties.getStaticLocations());</span><br><span class="line">         <span class="keyword">if</span> (<span class="built_in">this</span>.servletContext != <span class="literal">null</span>) &#123;</span><br><span class="line">             <span class="type">ServletContextResource</span> <span class="variable">resource</span> <span class="operator">=</span> <span class="keyword">new</span> </span><br><span class="line">                 	<span class="title class_">ServletContextResource</span>(<span class="built_in">this</span>.servletContext, SERVLET_LOCATION);</span><br><span class="line">             registration.addResourceLocations(resource);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addResourceHandler</span><span class="params">(ResourceHandlerRegistry registry, String pattern, String... locations)</span> &#123;</span><br><span class="line"> addResourceHandler(registry, pattern, (registration) -&gt; registration.addResourceLocations(locations));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addResourceHandler</span><span class="params">(ResourceHandlerRegistry registry, String pattern,</span></span><br><span class="line"><span class="params">                             Consumer&lt;ResourceHandlerRegistration&gt; customizer)</span> &#123;</span><br><span class="line"> <span class="keyword">if</span> (registry.hasMappingForPattern(pattern)) &#123;</span><br><span class="line">     <span class="keyword">return</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="type">ResourceHandlerRegistration</span> <span class="variable">registration</span> <span class="operator">=</span> registry.addResourceHandler(pattern);</span><br><span class="line"> customizer.accept(registration);</span><br><span class="line"> </span><br><span class="line"> <span class="comment">// ==========设置静态资源缓存时间：spring.web.resources.cache.period=1000==========</span></span><br><span class="line"> registration.setCachePeriod(getSeconds(<span class="built_in">this</span>.resourceProperties.getCache().getPeriod()));</span><br><span class="line"> registration.setCacheControl(<span class="built_in">this</span>.resourceProperties.getCache().getCachecontrol().toHttpCacheControl());</span><br><span class="line"> registration.setUseLastModified(<span class="built_in">this</span>.resourceProperties.getCache().isUseLastModified());</span><br><span class="line"> customizeResourceHandlerRegistration(registration);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>静态资源默认路径：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] CLASSPATH_RESOURCE_LOCATIONS = &#123; <span class="string">&quot;classpath:/META-INF/resources/&quot;</span>,</span><br><span class="line">		<span class="string">&quot;classpath:/resources/&quot;</span>, <span class="string">&quot;classpath:/static/&quot;</span>, <span class="string">&quot;classpath:/public/&quot;</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Locations of static resources. Defaults to classpath:[/META-INF/resources/,</span></span><br><span class="line"><span class="comment"> * /resources/, /static/, /public/].</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> String[] staticLocations = CLASSPATH_RESOURCE_LOCATIONS;</span><br></pre></td></tr></table></figure>

<p>欢迎页处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">	HandlerMapping：处理器映射。保存了每一个Handler能处理哪些请求。	</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> WelcomePageHandlerMapping <span class="title function_">welcomePageHandlerMapping</span><span class="params">(ApplicationContext applicationContext,</span></span><br><span class="line"><span class="params">				FormattingConversionService mvcConversionService, ResourceUrlProvider mvcResourceUrlProvider)</span> &#123;</span><br><span class="line">			<span class="type">WelcomePageHandlerMapping</span> <span class="variable">welcomePageHandlerMapping</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WelcomePageHandlerMapping</span>(</span><br><span class="line">					<span class="keyword">new</span> <span class="title class_">TemplateAvailabilityProviders</span>(applicationContext), applicationContext, getWelcomePage(),</span><br><span class="line">					<span class="built_in">this</span>.mvcProperties.getStaticPathPattern());</span><br><span class="line">welcomePageHandlerMapping.setInterceptors(getInterceptors(mvcConversionService, mvcResourceUrlProvider));</span><br><span class="line">			welcomePageHandlerMapping.setCorsConfigurations(getCorsConfigurations());</span><br><span class="line">			<span class="keyword">return</span> welcomePageHandlerMapping;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">WelcomePageHandlerMapping(TemplateAvailabilityProviders templateAvailabilityProviders,</span><br><span class="line">			ApplicationContext applicationContext, Resource welcomePage, String staticPathPattern) &#123;</span><br><span class="line">    <span class="comment">// ==========欢迎页功能，必须是/**==========</span></span><br><span class="line">		<span class="keyword">if</span> (welcomePage != <span class="literal">null</span> &amp;&amp; <span class="string">&quot;/**&quot;</span>.equals(staticPathPattern)) &#123;</span><br><span class="line">			logger.info(<span class="string">&quot;Adding welcome page: &quot;</span> + welcomePage);</span><br><span class="line">			setRootViewName(<span class="string">&quot;forward:index.html&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (welcomeTemplateExists(templateAvailabilityProviders, applicationContext)) &#123;</span><br><span class="line">			logger.info(<span class="string">&quot;Adding welcome page template: index&quot;</span>);</span><br><span class="line">			setRootViewName(<span class="string">&quot;index&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="请求参数处理"><a href="#请求参数处理" class="headerlink" title="请求参数处理"></a>请求参数处理</h2><h3 id="Restful-请求与原理"><a href="#Restful-请求与原理" class="headerlink" title="Restful 请求与原理"></a>Restful 请求与原理</h3><h4 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h4><blockquote>
<p>Restful 风格支持：使用 **HTTP **请求方式动词来表示对资源的操作</p>
<p>GET（获取）	POST（提交）	DELETE（删除）	PUT（修改）</p>
<p>页面表单只支持 GET 请求（默认）和 POST 请求，如果要支持其他请求方式，则应该开启 HiddenHttpMethodFilter</p>
<p>核心 Filter：HiddenHttpMethodFilter</p>
<p><strong>Restful 使用：</strong></p>
<ol>
<li>开启配置</li>
<li>表单提交方式：post，同时提交隐藏域参数：_method （指定请求方法名）</li>
<li>默认不开启：如微服务、Postman 等可以直接发送 put、delete 请求，而 web 表单只能发送 get、post 请求</li>
<li>如果不开启：put&#x2F;delete 请求会走 post 路线或者 get 路线（版本差异）</li>
</ol>
<p>示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">mvc:</span></span><br><span class="line">    <span class="comment"># rest支持</span></span><br><span class="line">    <span class="comment"># 默认不开启：如微服务、Postman等可以直接发送put、delete请求，而web表单只能发送get、post请求</span></span><br><span class="line">    <span class="attr">hiddenmethod:</span></span><br><span class="line">      <span class="attr">filter:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>index.html：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>测试REST风格<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/user&quot;</span> <span class="attr">method</span>=<span class="string">&quot;get&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">&quot;REST-GET 提交&quot;</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/user&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">&quot;REST-POST 提交&quot;</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/user&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;_method&quot;</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">value</span>=<span class="string">&quot;delete&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;_m&quot;</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">value</span>=<span class="string">&quot;delete&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">&quot;REST-DELETE 提交&quot;</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/user&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;_method&quot;</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">value</span>=<span class="string">&quot;PUT&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">&quot;REST-PUT 提交&quot;</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>controller：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @RequestMapping(value = &quot;/user&quot;, method = RequestMethod.GET)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getUser</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;GET-USER&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/user&quot;, method = RequestMethod.POST)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">postUser</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;POST-USER&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/user&quot;, method = RequestMethod.PUT)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">putUser</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;PUT-USER&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/user&quot;, method = RequestMethod.DELETE)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">deleteUser</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;DELETE-USER&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</blockquote>
<h4 id="Rest原理"><a href="#Rest原理" class="headerlink" title="Rest原理"></a>Rest原理</h4><blockquote>
<p>WebMvcAutoConfiguration：</p>
<ul>
<li><strong>请求过来被</strong> HiddenHttpMethodFilter 拦截</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(HiddenHttpMethodFilter.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(prefix = &quot;spring.mvc.hiddenmethod.filter&quot;, name = &quot;enabled&quot;)</span></span><br><span class="line"><span class="keyword">public</span> OrderedHiddenHttpMethodFilter <span class="title function_">hiddenHttpMethodFilter</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OrderedHiddenHttpMethodFilter</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderedHiddenHttpMethodFilter</span> <span class="keyword">extends</span> <span class="title class_">HiddenHttpMethodFilter</span> <span class="keyword">implements</span> <span class="title class_">OrderedFilter</span> &#123;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>HiddenHttpMethodFilter 源码：</p>
<ul>
<li>支持的请求方式：HttpMethod.PUT.name()，HttpMethod.DELETE.name()，HttpMethod.PATCH.name()</li>
<li>表单携带的隐藏参数：_method</li>
<li>对于原生 request，使用 HttpMethodRequestWrapper 进行包装，<strong>重写了 getMethod( ) 方法</strong>，拦截器放行的也是 HttpMethodRequestWrapper 对象。</li>
<li>如果需要改变 _method 名称，则使用 @Bean 给容器中放入一个HiddenHttpMethodFilter</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HiddenHttpMethodFilter</span> <span class="keyword">extends</span> <span class="title class_">OncePerRequestFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;String&gt; ALLOWED_METHODS =</span><br><span class="line">			Collections.unmodifiableList(Arrays.asList(HttpMethod.PUT.name(),</span><br><span class="line">					HttpMethod.DELETE.name(), HttpMethod.PATCH.name()));</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Default method parameter: &#123;<span class="doctag">@code</span> _method&#125;. */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_METHOD_PARAM</span> <span class="operator">=</span> <span class="string">&quot;_method&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="type">String</span> <span class="variable">methodParam</span> <span class="operator">=</span> DEFAULT_METHOD_PARAM;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Set the parameter name to look for HTTP methods.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@see</span> #DEFAULT_METHOD_PARAM</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMethodParam</span><span class="params">(String methodParam)</span> &#123;</span><br><span class="line">		Assert.hasText(methodParam, <span class="string">&quot;&#x27;methodParam&#x27; must not be empty&quot;</span>);</span><br><span class="line">		<span class="built_in">this</span>.methodParam = methodParam;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span></span><br><span class="line">			<span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line"></span><br><span class="line">		<span class="type">HttpServletRequest</span> <span class="variable">requestToUse</span> <span class="operator">=</span> request;</span><br><span class="line">		<span class="comment">// ===========请求必须是POST请求，并且参数为_method==========</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="string">&quot;POST&quot;</span>.equals(request.getMethod()) &amp;&amp; request.getAttribute(WebUtils.ERROR_EXCEPTION_ATTRIBUTE) == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="type">String</span> <span class="variable">paramValue</span> <span class="operator">=</span> request.getParameter(<span class="built_in">this</span>.methodParam);</span><br><span class="line">			<span class="keyword">if</span> (StringUtils.hasLength(paramValue)) &#123;</span><br><span class="line">				<span class="type">String</span> <span class="variable">method</span> <span class="operator">=</span> paramValue.toUpperCase(Locale.ENGLISH);</span><br><span class="line">				<span class="keyword">if</span> (ALLOWED_METHODS.contains(method)) &#123;</span><br><span class="line">					requestToUse = <span class="keyword">new</span> <span class="title class_">HttpMethodRequestWrapper</span>(request, method);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// ==========拦截器放行的是 HttpMethodRequestWrapper==========</span></span><br><span class="line">		filterChain.doFilter(requestToUse, response);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 重写了getMethod()方法，返回的是传入的method</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">HttpMethodRequestWrapper</span> <span class="keyword">extends</span> <span class="title class_">HttpServletRequestWrapper</span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">final</span> String method;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">public</span> <span class="title function_">HttpMethodRequestWrapper</span><span class="params">(HttpServletRequest request, String method)</span> &#123;</span><br><span class="line">			<span class="built_in">super</span>(request);</span><br><span class="line">			<span class="built_in">this</span>.method = method;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="keyword">public</span> String <span class="title function_">getMethod</span><span class="params">()</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">this</span>.method;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>改变 _method 名称：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.springboot.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.HiddenHttpMethodFilter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Rest 改变默认的_method名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> HiddenHttpMethodFilter <span class="title function_">hiddenHttpMethodFilter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">HiddenHttpMethodFilter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HiddenHttpMethodFilter</span>();</span><br><span class="line">        filter.setMethodParam(<span class="string">&quot;_m&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> filter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="comment">// ==========@ConditionalOnMissingBean==========</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(HiddenHttpMethodFilter.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(prefix = &quot;spring.mvc.hiddenmethod.filter&quot;, name = &quot;enabled&quot;)</span></span><br><span class="line"><span class="keyword">public</span> OrderedHiddenHttpMethodFilter <span class="title function_">hiddenHttpMethodFilter</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OrderedHiddenHttpMethodFilter</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="请求映射原理"><a href="#请求映射原理" class="headerlink" title="请求映射原理"></a>请求映射原理</h3><blockquote>
<p>该部分主要分析具体的请求被哪一个 Controller 的方法处理。</p>
<p>SpringMVC 功能分析从： org.springframework.web.servlet.DispatcherServlet –&gt; doDispatch( ) 方法开始。</p>
<p>所有的请求映射都在 HandlerMapping 中，首先遍历所有的 HandlerMapping </p>
<p><img src="/2023/03/14/SpringBoot2/%E8%AF%B7%E6%B1%82%E6%98%A0%E5%B0%84%E5%8E%9F%E7%90%86HandlerMappings.png" alt="请求映射原理HandlerMappings.png"></p>
<p>其中<strong>RequestMappingHandlerMapping</strong>：保存了所有 @RequestMapping 和 handler 的映射规则。</p>
<ul>
<li><p>SpringBoot自动配置欢迎页的 WelcomePageHandlerMapping 。访问  &#x2F;  能访问到 index.html；</p>
</li>
<li><p>SpringBoot自动配置了默认的 <strong>RequestMappingHandlerMapping</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@Primary</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> RequestMappingHandlerMapping <span class="title function_">requestMappingHandlerMapping</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="meta">@Qualifier(&quot;mvcContentNegotiationManager&quot;)</span> ContentNegotiationManager contentNegotiationManager,</span></span><br><span class="line"><span class="params">    <span class="meta">@Qualifier(&quot;mvcConversionService&quot;)</span> FormattingConversionService conversionService,</span></span><br><span class="line"><span class="params">    <span class="meta">@Qualifier(&quot;mvcResourceUrlProvider&quot;)</span> ResourceUrlProvider resourceUrlProvider)</span> &#123;</span><br><span class="line">    <span class="comment">// Must be @Primary for MvcUriComponentsBuilder to work</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>.requestMappingHandlerMapping(</span><br><span class="line">        contentNegotiationManager, </span><br><span class="line">        conversionService,</span><br><span class="line">        resourceUrlProvider);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</li>
<li><p>请求进来会遍历所有的 HandlerMapping 查看是否有请求信息。</p>
<ul>
<li>如果有就找到这个请求对应的 handler</li>
<li>如果没有就是下一个 HandlerMapping</li>
</ul>
</li>
<li><p>如果需要一些自定义的映射处理，可以给容器中放自定义的 <strong>HandlerMapping</strong>。</p>
</li>
</ul>
</blockquote>
<blockquote>
<p>DispatcherServlet：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DispatcherServlet</span> <span class="keyword">extends</span> <span class="title class_">FrameworkServlet</span> &#123;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">FrameworkServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServletBean</span> <span class="keyword">implements</span> <span class="title class_">ApplicationContextAware</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span><br><span class="line">			<span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line"></span><br><span class="line">		processRequest(request, response);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span><br><span class="line">			<span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">		processRequest(request, response);</span><br><span class="line">	&#125;</span><br><span class="line">    	<span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">processRequest</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span><br><span class="line">			<span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			doService(request, response);</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">HttpServletBean</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> <span class="keyword">implements</span> <span class="title class_">EnvironmentCapable</span>, EnvironmentAware &#123;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doService</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">		doDispatch(request, response);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p><strong>doDispatch(request, response); 方法用于处理请求和响应。</strong></p>
</blockquote>
<p><strong>doDispatch方法：</strong></p>
<blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doDispatch</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="type">HttpServletRequest</span> <span class="variable">processedRequest</span> <span class="operator">=</span> request;</span><br><span class="line">		<span class="type">HandlerExecutionChain</span> <span class="variable">mappedHandler</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">		<span class="type">boolean</span> <span class="variable">multipartRequestParsed</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">		<span class="type">WebAsyncManager</span> <span class="variable">asyncManager</span> <span class="operator">=</span> WebAsyncUtils.getAsyncManager(request);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="type">ModelAndView</span> <span class="variable">mv</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">			<span class="type">Exception</span> <span class="variable">dispatchException</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				processedRequest = checkMultipart(request);</span><br><span class="line">				multipartRequestParsed = (processedRequest != request);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Determine handler for the current request.</span></span><br><span class="line">                <span class="comment">// ==========解析请求对应的方法（handler）=========</span></span><br><span class="line">				mappedHandler = getHandler(processedRequest);</span><br><span class="line">				<span class="keyword">if</span> (mappedHandler == <span class="literal">null</span>) &#123;</span><br><span class="line">					noHandlerFound(processedRequest, response);</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				&#125;</span><br></pre></td></tr></table></figure>

<p><strong>getHandler方法：</strong></p>
<p>该方法会从所有的 HandlerMapping 中查找 HandlerMapping，执行 getHandler 方法，返回执行器链</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">protected</span> HandlerExecutionChain <span class="title function_">getHandler</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"> <span class="keyword">if</span> (<span class="built_in">this</span>.handlerMappings != <span class="literal">null</span>) &#123;</span><br><span class="line">     <span class="keyword">for</span> (HandlerMapping mapping : <span class="built_in">this</span>.handlerMappings) &#123;</span><br><span class="line">         <span class="type">HandlerExecutionChain</span> <span class="variable">handler</span> <span class="operator">=</span> mapping.getHandler(request);</span><br><span class="line">         <span class="keyword">if</span> (handler != <span class="literal">null</span>) &#123;</span><br><span class="line">             <span class="keyword">return</span> handler;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>HandlerMapping 接口：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HandlerMapping</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="type">String</span> <span class="variable">BEST_MATCHING_HANDLER_ATTRIBUTE</span> <span class="operator">=</span> HandlerMapping.class.getName() + <span class="string">&quot;.bestMatchingHandler&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">String</span> <span class="variable">LOOKUP_PATH</span> <span class="operator">=</span> HandlerMapping.class.getName() + <span class="string">&quot;.lookupPath&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">String</span> <span class="variable">PATH_WITHIN_HANDLER_MAPPING_ATTRIBUTE</span> <span class="operator">=</span> HandlerMapping.class.getName() + <span class="string">&quot;.pathWithinHandlerMapping&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">String</span> <span class="variable">BEST_MATCHING_PATTERN_ATTRIBUTE</span> <span class="operator">=</span> HandlerMapping.class.getName() + <span class="string">&quot;.bestMatchingPattern&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">String</span> <span class="variable">INTROSPECT_TYPE_LEVEL_MAPPING</span> <span class="operator">=</span> HandlerMapping.class.getName() + <span class="string">&quot;.introspectTypeLevelMapping&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">String</span> <span class="variable">URI_TEMPLATE_VARIABLES_ATTRIBUTE</span> <span class="operator">=</span> HandlerMapping.class.getName() + <span class="string">&quot;.uriTemplateVariables&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">String</span> <span class="variable">MATRIX_VARIABLES_ATTRIBUTE</span> <span class="operator">=</span> HandlerMapping.class.getName() + <span class="string">&quot;.matrixVariables&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">String</span> <span class="variable">PRODUCIBLE_MEDIA_TYPES_ATTRIBUTE</span> <span class="operator">=</span> HandlerMapping.class.getName() + <span class="string">&quot;.producibleMediaTypes&quot;</span>;</span><br><span class="line">xception <span class="keyword">if</span> there is an internal error</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	HandlerExecutionChain <span class="title function_">getHandler</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>AbstractHandlerMapping：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> HandlerExecutionChain <span class="title function_">getHandler</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"> <span class="comment">// ==========com.example.springboot.controller.RestfulTestController#getUser()=======</span></span><br><span class="line"> <span class="type">Object</span> <span class="variable">handler</span> <span class="operator">=</span> getHandlerInternal(request);</span><br><span class="line"> <span class="keyword">if</span> (handler == <span class="literal">null</span>) &#123;</span><br><span class="line">     handler = getDefaultHandler();</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">if</span> (handler == <span class="literal">null</span>) &#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p><strong>getHandlerInternal：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">protected</span> HandlerMethod <span class="title function_">getHandlerInternal</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"> <span class="comment">// ==========从请求中获取路径，返回：/user==========</span></span><br><span class="line"> <span class="type">String</span> <span class="variable">lookupPath</span> <span class="operator">=</span> initLookupPath(request);</span><br><span class="line"> <span class="built_in">this</span>.mappingRegistry.acquireReadLock();</span><br><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line">     <span class="comment">// ========根据路径获取所有的方法========</span></span><br><span class="line">     <span class="type">HandlerMethod</span> <span class="variable">handlerMethod</span> <span class="operator">=</span> lookupHandlerMethod(lookupPath, request);</span><br><span class="line">     <span class="keyword">return</span> (handlerMethod != <span class="literal">null</span> ? handlerMethod.createWithResolvedBean() : <span class="literal">null</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">finally</span> &#123;</span><br><span class="line">     <span class="built_in">this</span>.mappingRegistry.releaseReadLock();</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>initLookupPath：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> String <span class="title function_">initLookupPath</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line"> <span class="keyword">if</span> (usesPathPatterns()) &#123;</span><br><span class="line">     request.removeAttribute(UrlPathHelper.PATH_ATTRIBUTE);</span><br><span class="line">     <span class="type">RequestPath</span> <span class="variable">requestPath</span> <span class="operator">=</span> ServletRequestPathUtils.getParsedRequestPath(request);</span><br><span class="line">     <span class="type">String</span> <span class="variable">lookupPath</span> <span class="operator">=</span> requestPath.pathWithinApplication().value();</span><br><span class="line">     <span class="keyword">return</span> UrlPathHelper.defaultInstance.removeSemicolonContent(lookupPath);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="keyword">return</span> getUrlPathHelper().resolveAndCacheLookupPath(request);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>lookupHandlerMethod：</strong></p>
<p>返回值：com.example.springboot.controller.RestfulTestController#getUser()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">protected</span> HandlerMethod <span class="title function_">lookupHandlerMethod</span><span class="params">(String lookupPath, HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	List&lt;Match&gt; matches = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">       <span class="comment">//======返回 /user 所匹配的所有路径======</span></span><br><span class="line">	List&lt;T&gt; directPathMatches = <span class="built_in">this</span>.mappingRegistry.getMappingsByDirectPath(lookupPath);</span><br><span class="line">	<span class="keyword">if</span> (directPathMatches != <span class="literal">null</span>) &#123;</span><br><span class="line">		addMatchingMappings(directPathMatches, matches, request);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (matches.isEmpty()) &#123;</span><br><span class="line">		addMatchingMappings(<span class="built_in">this</span>.mappingRegistry.getRegistrations().keySet(), matches, request);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!matches.isEmpty()) &#123;</span><br><span class="line">        </span><br><span class="line">       <span class="comment">// ======如果有多个方法，首先获取第一个，然后根据request请求方法（get/post...）二次匹配</span></span><br><span class="line">		<span class="type">Match</span> <span class="variable">bestMatch</span> <span class="operator">=</span> matches.get(<span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (matches.size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">			Comparator&lt;Match&gt; comparator = <span class="keyword">new</span> <span class="title class_">MatchComparator</span>(getMappingComparator(request));</span><br><span class="line">			matches.sort(comparator);</span><br><span class="line">			bestMatch = matches.get(<span class="number">0</span>);</span><br><span class="line">			<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">				logger.trace(matches.size() + <span class="string">&quot; matching mappings: &quot;</span> + matches);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (CorsUtils.isPreFlightRequest(request)) &#123;</span><br><span class="line">				<span class="keyword">for</span> (Match match : matches) &#123;</span><br><span class="line">					<span class="keyword">if</span> (match.hasCorsConfig()) &#123;</span><br><span class="line">						<span class="keyword">return</span> PREFLIGHT_AMBIGUOUS_MATCH;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="type">Match</span> <span class="variable">secondBestMatch</span> <span class="operator">=</span> matches.get(<span class="number">1</span>);</span><br><span class="line">				<span class="keyword">if</span> (comparator.compare(bestMatch, secondBestMatch) == <span class="number">0</span>) &#123;</span><br><span class="line">					<span class="type">Method</span> <span class="variable">m1</span> <span class="operator">=</span> bestMatch.getHandlerMethod().getMethod();</span><br><span class="line">					<span class="type">Method</span> <span class="variable">m2</span> <span class="operator">=</span> secondBestMatch.getHandlerMethod().getMethod();</span><br><span class="line">					<span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> request.getRequestURI();</span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(</span><br><span class="line">							<span class="string">&quot;Ambiguous handler methods mapped for &#x27;&quot;</span> + uri + <span class="string">&quot;&#x27;: &#123;&quot;</span> + m1 + <span class="string">&quot;, &quot;</span> + m2 + <span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="基本注解使用"><a href="#基本注解使用" class="headerlink" title="基本注解使用"></a>基本注解使用</h3><p><strong>@PathVariable、@RequestHeader、@ModelAttribute、@RequestParam、@MatrixVariable、@CookieValue、@RequestBody</strong></p>
<blockquote>
<p>index.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>测试基本注解<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;car/3/owner/lisi?age=18&amp;inters=basketball&amp;inters=game&quot;</span>&gt;</span>car/&#123;id&#125;/owner/&#123;username&#125;?...<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">li</span>&gt;</span>@PathVariable（路径变量）<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">li</span>&gt;</span>@RequestHeader（获取请求头）<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">li</span>&gt;</span>@RequestParam（获取请求参数）<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">li</span>&gt;</span>@CookieValue（获取cookie值）<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">li</span>&gt;</span>@RequestBody（获取请求体[POST]）<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">li</span>&gt;</span>@RequestAttribute（获取request域属性）<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">li</span>&gt;</span>@MatrixVariable（矩阵变量）<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"></span><br><span class="line">/cars/&#123;path&#125;?xxx=xxx&amp;aaa=ccc queryString 查询字符串。@RequestParam；<span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">/cars/sell;low=34;brand=byd,audi,yd  ；矩阵变量 <span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">页面开发，cookie禁用了，session里面的内容怎么使用；</span><br><span class="line">session.set(a,b)---&gt; jsessionid ---&gt; cookie ----&gt; 每次发请求携带</span><br><span class="line">url重写：/abc;jsesssionid=xxxx 把cookie的值使用矩阵变量的方式进行传递</span><br><span class="line"></span><br><span class="line">/boss/1/2</span><br><span class="line">/boss/1;age=20/2;age=20</span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/cars/sell;low=34;brand=byd,audi,yd&quot;</span>&gt;</span>@MatrixVariable（矩阵变量）<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/cars/sell;low=34;brand=byd;brand=audi;brand=yd&quot;</span>&gt;</span>@MatrixVariable（矩阵变量）<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/boss/1;age=20/2;age=10&quot;</span>&gt;</span>@MatrixVariable（矩阵变量）/boss/&#123;bossId&#125;/&#123;empId&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/save&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line"> 测试@RequestBody获取数据 <span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line"> 用户名：<span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;userName&quot;</span>/&gt;</span> <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"> 邮箱：<span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;email&quot;</span>/&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ol</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">li</span>&gt;</span>矩阵变量需要在SpringBoot中手动开启<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">li</span>&gt;</span>根据RFC3986的规范，矩阵变量应当绑定在路径变量中！<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">li</span>&gt;</span>若是有多个矩阵变量，应当使用英文符号;进行分隔。<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">li</span>&gt;</span>若是一个矩阵变量有多个值，应当使用英文符号,进行分隔，或之命名多个重复的key即可。<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">li</span>&gt;</span>如：/cars/sell;low=34;brand=byd,audi,yd<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ol</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>controller：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ParameterTestController</span> &#123;</span><br><span class="line"> <span class="comment">// car/3/owner/lisi?age=18&amp;inters=basketball&amp;inters=game</span></span><br><span class="line"> <span class="meta">@GetMapping(&quot;car/&#123;id&#125;/owner/&#123;username&#125;&quot;)</span></span><br><span class="line"> <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">getCar</span><span class="params">(</span></span><br><span class="line"><span class="params">         <span class="meta">@PathVariable(&quot;id&quot;)</span> String id,</span></span><br><span class="line"><span class="params">         <span class="meta">@PathVariable(&quot;username&quot;)</span> String name,</span></span><br><span class="line"><span class="params">         <span class="meta">@PathVariable</span> Map&lt;String, String&gt; map,</span></span><br><span class="line"><span class="params">         <span class="meta">@RequestHeader(&quot;User-Agent&quot;)</span> String userAgent,</span></span><br><span class="line"><span class="params">         <span class="meta">@RequestHeader</span> Map&lt;String, String&gt; header,</span></span><br><span class="line"><span class="params">         <span class="meta">@RequestParam(&quot;age&quot;)</span> Integer age,</span></span><br><span class="line"><span class="params">         <span class="meta">@RequestParam(&quot;inters&quot;)</span> List&lt;String&gt; inters,</span></span><br><span class="line"><span class="params">         <span class="meta">@RequestParam</span> Map&lt;String, String&gt; params,</span></span><br><span class="line"><span class="params">         <span class="meta">@CookieValue(value = &quot;_ga&quot;,required = false)</span> String _ga,</span></span><br><span class="line"><span class="params">         <span class="meta">@CookieValue(value = &quot;_ga&quot;,required = false)</span> Cookie cookie</span></span><br><span class="line"><span class="params"> )</span> &#123;</span><br><span class="line">     HashMap&lt;String, Object&gt; resultMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">     resultMap.put(<span class="string">&quot;id&quot;</span>, id);</span><br><span class="line">     resultMap.put(<span class="string">&quot;name&quot;</span>, name);</span><br><span class="line">     resultMap.put(<span class="string">&quot;pv&quot;</span>, map);</span><br><span class="line">     resultMap.put(<span class="string">&quot;userAgent&quot;</span>, userAgent);</span><br><span class="line">     resultMap.put(<span class="string">&quot;headers&quot;</span>, header);</span><br><span class="line">     resultMap.put(<span class="string">&quot;age&quot;</span>, age);</span><br><span class="line">     resultMap.put(<span class="string">&quot;inters&quot;</span>, inters);</span><br><span class="line">     resultMap.put(<span class="string">&quot;params&quot;</span>, params);</span><br><span class="line">     <span class="comment">// resultMap.put(&quot;_ga&quot;, _ga);</span></span><br><span class="line">     <span class="comment">// System.out.println(cookie.getName() + &quot;====&quot; + cookie.getValue());</span></span><br><span class="line">     <span class="keyword">return</span> resultMap;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@PostMapping(&quot;save&quot;)</span></span><br><span class="line"> <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">postMethod</span><span class="params">(<span class="meta">@RequestBody</span> String content)</span> &#123;</span><br><span class="line">     Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">     System.out.println(content);</span><br><span class="line">     map.put(<span class="string">&quot;content&quot;</span>, content);</span><br><span class="line">     <span class="keyword">return</span> map;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> 	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 矩阵变量：</span></span><br><span class="line"><span class="comment">     * 1. 语法：请求路径：/cars/sell;low=34;brand=byd,audi,yd</span></span><br><span class="line"><span class="comment">     * 2. SpringBoot默认是禁用了矩阵变量的功能</span></span><br><span class="line"><span class="comment">     *      手动开启：原理：对于路径的处理，由UrlPathHelper进行解析</span></span><br><span class="line"><span class="comment">     *          removeSemicolonContent（移除分号内容）支持矩阵变量的</span></span><br><span class="line"><span class="comment">     * 3. 矩阵变量必须有url路径变量才能被解析</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/cars/&#123;path&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">carsSell</span><span class="params">(<span class="meta">@MatrixVariable(&quot;low&quot;)</span> Integer low,</span></span><br><span class="line"><span class="params">                        <span class="meta">@MatrixVariable(&quot;brand&quot;)</span> List&lt;String&gt; brand</span></span><br><span class="line"><span class="params">                        //<span class="meta">@PathVariable(&quot;path&quot;)</span> String path</span></span><br><span class="line"><span class="params">    )</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;low&quot;</span>, low);</span><br><span class="line">        map.put(<span class="string">&quot;brand&quot;</span>, brand);</span><br><span class="line">        <span class="comment">// map.put(&quot;path&quot;, path);</span></span><br><span class="line">        <span class="comment">// &#123;&quot;path&quot;:&quot;sell&quot;,&quot;low&quot;:34,&quot;brand&quot;:[&quot;byd&quot;,&quot;audi&quot;,&quot;yd&quot;]&#125;</span></span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// /boss/1;age=20/2;age=10</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/boss/&#123;bossId&#125;/&#123;empId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">boss</span><span class="params">(<span class="meta">@MatrixVariable(value = &quot;age&quot;, pathVar = &quot;bossId&quot;)</span> Integer bossAge,</span></span><br><span class="line"><span class="params">                    <span class="meta">@MatrixVariable(value = &quot;age&quot;, pathVar = &quot;empId&quot;)</span> Integer empAge)</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;bossAge&quot;</span>, bossAge);</span><br><span class="line">        map.put(<span class="string">&quot;empAge&quot;</span>, empAge);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>测试 @RequestAttribute 注解：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试 <span class="doctag">@RequestAttribute</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RequestAttributeTestController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/goto&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">goToPage</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        request.setAttribute(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;request message&quot;</span>);</span><br><span class="line">        request.setAttribute(<span class="string">&quot;info&quot;</span>, <span class="string">&quot;request info&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;forward:/success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试 <span class="doctag">@RequestAttribute</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/success&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">success</span><span class="params">(<span class="meta">@RequestAttribute(&quot;message&quot;)</span> String message,</span></span><br><span class="line"><span class="params">                       <span class="meta">@RequestAttribute(&quot;info&quot;)</span> String info,</span></span><br><span class="line"><span class="params">                       HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            原生方式获取转发中的 request 对象</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">msg</span> <span class="operator">=</span> request.getAttribute(<span class="string">&quot;message&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">tip</span> <span class="operator">=</span> request.getAttribute(<span class="string">&quot;info&quot;</span>);</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;message&quot;</span>, message);</span><br><span class="line">        map.put(<span class="string">&quot;info&quot;</span>, info);</span><br><span class="line">        map.put(<span class="string">&quot;msg&quot;</span>, msg);</span><br><span class="line">        map.put(<span class="string">&quot;tip&quot;</span>, tip);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>矩阵变量：</strong></p>
<ul>
<li><p>通过分号在 URL 地址栏进行传值。</p>
<p>  页面开发，cookie禁用了，session里面的内容怎么使用？<br>  session.set(a, b)	—&gt;	jsessionid	—&gt;	cookie	—-&gt;	每次发请求携带<br>  URL 重写：&#x2F;abc;jsesssionid&#x3D;xxxx 把 cookie 的值使用矩阵变量的方式进行传递</p>
</li>
<li><p>SpringBoot默认是禁用了矩阵变量的功能</p>
<p>  手动开启：对于路径的处理，由 <code>UrlPathHelper</code> 进行解析</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//========UrlPathHelper负责路径解析=====</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configurePathMatch</span><span class="params">(PathMatchConfigurer configurer)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    configurer.setUseSuffixPatternMatch(<span class="built_in">this</span>.mvcProperties.getPathmatch().isUseSuffixPattern());</span><br><span class="line">        configurer.setUseRegisteredSuffixPatternMatch(</span><br><span class="line">            <span class="built_in">this</span>.mvcProperties.getPathmatch().isUseRegisteredSuffixPattern());</span><br><span class="line">        <span class="built_in">this</span>.dispatcherServletPath.ifAvailable((dispatcherPath) -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">servletUrlMapping</span> <span class="operator">=</span> dispatcherPath.getServletUrlMapping();</span><br><span class="line">            <span class="keyword">if</span> (servletUrlMapping.equals(<span class="string">&quot;/&quot;</span>) &amp;&amp; singleDispatcherServlet()) &#123;</span><br><span class="line">                <span class="type">UrlPathHelper</span> <span class="variable">urlPathHelper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UrlPathHelper</span>();</span><br><span class="line">                urlPathHelper.setAlwaysUseFullPath(<span class="literal">true</span>);</span><br><span class="line">                configurer.setUrlPathHelper(urlPathHelper);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UrlPathHelper</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">WEBSPHERE_URI_ATTRIBUTE</span> <span class="operator">=</span> </span><br><span class="line">        <span class="string">&quot;com.ibm.websphere.servlet.uri_non_decoded&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Log</span> <span class="variable">logger</span> <span class="operator">=</span> LogFactory.getLog(UrlPathHelper.class);</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">volatile</span> Boolean websphereComplianceFlag;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">alwaysUseFullPath</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">urlDecode</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">//======是否移除分号======</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">removeSemicolonContent</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>removeSemicolonContent（移除分号内容）支持矩阵变量的</p>
<p>  矩阵变量必须有 url 路径变量才能被解析</p>
</li>
</ul>
<p><strong>开启矩阵变量：</strong></p>
<ul>
<li>方式一：自定义配置类实现 WebMvcConfigurer 接口的 configurePathMatch 方法</li>
<li>方式二：使用@Bean注入 WebMvcConfigurer</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.springboot.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.HiddenHttpMethodFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.PathMatchConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.util.UrlPathHelper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> &#123;</span><br><span class="line"><span class="comment">//public class WebConfig implements WebMvcConfigurer &#123;</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Rest 改变默认的 _method 名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> HiddenHttpMethodFilter <span class="title function_">hiddenHttpMethodFilter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">HiddenHttpMethodFilter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HiddenHttpMethodFilter</span>();</span><br><span class="line">        filter.setMethodParam(<span class="string">&quot;_m&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> filter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开启矩阵变量：</span></span><br><span class="line"><span class="comment">     * 方式一：实现WebMvcConfigurer接口</span></span><br><span class="line"><span class="comment">     * 方式二：使用<span class="doctag">@Bean</span>注入</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">/*@Override</span></span><br><span class="line"><span class="comment">    public void configurePathMatch(PathMatchConfigurer configurer) &#123;</span></span><br><span class="line"><span class="comment">        UrlPathHelper urlPathHelper = new UrlPathHelper();</span></span><br><span class="line"><span class="comment">        urlPathHelper.setRemoveSemicolonContent(false);</span></span><br><span class="line"><span class="comment">        configurer.setUrlPathHelper(urlPathHelper);</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> WebMvcConfigurer <span class="title function_">webMvcConfigurer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WebMvcConfigurer</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configurePathMatch</span><span class="params">(PathMatchConfigurer configurer)</span> &#123;</span><br><span class="line">                <span class="type">UrlPathHelper</span> <span class="variable">urlPathHelper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UrlPathHelper</span>();</span><br><span class="line">                urlPathHelper.setRemoveSemicolonContent(<span class="literal">false</span>);</span><br><span class="line">                configurer.setUrlPathHelper(urlPathHelper);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="各种类型参数解析原理"><a href="#各种类型参数解析原理" class="headerlink" title="各种类型参数解析原理"></a>各种类型参数解析原理</h3><p>doDispatch方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Determine handler adapter for the current request.</span></span><br><span class="line"><span class="type">HandlerAdapter</span> <span class="variable">ha</span> <span class="operator">=</span> getHandlerAdapter(mappedHandler.getHandler());</span><br><span class="line"><span class="comment">// Process last-modified header, if supported by the handler.</span></span><br><span class="line"><span class="type">String</span> <span class="variable">method</span> <span class="operator">=</span> request.getMethod();</span><br><span class="line"><span class="type">boolean</span> <span class="variable">isGet</span> <span class="operator">=</span> HttpMethod.GET.matches(method);</span><br><span class="line"><span class="keyword">if</span> (isGet || HttpMethod.HEAD.matches(method)) &#123;</span><br><span class="line"> <span class="type">long</span> <span class="variable">lastModified</span> <span class="operator">=</span> ha.getLastModified(request, mappedHandler.getHandler());</span><br><span class="line"> <span class="keyword">if</span> (<span class="keyword">new</span> <span class="title class_">ServletWebRequest</span>(request, response).checkNotModified(lastModified) &amp;&amp; isGet) 		&#123;</span><br><span class="line">     <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!mappedHandler.applyPreHandle(processedRequest, response)) &#123;</span><br><span class="line"> <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Actually invoke the handler.</span></span><br><span class="line">mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>HandlerAdapter  ha  &#x3D;  getHandlerAdapter(mappedHandler.getHandler( ));	</p>
<p><strong>先确定使用那种 HandlerAdapter，即决定处理的类型</strong></p>
<p>默认的几种 HandlerAdapter：</p>
<p><img src="/2023/03/14/SpringBoot2/%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90HandlerAdapter.png" alt="参数解析HandlerAdapter.png"></p>
<ul>
<li><p>RequestMappingHandlerAdapter：处理@RequestMapping</p>
</li>
<li><p>HandlerFunctionAdapter：处理函数式响应</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HandlerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="type">boolean</span> <span class="title function_">supports</span><span class="params">(Object handler)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	ModelAndView <span class="title function_">handle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Deprecated</span></span><br><span class="line">	<span class="type">long</span> <span class="title function_">getLastModified</span><span class="params">(HttpServletRequest request, Object handler)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>supports 方法：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">supports</span><span class="params">(Object handler)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (handler <span class="keyword">instanceof</span> HandlerMethod </span><br><span class="line">            &amp;&amp; supportsInternal((HandlerMethod) handler));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行 Handler：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Actually invoke the handler.HandlerAdapter ha;</span></span><br><span class="line">mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</span><br></pre></td></tr></table></figure>

<p><strong>AbstractHandlerMethodAdapter：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> ModelAndView <span class="title function_">handle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span></span><br><span class="line">		<span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> handleInternal(request, response, (HandlerMethod) handler);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> ModelAndView <span class="title function_">handleInternal</span><span class="params">(HttpServletRequest request,</span></span><br><span class="line"><span class="params">		HttpServletResponse response, HandlerMethod handlerMethod)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>RequestMappingHandlerAdapter：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> ModelAndView <span class="title function_">handleInternal</span><span class="params">(HttpServletRequest request,</span></span><br><span class="line"><span class="params">                                   HttpServletResponse response, HandlerMethod handlerMethod)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"> ModelAndView mav;</span><br><span class="line"> checkRequest(request);</span><br><span class="line"> <span class="comment">// Execute invokeHandlerMethod in synchronized block if required.</span></span><br><span class="line"> <span class="keyword">if</span> (<span class="built_in">this</span>.synchronizeOnSession) &#123;</span><br><span class="line">     <span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> request.getSession(<span class="literal">false</span>);</span><br><span class="line">     <span class="keyword">if</span> (session != <span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="type">Object</span> <span class="variable">mutex</span> <span class="operator">=</span> WebUtils.getSessionMutex(session);</span><br><span class="line">         <span class="keyword">synchronized</span> (mutex) &#123;</span><br><span class="line">             mav = invokeHandlerMethod(request, response, handlerMethod);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="comment">// No HttpSession available -&gt; no mutex necessary</span></span><br><span class="line">         mav = invokeHandlerMethod(request, response, handlerMethod);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="comment">// No synchronization on session demanded at all...</span></span><br><span class="line">     <span class="comment">//========执行========</span></span><br><span class="line">     mav = invokeHandlerMethod(request, response, handlerMethod);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">// .....</span></span><br><span class="line"> <span class="keyword">return</span> mav;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ModelAndView mav &#x3D; invokeHandlerMethod(request, response, handlerMethod);</p>
<p>其中 ServletInvocableHandlerMethod invocableMethod &#x3D; createInvocableHandlerMethod(handlerMethod);</p>
<p>对找到的请求方法进行包装，并设置它的参数解析器和返回值处理器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">protected</span> ModelAndView <span class="title function_">invokeHandlerMethod</span><span class="params">(HttpServletRequest request,</span></span><br><span class="line"><span class="params">                                        HttpServletResponse response, HandlerMethod handlerMethod)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"> <span class="type">ServletWebRequest</span> <span class="variable">webRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletWebRequest</span>(request, response);</span><br><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line">     <span class="type">WebDataBinderFactory</span> <span class="variable">binderFactory</span> <span class="operator">=</span> getDataBinderFactory(handlerMethod);</span><br><span class="line">     <span class="type">ModelFactory</span> <span class="variable">modelFactory</span> <span class="operator">=</span> getModelFactory(handlerMethod, binderFactory);</span><br><span class="line">     <span class="type">ServletInvocableHandlerMethod</span> <span class="variable">invocableMethod</span> <span class="operator">=</span> createInvocableHandlerMethod(handlerMethod);</span><br><span class="line">     <span class="comment">// ========参数解析器=========</span></span><br><span class="line">     <span class="keyword">if</span> (<span class="built_in">this</span>.argumentResolvers != <span class="literal">null</span>) &#123;</span><br><span class="line">         invocableMethod.setHandlerMethodArgumentResolvers(<span class="built_in">this</span>.argumentResolvers);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// // ========返回值处理器=========</span></span><br><span class="line">     <span class="keyword">if</span> (<span class="built_in">this</span>.returnValueHandlers != <span class="literal">null</span>) &#123;</span><br><span class="line">        invocableMethod.setHandlerMethodReturnValueHandlers(<span class="built_in">this</span>.returnValueHandlers);</span><br><span class="line">     &#125;</span><br><span class="line">     invocableMethod.setDataBinderFactory(binderFactory);</span><br><span class="line">     invocableMethod.setParameterNameDiscoverer(<span class="built_in">this</span>.parameterNameDiscoverer);</span><br><span class="line"></span><br><span class="line">     <span class="type">ModelAndViewContainer</span> <span class="variable">mavContainer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndViewContainer</span>();</span><br><span class="line">     mavContainer.addAllAttributes(RequestContextUtils.getInputFlashMap(request));</span><br><span class="line">     modelFactory.initModel(webRequest, mavContainer, invocableMethod);</span><br><span class="line">     mavContainer.setIgnoreDefaultModelOnRedirect(<span class="built_in">this</span>.ignoreDefaultModelOnRedirect);</span><br><span class="line"></span><br><span class="line">     <span class="type">AsyncWebRequest</span> <span class="variable">asyncWebRequest</span> <span class="operator">=</span> WebAsyncUtils.createAsyncWebRequest(request, response);</span><br><span class="line">     asyncWebRequest.setTimeout(<span class="built_in">this</span>.asyncRequestTimeout);</span><br><span class="line"></span><br><span class="line">     <span class="type">WebAsyncManager</span> <span class="variable">asyncManager</span> <span class="operator">=</span> WebAsyncUtils.getAsyncManager(request);</span><br><span class="line">     asyncManager.setTaskExecutor(<span class="built_in">this</span>.taskExecutor);</span><br><span class="line">     asyncManager.setAsyncWebRequest(asyncWebRequest);</span><br><span class="line">     asyncManager.registerCallableInterceptors(<span class="built_in">this</span>.callableInterceptors);</span><br><span class="line">     asyncManager.registerDeferredResultInterceptors(<span class="built_in">this</span>.deferredResultInterceptors);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (asyncManager.hasConcurrentResult()) &#123;</span><br><span class="line">         <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> asyncManager.getConcurrentResult();</span><br><span class="line">         mavContainer = (ModelAndViewContainer) asyncManager.getConcurrentResultContext()[<span class="number">0</span>];</span><br><span class="line">         asyncManager.clearConcurrentResult();</span><br><span class="line">         LogFormatUtils.traceDebug(logger, traceOn -&gt; &#123;</span><br><span class="line">             <span class="type">String</span> <span class="variable">formatted</span> <span class="operator">=</span> LogFormatUtils.formatValue(result, !traceOn);</span><br><span class="line">             <span class="keyword">return</span> <span class="string">&quot;Resume with async result [&quot;</span> + formatted + <span class="string">&quot;]&quot;</span>;</span><br><span class="line">         &#125;);</span><br><span class="line">         invocableMethod = invocableMethod.wrapConcurrentResult(result);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// =========执行目标方法=========</span></span><br><span class="line">     invocableMethod.invokeAndHandle(webRequest, mavContainer);</span><br><span class="line">     <span class="keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> getModelAndView(mavContainer, modelFactory, webRequest);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">finally</span> &#123;</span><br><span class="line">     webRequest.requestCompleted();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p><strong>参数解析器：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HandlerMethodArgumentResolver</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="type">boolean</span> <span class="title function_">supportsParameter</span><span class="params">(MethodParameter parameter)</span>;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Nullable</span></span><br><span class="line"> Object <span class="title function_">resolveArgument</span><span class="params">(</span></span><br><span class="line"><span class="params">     </span></span><br><span class="line"><span class="params">     MethodParameter parameter, </span></span><br><span class="line"><span class="params">     <span class="meta">@Nullable</span> ModelAndViewContainer mavContainer, </span></span><br><span class="line"><span class="params">     NativeWebRequest webRequest,</span></span><br><span class="line"><span class="params">     <span class="meta">@Nullable</span> WebDataBinderFactory binderFactory)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/03/14/SpringBoot2/%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90%E5%99%A8.png" alt="参数解析器.png"></p>
<p><strong>返回值处理器：</strong></p>
<p><img src="/2023/03/14/SpringBoot2/%E8%BF%94%E5%9B%9E%E5%80%BC%E5%A4%84%E7%90%86%E5%99%A8.png" alt="返回值处理器.png"></p>
<p>参数解析器和返回值处理器都会封装到 <strong>invocableMethod</strong> 中。</p>
<p>invocableMethod.invokeAndHandle(webRequest, mavContainer);</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invokeAndHandle</span><span class="params">(ServletWebRequest webRequest, ModelAndViewContainer mavContainer,Object... providedArgs)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	<span class="comment">// ===========invokeForRequest：解析参数,给代理handler方法赋值，执行handler方法============</span></span><br><span class="line"> <span class="type">Object</span> <span class="variable">returnValue</span> <span class="operator">=</span> invokeForRequest(webRequest, mavContainer, providedArgs);</span><br><span class="line"> setResponseStatus(webRequest);</span><br><span class="line">	</span><br><span class="line"> <span class="keyword">if</span> (returnValue == <span class="literal">null</span>) &#123;</span><br><span class="line">     <span class="keyword">if</span> (isRequestNotModified(webRequest) || getResponseStatus() != <span class="literal">null</span> || mavContainer.isRequestHandled()) &#123;</span><br><span class="line">         disableContentCachingIfNecessary(webRequest);</span><br><span class="line">         mavContainer.setRequestHandled(<span class="literal">true</span>);</span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">else</span> <span class="keyword">if</span> (StringUtils.hasText(getResponseStatusReason())) &#123;</span><br><span class="line">     mavContainer.setRequestHandled(<span class="literal">true</span>);</span><br><span class="line">     <span class="keyword">return</span>;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> mavContainer.setRequestHandled(<span class="literal">false</span>);</span><br><span class="line"> Assert.state(<span class="built_in">this</span>.returnValueHandlers != <span class="literal">null</span>, <span class="string">&quot;No return value handlers&quot;</span>);</span><br><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line">     <span class="built_in">this</span>.returnValueHandlers.handleReturnValue(</span><br><span class="line">         returnValue, getReturnValueType(returnValue), mavContainer, webRequest);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">     <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">         logger.trace(formatErrorForReturnValue(returnValue), ex);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">throw</span> ex;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Object returnValue &#x3D; invokeForRequest(webRequest, mavContainer, providedArgs);</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">invokeForRequest</span><span class="params">(NativeWebRequest request, <span class="meta">@Nullable</span> ModelAndViewContainer mavContainer,Object... providedArgs)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	<span class="comment">// ===========返回参数值的数组：已经解析完成==========</span></span><br><span class="line"> Object[] args = getMethodArgumentValues(request, mavContainer, providedArgs);</span><br><span class="line"> <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">     logger.trace(<span class="string">&quot;Arguments: &quot;</span> + Arrays.toString(args));</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> doInvoke(args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Object[] args &#x3D; getMethodArgumentValues(request, mavContainer, providedArgs);</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object[] getMethodArgumentValues(NativeWebRequest request, <span class="meta">@Nullable</span> ModelAndViewContainer mavContainer,Object... providedArgs) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"> MethodParameter[] parameters = getMethodParameters();</span><br><span class="line"> <span class="keyword">if</span> (ObjectUtils.isEmpty(parameters)) &#123;</span><br><span class="line">     <span class="keyword">return</span> EMPTY_ARGS;</span><br><span class="line"> &#125;</span><br><span class="line"> Object[] args = <span class="keyword">new</span> <span class="title class_">Object</span>[parameters.length];</span><br><span class="line"> <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; parameters.length; i++) &#123;</span><br><span class="line">     <span class="type">MethodParameter</span> <span class="variable">parameter</span> <span class="operator">=</span> parameters[i];</span><br><span class="line">     parameter.initParameterNameDiscovery(<span class="built_in">this</span>.parameterNameDiscoverer);</span><br><span class="line">     args[i] = findProvidedArgument(parameter, providedArgs);</span><br><span class="line">     <span class="keyword">if</span> (args[i] != <span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="keyword">continue</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span> (!<span class="built_in">this</span>.resolvers.supportsParameter(parameter)) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(formatArgumentError(parameter, <span class="string">&quot;No suitable resolver&quot;</span>));</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="comment">// =============由参数解析器进行解析封装==============</span></span><br><span class="line">         args[i] = <span class="built_in">this</span>.resolvers.resolveArgument(parameter, mavContainer, request, <span class="built_in">this</span>.dataBinderFactory);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">         <span class="comment">// Leave stack trace for later, exception may actually be resolved and handled...</span></span><br><span class="line">         <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">             <span class="type">String</span> <span class="variable">exMsg</span> <span class="operator">=</span> ex.getMessage();</span><br><span class="line">             <span class="keyword">if</span> (exMsg != <span class="literal">null</span> &amp;&amp; !exMsg.contains(parameter.getExecutable().toGenericString())) &#123;</span><br><span class="line">                 logger.debug(formatArgumentError(parameter, exMsg));</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">throw</span> ex;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> args;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>args[i] &#x3D; this.resolvers.resolveArgument(parameter, mavContainer, request, this.dataBinderFactory);</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">resolveArgument</span><span class="params">(MethodParameter parameter, <span class="meta">@Nullable</span> ModelAndViewContainer mavContainer,NativeWebRequest webRequest, <span class="meta">@Nullable</span> WebDataBinderFactory binderFactory)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	<span class="comment">// 在所有的参数解析器中找到每一个参数详细信息（注解，类型，位置等）对应的resolver</span></span><br><span class="line"> <span class="type">HandlerMethodArgumentResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> getArgumentResolver(parameter);</span><br><span class="line"> <span class="keyword">if</span> (resolver == <span class="literal">null</span>) &#123;</span><br><span class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Unsupported parameter type [&quot;</span> +</span><br><span class="line">                                        parameter.getParameterType().getName() + <span class="string">&quot;]. supportsParameter should be called first.&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">// ===========拿到相应的参数解析器后，解析参数===========</span></span><br><span class="line"> <span class="keyword">return</span> resolver.resolveArgument(parameter, mavContainer, webRequest, binderFactory);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>HandlerMethodArgumentResolver resolver &#x3D; getArgumentResolver(parameter);</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">private</span> HandlerMethodArgumentResolver <span class="title function_">getArgumentResolver</span><span class="params">(MethodParameter parameter)</span> &#123;</span><br><span class="line"> <span class="comment">// ===========先从缓存中查找===========</span></span><br><span class="line"> <span class="type">HandlerMethodArgumentResolver</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">this</span>.argumentResolverCache.get(parameter);</span><br><span class="line"> <span class="keyword">if</span> (result == <span class="literal">null</span>) &#123;</span><br><span class="line">     <span class="keyword">for</span> (HandlerMethodArgumentResolver resolver : <span class="built_in">this</span>.argumentResolvers) &#123;</span><br><span class="line">         <span class="comment">// =========判断是否支持某种解析器：是否有相应注解等===========</span></span><br><span class="line">         <span class="keyword">if</span> (resolver.supportsParameter(parameter)) &#123;</span><br><span class="line">             result = resolver;</span><br><span class="line">             <span class="comment">// =============找到后放入缓存==============</span></span><br><span class="line">             <span class="built_in">this</span>.argumentResolverCache.put(parameter, result);</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如@PathVariable注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PathVariableMapMethodArgumentResolver</span> <span class="keyword">implements</span> <span class="title class_">HandlerMethodArgumentResolver</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">supportsParameter</span><span class="params">(MethodParameter parameter)</span> &#123;</span><br><span class="line">     <span class="comment">// =========判断是否有@PathVariable========</span></span><br><span class="line">     <span class="type">PathVariable</span> <span class="variable">ann</span> <span class="operator">=</span> parameter.getParameterAnnotation(PathVariable.class);</span><br><span class="line">     <span class="keyword">return</span> (ann != <span class="literal">null</span> &amp;&amp; Map.class.isAssignableFrom(parameter.getParameterType()) &amp;&amp;</span><br><span class="line">             !StringUtils.hasText(ann.value()));</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>参数解析器解析参数：</p>
<p>resolver.resolveArgument(parameter, mavContainer, webRequest, binderFactory);</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title function_">resolveArgument</span><span class="params">(MethodParameter parameter, <span class="meta">@Nullable</span> ModelAndViewContainer mavContainer, NativeWebRequest webRequest, <span class="meta">@Nullable</span> WebDataBinderFactory binderFactory)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"> <span class="type">NamedValueInfo</span> <span class="variable">namedValueInfo</span> <span class="operator">=</span> getNamedValueInfo(parameter);</span><br><span class="line"> <span class="type">MethodParameter</span> <span class="variable">nestedParameter</span> <span class="operator">=</span> parameter.nestedIfOptional();</span><br><span class="line"> </span><br><span class="line"> <span class="type">Object</span> <span class="variable">resolvedName</span> <span class="operator">=</span> resolveEmbeddedValuesAndExpressions(namedValueInfo.name);</span><br><span class="line"> <span class="keyword">if</span> (resolvedName == <span class="literal">null</span>) &#123;</span><br><span class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(</span><br><span class="line">         <span class="string">&quot;Specified name must not resolve to null: [&quot;</span> + namedValueInfo.name + <span class="string">&quot;]&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line">	<span class="comment">// =========得到参数：如@PathVariable解析路径的值==========</span></span><br><span class="line"> <span class="type">Object</span> <span class="variable">arg</span> <span class="operator">=</span> resolveName(resolvedName.toString(), nestedParameter, webRequest);</span><br><span class="line"> <span class="keyword">if</span> (arg == <span class="literal">null</span>) &#123;</span><br></pre></td></tr></table></figure>

<p>最终得到所有的参数值：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">invokeForRequest</span><span class="params">(NativeWebRequest request, <span class="meta">@Nullable</span> ModelAndViewContainer mavContainer,Object... providedArgs)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	<span class="comment">// ===========返回参数值的数组：已经解析完成==========</span></span><br><span class="line"> Object[] args = getMethodArgumentValues(request, mavContainer, providedArgs);</span><br><span class="line"> <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">     logger.trace(<span class="string">&quot;Arguments: &quot;</span> + Arrays.toString(args));</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">// ==========通过反射给代理的方法参数赋值并返回 handler 的返回值============</span></span><br><span class="line"> <span class="keyword">return</span> doInvoke(args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>doInvoke(args);</p>
<blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==========通过反射给代理的方法参数赋值============</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">protected</span> Object <span class="title function_">doInvoke</span><span class="params">(Object... args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"> <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> getBridgedMethod();</span><br><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line">     <span class="keyword">if</span> (KotlinDetector.isSuspendingFunction(method)) &#123;</span><br><span class="line">         <span class="keyword">return</span> CoroutinesUtils.invokeSuspendingFunction(method, getBean(), args);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> method.invoke(getBean(), args);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

</blockquote>
<p>并执行 handler 方法，返回方法值。</p>
<h3 id="ServletAPI"><a href="#ServletAPI" class="headerlink" title="ServletAPI"></a>ServletAPI</h3><blockquote>
<p>WebRequest、ServletRequest、MultipartRequest、 HttpSession、javax.servlet.http.PushBuilder、Principal、InputStream、Reader、HttpMethod、Locale、TimeZone、ZoneId</p>
</blockquote>
<p>基本示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/goto&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">goToPage</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    request.setAttribute(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;request message&quot;</span>);</span><br><span class="line">    request.setAttribute(<span class="string">&quot;info&quot;</span>, <span class="string">&quot;request info&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;forward:/success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于原生的 ServletAPI 使用：<strong>ServletRequestMethodArgumentResolver</strong> 参数解析器进行参数解析</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">supportsParameter</span><span class="params">(MethodParameter parameter)</span> &#123;</span><br><span class="line"> Class&lt;?&gt; paramType = parameter.getParameterType();</span><br><span class="line"> <span class="keyword">return</span> (WebRequest.class.isAssignableFrom(paramType) ||</span><br><span class="line">         ServletRequest.class.isAssignableFrom(paramType) ||</span><br><span class="line">         MultipartRequest.class.isAssignableFrom(paramType) ||</span><br><span class="line">         HttpSession.class.isAssignableFrom(paramType) ||</span><br><span class="line">         (pushBuilder != <span class="literal">null</span> &amp;&amp; pushBuilder.isAssignableFrom(paramType)) ||</span><br><span class="line">         Principal.class.isAssignableFrom(paramType) ||</span><br><span class="line">         InputStream.class.isAssignableFrom(paramType) ||</span><br><span class="line">         Reader.class.isAssignableFrom(paramType) ||</span><br><span class="line">         HttpMethod.class == paramType ||</span><br><span class="line">         Locale.class == paramType ||</span><br><span class="line">         TimeZone.class == paramType ||</span><br><span class="line">         ZoneId.class == paramType);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="复杂参数"><a href="#复杂参数" class="headerlink" title="复杂参数"></a>复杂参数</h3><ul>
<li><strong>Map、Model（Map、Model里面的数据会被放在 request 的请求域中：request.setAttribute）</strong></li>
<li>Errors&#x2F;BindingResult</li>
<li><strong>RedirectAttributes（ 重定向携带数据）</strong></li>
<li><strong>ServletResponse（response）</strong></li>
<li>SessionStatus</li>
<li>UriComponentsBuilder</li>
<li>ServletUriComponentsBuilder</li>
</ul>
<p><strong>使用示例：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/params&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">params</span><span class="params">(Map&lt;String, Object&gt; map,</span></span><br><span class="line"><span class="params">                     Model model,</span></span><br><span class="line"><span class="params">                     HttpServletRequest request,</span></span><br><span class="line"><span class="params">                     HttpServletResponse response)</span> &#123;</span><br><span class="line">    map.put(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;SpringBoot&quot;</span>);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;B&quot;</span>, <span class="string">&quot;SpringMVC&quot;</span>);</span><br><span class="line">    request.setAttribute(<span class="string">&quot;C&quot;</span>, <span class="string">&quot;Spring&quot;</span>);</span><br><span class="line">    <span class="type">Cookie</span> <span class="variable">cookie</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cookie</span>(<span class="string">&quot;c1&quot;</span>, <span class="string">&quot;v1&quot;</span>);</span><br><span class="line">    response.addCookie(cookie);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;forward:/success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="复杂参数解析原理"><a href="#复杂参数解析原理" class="headerlink" title="复杂参数解析原理"></a>复杂参数解析原理</h3><p><strong>Map、Model类型的参数</strong></p>
<p>Map 和 Model 类型的参数分别由 MapMethodProcessor 和 ModelMethodProcessor进行解析，其中</p>
<p>对应的参数解析器会返回 BindingAwareModelMap &#x3D; mavContainer.getModel(); 既是 Model 也是 Map。</p>
<p>ModelAndViewContainer.getModel( )</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ModelMap</span> <span class="variable">defaultModel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BindingAwareModelMap</span>();</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BindingAwareModelMap</span> <span class="keyword">extends</span> <span class="title class_">ExtendedModelMap</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExtendedModelMap</span> <span class="keyword">extends</span> <span class="title class_">ModelMap</span> <span class="keyword">implements</span> <span class="title class_">Model</span> &#123;</span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ModelMap</span> <span class="keyword">extends</span> <span class="title class_">LinkedHashMap</span>&lt;String, Object&gt; &#123;</span><br></pre></td></tr></table></figure>

<p><strong>Map 类型：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MapMethodProcessor</span> <span class="keyword">implements</span> <span class="title class_">HandlerMethodArgumentResolver</span>, HandlerMethodReturnValueHandler &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">supportsParameter</span><span class="params">(MethodParameter parameter)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> Map.class.isAssignableFrom(parameter.getParameterType()) &amp;&amp;</span><br><span class="line">				parameter.getParameterAnnotations().length == <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="keyword">public</span> Object <span class="title function_">resolveArgument</span><span class="params">(MethodParameter parameter, <span class="meta">@Nullable</span> ModelAndViewContainer mavContainer,</span></span><br><span class="line"><span class="params">			NativeWebRequest webRequest, <span class="meta">@Nullable</span> WebDataBinderFactory binderFactory)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">		Assert.state(mavContainer != <span class="literal">null</span>, <span class="string">&quot;ModelAndViewContainer is required for model exposure&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> mavContainer.getModel();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Model 类型：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ModelMethodProcessor</span> <span class="keyword">implements</span> <span class="title class_">HandlerMethodArgumentResolver</span>, HandlerMethodReturnValueHandler &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">supportsParameter</span><span class="params">(MethodParameter parameter)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> Model.class.isAssignableFrom(parameter.getParameterType());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="keyword">public</span> Object <span class="title function_">resolveArgument</span><span class="params">(MethodParameter parameter, <span class="meta">@Nullable</span> ModelAndViewContainer mavContainer,</span></span><br><span class="line"><span class="params">			NativeWebRequest webRequest, <span class="meta">@Nullable</span> WebDataBinderFactory binderFactory)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">		Assert.state(mavContainer != <span class="literal">null</span>, <span class="string">&quot;ModelAndViewContainer is required for model exposure&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> mavContainer.getModel();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>目标方法执行完成后，处理返回结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invokeAndHandle</span><span class="params">(ServletWebRequest webRequest, ModelAndViewContainer mavContainer,</span></span><br><span class="line"><span class="params">		Object... providedArgs)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">	<span class="type">Object</span> <span class="variable">returnValue</span> <span class="operator">=</span> invokeForRequest(webRequest, mavContainer, providedArgs);</span><br><span class="line">	setResponseStatus(webRequest);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (returnValue == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (isRequestNotModified(webRequest) || getResponseStatus() != <span class="literal">null</span> || mavContainer.isRequestHandled()) &#123;</span><br><span class="line">			disableContentCachingIfNecessary(webRequest);</span><br><span class="line">			mavContainer.setRequestHandled(<span class="literal">true</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (StringUtils.hasText(getResponseStatusReason())) &#123;</span><br><span class="line">		mavContainer.setRequestHandled(<span class="literal">true</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	mavContainer.setRequestHandled(<span class="literal">false</span>);</span><br><span class="line">	Assert.state(<span class="built_in">this</span>.returnValueHandlers != <span class="literal">null</span>, <span class="string">&quot;No return value handlers&quot;</span>);</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">//==========处理返回结果，将Model和Map中的数据放入request中==========</span></span><br><span class="line">		<span class="built_in">this</span>.returnValueHandlers.handleReturnValue(</span><br><span class="line">				returnValue, getReturnValueType(returnValue), mavContainer, webRequest);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">		<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">			logger.trace(formatErrorForReturnValue(returnValue), ex);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">throw</span> ex;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>handleReturnValue：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleReturnValue</span><span class="params">(<span class="meta">@Nullable</span> Object returnValue, MethodParameter returnType,</span></span><br><span class="line"><span class="params">		ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	<span class="comment">//==========拿到返回值处理器==========</span></span><br><span class="line">	<span class="type">HandlerMethodReturnValueHandler</span> <span class="variable">handler</span> <span class="operator">=</span> selectHandler(returnValue, returnType);</span><br><span class="line">	<span class="keyword">if</span> (handler == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Unknown return value type: &quot;</span> + returnType.getParameterType().getName());</span><br><span class="line">	&#125;</span><br><span class="line">	handler.handleReturnValue(returnValue, returnType, mavContainer, webRequest);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">private</span> HandlerMethodReturnValueHandler <span class="title function_">selectHandler</span><span class="params">(<span class="meta">@Nullable</span> Object value, MethodParameter returnType)</span> &#123;</span><br><span class="line">	<span class="type">boolean</span> <span class="variable">isAsyncValue</span> <span class="operator">=</span> isAsyncReturnValue(value, returnType);</span><br><span class="line">	<span class="keyword">for</span> (HandlerMethodReturnValueHandler handler : <span class="built_in">this</span>.returnValueHandlers) &#123;</span><br><span class="line">		<span class="keyword">if</span> (isAsyncValue &amp;&amp; !(handler <span class="keyword">instanceof</span> AsyncHandlerMethodReturnValueHandler)) &#123;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (handler.supportsReturnType(returnType)) &#123;</span><br><span class="line">			<span class="keyword">return</span> handler;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">invocableMethod.invokeAndHandle(webRequest, mavContainer);</span><br><span class="line"><span class="keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> getModelAndView(mavContainer, modelFactory, webRequest);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">finally</span> &#123;</span><br><span class="line">    webRequest.requestCompleted();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>getModelAndView(mavContainer, modelFactory, webRequest);</p>
<p>将 BindingAwareModelMap  中的数据 ModelAndViewContainer 中，最后再放入  ModelAndView 中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">private</span> ModelAndView <span class="title function_">getModelAndView</span><span class="params">(ModelAndViewContainer mavContainer,</span></span><br><span class="line"><span class="params">		ModelFactory modelFactory, NativeWebRequest webRequest)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	<span class="comment">//==========更新Model==========</span></span><br><span class="line">	modelFactory.updateModel(webRequest, mavContainer);</span><br><span class="line">	<span class="keyword">if</span> (mavContainer.isRequestHandled()) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">ModelMap</span> <span class="variable">model</span> <span class="operator">=</span> mavContainer.getModel();</span><br><span class="line">	<span class="type">ModelAndView</span> <span class="variable">mav</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>(mavContainer.getViewName(), model, mavContainer.getStatus());</span><br><span class="line">	<span class="keyword">if</span> (!mavContainer.isViewReference()) &#123;</span><br><span class="line">		mav.setView((View) mavContainer.getView());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (model <span class="keyword">instanceof</span> RedirectAttributes) &#123;</span><br><span class="line">		Map&lt;String, ?&gt; flashAttributes = ((RedirectAttributes) model).getFlashAttributes();</span><br><span class="line">		<span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> webRequest.getNativeRequest(HttpServletRequest.class);</span><br><span class="line">		<span class="keyword">if</span> (request != <span class="literal">null</span>) &#123;</span><br><span class="line">			RequestContextUtils.getOutputFlashMap(request).putAll(flashAttributes);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> mav;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>udpateModel：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateModel</span><span class="params">(NativeWebRequest request, ModelAndViewContainer container)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	<span class="type">ModelMap</span> <span class="variable">defaultModel</span> <span class="operator">=</span> container.getDefaultModel();</span><br><span class="line">	<span class="keyword">if</span> (container.getSessionStatus().isComplete())&#123;</span><br><span class="line">		<span class="built_in">this</span>.sessionAttributesHandler.cleanupAttributes(request);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.sessionAttributesHandler.storeAttributes(request, defaultModel);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!container.isRequestHandled() &amp;&amp; container.getModel() == defaultModel) &#123;</span><br><span class="line">		updateBindingResult(request, defaultModel);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>updateBindingResult(request, defaultModel);</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateBindingResult</span><span class="params">(NativeWebRequest request, ModelMap model)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	List&lt;String&gt; keyNames = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(model.keySet());</span><br><span class="line">	<span class="keyword">for</span> (String name : keyNames) &#123;</span><br><span class="line">		<span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> model.get(name);</span><br><span class="line">		<span class="keyword">if</span> (value != <span class="literal">null</span> &amp;&amp; isBindingCandidate(name, value)) &#123;</span><br><span class="line">			<span class="type">String</span> <span class="variable">bindingResultKey</span> <span class="operator">=</span> BindingResult.MODEL_KEY_PREFIX + name;</span><br><span class="line">			<span class="keyword">if</span> (!model.containsAttribute(bindingResultKey)) &#123;</span><br><span class="line">				<span class="type">WebDataBinder</span> <span class="variable">dataBinder</span> <span class="operator">=</span> <span class="built_in">this</span>.dataBinderFactory.createBinder(request, value, name);</span><br><span class="line">				model.put(bindingResultKey, dataBinder.getBindingResult());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>渲染视图时处理数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processDispatchResult</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span><br><span class="line"><span class="params">		<span class="meta">@Nullable</span> HandlerExecutionChain mappedHandler, <span class="meta">@Nullable</span> ModelAndView mv,</span></span><br><span class="line"><span class="params">		<span class="meta">@Nullable</span> Exception exception)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">	<span class="type">boolean</span> <span class="variable">errorView</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (exception != <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (exception <span class="keyword">instanceof</span> ModelAndViewDefiningException) &#123;</span><br><span class="line">			logger.debug(<span class="string">&quot;ModelAndViewDefiningException encountered&quot;</span>, exception);</span><br><span class="line">			mv = ((ModelAndViewDefiningException) exception).getModelAndView();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="type">Object</span> <span class="variable">handler</span> <span class="operator">=</span> (mappedHandler != <span class="literal">null</span> ? mappedHandler.getHandler() : <span class="literal">null</span>);</span><br><span class="line">			mv = processHandlerException(request, response, handler, exception);</span><br><span class="line">			errorView = (mv != <span class="literal">null</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Did the handler return a view to render?</span></span><br><span class="line">	<span class="keyword">if</span> (mv != <span class="literal">null</span> &amp;&amp; !mv.wasCleared()) &#123;</span><br><span class="line">		render(mv, request, response);</span><br><span class="line">		<span class="keyword">if</span> (errorView) &#123;</span><br><span class="line">			WebUtils.clearErrorRequestAttributes(request);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">			logger.trace(<span class="string">&quot;No view rendering, null ModelAndView returned.&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">render</span><span class="params">(<span class="meta">@Nullable</span> Map&lt;String, ?&gt; model, HttpServletRequest request,</span></span><br><span class="line"><span class="params">		HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">		logger.debug(<span class="string">&quot;View &quot;</span> + formatViewName() +</span><br><span class="line">				<span class="string">&quot;, model &quot;</span> + (model != <span class="literal">null</span> ? model : Collections.emptyMap()) +</span><br><span class="line">				(<span class="built_in">this</span>.staticAttributes.isEmpty() ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;, static attributes &quot;</span> + <span class="built_in">this</span>.staticAttributes));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	Map&lt;String, Object&gt; mergedModel = createMergedOutputModel(model, request, response);</span><br><span class="line">	prepareResponse(request, response);</span><br><span class="line">	renderMergedOutputModel(mergedModel, getRequestToExpose(request), response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>renderMergedOutputModel(mergedModel, getRequestToExpose(request), response);</p>
<p>转发操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">renderMergedOutputModel</span><span class="params">(</span></span><br><span class="line"><span class="params">		Map&lt;String, Object&gt; model, HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Expose the model object as request attributes.</span></span><br><span class="line">	exposeModelAsRequestAttributes(model, request);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Expose helpers as request attributes, if any.</span></span><br><span class="line">	exposeHelpers(request);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Determine the path for the request dispatcher.</span></span><br><span class="line">	<span class="type">String</span> <span class="variable">dispatcherPath</span> <span class="operator">=</span> prepareForRendering(request, response);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Obtain a RequestDispatcher for the target resource (typically a JSP).</span></span><br><span class="line">	<span class="type">RequestDispatcher</span> <span class="variable">rd</span> <span class="operator">=</span> getRequestDispatcher(request, dispatcherPath);</span><br><span class="line">	<span class="keyword">if</span> (rd == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(<span class="string">&quot;Could not get RequestDispatcher for [&quot;</span> + getUrl() +</span><br><span class="line">				<span class="string">&quot;]: Check that the corresponding file exists within your web application archive!&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If already included or response already committed, perform include, else forward.</span></span><br><span class="line">	<span class="keyword">if</span> (useInclude(request, response)) &#123;</span><br><span class="line">		response.setContentType(getContentType());</span><br><span class="line">		<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">			logger.debug(<span class="string">&quot;Including [&quot;</span> + getUrl() + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		rd.include(request, response);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// Note: The forwarded resource is supposed to determine the content type itself.</span></span><br><span class="line">		<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">			logger.debug(<span class="string">&quot;Forwarding to [&quot;</span> + getUrl() + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		rd.forward(request, response);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>将 Model 中的数据存入 request 请求域中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">exposeModelAsRequestAttributes</span><span class="params">(Map&lt;String, Object&gt; model,</span></span><br><span class="line"><span class="params">		HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">	model.forEach((name, value) -&gt; &#123;</span><br><span class="line">		<span class="keyword">if</span> (value != <span class="literal">null</span>) &#123;</span><br><span class="line">			request.setAttribute(name, value);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			request.removeAttribute(name);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>即最终是在跳转之前将 Model 中的数据放入 request 请求域中。</strong></p>
<h3 id="POJO-参数"><a href="#POJO-参数" class="headerlink" title="POJO 参数"></a>POJO 参数</h3><p>代码示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> Date date;</span><br><span class="line">    <span class="keyword">private</span> Pet pet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Pet</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>index.html</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/saveUser&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    姓名： <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;userName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;zhangsan&quot;</span>/&gt;</span> <span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">    年龄： <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;age&quot;</span> <span class="attr">value</span>=<span class="string">&quot;18&quot;</span>/&gt;</span> <span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">    生日： <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;birth&quot;</span> <span class="attr">value</span>=<span class="string">&quot;2019/12/10&quot;</span>/&gt;</span> <span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    宠物姓名：&lt;input name=&quot;pet.name&quot; value=&quot;阿猫&quot;/&gt;&lt;br/&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    宠物年龄：&lt;input name=&quot;pet.age&quot; value=&quot;5&quot;/&gt;--&gt;</span></span><br><span class="line">    宠物： <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;pet&quot;</span> <span class="attr">value</span>=<span class="string">&quot;啊猫,3&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;保存&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>controller</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/saveUser&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Person <span class="title function_">saveUser</span><span class="params">(Person person)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> person;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="POJO-参数解析原理"><a href="#POJO-参数解析原理" class="headerlink" title="POJO 参数解析原理"></a>POJO 参数解析原理</h3><h2 id="数据响应与内容协商"><a href="#数据响应与内容协商" class="headerlink" title="数据响应与内容协商"></a>数据响应与内容协商</h2><h2 id="视图解析与模板引擎"><a href="#视图解析与模板引擎" class="headerlink" title="视图解析与模板引擎"></a>视图解析与模板引擎</h2><p><strong>视图解析：SpringBoot默认不支持 JSP（JSP不支持在 JAR 压缩包内编译），需要引入第三方模板引擎技术实现页面渲染。</strong></p>
<h3 id="视图解析流程原理"><a href="#视图解析流程原理" class="headerlink" title="视图解析流程原理"></a>视图解析流程原理</h3><p><strong>视图处理方式：转发、重定向、自定义视图</strong></p>
<blockquote>
<p>目标方法处理的过程中，所有数据都会被放在 <strong>ModelAndViewContainer 里面。包括数据和视图地址</strong></p>
</blockquote>
<h2 id="拦截器"><a href="#拦截器" class="headerlink" title="拦截器"></a>拦截器</h2><h2 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h2><h2 id="原生Servlet组件"><a href="#原生Servlet组件" class="headerlink" title="原生Servlet组件"></a>原生Servlet组件</h2><h2 id="Web-请求处理流程"><a href="#Web-请求处理流程" class="headerlink" title="Web 请求处理流程"></a>Web 请求处理流程</h2><blockquote>
<ol>
<li>请求映射，客户端的请求被哪一个controller的方法处理</li>
<li></li>
</ol>
</blockquote>
<p><strong>SpringMVC 功能分析从： org.springframework.web.servlet.DispatcherServlet –&gt; doDispatch() 方法开始。</strong></p>
<p><strong>DispatcherServlet：</strong></p>
<p>该类继承了HttpServlet</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DispatcherServlet</span> <span class="keyword">extends</span> <span class="title class_">FrameworkServlet</span> &#123;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">FrameworkServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServletBean</span> <span class="keyword">implements</span> <span class="title class_">ApplicationContextAware</span> &#123;</span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span><br><span class="line">			<span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">		processRequest(request, response);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span><br><span class="line">			<span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">		processRequest(request, response);</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line"> 	<span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">processRequest</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span><br><span class="line">			<span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			doService(request, response);</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">HttpServletBean</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> <span class="keyword">implements</span> <span class="title class_">EnvironmentCapable</span>, EnvironmentAware &#123;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doService</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">		doDispatch(request, response);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>核心方法：doDispatch(request, response);方法用于处理请求和响应。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Process the actual dispatching to the handler.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;The handler will be obtained by applying the servlet&#x27;s HandlerMappings in order.</span></span><br><span class="line"><span class="comment">	 * The HandlerAdapter will be obtained by querying the servlet&#x27;s installed HandlerAdapters</span></span><br><span class="line"><span class="comment">	 * to find the first that supports the handler class.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;All HTTP methods are handled by this method. It&#x27;s up to HandlerAdapters or handlers</span></span><br><span class="line"><span class="comment">	 * themselves to decide which methods are acceptable.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> request current HTTP request</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> response current HTTP response</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception in case of any kind of processing failure</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;deprecation&quot;)</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doDispatch</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">HttpServletRequest</span> <span class="variable">processedRequest</span> <span class="operator">=</span> request;</span><br><span class="line">    <span class="type">HandlerExecutionChain</span> <span class="variable">mappedHandler</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">multipartRequestParsed</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">WebAsyncManager</span> <span class="variable">asyncManager</span> <span class="operator">=</span> WebAsyncUtils.getAsyncManager(request);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">ModelAndView</span> <span class="variable">mv</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Exception</span> <span class="variable">dispatchException</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// ==========检查是否为文件上传请求==========</span></span><br><span class="line">            processedRequest = checkMultipart(request);</span><br><span class="line">            multipartRequestParsed = (processedRequest != request);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Determine handler for the current request.</span></span><br><span class="line">            <span class="comment">// ==========决定哪一个handler方法进行请求的处理==========</span></span><br><span class="line">            mappedHandler = getHandler(processedRequest);</span><br><span class="line">            <span class="keyword">if</span> (mappedHandler == <span class="literal">null</span>) &#123;</span><br><span class="line">                noHandlerFound(processedRequest, response);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Determine handler adapter for the current request.</span></span><br><span class="line">            <span class="comment">// ===========返回该请求对应的adapter：RequestMappingHandlerAdapter==========</span></span><br><span class="line">            <span class="type">HandlerAdapter</span> <span class="variable">ha</span> <span class="operator">=</span> getHandlerAdapter(mappedHandler.getHandler());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Process last-modified header, if supported by the handler.</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">method</span> <span class="operator">=</span> request.getMethod();</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isGet</span> <span class="operator">=</span> HttpMethod.GET.matches(method);</span><br><span class="line">            <span class="keyword">if</span> (isGet || HttpMethod.HEAD.matches(method)) &#123;</span><br><span class="line">                <span class="type">long</span> <span class="variable">lastModified</span> <span class="operator">=</span> ha.getLastModified(request, mappedHandler.getHandler());</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">new</span> <span class="title class_">ServletWebRequest</span>(request, response).checkNotModified(lastModified) &amp;&amp; isGet) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="comment">// =========真正的handler方法执行之前执行的拦截器方法==========</span></span><br><span class="line">            <span class="keyword">if</span> (!mappedHandler.applyPreHandle(processedRequest, response)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Actually invoke the handler.</span></span><br><span class="line">            mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            applyDefaultViewName(processedRequest, mv);</span><br><span class="line">            <span class="comment">// ==============拦截器后置方法执行===============</span></span><br><span class="line">            mappedHandler.applyPostHandle(processedRequest, response, mv);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            <span class="comment">// =============以上过程发生的任何异常都会被dispatchException记录===========</span></span><br><span class="line">            dispatchException = ex;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable err) &#123;</span><br><span class="line">            <span class="comment">// As of 4.3, we&#x27;re processing Errors thrown from handler methods as well,</span></span><br><span class="line">            <span class="comment">// making them available for @ExceptionHandler methods and other scenarios.</span></span><br><span class="line">            dispatchException = <span class="keyword">new</span> <span class="title class_">NestedServletException</span>(<span class="string">&quot;Handler dispatch failed&quot;</span>, err);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ==========处理派发结果，试图渲染等==========</span></span><br><span class="line">        processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        triggerAfterCompletion(processedRequest, response, mappedHandler, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable err) &#123;</span><br><span class="line">        triggerAfterCompletion(processedRequest, response, mappedHandler,</span><br><span class="line">                               <span class="keyword">new</span> <span class="title class_">NestedServletException</span>(<span class="string">&quot;Handler processing failed&quot;</span>, err));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">            <span class="comment">// Instead of postHandle and afterCompletion</span></span><br><span class="line">            <span class="keyword">if</span> (mappedHandler != <span class="literal">null</span>) &#123;</span><br><span class="line">                mappedHandler.applyAfterConcurrentHandlingStarted(processedRequest, response);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Clean up any resources used by a multipart request.</span></span><br><span class="line">            <span class="keyword">if</span> (multipartRequestParsed) &#123;</span><br><span class="line">                cleanupMultipart(processedRequest);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>方法：HandlerExecutionChain mappedHandler &#x3D; getHandler(processedRequest);</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Return the HandlerExecutionChain for this request.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;Tries all handler mappings in order.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> request current HTTP request</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the HandlerExecutionChain, or &#123;<span class="doctag">@code</span> null&#125; if no handler could be found</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">protected</span> HandlerExecutionChain <span class="title function_">getHandler</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.handlerMappings != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (HandlerMapping mapping : <span class="built_in">this</span>.handlerMappings) &#123;</span><br><span class="line">            <span class="type">HandlerExecutionChain</span> <span class="variable">handler</span> <span class="operator">=</span> mapping.getHandler(request);</span><br><span class="line">            <span class="keyword">if</span> (handler != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> handler;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>this.handlerMappings：</p>
<img src="/2023/03/14/SpringBoot2/Java\SpringBoot\SpringBoot2.assets\image-20221020211213700.png" alt="image-20221020211213700" style="zoom:80%;">

<p><strong>RequestMappingHandlerMapping</strong> –&gt; getHandler()：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Look up a handler for the given request, falling back to the default</span></span><br><span class="line"><span class="comment"> * handler if no specific one is found.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> request current HTTP request</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the corresponding handler instance, or the default handler</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #getHandlerInternal</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> HandlerExecutionChain <span class="title function_">getHandler</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">       <span class="comment">// ===========返回处理该请求的handler（代理）对象===========</span></span><br><span class="line">	<span class="type">Object</span> <span class="variable">handler</span> <span class="operator">=</span> getHandlerInternal(request);</span><br><span class="line">	<span class="keyword">if</span> (handler == <span class="literal">null</span>) &#123;</span><br><span class="line">		handler = getDefaultHandler();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (handler == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Bean name or resolved handler?</span></span><br><span class="line">	<span class="keyword">if</span> (handler <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">		<span class="type">String</span> <span class="variable">handlerName</span> <span class="operator">=</span> (String) handler;</span><br><span class="line">		handler = obtainApplicationContext().getBean(handlerName);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Ensure presence of cached lookupPath for interceptors and others</span></span><br><span class="line">	<span class="keyword">if</span> (!ServletRequestPathUtils.hasCachedPath(request)) &#123;</span><br><span class="line">		initLookupPath(request);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ==========方法的拦截器</span></span><br><span class="line">	<span class="type">HandlerExecutionChain</span> <span class="variable">executionChain</span> <span class="operator">=</span> getHandlerExecutionChain(handler, request);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">		logger.trace(<span class="string">&quot;Mapped to &quot;</span> + handler);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (logger.isDebugEnabled() &amp;&amp; !DispatcherType.ASYNC.equals(request.getDispatcherType())) &#123;</span><br><span class="line">		logger.debug(<span class="string">&quot;Mapped to &quot;</span> + executionChain.getHandler());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (hasCorsConfigurationSource(handler) || CorsUtils.isPreFlightRequest(request)) &#123;</span><br><span class="line">		<span class="type">CorsConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> getCorsConfiguration(handler, request);</span><br><span class="line">		<span class="keyword">if</span> (getCorsConfigurationSource() != <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="type">CorsConfiguration</span> <span class="variable">globalConfig</span> <span class="operator">=</span> getCorsConfigurationSource().getCorsConfiguration(request);</span><br><span class="line">			config = (globalConfig != <span class="literal">null</span> ? globalConfig.combine(config) : config);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (config != <span class="literal">null</span>) &#123;</span><br><span class="line">			config.validateAllowCredentials();</span><br><span class="line">		&#125;</span><br><span class="line">		executionChain = getCorsHandlerExecutionChain(request, executionChain, config);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> executionChain;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>getHandlerInternal(request)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Look up a handler method for the given request.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">protected</span> HandlerMethod <span class="title function_">getHandlerInternal</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	<span class="comment">// ===========得到请求的路径：/user ===============</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">lookupPath</span> <span class="operator">=</span> initLookupPath(request);</span><br><span class="line">       <span class="comment">// ===========加锁==============</span></span><br><span class="line">	<span class="built_in">this</span>.mappingRegistry.acquireReadLock();</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">// ===========根据lookupPath,在mappingRegistry中查找，返回处理该请求的handler对象=====</span></span><br><span class="line">		<span class="type">HandlerMethod</span> <span class="variable">handlerMethod</span> <span class="operator">=</span> lookupHandlerMethod(lookupPath, request);</span><br><span class="line">		<span class="keyword">return</span> (handlerMethod != <span class="literal">null</span> ? handlerMethod.createWithResolvedBean() : <span class="literal">null</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.mappingRegistry.releaseReadLock();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>lookupHandlerMethod(lookupPath, request)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Look up the best-matching handler method for the current request.</span></span><br><span class="line"><span class="comment"> * If multiple matches are found, the best match is selected.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> lookupPath mapping lookup path within the current servlet mapping</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> request the current request</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the best-matching handler method, or &#123;<span class="doctag">@code</span> null&#125; if no match</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #handleMatch(Object, String, HttpServletRequest)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #handleNoMatch(Set, String, HttpServletRequest)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">protected</span> HandlerMethod <span class="title function_">lookupHandlerMethod</span><span class="params">(String lookupPath, HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	List&lt;Match&gt; matches = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">       <span class="comment">// ==========this.mappingRegistry：所有的请求路径对应的方法=============</span></span><br><span class="line">	List&lt;T&gt; directPathMatches = <span class="built_in">this</span>.mappingRegistry.getMappingsByDirectPath(lookupPath);</span><br><span class="line">	<span class="keyword">if</span> (directPathMatches != <span class="literal">null</span>) &#123;</span><br><span class="line">		addMatchingMappings(directPathMatches, matches, request);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (matches.isEmpty()) &#123;</span><br><span class="line">		addMatchingMappings(<span class="built_in">this</span>.mappingRegistry.getRegistrations().keySet(), matches, request);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!matches.isEmpty()) &#123;</span><br><span class="line">           <span class="comment">// ============默认得到第一个handler作为最佳匹配=============</span></span><br><span class="line">		<span class="type">Match</span> <span class="variable">bestMatch</span> <span class="operator">=</span> matches.get(<span class="number">0</span>);</span><br><span class="line">           <span class="comment">// ============如果有多个匹配，但请求方式不同，或其他原因，则再根据请求方式筛选==========</span></span><br><span class="line">		<span class="keyword">if</span> (matches.size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">			Comparator&lt;Match&gt; comparator = <span class="keyword">new</span> <span class="title class_">MatchComparator</span>(getMappingComparator(request));</span><br><span class="line">			matches.sort(comparator);</span><br><span class="line">			bestMatch = matches.get(<span class="number">0</span>);</span><br><span class="line">			<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">				logger.trace(matches.size() + <span class="string">&quot; matching mappings: &quot;</span> + matches);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (CorsUtils.isPreFlightRequest(request)) &#123;</span><br><span class="line">				<span class="keyword">for</span> (Match match : matches) &#123;</span><br><span class="line">					<span class="keyword">if</span> (match.hasCorsConfig()) &#123;</span><br><span class="line">						<span class="keyword">return</span> PREFLIGHT_AMBIGUOUS_MATCH;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="type">Match</span> <span class="variable">secondBestMatch</span> <span class="operator">=</span> matches.get(<span class="number">1</span>);</span><br><span class="line">				<span class="keyword">if</span> (comparator.compare(bestMatch, secondBestMatch) == <span class="number">0</span>) &#123;</span><br><span class="line">					<span class="type">Method</span> <span class="variable">m1</span> <span class="operator">=</span> bestMatch.getHandlerMethod().getMethod();</span><br><span class="line">					<span class="type">Method</span> <span class="variable">m2</span> <span class="operator">=</span> secondBestMatch.getHandlerMethod().getMethod();</span><br><span class="line">					<span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> request.getRequestURI();</span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(</span><br><span class="line">							<span class="string">&quot;Ambiguous handler methods mapped for &#x27;&quot;</span> + uri + <span class="string">&quot;&#x27;: &#123;&quot;</span> + m1 + <span class="string">&quot;, &quot;</span> + m2 + <span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		request.setAttribute(BEST_MATCHING_HANDLER_ATTRIBUTE, </span><br><span class="line">                                bestMatch.getHandlerMethod());</span><br><span class="line">		handleMatch(bestMatch.mapping, lookupPath, request);</span><br><span class="line">           <span class="comment">// ===========返回最佳匹配对应的handler方法=============</span></span><br><span class="line">		<span class="keyword">return</span> bestMatch.getHandlerMethod();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> handleNoMatch(<span class="built_in">this</span>.mappingRegistry.getRegistrations().keySet(), lookupPath, request);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>this.mappingRegistry：</p>
<p><img src="/2023/03/14/SpringBoot2/Java\SpringBoot\SpringBoot2.assets\image-20221020212346713.png" alt="image-20221020212346713"></p>
<p><img src="/2023/03/14/SpringBoot2/Java\SpringBoot\SpringBoot2.assets\image-20221020212415533.png" alt="image-20221020212415533"></p>
<p>HandlerExecutionChain executionChain &#x3D; getHandlerExecutionChain(handler, request);</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Build a &#123;<span class="doctag">@link</span> HandlerExecutionChain&#125; for the given handler, including</span></span><br><span class="line"><span class="comment"> * applicable interceptors.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;The default implementation builds a standard &#123;<span class="doctag">@link</span> HandlerExecutionChain&#125;</span></span><br><span class="line"><span class="comment"> * with the given handler, the common interceptors of the handler mapping, and any</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> MappedInterceptor MappedInterceptors&#125; matching to the current request URL. Interceptors</span></span><br><span class="line"><span class="comment"> * are added in the order they were registered. Subclasses may override this</span></span><br><span class="line"><span class="comment"> * in order to extend/rearrange the list of interceptors.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;&lt;b&gt;<span class="doctag">NOTE:</span>&lt;/b&gt; The passed-in handler object may be a raw handler or a</span></span><br><span class="line"><span class="comment"> * pre-built &#123;<span class="doctag">@link</span> HandlerExecutionChain&#125;. This method should handle those</span></span><br><span class="line"><span class="comment"> * two cases explicitly, either building a new &#123;<span class="doctag">@link</span> HandlerExecutionChain&#125;</span></span><br><span class="line"><span class="comment"> * or extending the existing chain.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;For simply adding an interceptor in a custom subclass, consider calling</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@code</span> super.getHandlerExecutionChain(handler, request)&#125; and invoking</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> HandlerExecutionChain#addInterceptor&#125; on the returned chain object.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> handler the resolved handler instance (never &#123;<span class="doctag">@code</span> null&#125;)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> request current HTTP request</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the HandlerExecutionChain (never &#123;<span class="doctag">@code</span> null&#125;)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #getAdaptedInterceptors()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> HandlerExecutionChain <span class="title function_">getHandlerExecutionChain</span><span class="params">(Object handler, HttpServletRequest request)</span> &#123;</span><br><span class="line">       <span class="comment">// ==========创建或获取拦截器链==========</span></span><br><span class="line">	<span class="type">HandlerExecutionChain</span> <span class="variable">chain</span> <span class="operator">=</span> (handler <span class="keyword">instanceof</span> HandlerExecutionChain ?</span><br><span class="line">			(HandlerExecutionChain) handler : <span class="keyword">new</span> <span class="title class_">HandlerExecutionChain</span>(handler));</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span> (HandlerInterceptor interceptor : <span class="built_in">this</span>.adaptedInterceptors) &#123;</span><br><span class="line">		<span class="keyword">if</span> (interceptor <span class="keyword">instanceof</span> MappedInterceptor) &#123;</span><br><span class="line">			<span class="type">MappedInterceptor</span> <span class="variable">mappedInterceptor</span> <span class="operator">=</span> (MappedInterceptor) interceptor;</span><br><span class="line">			<span class="keyword">if</span> (mappedInterceptor.matches(request)) &#123;</span><br><span class="line">				chain.addInterceptor(mappedInterceptor.getInterceptor());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			chain.addInterceptor(interceptor);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> chain;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>this.adaptedInterceptors：</p>
<p><img src="/2023/03/14/SpringBoot2/Java\SpringBoot\SpringBoot2.assets\image-20221020213634619.png" alt="image-20221020213634619"></p>
<p>HandlerExecutionChain：包括了请求的handler方法和拦截器 List<HandlerInterceptor> handlerInterceptorList</HandlerInterceptor></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Interception point before the execution of a handler. Called after</span></span><br><span class="line"><span class="comment">	 * HandlerMapping determined an appropriate handler object, but before</span></span><br><span class="line"><span class="comment">	 * HandlerAdapter invokes the handler.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;DispatcherServlet processes a handler in an execution chain, consisting</span></span><br><span class="line"><span class="comment">	 * of any number of interceptors, with the handler itself at the end.</span></span><br><span class="line"><span class="comment">	 * With this method, each interceptor can decide to abort the execution chain,</span></span><br><span class="line"><span class="comment">	 * typically sending an HTTP error or writing a custom response.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; special considerations apply for asynchronous</span></span><br><span class="line"><span class="comment">	 * request processing. For more details see</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> org.springframework.web.servlet.AsyncHandlerInterceptor&#125;.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;The default implementation returns &#123;<span class="doctag">@code</span> true&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> request current HTTP request</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> response current HTTP response</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> handler chosen handler to execute, for type and/or instance evaluation</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if the execution chain should proceed with the</span></span><br><span class="line"><span class="comment">	 * next interceptor or the handler itself. Else, DispatcherServlet assumes</span></span><br><span class="line"><span class="comment">	 * that this interceptor has already dealt with the response itself.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception in case of errors</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="comment">// ===========handler方法执行之前执行该方法================</span></span><br><span class="line">	<span class="keyword">default</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span></span><br><span class="line">			<span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Interception point after successful execution of a handler.</span></span><br><span class="line"><span class="comment">	 * Called after HandlerAdapter actually invoked the handler, but before the</span></span><br><span class="line"><span class="comment">	 * DispatcherServlet renders the view. Can expose additional model objects</span></span><br><span class="line"><span class="comment">	 * to the view via the given ModelAndView.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;DispatcherServlet processes a handler in an execution chain, consisting</span></span><br><span class="line"><span class="comment">	 * of any number of interceptors, with the handler itself at the end.</span></span><br><span class="line"><span class="comment">	 * With this method, each interceptor can post-process an execution,</span></span><br><span class="line"><span class="comment">	 * getting applied in inverse order of the execution chain.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; special considerations apply for asynchronous</span></span><br><span class="line"><span class="comment">	 * request processing. For more details see</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> org.springframework.web.servlet.AsyncHandlerInterceptor&#125;.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;The default implementation is empty.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> request current HTTP request</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> response current HTTP response</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> handler the handler (or &#123;<span class="doctag">@link</span> HandlerMethod&#125;) that started asynchronous</span></span><br><span class="line"><span class="comment">	 * execution, for type and/or instance examination</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> modelAndView the &#123;<span class="doctag">@code</span> ModelAndView&#125; that the handler returned</span></span><br><span class="line"><span class="comment">	 * (can also be &#123;<span class="doctag">@code</span> null&#125;)</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception in case of errors</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="comment">// ===========handler方法执行之后执行该方法================</span></span><br><span class="line">	<span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler,</span></span><br><span class="line"><span class="params">			<span class="meta">@Nullable</span> ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Callback after completion of request processing, that is, after rendering</span></span><br><span class="line"><span class="comment">	 * the view. Will be called on any outcome of handler execution, thus allows</span></span><br><span class="line"><span class="comment">	 * for proper resource cleanup.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;Note: Will only be called if this interceptor&#x27;s &#123;<span class="doctag">@code</span> preHandle&#125;</span></span><br><span class="line"><span class="comment">	 * method has successfully completed and returned &#123;<span class="doctag">@code</span> true&#125;!</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;As with the &#123;<span class="doctag">@code</span> postHandle&#125; method, the method will be invoked on each</span></span><br><span class="line"><span class="comment">	 * interceptor in the chain in reverse order, so the first interceptor will be</span></span><br><span class="line"><span class="comment">	 * the last to be invoked.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; special considerations apply for asynchronous</span></span><br><span class="line"><span class="comment">	 * request processing. For more details see</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> org.springframework.web.servlet.AsyncHandlerInterceptor&#125;.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;The default implementation is empty.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> request current HTTP request</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> response current HTTP response</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> handler the handler (or &#123;<span class="doctag">@link</span> HandlerMethod&#125;) that started asynchronous</span></span><br><span class="line"><span class="comment">	 * execution, for type and/or instance examination</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> ex any exception thrown on handler execution, if any; this does not</span></span><br><span class="line"><span class="comment">	 * include exceptions that have been handled through an exception resolver</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception in case of errors</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="comment">// ===========渲染完成视图，请求处理完成后执行的回调函数================</span></span><br><span class="line">	<span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler,</span></span><br><span class="line"><span class="params">			<span class="meta">@Nullable</span> Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>HandlerAdapter ha &#x3D; getHandlerAdapter(mappedHandler.getHandler());</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Return the HandlerAdapter for this handler object.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> handler the handler object to find an adapter for</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> ServletException if no HandlerAdapter can be found for the handler. This is a fatal error.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="keyword">protected</span> HandlerAdapter <span class="title function_">getHandlerAdapter</span><span class="params">(Object handler)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.handlerAdapters != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (HandlerAdapter adapter : <span class="built_in">this</span>.handlerAdapters) &#123;</span><br><span class="line">            <span class="keyword">if</span> (adapter.supports(handler)) &#123;</span><br><span class="line">                <span class="keyword">return</span> adapter;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(<span class="string">&quot;No adapter for handler [&quot;</span> + handler +</span><br><span class="line">                               <span class="string">&quot;]: The DispatcherServlet configuration needs to include a HandlerAdapter that supports this handler&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>this.handlerAdapters：</p>
<p><img src="/2023/03/14/SpringBoot2/Java\SpringBoot\SpringBoot2.assets\image-20221020220013111.png" alt="image-20221020220013111"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HandlerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Given a handler instance, return whether this &#123;<span class="doctag">@code</span> HandlerAdapter&#125;</span></span><br><span class="line"><span class="comment">	 * can support it. Typical HandlerAdapters will base the decision on the handler</span></span><br><span class="line"><span class="comment">	 * type. HandlerAdapters will usually only support one handler type each.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;A typical implementation:</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;&#123;<span class="doctag">@code</span></span></span><br><span class="line"><span class="comment">	 * return (handler instanceof MyHandler);</span></span><br><span class="line"><span class="comment">	 * &#125;</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> handler the handler object to check</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> whether this object can use the given handler</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">boolean</span> <span class="title function_">supports</span><span class="params">(Object handler)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Use the given handler to handle this request.</span></span><br><span class="line"><span class="comment">	 * The workflow that is required may vary widely.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> request current HTTP request</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> response current HTTP response</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> handler the handler to use. This object must have previously been passed</span></span><br><span class="line"><span class="comment">	 * to the &#123;<span class="doctag">@code</span> supports&#125; method of this interface, which must have</span></span><br><span class="line"><span class="comment">	 * returned &#123;<span class="doctag">@code</span> true&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> a ModelAndView object with the name of the view and the required</span></span><br><span class="line"><span class="comment">	 * model data, or &#123;<span class="doctag">@code</span> null&#125; if the request has been handled directly</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception in case of errors</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	ModelAndView <span class="title function_">handle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Same contract as for HttpServlet&#x27;s &#123;<span class="doctag">@code</span> getLastModified&#125; method.</span></span><br><span class="line"><span class="comment">	 * Can simply return -1 if there&#x27;s no support in the handler class.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> request current HTTP request</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> handler the handler to use</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the lastModified value for the given handler</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@deprecated</span> as of 5.3.9 along with</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> org.springframework.web.servlet.mvc.LastModified&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Deprecated</span></span><br><span class="line">	<span class="type">long</span> <span class="title function_">getLastModified</span><span class="params">(HttpServletRequest request, Object handler)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>对于 RequestMappingHandlerAdapter：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">supports</span><span class="params">(Object handler)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (handler <span class="keyword">instanceof</span> HandlerMethod &amp;&amp; supportsInternal((HandlerMethod) handler));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>!mappedHandler.applyPreHandle(processedRequest, response)：handler执行之前执行的拦截器方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Apply preHandle methods of registered interceptors.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if the execution chain should proceed with the</span></span><br><span class="line"><span class="comment">	 * next interceptor or the handler itself. Else, DispatcherServlet assumes</span></span><br><span class="line"><span class="comment">	 * that this interceptor has already dealt with the response itself.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">applyPreHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.interceptorList.size(); i++) &#123;</span><br><span class="line">        <span class="type">HandlerInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="built_in">this</span>.interceptorList.get(i);</span><br><span class="line">        <span class="keyword">if</span> (!interceptor.preHandle(request, response, <span class="built_in">this</span>.handler)) &#123;</span><br><span class="line">            triggerAfterCompletion(request, response, <span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.interceptorIndex = i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mv &#x3D; ha.handle(processedRequest, response, mappedHandler.getHandler());真正执行handler方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This implementation expects the handler to be an &#123;<span class="doctag">@link</span> HandlerMethod&#125;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> ModelAndView <span class="title function_">handle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span></span><br><span class="line">    <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">return</span> handleInternal(request, response, (HandlerMethod) handler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> ModelAndView <span class="title function_">handleInternal</span><span class="params">(HttpServletRequest request,</span></span><br><span class="line"><span class="params">                                      HttpServletResponse response, HandlerMethod handlerMethod)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	<span class="comment">// ==========模型视图对象===========</span></span><br><span class="line">    ModelAndView mav;</span><br><span class="line">    checkRequest(request);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Execute invokeHandlerMethod in synchronized block if required.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.synchronizeOnSession) &#123;</span><br><span class="line">        <span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> request.getSession(<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (session != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">mutex</span> <span class="operator">=</span> WebUtils.getSessionMutex(session);</span><br><span class="line">            <span class="keyword">synchronized</span> (mutex) &#123;</span><br><span class="line">                mav = invokeHandlerMethod(request, response, handlerMethod);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// No HttpSession available -&gt; no mutex necessary</span></span><br><span class="line">            mav = invokeHandlerMethod(request, response, handlerMethod);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// No synchronization on session demanded at all...</span></span><br><span class="line">        mav = invokeHandlerMethod(request, response, handlerMethod);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!response.containsHeader(HEADER_CACHE_CONTROL)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (getSessionAttributesHandler(handlerMethod).hasSessionAttributes()) &#123;</span><br><span class="line">            applyCacheSeconds(response, <span class="built_in">this</span>.cacheSecondsForSessionAttributeHandlers);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            prepareResponse(response);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mav;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ModelAndView mav &#x3D; invokeHandlerMethod(request, response, handlerMethod); </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Invoke the &#123;<span class="doctag">@link</span> RequestMapping&#125; handler method preparing a &#123;<span class="doctag">@link</span> ModelAndView&#125;</span></span><br><span class="line"><span class="comment">	 * if view resolution is required.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@since</span> 4.2</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@see</span> #createInvocableHandlerMethod(HandlerMethod)</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">protected</span> ModelAndView <span class="title function_">invokeHandlerMethod</span><span class="params">(HttpServletRequest request,</span></span><br><span class="line"><span class="params">                                           HttpServletResponse response, HandlerMethod handlerMethod)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">ServletWebRequest</span> <span class="variable">webRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletWebRequest</span>(request, response);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">WebDataBinderFactory</span> <span class="variable">binderFactory</span> <span class="operator">=</span> getDataBinderFactory(handlerMethod);</span><br><span class="line">        <span class="type">ModelFactory</span> <span class="variable">modelFactory</span> <span class="operator">=</span> getModelFactory(handlerMethod, binderFactory);</span><br><span class="line">		<span class="comment">// =======ServletInvocableHandlerMethod ... implements HandlerMethod</span></span><br><span class="line">        <span class="type">ServletInvocableHandlerMethod</span> <span class="variable">invocableMethod</span> <span class="operator">=</span> </span><br><span class="line">            createInvocableHandlerMethod(handlerMethod);</span><br><span class="line">        <span class="comment">// ===========设置参数解析器===========</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.argumentResolvers != <span class="literal">null</span>) &#123;</span><br><span class="line">            invocableMethod.setHandlerMethodArgumentResolvers(<span class="built_in">this</span>.argumentResolvers);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ===========设置返回值处理器===========</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.returnValueHandlers != <span class="literal">null</span>) &#123;</span><br><span class="line">            invocableMethod.setHandlerMethodReturnValueHandlers(<span class="built_in">this</span>.returnValueHandlers);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ===========设置数据绑定器，如自定义对象封装参数============</span></span><br><span class="line">        invocableMethod.setDataBinderFactory(binderFactory);</span><br><span class="line">        <span class="comment">// ===========设置参数名的处理============</span></span><br><span class="line">        invocableMethod.setParameterNameDiscoverer(<span class="built_in">this</span>.parameterNameDiscoverer);</span><br><span class="line">		<span class="comment">// ===========模型视图数据容器============</span></span><br><span class="line">        <span class="type">ModelAndViewContainer</span> <span class="variable">mavContainer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndViewContainer</span>();</span><br><span class="line">        mavContainer.addAllAttributes(RequestContextUtils.getInputFlashMap(request));</span><br><span class="line">        <span class="comment">// ===========初始化工厂============</span></span><br><span class="line">        modelFactory.initModel(webRequest, mavContainer, invocableMethod);</span><br><span class="line">        mavContainer.setIgnoreDefaultModelOnRedirect(<span class="built_in">this</span>.ignoreDefaultModelOnRedirect);</span><br><span class="line">		<span class="comment">// ===========异步请求处理============</span></span><br><span class="line">        <span class="type">AsyncWebRequest</span> <span class="variable">asyncWebRequest</span> <span class="operator">=</span> WebAsyncUtils.createAsyncWebRequest(request, response);</span><br><span class="line">        asyncWebRequest.setTimeout(<span class="built_in">this</span>.asyncRequestTimeout);</span><br><span class="line"></span><br><span class="line">        <span class="type">WebAsyncManager</span> <span class="variable">asyncManager</span> <span class="operator">=</span> WebAsyncUtils.getAsyncManager(request);</span><br><span class="line">        asyncManager.setTaskExecutor(<span class="built_in">this</span>.taskExecutor);</span><br><span class="line">        asyncManager.setAsyncWebRequest(asyncWebRequest);</span><br><span class="line">        asyncManager.registerCallableInterceptors(<span class="built_in">this</span>.callableInterceptors);</span><br><span class="line">        asyncManager.registerDeferredResultInterceptors(<span class="built_in">this</span>.deferredResultInterceptors);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (asyncManager.hasConcurrentResult()) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> asyncManager.getConcurrentResult();</span><br><span class="line">            mavContainer = (ModelAndViewContainer) asyncManager.getConcurrentResultContext()[<span class="number">0</span>];</span><br><span class="line">            asyncManager.clearConcurrentResult();</span><br><span class="line">            LogFormatUtils.traceDebug(logger, traceOn -&gt; &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">formatted</span> <span class="operator">=</span> LogFormatUtils.formatValue(result, !traceOn);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Resume with async result [&quot;</span> + formatted + <span class="string">&quot;]&quot;</span>;</span><br><span class="line">            &#125;);</span><br><span class="line">            invocableMethod = invocableMethod.wrapConcurrentResult(result);</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">// ============执行请求方法==========</span></span><br><span class="line">        invocableMethod.invokeAndHandle(webRequest, mavContainer);</span><br><span class="line">        <span class="keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">// ====================</span></span><br><span class="line">        <span class="keyword">return</span> getModelAndView(mavContainer, modelFactory, webRequest);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">        webRequest.requestCompleted();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ServletInvocableHandlerMethod invocableMethod：</p>
<p><img src="/2023/03/14/SpringBoot2/Java\SpringBoot\SpringBoot2.assets\image-20221020222317218.png" alt="image-20221020222317218"></p>
<p>this.argumentResolvers：</p>
<p><img src="/2023/03/14/SpringBoot2/Java\SpringBoot\SpringBoot2.assets\image-20221020222412605.png" alt="image-20221020222412605"></p>
<p>this.returnValueHandlers：</p>
<p><img src="/2023/03/14/SpringBoot2/Java\SpringBoot\SpringBoot2.assets\image-20221020222451296.png" alt="image-20221020222451296"></p>
<p>ModelAndViewContainer mavContainer &#x3D; new ModelAndViewContainer();</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ModelAndViewContainer</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">ignoreDefaultModelOnRedirect</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="keyword">private</span> Object view;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ModelMap</span> <span class="variable">defaultModel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BindingAwareModelMap</span>();</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="keyword">private</span> ModelMap redirectModel;</span><br><span class="line">	<span class="comment">// ================ModelMap既是Model也是Map================</span></span><br><span class="line">    <span class="comment">// public class BindingAwareModelMap extends ExtendedModelMap &#123;</span></span><br><span class="line">	<span class="comment">// public class ExtendedModelMap extends ModelMap implements Model &#123;</span></span><br><span class="line">	<span class="comment">// public class ModelMap extends LinkedHashMap&lt;String, Object&gt; &#123;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>invocableMethod.invokeAndHandle(webRequest, mavContainer);</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Invoke the method and handle the return value through one of the</span></span><br><span class="line"><span class="comment">	 * configured &#123;<span class="doctag">@link</span> HandlerMethodReturnValueHandler HandlerMethodReturnValueHandlers&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> webRequest the current request</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> mavContainer the ModelAndViewContainer for this request</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> providedArgs &quot;given&quot; arguments matched by type (not resolved)</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invokeAndHandle</span><span class="params">(ServletWebRequest webRequest, ModelAndViewContainer mavContainer,</span></span><br><span class="line"><span class="params">                            Object... providedArgs)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	<span class="comment">// =============执行handler方法，并返回值==============</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">returnValue</span> <span class="operator">=</span> invokeForRequest(webRequest, mavContainer, providedArgs);</span><br><span class="line">    setResponseStatus(webRequest);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (returnValue == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isRequestNotModified(webRequest) || getResponseStatus() != <span class="literal">null</span> || mavContainer.isRequestHandled()) &#123;</span><br><span class="line">            disableContentCachingIfNecessary(webRequest);</span><br><span class="line">            mavContainer.setRequestHandled(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (StringUtils.hasText(getResponseStatusReason())) &#123;</span><br><span class="line">        mavContainer.setRequestHandled(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mavContainer.setRequestHandled(<span class="literal">false</span>);</span><br><span class="line">    Assert.state(<span class="built_in">this</span>.returnValueHandlers != <span class="literal">null</span>, <span class="string">&quot;No return value handlers&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ==============返回值处理器对返回值进行处理===============</span></span><br><span class="line">        <span class="built_in">this</span>.returnValueHandlers.handleReturnValue(</span><br><span class="line">            returnValue, getReturnValueType(returnValue), mavContainer, webRequest);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(formatErrorForReturnValue(returnValue), ex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>invokeForRequest(webRequest, mavContainer, providedArgs);</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">invokeForRequest</span><span class="params">(NativeWebRequest request, <span class="meta">@Nullable</span> ModelAndViewContainer mavContainer,</span></span><br><span class="line"><span class="params">                               Object... providedArgs)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	<span class="comment">// =============获取方法参数的详细信息，注解等=============</span></span><br><span class="line">    Object[] args = getMethodArgumentValues(request, mavContainer, providedArgs);</span><br><span class="line">    <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">        logger.trace(<span class="string">&quot;Arguments: &quot;</span> + Arrays.toString(args));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> doInvoke(args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>getMethodArgumentValues(request, mavContainer, providedArgs);</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Get the method argument values for the current request, checking the provided</span></span><br><span class="line"><span class="comment">	 * argument values and falling back to the configured argument resolvers.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;The resulting array will be passed into &#123;<span class="doctag">@link</span> #doInvoke&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@since</span> 5.1.2</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="keyword">protected</span> Object[] getMethodArgumentValues(NativeWebRequest request, <span class="meta">@Nullable</span> ModelAndViewContainer mavContainer,Object... providedArgs) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	<span class="comment">// ===========获取参数详细信息============</span></span><br><span class="line">    MethodParameter[] parameters = getMethodParameters();</span><br><span class="line">    <span class="keyword">if</span> (ObjectUtils.isEmpty(parameters)) &#123;</span><br><span class="line">        <span class="keyword">return</span> EMPTY_ARGS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Object[] args = <span class="keyword">new</span> <span class="title class_">Object</span>[parameters.length];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; parameters.length; i++) &#123;</span><br><span class="line">        <span class="type">MethodParameter</span> <span class="variable">parameter</span> <span class="operator">=</span> parameters[i];</span><br><span class="line">        parameter.initParameterNameDiscovery(<span class="built_in">this</span>.parameterNameDiscoverer);</span><br><span class="line">        args[i] = findProvidedArgument(parameter, providedArgs);</span><br><span class="line">        <span class="keyword">if</span> (args[i] != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.resolvers.supportsParameter(parameter)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(formatArgumentError(parameter, <span class="string">&quot;No suitable resolver&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// ================由参数解析处理参数==================</span></span><br><span class="line">            args[i] = <span class="built_in">this</span>.resolvers.resolveArgument(parameter, mavContainer, request, <span class="built_in">this</span>.dataBinderFactory);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            <span class="comment">// Leave stack trace for later, exception may actually be resolved and handled...</span></span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">exMsg</span> <span class="operator">=</span> ex.getMessage();</span><br><span class="line">                <span class="keyword">if</span> (exMsg != <span class="literal">null</span> &amp;&amp; !exMsg.contains(parameter.getExecutable().toGenericString())) &#123;</span><br><span class="line">                    logger.debug(formatArgumentError(parameter, exMsg));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> args;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>this.resolvers.resolveArgument(parameter, mavContainer, request, this.dataBinderFactory);</p>
<p>return doInvoke(args);反射执行方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Invoke the handler method with the given argument values.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">protected</span> Object <span class="title function_">doInvoke</span><span class="params">(Object... args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> getBridgedMethod();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (KotlinDetector.isSuspendingFunction(method)) &#123;</span><br><span class="line">            <span class="keyword">return</span> CoroutinesUtils.invokeSuspendingFunction(method, getBean(), args);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// =============执行方法，返回方法值==============</span></span><br><span class="line">        <span class="keyword">return</span> method.invoke(getBean(), args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</span><br><span class="line">        assertTargetBean(method, getBean(), args);</span><br><span class="line">        <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> (ex.getMessage() != <span class="literal">null</span> ? ex.getMessage() : <span class="string">&quot;Illegal argument&quot;</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(formatInvokeError(text, args), ex);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>this.returnValueHandlers.handleReturnValue(returnValue, getReturnValueType(returnValue), mavContainer, webRequest);</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Iterate over registered &#123;<span class="doctag">@link</span> HandlerMethodReturnValueHandler HandlerMethodReturnValueHandlers&#125; and invoke the one that supports it.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> IllegalStateException if no suitable &#123;<span class="doctag">@link</span> HandlerMethodReturnValueHandler&#125; is found.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleReturnValue</span><span class="params">(<span class="meta">@Nullable</span> Object returnValue, MethodParameter returnType,</span></span><br><span class="line"><span class="params">                              ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	<span class="comment">// =============迭代所有的返回值处理器===============</span></span><br><span class="line">    <span class="type">HandlerMethodReturnValueHandler</span> <span class="variable">handler</span> <span class="operator">=</span> selectHandler(returnValue, returnType);</span><br><span class="line">    <span class="keyword">if</span> (handler == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Unknown return value type: &quot;</span> + returnType.getParameterType().getName());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// =============处理返回值============</span></span><br><span class="line">    handler.handleReturnValue(returnValue, returnType, mavContainer, webRequest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>HandlerMethodReturnValueHandler handler &#x3D; selectHandler(returnValue, returnType);</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">private</span> HandlerMethodReturnValueHandler <span class="title function_">selectHandler</span><span class="params">(<span class="meta">@Nullable</span> Object value, MethodParameter returnType)</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isAsyncValue</span> <span class="operator">=</span> isAsyncReturnValue(value, returnType);</span><br><span class="line">    <span class="keyword">for</span> (HandlerMethodReturnValueHandler handler : <span class="built_in">this</span>.returnValueHandlers) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isAsyncValue &amp;&amp; !(handler <span class="keyword">instanceof</span> AsyncHandlerMethodReturnValueHandler)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (handler.supportsReturnType(returnType)) &#123;</span><br><span class="line">            <span class="keyword">return</span> handler;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于handler：RequestResponseBodyMethodProcessor：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleReturnValue</span><span class="params">(<span class="meta">@Nullable</span> Object returnValue, MethodParameter returnType,</span></span><br><span class="line"><span class="params">                              ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span></span><br><span class="line">    <span class="keyword">throws</span> IOException, HttpMediaTypeNotAcceptableException, HttpMessageNotWritableException &#123;</span><br><span class="line"></span><br><span class="line">    mavContainer.setRequestHandled(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">ServletServerHttpRequest</span> <span class="variable">inputMessage</span> <span class="operator">=</span> createInputMessage(webRequest);</span><br><span class="line">    <span class="type">ServletServerHttpResponse</span> <span class="variable">outputMessage</span> <span class="operator">=</span> createOutputMessage(webRequest);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Try even with null return value. ResponseBodyAdvice could get involved.</span></span><br><span class="line">    writeWithMessageConverters(returnValue, returnType, inputMessage, outputMessage);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>a</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Writes the given return type to the given output message.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> value the value to write to the output message</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> returnType the type of the value</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> inputMessage the input messages. Used to inspect the &#123;<span class="doctag">@code</span> Accept&#125; header.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> outputMessage the output message to write to</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> IOException thrown in case of I/O errors</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> HttpMediaTypeNotAcceptableException thrown when the conditions indicated</span></span><br><span class="line"><span class="comment">	 * by the &#123;<span class="doctag">@code</span> Accept&#125; header on the request cannot be met by the message converters</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> HttpMessageNotWritableException thrown if a given message cannot</span></span><br><span class="line"><span class="comment">	 * be written by a converter, or if the content-type chosen by the server</span></span><br><span class="line"><span class="comment">	 * has no compatible converter.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&#123;&quot;rawtypes&quot;, &quot;unchecked&quot;&#125;)</span></span><br><span class="line"><span class="keyword">protected</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">writeWithMessageConverters</span><span class="params">(<span class="meta">@Nullable</span> T value, MethodParameter returnType, ServletServerHttpRequest inputMessage, ServletServerHttpResponse outputMessage)</span></span><br><span class="line">    <span class="keyword">throws</span> IOException, HttpMediaTypeNotAcceptableException, HttpMessageNotWritableException &#123;</span><br><span class="line"></span><br><span class="line">    Object body;</span><br><span class="line">    Class&lt;?&gt; valueType;</span><br><span class="line">    Type targetType;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (value <span class="keyword">instanceof</span> CharSequence) &#123;</span><br><span class="line">        body = value.toString();</span><br><span class="line">        valueType = String.class;</span><br><span class="line">        targetType = String.class;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        body = value;</span><br><span class="line">        valueType = getReturnValueType(body, returnType);</span><br><span class="line">        targetType = GenericTypeResolver.resolveType(getGenericType(returnType), </span><br><span class="line">                                                     returnType.getContainingClass());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isResourceType(value, returnType)) &#123;</span><br><span class="line">        outputMessage.getHeaders().set(HttpHeaders.ACCEPT_RANGES, <span class="string">&quot;bytes&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (value != <span class="literal">null</span> &amp;&amp; inputMessage.getHeaders().getFirst(HttpHeaders.RANGE) != <span class="literal">null</span> &amp;&amp; outputMessage.getServletResponse().getStatus() == <span class="number">200</span>) &#123;</span><br><span class="line">            <span class="type">Resource</span> <span class="variable">resource</span> <span class="operator">=</span> (Resource) value;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                List&lt;HttpRange&gt; httpRanges = inputMessage.getHeaders().getRange();</span><br><span class="line">                outputMessage.getServletResponse().setStatus(HttpStatus.PARTIAL_CONTENT.value());</span><br><span class="line">                body = HttpRange.toResourceRegions(httpRanges, resource);</span><br><span class="line">                valueType = body.getClass();</span><br><span class="line">                targetType = RESOURCE_REGION_LIST_TYPE;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</span><br><span class="line">                outputMessage.getHeaders().set(HttpHeaders.CONTENT_RANGE, <span class="string">&quot;bytes */&quot;</span> + resource.contentLength());</span><br><span class="line">                outputMessage.getServletResponse().setStatus(HttpStatus.REQUESTED_RANGE_NOT_SATISFIABLE.value());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// =================媒体协商================</span></span><br><span class="line">    <span class="type">MediaType</span> <span class="variable">selectedMediaType</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">MediaType</span> <span class="variable">contentType</span> <span class="operator">=</span> outputMessage.getHeaders().getContentType();</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isContentTypePreset</span> <span class="operator">=</span> contentType != <span class="literal">null</span> &amp;&amp; contentType.isConcrete();</span><br><span class="line">    <span class="keyword">if</span> (isContentTypePreset) &#123;</span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(<span class="string">&quot;Found &#x27;Content-Type:&quot;</span> + contentType + <span class="string">&quot;&#x27; in response&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        selectedMediaType = contentType;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> inputMessage.getServletRequest();</span><br><span class="line">        List&lt;MediaType&gt; acceptableTypes;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// =============客户端浏览器接受的媒体类型=============</span></span><br><span class="line">            acceptableTypes = getAcceptableMediaTypes(request);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (HttpMediaTypeNotAcceptableException ex) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">series</span> <span class="operator">=</span> outputMessage.getServletResponse().getStatus() / <span class="number">100</span>;</span><br><span class="line">            <span class="keyword">if</span> (body == <span class="literal">null</span> || series == <span class="number">4</span> || series == <span class="number">5</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                    logger.debug(<span class="string">&quot;Ignoring error response content (if any). &quot;</span> + ex);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ===============服务器端能产生的媒体类型===============</span></span><br><span class="line">        List&lt;MediaType&gt; producibleTypes = getProducibleMediaTypes(request, valueType, targetType);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (body != <span class="literal">null</span> &amp;&amp; producibleTypes.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">HttpMessageNotWritableException</span>(</span><br><span class="line">                <span class="string">&quot;No converter found for return value of type: &quot;</span> + valueType);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ==============兼容客户端的媒体类型=============</span></span><br><span class="line">        List&lt;MediaType&gt; mediaTypesToUse = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (MediaType requestedType : acceptableTypes) &#123;</span><br><span class="line">            <span class="keyword">for</span> (MediaType producibleType : producibleTypes) &#123;</span><br><span class="line">                <span class="keyword">if</span> (requestedType.isCompatibleWith(producibleType)) &#123;</span><br><span class="line">                    mediaTypesToUse.add(getMostSpecificMediaType(requestedType, producibleType));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mediaTypesToUse.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(<span class="string">&quot;No match for &quot;</span> + acceptableTypes + <span class="string">&quot;, supported: &quot;</span> + producibleTypes);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (body != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">HttpMediaTypeNotAcceptableException</span>(producibleTypes);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">// ==========媒体类型按照权重排序=============</span></span><br><span class="line">        MediaType.sortBySpecificityAndQuality(mediaTypesToUse);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (MediaType mediaType : mediaTypesToUse) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mediaType.isConcrete()) &#123;</span><br><span class="line">                selectedMediaType = mediaType;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (mediaType.isPresentIn(ALL_APPLICATION_MEDIA_TYPES)) &#123;</span><br><span class="line">                selectedMediaType = MediaType.APPLICATION_OCTET_STREAM;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(<span class="string">&quot;Using &#x27;&quot;</span> + selectedMediaType + <span class="string">&quot;&#x27;, given &quot;</span> +</span><br><span class="line">                         acceptableTypes + <span class="string">&quot; and supported &quot;</span> + producibleTypes);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (selectedMediaType != <span class="literal">null</span>) &#123;</span><br><span class="line">        selectedMediaType = selectedMediaType.removeQualityValue();</span><br><span class="line">        <span class="comment">// ==============遍历转换器，将结果转换为接收类型==============</span></span><br><span class="line">        <span class="keyword">for</span> (HttpMessageConverter&lt;?&gt; converter : <span class="built_in">this</span>.messageConverters) &#123;</span><br><span class="line">            <span class="type">GenericHttpMessageConverter</span> <span class="variable">genericConverter</span> <span class="operator">=</span> (converter <span class="keyword">instanceof</span> GenericHttpMessageConverter ?</span><br><span class="line">                                                            (GenericHttpMessageConverter&lt;?&gt;) converter : <span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (genericConverter != <span class="literal">null</span> ?</span><br><span class="line">                ((GenericHttpMessageConverter) converter).canWrite(targetType, valueType, selectedMediaType) :</span><br><span class="line">                converter.canWrite(valueType, selectedMediaType)) &#123;</span><br><span class="line">                body = getAdvice().beforeBodyWrite(body, returnType, selectedMediaType,</span><br><span class="line">(Class&lt;? <span class="keyword">extends</span> <span class="title class_">HttpMessageConverter</span>&lt;?&gt;&gt;) converter.getClass(),inputMessage, outputMessage);</span><br><span class="line">                <span class="keyword">if</span> (body != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">theBody</span> <span class="operator">=</span> body;</span><br><span class="line">                    LogFormatUtils.traceDebug(logger, traceOn -&gt;</span><br><span class="line">                                              <span class="string">&quot;Writing [&quot;</span> + LogFormatUtils.formatValue(theBody, !traceOn) + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">                    addContentDispositionHeader(inputMessage, outputMessage);</span><br><span class="line">                    <span class="keyword">if</span> (genericConverter != <span class="literal">null</span>) &#123;</span><br><span class="line">                        genericConverter.write(body, targetType, selectedMediaType, </span><br><span class="line">                                               outputMessage);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        ((HttpMessageConverter) converter).write(body, selectedMediaType,</span><br><span class="line">                                                                 outputMessage);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                        logger.debug(<span class="string">&quot;Nothing to write: null body&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (body != <span class="literal">null</span>) &#123;</span><br><span class="line">        Set&lt;MediaType&gt; producibleMediaTypes =</span><br><span class="line">            (Set&lt;MediaType&gt;) inputMessage.getServletRequest()</span><br><span class="line">            .getAttribute(HandlerMapping.PRODUCIBLE_MEDIA_TYPES_ATTRIBUTE);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isContentTypePreset || !CollectionUtils.isEmpty(producibleMediaTypes)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">HttpMessageNotWritableException</span>(</span><br><span class="line">                <span class="string">&quot;No converter for [&quot;</span> + valueType + <span class="string">&quot;] with preset Content-Type &#x27;&quot;</span> + contentType + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">HttpMediaTypeNotAcceptableException</span>(getSupportedMediaTypes(body.getClass()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>List<MediaType> acceptableTypes;	producibleTypes；</MediaType></p>
<p><img src="/2023/03/14/SpringBoot2/Java\SpringBoot\SpringBoot2.assets\image-20221021120403924.png" alt="image-20221021120403924"></p>
<p> <strong>this.messageConverters：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Strategy interface for converting from and to HTTP requests and responses.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Arjen Poutsma</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Juergen Hoeller</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Rossen Stoyanchev</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 3.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;T&gt; the converted object type</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HttpMessageConverter</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Indicates whether the given class can be read by this converter.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> clazz the class to test for readability</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> mediaType the media type to read (can be &#123;<span class="doctag">@code</span> null&#125; if not specified);</span></span><br><span class="line"><span class="comment">	 * typically the value of a &#123;<span class="doctag">@code</span> Content-Type&#125; header.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if readable; &#123;<span class="doctag">@code</span> false&#125; otherwise</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">boolean</span> <span class="title function_">canRead</span><span class="params">(Class&lt;?&gt; clazz, <span class="meta">@Nullable</span> MediaType mediaType)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Indicates whether the given class can be written by this converter.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> clazz the class to test for writability</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> mediaType the media type to write (can be &#123;<span class="doctag">@code</span> null&#125; if not specified);</span></span><br><span class="line"><span class="comment">	 * typically the value of an &#123;<span class="doctag">@code</span> Accept&#125; header.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if writable; &#123;<span class="doctag">@code</span> false&#125; otherwise</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">boolean</span> <span class="title function_">canWrite</span><span class="params">(Class&lt;?&gt; clazz, <span class="meta">@Nullable</span> MediaType mediaType)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Return the list of media types supported by this converter. The list may</span></span><br><span class="line"><span class="comment">	 * not apply to every possible target element type and calls to this method</span></span><br><span class="line"><span class="comment">	 * should typically be guarded via &#123;<span class="doctag">@link</span> #canWrite(Class, MediaType)</span></span><br><span class="line"><span class="comment">	 * canWrite(clazz, null&#125;. The list may also exclude MIME types supported</span></span><br><span class="line"><span class="comment">	 * only for a specific class. Alternatively, use</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> #getSupportedMediaTypes(Class)&#125; for a more precise list.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the list of supported media types</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	List&lt;MediaType&gt; <span class="title function_">getSupportedMediaTypes</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Return the list of media types supported by this converter for the given</span></span><br><span class="line"><span class="comment">	 * class. The list may differ from &#123;<span class="doctag">@link</span> #getSupportedMediaTypes()&#125; if the</span></span><br><span class="line"><span class="comment">	 * converter does not support the given Class or if it supports it only for</span></span><br><span class="line"><span class="comment">	 * a subset of media types.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> clazz the type of class to check</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the list of media types supported for the given class</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@since</span> 5.3.4</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">default</span> List&lt;MediaType&gt; <span class="title function_">getSupportedMediaTypes</span><span class="params">(Class&lt;?&gt; clazz)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> (canRead(clazz, <span class="literal">null</span>) || canWrite(clazz, <span class="literal">null</span>) ?</span><br><span class="line">				getSupportedMediaTypes() : Collections.emptyList());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Read an object of the given type from the given input message, and returns it.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> clazz the type of object to return. This type must have previously been passed to the</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> #canRead canRead&#125; method of this interface, which must have returned &#123;<span class="doctag">@code</span> true&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> inputMessage the HTTP input message to read from</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the converted object</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> IOException in case of I/O errors</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> HttpMessageNotReadableException in case of conversion errors</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	T <span class="title function_">read</span><span class="params">(Class&lt;? extends T&gt; clazz, HttpInputMessage inputMessage)</span></span><br><span class="line">			<span class="keyword">throws</span> IOException, HttpMessageNotReadableException;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Write a given object to the given output message.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> t the object to write to the output message. The type of this object must have previously been</span></span><br><span class="line"><span class="comment">	 * passed to the &#123;<span class="doctag">@link</span> #canWrite canWrite&#125; method of this interface, which must have returned &#123;<span class="doctag">@code</span> true&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> contentType the content type to use when writing. May be &#123;<span class="doctag">@code</span> null&#125; to indicate that the</span></span><br><span class="line"><span class="comment">	 * default content type of the converter must be used. If not &#123;<span class="doctag">@code</span> null&#125;, this media type must have</span></span><br><span class="line"><span class="comment">	 * previously been passed to the &#123;<span class="doctag">@link</span> #canWrite canWrite&#125; method of this interface, which must have</span></span><br><span class="line"><span class="comment">	 * returned &#123;<span class="doctag">@code</span> true&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> outputMessage the message to write to</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> IOException in case of I/O errors</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> HttpMessageNotWritableException in case of conversion errors</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">write</span><span class="params">(T t, <span class="meta">@Nullable</span> MediaType contentType, HttpOutputMessage outputMessage)</span></span><br><span class="line">			<span class="keyword">throws</span> IOException, HttpMessageNotWritableException;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>write方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * This implementation sets the default headers by calling &#123;<span class="doctag">@link</span> #addDefaultHeaders&#125;,</span></span><br><span class="line"><span class="comment">	 * and then calls &#123;<span class="doctag">@link</span> #writeInternal&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(<span class="keyword">final</span> T t, <span class="meta">@Nullable</span> MediaType contentType, HttpOutputMessage outputMessage)</span></span><br><span class="line">    <span class="keyword">throws</span> IOException, HttpMessageNotWritableException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> outputMessage.getHeaders();</span><br><span class="line">    addDefaultHeaders(headers, t, contentType);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (outputMessage <span class="keyword">instanceof</span> StreamingHttpOutputMessage) &#123;</span><br><span class="line">        <span class="type">StreamingHttpOutputMessage</span> <span class="variable">streamingOutputMessage</span> <span class="operator">=</span> (StreamingHttpOutputMessage) outputMessage;</span><br><span class="line">        streamingOutputMessage.setBody(outputStream -&gt; writeInternal(t, <span class="keyword">new</span> <span class="title class_">HttpOutputMessage</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> OutputStream <span class="title function_">getBody</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> outputStream;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> HttpHeaders <span class="title function_">getHeaders</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> headers;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        writeInternal(t, outputMessage);</span><br><span class="line">        outputMessage.getBody().flush();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>return getModelAndView(mavContainer, modelFactory, webRequest);</p>
<p>handler方法执行完成，返回数据视图 ModelAndView。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">private</span> ModelAndView <span class="title function_">getModelAndView</span><span class="params">(ModelAndViewContainer mavContainer,</span></span><br><span class="line"><span class="params">                                     ModelFactory modelFactory, NativeWebRequest webRequest)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    modelFactory.updateModel(webRequest, mavContainer);</span><br><span class="line">    <span class="keyword">if</span> (mavContainer.isRequestHandled()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">ModelMap</span> <span class="variable">model</span> <span class="operator">=</span> mavContainer.getModel();</span><br><span class="line">    <span class="type">ModelAndView</span> <span class="variable">mav</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>(mavContainer.getViewName(), model, </span><br><span class="line">                                        mavContainer.getStatus());</span><br><span class="line">    <span class="keyword">if</span> (!mavContainer.isViewReference()) &#123;</span><br><span class="line">        mav.setView((View) mavContainer.getView());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (model <span class="keyword">instanceof</span> RedirectAttributes) &#123;</span><br><span class="line">        Map&lt;String, ?&gt; flashAttributes = ((RedirectAttributes) model).getFlashAttributes();</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> webRequest.getNativeRequest(HttpServletRequest.class);</span><br><span class="line">        <span class="keyword">if</span> (request != <span class="literal">null</span>) &#123;</span><br><span class="line">            RequestContextUtils.getOutputFlashMap(request).putAll(flashAttributes);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mav;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>modelFactory.updateModel(webRequest, mavContainer);</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Promote model attributes listed as &#123;<span class="doctag">@code</span> <span class="doctag">@SessionAttributes</span>&#125; to the session.</span></span><br><span class="line"><span class="comment">	 * Add &#123;<span class="doctag">@link</span> BindingResult&#125; attributes where necessary.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> request the current request</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> container contains the model to update</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception if creating BindingResult attributes fails</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateModel</span><span class="params">(NativeWebRequest request, ModelAndViewContainer container)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">ModelMap</span> <span class="variable">defaultModel</span> <span class="operator">=</span> container.getDefaultModel();</span><br><span class="line">    <span class="keyword">if</span> (container.getSessionStatus().isComplete())&#123;</span><br><span class="line">        <span class="built_in">this</span>.sessionAttributesHandler.cleanupAttributes(request);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sessionAttributesHandler.storeAttributes(request, defaultModel);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!container.isRequestHandled() &amp;&amp; container.getModel() == defaultModel) &#123;</span><br><span class="line">        updateBindingResult(request, defaultModel);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时 mv &#x3D; ha.handle(processedRequest, response, mappedHandler.getHandler());执行完成。</p>
<p>mappedHandler.applyPostHandle(processedRequest, response, mv); 拦截器后置方法执行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">applyPostHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, <span class="meta">@Nullable</span> ModelAndView mv)</span></span><br><span class="line">    <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="built_in">this</span>.interceptorList.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="type">HandlerInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="built_in">this</span>.interceptorList.get(i);</span><br><span class="line">        interceptor.postHandle(request, response, <span class="built_in">this</span>.handler, mv);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);处理请求派发结果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Handle the result of handler selection and handler invocation, which is</span></span><br><span class="line"><span class="comment">	 * either a ModelAndView or an Exception to be resolved to a ModelAndView.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processDispatchResult</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span><br><span class="line"><span class="params">                                   <span class="meta">@Nullable</span> HandlerExecutionChain mappedHandler, </span></span><br><span class="line"><span class="params">                                   <span class="meta">@Nullable</span> ModelAndView mv,</span></span><br><span class="line"><span class="params">                                   <span class="meta">@Nullable</span> Exception exception)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">errorView</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">	<span class="comment">// ========处理异常========</span></span><br><span class="line">    <span class="keyword">if</span> (exception != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (exception <span class="keyword">instanceof</span> ModelAndViewDefiningException) &#123;</span><br><span class="line">            logger.debug(<span class="string">&quot;ModelAndViewDefiningException encountered&quot;</span>, exception);</span><br><span class="line">            mv = ((ModelAndViewDefiningException) exception).getModelAndView();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">handler</span> <span class="operator">=</span> (mappedHandler != <span class="literal">null</span> ? mappedHandler.getHandler() : <span class="literal">null</span>);</span><br><span class="line">            mv = processHandlerException(request, response, handler, exception);</span><br><span class="line">            errorView = (mv != <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Did the handler return a view to render?</span></span><br><span class="line">    <span class="keyword">if</span> (mv != <span class="literal">null</span> &amp;&amp; !mv.wasCleared()) &#123;</span><br><span class="line">        <span class="comment">// ===========渲染视图============</span></span><br><span class="line">        render(mv, request, response);</span><br><span class="line">        <span class="keyword">if</span> (errorView) &#123;</span><br><span class="line">            WebUtils.clearErrorRequestAttributes(request);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(<span class="string">&quot;No view rendering, null ModelAndView returned.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (WebAsyncUtils.getAsyncManager(request).isConcurrentHandlingStarted()) &#123;</span><br><span class="line">        <span class="comment">// Concurrent handling started during a forward</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mappedHandler != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Exception (if any) is already handled..</span></span><br><span class="line">        <span class="comment">// 视图渲染完成执行handler后置方法</span></span><br><span class="line">        mappedHandler.triggerAfterCompletion(request, response, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>视图渲染：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Render the given ModelAndView.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;This is the last stage in handling a request. It may involve resolving the view by name.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> mv the ModelAndView to render</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> request current HTTP servlet request</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> response current HTTP servlet response</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> ServletException if view is missing or cannot be resolved</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception if there&#x27;s a problem rendering the view</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">render</span><span class="params">(ModelAndView mv, HttpServletRequest request, </span></span><br><span class="line"><span class="params">                      HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// Determine locale for request and apply it to the response.</span></span><br><span class="line">    <span class="type">Locale</span> <span class="variable">locale</span> <span class="operator">=</span></span><br><span class="line">        (<span class="built_in">this</span>.localeResolver != <span class="literal">null</span> ? <span class="built_in">this</span>.localeResolver.resolveLocale(request) : request.getLocale());</span><br><span class="line">    response.setLocale(locale);</span><br><span class="line"></span><br><span class="line">    View view;</span><br><span class="line">    <span class="type">String</span> <span class="variable">viewName</span> <span class="operator">=</span> mv.getViewName();</span><br><span class="line">    <span class="keyword">if</span> (viewName != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// We need to resolve the view name.</span></span><br><span class="line">        <span class="comment">// ==============处理视图名称：得到视图解析器=============</span></span><br><span class="line">        view = resolveViewName(viewName, mv.getModelInternal(), locale, request);</span><br><span class="line">        <span class="keyword">if</span> (view == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(<span class="string">&quot;Could not resolve view with name &#x27;&quot;</span> + mv.getViewName() + <span class="string">&quot;&#x27; in servlet with name &#x27;&quot;</span> + getServletName() + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// No need to lookup: the ModelAndView object contains the actual View object.</span></span><br><span class="line">        view = mv.getView();</span><br><span class="line">        <span class="keyword">if</span> (view == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(<span class="string">&quot;ModelAndView [&quot;</span> + mv + <span class="string">&quot;] neither contains a view name nor a &quot;</span> +</span><br><span class="line">                                       <span class="string">&quot;View object in servlet with name &#x27;&quot;</span> + getServletName() + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Delegate to the View object for rendering.</span></span><br><span class="line">    <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">        logger.trace(<span class="string">&quot;Rendering view [&quot;</span> + view + <span class="string">&quot;] &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mv.getStatus() != <span class="literal">null</span>) &#123;</span><br><span class="line">            request.setAttribute(View.RESPONSE_STATUS_ATTRIBUTE, mv.getStatus());</span><br><span class="line">            response.setStatus(mv.getStatus().value());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// =========视图解析器渲染视图==========</span></span><br><span class="line">        view.render(mv.getModelInternal(), request, response);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(<span class="string">&quot;Error rendering view [&quot;</span> + view + <span class="string">&quot;]&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>































































<h1 id="数据访问"><a href="#数据访问" class="headerlink" title="数据访问"></a>数据访问</h1><h2 id="SQL"><a href="#SQL" class="headerlink" title="SQL"></a>SQL</h2><h3 id="数据源自动配置"><a href="#数据源自动配置" class="headerlink" title="数据源自动配置"></a>数据源自动配置</h3><h4 id="引入场景-starter"><a href="#引入场景-starter" class="headerlink" title="引入场景 starter"></a>引入场景 starter</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="数据库驱动"><a href="#数据库驱动" class="headerlink" title="数据库驱动"></a>数据库驱动</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">默认版本：<span class="tag">&lt;<span class="name">mysql.version</span>&gt;</span>8.0.22<span class="tag">&lt;/<span class="name">mysql.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;version&gt;5.1.49&lt;/version&gt;--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">修改默认版本：</span><br><span class="line">1. 直接依赖引入具体版本（maven的就近依赖原则）</span><br><span class="line">2. 重新声明版本（maven的属性的就近优先原则）</span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mysql.version</span>&gt;</span>5.1.49<span class="tag">&lt;/<span class="name">mysql.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="分析自动配置"><a href="#分析自动配置" class="headerlink" title="分析自动配置"></a>分析自动配置</h4><p>查看spring-boot-autoconfiguration：</p>
<blockquote>
<ol>
<li><p>DataSourceAutoConfiguration ：数据源的自动配置</p>
<ul>
<li>绑定了 spring.datasource</li>
</ul>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourceProperties</span> <span class="keyword">implements</span> <span class="title class_">BeanClassLoaderAware</span>, InitializingBean &#123;</span><br></pre></td></tr></table></figure>

<ul>
<li>底层默认使用了<strong>HikariDataSource</strong></li>
</ul>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.zaxxer<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>HikariCP<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Hikari DataSource configuration.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(HikariDataSource.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(DataSource.class)</span></span><br><span class="line"><span class="comment">// ========可以指定数据库连接池的类型=========</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(name = &quot;spring.datasource.type&quot;, havingValue = &quot;com.zaxxer.hikari.HikariDataSource&quot;,</span></span><br><span class="line"><span class="meta">      matchIfMissing = true)</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Hikari</span> &#123;</span><br></pre></td></tr></table></figure>

<p> DataSourceAutoConfiguration：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoConfiguration(before = SqlInitializationAutoConfiguration.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(&#123; DataSource.class, EmbeddedDatabaseType.class &#125;)</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(type = &quot;io.r2dbc.spi.ConnectionFactory&quot;)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(DataSourceProperties.class)</span></span><br><span class="line"><span class="meta">@Import(DataSourcePoolMetadataProvidersConfiguration.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourceAutoConfiguration</span> &#123;</span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@Conditional(PooledDataSourceCondition.class)</span></span><br><span class="line"><span class="comment">// ====容器中没有DataSource类才会导入配置好连接池：Hikari====</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(&#123; DataSource.class, XADataSource.class &#125;)</span></span><br><span class="line"><span class="meta">@Import(&#123; DataSourceConfiguration.Hikari.class, DataSourceConfiguration.Tomcat.class,</span></span><br><span class="line"><span class="meta">		DataSourceConfiguration.Dbcp2.class, DataSourceConfiguration.OracleUcp.class,</span></span><br><span class="line"><span class="meta">		DataSourceConfiguration.Generic.class, DataSourceJmxConfiguration.class &#125;)</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">PooledDataSourceConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>DataSourceTransactionManagerAutoConfiguration： 事务管理器的自动配置</p>
</li>
<li><p>JdbcTemplateAutoConfiguration： <strong>JdbcTemplate的自动配置</strong></p>
<p> 数据库连接配置：spring.jdbc</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoConfiguration(after = DataSourceAutoConfiguration.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(&#123; DataSource.class, JdbcTemplate.class &#125;)</span></span><br><span class="line"><span class="meta">@ConditionalOnSingleCandidate(DataSource.class)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(JdbcProperties.class)</span></span><br><span class="line"><span class="meta">@Import(&#123; DatabaseInitializationDependencyConfigurer.class, JdbcTemplateConfiguration.class,</span></span><br><span class="line"><span class="meta">      NamedParameterJdbcTemplateConfiguration.class &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdbcTemplateAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;spring.jdbc&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdbcProperties</span> &#123;</span><br></pre></td></tr></table></figure>
</li>
<li><p>JndiDataSourceAutoConfiguration： jndi 的自动配置</p>
</li>
<li><p>XADataSourceAutoConfiguration： 分布式事务相关</p>
</li>
</ol>
</blockquote>
<h4 id="配置修改"><a href="#配置修改" class="headerlink" title="配置修改"></a>配置修改</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.100.100:3306/springboot</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br></pre></td></tr></table></figure>

<p>注意报错：如果引入数据库相关starter，如不配置则会报错。</p>
<p>可以加注解：@SpringBootApplication(exclude &#x3D; {DataSourceAutoConfiguration.class})</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">***************************</span><br><span class="line">APPLICATION FAILED TO START</span><br><span class="line">***************************</span><br><span class="line">Description:</span><br><span class="line">Failed to configure a DataSource: <span class="string">&#x27;url&#x27;</span> attribute is not specified and no embedded datasource could be configured.</span><br><span class="line">Reason: Failed to determine a suitable driver <span class="keyword">class</span></span><br><span class="line"><span class="title class_">Action</span>:</span><br><span class="line">Consider the following:</span><br><span class="line">	If you want an embedded <span class="title function_">database</span> <span class="params">(H2, HSQL or Derby)</span>, please put it on the classpath.</span><br><span class="line">	If you have database settings to be loaded from a particular profile you may need to activate <span class="title function_">it</span> <span class="params">(no profiles are currently active)</span>.</span><br></pre></td></tr></table></figure>

<h4 id="测试连接"><a href="#测试连接" class="headerlink" title="测试连接"></a>测试连接</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SpringBoot2Web01ApplicationTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">count</span> <span class="operator">=</span> jdbcTemplate.queryForObject(<span class="string">&quot;select count(*) from tbl_account&quot;</span>,</span><br><span class="line">                                                 Long.class);</span><br><span class="line">        log.info(<span class="string">&quot;记录总数：&#123;&#125;&quot;</span>, count);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="切换-Druid-数据源"><a href="#切换-Druid-数据源" class="headerlink" title="切换 Druid 数据源"></a>切换 Druid 数据源</h3><p>地址：<a target="_blank" rel="noopener" href="https://github.com/alibaba/druid">https://github.com/alibaba/druid</a></p>
<p>对于第三方技术的整合：自定义方式整合、starter整合</p>
<h4 id="自定义方式整合Druid"><a href="#自定义方式整合Druid" class="headerlink" title="自定义方式整合Druid"></a>自定义方式整合Druid</h4><blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@Conditional(PooledDataSourceCondition.class)</span></span><br><span class="line"><span class="comment">// ========容器中没有DataSource时会导入HikariDataSource===========</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(&#123; DataSource.class, XADataSource.class &#125;)</span></span><br><span class="line"><span class="meta">@Import(&#123; DataSourceConfiguration.Hikari.class, DataSourceConfiguration.Tomcat.class,</span></span><br><span class="line"><span class="meta">         DataSourceConfiguration.Dbcp2.class, DataSourceConfiguration.OracleUcp.class,</span></span><br><span class="line"><span class="meta">         DataSourceConfiguration.Generic.class, DataSourceJmxConfiguration.class &#125;)</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">PooledDataSourceConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>容器中没有DataSource时会导入HikariDataSource。</p>
</blockquote>
<p>引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>xml配置：（配置文件形式）</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span></span></span><br><span class="line"><span class="tag">		<span class="attr">destroy-method</span>=<span class="string">&quot;close&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.url&#125;&quot;</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.username&#125;&quot;</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.password&#125;&quot;</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxActive&quot;</span> <span class="attr">value</span>=<span class="string">&quot;20&quot;</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;initialSize&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxWait&quot;</span> <span class="attr">value</span>=<span class="string">&quot;60000&quot;</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;minIdle&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;timeBetweenEvictionRunsMillis&quot;</span> <span class="attr">value</span>=<span class="string">&quot;60000&quot;</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;minEvictableIdleTimeMillis&quot;</span> <span class="attr">value</span>=<span class="string">&quot;300000&quot;</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;testWhileIdle&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;testOnBorrow&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;testOnReturn&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;poolPreparedStatements&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxOpenPreparedStatements&quot;</span> <span class="attr">value</span>=<span class="string">&quot;20&quot;</span> /&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>新建SpringBoot配置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyDataSourceConfig</span> &#123;</span><br><span class="line">    <span class="comment">// 同application.yaml文件配置绑定</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource&quot;)</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">druidDataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">        <span class="comment">// druidDataSource.setUrl();</span></span><br><span class="line">        <span class="comment">// druidDataSource.setXXX();</span></span><br><span class="line">        <span class="keyword">return</span> druidDataSource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：输出DataSource：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SpringBoot2Web01ApplicationTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">count</span> <span class="operator">=</span> jdbcTemplate.queryForObject(<span class="string">&quot;select count(*) from tbl_account&quot;</span>, Long.class);</span><br><span class="line">        log.info(<span class="string">&quot;记录总数：&#123;&#125;&quot;</span>, count);</span><br><span class="line">        log.info(<span class="string">&quot;DataSource: &#123;&#125;&quot;</span>, dataSource);</span><br><span class="line">        <span class="comment">// class com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Druid-数据监控"><a href="#Druid-数据监控" class="headerlink" title="Druid 数据监控"></a>Druid 数据监控</h4><p><a target="_blank" rel="noopener" href="https://github.com/alibaba/druid">https://github.com/alibaba/druid</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/druid/wiki/%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98">https://github.com/alibaba/druid/wiki/%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98</a></p>
<h5 id="配置-StatViewServlet配置"><a href="#配置-StatViewServlet配置" class="headerlink" title="配置_StatViewServlet配置"></a>配置_StatViewServlet配置</h5><p><a target="_blank" rel="noopener" href="https://github.com/alibaba/druid/wiki/%E9%85%8D%E7%BD%AE_StatViewServlet%E9%85%8D%E7%BD%AE">https://github.com/alibaba/druid/wiki/%E9%85%8D%E7%BD%AE_StatViewServlet%E9%85%8D%E7%BD%AE</a></p>
<p>Druid内置提供了一个StatViewServlet用于展示Druid的统计信息。</p>
<p>这个StatViewServlet的用途包括：</p>
<ul>
<li>提供监控信息展示的html页面</li>
<li>提供监控信息的JSON API</li>
</ul>
<p>注意：使用StatViewServlet，建议使用druid 0.2.6以上版本。</p>
<p>SpringBoot配置Servlet：（配置类）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配置Druid的监控员功能</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> ServletRegistrationBean <span class="title function_">statViewServlet</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">StatViewServlet</span> <span class="variable">statViewServlet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StatViewServlet</span>();</span><br><span class="line">    ServletRegistrationBean&lt;StatViewServlet&gt; registrationBean =</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ServletRegistrationBean</span>&lt;&gt;(statViewServlet, <span class="string">&quot;/druid/*&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> registrationBean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：<a target="_blank" rel="noopener" href="http://localhost:8080/druid/index.html">http://localhost:8080/druid/index.html</a></p>
<p><img src="/2023/03/14/SpringBoot2/Java\SpringBoot\SpringBoot2.assets\image-20221021204241297.png" alt="image-20221021204241297"></p>
<p>配置 StatViewServlet的登录功能：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> ServletRegistrationBean <span class="title function_">statViewServlet</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">StatViewServlet</span> <span class="variable">statViewServlet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StatViewServlet</span>();</span><br><span class="line">    ServletRegistrationBean&lt;StatViewServlet&gt; registrationBean =</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ServletRegistrationBean</span>&lt;&gt;(statViewServlet, <span class="string">&quot;/druid/*&quot;</span>);</span><br><span class="line">    <span class="comment">// 设置Druid页面的登录账户</span></span><br><span class="line">    registrationBean.addInitParameter(<span class="string">&quot;loginUsername&quot;</span>, <span class="string">&quot;druid&quot;</span>);</span><br><span class="line">    registrationBean.addInitParameter(<span class="string">&quot;loginPassword&quot;</span>, <span class="string">&quot;druid&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> registrationBean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>登录界面：</p>
<img src="/2023/03/14/SpringBoot2/Java\SpringBoot\SpringBoot2.assets\image-20221021211332942.png" alt="image-20221021211332942" style="zoom:50%;">

<h5 id="配置-StatFilter"><a href="#配置-StatFilter" class="headerlink" title="配置_StatFilter"></a>配置_StatFilter</h5><p>Druid内置提供一个StatFilter，用于统计监控信息。</p>
<p>SpringBoot配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyDataSourceConfig</span> &#123;</span><br><span class="line">    <span class="comment">// 同application.yaml文件配置绑定</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource&quot;)</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">druidDataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">        <span class="comment">// 开启SQL监控功能</span></span><br><span class="line">        druidDataSource.setFilters(<span class="string">&quot;stat&quot;</span>);</span><br><span class="line">        <span class="comment">// setXX可以写在配置文件中</span></span><br><span class="line">        <span class="keyword">return</span> druidDataSource;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>使用yaml代替配置类setXXX( );</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span> </span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.100.100:3306/springboot</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">    </span><br><span class="line">    <span class="attr">filters:</span> <span class="string">stat,wall</span></span><br></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RestfulTestController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/sql&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sql</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">count</span> <span class="operator">=</span> jdbcTemplate.queryForObject(<span class="string">&quot;select count(*) from tbl_account&quot;</span>, Long.class);</span><br><span class="line">        <span class="keyword">return</span> count.toString();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>多次访问：<a target="_blank" rel="noopener" href="http://localhost:8080/sql">http://localhost:8080/sql</a></p>
<p><img src="/2023/03/14/SpringBoot2/Java\SpringBoot\SpringBoot2.assets\image-20221021205302884.png" alt="image-20221021205302884"></p>
<p>其中执行时间分布：</p>
<blockquote>
<p>SQL监控项上，执行时间、读取行数、更新行数都有区间分布，将耗时分布成8个区间：</p>
<ul>
<li>0 - 1 耗时0到1毫秒的次数</li>
<li>1 - 10 耗时1到10毫秒的次数</li>
<li>10 - 100 耗时10到100毫秒的次数</li>
<li>100 - 1,000 耗时100到1000毫秒的次数</li>
<li>1,000 - 10,000 耗时1到10秒的次数</li>
<li>10,000 - 100,000 耗时10到100秒的次数</li>
<li>100,000 - 1,000,000 耗时100到1000秒的次数</li>
<li>1,000,000 - 耗时1000秒以上的次数</li>
</ul>
<p>记录耗时区间的发生次数，通过区分分布，可以很方便看出SQL运行的极好、普通和极差的分布。 耗时区分分布提供了“执行+RS时分布”，是将执行时间+ResultSet持有时间合并监控，这个能方便诊断返回行数过多的查询。</p>
</blockquote>
<h5 id="Web关联Spring监控"><a href="#Web关联Spring监控" class="headerlink" title="Web关联Spring监控"></a>Web关联Spring监控</h5><p>WebStatFilter用于采集web-jdbc关联监控的数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 配置 WebStatFilter</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> FilterRegistrationBean <span class="title function_">webStatFilter</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">WebStatFilter</span> <span class="variable">webStatFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebStatFilter</span>();</span><br><span class="line">    FilterRegistrationBean&lt;WebStatFilter&gt; filterRegistrationBean =</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">FilterRegistrationBean</span>&lt;&gt;(webStatFilter);</span><br><span class="line">    filterRegistrationBean.setUrlPatterns(Arrays.asList(<span class="string">&quot;/*&quot;</span>));</span><br><span class="line">    filterRegistrationBean.addInitParameter(<span class="string">&quot;exclusions&quot;</span>, </span><br><span class="line">                                            <span class="string">&quot;*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> filterRegistrationBean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<p><img src="/2023/03/14/SpringBoot2/Java\SpringBoot\SpringBoot2.assets\image-20221021210500885.png" alt="image-20221021210500885"></p>
<h5 id="配置-wallfilter（防火墙）"><a href="#配置-wallfilter（防火墙）" class="headerlink" title="配置 wallfilter（防火墙）"></a>配置 wallfilter（防火墙）</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource&quot;)</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="type">DruidDataSource</span> <span class="variable">druidDataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">    <span class="comment">// 开启SQL监控，防火墙功能</span></span><br><span class="line">    druidDataSource.setFilters(<span class="string">&quot;stat,wall&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> druidDataSource;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/03/14/SpringBoot2/Java\SpringBoot\SpringBoot2.assets\image-20221021210646250.png" alt="image-20221021210646250"></p>
<h4 id="Starter-方式整合Druid"><a href="#Starter-方式整合Druid" class="headerlink" title="Starter 方式整合Druid"></a>Starter 方式整合Druid</h4><p><a target="_blank" rel="noopener" href="https://github.com/alibaba/druid/tree/master/druid-spring-boot-starter">https://github.com/alibaba/druid/tree/master/druid-spring-boot-starter</a></p>
<h5 id="引入依赖-1"><a href="#引入依赖-1" class="headerlink" title="引入依赖"></a>引入依赖</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="自动配置-1"><a href="#自动配置-1" class="headerlink" title="自动配置"></a>自动配置</h5><p>先看starter下的META-INF下spring.factory中声明了那个自动配置类。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span>=<span class="string">\</span></span><br><span class="line"><span class="string">com.alibaba.druid.spring.boot.autoconfigure.DruidDataSourceAutoConfigure</span></span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>DruidStatProperties 和 spring.datasource.druid绑定</li>
<li>DataSourceProperties 和 spring.datasource绑定</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(&#123;DruidDataSource.class&#125;)</span></span><br><span class="line"><span class="meta">@AutoConfigureBefore(&#123;DataSourceAutoConfiguration.class&#125;)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(&#123;DruidStatProperties.class, DataSourceProperties.class&#125;)</span></span><br><span class="line"><span class="meta">@Import(&#123;DruidSpringAopConfiguration.class, DruidStatViewServletConfiguration.class, DruidWebStatFilterConfiguration.class, DruidFilterConfiguration.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DruidDataSourceAutoConfigure</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DruidDataSourceAutoConfigure</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(</span></span><br><span class="line"><span class="meta">        initMethod = &quot;init&quot;</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        LOGGER.info(<span class="string">&quot;Init DruidDataSource&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DruidDataSourceWrapper</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>DruidSpringAopConfiguration.<strong>class</strong>,   监控SpringBean的；配置项：<strong>spring.datasource.druid.aop-patterns</strong></li>
<li>DruidStatViewServletConfiguration.<strong>class</strong>, 监控页的配置：<strong>spring.datasource.druid.stat-view-servlet；默认开启</strong></li>
<li>DruidWebStatFilterConfiguration.<strong>class</strong>, web监控配置；<strong>spring.datasource.druid.web-stat-filter；默认开启</strong></li>
<li>DruidFilterConfiguration.<strong>class</strong>}) 所有Druid自己filter的配置</li>
</ul>
</blockquote>
<h5 id="配置示例"><a href="#配置示例" class="headerlink" title="配置示例"></a>配置示例</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/db_account</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">druid:</span></span><br><span class="line">      <span class="attr">aop-patterns:</span> <span class="string">com.example.admin.*</span>  <span class="comment">#监控SpringBean</span></span><br><span class="line">      <span class="attr">filters:</span> <span class="string">stat,wall</span>     <span class="comment"># 底层开启功能，stat（sql监控），wall（防火墙）</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">stat-view-servlet:</span>   <span class="comment"># 配置监控页功能</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">login-username:</span> <span class="string">admin</span></span><br><span class="line">        <span class="attr">login-password:</span> <span class="string">admin</span></span><br><span class="line">        <span class="attr">resetEnable:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">web-stat-filter:</span>  <span class="comment"># 监控web</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">urlPattern:</span> <span class="string">/*</span></span><br><span class="line">        <span class="attr">exclusions:</span> <span class="string">&#x27;*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="attr">filter:</span></span><br><span class="line">        <span class="attr">stat:</span>    <span class="comment"># 对上面filters里面的stat的详细配置</span></span><br><span class="line">          <span class="attr">slow-sql-millis:</span> <span class="number">1000</span></span><br><span class="line">          <span class="attr">logSlowSql:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">wall:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">config:</span></span><br><span class="line">            <span class="attr">drop-table-allow:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>















<h3 id="整合-Mybatis"><a href="#整合-Mybatis" class="headerlink" title="整合 Mybatis"></a>整合 Mybatis</h3><p><a target="_blank" rel="noopener" href="https://github.com/mybatis">https://github.com/mybatis</a></p>
<p><a target="_blank" rel="noopener" href="https://mybatis.org/mybatis-3/">https://mybatis.org/mybatis-3/</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/mybatis/spring-boot-starter">https://github.com/mybatis/spring-boot-starter</a></p>
<h5 id="引入依赖-2"><a href="#引入依赖-2" class="headerlink" title="引入依赖"></a>引入依赖</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="分析自动配置-1"><a href="#分析自动配置-1" class="headerlink" title="分析自动配置"></a>分析自动配置</h5><blockquote>
<p>spring.factory</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Auto Configure</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span>=<span class="string">\</span></span><br><span class="line"><span class="string">org.mybatis.spring.boot.autoconfigure.MybatisLanguageDriverAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration</span></span><br></pre></td></tr></table></figure>

<p>MybatisAutoConfiguration</p>
<ul>
<li>MybatisProperties绑定了 mybatis</li>
<li>自动配置了SqlSessionFactory</li>
<li>自动配置了SqlSessionTemplate，包含了SqlSession</li>
<li>引入了AutoConfiguredMapperScannerRegistrar，@Mapper扫描</li>
<li>可以在配置类上使用 @MapperScan指定扫描的包下所有的Mapper，不需要单独添加@Mapper</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(&#123;SqlSessionFactory.class, SqlSessionFactoryBean.class&#125;)</span></span><br><span class="line"><span class="comment">// ========单个实例生效=========</span></span><br><span class="line"><span class="meta">@ConditionalOnSingleCandidate(DataSource.class)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(&#123;MybatisProperties.class&#125;)</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(&#123;DataSourceAutoConfiguration.class, MybatisLanguageDriverAutoConfiguration.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisAutoConfiguration</span> <span class="keyword">implements</span> <span class="title class_">InitializingBean</span> &#123;</span><br><span class="line">    <span class="comment">// ....</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="keyword">public</span> SqlSessionFactory <span class="title function_">sqlSessionFactory</span><span class="params">(DataSource dataSource)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">SqlSessionFactoryBean</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBean</span>();</span><br><span class="line">        factory.setDataSource(dataSource);</span><br><span class="line">        <span class="comment">// ....</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ====-自动配置了SQLSessionTemplate：组合了SQlSession========</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="keyword">public</span> SqlSessionTemplate <span class="title function_">sqlSessionTemplate</span><span class="params">(SqlSessionFactory sqlSessionFactory)</span> &#123;</span><br><span class="line">        <span class="type">ExecutorType</span> <span class="variable">executorType</span> <span class="operator">=</span> <span class="built_in">this</span>.properties.getExecutorType();</span><br><span class="line">        <span class="keyword">return</span> executorType != <span class="literal">null</span> ? <span class="keyword">new</span> <span class="title class_">SqlSessionTemplate</span>(sqlSessionFactory, executorType) : <span class="keyword">new</span> <span class="title class_">SqlSessionTemplate</span>(sqlSessionFactory);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ========MapperScan，标注了@Mapper的类会被自动扫描=========</span></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="meta">@Import(&#123;MybatisAutoConfiguration.AutoConfiguredMapperScannerRegistrar.class&#125;)</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean(&#123;MapperFactoryBean.class, MapperScannerConfigurer.class&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MapperScannerRegistrarNotFoundConfiguration</span> <span class="keyword">implements</span> <span class="title class_">InitializingBean</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">MapperScannerRegistrarNotFoundConfiguration</span><span class="params">()</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> &#123;</span><br><span class="line">            MybatisAutoConfiguration.logger.debug(<span class="string">&quot;Not found configuration for registering mapper bean using @MapperScan, MapperFactoryBean and MapperScannerConfigurer.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ....</span></span><br></pre></td></tr></table></figure>

<p>MybatisProperties</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;mybatis&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisProperties</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MYBATIS_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;mybatis&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ResourcePatternResolver</span> <span class="variable">resourceResolver</span> <span class="operator">=</span> </span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">PathMatchingResourcePatternResolver</span>();</span><br><span class="line">    <span class="keyword">private</span> String configLocation;</span><br><span class="line">    <span class="keyword">private</span> String[] mapperLocations;</span><br><span class="line">    <span class="keyword">private</span> String typeAliasesPackage;</span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt; typeAliasesSuperType;</span><br><span class="line">    <span class="keyword">private</span> String typeHandlersPackage;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">checkConfigLocation</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">private</span> ExecutorType executorType;</span><br><span class="line">    <span class="keyword">private</span> Class&lt;? <span class="keyword">extends</span> <span class="title class_">LanguageDriver</span>&gt; defaultScriptingLanguageDriver;</span><br><span class="line">    <span class="keyword">private</span> Properties configurationProperties;</span><br><span class="line">    <span class="comment">// =============全局配置对象============</span></span><br><span class="line">    <span class="meta">@NestedConfigurationProperty</span></span><br><span class="line">    <span class="keyword">private</span> Configuration configuration;</span><br></pre></td></tr></table></figure>
</blockquote>
<h5 id="配置示例-1"><a href="#配置示例-1" class="headerlink" title="配置示例"></a>配置示例</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="comment">#config-location: classpath:mybatis/mybatis-config.xml</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:mybatis/mapper/*.xml</span></span><br><span class="line">  <span class="comment"># 注意配置文件和configuration配置不能一起使用，会发生冲突</span></span><br><span class="line">  <span class="comment"># Property &#x27;configuration&#x27; and &#x27;configLocation&#x27; can not specified with together</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">map-underscore-to-camel-case:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">typeAliasesPackage:</span> <span class="string">com.example.springboot.bean</span></span><br></pre></td></tr></table></figure>

<p>测试：</p>
<p>mybatis-config.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">configuration</span></span></span><br><span class="line"><span class="meta">  <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">  <span class="string">&quot;https://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>AccountMapper.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;https://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.example.springboot.mapper.AccountMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--resultType默认写全名，别名需要配置--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectAccountById&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.example.springboot.bean.Account&quot;</span>&gt;</span></span><br><span class="line">        select * from tbl_account where id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>AccoutMapper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.springboot.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.springboot.bean.Account;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AccountMapper</span> &#123;</span><br><span class="line">    Account <span class="title function_">selectAccountById</span><span class="params">(Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>AccountService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.springboot.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.springboot.bean.Account;</span><br><span class="line"><span class="keyword">import</span> com.example.springboot.mapper.AccountMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountMapper accountMapper;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Account <span class="title function_">getAAccountById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> accountMapper.selectAccountById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DaoController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DaoController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountService accountService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 如果不加<span class="doctag">@ResponseBody</span>报错：</span></span><br><span class="line"><span class="comment">     * Error resolving template [account], template might not exist or might not be accessible by any of the configured Template Resolvers</span></span><br><span class="line"><span class="comment">     * org.thymeleaf.exceptions.TemplateInputException: Error resolving template [account], template might not exist or</span></span><br><span class="line"><span class="comment">     * might not be accessible by any of the configured Template Resolvers</span></span><br><span class="line"><span class="comment">     * 如果不带参数报400错误</span></span><br><span class="line"><span class="comment">     * 如果bean没有get、set方法，报错：</span></span><br><span class="line"><span class="comment">     * Resolved [org.springframework.web.HttpMediaTypeNotAcceptableException: Could not find acceptable representation]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/account&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Account <span class="title function_">account</span><span class="params">(<span class="meta">@RequestParam(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> accountService.getAAccountById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="注解模式"><a href="#注解模式" class="headerlink" title="注解模式"></a>注解模式</h5><p>city表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> city</span><br><span class="line">(</span><br><span class="line">  id      <span class="type">INT</span>(<span class="number">11</span>) <span class="keyword">PRIMARY</span> KEY auto_increment,</span><br><span class="line">  name    <span class="type">VARCHAR</span>(<span class="number">30</span>),</span><br><span class="line">  state   <span class="type">VARCHAR</span>(<span class="number">30</span>),</span><br><span class="line">  country <span class="type">VARCHAR</span>(<span class="number">30</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>bean：city</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">City</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String state;</span><br><span class="line">    <span class="keyword">private</span> String country;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CityMapper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CityMapper</span> &#123;</span><br><span class="line">    <span class="meta">@Select(&quot;select * from city&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;City&gt; <span class="title function_">selectAllCity</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Insert(&quot;insert into city(name,state,country) values(#&#123;name&#125;,#&#123;state&#125;,#&#123;country&#125;)&quot;)</span></span><br><span class="line">    <span class="comment">// 自增数据库返回新插入数据的主键</span></span><br><span class="line">    <span class="meta">@Options(useGeneratedKeys = true, keyProperty = &quot;id&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">insertOneCity</span><span class="params">(City city)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CityServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CityServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">CityService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CityMapper cityMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;City&gt; <span class="title function_">getAllCity</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> cityMapper.selectAllCity();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">addCity</span><span class="params">(City city)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> cityMapper.insertOneCity(city);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DaoController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountService accountService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CityService cityService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 如果不加<span class="doctag">@ResponseBody</span>报错：</span></span><br><span class="line"><span class="comment">     * Error resolving template [account], template might not exist or might not be accessible by any of the configured Template Resolvers</span></span><br><span class="line"><span class="comment">     * org.thymeleaf.exceptions.TemplateInputException: Error resolving template [account], template might not exist or</span></span><br><span class="line"><span class="comment">     * might not be accessible by any of the configured Template Resolvers</span></span><br><span class="line"><span class="comment">     * 如果不带参数报400错误</span></span><br><span class="line"><span class="comment">     * 如果bean没有get、set方法，报错：</span></span><br><span class="line"><span class="comment">     * Resolved [org.springframework.web.HttpMediaTypeNotAcceptableException: Could not find acceptable representation]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/account&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Account <span class="title function_">account</span><span class="params">(<span class="meta">@RequestParam(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> accountService.getAAccountById(id);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/getAllCity&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;City&gt; <span class="title function_">getAllCity</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> cityService.getAllCity();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用postman测试</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/postCity&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">postCity</span><span class="params">(City city)</span> &#123;</span><br><span class="line">        <span class="type">City</span> <span class="variable">c</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">City</span>(<span class="literal">null</span>, <span class="string">&quot;xian&quot;</span>, <span class="string">&quot;shanxi&quot;</span>, <span class="string">&quot;china&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> cityService.addCity(c);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="整合-MybatisPlus"><a href="#整合-MybatisPlus" class="headerlink" title="整合 MybatisPlus"></a>整合 MybatisPlus</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/baomidou/mybatis-plus">MyBatis-Plus (opens new window)</a>（简称 MP）是一个 <a target="_blank" rel="noopener" href="https://www.mybatis.org/mybatis-3/">MyBatis (opens new window)</a>的增强工具，在 MyBatis 的基础上只做增强不做改变，为简化开发、提高效率而生。</p>
</blockquote>
<h5 id="引入依赖-3"><a href="#引入依赖-3" class="headerlink" title="引入依赖"></a>引入依赖</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="分析自动配置-2"><a href="#分析自动配置-2" class="headerlink" title="分析自动配置"></a>分析自动配置</h5><blockquote>
<p>spring.factories</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Auto Configure</span></span><br><span class="line"><span class="attr">org.springframework.boot.env.EnvironmentPostProcessor</span>=<span class="string">\</span></span><br><span class="line"><span class="string">  com.baomidou.mybatisplus.autoconfigure.SafetyEncryptProcessor</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span>=<span class="string">\</span></span><br><span class="line"><span class="string">  com.baomidou.mybatisplus.autoconfigure.MybatisPlusLanguageDriverAutoConfiguration,\</span></span><br><span class="line"><span class="string">  com.baomidou.mybatisplus.autoconfigure.MybatisPlusAutoConfiguration</span></span><br></pre></td></tr></table></figure>

<p>MybatisPlusAutoConfiguration</p>
<ul>
<li><p>MybatisPlusProperties 绑定了 mybatis-plus</p>
</li>
<li><p>默认的 mapperLocations &#x3D; new String[]{“classpath*:&#x2F;mapper&#x2F;**&#x2F;*.xml”};</p>
</li>
<li><p><strong>任意包的类路径下的所有mapper文件夹下任意路径下的所有xml都是sql映射文件</strong></p>
</li>
<li><p>自动配置好了 SqlSessionFactory 以及SqlSessionTemplate</p>
</li>
<li><p>在 Spring Boot 启动类中添加 <code>@MapperScan</code> 注解，扫描 Mapper 文件夹</p>
<blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.example.springboot.mapper&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringBootWebApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(SpringBootWebApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(&#123;SqlSessionFactory.class, SqlSessionFactoryBean.class&#125;)</span></span><br><span class="line"><span class="meta">@ConditionalOnSingleCandidate(DataSource.class)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(&#123;MybatisPlusProperties.class&#125;)</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(&#123;DataSourceAutoConfiguration.class, MybatisPlusLanguageDriverAutoConfiguration.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisPlusAutoConfiguration</span> <span class="keyword">implements</span> <span class="title class_">InitializingBean</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MybatisPlusProperties properties;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Interceptor[] interceptors;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TypeHandler[] typeHandlers;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LanguageDriver[] languageDrivers;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ResourceLoader resourceLoader;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DatabaseIdProvider databaseIdProvider;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;ConfigurationCustomizer&gt; configurationCustomizers;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;MybatisPlusPropertiesCustomizer&gt; mybatisPlusPropertiesCustomizers;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注意：</p>
<ul>
<li>实体类的beanMapper 只需要继承 <strong>BaseMapper</strong> 就可以拥有crud能力</li>
<li></li>
</ul>
</blockquote>
<h5 id="配置示例-2"><a href="#配置示例-2" class="headerlink" title="配置示例"></a>配置示例</h5><p><strong>只需要配合好数据源即可。</strong></p>
<p>mapperLocations 已经默认配置好，需要在类路径下创建 mapper 文件夹</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">org.h2.Driver</span></span><br><span class="line">    <span class="attr">schema:</span> <span class="string">classpath:db/schema-h2.sql</span></span><br><span class="line">    <span class="attr">data:</span> <span class="string">classpath:db/data-h2.sql</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:h2:mem:test</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">test</span></span><br></pre></td></tr></table></figure>

<p>表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">user</span></span><br><span class="line">(</span><br><span class="line">    id <span class="type">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;主键ID&#x27;</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">30</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">    age <span class="type">INT</span>(<span class="number">11</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;年龄&#x27;</span>,</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;邮箱&#x27;</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (id)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">user</span> (id, name, age, email) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="number">1</span>, <span class="string">&#x27;Jone&#x27;</span>, <span class="number">18</span>, <span class="string">&#x27;test1@baomidou.com&#x27;</span>),</span><br><span class="line">(<span class="number">2</span>, <span class="string">&#x27;Jack&#x27;</span>, <span class="number">20</span>, <span class="string">&#x27;test2@baomidou.com&#x27;</span>),</span><br><span class="line">(<span class="number">3</span>, <span class="string">&#x27;Tom&#x27;</span>, <span class="number">28</span>, <span class="string">&#x27;test3@baomidou.com&#x27;</span>),</span><br><span class="line">(<span class="number">4</span>, <span class="string">&#x27;Sandy&#x27;</span>, <span class="number">21</span>, <span class="string">&#x27;test4@baomidou.com&#x27;</span>),</span><br><span class="line">(<span class="number">5</span>, <span class="string">&#x27;Billie&#x27;</span>, <span class="number">24</span>, <span class="string">&#x27;test5@baomidou.com&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UserMapper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;User&gt; &#123;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BaseMapper包含了基本的CRUD</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BaseMapper</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">Mapper</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">insert</span><span class="params">(T entity)</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">deleteById</span><span class="params">(Serializable id)</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">deleteByMap</span><span class="params">(<span class="meta">@Param(&quot;cm&quot;)</span> Map&lt;String, Object&gt; columnMap)</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">delete</span><span class="params">(<span class="meta">@Param(&quot;ew&quot;)</span> Wrapper&lt;T&gt; queryWrapper)</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">deleteBatchIds</span><span class="params">(<span class="meta">@Param(&quot;coll&quot;)</span> Collection&lt;? extends Serializable&gt; idList)</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">updateById</span><span class="params">(<span class="meta">@Param(&quot;et&quot;)</span> T entity)</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">update</span><span class="params">(<span class="meta">@Param(&quot;et&quot;)</span> T entity, <span class="meta">@Param(&quot;ew&quot;)</span> Wrapper&lt;T&gt; updateWrapper)</span>;</span><br><span class="line">    T <span class="title function_">selectById</span><span class="params">(Serializable id)</span>;</span><br><span class="line">    List&lt;T&gt; <span class="title function_">selectBatchIds</span><span class="params">(<span class="meta">@Param(&quot;coll&quot;)</span> Collection&lt;? extends Serializable&gt; idList)</span>;</span><br><span class="line">    List&lt;T&gt; <span class="title function_">selectByMap</span><span class="params">(<span class="meta">@Param(&quot;cm&quot;)</span> Map&lt;String, Object&gt; columnMap)</span>;</span><br><span class="line">    T <span class="title function_">selectOne</span><span class="params">(<span class="meta">@Param(&quot;ew&quot;)</span> Wrapper&lt;T&gt; queryWrapper)</span>;</span><br><span class="line">    Integer <span class="title function_">selectCount</span><span class="params">(<span class="meta">@Param(&quot;ew&quot;)</span> Wrapper&lt;T&gt; queryWrapper)</span>;</span><br><span class="line">    List&lt;T&gt; <span class="title function_">selectList</span><span class="params">(<span class="meta">@Param(&quot;ew&quot;)</span> Wrapper&lt;T&gt; queryWrapper)</span>;</span><br><span class="line">    List&lt;Map&lt;String, Object&gt;&gt; <span class="title function_">selectMaps</span><span class="params">(<span class="meta">@Param(&quot;ew&quot;)</span> Wrapper&lt;T&gt; queryWrapper)</span>;</span><br><span class="line">    List&lt;Object&gt; <span class="title function_">selectObjs</span><span class="params">(<span class="meta">@Param(&quot;ew&quot;)</span> Wrapper&lt;T&gt; queryWrapper)</span>;</span><br><span class="line">    &lt;E <span class="keyword">extends</span> <span class="title class_">IPage</span>&lt;T&gt;&gt; E <span class="title function_">selectPage</span><span class="params">(E page, <span class="meta">@Param(&quot;ew&quot;)</span> Wrapper&lt;T&gt; queryWrapper)</span>;</span><br><span class="line">    &lt;E <span class="keyword">extends</span> <span class="title class_">IPage</span>&lt;Map&lt;String, Object&gt;&gt;&gt; E <span class="title function_">selectMapsPage</span><span class="params">(E page, <span class="meta">@Param(&quot;ew&quot;)</span> Wrapper&lt;T&gt; queryWrapper)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testUserMapper</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;User&gt; userList = userMapper.selectList(<span class="literal">null</span>);</span><br><span class="line">    userList.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h5><blockquote>
<p>默认实体类名和表名相同，并且实体类的字段在表中都存在，可以通过以下注解进行修改</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="comment">// 指定表名</span></span><br><span class="line"><span class="meta">@TableName(&quot;tbl_user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 排除其他属性</span></span><br><span class="line">    <span class="meta">@TableField(exist = false)</span></span><br><span class="line">    <span class="keyword">private</span> String otherField;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>UserService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserService</span> <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;User&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UserServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="comment">/*public class UserService implements IService&lt;User&gt; &#123;</span></span><br><span class="line"><span class="comment">	// 需要手动实现方法 </span></span><br><span class="line"><span class="comment">&#125;*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;UserMapper, User&gt; <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="分页插件配置"><a href="#分页插件配置" class="headerlink" title="分页插件配置"></a>分页插件配置</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisPlusConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新的分页插件,一缓和二缓遵循mybatis的规则,</span></span><br><span class="line"><span class="comment">     * 需要设置 MybatisConfiguration#useDeprecatedExecutor = false</span></span><br><span class="line"><span class="comment">     * 避免缓存出现问题(该属性会在旧插件移除后一同移除)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MybatisPlusInterceptor <span class="title function_">mybatisPlusInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MybatisPlusInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisPlusInterceptor</span>();</span><br><span class="line">        <span class="type">PaginationInnerInterceptor</span> <span class="variable">paginationInnerInterceptor</span> <span class="operator">=</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">PaginationInnerInterceptor</span>(DbType.MYSQL);</span><br><span class="line">        <span class="comment">// overflow：当请求的页面大于最大页后，true回到首页，false（默认）继续请求</span></span><br><span class="line">        paginationInnerInterceptor.setOverflow(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// maxLimit：最大单页限制数量：-1表示不受限制</span></span><br><span class="line">        paginationInnerInterceptor.setMaxLimit(<span class="number">500L</span>);</span><br><span class="line">        interceptor.addInnerInterceptor(paginationInnerInterceptor);</span><br><span class="line">        <span class="keyword">return</span> interceptor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="controller"><a href="#controller" class="headerlink" title="controller"></a>controller</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> UserService userService;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 重定向到当前页</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@GetMapping(&quot;/user/delete/&#123;id&#125;&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">deleteUser</span><span class="params">(<span class="meta">@PathVariable</span> Long id,</span></span><br><span class="line"><span class="params">                            <span class="meta">@RequestParam(value = &quot;pn&quot;, defaultValue = &quot;1&quot;)</span> Integer pn,</span></span><br><span class="line"><span class="params">                            RedirectAttributes ra)</span> &#123;</span><br><span class="line">       userService.removeById(id);</span><br><span class="line">       ra.addAttribute(<span class="string">&quot;pn&quot;</span>, pn);</span><br><span class="line">       <span class="keyword">return</span> <span class="string">&quot;redirect:/dynamic_table&quot;</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@GetMapping(&quot;/dynamic_table&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">dynamicTable</span><span class="params">(<span class="meta">@RequestParam(value = &quot;pn&quot;, defaultValue = &quot;1&quot;)</span> Integer pn,</span></span><br><span class="line"><span class="params">                              Model model)</span> &#123;</span><br><span class="line">       <span class="comment">/*List&lt;User&gt; users = Arrays.asList(new User(&quot;AA&quot;, &quot;AA-password&quot;),</span></span><br><span class="line"><span class="comment">               new User(&quot;BB&quot;, &quot;BB-password&quot;),</span></span><br><span class="line"><span class="comment">               new User(&quot;CC&quot;, &quot;CC-password&quot;));*/</span></span><br><span class="line">       Page&lt;User&gt; userPage = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(pn, <span class="number">2</span>);</span><br><span class="line">       Page&lt;User&gt; page = userService.page(userPage);</span><br><span class="line">       model.addAttribute(<span class="string">&quot;page&quot;</span>, page);</span><br><span class="line">       <span class="keyword">return</span> <span class="string">&quot;table/dynamic_table&quot;</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h2 id="NoSQL"><a href="#NoSQL" class="headerlink" title="NoSQL"></a>NoSQL</h2><blockquote>
<p>​		Redis 是一个开源（BSD许可）的，内存中的数据结构存储系统，它可以用作数据库、<strong>缓存</strong>和消息中间件。 它支持多种类型的数据结构，如 <a target="_blank" rel="noopener" href="http://www.redis.cn/topics/data-types-intro.html#strings">字符串（strings）</a>， <a target="_blank" rel="noopener" href="http://www.redis.cn/topics/data-types-intro.html#hashes">散列（hashes）</a>， <a target="_blank" rel="noopener" href="http://www.redis.cn/topics/data-types-intro.html#lists">列表（lists）</a>， <a target="_blank" rel="noopener" href="http://www.redis.cn/topics/data-types-intro.html#sets">集合（sets）</a>， <a target="_blank" rel="noopener" href="http://www.redis.cn/topics/data-types-intro.html#sorted-sets">有序集合（sorted sets）</a> 与范围查询， <a target="_blank" rel="noopener" href="http://www.redis.cn/topics/data-types-intro.html#bitmaps">bitmaps</a>， <a target="_blank" rel="noopener" href="http://www.redis.cn/topics/data-types-intro.html#hyperloglogs">hyperloglogs</a> 和 <a target="_blank" rel="noopener" href="http://www.redis.cn/commands/geoadd.html">地理空间（geospatial）</a> 索引半径查询。 Redis 内置了 <a target="_blank" rel="noopener" href="http://www.redis.cn/topics/replication.html">复制（replication）</a>，<a target="_blank" rel="noopener" href="http://www.redis.cn/commands/eval.html">LUA脚本（Lua scripting）</a>， <a target="_blank" rel="noopener" href="http://www.redis.cn/topics/lru-cache.html">LRU驱动事件（LRU eviction）</a>，<a target="_blank" rel="noopener" href="http://www.redis.cn/topics/transactions.html">事务（transactions）</a> 和不同级别的 <a target="_blank" rel="noopener" href="http://www.redis.cn/topics/persistence.html">磁盘持久化（persistence）</a>， 并通过 <a target="_blank" rel="noopener" href="http://www.redis.cn/topics/sentinel.html">Redis哨兵（Sentinel）</a>和自动 <a target="_blank" rel="noopener" href="http://www.redis.cn/topics/cluster-tutorial.html">分区（Cluster）</a>提供高可用性（high availability）。</p>
</blockquote>
<h3 id="Redis自动配置"><a href="#Redis自动配置" class="headerlink" title="Redis自动配置"></a>Redis自动配置</h3><h4 id="引入依赖-4"><a href="#引入依赖-4" class="headerlink" title="引入依赖"></a>引入依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="分析自动配置-3"><a href="#分析自动配置-3" class="headerlink" title="分析自动配置"></a>分析自动配置</h4><blockquote>
<p>RedisAutoConfiguration </p>
<p>RedisProperties 和 spring.redis绑定</p>
<p>引入了两个连接工厂：LettuceConnectionConfiguration（默认），JedisConnectionConfiguration</p>
<p><strong>自动注入了RedisTemplate</strong>&lt;**Object**, **Object**&gt; </p>
<p><strong>自动注入了StringRedisTemplate；k：v 都是String</strong></p>
<p><strong>底层只要我们使用</strong> <strong>StringRedisTemplate、</strong>RedisTemplate就可以操作redis</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoConfiguration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(RedisOperations.class)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(RedisProperties.class)</span></span><br><span class="line"><span class="meta">@Import(&#123; LettuceConnectionConfiguration.class, JedisConnectionConfiguration.class &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisAutoConfiguration</span> &#123;</span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean(name = &quot;redisTemplate&quot;)</span></span><br><span class="line">	<span class="meta">@ConditionalOnSingleCandidate(RedisConnectionFactory.class)</span></span><br><span class="line">	<span class="keyword">public</span> RedisTemplate&lt;Object, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span> &#123;</span><br><span class="line">		RedisTemplate&lt;Object, Object&gt; template = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line">		template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">		<span class="keyword">return</span> template;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">	<span class="meta">@ConditionalOnSingleCandidate(RedisConnectionFactory.class)</span></span><br><span class="line">	<span class="keyword">public</span> StringRedisTemplate <span class="title function_">stringRedisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringRedisTemplate</span>(redisConnectionFactory);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="切换-Jedis"><a href="#切换-Jedis" class="headerlink" title="切换 Jedis"></a>切换 Jedis</h4><blockquote>
<ol>
<li>引入依赖：</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>2. 修改配置 spring.redis.client-type&#x3D;jedis</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(RedisClient.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(name = &quot;spring.redis.client-type&quot;, havingValue = &quot;lettuce&quot;, matchIfMissing = true)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LettuceConnectionConfiguration</span> <span class="keyword">extends</span> <span class="title class_">RedisConnectionConfiguration</span> &#123;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.100</span><span class="number">.100</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">      <span class="attr">client-type:</span> <span class="string">jedis</span></span><br><span class="line">      <span class="attr">jedis:</span></span><br><span class="line">        <span class="attr">pool:</span></span><br><span class="line">          <span class="attr">max-active:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="测试连接-1"><a href="#测试连接-1" class="headerlink" title="测试连接"></a>测试连接</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testRedisConnection</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ValueOperations</span> <span class="variable">ops</span> <span class="operator">=</span> redisTemplate.opsForValue();</span><br><span class="line">    ops.set(<span class="string">&quot;k1&quot;</span>, <span class="string">&quot;v1&quot;</span>);</span><br><span class="line">    <span class="type">Object</span> <span class="variable">v1</span> <span class="operator">=</span> ops.get(<span class="string">&quot;k2&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;k1 = &quot;</span> + v1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="URI-统计"><a href="#URI-统计" class="headerlink" title="URI 统计"></a>URI 统计</h4><p>拦截器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisUrlCountInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> request.getRequestURI();</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;/main.html&quot;</span>.equals(uri) || <span class="string">&quot;/sql&quot;</span>.equals(uri)) &#123;</span><br><span class="line">            redisTemplate.opsForValue().increment(uri);</span><br><span class="line">            System.out.println(<span class="string">&quot;uri: &quot;</span> + uri);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置拦截器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisUrlCountInterceptor redisUrlCountInterceptor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(redisUrlCountInterceptor)</span><br><span class="line">                .addPathPatterns(<span class="string">&quot;/**&quot;</span>)</span><br><span class="line">                .excludePathPatterns(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;login&quot;</span>, <span class="string">&quot;/css/**&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/main.html&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">mainPage</span><span class="params">(HttpSession session, Model model)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">main</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;/main.html&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;/sql&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;main:&quot;</span> + main + <span class="string">&quot;,sql: &quot;</span> + sql);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;mainCount&quot;</span>, main);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;sqlCount&quot;</span>, sql);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;main&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h1><h2 id="JUnit5-的变化"><a href="#JUnit5-的变化" class="headerlink" title="JUnit5 的变化"></a>JUnit5 的变化</h2><p>Junit类具有Spring的功能，@Autowired、比如 @Transactional 标注测试方法，测试完成后自动回滚</p>
<blockquote>
<p><strong>Spring Boot 2.2.0 版本开始引入 JUnit 5 作为单元测试默认库</strong></p>
<p>作为最新版本的JUnit框架，JUnit5与之前版本的Junit框架有很大的不同。由三个不同子项目的几个不同模块组成。</p>
<p><strong>JUnit 5 &#x3D; JUnit Platform + JUnit Jupiter + JUnit Vintage</strong></p>
<p><strong>JUnit Platform</strong>: Junit Platform是在JVM上启动测试框架的基础，不仅支持Junit自制的测试引擎，其他测试引擎也都可以接入。</p>
<p><strong>JUnit Jupiter</strong>: JUnit Jupiter提供了JUnit5的新的编程模型，是JUnit5新特性的核心。内部 包含了一个<strong>测试引擎</strong>，用于在Junit Platform上运行。</p>
<p><strong>JUnit Vintage</strong>: 由于JUint 已经发展多年，为了照顾老的项目，JUnit Vintage提供了兼容JUnit4.x,Junit3.x的测试引擎。</p>
</blockquote>
<blockquote>
<p>注意：</p>
<p><strong>SpringBoot 2.4 以上版本移除了默认对</strong> <strong>Vintage 的依赖。如果需要兼容junit4需要自行引入（不能使用junit4的功能 @Test</strong>）</p>
<p><strong>JUnit 5’s Vintage Engine Removed from</strong> spring-boot-starter-test，如果需要继续兼容 junit4需要自行引入vintage</p>
<ol>
<li>引入 Junit4 依赖</li>
<li>排除 hamcrest-core</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.vintage<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-vintage-engine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hamcrest<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hamcrest-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p><strong>引入依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="JUnit5常用注解"><a href="#JUnit5常用注解" class="headerlink" title="JUnit5常用注解"></a>JUnit5常用注解</h2><p>JUnit5的注解与JUnit4的注解有所变化</p>
<p><a target="_blank" rel="noopener" href="https://junit.org/junit5/docs/current/user-guide/#writing-tests-annotations">https://junit.org/junit5/docs/current/user-guide/#writing-tests-annotations</a></p>
<blockquote>
<ul>
<li>**@Test :**表示方法是测试方法。但是与JUnit4的@Test不同，他的职责非常单一不能声明任何属性，拓展的测试将会由Jupiter提供额外测试</li>
<li>**@ParameterizedTest :**表示方法是参数化测试，下方会有详细介绍</li>
<li>**@RepeatedTest :**表示方法可重复执行，下方会有详细介绍</li>
<li>**@DisplayName :**为测试类或者测试方法设置展示名称</li>
<li>**@BeforeEach :**表示在每个单元测试之前执行</li>
<li>**@AfterEach :**表示在每个单元测试之后执行</li>
<li>**@BeforeAll :**表示在所有单元测试之前执行</li>
<li>**@AfterAll :**表示在所有单元测试之后执行</li>
<li>**@Tag :**表示单元测试类别，类似于JUnit4中的@Categories</li>
<li>**@Disabled :**表示测试类或测试方法不执行，类似于JUnit4中的@Ignore</li>
<li>**@Timeout :**表示测试方法运行如果超过了指定时间将会返回错误</li>
<li>**@ExtendWith :**为测试类或测试方法提供扩展类引用</li>
<li>RepeatTest：测试方法重复执行多少次</li>
</ul>
</blockquote>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.WebManageApplication;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@DisplayName(&quot;Junit5功能测试&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Junit5Test</span> &#123;</span><br><span class="line">    <span class="meta">@DisplayName(&quot;测试DisplayName&quot;)</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testDisplayName</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;测试DisplayName&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 每个方法之前执行</span></span><br><span class="line">    <span class="meta">@BeforeEach</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testBeforeEach</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;BeforeEach...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@BeforeEach</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testAfterEach</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;AfterEach...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注意：</span></span><br><span class="line"><span class="comment">     * org.junit.platform.commons.JUnitException: <span class="doctag">@BeforeAll</span> method</span></span><br><span class="line"><span class="comment">     * &#x27;void com.example.WebManageApplication.Junit5Test.testBeforeAll()&#x27;</span></span><br><span class="line"><span class="comment">     * must be static unless the test class is annotated with <span class="doctag">@TestInstance</span>(Lifecycle.PER_CLASS).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 所有方法之前执行，只执行一次</span></span><br><span class="line">    <span class="meta">@BeforeAll</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">testBeforeAll</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;BeforeAll....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterAll</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">testAfterAll</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;AfterAll....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 不执行该测试方法</span></span><br><span class="line">    <span class="meta">@Disabled</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testDisabled</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Disabled...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 超时</span></span><br><span class="line">    <span class="meta">@Timeout(value = 5, unit = TimeUnit.SECONDS)</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testTimeout</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">6000</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;Timeout...&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重复执行4次</span></span><br><span class="line">    <span class="meta">@RepeatedTest(4)</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testRepeatTest</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;RepeatTest...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>测试结果：</p>
<p><img src="/2023/03/14/SpringBoot2/Java\SpringBoot\SpringBoot2.assets\image-20221022194150440.png" alt="image-20221022194150440"></p>
<h2 id="断言（assertions）"><a href="#断言（assertions）" class="headerlink" title="断言（assertions）"></a>断言（assertions）</h2><blockquote>
<p>断言（assertions）是测试方法中的核心部分，用来对测试需要满足的条件进行验证。<strong>这些断言方法都是 org.junit.jupiter.api.Assertions 的静态方法</strong>。JUnit 5 内置的断言可以分成如下几个类别：</p>
<p><strong>检查业务逻辑返回的数据是否合理。</strong></p>
<p><strong>所有的测试运行结束以后，会有一个详细的测试报告；</strong></p>
</blockquote>
<h3 id="简单断言"><a href="#简单断言" class="headerlink" title="简单断言"></a>简单断言</h3><p>用来对单个值进行简单的验证。如：</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>assertEquals</td>
<td>判断两个对象或两个原始类型是否相等</td>
</tr>
<tr>
<td>assertNotEquals</td>
<td>判断两个对象或两个原始类型是否不相等</td>
</tr>
<tr>
<td>assertSame</td>
<td>判断两个对象引用是否指向同一个对象</td>
</tr>
<tr>
<td>assertNotSame</td>
<td>判断两个对象引用是否指向不同的对象</td>
</tr>
<tr>
<td>assertTrue</td>
<td>判断给定的布尔值是否为 true</td>
</tr>
<tr>
<td>assertFalse</td>
<td>判断给定的布尔值是否为 false</td>
</tr>
<tr>
<td>assertNull</td>
<td>判断给定的对象引用是否为 null</td>
</tr>
<tr>
<td>assertNotNull</td>
<td>判断给定的对象引用是否不为 null</td>
</tr>
</tbody></table>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 前面断言失败，则后面的断言不会执行</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@DisplayName(&quot;测试简单断言&quot;)</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSimpleAssert</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">ret</span> <span class="operator">=</span> cal(<span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line">    <span class="comment">//        assertEquals(1, ret, &quot;期望值和计算值不相等&quot;);</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">obj1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="type">Object</span> <span class="variable">obj2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    assertSame(obj1, obj2, <span class="string">&quot;对象引用不同&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">cal</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="数组断言"><a href="#数组断言" class="headerlink" title="数组断言"></a>数组断言</h3><blockquote>
<p>通过 assertArrayEquals 方法来判断两个对象或原始类型的数组是否相等。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DisplayName(&quot;测试数组断言&quot;)</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testArrayAssert</span><span class="params">()</span> &#123;</span><br><span class="line">    assertArrayEquals(<span class="keyword">new</span> <span class="title class_">int</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>&#125;, <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;<span class="number">2</span>, <span class="number">1</span>&#125;, <span class="string">&quot;数组断言失败&quot;</span>);</span><br><span class="line">    <span class="comment">// org.opentest4j.AssertionFailedError:</span></span><br><span class="line">    <span class="comment">// 数组断言失败 ==&gt; array contents differ at index [0], expected: &lt;1&gt; but was: &lt;2&gt;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="组合断言"><a href="#组合断言" class="headerlink" title="组合断言"></a>组合断言</h3><blockquote>
<p>assertAll 方法接受多个 org.junit.jupiter.api.Executable 函数式接口的实例作为要验证的断言，可以通过 lambda 表达式很容易的提供这些断言</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DisplayName(&quot;测试组合断言&quot;)</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testAssertAll</span><span class="params">()</span> &#123;</span><br><span class="line">    assertAll(<span class="string">&quot;Math&quot;</span>,</span><br><span class="line">            () -&gt; assertEquals(<span class="number">3</span>, <span class="number">1</span> + <span class="number">2</span>, <span class="string">&quot;计算值不等于3&quot;</span>),</span><br><span class="line">            () -&gt; assertTrue(<span class="number">2</span> &lt; <span class="number">1</span>, <span class="string">&quot;数字大小判断错误&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="异常断言"><a href="#异常断言" class="headerlink" title="异常断言"></a>异常断言</h3><blockquote>
<p>在JUnit4时期，想要测试方法的异常情况时，需要用**@Rule<strong>注解的ExpectedException变量还是比较麻烦的。而JUnit5提供了一种新的断言方式</strong>Assertions.assertThrows()** ,配合函数式编程就可以进行使用。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DisplayName(&quot;异常断言&quot;)</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testExceptionAssert</span><span class="params">()</span> &#123;</span><br><span class="line">    assertThrows(ArithmeticException.class, () -&gt; &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">10</span> / <span class="number">1</span>;</span><br><span class="line">    &#125;, <span class="string">&quot;业务逻辑没有出现异常&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="超时断言"><a href="#超时断言" class="headerlink" title="超时断言"></a>超时断言</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 超时</span></span><br><span class="line"><span class="comment">// @Timeout(value = 5, unit = TimeUnit.SECONDS)</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testTimeout</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(<span class="number">6000</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Timeout...&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="快速失败"><a href="#快速失败" class="headerlink" title="快速失败"></a>快速失败</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DisplayName(&quot;快速失败&quot;)</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testFail</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">2</span> == <span class="number">2</span>) &#123;</span><br><span class="line">        fail(<span class="string">&quot;测试失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="前置条件"><a href="#前置条件" class="headerlink" title="前置条件"></a>前置条件</h2><blockquote>
<p>JUnit 5 中的前置条件（<strong>assumptions【假设】</strong>）类似于断言，不同之处在于<strong>不满足的断言会使得测试方法失败</strong>，而不满足的<strong>前置条件只会使得测试方法的执行终止</strong>。前置条件可以看成是测试方法执行的前提，当该前提不满足时，就没有继续执行的必要。</p>
<p>assumeTrue 和 assumFalse 确保给定的条件为 true 或 false，不满足条件会使得测试执行终止。assumingThat 的参数是表示条件的布尔值和对应的 Executable 接口的实现对象。只有条件满足时，Executable 对象才会被执行；当条件不满足时，测试执行并不会终止。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DisplayName(&quot;前置条件&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AssumptionsTest</span> &#123;</span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">environment</span> <span class="operator">=</span> <span class="string">&quot;DEV&quot;</span>;</span><br><span class="line"> </span><br><span class="line"> <span class="meta">@Test</span></span><br><span class="line"> <span class="meta">@DisplayName(&quot;simple&quot;)</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">simpleAssume</span><span class="params">()</span> &#123;</span><br><span class="line">    assumeTrue(Objects.equals(<span class="built_in">this</span>.environment, <span class="string">&quot;DEV&quot;</span>));</span><br><span class="line">    assumeFalse(() -&gt; Objects.equals(<span class="built_in">this</span>.environment, <span class="string">&quot;PROD&quot;</span>));</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="meta">@Test</span></span><br><span class="line"> <span class="meta">@DisplayName(&quot;assume then do&quot;)</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">assumeThenDo</span><span class="params">()</span> &#123;</span><br><span class="line">    assumingThat(</span><br><span class="line">       Objects.equals(<span class="built_in">this</span>.environment, <span class="string">&quot;DEV&quot;</span>),</span><br><span class="line">       () -&gt; System.out.println(<span class="string">&quot;In DEV&quot;</span>)</span><br><span class="line">    );</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="嵌套测试"><a href="#嵌套测试" class="headerlink" title="嵌套测试"></a>嵌套测试</h2><blockquote>
<p>JUnit 5 可以通过 Java 中的内部类和@Nested 注解实现嵌套测试，从而可以更好的把相关的测试方法组织在一起。在内部类中可以使用@BeforeEach 和@AfterEach 注解，而且嵌套的层次没有限制。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.*;</span><br><span class="line"><span class="keyword">import</span> java.util.EmptyStackException;</span><br><span class="line"><span class="keyword">import</span> java.util.Stack;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.junit.jupiter.api.Assertions.*;</span><br><span class="line"><span class="meta">@DisplayName(&quot;A stack&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestingAStackDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    Stack&lt;Object&gt; stack;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="meta">@DisplayName(&quot;is instantiated with new Stack()&quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">isInstantiatedWithNew</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Stack</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nested</span></span><br><span class="line">    <span class="meta">@DisplayName(&quot;when new&quot;)</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">WhenNew</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@BeforeEach</span></span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">createNewStack</span><span class="params">()</span> &#123;</span><br><span class="line">            stack = <span class="keyword">new</span> <span class="title class_">Stack</span>&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Test</span></span><br><span class="line">        <span class="meta">@DisplayName(&quot;is empty&quot;)</span></span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">isEmpty</span><span class="params">()</span> &#123;</span><br><span class="line">            assertTrue(stack.isEmpty());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Test</span></span><br><span class="line">        <span class="meta">@DisplayName(&quot;throws EmptyStackException when popped&quot;)</span></span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">throwsExceptionWhenPopped</span><span class="params">()</span> &#123;</span><br><span class="line">            assertThrows(EmptyStackException.class, stack::pop);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Test</span></span><br><span class="line">        <span class="meta">@DisplayName(&quot;throws EmptyStackException when peeked&quot;)</span></span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">throwsExceptionWhenPeeked</span><span class="params">()</span> &#123;</span><br><span class="line">            assertThrows(EmptyStackException.class, stack::peek);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Nested</span></span><br><span class="line">        <span class="meta">@DisplayName(&quot;after pushing an element&quot;)</span></span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">AfterPushing</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">anElement</span> <span class="operator">=</span> <span class="string">&quot;an element&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@BeforeEach</span></span><br><span class="line">            <span class="keyword">void</span> <span class="title function_">pushAnElement</span><span class="params">()</span> &#123;</span><br><span class="line">                stack.push(anElement);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Test</span></span><br><span class="line">            <span class="meta">@DisplayName(&quot;it is no longer empty&quot;)</span></span><br><span class="line">            <span class="keyword">void</span> <span class="title function_">isNotEmpty</span><span class="params">()</span> &#123;</span><br><span class="line">                assertFalse(stack.isEmpty());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Test</span></span><br><span class="line">            <span class="meta">@DisplayName(&quot;returns the element when popped and is empty&quot;)</span></span><br><span class="line">            <span class="keyword">void</span> <span class="title function_">returnElementWhenPopped</span><span class="params">()</span> &#123;</span><br><span class="line">                assertEquals(anElement, stack.pop());</span><br><span class="line">                assertTrue(stack.isEmpty());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Test</span></span><br><span class="line">            <span class="meta">@DisplayName(&quot;returns the element when peeked but remains not empty&quot;)</span></span><br><span class="line">            <span class="keyword">void</span> <span class="title function_">returnElementWhenPeeked</span><span class="params">()</span> &#123;</span><br><span class="line">                assertEquals(anElement, stack.peek());</span><br><span class="line">                assertFalse(stack.isEmpty());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="参数化测试"><a href="#参数化测试" class="headerlink" title="参数化测试"></a>参数化测试</h2><blockquote>
<p>参数化测试是JUnit5很重要的一个新特性，它使得用不同的参数多次运行测试成为了可能，也为我们的单元测试带来许多便利。</p>
<p>利用**@ValueSource**等注解，指定入参，我们将可以使用不同的参数进行多次单元测试，而不需要每新增一个参数就新增一个单元测试，省去了很多冗余代码。</p>
<p><strong>@ValueSource</strong>: 为参数化测试指定入参来源，支持八大基础类以及String类型,Class类型</p>
<p><strong>@NullSource</strong>: 表示为参数化测试提供一个null的入参</p>
<p><strong>@EnumSource</strong>: 表示为参数化测试提供一个枚举入参</p>
<p><strong>@CsvFileSource</strong>：表示读取指定CSV文件内容作为参数化测试入参</p>
<p><strong>@MethodSource</strong>：表示读取指定方法的返回值作为参数化测试入参(注意方法返回需要是一个流)</p>
</blockquote>
<blockquote>
<p>当然如果参数化测试仅仅只能做到指定普通的入参还达不到让我觉得惊艳的地步。让我真正感到他的强大之处的地方在于他可以支持外部的各类入参。如:CSV,YML,JSON 文件甚至方法的返回值也可以作为入参。只需要去实现<strong>ArgumentsProvider</strong>接口，任何外部文件都可以作为它的入参。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DisplayName(&quot;参数化测试&quot;)</span></span><br><span class="line"><span class="meta">@ParameterizedTest</span></span><br><span class="line"><span class="comment">// 通过方法传参</span></span><br><span class="line"><span class="meta">@MethodSource(&quot;stringProvider&quot;)</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testWithSourceValue2</span><span class="params">(String str)</span> &#123;</span><br><span class="line">    System.out.println(str);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="迁移指南"><a href="#迁移指南" class="headerlink" title="迁移指南"></a>迁移指南</h2><blockquote>
<p>在进行迁移的时候需要注意如下的变化：</p>
<ul>
<li>注解在 org.junit.jupiter.api 包中，断言在 org.junit.jupiter.api.Assertions 类中，前置条件在 org.junit.jupiter.api.Assumptions 类中。</li>
<li>把@Before 和@After 替换成@BeforeEach 和@AfterEach。</li>
<li>把@BeforeClass 和@AfterClass 替换成@BeforeAll 和@AfterAll。</li>
<li>把@Ignore 替换成@Disabled。</li>
<li>把@Category 替换成@Tag。</li>
<li>把@RunWith、@Rule 和@ClassRule 替换成@ExtendWith。</li>
</ul>
</blockquote>
<h1 id="指标监控"><a href="#指标监控" class="headerlink" title="指标监控"></a>指标监控</h1><h2 id="SpringBoot-Actuator"><a href="#SpringBoot-Actuator" class="headerlink" title="SpringBoot Actuator"></a>SpringBoot Actuator</h2><h3 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h3><blockquote>
<p>未来每一个微服务在云上部署以后，我们都需要对其进行监控、追踪、审计、控制等。SpringBoot就抽取了Actuator场景，使得我们每个微服务快速引用即可获得生产级别的应用监控、审计等功能。</p>
</blockquote>
<h1 id="高级特性"><a href="#高级特性" class="headerlink" title="高级特性"></a>高级特性</h1><h2 id="环境切换"><a href="#环境切换" class="headerlink" title="环境切换"></a>环境切换</h2><h3 id="Profile条件装配"><a href="#Profile条件装配" class="headerlink" title="@Profile条件装配"></a>@Profile条件装配</h3><blockquote>
<p>为了方便多环境适配，springboot简化了@profile功能。</p>
<h2 id="application-profile功能"><a href="#application-profile功能" class="headerlink" title="application-profile功能"></a>application-profile功能</h2><ul>
<li><p>默认配置文件  application.yaml；任何时候都会加载</p>
</li>
<li><p>指定环境配置文件  application-{env}.yaml</p>
</li>
<li><p>激活指定环境</p>
</li>
<li><ul>
<li>配置文件激活<ul>
<li>命令行激活：java -jar xxx.jar –**spring.profiles.active&#x3D;prod  –person.name&#x3D;aaa</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li><strong>修改配置文件的任意值，命令行优先</strong></li>
</ul>
</li>
</ul>
</li>
<li><p>默认配置与环境配置同时生效</p>
</li>
<li><p>同名配置项，profile配置优先</p>
</li>
</ul>
</blockquote>
<p>示例：</p>
<p>创建 Worker 和 Boss 类，都继承于 Person</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.springboot.bean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="comment">// 生产环境和默认环境都会生效</span></span><br><span class="line"><span class="meta">@Profile(&#123;&quot;prod&quot;,&quot;default&quot;&#125;)</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;person&quot;)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Boss</span> <span class="keyword">extends</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Profile(&quot;test&quot;)</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;person&quot;)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Worker</span> <span class="keyword">extends</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//@Profile()    // 标注生效环境</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean(&quot;red&quot;)</span></span><br><span class="line">    <span class="meta">@Profile(&quot;test&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Color <span class="title function_">red</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Color</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;green&quot;)</span></span><br><span class="line">    <span class="meta">@Profile(&quot;prod&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Color <span class="title function_">green</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Color</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置文件：</p>
<p>application-prod.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">person:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prod-name</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9000</span></span><br></pre></td></tr></table></figure>

<p>application-test.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">person:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-name</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7000</span></span><br></pre></td></tr></table></figure>

<p>默认配置：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">person.name</span>=<span class="string">default-name</span></span><br><span class="line"><span class="attr">spring.profiles.active</span>=<span class="string">test</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server.port</span>=<span class="string">8000</span></span><br></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line">    <span class="comment">// 冒号表示默认值</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;person.name:none-name&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Person person;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/person&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">person</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.person.getClass().toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>使用 spring.profile.active&#x3D;prod 指定默认的 prod 环境</li>
<li>也可以使用 java -jar xxx.jar –**spring.profiles.active&#x3D;prod  –person.name&#x3D;aaa</li>
</ul>
<h3 id="Profile分组"><a href="#Profile分组" class="headerlink" title="@Profile分组"></a>@Profile分组</h3><p>同一分组条件下的所有配置都会生效。</p>
<p>示例：新建 application-proddb-yaml 和 application-prodmq.yaml，当指定环境为 production 时，两者都会生效。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.profiles.group.production[0]</span>=<span class="string">proddb</span></span><br><span class="line"><span class="attr">spring.profiles.group.production[1]</span>=<span class="string">prodmq</span></span><br><span class="line"></span><br><span class="line"><span class="attr">使用：--spring.profiles.active</span>=<span class="string">production  激活</span></span><br></pre></td></tr></table></figure>

<h2 id="配置加载的优先级"><a href="#配置加载的优先级" class="headerlink" title="配置加载的优先级"></a>配置加载的优先级</h2><h3 id="外部化配置"><a href="#外部化配置" class="headerlink" title="外部化配置"></a>外部化配置</h3><p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-external-config">https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-external-config</a></p>
<p>SpringBoot 可以接受的配置来源：</p>
<p><strong>Java属性文件</strong>、<strong>YAML文件</strong>、<strong>环境变量</strong>、<strong>命令行参数等</strong></p>
<blockquote>
<ol>
<li>Default properties (specified by setting <code>SpringApplication.setDefaultProperties</code>).</li>
<li><code>@PropertySource</code> annotations on your <code>@Configuration</code> classes. Please note that such property sources are not added to the <code>Environment</code> until the application context is being refreshed. This is too late to configure certain properties such as <code>logging.*</code> and <code>spring.main.*</code> which are read before refresh begins.</li>
<li><strong>Config data (such as</strong> <code>**application.properties**</code> <strong>files)</strong></li>
<li>A <code>RandomValuePropertySource</code> that has properties only in <code>random.*</code>.</li>
<li>OS environment variables.</li>
<li>Java System properties (<code>System.getProperties()</code>).</li>
<li>JNDI attributes from <code>java:comp/env</code>.</li>
<li><code>ServletContext</code> init parameters.</li>
<li><code>ServletConfig</code> init parameters.</li>
<li>Properties from <code>SPRING_APPLICATION_JSON</code> (inline JSON embedded in an environment variable or system property).</li>
<li>Command line arguments.</li>
<li><code>properties</code> attribute on your tests. Available on <code>@SpringBootTest</code> and the <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-testing-spring-boot-applications-testing-autoconfigured-tests">test annotations for testing a particular slice of your application</a>.</li>
<li><code>@TestPropertySource</code> annotations on your tests.</li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/using-spring-boot.html#using-boot-devtools-globalsettings">Devtools global settings properties</a> in the <code>$HOME/.config/spring-boot</code> directory when devtools is active.</li>
</ol>
<p><strong>注意：后面的会覆盖前面的。</strong></p>
</blockquote>
<h3 id="配置文件查找位置"><a href="#配置文件查找位置" class="headerlink" title="配置文件查找位置"></a>配置文件查找位置</h3><blockquote>
<p>(1) classpath 根路径</p>
<p>(2) classpath 根路径下config目录</p>
<p>(3) jar包当前目录</p>
<p>(4) jar包当前目录的config目录</p>
<p>(5) &#x2F;config子目录的直接子目录（Linux环境下）</p>
<p><strong>注意：后面的会覆盖前面的。</strong></p>
</blockquote>
<h3 id="配置文件的加载顺序"><a href="#配置文件的加载顺序" class="headerlink" title="配置文件的加载顺序"></a>配置文件的加载顺序</h3><blockquote>
<ol>
<li>　当前 jar 包内部的 application.properties 和 application.yml</li>
<li>　当前jar包内部的application-{profile}.properties 和 application-{profile}.yml</li>
<li>　引用的外部jar包的application.properties和application.yml</li>
<li>　引用的外部jar包的application-{profile}.properties 和 application-{profile}.yml</li>
</ol>
<p><strong>注意：后面的会覆盖前面的。</strong></p>
</blockquote>
<p><strong>注意：指定环境优先，外部优先，后面的可以覆盖前面的同名配置项</strong></p>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value(&quot;$&#123;JAVA_HOME&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String javaHome;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value(&quot;$&#123;os.name&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String osName;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/system&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">system</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> javaHome + <span class="string">&quot; : &quot;</span> + osName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="自定义starter"><a href="#自定义starter" class="headerlink" title="自定义starter"></a>自定义starter</h2><h3 id="starter启动原理"><a href="#starter启动原理" class="headerlink" title="starter启动原理"></a>starter启动原理</h3><blockquote>
<img src="/2023/03/14/SpringBoot2/Java\SpringBoot\SpringBoot2.assets\image-20221025191311999.png" alt="image-20221025191311999" style="zoom:67%;">

<ul>
<li><p>autoconfigure包中配置使用 <strong>META-INF&#x2F;spring.factories</strong> 中 <strong>EnableAutoConfiguration 的值，使得项目启动加载指定的自动配置类</strong></p>
</li>
<li><p><strong>编写自动配置类 xxxAutoConfiguration -&gt; xxxxProperties</strong></p>
</li>
<li><ul>
<li><strong>@Configuration</strong><ul>
<li><strong>@Conditional</strong></li>
<li><strong>@EnableConfigurationProperties</strong></li>
<li><strong>@Bean</strong></li>
</ul>
</li>
</ul>
</li>
</ul>
</blockquote>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><blockquote>
<p>example-hello-spring-boot-starter（启动器）</p>
<p><strong>example-hello-spring-boot-starter-autoconfigure（自动配置包）</strong></p>
</blockquote>
<p>步骤：</p>
<p>新建空工程：example-hello-spring-boot-starter，该工程引入模块 example-hello-spring-boot-starter-autoconfigure</p>
<p>在example-hello-spring-boot-starter-autoconfigure中引入底层的spring-boot-starter。</p>
<p><strong>example-hello-spring-boot-starter：</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>example-hello-spring-boot-starter-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>example-hello-spring-boot-starter-autoconfigure：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>        </span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                   <span class="comment">&lt;!-- 取消查找本项目下的Main方法：为了解决Unable to find main class的问题 --&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>none<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span>  </span><br><span class="line">                    <span class="comment">&lt;!-- 为了解决依赖模块找不到此模块中的类或属性 --&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">classifier</span>&gt;</span>execute<span class="tag">&lt;/<span class="name">classifier</span>&gt;</span>   </span><br><span class="line">               <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在META-INF&#x2F;spring.factories中：</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=<span class="keyword">\</span></span><br><span class="line"><span class="keyword"></span>com.example.hellostarter.auto.HelloServiceAutoConfiguration</span><br></pre></td></tr></table></figure>

<p>服务类HelloService：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.hellostarter.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.hellostarter.bean.HelloProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="comment">// 该类不放入容器，由ConditionalXXX决定</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String identify;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> HelloProperties helloProperties;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> helloProperties.getPrefix() + <span class="string">&quot; : &quot;</span> + name + <span class="string">&quot; : &quot;</span> + helloProperties.getSuffix();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getIdentify</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> identify;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setIdentify</span><span class="params">(String identify)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.identify = identify;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>自动配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.hellostarter.auto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.hellostarter.bean.HelloProperties;</span><br><span class="line"><span class="keyword">import</span> com.example.hellostarter.service.HelloService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.EnableConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//@ConditionalOnMissingBean(HelloService.class)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(HelloProperties.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloServiceAutoConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean(HelloService.class)</span></span><br><span class="line">    <span class="keyword">public</span> HelloService <span class="title function_">helloService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">HelloService</span> <span class="variable">helloService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HelloService</span>();</span><br><span class="line">        <span class="keyword">return</span> helloService;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>属性绑定：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.hellostarter.bean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ConfigurationProperties(&quot;example.hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloProperties</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String prefix;</span><br><span class="line">    <span class="keyword">private</span> String suffix;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPrefix</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> prefix;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPrefix</span><span class="params">(String prefix)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.prefix = prefix;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getSuffix</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> suffix;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSuffix</span><span class="params">(String suffix)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.suffix = suffix;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用mvn clean install</p>
<p>测试：</p>
<p>新建测试工程：SpringBoot2-HelloService-Test</p>
<p>引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>example-hello-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>controller：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    HelloService helloService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> helloService.hello(<span class="string">&quot;Start&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果放入自定义的HelloService，则原来的不会生效。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> HelloService <span class="title function_">helloService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">HelloService</span> <span class="variable">helloService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HelloService</span>();</span><br><span class="line">        helloService.setIdentify(<span class="string">&quot;identify&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> helloService;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="原理解析"><a href="#原理解析" class="headerlink" title="原理解析"></a>原理解析</h1><h2 id="SpringBoot-启动过程"><a href="#SpringBoot-启动过程" class="headerlink" title="SpringBoot 启动过程"></a>SpringBoot 启动过程</h2><h3 id="创建-SpringApplication"><a href="#创建-SpringApplication" class="headerlink" title="创建 SpringApplication"></a>创建 <strong>SpringApplication</strong></h3><h1 id="安全控制"><a href="#安全控制" class="headerlink" title="安全控制"></a>安全控制</h1><h1 id="缓存控制"><a href="#缓存控制" class="headerlink" title="缓存控制"></a>缓存控制</h1><h1 id="消息中间件"><a href="#消息中间件" class="headerlink" title="消息中间件"></a>消息中间件</h1><h1 id="分布式入门"><a href="#分布式入门" class="headerlink" title="分布式入门"></a>分布式入门</h1><h1 id="响应式编程基础"><a href="#响应式编程基础" class="headerlink" title="响应式编程基础"></a>响应式编程基础</h1><h2 id="响应式编程模型"><a href="#响应式编程模型" class="headerlink" title="响应式编程模型"></a>响应式编程模型</h2><h2 id="使用-Reactor-开发"><a href="#使用-Reactor-开发" class="headerlink" title="使用 Reactor 开发"></a>使用 Reactor 开发</h2><h1 id="WebFlux开发Web应用"><a href="#WebFlux开发Web应用" class="headerlink" title="WebFlux开发Web应用"></a>WebFlux开发Web应用</h1><h2 id="WebFlux构建-Restful-应用"><a href="#WebFlux构建-Restful-应用" class="headerlink" title="WebFlux构建 Restful 应用"></a>WebFlux构建 Restful 应用</h2><h2 id="函数式构建-Restful-应用"><a href="#函数式构建-Restful-应用" class="headerlink" title="函数式构建 Restful 应用"></a>函数式构建 Restful 应用</h2><h2 id="RestTemplate-与-WebClient"><a href="#RestTemplate-与-WebClient" class="headerlink" title="RestTemplate 与 WebClient"></a>RestTemplate 与 WebClient</h2><h1 id="响应式访问持久化层"><a href="#响应式访问持久化层" class="headerlink" title="响应式访问持久化层"></a>响应式访问持久化层</h1><h2 id="响应式访问-MySQL"><a href="#响应式访问-MySQL" class="headerlink" title="响应式访问 MySQL"></a>响应式访问 MySQL</h2><h2 id="响应式访问-Redis"><a href="#响应式访问-Redis" class="headerlink" title="响应式访问 Redis"></a>响应式访问 Redis</h2><h1 id="响应式安全开发"><a href="#响应式安全开发" class="headerlink" title="响应式安全开发"></a>响应式安全开发</h1><h2 id="Spring-Security-Reactive-构建安全服务"><a href="#Spring-Security-Reactive-构建安全服务" class="headerlink" title="Spring Security Reactive 构建安全服务"></a>Spring Security Reactive 构建安全服务</h2><h1 id="响应式原理"><a href="#响应式原理" class="headerlink" title="响应式原理"></a>响应式原理</h1><h2 id="IO-模型"><a href="#IO-模型" class="headerlink" title="IO 模型"></a>IO 模型</h2><h2 id="Netty-Reactor"><a href="#Netty-Reactor" class="headerlink" title="Netty-Reactor"></a>Netty-Reactor</h2><h2 id="数据流处理原理"><a href="#数据流处理原理" class="headerlink" title="数据流处理原理"></a>数据流处理原理</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/13/Linux/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MineTing">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/13/Linux/" class="post-title-link" itemprop="url">Linux</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-13 00:00:00" itemprop="dateCreated datePublished" datetime="2023-03-13T00:00:00+08:00">2023-03-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-22 16:29:20" itemprop="dateModified" datetime="2023-03-22T16:29:20+08:00">2023-03-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <div align="center"><font size="70"><b>通用 Linux</b></font></div>

<blockquote>
<p>【Refer】</p>
</blockquote>
<h1 id="Linux-概述（略）"><a href="#Linux-概述（略）" class="headerlink" title="Linux 概述（略）"></a>Linux 概述（略）</h1><h2 id="VmWare-网络设置"><a href="#VmWare-网络设置" class="headerlink" title="VmWare 网络设置"></a>VmWare 网络设置</h2><h3 id="Vmware三种网络模式"><a href="#Vmware三种网络模式" class="headerlink" title="Vmware三种网络模式"></a>Vmware三种网络模式</h3><p>Vmware 提供了三种虚拟交换机和两张虚拟网卡：</p>
<blockquote>
<ul>
<li><p>VMnet0：用于虚拟桥接网络下的虚拟交换机</p>
</li>
<li><p>VMnet1：用于虚拟 Host-Only 网络下的虚拟交换机</p>
</li>
<li><p>VMnet8：用于虚拟 NAT 网络下的虚拟交换机</p>
</li>
<li><p>VMware Network Adepter VMnet1：Host 用于与 Host-Only 虚拟网络进行通信的虚拟网卡</p>
</li>
<li><p>VMware Network Adepter VMnet8：Host 用于与 NAT 虚拟网络进行通信的虚拟网卡</p>
</li>
</ul>
</blockquote>
<h4 id="桥接网络"><a href="#桥接网络" class="headerlink" title="桥接网络"></a>桥接网络</h4><p>​		桥接网络是指虚拟网卡通过 VMnet0 虚拟交换机和本地物理网卡进行桥接，那么物理网卡和虚拟网卡就相当于处于同一个网段，虚拟交换机就相当于一台现实网络中的交换机。所以要想虚拟机也可以连接到互联网中，那 么两个网卡的IP地址也要设置为同一网段。</p>
<p>特点：</p>
<blockquote>
<ul>
<li><p>默认情况下可以访问互联网</p>
</li>
<li><p>桥接网络的虚拟机IP地址和物理真机在同一个网段</p>
</li>
<li><p>主机 B 及其虚拟机 B1 可以和主机 A1，A2相互通信</p>
</li>
</ul>
</blockquote>
<p><img src="/2023/03/13/Linux/%E6%A1%A5%E6%8E%A5%E7%BD%91%E7%BB%9C.png" alt="桥接网络.png"></p>
<h4 id="NAT网络"><a href="#NAT网络" class="headerlink" title="NAT网络"></a>NAT网络</h4><p>​		在 NAT 网络中，会用到 VMware Network Adepter VMnet8 虚拟网卡，主机上的 VMware Network Adepter VMnet8 虚拟网卡被直接连接到 VMnet8 虚拟交换机上与虚拟网卡进行通信。</p>
<p>VMware Network Adepter VMnet8 虚拟网卡的作用仅限于和 VMnet8 网段进行通信，它不给 VMnet8 网段提供路由功能，所以虚拟机虚拟 一个 NAT 服务器，使虚拟网卡可以连接到 Internet。</p>
<p> VMware Network Adepter VMnet8 虚拟网卡的 IP 地址是在安装 VMware 时由系统指定生成的，尽量不要修改这个数值，否则可能会使主机和虚拟机无法通信。</p>
<p>特点：</p>
<blockquote>
<ul>
<li><p>默认情况下可以访问互联网</p>
</li>
<li><p>NAT 网络的虚拟 IP 地址和物理真机不在同一个网段</p>
</li>
<li><p>为什么NAT网络可以访问互联网？<strong>因为 NAT 路由转换功能（地址转换技术）</strong></p>
</li>
<li><p>主机 B 不能访问主机 A1 和主机 A2</p>
</li>
</ul>
</blockquote>
<p><img src="/2023/03/13/Linux/NAT%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%BC%8F.png" alt="NAT网络模式.png"></p>
<h4 id="仅主机网络"><a href="#仅主机网络" class="headerlink" title="仅主机网络"></a>仅主机网络</h4><p>​		在Host-Only模式下，虚拟网络是一个全封闭的网络，它唯一能够访问的就是物理真机。其实 Host-Only 网络和 NAT网络很相似，不同的地方就是 Host-Only 网络没有NAT服务，所以虚拟网络不能连接到 Internet。主机和虚拟机之间的通信是通过 VMware Network Adepter VMnet1 虚拟网卡来实现的。</p>
<p>特点：</p>
<blockquote>
<ul>
<li><p>默认情况下不可以访问互联网</p>
</li>
<li><p>仅主机模式下虚拟机 IP 地址和物理真机不在同一个网段</p>
</li>
<li><p>主机 A 和主机 A1，A2 可以相互访问，因为有 VMnet1 虚拟网卡</p>
</li>
</ul>
</blockquote>
<p><img src="/2023/03/13/Linux/%E4%BB%85%E4%B8%BB%E6%9C%BA%E6%A8%A1%E5%BC%8F.png" alt="仅主机模式.png"></p>
<h3 id="Vmware-虚拟网络编辑器"><a href="#Vmware-虚拟网络编辑器" class="headerlink" title="Vmware 虚拟网络编辑器"></a>Vmware 虚拟网络编辑器</h3><h4 id="桥接网络-1"><a href="#桥接网络-1" class="headerlink" title="桥接网络"></a>桥接网络</h4><p>注意：</p>
<blockquote>
<p>桥接模式，自动：会自动连接至网线或无线网络</p>
</blockquote>
<p><img src="/2023/03/13/Linux/%E6%A1%A5%E6%8E%A5%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE.png" alt="桥接网络配置.png"></p>
<h4 id="仅主机模式"><a href="#仅主机模式" class="headerlink" title="仅主机模式"></a>仅主机模式</h4><p>注意：</p>
<blockquote>
<p>仅主机模式，选择子网 IP，DHCP表示动态获取网络</p>
</blockquote>
<p><img src="/2023/03/13/Linux/%E4%BB%85%E4%B8%BB%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%BC%8F%E9%85%8D%E7%BD%AE.png" alt="仅主机网络模式配置.png"></p>
<h4 id="NAT模式"><a href="#NAT模式" class="headerlink" title="NAT模式"></a>NAT模式</h4><p><img src="/2023/03/13/Linux/NAT%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%BC%8F%E9%85%8D%E7%BD%AE.png" alt="NAT网络模式配置.png"></p>
<h2 id="静态-IP-地址配置"><a href="#静态-IP-地址配置" class="headerlink" title="静态 IP 地址配置"></a>静态 IP 地址配置</h2><h3 id="方法一：修改网卡配置文件"><a href="#方法一：修改网卡配置文件" class="headerlink" title="方法一：修改网卡配置文件"></a>方法一：修改网卡配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# cd /etc/sysconfig/network-scripts/</span><br><span class="line">[root@localhost network-scripts]# cp ifcfg-ens33 ifcfg-ens33.bak</span><br><span class="line">[root@localhost network-scripts]# vim ifcfg-ens33</span><br></pre></td></tr></table></figure>

<p>增加配置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">TYPE=&quot;Ethernet&quot;</span><br><span class="line">PROXY_METHOD=&quot;none&quot;</span><br><span class="line">BROWSER_ONLY=&quot;no&quot;</span><br><span class="line">DEFROUTE=&quot;yes&quot;</span><br><span class="line">IPV4_FAILURE_FATAL=&quot;no&quot;</span><br><span class="line">IPV6INIT=&quot;yes&quot;</span><br><span class="line">IPV6_AUTOCONF=&quot;yes&quot;</span><br><span class="line">IPV6_DEFROUTE=&quot;yes&quot;</span><br><span class="line">IPV6_FAILURE_FATAL=&quot;no&quot;</span><br><span class="line">IPV6_ADDR_GEN_MODE=&quot;stable-privacy&quot;</span><br><span class="line"></span><br><span class="line">NAME=&quot;ens33&quot;					# 网卡名</span><br><span class="line">UUID=&quot;7525fa8a-a069-47fc-bd45-0d2eb148bef8&quot;		# 网卡UUID，唯一标识</span><br><span class="line">DEVICE=&quot;ens33&quot;					# 网卡设备名</span><br><span class="line">ONBOOT=&quot;yes&quot;					# 激活网卡</span><br><span class="line">BOOTPROTO=&quot;static&quot;				# IP获取方式，none和static表示静态，dhcp动态</span><br><span class="line">IPADDR=192.168.100.100			# IP地址</span><br><span class="line">PREFIX=24						# 子网掩码，等同于NETMASK=255.255.255.0</span><br><span class="line">NETMASK=255.255.255.0</span><br><span class="line">GATEWAY=192.168.100.2			# 网关, 默认 .2，Vmnet网卡默认 .1，其他的可作为IP</span><br><span class="line">DNS1=8.8.8.8					# dns服务器</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="重启网络服务"><a href="#重启网络服务" class="headerlink" title="重启网络服务"></a>重启网络服务</h3><blockquote>
<p>Redhat6：service network restart</p>
<p>Redhat7：systemctl restart network.service</p>
<p>Redhat8：nmcli connection reload ens160</p>
<p>​					nmcli connection up ens160</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost network-scripts]# systemctl restart network.service</span><br><span class="line">[root@localhost network-scripts]# ifconfig</span><br><span class="line">ens33: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.100.100  netmask 255.255.255.0  broadcast 192.168.100.255</span><br><span class="line">        inet6 fe80::5416:4001:661d:1ada  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:0c:29:ad:84:bb  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 457746  bytes 654018153 (623.7 MiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 105694  bytes 6433985 (6.1 MiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="Linux-常用命令"><a href="#Linux-常用命令" class="headerlink" title="Linux 常用命令"></a>Linux 常用命令</h1><h2 id="帮助类"><a href="#帮助类" class="headerlink" title="帮助类"></a>帮助类</h2><h3 id="清屏"><a href="#清屏" class="headerlink" title="清屏"></a>清屏</h3><blockquote>
<p>clear	CTRL+L		reset（彻底清屏）</p>
<p>清空文件内容：echo “” &gt; sources.list</p>
</blockquote>
<h3 id="man"><a href="#man" class="headerlink" title="man"></a>man</h3><p>​		帮助命令：man [命令]</p>
<h3 id="help"><a href="#help" class="headerlink" title="help"></a>help</h3><p>​		帮助命令：help [命令]</p>
<h2 id="文件目录类"><a href="#文件目录类" class="headerlink" title="文件目录类"></a>文件目录类</h2><h3 id="pwd：显示当前目录"><a href="#pwd：显示当前目录" class="headerlink" title="pwd：显示当前目录"></a>pwd：显示当前目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@root ~]# pwd</span><br><span class="line">/root</span><br></pre></td></tr></table></figure>

<h3 id="ls：列出目录内容"><a href="#ls：列出目录内容" class="headerlink" title="ls：列出目录内容"></a>ls：列出目录内容</h3><blockquote>
<p>基本语法：ls 	[选项] 	[目录或是文件]</p>
<p><strong>常用选项：</strong></p>
<p>-a ：显示当前目录所有的文件和目录，包括隐藏的文件</p>
<p>-l ：以列表的方式显示信息。（等价于 ll ）</p>
<p>-h：human人性化，可以查看文件大小。</p>
<p>-R：显示所有文件。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@root ~]# ls -lah</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">文件类型与权限 	链接数 	文件属主 文件属组 文件大小 建立或最近修改的时间 		名字</span></span><br><span class="line">dr-xr-x---. 		16 		root 	root   4.0K 	4月  24 22:17		 .</span><br><span class="line">dr-xr-xr-x. 		17 		root 	root    224 	4月   9 18:25		 ..</span><br><span class="line">-rw-------. 		 1 		root 	root   1.8K 	4月   9 18:26		 anaconda-ks.cfg</span><br><span class="line">drwxr-xr-x. 		 3 		root 	root     53 	4月  24 17:57		 archive</span><br><span class="line">-rw-------. 		 1 		root 	root    11K 	4月  24 22:17		 .bash_history</span><br><span class="line">-rw-r--r--. 		 1 		root 	root     18 	12月 29 2013 		.bash_logout</span><br><span class="line">-rw-r--r--. 		 1 		root 	root    176 	12月 29 2013 		.bash_profile</span><br><span class="line">-rw-r--r--. 		 1 		root 	root    176 	12月 29 2013 		.bashrc</span><br><span class="line">drwx------. 		15 		root 	root   4.0K 	4月   9 18:51		 .cache</span><br><span class="line">drwxr-xr-x. 		14 		root 	root    261 	4月   9 18:44		 .config</span><br></pre></td></tr></table></figure>

<h3 id="cd：切换目录"><a href="#cd：切换目录" class="headerlink" title="cd：切换目录"></a>cd：切换目录</h3><blockquote>
<p>cd：Change Directory 切换路径</p>
<p>cd ~ 或 cd 切换到当前用户家目录</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# pwd</span><br><span class="line">/opt/shell</span><br><span class="line">[root@root shell]# cd</span><br><span class="line">[root@root ~]# cd /opt/shell</span><br><span class="line">[root@root shell]# cd ~</span><br></pre></td></tr></table></figure>

<h3 id="mkdir：创建目录"><a href="#mkdir：创建目录" class="headerlink" title="mkdir：创建目录"></a>mkdir：创建目录</h3><blockquote>
<p>基本语法：mkdir [选项] 要创建的目录</p>
<p>参数：-p  创建多级目录</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@root opt]# mkdir ./linux/dir</span><br><span class="line">mkdir: 无法创建目录&quot;./linux/dir&quot;: 没有那个文件或目录</span><br><span class="line">[root@root opt]# mkdir ./linux/dir -p</span><br><span class="line">[root@root opt]# ls</span><br><span class="line">linux  rh</span><br></pre></td></tr></table></figure>

<h3 id="rmdir：删除空目录"><a href="#rmdir：删除空目录" class="headerlink" title="rmdir：删除空目录"></a>rmdir：删除空目录</h3><p>注意：<strong>如果需要删除非空目录，需要使用 rm -rf 要删除的目录。</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@root opt]# rmdir ./linux</span><br><span class="line">rmdir: 删除 &quot;./linux&quot; 失败: 目录非空</span><br><span class="line">[root@root opt]# rm -rf ./linux</span><br><span class="line">[root@root opt]# ls</span><br><span class="line">rh</span><br></pre></td></tr></table></figure>

<h3 id="touch：创建一个或多个空文件"><a href="#touch：创建一个或多个空文件" class="headerlink" title="touch：创建一个或多个空文件"></a>touch：创建一个或多个空文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@root dir]# touch test test2 &amp;&amp; ls</span><br><span class="line">test test2</span><br></pre></td></tr></table></figure>

<h3 id="cp-：拷贝文件或文件夹"><a href="#cp-：拷贝文件或文件夹" class="headerlink" title="cp ：拷贝文件或文件夹"></a>cp ：拷贝文件或文件夹</h3><blockquote>
<p>基本语法： cp [选项] source destation</p>
<p>常用选项：</p>
<p>​		-r ：递归复制整个文件夹，<strong>单独拷贝文件或压缩包不需要加 -r ，对于文件夹需要添加 -r</strong></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1. 将一个文件夹复制到另一个文件夹下</span></span><br><span class="line">cp -r srcDir/ destDir/</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2. 将一个文件夹下的所有内容复制到另一个文件夹下</span></span><br><span class="line">cp -r srcDir/* destDir/</span><br><span class="line">cp -r srcDir/. destDir/</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注意拷贝多级目录时需要加递归参数 -r，否则不生效，提示：<span class="built_in">cp</span>: 略过目录<span class="string">&quot;apache-tomcat-8.5.70&quot;</span></span></span><br></pre></td></tr></table></figure>

<p>注意：如果目的目录下有相同的文件则会提示是否进行覆盖，<strong>强制覆盖不提示的方法：\cp（在前面加\）</strong></p>
<h3 id="rm-：移除文件或目录"><a href="#rm-：移除文件或目录" class="headerlink" title="rm ：移除文件或目录"></a>rm ：移除文件或目录</h3><blockquote>
<p>基本语法：rm [选项] 要删除的文件或目录。</p>
<p>常用选项</p>
<p><strong>-r ：递归删除整个文件夹。</strong></p>
<p><strong>-f ：强制删除不提示。</strong></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@root dir]# rm -rf test</span><br></pre></td></tr></table></figure>

<h3 id="mv-：移动文件与目录或重命名"><a href="#mv-：移动文件与目录或重命名" class="headerlink" title="mv ：移动文件与目录或重命名"></a><strong>mv ：移动文件与目录或重命名</strong></h3><blockquote>
<p><strong>基本语法：</strong></p>
<p>重命名：mv  oldNameFile  newNameFile</p>
<p>移动文件：mv  &#x2F;temp&#x2F;movefile  &#x2F;targetFolder</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@root dir]# touch config.txt</span><br><span class="line">[root@root dir]# mv config.txt config.txt.bak</span><br><span class="line">[root@root dir]# ls</span><br><span class="line">config.txt.bak</span><br><span class="line">[root@root dir]# mv config.txt.bak /opt/linux/ &amp;&amp; ls /opt/linux/</span><br><span class="line">config.txt.bak  dir</span><br></pre></td></tr></table></figure>

<h3 id="cat-：查看文件内容"><a href="#cat-：查看文件内容" class="headerlink" title="cat ：查看文件内容"></a>cat ：查看文件内容</h3><blockquote>
<p>基本语法： cat [选项] 要查看的文件。</p>
<p>注意：会显示全部文件内容，一般会带上管道命令 | more。管道符 <strong>|</strong> 作为连接使用。</p>
<p>常用选项</p>
<p>​	<strong>-n ：显示行号</strong></p>
</blockquote>
<p>示例： &#x2F;etc&#x2F;profile 文件内容，并显示行号。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@root ~]# cat -n /etc/profile</span><br><span class="line">1  # /etc/profile</span><br><span class="line">2</span><br><span class="line">3  # System wide environment and startup programs, for login setup</span><br><span class="line">4  # Functions and aliases go in /etc/bashrc</span><br><span class="line">5</span><br><span class="line">6  # It&#x27;s NOT a good idea to change this file unless you know what you</span><br><span class="line">7  # are doing. It&#x27;s much better to create a custom.sh shell script in</span><br><span class="line">8  # /etc/profile.d/ to make custom changes to your environment, as this</span><br><span class="line">9  # will prevent the need for merging in future updates.</span><br><span class="line">10</span><br><span class="line">11  pathmunge () &#123;</span><br><span class="line">12      case &quot;:$&#123;PATH&#125;:&quot; in</span><br><span class="line">13          *:&quot;$1&quot;:*)</span><br><span class="line">14              ;;</span><br><span class="line">15          *)</span><br><span class="line">16              if [ &quot;$2&quot; = &quot;after&quot; ] ; then</span><br><span class="line">17                  PATH=$PATH:$1</span><br><span class="line">18              else</span><br><span class="line">19                  PATH=$1:$PATH</span><br><span class="line">20              fi</span><br><span class="line">21      esac</span><br><span class="line">22  &#125;</span><br><span class="line">23</span><br></pre></td></tr></table></figure>

<h3 id="more：一次性加载"><a href="#more：一次性加载" class="headerlink" title="more：一次性加载"></a>more：一次性加载</h3><blockquote>
<p>​		more 指令是一个基于 VI 编辑器的文本过滤器，它以全屏幕的方式按页显示文本文件的内容（一次性加载全部文件内容）。more指令中内置了若干快捷键，详见操作说明。</p>
<p>基本语法：more 要查看的文件</p>
</blockquote>
<p>操作说明：</p>
<table>
<thead>
<tr>
<th><strong>操作</strong></th>
<th><strong>功能说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>空白键（space）</strong></td>
<td>代表向下翻一页</td>
</tr>
<tr>
<td><strong>Enter</strong></td>
<td>代表向下翻一行</td>
</tr>
<tr>
<td><strong>q</strong></td>
<td>立即离开，不再显示文件内容</td>
</tr>
<tr>
<td><strong>Ctrl+F</strong></td>
<td>向下滚动一屏</td>
</tr>
<tr>
<td><strong>Ctrl+B</strong></td>
<td>返回上一屏</td>
</tr>
<tr>
<td><strong>&#x3D;</strong></td>
<td>输出当前行号</td>
</tr>
<tr>
<td><strong>:f</strong></td>
<td>输出文件名和当前行号</td>
</tr>
</tbody></table>
<h3 id="less：按需加载，日志推荐"><a href="#less：按需加载，日志推荐" class="headerlink" title="less：按需加载，日志推荐"></a><strong>less：按需加载，日志推荐</strong></h3><p>​		less 指令用来分屏查看文件内容，它的功能与 more 指令类似，但是<strong>比 more 指令更加强大，支持各种显示终端。</strong>less 指令在显示文件内容时，并不是一次将整个文件加载之后才显示，而是根据显示需要加载内容，对于显示大型文件具有较高的效率。<strong>（日志推荐使用less）</strong></p>
<p>操作说明：</p>
<table>
<thead>
<tr>
<th><strong>操作</strong></th>
<th><strong>功能说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>空格</strong></td>
<td>向下翻动一页</td>
</tr>
<tr>
<td><strong>【pagedown】</strong></td>
<td>向下翻动一页</td>
</tr>
<tr>
<td><strong>【pageup】</strong></td>
<td>向上翻动一页</td>
</tr>
<tr>
<td><strong>&#x2F;字符串</strong></td>
<td>向下搜寻【字符串】，n：向下查找，N：向上查找</td>
</tr>
<tr>
<td><strong>?字符串</strong></td>
<td>向上搜寻【字符串】，n：向上查找，N：向下查找</td>
</tr>
<tr>
<td><strong>q</strong></td>
<td>离开less</td>
</tr>
</tbody></table>
<h3 id="gt-输出重定向和-gt-gt-追加"><a href="#gt-输出重定向和-gt-gt-追加" class="headerlink" title="&gt; 输出重定向和 &gt;&gt; 追加"></a>&gt; 输出重定向和 &gt;&gt; 追加</h3><blockquote>
<p>示例：</p>
<p>​		ls -l &gt; 文件 （功能描述：列表的内容写入文件 appendTest.txt 中（覆盖写））</p>
<p>​		cat 文件1 &gt; 文件2 （功能描述：将文件1的内容覆盖到文件2）</p>
<p>​		echo “内容”&gt;&gt; 文件</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;Hello Wolrd&quot; &gt;&gt; a.txt</span><br><span class="line">cat /etc/profile &gt;&gt; global.cof</span><br><span class="line">echo &quot;&quot; &gt; a.txt</span><br></pre></td></tr></table></figure>

<h3 id="head：默认显示前-10-行"><a href="#head：默认显示前-10-行" class="headerlink" title="head：默认显示前 10 行"></a>head：默认显示前 10 行</h3><blockquote>
<p>​		head 用于显示文件的开头部分内容，默认情况下 head 指令显示文件的前 10 行内容。</p>
<p>基本语法：</p>
<p>​		head 文件 (功能描述：默认查看文件头10 行内容) </p>
<p>​		head -n 5 文件 (功能描述：查看文件头 5 行内容，5 可以是任意行数)</p>
</blockquote>
<h3 id="tail：默认显示后10行"><a href="#tail：默认显示后10行" class="headerlink" title="tail：默认显示后10行"></a>tail：默认显示后10行</h3><p>​		tail用于输出文件中尾部的内容，默认情况下 tail 指令显示文件的后 10 行内容。 </p>
<blockquote>
<p>基本语法</p>
<ol>
<li>tail 文件 （功能描述：查看文件后10行内容）</li>
<li>tail -n 5 文件 （功能描述：查看文件后5行内容，5可以是任意行数）</li>
<li><strong>tail -f 文件 （功能描述：实时追踪该文档的所有更新）CTRL + C退出</strong></li>
</ol>
</blockquote>
<h3 id="wc：统计字数"><a href="#wc：统计字数" class="headerlink" title="wc：统计字数"></a>wc：统计字数</h3><blockquote>
<p>​		利用 wc 指令我们可以计算文件的 Byte 数、字数、或是行数，若不指定文件名称、或是所给予的文件名为”-“，则wc指令会从标准输入设备读取数据。</p>
<p>语法：<strong>wc [-clw ][–help][–version][文件…]</strong></p>
<p><strong>可以统计多个文件。</strong></p>
<p><strong>参数说明：</strong></p>
<ol>
<li><strong>-c 或 –bytes 或 –chars 只显示Bytes数。</strong></li>
<li><strong>-l 或 –lines 显示行数。</strong></li>
<li><strong>-w 或 –words 只显示字数。</strong></li>
<li>–help 在线帮助。</li>
<li>–version 显示版本信息。</li>
</ol>
</blockquote>
<p><strong>示例：统计文件字数</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@root testCommand]# vim testWC.txt</span><br><span class="line">[root@root testCommand]# wc testWC.txt</span><br><span class="line">  5  12 110 testWC.txt</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">5 行 12 字数 110 字节数</span></span><br></pre></td></tr></table></figure>

<h3 id="ln-：软链接"><a href="#ln-：软链接" class="headerlink" title="ln ：软链接"></a>ln ：软链接</h3><p>基本语法</p>
<p>​		ln -s [原文件或目录] [软链接名] （功能描述：给原文件创建一个软链接）</p>
<p>示例： 在 &#x2F;home 目录下创建一个软连接 linkToRoot，连接到 &#x2F;root 目录，删除软连接 linkToRoot</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@root home]# ln -s /root homeToRoot</span><br><span class="line">[root@root home]# ll</span><br><span class="line">总用量 0</span><br><span class="line">lrwxrwxrwx. 1 root   root    5 4月  24 23:10 homeToRoot -&gt; /root</span><br><span class="line">drwx------. 3 liufei liufei 78 4月   9 18:14 liufei</span><br><span class="line">[root@root home]# cd homeToRoot/</span><br><span class="line">[root@root homeToRoot]# ls</span><br><span class="line">anaconda-ks.cfg  archive  initial-setup-ks.cfg  shell  testCommand  公共  模板  视频  图片  文档  下载  音乐  桌面</span><br><span class="line">[root@root homeToRoot]# pwd</span><br><span class="line">/home/homeToRoot</span><br></pre></td></tr></table></figure>

<p><strong>注意事项：当我们使用 pwd 指令查看目录时，仍然看到的是软链接所在目录。cd  -P：如果目录是链接时，切换到实际路径的目录。</strong></p>
<h3 id="history：显示历史指令"><a href="#history：显示历史指令" class="headerlink" title="history：显示历史指令"></a>history：显示历史指令</h3><p>​		查看已经执行过历史命令，也可以执行历史指令。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">显示所有的历史命令</span></span><br><span class="line">history</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">显示最近使用过的10个指令</span></span><br><span class="line">history 10</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">执行历史编号为10的指令</span></span><br><span class="line">! 10</span><br></pre></td></tr></table></figure>

<h2 id="时间日期类"><a href="#时间日期类" class="headerlink" title="时间日期类"></a>时间日期类</h2><h3 id="date：显示日期"><a href="#date：显示日期" class="headerlink" title="date：显示日期"></a>date：显示日期</h3><blockquote>
<p>基本语法</p>
<ol>
<li><p>date （功能描述：显示当前时间）</p>
</li>
<li><p>date +%Y （功能描述：显示当前年份）</p>
</li>
<li><p>date +%m （功能描述：显示当前月份）</p>
</li>
<li><p>date +%d （功能描述：显示当前是哪一天）</p>
</li>
<li><p>date “+%Y-%m-%d %H：%M：%S”（功能描述：显示年月日时分秒）</p>
</li>
</ol>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@root homeToRoot]# date +%Y</span><br><span class="line">2022</span><br><span class="line">[root@root homeToRoot]# date +%y</span><br><span class="line">22</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注意M表示分钟，m表示月份（从1开始）</span></span><br><span class="line">[root@root homeToRoot]# date +%M</span><br><span class="line">17</span><br><span class="line">[root@root homeToRoot]# date +%m</span><br><span class="line">04</span><br><span class="line">[root@root homeToRoot]# date &quot;+%Y年-%m月-%d日 %H:%M:%S&quot;</span><br><span class="line">2022年-04月-24日 23:19:31</span><br><span class="line">[root@root homeToRoot]#</span><br></pre></td></tr></table></figure>

<h3 id="cal：查看日历"><a href="#cal：查看日历" class="headerlink" title="cal：查看日历"></a>cal：查看日历</h3><p>示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@root homeToRoot]# cal</span><br><span class="line">      四月 2022</span><br><span class="line">日 一 二 三 四 五 六</span><br><span class="line">                1  2</span><br><span class="line"> 3  4  5  6  7  8  9</span><br><span class="line">10 11 12 13 14 15 16</span><br><span class="line">17 18 19 20 21 22 23</span><br><span class="line">24 25 26 27 28 29 30</span><br><span class="line"></span><br><span class="line">[root@root homeToRoot]# cal 2022</span><br><span class="line">                               2022</span><br><span class="line"></span><br><span class="line">        一月                   二月                   三月</span><br><span class="line">日 一 二 三 四 五 六   日 一 二 三 四 五 六   日 一 二 三 四 五 六</span><br><span class="line">                   1          1  2  3  4  5          1  2  3  4  5</span><br><span class="line"> 2  3  4  5  6  7  8    6  7  8  9 10 11 12    6  7  8  9 10 11 12</span><br><span class="line"> 9 10 11 12 13 14 15   13 14 15 16 17 18 19   13 14 15 16 17 18 19</span><br><span class="line">16 17 18 19 20 21 22   20 21 22 23 24 25 26   20 21 22 23 24 25 26</span><br><span class="line">23 24 25 26 27 28 29   27 28                  27 28 29 30 31</span><br><span class="line">30 31</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h2 id="搜索查找类"><a href="#搜索查找类" class="headerlink" title="搜索查找类"></a>搜索查找类</h2><h3 id="which：查看可执行文件的位置"><a href="#which：查看可执行文件的位置" class="headerlink" title="which：查看可执行文件的位置"></a>which：查看可执行文件的位置</h3><blockquote>
<p>​		查看可执行文件的位置。在 PATH 变量指定的路径中，搜索某个系统命令的位置，并且返回第一个搜索结果。也就是说，使用 which 命令，就可以看到某个系统命令是否存在，以及执行的到底是哪一个位置的命令。</p>
<p>命令功能：which 指令会在 PATH 变量指定的路径中，搜索某个系统命令的位置，并且返回第一个搜索结果。</p>
<p>命令参数：</p>
<ul>
<li>-n 　指定文件名长度，指定的长度必须大于或等于所有文件中最长的文件名。</li>
<li>-p 　与-n参数相同，但此处的包括了文件的路径。</li>
<li>-w 　指定输出时栏位的宽度。</li>
<li>-V 　显示版本信息</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@root homeToRoot]# which firefox</span><br><span class="line">/usr/bin/firefox</span><br></pre></td></tr></table></figure>

<h3 id="find：查找文件目录"><a href="#find：查找文件目录" class="headerlink" title="find：查找文件目录"></a>find：查找文件目录</h3><p>​		find 指令将从指定目录向下递归地遍历其各个子目录，将满足条件的文件或者目录显示在终端。</p>
<p>基本语法：<strong>find [搜索范围] [选项]</strong></p>
<p>选项说明</p>
<table>
<thead>
<tr>
<th><strong>选项</strong></th>
<th><strong>功能</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>-name&lt;查询方式&gt;</strong></td>
<td>按照指定的文件名查找模式查找文件</td>
</tr>
<tr>
<td><strong>-user&lt;用户名&gt;</strong></td>
<td>查找属于指定用户名的所有文件</td>
</tr>
<tr>
<td><strong>-size&lt;文件大小&gt;</strong></td>
<td>按照指定的文件大小查找文件</td>
</tr>
</tbody></table>
<p>示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">根据名称查找/home 目录下的hello.txt文件</span></span><br><span class="line">find /home -name hello.txt</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用通配符时需要添加引号</span></span><br><span class="line">find /home -name &quot;hello*&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查找/opt目录下，用户名称为 nobody的文件。</span></span><br><span class="line">find /opt -user nobody</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查找整个Linux系统下大于200M的文件（+n 大于 -n小于 n等于）</span></span><br><span class="line">find / -size +20M</span><br></pre></td></tr></table></figure>

<h3 id="locate：快速定位文件路径"><a href="#locate：快速定位文件路径" class="headerlink" title="locate：快速定位文件路径"></a>locate：快速定位文件路径</h3><p>​		locate 指令可以快速定位文件路径。locate 指令利用事先建立的系统中所有文件名称及路径的 locate 数据库实现快速定位给定的文件。locate 指令无需遍历整个文件系统，查询速度较快。为了保证查询结果的准确度，管理员必须定期更新locate。</p>
<p>特别说明：由于 locate 指令基于数据库进行查询，所以第一次运行前，必须使用 updatedb 指令创建 locate 数据库。</p>
<p>示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">请使用locate 指令快速定位 hello文件所在目录</span></span><br><span class="line">updatedb</span><br><span class="line">locate hello</span><br></pre></td></tr></table></figure>

<h3 id="grep-指令和管道符号"><a href="#grep-指令和管道符号" class="headerlink" title="grep 指令和管道符号  |"></a>grep 指令和管道符号  |</h3><blockquote>
<p>​		grep 过滤查找，<strong>管道符，“|”，表示将前一个命令的处理结果输出传递给后面的命令处理。</strong></p>
<p>基本语法：<strong>grep [选项] 查找内容 源文件</strong></p>
<p>常用选项</p>
<table>
<thead>
<tr>
<th><strong>选项</strong></th>
<th><strong>功能</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>-n</strong></td>
<td>显示匹配行及行号</td>
</tr>
<tr>
<td><strong>-i</strong></td>
<td>忽略字母大小写</td>
</tr>
</tbody></table>
</blockquote>
<p>示例：查找 &#x2F;etc&#x2F;profile下的 HOSTNAME 所在行。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@root homeToRoot]# cat /etc/profile | grep -ni HostName</span><br><span class="line">45:HOSTNAME=`/usr/bin/hostname 2&gt;/dev/null`</span><br><span class="line">53:export PATH USER LOGNAME MAIL HOSTNAME HISTSIZE HISTCONTROL</span><br></pre></td></tr></table></figure>

<h2 id="文件压缩类"><a href="#文件压缩类" class="headerlink" title="文件压缩类"></a>文件压缩类</h2><h3 id="gzip-x2F-gunzip"><a href="#gzip-x2F-gunzip" class="headerlink" title="gzip&#x2F;gunzip"></a>gzip&#x2F;gunzip</h3><blockquote>
<p>​		gzip 用于压缩<strong>文件</strong>（<strong>不会保留原文件</strong>），gunzip 用于解压的。</p>
<p>基本语法：</p>
<p>gzip 文件 （功能描述：压缩文件，只能将文件压缩为 *.gz 文件）</p>
<p>gunzip 文件 .gz （功能描述：解压缩文件命令）</p>
<p><strong>说明：不会保留原文件。</strong></p>
<p><strong>参数 –r：对文件分别压缩</strong></p>
<p>示例： gzip 压缩，将 &#x2F;home 下的 hello.txt 文件先进行压缩再解压。</p>
</blockquote>
<h3 id="zip-x2F-unzip"><a href="#zip-x2F-unzip" class="headerlink" title="zip&#x2F;unzip"></a>zip&#x2F;unzip</h3><blockquote>
<p>zip 用于压缩文件，unzip 用于解压的，这个在项目打包发布中很有用的。</p>
<p>基本语法</p>
<ul>
<li><p>zip  [选项]  XXX.zip 将要压缩的内容（功能描述：压缩文件和目录的命令）</p>
</li>
<li><p>unzip  [选项]  XXX.zip （功能描述：解压缩文件）</p>
</li>
</ul>
<p>zip常用选项</p>
<ul>
<li>-r：递归压缩，即压缩目录</li>
</ul>
<p>unzip的常用选项</p>
<ul>
<li>-d ：指定解压后文件的存放目录</li>
</ul>
<p>示例1： 将 &#x2F;home下的所有文件进行压缩成 mypackage.zip，对于单独的文件可以显示压缩率。</p>
</blockquote>
<h3 id="tar：打包压缩"><a href="#tar：打包压缩" class="headerlink" title="tar：打包压缩"></a>tar：打包压缩</h3><blockquote>
<p><strong>tar</strong> 指令是打包指令，最后打包后的文件是 <strong>.tar.gz</strong> 的文件。</p>
<p>打包和压缩：打包是指将一大堆文件或目录什么的变成一个总的文件，压缩则是将一个大的文件通过一些压缩算法变成一个小文件。</p>
<p>基本语法：<strong>tar [选项]  XXX.tar.gz 打包的内容</strong> </p>
<p>功能描述：打包目录，压缩后的文件格式 <strong>.tar.gz。</strong></p>
<p>选项说明：</p>
<table>
<thead>
<tr>
<th><strong>选项</strong></th>
<th><strong>功能</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>-c</strong></td>
<td>产生 <strong>.tar</strong> 打包文件</td>
</tr>
<tr>
<td>-z</td>
<td><strong>打包同时压缩</strong></td>
</tr>
<tr>
<td><strong>-x</strong></td>
<td>解压  .tar 文件</td>
</tr>
<tr>
<td><strong>-f</strong></td>
<td>指定压缩后的文件名</td>
</tr>
<tr>
<td><strong>-v</strong></td>
<td>显示详细信息</td>
</tr>
</tbody></table>
</blockquote>
<p>示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">打包</span></span><br><span class="line">tar -zcvf testTar.tar.gz a.txt b.txt</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解压,-C 指定解压目录</span></span><br><span class="line">tar -zxvf testTar.tar.gz -C /root/testTar</span><br></pre></td></tr></table></figure>

<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="wget：下载资源"><a href="#wget：下载资源" class="headerlink" title="wget：下载资源"></a>wget：下载资源</h3><p>示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://nginx.org/download/nginx-1.6.2.tar.gz</span><br></pre></td></tr></table></figure>



<h3 id="设置主机名"><a href="#设置主机名" class="headerlink" title="设置主机名"></a>设置主机名</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname xxx</span><br><span class="line">cat /etc/hostname</span><br></pre></td></tr></table></figure>

<h1 id="磁盘管理"><a href="#磁盘管理" class="headerlink" title="磁盘管理"></a>磁盘管理</h1><h1 id="网络管理"><a href="#网络管理" class="headerlink" title="网络管理"></a>网络管理</h1><h1 id="进程管理"><a href="#进程管理" class="headerlink" title="进程管理"></a>进程管理</h1><h1 id="用户管理"><a href="#用户管理" class="headerlink" title="用户管理"></a>用户管理</h1><h1 id="权限管理"><a href="#权限管理" class="headerlink" title="权限管理"></a>权限管理</h1><h1 id="软件安装"><a href="#软件安装" class="headerlink" title="软件安装"></a>软件安装</h1><h1 id="Shell-编程"><a href="#Shell-编程" class="headerlink" title="Shell 编程"></a>Shell 编程</h1><h2 id="Shell-概述"><a href="#Shell-概述" class="headerlink" title="Shell 概述"></a>Shell 概述</h2><p>​		Shell 是一个命令行解释器，为用户提供了一个向 Linux 发送请求以便运行程序的界面系统级程序，用户可以用 Shell 来启动、挂起、停止甚至是编写一些程序接收用户指令，然后调用系统内核，Shell有很多版本。</p>
<p>Linux 提供的解析器：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# cat /etc/shells</span><br><span class="line">/bin/sh</span><br><span class="line">/bin/bash</span><br><span class="line">/usr/bin/sh</span><br><span class="line">/usr/bin/bash</span><br><span class="line">/bin/tcsh</span><br><span class="line">/bin/csh</span><br></pre></td></tr></table></figure>

<p>bash 和 sh 的关系：sh 作为 bash 的一个软链接</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# ll /bin/ |grep bash</span><br><span class="line">-rwxr-xr-x. 1 root root      964536 4月   1 2020 bash</span><br><span class="line">lrwxrwxrwx. 1 root root          10 4月   9 18:14 bashbug -&gt; bashbug-64</span><br><span class="line">-rwxr-xr-x. 1 root root        6964 4月   1 2020 bashbug-64</span><br><span class="line">lrwxrwxrwx. 1 root root           4 4月   9 18:14 sh -&gt; bash</span><br></pre></td></tr></table></figure>

<p>Centos 默认的解析器是 bash：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# echo $SHELL</span><br><span class="line">/bin/bash</span><br></pre></td></tr></table></figure>

<h2 id="Shell-脚本入门"><a href="#Shell-脚本入门" class="headerlink" title="Shell 脚本入门"></a>Shell 脚本入门</h2><p>脚本格式的要求：</p>
<p>​		**#!&#x2F;bin&#x2F;sh **是指此脚本使用 &#x2F;bin&#x2F;sh 来解释执行，#! 是特殊的表示符，其后面跟的是解释此脚本的 shell 的路径。</p>
<p>示例：编写 Shell 脚本 helloworld.sh 输出 Hello World</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir /opt/shell</span><br><span class="line">cd /opt/shell</span><br><span class="line">vim helloworld.sh</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">echo &#x27;Hello World&#x27;</span><br></pre></td></tr></table></figure>

<p>Shell脚本的执行方式：</p>
<p>方式一：使用命令 sh&#x2F;bash helloworld.sh 执行，文件路径可以使用绝对路径和相对路径。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost shell]# bash helloworld.sh</span><br><span class="line">Hello World</span><br><span class="line">[root@localhost shell]# sh helloworld.sh</span><br><span class="line">Hello World</span><br><span class="line">[root@localhost shell]# bash /opt/shell/helloworld.sh</span><br><span class="line">Hello World</span><br><span class="line">[root@localhost shell]# sh /opt/shell/helloworld.sh</span><br><span class="line">Hello World</span><br><span class="line">[root@localhost shell]#</span><br></pre></td></tr></table></figure>

<p>方式二：赋予文件可执行权限，直接使用相对路径和绝对路径执行文件。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost shell]# helloworld.sh</span><br><span class="line">bash: helloworld.sh: 未找到命令...</span><br><span class="line">[root@localhost shell]# chmod +x helloworld.sh</span><br><span class="line">[root@localhost shell]# ./helloworld.sh</span><br><span class="line">Hello World</span><br><span class="line">[root@localhost shell]# /opt/shell/helloworld.sh</span><br><span class="line">Hello World</span><br></pre></td></tr></table></figure>

<p>方式三：在脚本的路径前面加上点  .  或者 source</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost shell]# chmod -x helloworld.sh</span><br><span class="line">[root@localhost shell]# . helloworld.sh</span><br><span class="line">Hello World</span><br><span class="line">[root@localhost shell]# source helloworld.sh</span><br><span class="line">Hello World</span><br><span class="line">[root@localhost shell]#</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意：</strong></p>
<p>如果在 shell 脚本目录执行 helloworld.sh，则 shell 会将 helloworld.sh 当作一个命令，报错：未找到命令</p>
<p>关于 “.” 和 source 的区别：</p>
<ol>
<li>source 命令是 shell 内嵌的一种命令，由 cshell&#x2F;csh 演变而来。</li>
<li>“.”  命令由 bash 命令演变而来。</li>
</ol>
<p>注意方式三和前两种方式的区别：</p>
<ol>
<li>前两种方式都是在当前 shell 中打开一个子 shell 来执行脚本内容，当脚本内容结束，则子 shell 关闭，回到父 shell 中。 </li>
<li>第三种方式，在脚本路径前加  “.”  或者 source 的方式，可以使脚本内容在当前 shell 里执行，而无需打开子 shell。相当于读取文件的每一行命令，然后再当前 shell 中执行。如修改 &#x2F;etc&#x2F;profile 文件以后，需要 source 一下的原因。 </li>
<li>打开子 shell 与不打开子 shell 的区别就在于，环境变量的继承关系，如在子 shell 中设置的当前变量，父 shell 是不可见的。</li>
</ol>
</blockquote>
<p>查看子bash进程：（-bash表示父bash）</p>
<p>使用 bash 命令开启一个新的进程。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# bash</span><br><span class="line">[root@root shell]# ps -f</span><br><span class="line">UID         PID   PPID  C STIME TTY          TIME CMD</span><br><span class="line">root       9873   9865  0 08:34 pts/4    00:00:00 -bash</span><br><span class="line">root      10766   9873  1 09:51 pts/4    00:00:00 bash</span><br><span class="line">root      10799  10766  0 09:52 pts/4    00:00:00 ps -f</span><br><span class="line">[root@root shell]# exit</span><br></pre></td></tr></table></figure>

<p>ps -ef |grep bash 相当于在子 shell 中执行 ps 命令，使用 exit 退出子shell。</p>
<p>bash 作为一个进程存在，开启 bash 就需要关闭 exit。</p>
<p>注意单引号与双引号的区别：</p>
<p>单引号：单引号中的内容不会转义或取值</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# echo &#x27;----$USER----&#x27;</span><br><span class="line"><span class="meta prompt_">----$</span><span class="language-bash">USER----</span></span><br><span class="line">[root@root shell]# echo &quot;----$USER----&quot;</span><br><span class="line">----root---</span><br></pre></td></tr></table></figure>

<h2 id="Shell-变量"><a href="#Shell-变量" class="headerlink" title="Shell 变量"></a>Shell 变量</h2><p>Shell变量分为系统变量和用户自定义变量，也可以分为全局变量和局部变量。</p>
<p>对于全局变量和局部变量：如在 bash 进程中再开启 bash，全局变量对于子 bash 是可见的。</p>
<h3 id="系统变量"><a href="#系统变量" class="headerlink" title="系统变量"></a>系统变量</h3><p>如 $HOME、$PWD、$SHELL、$USER。</p>
<p>查看变量的方式：</p>
<ul>
<li><p>env</p>
</li>
<li><p>printenv</p>
</li>
<li><p>echo $HOME</p>
</li>
<li><p>printenv HOME</p>
</li>
<li><p>set</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# env |less</span><br><span class="line">[root@root shell]# env</span><br><span class="line">XDG_SESSION_ID=84</span><br><span class="line">HOSTNAME=root</span><br><span class="line">SELINUX_ROLE_REQUESTED=</span><br><span class="line">TERM=xterm</span><br><span class="line">SHELL=/bin/bash</span><br><span class="line">HISTSIZE=1000</span><br><span class="line">SSH_CLIENT=192.168.1.5 6921 22</span><br><span class="line">SELINUX_USE_CURRENT_RANGE=</span><br><span class="line">SSH_TTY=/dev/pts/4</span><br><span class="line">USER=root</span><br><span class="line">LS_COLORS=rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:mi=01;05;37;41:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arc=01;31:*.arj=01;31:*.taz=01;31:*.lha=01;31:*.lz4=01;31:*.lzh=01;31:*.lzma=01;31:*.tlz=01;31:*.txz=01;31:*.tzo=01;31:*.t7z=01;31:*.zip=01;31:*.z=01;31:*.Z=01;31:*.dz=01;31:*.gz=01;31:*.lrz=01;31:*.lz=01;31:*.lzo=01;31:*.xz=01;31:*.bz2=01;31:*.bz=01;31:*.tbz=01;31:*.tbz2=01;31:*.tz=01;31:*.deb=01;31:*.rpm=01;31:*.jar=01;31:*.war=01;31:*.ear=01;31:*.sar=01;31:*.rar=01;31:*.alz=01;31:*.ace=01;31:*.zoo=01;31:*.cpio=01;31:*.7z=01;31:*.rz=01;31:*.cab=01;31:*.jpg=01;35:*.jpeg=01;35:*.gif=01;35:*.bmp=01;35:*.pbm=01;35:*.pgm=01;35:*.ppm=01;35:*.tga=01;35:*.xbm=01;35:*.xpm=01;35:*.tif=01;35:*.tiff=01;35:*.png=01;35:*.svg=01;35:*.svgz=01;35:*.mng=01;35:*.pcx=01;35:*.mov=01;35:*.mpg=01;35:*.mpeg=01;35:*.m2v=01;35:*.mkv=01;35:*.webm=01;35:*.ogm=01;35:*.mp4=01;35:*.m4v=01;35:*.mp4v=01;35:*.vob=01;35:*.qt=01;35:*.nuv=01;35:*.wmv=01;35:*.asf=01;35:*.rm=01;35:*.rmvb=01;35:*.flc=01;35:*.avi=01;35:*.fli=01;35:*.flv=01;35:*.gl=01;35:*.dl=01;35:*.xcf=01;35:*.xwd=01;35:*.yuv=01;35:*.cgm=01;35:*.emf=01;35:*.axv=01;35:*.anx=01;35:*.ogv=01;35:*.ogx=01;35:*.aac=01;36:*.au=01;36:*.flac=01;36:*.mid=01;36:*.midi=01;36:*.mka=01;36:*.mp3=01;36:*.mpc=01;36:*.ogg=01;36:*.ra=01;36:*.wav=01;36:*.axa=01;36:*.oga=01;36:*.spx=01;36:*.xspf=01;36:</span><br><span class="line">MAIL=/var/spool/mail/root</span><br><span class="line">PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin</span><br><span class="line">PWD=/root/shell</span><br><span class="line">LANG=zh_CN.UTF-8</span><br><span class="line">SELINUX_LEVEL_REQUESTED=</span><br><span class="line">HISTCONTROL=ignoredups</span><br><span class="line">SHLVL=1</span><br><span class="line">HOME=/root</span><br><span class="line">LOGNAME=root</span><br><span class="line">XDG_DATA_DIRS=/root/.local/share/flatpak/exports/share:/var/lib/flatpak/exports/share:/usr/local/share:/usr/share</span><br><span class="line">SSH_CONNECTION=192.168.1.5 6921 192.168.1.130 22</span><br><span class="line">LESSOPEN=||/usr/bin/lesspipe.sh %s</span><br><span class="line">XDG_RUNTIME_DIR=/run/user/0</span><br><span class="line">DISPLAY=localhost:11.0</span><br><span class="line">_=/usr/bin/env</span><br><span class="line">OLDPWD=/root</span><br><span class="line">[root@root shell]# printenv</span><br><span class="line">XDG_SESSION_ID=84</span><br><span class="line">HOSTNAME=root</span><br><span class="line">...同上所述</span><br><span class="line">[root@root shell]# printenv USER</span><br><span class="line">root</span><br><span class="line">[root@root shell]# echo $HOME</span><br><span class="line">/root</span><br><span class="line">[root@root shell]# ls $HOME</span><br><span class="line">anaconda-ks.cfg  initial-setup-ks.cfg  shell  公共  模板  视频  图片  文档  下载  音乐  桌面</span><br><span class="line">[root@root shell]#</span><br><span class="line">[root@root shell]# set</span><br><span class="line">ABRT_DEBUG_LOG=/dev/null</span><br><span class="line">BASH=/bin/bash</span><br><span class="line">BASHOPTS=checkwinsize:cmdhist:expand_aliases:extglob:extquote:force_fignore:histappend:interactive_comments:login_shell:progcomp:promptvars:sourcepath</span><br><span class="line">BASH_ALIASES=()</span><br><span class="line">BASH_ARGC=()</span><br><span class="line">BASH_ARGV=()</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h3 id="自定义变量"><a href="#自定义变量" class="headerlink" title="自定义变量"></a>自定义变量</h3><blockquote>
<p>定义变量：变量名&#x3D;变量值， &#x3D; 前后不能使用空格。</p>
<p>撤销变量：unset 变量名。</p>
<p>声明静态变量：readonly 变量，注意：不能 unset。</p>
<p><strong>读取变量：$变量名，${特殊变量名}</strong></p>
<p>变量定义规则 ：</p>
<ol>
<li>变量名称可以由字母、数字和下划线组成，但是不能以数字开头，环境变量名建议大写。</li>
<li>等号两侧不能有空格。</li>
<li>在 bash 中，变量默认类型都是字符串类型，无法直接进行数值运算。</li>
<li>变量的值如果有空格，需要使用双引号或单引号括起来。</li>
</ol>
</blockquote>
<blockquote>
<p>注释说明：</p>
<p># 单行注释</p>
<p>:&gt;&gt;! 多行注释 !</p>
</blockquote>
<p>示例：变量的赋值及修改</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# A=1</span><br><span class="line">[root@root shell]# echo $A</span><br><span class="line">1</span><br><span class="line">[root@root shell]# A=2</span><br><span class="line">[root@root shell]# echo $A</span><br><span class="line">2</span><br><span class="line">[root@root shell]# unset A</span><br><span class="line">[root@root shell]# echo $A</span><br><span class="line"></span><br><span class="line">[root@root shell]# readonly B=2</span><br><span class="line">[root@root shell]# echo $B</span><br><span class="line">2</span><br><span class="line">[root@root shell]# unset B</span><br><span class="line">-bash: unset: B: 无法反设定: 只读 variable</span><br></pre></td></tr></table></figure>

<h3 id="注意事项-x2F-x2F"><a href="#注意事项-x2F-x2F" class="headerlink" title="注意事项 $[ ]&#x2F;$( )&#x2F;$(( ))"></a>注意事项 $[ ]&#x2F;$( )&#x2F;$(( ))</h3><p>在 bash 中，变量默认类型都是字符串类型，无法直接进行数值运算。</p>
<p><strong>如果要参与数值运算：</strong></p>
<p>方式一：$((表达式))</p>
<p>方式二：$[表达式]</p>
<p><strong>将命令的返回值赋值给变量</strong></p>
<p><strong>A&#x3D;`ls -la` 将命令的结果赋值返回给变量A</strong></p>
<p><strong>A&#x3D;$(ls -la)等价于反引号</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# C=1+2</span><br><span class="line">[root@root shell]# echo $C</span><br><span class="line">1+2</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">方式一</span></span><br><span class="line">[root@root shell]# C=$((1+2))</span><br><span class="line">[root@root shell]# echo $C</span><br><span class="line">3</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">方式二</span></span><br><span class="line">[root@root shell]# C=$[1+2]</span><br><span class="line">[root@root shell]# echo $C</span><br><span class="line">3</span><br></pre></td></tr></table></figure>

<p>变量的值如果有空格，需要使用双引号或单引号括起来。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# D=Hello World</span><br><span class="line">bash: World: 未找到命令...</span><br><span class="line">[root@root shell]# D=&#x27;Hello World&#x27;</span><br><span class="line">[root@root shell]# echo $D</span><br><span class="line">Hello World</span><br></pre></td></tr></table></figure>

<p><strong>export 可把变量提升为全局环境变量，可供其他 Shell 程序使用。</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# export D</span><br><span class="line">[root@root shell]# bash</span><br><span class="line">[root@root shell]# ps -f</span><br><span class="line">UID         PID   PPID  C STIME TTY          TIME CMD</span><br><span class="line">root       9873   9865  0 08:34 pts/4    00:00:00 -bash</span><br><span class="line">root      10819   9873  0 09:54 pts/4    00:00:00 bash</span><br><span class="line">root      10855  10819  0 09:54 pts/4    00:00:00 ps -f</span><br><span class="line">[root@root shell]# echo $D</span><br><span class="line">Hello World</span><br></pre></td></tr></table></figure>

<p>子 shell 不会改变全局变量。</p>
<p><strong>示例：(使用 “.” &#x2F; source会在当前 bash 中执行，将变量导出后才能在子 shell 中使用)</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# E=&#x27;Hello Shell&#x27;</span><br><span class="line">[root@root shell]# vim helloworld.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">echo &#x27;Hello World&#x27;</span><br><span class="line">echo $E</span><br><span class="line">[root@root shell]# ./helloworld.sh</span><br><span class="line">Hello World</span><br><span class="line"></span><br><span class="line">[root@root shell]# . helloworld.sh</span><br><span class="line">Hello World</span><br><span class="line">Hello Shell</span><br><span class="line">[root@root shell]# export E</span><br><span class="line">[root@root shell]# ./helloworld.sh</span><br><span class="line">Hello World</span><br><span class="line">Hello Shell</span><br><span class="line">[root@root shell]#</span><br></pre></td></tr></table></figure>

<p><strong>将命令的返回值赋值给变量</strong></p>
<p><strong>A&#x3D;`ls -la` 将命令的结果赋值返回给变量A</strong></p>
<p><strong>A&#x3D;$(ls -la)等价于反引号</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost shell]# R=`ls -a /`</span><br><span class="line">[root@localhost shell]# echo $R</span><br><span class="line">. .. bin boot dev etc home lib lib64 media mnt opt proc root run sbin srv sys tmp usr var</span><br><span class="line">[root@localhost shell]# R=$(ls -a /)</span><br><span class="line">[root@localhost shell]# echo $R</span><br><span class="line">. .. bin boot dev etc home lib lib64 media mnt opt proc root run sbin srv sys tmp usr var</span><br><span class="line">[root@localhost shell]#</span><br></pre></td></tr></table></figure>

<h3 id="特殊变量"><a href="#特殊变量" class="headerlink" title="特殊变量"></a>特殊变量</h3><p>$PATH：环境变量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# helloworld.sh</span><br><span class="line">bash: helloworld.sh: 未找到命令...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">不建议直接拷贝.sh文件到/bin目录</span></span><br><span class="line">[root@root shell]# cp helloworld.sh /bin/</span><br><span class="line">[root@root shell]# helloworld.sh</span><br><span class="line">Hello World</span><br><span class="line">Hello Shell</span><br><span class="line">[root@root shell]# rm -rf /bin/helloworld.sh</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">输出环境变量</span></span><br><span class="line">[root@root shell]# echo $PATH</span><br><span class="line">/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin</span><br></pre></td></tr></table></figure>

<h3 id="位置参数"><a href="#位置参数" class="headerlink" title="位置参数"></a>位置参数</h3><h4 id="n-位置参数"><a href="#n-位置参数" class="headerlink" title="$n  位置参数"></a>$n  位置参数</h4><p>​		$n 功能描述：n 为数字，$0 代表该脚本名称，$1-$9 代表第一到第九个参数，十以上的参数，十以上的参数需要用大括号包含，如${10}。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# vim parameter.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">echo &#x27;====位置参数====&#x27;</span><br><span class="line">echo $0</span><br><span class="line">echo $1</span><br><span class="line">echo $2</span><br><span class="line">[root@root shell]# chmod +x parameter.sh</span><br><span class="line">[root@root shell]# ./parameter.sh p1 p2</span><br><span class="line">====位置参数====</span><br><span class="line">parameter.sh</span><br><span class="line">p1</span><br><span class="line">p2</span><br></pre></td></tr></table></figure>

<h4 id="参数个数"><a href="#参数个数" class="headerlink" title="$#  参数个数"></a>$#  参数个数</h4><p>​		$#  	功能描述：获取所有输入参数个数，常用于循环，判断参数的个数是否正确。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# vim parameter.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">echo &#x27;====位置参数====&#x27;</span><br><span class="line">echo $1</span><br><span class="line">echo $2</span><br><span class="line">echo &#x27;====参数个数====&#x27;</span><br><span class="line">echo $#</span><br><span class="line">[root@root shell]# ./parameter.sh a b c</span><br><span class="line">====位置参数====</span><br><span class="line">a</span><br><span class="line">b</span><br><span class="line">====参数个数====</span><br><span class="line">3</span><br></pre></td></tr></table></figure>

<h4 id="与-具体参数"><a href="#与-具体参数" class="headerlink" title="$* 与 $@  具体参数"></a>$* 与 $@  具体参数</h4><p>​		$* （功能描述：这个变量代表命令行中所有的参数，$* 把所有的参数看成一个整体）</p>
<p>​		$@ （功能描述：这个变量也代表命令行中所有的参数，不过 $@ 把每个参数区分对待）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# vim parameter.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">echo &quot;位置变量：&quot;</span><br><span class="line">echo $1</span><br><span class="line">echo $2</span><br><span class="line">echo &quot;参数个数：&quot;</span><br><span class="line">echo $#</span><br><span class="line">echo &#x27;变量$*：&#x27;</span><br><span class="line">echo $*</span><br><span class="line">echo &#x27;变量$@：&#x27;</span><br><span class="line">echo $@</span><br><span class="line">[root@root shell]# ./parameter.sh a b c</span><br><span class="line">位置变量：</span><br><span class="line">a</span><br><span class="line">b</span><br><span class="line">参数个数：</span><br><span class="line">3</span><br><span class="line">变量$*：</span><br><span class="line">a b c</span><br><span class="line">变量$@：</span><br><span class="line">a b c</span><br></pre></td></tr></table></figure>

<h3 id="预定义变量"><a href="#预定义变量" class="headerlink" title="预定义变量"></a>预定义变量</h3><p>​		shell 事先已经定义好的变量，可以直接在shell脚本中使用。</p>
<table>
<thead>
<tr>
<th align="center"></th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>$$</strong></td>
<td><strong>当前进程的进程号(PID)</strong></td>
</tr>
<tr>
<td align="center"><strong>$!</strong></td>
<td>后台运行的最后一个进程的进程号(PID)</td>
</tr>
<tr>
<td align="center"><strong>$?</strong></td>
<td>最后一次执行的命令的返回状态。如果这个变量的值为0，证明上一个命令正确执行；如果这个变量的值为非0 (具体是哪个数，由命令自己来决定)，则证明上一个命令执行不正确了。</td>
</tr>
</tbody></table>
<p><strong>$?  命令状态</strong></p>
<p>​		$？ （功能描述：最后一次执行的命令的返回状态。如果这个变量的值为0，证明上一个命令正确执行；如果这个变量的值为非 0（具体是哪个数，由命令自己来决定），则上一个命令执行错误）。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# echo $?</span><br><span class="line">0</span><br><span class="line">[root@root shell]# parameter.sh</span><br><span class="line">bash: parameter.sh: 未找到命令...</span><br><span class="line">[root@root shell]# echo $?</span><br><span class="line">127</span><br></pre></td></tr></table></figure>

<h2 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h2><p>基本语法：</p>
<p>方式一：expr 参数1，参数2，……【不推荐】</p>
<p>expr 会将后面的内容当作参数，注意：需要使用空格分开</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# expr 1+2</span><br><span class="line">1+2</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">传入三个参数, 1,+,2</span></span><br><span class="line">[root@root shell]# expr 1 + 2</span><br><span class="line">3</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">* 表示通配符，需要进行转义</span></span><br><span class="line">[root@root shell]# expr 1 * 2</span><br><span class="line">expr: 语法错误</span><br><span class="line">[root@root shell]# expr 1 \* 2</span><br><span class="line">2</span><br></pre></td></tr></table></figure>

<p>方式二：$((运算式)) 或 $[运算式]</p>
<p>示例：计算（2+3）* 4 的值</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# echo $(((2+3)*4))</span><br><span class="line">20</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">推荐使用</span></span><br><span class="line">[root@root shell]# echo $[(2+3)*4]</span><br><span class="line">20</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">空格不影响</span></span><br><span class="line">[root@root shell]# A=$[ ( 2 + 3 ) * 4]</span><br><span class="line">[root@root shell]# echo $A</span><br><span class="line">20</span><br></pre></td></tr></table></figure>

<p>方式三：使用变量接收 expr 命令的值：<strong>（命令替换）</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# B=&quot;expr 1 + 2&quot;</span><br><span class="line">[root@root shell]# echo $B</span><br><span class="line">expr 1 + 2</span><br><span class="line">[root@root shell]# B=$(expr 1 \* 2)</span><br><span class="line">[root@root shell]# echo $B</span><br><span class="line">2</span><br><span class="line">[root@root shell]# B=`expr 2 \* 3`</span><br><span class="line">[root@root shell]# echo $B</span><br><span class="line">6</span><br><span class="line">[root@localhost shell]# R=$(ls -a /)</span><br><span class="line">[root@localhost shell]# echo $R</span><br><span class="line">. .. bin boot dev etc home lib lib64 media mnt opt proc root run sbin srv sys tmp usr var</span><br></pre></td></tr></table></figure>

<p>示例：编写add.sh，输出两数之和。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# vim add.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">sum=$[$1+$2]</span><br><span class="line">echo sum=$sum</span><br><span class="line">[root@root shell]# chmod +x add.sh</span><br><span class="line">[root@root shell]# ./add.sh 2 3</span><br><span class="line">sum=5</span><br></pre></td></tr></table></figure>

<h2 id="条件判断"><a href="#条件判断" class="headerlink" title="条件判断"></a>条件判断</h2><h3 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h3><blockquote>
<p>方式一：test condition（如果 condition  有值则为true）</p>
<p>方式二：[ condition ]（注意 condition 前后要有空格，<strong>条件非空即为true，否则为false</strong>)</p>
<p>​				非空返回true，可以使用 $? 进行验证，0 为 true，1 为 false。</p>
<p>​				[ condition ]&amp;&amp;echo ok||echo notok 条件满足，执行后面的语句。</p>
<p>使用 [ condition ] 替换 test condition</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# a=hello</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果=前后没有空格，就会被当作一个整体，会返回<span class="literal">true</span></span></span><br><span class="line">[root@root shell]# test $a=hello</span><br><span class="line">[root@root shell]# echo $?</span><br><span class="line">0</span><br><span class="line">[root@root shell]# test $a = hello</span><br><span class="line">[root@root shell]# echo $?</span><br><span class="line">0</span><br><span class="line">[root@root shell]# test $a=Hello</span><br><span class="line">[root@root shell]# echo $?</span><br><span class="line">0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">= 前后必须有空格</span></span><br><span class="line">[root@root shell]# test $a = Hello</span><br><span class="line">[root@root shell]# echo $?</span><br><span class="line">1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用 [ condition ] 代替<span class="built_in">test</span> condition</span></span><br><span class="line">[root@root shell]# [ $a = abc ]</span><br><span class="line">[root@root shell]# echo $?</span><br><span class="line">1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">必须有空格，<span class="variable">$a</span>=hello被当作一个字符串了</span></span><br><span class="line">[root@root shell]# [ $a=abc ]</span><br><span class="line">[root@root shell]# echo $?</span><br><span class="line">0</span><br><span class="line">[root@root shell]# [ abcd ]</span><br><span class="line">[root@root shell]# echo $?</span><br><span class="line">0</span><br><span class="line">[root@root shell]# [  ]</span><br><span class="line">[root@root shell]# echo $?</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<h3 id="常用判断条件"><a href="#常用判断条件" class="headerlink" title="常用判断条件"></a>常用判断条件</h3><blockquote>
<p>（1）两个整数之间比较 </p>
<p>​	注意：使用 &gt; 会重定向，但在 for 循环语句中不会，可以使用</p>
<ul>
<li>-eq 等于（equal） </li>
<li>-ne 不等于（not equal） </li>
<li>-lt 小于（less than） </li>
<li>-le 小于等于（less equal）</li>
<li>-gt 大于（greater than）</li>
<li>-ge 大于等于（greater equal）</li>
</ul>
<p>注意：如果是字符串之间的比较 ，用等号 “&#x3D;” 判断相等；用 “!&#x3D;” 判断不等于</p>
<p>（2）按照文件权限进行判断</p>
<ul>
<li>-r   有读的权限（read）</li>
<li>-w  有写的权限（write）</li>
<li>-x  有执行的权限（execute）</li>
</ul>
<p>（3）按照文件类型进行判断 </p>
<ul>
<li><p>-e  文件存在（existence）</p>
</li>
<li><p>-f  文件存在并且是一个常规的文件（file） </p>
</li>
<li><p>-d  文件存在并且是一个目录（directory）</p>
<p> (4) 多条件判断</p>
</li>
</ul>
<p>​		&amp;&amp; 表示前一条命令执行成功时，才执行后一条命令，|| 表示上一条命令执行失败后，才执行下一条命令</p>
</blockquote>
<p>示例一：判断整数大小关系</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# [ 2 = 3 ]</span><br><span class="line">[root@root shell]# echo $?</span><br><span class="line">1</span><br><span class="line">[root@root shell]# [ 2 = 2 ]</span><br><span class="line">[root@root shell]# echo $?</span><br><span class="line">0</span><br><span class="line">[root@root shell]# A=hello</span><br><span class="line">[root@root shell]# [ $A = abc ]</span><br><span class="line">[root@root shell]# echo $?</span><br><span class="line">1</span><br><span class="line">[root@root shell]# [ $A=abc ]</span><br><span class="line">[root@root shell]# echo $?</span><br><span class="line">0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2 会输出重定向到文件 3 中</span></span><br><span class="line">[root@root shell]# [ 2  &gt;  3 ]</span><br><span class="line">[root@root shell]# ll</span><br><span class="line">总用量 12</span><br><span class="line">-rw-r--r--. 1 root root   0 4月  24 11:25 3</span><br><span class="line">-rwxr-xr-x. 1 root root  39 4月  24 10:59 add.sh</span><br><span class="line">-rwxr-xr-x. 1 root root  39 4月  24 09:59 helloworld.sh</span><br><span class="line">-rwxr-xr-x. 1 root root 161 4月  24 10:37 parameter.sh</span><br><span class="line">[root@root shell]# [ 2  &lt;  3 ]</span><br><span class="line">[root@root shell]# [ 2 -lt 3 ]</span><br><span class="line">[root@root shell]# echo $?</span><br><span class="line">0</span><br><span class="line">[root@root shell]#</span><br></pre></td></tr></table></figure>

<p>示例二：判断文件权限</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# touch test</span><br><span class="line">[root@root shell]# [ -x test ]</span><br><span class="line">[root@root shell]# echo $?</span><br><span class="line">1</span><br><span class="line">[root@root shell]# [ -x helloworld.sh ]</span><br><span class="line">[root@root shell]# echo $?</span><br><span class="line">0</span><br></pre></td></tr></table></figure>

<p>示例三：判断文件类型</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# [ -d test ]</span><br><span class="line">[root@root shell]# echo $?</span><br><span class="line">1</span><br><span class="line">[root@root shell]# [ -f test ]</span><br><span class="line">[root@root shell]# echo $?</span><br><span class="line">0</span><br><span class="line">[root@root shell]#</span><br></pre></td></tr></table></figure>

<p>示例四：多条件判断（&amp;&amp; 表示前一条命令执行成功时，才执行后一条命令，|| 表示上一条命令执行失败后，才执行下一条命令）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# [ condition ] &amp;&amp; echo ok ||echo error</span><br><span class="line">ok</span><br><span class="line">[root@root shell]# [  ] &amp;&amp; echo ok ||echo error</span><br><span class="line">error</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">示例2</span></span><br><span class="line">[root@root shell]# A=18</span><br><span class="line">[root@root shell]# [ $A -le 20 ] &amp;&amp; echo &quot;$A &lt;= 20&quot; || echo &quot;$A &gt;= 20&quot;</span><br><span class="line">18 &lt;= 20</span><br><span class="line">[root@root shell]# A=25</span><br><span class="line">[root@root shell]# [ $A -le 20 ] &amp;&amp; echo &quot;$A &lt;= 20&quot; || echo &quot;$A &gt;= 20&quot;</span><br><span class="line">25 &gt;= 20</span><br></pre></td></tr></table></figure>

<h2 id="流程控制"><a href="#流程控制" class="headerlink" title="流程控制"></a>流程控制</h2><h3 id="if-判断"><a href="#if-判断" class="headerlink" title="if 判断"></a>if 判断</h3><p>（1）单分支</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">;表示语句在一行,如<span class="built_in">cd</span> /etc;<span class="built_in">ls</span></span></span><br><span class="line">if [ 条件 ];then</span><br><span class="line">	程序</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if [ 条件 ]</span><br><span class="line">then</span><br><span class="line">	程序</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>（2）多分支	</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">if [ 条件判断式 ]</span><br><span class="line">then</span><br><span class="line">	程序</span><br><span class="line">elif [ 条件 ]</span><br><span class="line">then</span><br><span class="line">	程序</span><br><span class="line">else</span><br><span class="line">	程序</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>注意事项：</p>
<ul>
<li><p>[ 条件判断式 ]，中括号和条件判断式之间必须有空格</p>
</li>
<li><p>if 后要有空格</p>
</li>
</ul>
<p>​	可以使用 exit 退出判断</p>
<p>示例：根据输出的数判断大小</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# vim if.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">if [ $1 -eq 2 ];then</span><br><span class="line">        echo &quot;$1 等于 2&quot;</span><br><span class="line">elif [ $1 -lt 2 ]</span><br><span class="line">then</span><br><span class="line">        echo &quot;$1 小于 2&quot;</span><br><span class="line">else</span><br><span class="line">        echo &quot;$1 大于 2&quot;</span><br><span class="line">fi</span><br><span class="line">[root@root shell]# chmod +x if.sh</span><br><span class="line">[root@root shell]# ./if.sh 3</span><br><span class="line">3 大于 2</span><br><span class="line">[root@root shell]# ./if.sh 1</span><br><span class="line">1 小于 2</span><br><span class="line">[root@root shell]# ./if.sh 2</span><br><span class="line">2 等于 2</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果不传递参数</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">if [ &quot;$1&quot; -eq &quot;2&quot;];then</span><br><span class="line">        echo &quot;$1 等于 2&quot;</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">也可以写在一行</span></span><br><span class="line">[root@root shell]# a=19</span><br><span class="line">[root@root shell]# if [ $a -ge 18 ] &amp;&amp; [ $a -le 20 ];then echo ok;fi</span><br><span class="line">ok</span><br><span class="line">[root@root shell]# a=21</span><br><span class="line">[root@root shell]# if [ $a -ge 18 ] &amp;&amp; [ $a -le 20 ];then echo ok;fi</span><br><span class="line">[root@root shell]</span><br></pre></td></tr></table></figure>

<h3 id="case-语句"><a href="#case-语句" class="headerlink" title="case 语句"></a>case 语句</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">case $变量名 in</span><br><span class="line">&quot;值 1&quot;)</span><br><span class="line">	如果变量的值等于值 1，则执行程序 1, 对于数字可以省略引号</span><br><span class="line">;;</span><br><span class="line">&quot;值 2&quot;)</span><br><span class="line">	如果变量的值等于值 2，则执行程序 2</span><br><span class="line">;;</span><br><span class="line">	......其他分支......</span><br><span class="line">*)</span><br><span class="line">	如果变量的值都不是以上的值，则执行此程序</span><br><span class="line">;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意事项：</strong></p>
<p>（1）case 行尾必须为单词 “in”，每一个模式匹配必须以右括号 “)” 结束。</p>
<p>（2）双分号 “;;” 表示命令序列结束，相当于 java 中的 break。</p>
<p>（3）最后的 “*)” 表示默认模式，相当于 java 中的 default。</p>
</blockquote>
<p>示例：输入一个数进行判断</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@root etc]# vim case.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">case $1 in</span><br><span class="line">&quot;1&quot;)</span><br><span class="line">        echo success</span><br><span class="line">;;</span><br><span class="line">&quot;2&quot;)</span><br><span class="line">        echo warning</span><br><span class="line">;;</span><br><span class="line">*)</span><br><span class="line">        echo error</span><br><span class="line">esac</span><br><span class="line">[root@root etc]# chmod +x case.sh</span><br><span class="line">[root@root etc]# ./case.sh 1</span><br><span class="line">success</span><br><span class="line">[root@root etc]# ./case.sh 2</span><br><span class="line">warning</span><br><span class="line">[root@root etc]# ./case.sh 3</span><br><span class="line">error</span><br><span class="line">[root@root etc]#</span><br></pre></td></tr></table></figure>

<h3 id="for循环"><a href="#for循环" class="headerlink" title="for循环"></a>for循环</h3><p>语法一：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for (( 初始值;循环控制条件;变量变化 ))</span><br><span class="line">do</span><br><span class="line">程序</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>语法二：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for 变量 in 值 1 值 2 值 3…</span><br><span class="line">do</span><br><span class="line">程序</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p><strong>{1..100} 表示序列</strong></p>
<p>示例：1+2+……+100</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# vim for01.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">sum=0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">此处使用(())，可以使用&lt;==,&lt;，不是重定向</span></span><br><span class="line">for((i=0;i&lt;=100;i++))</span><br><span class="line">do</span><br><span class="line">        sum=$[$sum+$i]</span><br><span class="line">done</span><br><span class="line">echo $sum</span><br><span class="line">[root@root shell]# chmod +x for01.sh</span><br><span class="line">[root@root shell]# ./for01.sh</span><br><span class="line">5050</span><br></pre></td></tr></table></figure>

<p>示例：结合 $*，$@ 使用，如果不加引号，则控制台输出没有区别。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">&#123;1..100&#125;表示序列</span></span><br><span class="line">[root@root shell]# for i in &#123;1..100&#125;;do sum=$[$sum+$i];done;echo $sum;</span><br><span class="line">5050</span><br><span class="line">[root@root shell]# vim for02.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">$*和<span class="variable">$@</span>都表示传递给函数或脚本的所有参数，不被双引号 <span class="string">&quot;&quot;</span> 包含时，都以<span class="variable">$1</span> <span class="variable">$2</span> …<span class="variable">$n</span>的形式输出所有参数</span></span><br><span class="line">echo &quot;======不使用引号========&quot;</span><br><span class="line">echo &#x27;$*: &#x27;</span><br><span class="line">for para in $*</span><br><span class="line">do</span><br><span class="line">        echo $para</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">echo &#x27;$@: &#x27;</span><br><span class="line">for para in $@</span><br><span class="line">do</span><br><span class="line">        echo $para</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">echo &quot;======使用引号========&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加引号</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">当它们被双引号 <span class="string">&quot;&quot;</span> 包含时，$*会将所有的参数作为一个整体，以 <span class="string">&quot;<span class="variable">$1</span> <span class="variable">$2</span>...<span class="variable">$n</span>&quot;</span> 的形式输出所有参数；<span class="variable">$@</span>会将各个参数分开，以<span class="string">&quot;<span class="variable">$1</span>&quot;</span> <span class="string">&quot;<span class="variable">$2</span>&quot;</span>...<span class="string">&quot;<span class="variable">$n</span>&quot;</span>的形式输出所有参数。</span></span><br><span class="line">echo &#x27;$*: &#x27;</span><br><span class="line">for para in &quot;$*&quot;</span><br><span class="line">do</span><br><span class="line">        echo $para</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">echo &#x27;$@: &#x27;</span><br><span class="line">for para in &quot;$@&quot;</span><br><span class="line">do</span><br><span class="line">        echo $para</span><br><span class="line">done</span><br><span class="line">[root@root shell]# chmod 777 for02.sh</span><br><span class="line">[root@root shell]# ./for02.sh a b c</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">*:</span></span><br><span class="line">a</span><br><span class="line">b</span><br><span class="line">c</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">@:</span></span><br><span class="line">a</span><br><span class="line">b</span><br><span class="line">c</span><br><span class="line">======使用引号======</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">*:</span></span><br><span class="line">a b c</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">@:</span></span><br><span class="line">a</span><br><span class="line">b</span><br><span class="line">c</span><br></pre></td></tr></table></figure>

<h3 id="while循环"><a href="#while循环" class="headerlink" title="while循环"></a>while循环</h3><p>基本语法</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">while [ 条件判断式 ]</span><br><span class="line">do</span><br><span class="line">程序</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>示例：1+2+……+100</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# vim while.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">sum=0</span><br><span class="line">count=1</span><br><span class="line">while [ $count -lt 100 ]</span><br><span class="line">do</span><br><span class="line">        sum=$[$sum+$count]</span><br><span class="line">        count=$[$count+1]</span><br><span class="line">        # 也可以采用let</span><br><span class="line">        # let sum+=count</span><br><span class="line">        # let count++</span><br><span class="line">done</span><br><span class="line">echo &quot;count: $count, sum: $sum&quot;</span><br><span class="line">[root@root shell]# ./while.sh</span><br><span class="line">count: 100, sum: 5050</span><br></pre></td></tr></table></figure>

<h2 id="read-读取控制台输入"><a href="#read-读取控制台输入" class="headerlink" title="read 读取控制台输入"></a>read 读取控制台输入</h2><blockquote>
<p>基本语法</p>
<p>read (选项) (参数) </p>
<p>选项：</p>
<p>​		-p：指定读取值时的提示符； </p>
<p>​		-t：指定读取值时等待的时间（秒）如果不加 -t 表示一直等待</p>
<p>参数变量：指定读取值的变量名</p>
</blockquote>
<p>示例：提示 7 秒内，读取控制台输入的名称</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# vim read.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">read -t 7 -p &quot;请输入内容: &quot; R</span><br><span class="line">echo $R</span><br><span class="line">[root@root shell]# chmod +x read.sh</span><br><span class="line">[root@root shell]# ./read.sh</span><br><span class="line">请输入内容: root</span><br><span class="line">root</span><br></pre></td></tr></table></figure>

<h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><h3 id="系统函数"><a href="#系统函数" class="headerlink" title="系统函数"></a>系统函数</h3><blockquote>
<p><strong>basename</strong></p>
<p>basename [string &#x2F; pathname] [suffix] </p>
<p>basename 命令会删掉所有的前缀包括最后一个 “&#x2F;“ 字符，然后将字符串显示出来。 </p>
<p>basename 可以理解为：取路径里的文件名称。</p>
<p>选项： suffix 为后缀，如果 suffix 被指定，basename 会将 pathname 或 string 中的 suffix 去掉。</p>
</blockquote>
<p>示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# basename /root/shell/read.sh</span><br><span class="line">read.sh</span><br><span class="line">[root@root shell]# basename /root/shell/read.sh .sh</span><br><span class="line">read</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取当前脚本所在路径, <span class="variable">$0</span> 代表该脚本名称</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">basename</span> <span class="variable">$0</span></span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>dirname</strong></p>
<p>dirname 文件绝对路径</p>
<p>获取文件路径的绝对路径名称</p>
</blockquote>
<p>示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# dirname /root/shell/read.sh</span><br><span class="line">/root/shell</span><br></pre></td></tr></table></figure>

<h3 id="自定义函数"><a href="#自定义函数" class="headerlink" title="自定义函数"></a>自定义函数</h3><p>基本语法</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">定义</span></span><br><span class="line">[ function ] funname[()]</span><br><span class="line">&#123;</span><br><span class="line">	Action;</span><br><span class="line">	[return int;]</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用$(接收返回的值)</span></span><br><span class="line">funname param1 param2...</span><br></pre></td></tr></table></figure>

<p>（1）必须在调用函数地方之前，先声明函数，shell 脚本是逐行运行。不会像其它语言一样先编译。 </p>
<p>（2）函数返回值，只能通过 $? 系统变量获得，可以显式加：return 返回，如果不加，将以最后一条命令运行结果，作为返回值。return 后跟数值 n(0-255)</p>
<p>示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# vim fun.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">function add()&#123;</span><br><span class="line">        s=$[$1+$2]</span><br><span class="line">        echo $s</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">read -p &quot;please input number1: &quot; num1</span><br><span class="line">read -p &quot;please input number2: &quot; num2</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用$(接收返回的值)</span></span><br><span class="line">sum=$(add $num1 $num2)</span><br><span class="line">echo &quot;sum: &quot;$sum</span><br><span class="line">echo &quot;square: &quot;$[$sum * $sum]</span><br><span class="line">[root@root shell]# ./fun.sh</span><br></pre></td></tr></table></figure>



<h2 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h2><p>​		正则表达式使用单个字符串来描述、匹配一系列符合某个语法规则的字符串。在很多文本编辑器里，正则表达式通常被用来检索、替换那些符合某个模式的文本。在 Linux 中，<strong>grep，sed，awk</strong> 等文本处理工具都支持通过正则表达式进行模式匹配。</p>
<p>示例：匹配 &#x2F;etc&#x2F;passwd&#x2F; 下的所有包含bash的行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@root archive]# cat /etc/passwd |grep bash</span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">liufei:x:1000:1000:liufei:/home/liufei:/bin/bash</span><br></pre></td></tr></table></figure>

<h3 id="常用的特殊字符"><a href="#常用的特殊字符" class="headerlink" title="常用的特殊字符"></a>常用的特殊字符</h3><h4 id="：匹配一行的开头"><a href="#：匹配一行的开头" class="headerlink" title="^：匹配一行的开头"></a>^：匹配一行的开头</h4><p>示例：以 a 开头</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@root archive]# cat /etc/passwd|grep ^a</span><br><span class="line">adm:x:3:4:adm:/var/adm:/sbin/nologin</span><br><span class="line">abrt:x:173:173::/etc/abrt:/sbin/nologin</span><br><span class="line">avahi:x:70:70:Avahi mDNS/DNS-SD Stack:/var/run/avahi-daemon:/sbin/nologin</span><br></pre></td></tr></table></figure>

<h4 id="：匹配一行的结束"><a href="#：匹配一行的结束" class="headerlink" title="$：匹配一行的结束"></a>$：匹配一行的结束</h4><p>示例：以 t 结束</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@root archive]# cat /etc/passwd|grep t$</span><br><span class="line">halt:x:7:0:halt:/sbin:/sbin/halt</span><br></pre></td></tr></table></figure>

<h4 id="点-：匹配一个任意的字符"><a href="#点-：匹配一个任意的字符" class="headerlink" title="点 . ：匹配一个任意的字符"></a>点 <strong>.</strong> ：匹配一个任意的字符</h4><p>示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@root archive]# cat /etc/passwd|grep r..t</span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">operator:x:11:0:operator:/root:/sbin/nologin</span><br><span class="line">ftp:x:14:50:FTP User:/var/ftp:/sbin/nologin</span><br></pre></td></tr></table></figure>

<h4 id="：匹配0次或多次"><a href="#：匹配0次或多次" class="headerlink" title="*：匹配0次或多次"></a>*：匹配0次或多次</h4><p>​		不单独使用，它和上一个字符连用，表示匹配上一个字符 0 次或多次。</p>
<p>示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@root archive]# cat /etc/passwd|grep ro*t</span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">operator:x:11:0:operator:/root:/sbin/nologin</span><br></pre></td></tr></table></figure>

<h4 id="：匹配某个范围内的一个字符"><a href="#：匹配某个范围内的一个字符" class="headerlink" title="[ ]：匹配某个范围内的一个字符"></a>[ ]：匹配某个范围内的一个字符</h4><p>[ ] 表示匹配某个范围内的<strong>一个字符</strong>，例如</p>
<p>[6,8]			匹配 6 或者 8 </p>
<p>[0-9]			匹配一个 0-9 的数字 </p>
<p>[0-9]*			匹配任意长度的数字字符串</p>
<p>[a-z]*			匹配任意长度 a-z 之间的字符</p>
<p>[a-z]			匹配任意长度的字母字符串 </p>
<p>[a-c, e-f]		匹配 a-c 或者 e-f 之间的任意字符</p>
<p>示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@root archive]# cat /etc/passwd|grep r[a,b,c]*t</span><br><span class="line">operator:x:11:0:operator:/root:/sbin/nologin</span><br><span class="line">abrt:x:173:173::/etc/abrt:/sbin/nologin</span><br><span class="line">rtkit:x:172:172:RealtimeKit:/proc:/sbin/nologin</span><br><span class="line">sshd:x:74:74:Privilege-separated SSH:/var/empty/sshd:/sbin/nologin</span><br></pre></td></tr></table></figure>

<h4 id="：转义字符"><a href="#：转义字符" class="headerlink" title="\：转义字符"></a>\：转义字符</h4><p>​		\ 表示转义，并不会单独使用。匹配特殊字符，如$、^等。【需要使用单引号将表达式引起来】</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@root archive]# cat /etc/passwd|grep &#x27;a\$b&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="文本处理工具"><a href="#文本处理工具" class="headerlink" title="文本处理工具"></a>文本处理工具</h3><h4 id="grep"><a href="#grep" class="headerlink" title="grep"></a>grep</h4><p>​		过滤文本的行</p>
<h4 id="cut"><a href="#cut" class="headerlink" title="cut"></a>cut</h4><p>​		在文件中负责剪切数据用的。cut 命令从文件的每一行剪切字节、字符和字段并将这些字节、字符和字段输出。</p>
<p>基本语法</p>
<p>​		cut [选项参数] filename</p>
<p>选项参数说明</p>
<table>
<thead>
<tr>
<th>选项参数</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>-f</td>
<td>列号，提取第几列</td>
</tr>
<tr>
<td>-d</td>
<td>分隔符，按照指定分隔符有进行分隔，默认分隔符是制表符</td>
</tr>
<tr>
<td>-c</td>
<td>按字符进行切割后加 n 表示取第几列 比如 -c 1</td>
</tr>
</tbody></table>
<p>示例：选取系统 PATH 变量值，第二个 : 后开始的所有路径。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@root archive]# echo $PATH</span><br><span class="line">/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin</span><br><span class="line">[root@root archive]# echo $PATH | cut -d &quot;:&quot; -f 3-</span><br><span class="line">/usr/sbin:/usr/bin:/root/bin</span><br></pre></td></tr></table></figure>

<p>示例：切割 ifconfig 后打印的 IP 地址。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@root archive]# ifconfig</span><br><span class="line">ens33: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.1.130  netmask 255.255.255.0  broadcast 192.168.1.255</span><br><span class="line">        inet6 fe80::46be:b086:81c7:b3b2  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:0c:29:15:3a:b3  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 40674  bytes 3071986 (2.9 MiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 14352  bytes 1922281 (1.8 MiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536</span><br><span class="line">        inet 127.0.0.1  netmask 255.0.0.0</span><br><span class="line">        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;</span><br><span class="line">        loop  txqueuelen 1000  (Local Loopback)</span><br><span class="line">        RX packets 68  bytes 5912 (5.7 KiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 68  bytes 5912 (5.7 KiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">virbr0: flags=4099&lt;UP,BROADCAST,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.122.1  netmask 255.255.255.0  broadcast 192.168.122.255</span><br><span class="line">        ether 52:54:00:0f:e3:ff  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">[root@root archive]# ifconfig ens33 |grep netmask |cut -d &quot; &quot; -f 10</span><br><span class="line">192.168.1.130</span><br><span class="line">[root@root archive]# ifconfig |grep netmask |cut -d &quot; &quot; -f 10</span><br><span class="line">192.168.1.130</span><br><span class="line">127.0.0.1</span><br><span class="line">192.168.122.1</span><br></pre></td></tr></table></figure>

<h4 id="awk"><a href="#awk" class="headerlink" title="awk"></a>awk</h4><blockquote>
<p>​		一个强大的文本分析工具，把文件逐行的读入，以空格为默认分隔符将每行切片，切开的部分再进行分析处理。</p>
<h5 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h5><p>​		awk   [选项参数]   <strong>‘&#x2F;pattern1&#x2F;{action1} &#x2F;pattern2&#x2F;{action2}……’ filename</strong> </p>
<p>​		pattern：表示 awk 在数据中查找的内容，就是匹配模式</p>
<p>​		action：在找到匹配内容时所执行的一系列命令</p>
<p>选项参数说明</p>
<p>​		-F		指定输入文件分隔符</p>
<p>​		-v		赋值一个用户定义变量</p>
</blockquote>
<p>示例：搜索 passwd 文件以 root 关键字开头的所有行，并输出该行的第7 列。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# awk -F : &#x27;/^root/&#123;print $7&#125;&#x27; /etc/passwd</span><br><span class="line">/bin/bash</span><br></pre></td></tr></table></figure>

<p>示例：搜索 passwd 文件以 root 关键字开头的所有行，并输出该行的第1 列和第7 列，中间以 “,” 号分割</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# awk -F : &#x27;/^root/&#123;print $1&quot;,&quot;$7&#125;&#x27; /etc/passwd</span><br><span class="line">root,/bin/bash</span><br></pre></td></tr></table></figure>

<p>示例：只显示&#x2F;etc&#x2F;passwd 的第一列和第七列，以逗号分割，且在所有行前面添加列名user，shell 在最后一行添加”end，			shell”。</p>
<p>注意：BEGIN 在所有数据读取行之前执行；END 在所有数据执行之后执行。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# awk -F : &#x27;BEGIN&#123;print &quot;user,shell&quot;&#125; &#123;print $1&quot;,&quot;$7&#125; END&#123;print &quot;shell end&quot;&#125;&#x27; /etc/passwd</span><br><span class="line">user,shell</span><br><span class="line">root,/bin/bash</span><br><span class="line">bin,/sbin/nologin</span><br><span class="line">......</span><br><span class="line">liufei,/bin/bash</span><br><span class="line">mysql,/bin/false</span><br><span class="line">shell end</span><br></pre></td></tr></table></figure>

<p>示例：将 passwd 文件中的用户 id 增加数值 1 并输出。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# awk -F : -v i=1 &#x27;&#123;print $3+i&#125;&#x27; /etc/passwd</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">......</span><br><span class="line">100</span><br><span class="line">193</span><br><span class="line">82</span><br><span class="line">1000</span><br></pre></td></tr></table></figure>

<h5 id="awk-的内置变量"><a href="#awk-的内置变量" class="headerlink" title="awk 的内置变量"></a>awk 的内置变量</h5><table>
<thead>
<tr>
<th>变量</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>FILENAME</td>
<td>文件名</td>
</tr>
<tr>
<td>NR</td>
<td>已读的记录数（行号）</td>
</tr>
<tr>
<td>NF</td>
<td>浏览记录的域的个数（切割后，列的个数）</td>
</tr>
</tbody></table>
<p>示例：统计 passwd 文件名，每行的行号，每行的列数。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# awk -F : &#x27;&#123;print &quot;filename: &quot;FILENAME&quot;, lineNum: &quot;NR&quot;, column: &quot;NF&#125;&#x27; /etc/passwd</span><br><span class="line">filename: /etc/passwd, lineNum: 1, column: 7</span><br><span class="line">filename: /etc/passwd, lineNum: 2, column: 7</span><br><span class="line">filename: /etc/passwd, lineNum: 3, column: 7</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>示例：查询 ifconfig 命令输出结果中的空行所在的行号。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# ifconfig |awk &#x27;/^$/&#123;print NR&#125;&#x27;</span><br><span class="line">9</span><br><span class="line">18</span><br><span class="line">26	</span><br></pre></td></tr></table></figure>

<p>示例：切割IP，默认以空格分割</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# ifconfig |awk &#x27;/netmask/&#123;print $2&#125;&#x27;</span><br><span class="line">192.168.1.130</span><br><span class="line">127.0.0.1</span><br><span class="line">192.168.122.1</span><br></pre></td></tr></table></figure>

<h2 id="Shell示例"><a href="#Shell示例" class="headerlink" title="Shell示例"></a>Shell示例</h2><h3 id="文件归档"><a href="#文件归档" class="headerlink" title="文件归档"></a>文件归档</h3><p>示例：</p>
<p>​		实现一个每天对指定目录归档备份的脚本，输入一个目录名称（末尾不带&#x2F;），将目录下所有文件按天归档保存，并将</p>
<p>归档日期附加在归档文件名上，放在 &#x2F;opt&#x2F;shell&#x2F;archive 下。这里用到了归档命令：tar 后面可以加上 -c 选项表示归档，</p>
<p>加上  -z 选项表示同时进行压缩，得到的文件后缀名为.tar.gz。 archive .sh 脚本实现如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">首先判断输入参数个数是否为1</span></span><br><span class="line">if [ $# -ne 1 ]</span><br><span class="line">then</span><br><span class="line">	echo &quot;参数个数错误！应该输入一个参数，作为归档目录名&quot;</span><br><span class="line">	exit</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">从参数中获取目录名称</span></span><br><span class="line">if [ -d $1 ]</span><br><span class="line">then</span><br><span class="line">	echo &quot;目录存在！&quot;</span><br><span class="line">else</span><br><span class="line">	echo</span><br><span class="line">	echo &quot;目录不存在！&quot;</span><br><span class="line">	echo</span><br><span class="line">	exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">DIR_NAME=$(basename $1)</span><br><span class="line">DIR_PATH=$(cd $(dirname $1); pwd)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取当前日期</span></span><br><span class="line">DATE=$(date +%Y%m%d)</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">定义生成的归档文件名称</span></span><br><span class="line">DEST_PATH=/opt/shell/archive</span><br><span class="line">FILE=archive_$&#123;DIR_NAME&#125;_$DATE.tar.gz</span><br><span class="line">DEST=$DEST_PATH/$FILE</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开始归档目录文件</span></span><br><span class="line"></span><br><span class="line">echo &quot;开始归档...&quot;</span><br><span class="line">echo</span><br><span class="line"></span><br><span class="line">tar -czf $DEST $DIR_PATH/$DIR_NAME</span><br><span class="line"></span><br><span class="line">if [ $? -eq 0 ]</span><br><span class="line">then</span><br><span class="line">	echo</span><br><span class="line">	echo &quot;归档成功！&quot;</span><br><span class="line">	echo &quot;归档文件为：$DEST&quot;</span><br><span class="line">	echo</span><br><span class="line">else</span><br><span class="line">	echo &quot;归档出现问题！&quot;</span><br><span class="line">	echo</span><br><span class="line">fi</span><br><span class="line">exit</span><br></pre></td></tr></table></figure>



<h3 id="数据库备份"><a href="#数据库备份" class="headerlink" title="数据库备份"></a>数据库备份</h3><ol>
<li><p>每天凌晨 2:10 备份数据库 testDB 到&#x2F;data&#x2F;backup&#x2F;db</p>
</li>
<li><p>备份开始和备份结束能够给出相应的提示信息</p>
</li>
<li><p>备份后的文件要求以备份时间为文件名，并打包成 tar.gz. 的形式，比如：2018-03-12_ 230201.tar.gz</p>
</li>
<li><p>在备份的同时，检查是否有 10 天前备份的数据库文件，如果有就将其删除</p>
</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">BACKUP=/opt/shell/backup/db</span><br><span class="line">DATETIME=$(date +%Y_%m_%d_%H%M%S)</span><br><span class="line">echo &quot;开始备份...&quot;</span><br><span class="line">echo &quot;备份路径为：$BACKUP/$DATETIME.tar.gz&quot;</span><br><span class="line">HOST=127.0.0.1</span><br><span class="line">DB_USER=root</span><br><span class="line">DB_PWD=root</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">数据库名</span></span><br><span class="line">DATABASE=test</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">没有目录则创建</span></span><br><span class="line">[ ! -d &quot;$BACKUP/$DATETIME&quot; ] &amp;&amp; mkdir -p &quot;$BACKUP/$DATETIME&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">MySQL备份数据库的指令</span></span><br><span class="line">mysqldump -u$&#123;DB_USER&#125; -p$&#123;DB_PWD&#125; --host=$HOST $DATEBASE | gzip &gt; $BACKUP/$DATETIME/$DATETIME.sql.gz</span><br><span class="line"></span><br><span class="line">cd $BACKUP</span><br><span class="line">tar -zcvf $DATETIME.tar.gz $DATETIME</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除临时目录</span></span><br><span class="line">rm -rf $BACKUP/$DATETIME</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除10天前的备份文件，&#123;&#125; \ 固定写法</span></span><br><span class="line">find $BACKUP -mtime +10 -name &quot;*.tar.gz&quot; -exec rm -rf &#123;&#125; \;</span><br><span class="line">echo &quot;备份成功&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">0 2 * * * /usr/sbin/mysql_db_backup.sh</span></span><br></pre></td></tr></table></figure>

<h3 id="文件分发脚本"><a href="#文件分发脚本" class="headerlink" title="文件分发脚本"></a>文件分发脚本</h3><p>批量进行跨机器间的文件（含文件夹）传输</p>
<blockquote>
<ul>
<li>创建脚本 xsync.sh，传入要传输的目录名</li>
<li>shell脚本要求具有执行权限：chmod +x xsync</li>
<li>shell脚本保存在 &#x2F;usr&#x2F;bin 这样的目录下，以使命令全局有效</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">判断参数个数</span></span><br><span class="line">if [ $# -lt 1 ]</span><br><span class="line">then</span><br><span class="line">	echo &quot;Not Enough Arguments&quot;</span><br><span class="line">	exit</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">遍历所有主机</span></span><br><span class="line">for host in 192.168.100.100 192.168.100.110 192.168.100.120</span><br><span class="line">do</span><br><span class="line">	echo ========$host========</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">遍历所有目录</span></span><br><span class="line">	for file in $@</span><br><span class="line">	do</span><br><span class="line">		if [ -e $file ]</span><br><span class="line">		then</span><br><span class="line"><span class="meta prompt_">			# </span><span class="language-bash">如果文件存在，获取父目录，</span></span><br><span class="line"><span class="meta prompt_">			# </span><span class="language-bash"><span class="built_in">pwd</span> -P：如果目录是链接时，显示出实际路径，而非使用连接（<span class="built_in">link</span>）路径。<span class="built_in">pwd</span> 防止传入相对路径</span></span><br><span class="line"><span class="meta prompt_">			# </span><span class="language-bash"><span class="built_in">cd</span> -P:如果目录是链接时，切换到实际路径的目录。</span></span><br><span class="line">			pdir=$(cd -P $(dirname $file);pwd)</span><br><span class="line"><span class="meta prompt_">			# </span><span class="language-bash">获取文件名称</span></span><br><span class="line">			filename=$(basename $file)</span><br><span class="line">			ssh $host &quot;mkdir -p $pdir&quot;</span><br><span class="line">			rsync -av $pdir/$filename $host:$pdir</span><br><span class="line">		else</span><br><span class="line">			echo $file not exist!</span><br><span class="line">		fi</span><br><span class="line">	done</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@root shell]# chmod +x xsync.sh</span><br><span class="line">[root@root shell]# cp xsync.sh /usr/bin</span><br></pre></td></tr></table></figure>

<h3 id="查看所有-JPS-进程"><a href="#查看所有-JPS-进程" class="headerlink" title="查看所有 JPS 进程"></a>查看所有 JPS 进程</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">for host in 192.168.100.100 192.168.100.110 192.168.100.120</span><br><span class="line">do</span><br><span class="line">    echo ========$host========</span><br><span class="line">    ssh $host jps $@ | grep -v Jps</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h3 id="Zookeeper-启动停止脚本"><a href="#Zookeeper-启动停止脚本" class="headerlink" title="Zookeeper 启动停止脚本"></a>Zookeeper 启动停止脚本</h3><blockquote>
<p>启动 Zookeeper 集群，脚本位置：&#x2F;home&#x2F;xxxx&#x2F;bin</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">case $1 in</span><br><span class="line">&quot;start&quot;)&#123;</span><br><span class="line">	for host in 192.168.100.100 192.168.100.110 192.168.100.120</span><br><span class="line">	do</span><br><span class="line">		echo &quot;========zookeeper $host start========&quot;</span><br><span class="line">		ssh $host &quot;/opt/zookeeper/zookeeper-3.5.7/bin/zkServer.sh start&quot;</span><br><span class="line">	done</span><br><span class="line">&#125;</span><br><span class="line">;;</span><br><span class="line">&quot;status&quot;)&#123;</span><br><span class="line">	for host in 192.168.100.100 192.168.100.110 192.168.100.120</span><br><span class="line">	do</span><br><span class="line">		echo &quot;========zookeeper $host status========&quot;</span><br><span class="line">		ssh $host &quot;/opt/zookeeper/zookeeper-3.5.7/bin/zkServer.sh status&quot;</span><br><span class="line">	done</span><br><span class="line">&#125;</span><br><span class="line">;;</span><br><span class="line">&quot;stop&quot;)&#123;</span><br><span class="line">	for host in 192.168.100.100 192.168.100.110 192.168.100.120</span><br><span class="line">	do</span><br><span class="line">		echo &quot;========zookeeper $host stop========&quot;</span><br><span class="line">		ssh $host &quot;/opt/zookeeper/zookeeper-3.5.7/bin/zkServer.sh stop&quot;</span><br><span class="line">	done</span><br><span class="line">&#125;</span><br><span class="line">;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>






















      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/12/OperatingSystem/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MineTing">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/12/OperatingSystem/" class="post-title-link" itemprop="url">操作系统</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-12 00:00:00" itemprop="dateCreated datePublished" datetime="2023-03-12T00:00:00+08:00">2023-03-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-22 16:28:57" itemprop="dateModified" datetime="2023-03-22T16:28:57+08:00">2023-03-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <div align="center"><font size="70"><b>操作系统</b></font></div>

<h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/11/SpringSecurity/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MineTing">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/11/SpringSecurity/" class="post-title-link" itemprop="url">SpringSecurity</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-11 00:00:00" itemprop="dateCreated datePublished" datetime="2023-03-11T00:00:00+08:00">2023-03-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-22 16:28:25" itemprop="dateModified" datetime="2023-03-22T16:28:25+08:00">2023-03-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <div align="center"><font size="70"><b>SpringSecurity</b></font></div>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/10/Shiro/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MineTing">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/10/Shiro/" class="post-title-link" itemprop="url">Shiro</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-10 00:00:00" itemprop="dateCreated datePublished" datetime="2023-03-10T00:00:00+08:00">2023-03-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-22 16:27:40" itemprop="dateModified" datetime="2023-03-22T16:27:40+08:00">2023-03-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <div align="center"><font size="70"><b>Shiro</b></font></div>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/09/SSM/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MineTing">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/09/SSM/" class="post-title-link" itemprop="url">SSM</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-09 00:00:00" itemprop="dateCreated datePublished" datetime="2023-03-09T00:00:00+08:00">2023-03-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-22 16:27:15" itemprop="dateModified" datetime="2023-03-22T16:27:15+08:00">2023-03-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <div align="center"><font size="70"><b>SSM</b></font></div>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/08/SpringMVC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MineTing">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/08/SpringMVC/" class="post-title-link" itemprop="url">SpringMVC</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-08 00:00:00" itemprop="dateCreated datePublished" datetime="2023-03-08T00:00:00+08:00">2023-03-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-22 16:26:17" itemprop="dateModified" datetime="2023-03-22T16:26:17+08:00">2023-03-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <div align="center"><font size="70"><b>SpringMVC</b></font></div>

<blockquote>
<p>【refer】</p>
<p>官网地址：</p>
<p>参考文档：</p>
</blockquote>
<h1 id="SpringMVC-概述"><a href="#SpringMVC-概述" class="headerlink" title="SpringMVC 概述"></a>SpringMVC 概述</h1><p>​		SpringMVC 是一种基于 Java 的实现 MVC 设计模型的请求驱动类型的轻量级 Web 框架，是 Spring 的一个子项目，通过一套注解，让一个简单的 Java 类成为处理请求的控制器，而无须实现任何接口。同时支持 Restful 编程风格的请求。采用了松散耦合可插拔组件结构，比其他 MVC 框架更具扩展性和灵活性。</p>
<h2 id="IDEA-创建-Maven-Web-项目"><a href="#IDEA-创建-Maven-Web-项目" class="headerlink" title="IDEA 创建 Maven Web 项目"></a>IDEA 创建 Maven Web 项目</h2><h3 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h3><p><img src="/2023/03/08/SpringMVC/JavaWeb%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84.png" alt="JavaWeb项目结构.png"></p>
<h3 id="方式一"><a href="#方式一" class="headerlink" title="方式一"></a>方式一</h3><ol>
<li><p>右键新建 Maven 工程，修改 <packaging>war</packaging></p>
</li>
<li><p>在 src&#x2F;main 目录下创建 webapp 目录</p>
</li>
<li><p>打开 Project Structure，创建 web.xml 并修改路径为 src\main\webapp\WEB-INF\web.xml</p>
<p><img src="/2023/03/08/SpringMVC/JavaWeb%E5%88%9B%E5%BB%BA%E6%96%B9%E5%BC%8F%E4%B8%80.png" alt="JavaWeb创建方式一.png"></p>
</li>
</ol>
<h3 id="方式二"><a href="#方式二" class="headerlink" title="方式二"></a>方式二</h3><ol>
<li><p>右键新建 Maven 工程，修改 <packaging>war</packaging></p>
</li>
<li><p>项目鼠标右键，添加框架支持：Add  FrameWork  Support…，选择 Web Application</p>
<p><img src="/2023/03/08/SpringMVC/JavaWeb%E5%88%9B%E5%BB%BA%E6%96%B9%E5%BC%8F%E4%BA%8C.png" alt="JavaWeb创建方式二.png"></p>
</li>
</ol>
<h3 id="方式三"><a href="#方式三" class="headerlink" title="方式三"></a>方式三</h3><ol>
<li><p>使用 Maven Archetype 创建 Web 项目</p>
</li>
<li><p>选择 war ：maven-archetype-webapp 创建方式</p>
<p><img src="/2023/03/08/SpringMVC/JavaWeb%E5%88%9B%E5%BB%BA%E6%96%B9%E5%BC%8F%E4%B8%89.png" alt="JavaWeb创建方式三.png"></p>
</li>
<li><p>替换掉旧版本的 web.xml 配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">&quot;4.0&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="Spring-与-Web-的集成"><a href="#Spring-与-Web-的集成" class="headerlink" title="Spring 与 Web 的集成"></a>Spring 与 Web 的集成</h2><p>​		在 Web 项目中，可以使用 <strong>ServletContextListener</strong> 监听Web应用的启动，在Web应用启动时，就加载Spring的配置文件，创建应用上下文对象ApplicationContext，将其存储到servletContext域中，这样就可以在任意位置从域中获得应用上下文ApplicationContext对象了，而不用每次new ClasspathXmlApplicationContext()等方式读取配置创建容器。</p>
<p>​		Spring 提供了一个监听器 <strong>ContextLoaderListener</strong> 就是对上述<strong>功能的封装</strong>，<strong>该监听器内部加载</strong> Spring配置文</p>
<p>件，创建应用上下文对象，并存储到 ServletContext 域中，提供了一个客户端工具 <strong>WebApplicationContextUtils</strong> 供使用者获得应用上下文对象。</p>
<p>使用示例：测试获取容器对象</p>
<p>创建 Web 项目：<code>SpringMVC-JSP</code></p>
<p>引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--SpringMVC--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--Servlet--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--JSP--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet.jsp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet.jsp-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--JSTL--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jstl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--JSP标签库--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>taglibs<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>standard<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>web.xml 配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">&quot;4.0&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--配置Servlet上下文参数--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">            该参数为 SpringMVC 中 ContextLoaderListener 的父类 ContextLoader的属性</span></span><br><span class="line"><span class="comment">            用于获取配置文件位置</span></span><br><span class="line"><span class="comment">        --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:applicationContext.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">        监听器配置：</span></span><br><span class="line"><span class="comment">        public class ContextLoaderListener extends ContextLoader implements ServletContextListener</span></span><br><span class="line"><span class="comment">        ContextLoaderListener可以在Web应用启动时，加载Spring的配置文件，创建应用上下文对象ApplicationContext，将其存储到最大的域servletContext域中，这样就可以在任意位置从域中获得应用上下文ApplicationContext对象。</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>applicationContext.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;beanObject&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.example.springmvc.bean.BeanObject&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.springmvc.bean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BeanObject</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Servlet：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试获取上下文对象</span></span><br><span class="line"><span class="comment"> * WebApplicationContextUtils.getWebApplicationContext(this.getServletContext());</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@WebServlet(&quot;/applicationContext&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebApplicationContextServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> &#123;</span><br><span class="line">        <span class="type">WebApplicationContext</span> <span class="variable">webApplicationContext</span> <span class="operator">=</span></span><br><span class="line">            WebApplicationContextUtils.getWebApplicationContext(<span class="built_in">this</span>.getServletContext());</span><br><span class="line">        String[] beanDefinitionNames = webApplicationContext.getBeanDefinitionNames();</span><br><span class="line">        System.out.println(Arrays.toString(beanDefinitionNames));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<p>访问：<a target="_blank" rel="noopener" href="http://localhost:8080/SpringMVC/applicationContext">http://localhost:8080/SpringMVC/applicationContext</a></p>
<p>控制台打印：[BeanObject]</p>
<h2 id="SpringMVC-入门示例"><a href="#SpringMVC-入门示例" class="headerlink" title="SpringMVC 入门示例"></a>SpringMVC 入门示例</h2><p>创建 Web 项目：<code>SpringMVC-JSP</code></p>
<p>引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--SpringMVC--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--Servlet--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--JSP--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet.jsp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet.jsp-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--JSTL--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jstl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--JSP标签库--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>taglibs<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>standard<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>web.xml 配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">&quot;4.0&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--配置Servlet上下文参数--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">            该参数为 SpringMVC 中 ContextLoaderListener 的父类 ContextLoader的属性</span></span><br><span class="line"><span class="comment">            用于获取配置文件位置</span></span><br><span class="line"><span class="comment">        --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:applicationContext.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">        监听器配置：</span></span><br><span class="line"><span class="comment">        public class ContextLoaderListener extends ContextLoader implements ServletContextListener</span></span><br><span class="line"><span class="comment">        ContextLoaderListener可以在Web应用启动时，加载Spring的配置文件，创建应用上下文对象ApplicationContext，将其存储到最大的域servletContext域中，这样就可以在任意位置从域中获得应用上下文ApplicationContext对象。</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--配置核心Servlet--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>dispatcherServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">            配置DispatcherServlet初始化参数:</span></span><br><span class="line"><span class="comment">            可以不指定配置文件位置，默认的配置文件为：/WEB-INF/&lt;servlet-name&gt;-servlet.xml</span></span><br><span class="line"><span class="comment">        --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 使用classpath:表示从类路径查找配置文件，例如maven工程中的src/main/resources --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:springmvc.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--服务器初次启动时便加载该Servlet--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">        当SpringMVC前端控制器对静态资源进行拦截后，在通过处理器映射器找不到相关处理器的情况下，</span></span><br><span class="line"><span class="comment">        该请求会被tomcat中web.xml中默认配置的Servlet拦截（只拦截WEB-INF下的内容）。</span></span><br><span class="line"><span class="comment">        tomcat的默认servlet是tomcat的 web.xml中的default,org.apache.catalina.servlets.DefaultServlet</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>dispatcherServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">            /a/b        精确匹配：路径必须一致</span></span><br><span class="line"><span class="comment">            /*          路径匹配：如 /a/*</span></span><br><span class="line"><span class="comment">            *.action    扩展名匹配：如 put.action</span></span><br><span class="line"><span class="comment">            注意：</span></span><br><span class="line"><span class="comment">                1. 扩展名和路径匹配不能同时应用，如/a/*.jsp</span></span><br><span class="line"><span class="comment">                2. dispatcherServlet 不会拦截 .jsp 文件，.jsp 文件本身是一个Servlet</span></span><br><span class="line"><span class="comment">                    路径匹配成功后应该访问的逻辑，不应该作为路径被拦截</span></span><br><span class="line"><span class="comment">                3. /* 表示拦截所有请求，也包括 .jsp</span></span><br><span class="line"><span class="comment">        --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>springmvc.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">        一般建议 springmvc.xml 只拦截 @Controller注解标识的组件</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.example.springmvc&quot;</span> <span class="attr">use-default-filters</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">context:include-filter</span> <span class="attr">type</span>=<span class="string">&quot;annotation&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;org.springframework.stereotype.Controller&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">        配置 jsp 的视图解析器，视图解析器有多种</span></span><br><span class="line"><span class="comment">        注意前缀前后的斜线 / 不可省略</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;prefix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/WEB-INF/pages/&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;suffix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;.jsp&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>webapp&#x2F;index.jsp</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Hello SpringMVC<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;hello&quot;</span>&gt;</span>Hello SpringMVC!<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>webapp&#x2F;WEB-INF&#x2F;pages&#x2F;success.jsp</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Success<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Success!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：访问 <a target="_blank" rel="noopener" href="http://localhost:8080/SpringMVC/">http://localhost:8080/SpringMVC/</a></p>
<h1 id="SpringMVC-执行流程"><a href="#SpringMVC-执行流程" class="headerlink" title="SpringMVC 执行流程"></a>SpringMVC 执行流程</h1><h2 id="总体流程"><a href="#总体流程" class="headerlink" title="总体流程"></a>总体流程</h2><h2 id="默认组件"><a href="#默认组件" class="headerlink" title="默认组件"></a>默认组件</h2><h2 id="代码调试"><a href="#代码调试" class="headerlink" title="代码调试"></a>代码调试</h2><h2 id="组件说明"><a href="#组件说明" class="headerlink" title="组件说明"></a>组件说明</h2><h1 id="SpringMVC-请求"><a href="#SpringMVC-请求" class="headerlink" title="SpringMVC 请求"></a>SpringMVC 请求</h1><h2 id="常用注解"><a href="#常用注解" class="headerlink" title="常用注解"></a>常用注解</h2><h3 id="RequestMapping"><a href="#RequestMapping" class="headerlink" title="@RequestMapping"></a>@RequestMapping</h3><p>负责请求路径与相应的 handler 方法的映射关系</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Mapping</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> RequestMapping &#123;</span><br><span class="line"></span><br><span class="line">   String <span class="title function_">name</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@AliasFor(&quot;path&quot;)</span></span><br><span class="line">   String[] value() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@AliasFor(&quot;value&quot;)</span></span><br><span class="line">   String[] path() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">   RequestMethod[] method() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">   String[] params() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">   String[] headers() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">   String[] consumes() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">   String[] produces() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>请求方式：RequestMethod</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">RequestMethod</span> &#123;</span><br><span class="line">   GET, HEAD, POST, PUT, PATCH, DELETE, OPTIONS, TRACE</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用示例：</p>
<p>index.jsp</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Hello SpringMVC<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;hello&quot;</span>&gt;</span>Hello SpringMVC!<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;testRequestParamAndHeaders?name=tom&amp;age=10&quot;</span>&gt;</span></span><br><span class="line">        Test RequestParamAndHeaders</span><br><span class="line">    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;testRequestMethod&quot;</span> <span class="attr">method</span>=<span class="string">&quot;get&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Test RequestMethod&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>RequestTestController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RequestTestController</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SUCCESS</span> <span class="operator">=</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@RequestMapping</span> 可以使用在方法和类上，方法上的 / 可以省略</span></span><br><span class="line"><span class="comment">     * 请求路径相对于 WEB 应用的根目录</span></span><br><span class="line"><span class="comment">     * 请求方式不一致：405</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/testRequestMethod&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">testRequestMethod</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/testRequestParamAndHeaders&quot;,</span></span><br><span class="line"><span class="meta">            params = &#123;&quot;name=tom&quot;, &quot;age=10&quot;&#125;</span></span><br><span class="line"><span class="meta">            /*,headers = &#123;&quot;Accept-Language=zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;&#125;*/)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">testRequestParamAndHeaders</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="RequestParam"><a href="#RequestParam" class="headerlink" title="@RequestParam"></a>@RequestParam</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@RequestParam</span>: 绑定请求参数</span></span><br><span class="line"><span class="comment"> * 注意 Integer 与 int 的区别</span></span><br><span class="line"><span class="comment"> *      属性required=false可以指定参数为非必需</span></span><br><span class="line"><span class="comment"> *      此时不能再使用int age接收数据，否则报错：</span></span><br><span class="line"><span class="comment"> *           java.lang.IllegalStateException: Optional int parameter &#x27;age&#x27; is not present</span></span><br><span class="line"><span class="comment"> *           but cannot be translated into a null value</span></span><br><span class="line"><span class="comment"> *        应该使用 Integer age接收数据,如果不传递参数则赋值为 null</span></span><br><span class="line"><span class="comment"> *        或者指定 defaultValue 作为缺省值。</span></span><br><span class="line"><span class="comment"> *     HTTP Status 400 - Required int parameter &#x27;age&#x27; is not present</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/testRequestParam&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testRequestParam</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(&quot;name&quot;)</span> String name,</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value = &quot;age&quot;, required = false, defaultValue = &quot;0&quot;)</span> Integer age</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;name: &quot;</span> + name + <span class="string">&quot;, age: &quot;</span> + age);</span><br><span class="line">    <span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="RequestHeader"><a href="#RequestHeader" class="headerlink" title="@RequestHeader"></a>@RequestHeader</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试请求头<span class="doctag">@RequestHeader</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/testRequestHeader&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testRequestHeader</span><span class="params">(<span class="meta">@RequestHeader(&quot;Accept-Language&quot;)</span> String header)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CookieValue"><a href="#CookieValue" class="headerlink" title="@CookieValue"></a>@CookieValue</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试<span class="doctag">@CookieValue</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/testCookieValue&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testCookieValue</span><span class="params">(<span class="meta">@CookieValue(&quot;JSESSIONID&quot;)</span>String cookieValue)</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;testCookieValue: &quot;</span>+cookieValue);</span><br><span class="line">    <span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ServletAPI-作为参数"><a href="#ServletAPI-作为参数" class="headerlink" title="ServletAPI 作为参数"></a>ServletAPI 作为参数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 可以使用Servlet原生的API作为目标方法的参数</span></span><br><span class="line"><span class="comment"> * 具体支持以下类型：</span></span><br><span class="line"><span class="comment"> *      HttpServletRequest</span></span><br><span class="line"><span class="comment"> *      HttpServletResponse</span></span><br><span class="line"><span class="comment"> *      HttpSession</span></span><br><span class="line"><span class="comment"> *      java.security.Principal</span></span><br><span class="line"><span class="comment"> *      Locale</span></span><br><span class="line"><span class="comment"> *      InputStream</span></span><br><span class="line"><span class="comment"> *      OutputStream</span></span><br><span class="line"><span class="comment"> *      Reader</span></span><br><span class="line"><span class="comment"> *      Writer</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/testServletAPI&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testServletAPI</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;testServletAPI: request = &quot;</span>+request+<span class="string">&quot;, response = &quot;</span>+response);</span><br><span class="line">    <span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="POJO-作为参数"><a href="#POJO-作为参数" class="headerlink" title="POJO 作为参数"></a>POJO 作为参数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Address address;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Address</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String province;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String city;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;testSubmitPojo&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    Username: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;MineTing&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">    Email: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;email&quot;</span> <span class="attr">name</span>=<span class="string">&quot;email&quot;</span> <span class="attr">value</span>=<span class="string">&quot;MineTing@example.com&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">    Age: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;age&quot;</span> <span class="attr">value</span>=<span class="string">&quot;18&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">    Address.province: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;address.province&quot;</span> <span class="attr">value</span>=<span class="string">&quot;ShanBei&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">    Address.city: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;address.city&quot;</span> <span class="attr">value</span>=<span class="string">&quot;YuLin&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;testSubmitPojo&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试 POJO 对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/testSubmitPojo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testSubmitPojo</span><span class="params">(User user)</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;user: &quot;</span>+user);</span><br><span class="line">    <span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Ant-路径风格"><a href="#Ant-路径风格" class="headerlink" title="Ant 路径风格"></a>Ant 路径风格</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;testAntPath/create/bean**&quot;</span>&gt;</span>Test Ant 风格路径<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@RequestMapping</span></span></span><br><span class="line"><span class="comment"> * 映射请求支持 Ant 风格的资源地址</span></span><br><span class="line"><span class="comment"> *      ?：匹配文件名中的一个字符,几个问号就是几个字符</span></span><br><span class="line"><span class="comment"> *      *：匹配文件名中的任意字符以及任意路径</span></span><br><span class="line"><span class="comment"> *　    **：** 匹配多层路径</span></span><br><span class="line"><span class="comment"> * 注意：实际路径中不能包含？</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 示例：</span></span><br><span class="line"><span class="comment">//  /user/*/createUser: 匹配/user/aaa/createUser、/user/bbb/createUser 等 URL</span></span><br><span class="line"><span class="comment">// /user/**/createUser: 匹配/user/createUser、/user/aaa/bbb/createUser 等 URL</span></span><br><span class="line"><span class="comment">// /user/createUser??: 匹配/user/createUseraa、/user/createUserbb 等 URL</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;testAntPath/**/bean??&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testAntPath</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Restful-路径风格"><a href="#Restful-路径风格" class="headerlink" title="Restful 路径风格"></a>Restful 路径风格</h3><h4 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h4><p>​		Restful是一种软件架构风格、设计风格，而不是标准，只是提供了一组设计原则和约束条件。主要用于客户端和服务</p>
<p>器交互类的软件，基于这个风格设计的软件可以更简洁，更有层次，更易于实现缓存机制等。</p>
<p>​		Restful风格的请求是使用 “url + 请求方式” 表示一次请求目的的，HTTP 协议里面四个表示操作方式的动词如下：</p>
<ul>
<li>GET：用于获取资源</li>
<li>POST：用于新建资源</li>
<li>PUT：用于更新资源</li>
<li>DELETE：用于删除资源</li>
</ul>
<p>例如：</p>
<ul>
<li>&#x2F;user&#x2F;1 GET ： 得到 id &#x3D; 1 的 user</li>
<li>&#x2F;user&#x2F;1 DELETE： 删除 id &#x3D; 1 的 user</li>
<li>&#x2F;user&#x2F;1 PUT： 更新 id &#x3D; 1 的 user</li>
<li>&#x2F;user POST： 新增 user</li>
</ul>
<p>上述 url 地址 &#x2F;user&#x2F;1 中的 1 就是要获得的请求参数，在SpringMVC 中可以使用 @PathVariable 占位符进行参数绑定。</p>
<p>SpringMVC 中实现 Restful 风格，需要配置 HiddenHttpMethodFilter 过滤器对请求方式进行转换。</p>
<h4 id="HiddenHttpMethodFilter"><a href="#HiddenHttpMethodFilter" class="headerlink" title="HiddenHttpMethodFilter"></a>HiddenHttpMethodFilter</h4><p>​		SpringMVC 提供了一个 Filter，HiddenHttpMethodFilter，对请求方式进行拦截，浏览器发送请求只支持 GET 和 </p>
<p>POST 请求方式。为了实现 Restful 风格，需要对请求方式进行装换。</p>
<h4 id="使用步骤"><a href="#使用步骤" class="headerlink" title="使用步骤"></a>使用步骤</h4><ul>
<li>在 web.xml 中配置 HiddenHttpMethodFilter 拦截器。</li>
<li>在发送请求时可以额外的传递参数  _method，指定请求的方式，并结合 @RequestMapping 注解以及 @PathVariable 注解实现。</li>
</ul>
<p>web.xml 配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    配置的基本顺序不能乱</span></span><br><span class="line"><span class="comment">    The content of element type &quot;web-app&quot; must match &quot;</span></span><br><span class="line"><span class="comment">        (icon?,display-name?,description?,distributable?,</span></span><br><span class="line"><span class="comment">        context-param*,</span></span><br><span class="line"><span class="comment">        filter*,filter-mapping*,</span></span><br><span class="line"><span class="comment">        listener*,</span></span><br><span class="line"><span class="comment">        servlet*,servlet-mapping*</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--配置请求方式拦截器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>hiddenHttpMethodFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.HiddenHttpMethodFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>hiddenHttpMethodFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">        /  只会拦截静态资源，不会拦截 .jsp等</span></span><br><span class="line"><span class="comment">        /* 会拦截所有的资源</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>













<h1 id="SpringMVC-响应"><a href="#SpringMVC-响应" class="headerlink" title="SpringMVC 响应"></a>SpringMVC 响应</h1><h1 id="SpringMVC-数据处理"><a href="#SpringMVC-数据处理" class="headerlink" title="SpringMVC 数据处理"></a>SpringMVC 数据处理</h1><h2 id="自定义转换器"><a href="#自定义转换器" class="headerlink" title="自定义转换器"></a>自定义转换器</h2><h2 id="数据格式化"><a href="#数据格式化" class="headerlink" title="数据格式化"></a>数据格式化</h2><h2 id="数据校验"><a href="#数据校验" class="headerlink" title="数据校验"></a>数据校验</h2><h2 id="JSON"><a href="#JSON" class="headerlink" title="JSON"></a>JSON</h2><h2 id="国际化"><a href="#国际化" class="headerlink" title="国际化"></a>国际化</h2><h2 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h2><p>Spring MVC 为文件上传提供了直接的支持，这种支持是通过即插即用的 MultipartResolver 实现的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MultipartResolver</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isMultipart</span><span class="params">(HttpServletRequest var1)</span>;</span><br><span class="line"></span><br><span class="line">    MultipartHttpServletRequest <span class="title function_">resolveMultipart</span><span class="params">(HttpServletRequest var1)</span> <span class="keyword">throws</span> MultipartException;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">cleanupMultipart</span><span class="params">(MultipartHttpServletRequest var1)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Spring 用 Jakarta Commons FileUpload 技术实现了一个 MultipartResolver 实现类：CommonsMultipartResovler </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.fileupload.FileItem;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.fileupload.FileItemFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.fileupload.FileUpload;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.fileupload.FileUploadBase;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.fileupload.FileUploadException;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.fileupload.servlet.ServletFileUpload;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsMultipartResolver</span> <span class="keyword">extends</span> <span class="title class_">CommonsFileUploadSupport</span></span><br><span class="line">		<span class="keyword">implements</span> <span class="title class_">MultipartResolver</span>, ServletContextAware &#123;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Spring MVC 上下文中默认没有装配 MultipartResovler，因此默认情况下不能处理文件的上传工作，如果想使用 Spring 的文件上传功能，需现在上下文中配置 MultipartResolver。</p>
<ul>
<li><p>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--文件上传--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-fileupload<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-fileupload<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>配置 MultipartResolver：</p>
<p>defaultEncoding : 必须和用户 JSP 的 pageEncoding 属性 一致，以便正确解析表单的内容。</p>
<p>为了让 CommonsMultipartResovler 正确工作，必须先将 Jakarta Commons FileUpload 及 Jakarta Commons io 的类包添加到类路径下。</p>
<p>需要引入 fileupload 依赖（会自动引入commons-io）：</p>
<h2 id="文件下载"><a href="#文件下载" class="headerlink" title="文件下载"></a>文件下载</h2><h1 id="SpringMVC-拦截器"><a href="#SpringMVC-拦截器" class="headerlink" title="SpringMVC 拦截器"></a>SpringMVC 拦截器</h1><h2 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h2><p>​		Spring MVC 可以使用拦截器对请求进行拦截处理，用户可以自定义拦截器来实现特定的功能，自定义的拦截器必须实现 HandlerInterceptor 接口。</p>
<p>HandlerInterceptor ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">default</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span></span><br><span class="line">			<span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler,</span></span><br><span class="line"><span class="params">			<span class="meta">@Nullable</span> ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler,</span></span><br><span class="line"><span class="params">			<span class="meta">@Nullable</span> Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>preHandle( )：该方法在获取 HandlerAdapter 之后，业务处理器处理请求之前被调用，对用户的请求进行拦截预处理。如果决定该拦截器对请求进行拦截处理后还要调用其他的拦截器，或者是业务处理器去进行处理，则返回 true；如果决定不需要再调用其他的组件去处理请求，则返回 false。</p>
</li>
<li><p>postHandle( )：该方法在业务处理器处理完请求后，渲染视图之前被调用，可以对请求域中的属性或视图做出修改。</p>
</li>
<li><p>afterCompletion( )：该方法在 DispatcherServlet 处理完请求，渲染完视图后被调用，可以做一些释放资源的操作。</p>
</li>
</ul>
<p>DispatcherServlet .doDispatch( )：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">mappedHandler = getHandler(processedRequest);</span><br><span class="line"><span class="keyword">if</span> (mappedHandler == <span class="literal">null</span>) &#123;</span><br><span class="line">    noHandlerFound(processedRequest, response);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">HandlerAdapter</span> <span class="variable">ha</span> <span class="operator">=</span> getHandlerAdapter(mappedHandler.getHandler());</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">method</span> <span class="operator">=</span> request.getMethod();</span><br><span class="line"><span class="type">boolean</span> <span class="variable">isGet</span> <span class="operator">=</span> <span class="string">&quot;GET&quot;</span>.equals(method);</span><br><span class="line"><span class="keyword">if</span> (isGet || <span class="string">&quot;HEAD&quot;</span>.equals(method)) &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">lastModified</span> <span class="operator">=</span> ha.getLastModified(request, mappedHandler.getHandler());</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">new</span> <span class="title class_">ServletWebRequest</span>(request, response)</span><br><span class="line">        .checkNotModified(lastModified) &amp;&amp; isGet) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//==========prehandle()===========</span></span><br><span class="line"><span class="keyword">if</span> (!mappedHandler.applyPreHandle(processedRequest, response)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</span><br><span class="line"><span class="keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">applyDefaultViewName(processedRequest, mv);</span><br><span class="line"></span><br><span class="line"><span class="comment">//==========Posthandle()===========</span></span><br><span class="line">mappedHandler.applyPostHandle(processedRequest, response, mv);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">    dispatchException = ex;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Throwable err) &#123;</span><br><span class="line">    dispatchException = <span class="keyword">new</span> <span class="title class_">NestedServletException</span>(<span class="string">&quot;Handler dispatch failed&quot;</span>, err);</span><br><span class="line">&#125;</span><br><span class="line">processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">    <span class="comment">//==========AfterCompletion()===========</span></span><br><span class="line">    triggerAfterCompletion(processedRequest, response, mappedHandler, ex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="自定义拦截器"><a href="#自定义拦截器" class="headerlink" title="自定义拦截器"></a>自定义拦截器</h2><p>基本步骤：</p>
<ul>
<li>自定义的拦截器实现 HandlerInterceptor 接口</li>
<li>配置拦截器</li>
</ul>
<p>FirstInterceptor：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义拦截器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FirstInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 该方法在目标方法之前被调用</span></span><br><span class="line"><span class="comment">     * 若返回值为 true, 则继续调用后续的拦截器和目标方法</span></span><br><span class="line"><span class="comment">     * 若返回值为 false, 则不会再调用后续的拦截器和目标方法</span></span><br><span class="line"><span class="comment">     * 可以考虑做权限, 日志, 事务等</span></span><br><span class="line"><span class="comment">     * 注意多个拦截器中一个拦截器返回 false 的情况</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object arg2)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;First Interceptor preHandle()...&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 调用目标方法之后, 但渲染视图之前被调用</span></span><br><span class="line"><span class="comment">     * 可以对请求域中的属性或视图做出修改</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object arg2, ModelAndView modelAndView)</span></span><br><span class="line">            <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;First Interceptor postHandle()...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 渲染视图之后被调用， 释放资源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object arg2, Exception arg3)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;First Interceptor afterCompletion()...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SecondInterceptor：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecondInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object arg2)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Second Interceptor preHandle()...&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object arg2,</span></span><br><span class="line"><span class="params">                           ModelAndView modelAndView)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Second Interceptor postHandle()...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object arg2, Exception</span></span><br><span class="line"><span class="params">            arg3)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Second Interceptor afterCompletion()...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>springmvc.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--拦截器配置--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:interceptors</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 配置自定义拦截器 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;firstInterceptor&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.example.springmvc.interceptor.FirstInterceptor&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 配置拦截器生效或不生效的路径 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:interceptor</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- SecondInterceptor只针对该path生效 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mvc:mapping</span> <span class="attr">path</span>=<span class="string">&quot;/home&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--SecondInterceptor 排除该 path 路径--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&lt;mvc:exclude-mapping path=&quot;/home&quot;/&gt;--&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;com.example.springmvc.interceptor.SecondInterceptor&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mvc:interceptor</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 配置 LocaleChanceInterceptor拦截器 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.web.servlet.i18n.LocaleChangeInterceptor&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mvc:interceptors</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="多个拦截器执行顺序"><a href="#多个拦截器执行顺序" class="headerlink" title="多个拦截器执行顺序"></a>多个拦截器执行顺序</h2><p>多个拦截器的执行顺序和【配置中的前后顺序一致】，如：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:interceptors</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;secondInterceptor&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.example.springmvc.interceptor.SecondInterceptor&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;firstInterceptor&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.example.springmvc.interceptor.FirstInterceptor&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mvc:interceptors</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Second Interceptor preHandle()...</span><br><span class="line">First Interceptor preHandle()...</span><br><span class="line">First Interceptor postHandle()...</span><br><span class="line">Second Interceptor postHandle()...</span><br><span class="line">First Interceptor afterCompletion()...</span><br><span class="line">Second Interceptor afterCompletion()...</span><br></pre></td></tr></table></figure>

<p>对于拦截器配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:interceptors</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;firstInterceptor&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.example.springmvc.interceptor.FirstInterceptor&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;secondInterceptor&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.example.springmvc.interceptor.SecondInterceptor&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mvc:interceptors</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果第二个拦截器 SecondInterceptor 的 prehandle( ) 返回 FALSE，则执行顺序为：</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">First Interceptor preHandle()...</span><br><span class="line">Second Interceptor preHandle()...</span><br><span class="line">First Interceptor afterCompletion()...</span><br></pre></td></tr></table></figure>

<p>源码说明：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">applyPreHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	HandlerInterceptor[] interceptors = getInterceptors();</span><br><span class="line">	<span class="keyword">if</span> (!ObjectUtils.isEmpty(interceptors)) &#123;</span><br><span class="line">           <span class="comment">//===========PreHandle：正向执行拦截器===========</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; interceptors.length; i++) &#123;</span><br><span class="line">			<span class="type">HandlerInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> interceptors[i];</span><br><span class="line">			<span class="keyword">if</span> (!interceptor.preHandle(request, response, <span class="built_in">this</span>.handler)) &#123;</span><br><span class="line">				triggerAfterCompletion(request, response, <span class="literal">null</span>);</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in">this</span>.interceptorIndex = i;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">applyPostHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, <span class="meta">@Nullable</span> ModelAndView mv)</span></span><br><span class="line">		<span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	HandlerInterceptor[] interceptors = getInterceptors();</span><br><span class="line">	<span class="keyword">if</span> (!ObjectUtils.isEmpty(interceptors)) &#123;</span><br><span class="line">           <span class="comment">//===========PostHandle：反向执行===========</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> interceptors.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">			<span class="type">HandlerInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> interceptors[i];</span><br><span class="line">			interceptor.postHandle(request, response, <span class="built_in">this</span>.handler, mv);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">triggerAfterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, <span class="meta">@Nullable</span> Exception ex)</span></span><br><span class="line">      <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">   HandlerInterceptor[] interceptors = getInterceptors();</span><br><span class="line">   <span class="keyword">if</span> (!ObjectUtils.isEmpty(interceptors)) &#123;</span><br><span class="line">       <span class="comment">//===========AfterCompletion：反向执行===========</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="built_in">this</span>.interceptorIndex; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">         <span class="type">HandlerInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> interceptors[i];</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">            interceptor.afterCompletion(request, response, <span class="built_in">this</span>.handler, ex);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">catch</span> (Throwable ex2) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;HandlerInterceptor.afterCompletion threw exception&quot;</span>, ex2);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="SpringMVC-异常"><a href="#SpringMVC-异常" class="headerlink" title="SpringMVC 异常"></a>SpringMVC 异常</h1><h2 id="概述-2"><a href="#概述-2" class="headerlink" title="概述"></a>概述</h2><p>​		Spring MVC 通过 HandlerExceptionResolver 处理程序的异常，包括 Handler 映射、数据绑定以及目标方法执行时发生的异常。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HandlerExceptionResolver</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	ModelAndView <span class="title function_">resolveException</span><span class="params">(</span></span><br><span class="line"><span class="params">			HttpServletRequest request, HttpServletResponse response, <span class="meta">@Nullable</span> Object handler, Exception ex)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​		SpringMVC 提供 HandlerExceptionResolver 的实现类，使用 <a href="mvc:annotation-driven/">mvc:annotation-driven/</a> 配置后，会自动配置以下实现类，这三个实现类负责具体的异常处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.web.servlet.mvc.method.annotation.ExceptionHandlerExceptionResolver</span><br><span class="line">org.springframework.web.servlet.mvc.support.DefaultHandlerExceptionResolver</span><br><span class="line">org.springframework.web.servlet.mvc.annotation.ResponseStatusExceptionResolver</span><br></pre></td></tr></table></figure>

<p>默认处理异常直接在页面返回错误信息：</p>
<p><img src="/2023/03/08/SpringMVC/SpringMVC%E9%BB%98%E8%AE%A4%E5%A4%84%E7%90%86%E5%BC%82%E5%B8%B8.png" alt="SpringMVC默认处理异常.png"></p>
<h2 id="ExceptionHandlerExceptionResolver（常用）"><a href="#ExceptionHandlerExceptionResolver（常用）" class="headerlink" title="ExceptionHandlerExceptionResolver（常用）"></a>ExceptionHandlerExceptionResolver（常用）</h2><ul>
<li><p>该 HandlerExceptionResolver 主要处理 Handler 中用 @ExceptionHandler 注解定义的方法。</p>
</li>
<li><p>@ExceptionHandler 注解定义的方法优先级（优先精确匹配异常）： 例如发生的是 NullPointerException，但是声明的异常有 RuntimeException 和 Exception，此时会抛出NullPointerException异常。</p>
</li>
<li><p>@ExceptionHandler 注解方法，优先使用该 handler 内部的异常处理方法，如果没有再全局查找；即标记了 RuntimeException 的方法。ExceptionHandlerMethodResolver 内部若找不到@ExceptionHandler 注解的话，会找 @ControllerAdvice 中的@ExceptionHandler 注解方法。</p>
</li>
</ul>
<p>使用示例：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<p>在 Controller 内部使用：@ExceptionHandler</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExceptionController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SUCCESS</span> <span class="operator">=</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ERROR</span> <span class="operator">=</span> <span class="string">&quot;error&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/testExceptionHandlerExceptionResolver&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">testExceptionHandlerExceptionResolver</span><span class="params">(<span class="meta">@RequestParam(&quot;num&quot;)</span> Integer num)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;num: &quot;</span> + <span class="number">10</span> / <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1. <span class="doctag">@ExceptionHandler</span> 方法的入参中可以加入 Exception 类型的参数, 该参数即对应发生的异常对象</span></span><br><span class="line"><span class="comment">     * 2. <span class="doctag">@ExceptionHandler</span> 方法的入参中不能传入 Map. 若希望把异常信息传到页面上, 需要使用 ModelAndView 作为返回值</span></span><br><span class="line"><span class="comment">     * 3. <span class="doctag">@ExceptionHandler</span> 方法标记的异常有优先级的问题，即优先按照异常范围精确匹配</span></span><br><span class="line"><span class="comment">     * 4. <span class="doctag">@ControllerAdvice</span>: 如果在当前 Handler 中找不到 <span class="doctag">@ExceptionHandler</span> 方法来出来当前方法出现的异常(如果由父类异常也会直接调用),</span></span><br><span class="line"><span class="comment">     *     则将去 <span class="doctag">@ControllerAdvice</span> 标记的类（全局异常处理）中查找 <span class="doctag">@ExceptionHandler</span> 标记的方法来处理异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  如果使用map存储信息，会报错，应该使用 ModelAndView</span></span><br><span class="line"><span class="comment">     *  java.lang.IllegalStateException:</span></span><br><span class="line"><span class="comment">     *  Could not resolve parameter [1] in public java.lang.String com.exception.springmvc.handler.</span></span><br><span class="line"><span class="comment">     *  RequestDataBindHandler.handlerArithmeticException(</span></span><br><span class="line"><span class="comment">     *  java.lang.Exception,java.util.Map&lt;java.lang.String, java.lang.Object&gt;):</span></span><br><span class="line"><span class="comment">     *  No suitable resolver</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">/*@ExceptionHandler(&#123;ArithmeticException.class&#125;)</span></span><br><span class="line"><span class="comment">    public String handlerArithmeticException(Exception exception, Map&lt;String, Object&gt; map) &#123;</span></span><br><span class="line"><span class="comment">        System.out.println(&quot;exception: &quot; + exception);</span></span><br><span class="line"><span class="comment">        map.put(&quot;exception&quot;, exception);</span></span><br><span class="line"><span class="comment">        return &quot;error&quot;;</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*@ExceptionHandler(&#123;ArithmeticException.class&#125;)</span></span><br><span class="line"><span class="comment">    public ModelAndView handlerArithmeticException(Exception exception) &#123;</span></span><br><span class="line"><span class="comment">        System.out.println(&quot;exception: &quot; + exception);</span></span><br><span class="line"><span class="comment">        ModelAndView modelAndView = new ModelAndView();</span></span><br><span class="line"><span class="comment">        modelAndView.addObject(&quot;exception&quot;, exception);</span></span><br><span class="line"><span class="comment">        modelAndView.setViewName(&quot;error&quot;);</span></span><br><span class="line"><span class="comment">        return modelAndView;</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*@ExceptionHandler(&#123;RuntimeException.class&#125;)</span></span><br><span class="line"><span class="comment">    public ModelAndView handlerRuntimeException(Exception exception) &#123;</span></span><br><span class="line"><span class="comment">        System.out.println(&quot;handlerRuntimeException: &quot; + exception);</span></span><br><span class="line"><span class="comment">        ModelAndView modelAndView = new ModelAndView(&quot;error&quot;);</span></span><br><span class="line"><span class="comment">        modelAndView.addObject(&quot;exception&quot;, exception);</span></span><br><span class="line"><span class="comment">        return modelAndView;</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>全局异常处理：GlobalExceptionHandler</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 全局异常处理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalExceptionHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(&#123;ArithmeticException.class&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">handlerArithmeticException</span><span class="params">(Exception exception)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;exception: &quot;</span> + exception);</span><br><span class="line">        <span class="type">ModelAndView</span> <span class="variable">modelAndView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">        modelAndView.addObject(<span class="string">&quot;exception&quot;</span>, exception);</span><br><span class="line">        <span class="keyword">return</span> modelAndView;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="meta">@ExceptionHandler(&#123;RuntimeException.class&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">handlerRuntimeException</span><span class="params">(Exception exception)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;handlerRuntimeException: &quot;</span> + exception);</span><br><span class="line">        <span class="type">ModelAndView</span> <span class="variable">modelAndView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">        modelAndView.addObject(<span class="string">&quot;exception&quot;</span>, exception);</span><br><span class="line">        <span class="keyword">return</span> modelAndView;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：该类需要被 Spring 容器管理</p>
<p>applicationContext.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;beanObject&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.example.springmvc.bean.BeanObject&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--扫描组件--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.example.springmvc&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">context:exclude-filter</span> <span class="attr">type</span>=<span class="string">&quot;annotation&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;org.springframework.stereotype.Controller&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>error.jsp</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot;</span><br><span class="line">         pageEncoding=&quot;UTF-8&quot;%&gt;</span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Error Page<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Error Page<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Error Page exception: $&#123;requestScope.exception&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Error Page ex: $&#123;requestScope.ex&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="ResponseStatusExceptionResolver（bug）"><a href="#ResponseStatusExceptionResolver（bug）" class="headerlink" title="ResponseStatusExceptionResolver（bug）"></a>ResponseStatusExceptionResolver（bug）</h2><p>该 ExceptionResolver 在异常及异常父类中找到 @ResponseStatus 注解，然后使用这个注解的属性进行处理。定义一个</p>
<p>@ResponseStatus 注解修饰的异常类，若在处理器方法中抛出了自定义的异常：</p>
<p>如果 ExceptionHandlerExceptionResolver 不解析该异常。由于触发的异常带有 @ResponseStatus 注解。因此会被ResponseStatusExceptionResolver 解析到。最后响应 HttpStatus.UNAUTHORIZED 代码给客户端。HttpStatus.UNAUTHORIZED 代表响应码 401，无权限。</p>
<p>关于其他的响应码参考 HttpStatus 枚举类型源码。</p>
<p>使用示例：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;testResponseStatusExceptionResolver?num=10&quot;</span>&gt;</span>Test ResponseStatusExceptionResolver<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>自定义异常：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ResponseStatus(value = HttpStatus.FORBIDDEN, reason = &quot;ParamValueNotMatch&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ParamValueNotMatchException</span> <span class="keyword">extends</span> <span class="title class_">RuntimeException</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">3745252631578061012L</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 标注在方法上，即使方法正常执行，但是会返回错误页面</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">//@ResponseStatus(value = HttpStatus.NOT_FOUND,reason = &quot;test method ParamValueNotMatch&quot;)</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/testResponseStatusExceptionResolver&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testResponseStatusExceptionResolver</span><span class="params">(<span class="type">int</span> num)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;testResponseStatusExceptionResolver...&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(num == <span class="number">10</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ParamValueNotMatchException</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="DefaultHandlerExceptionResolver"><a href="#DefaultHandlerExceptionResolver" class="headerlink" title="DefaultHandlerExceptionResolver"></a>DefaultHandlerExceptionResolver</h2><p>该 ExceptionResolver 对一些特殊的（默认的）异常进行处理，比如：</p>
<ul>
<li>NoSuchRequestHandlingMethodException</li>
<li>HttpRequestMethodNotSupportedException</li>
<li>HttpMediaTypeNotSupportedException</li>
<li>HttpMediaTypeNotAcceptableException</li>
</ul>
<p>使用示例：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;testDefaultHandlerExceptionResolver&quot;</span>&gt;</span>Test DefaultHandlerExceptionResolver<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 默认处理异常的方式，由DefaultHandlerExceptionResolver处理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/testDefaultHandlerExceptionResolver&quot;, method = RequestMethod.POST)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testDefaultHandlerExceptionResolver</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="SimpleMappingExceptionResolver"><a href="#SimpleMappingExceptionResolver" class="headerlink" title="SimpleMappingExceptionResolver"></a>SimpleMappingExceptionResolver</h2><p>​		如果希望对所有异常进行统一处理，可以使用 SimpleMappingExceptionResolver，它将异常类名映射为视图名，即发生异常时使用对应的视图报告异常。</p>
<p>使用示例：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;testSimpleMappingExceptionHandler?i=10&quot;</span>&gt;</span>Test SimpleMappingExceptionHandler<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置 SimpleMappingExceptionResolver</p>
<p>异常的属性默认采用 exception，可以指定 exceptionAttribute 修改 </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--配置SimpleMappingExceptionResolver--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.web.servlet.handler.SimpleMappingExceptionResolver&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">        public class SimpleMappingExceptionResolver extends AbstractHandlerExceptionResolver &#123;</span></span><br><span class="line"><span class="comment">         public static final String DEFAULT_EXCEPTION_ATTRIBUTE = &quot;exception&quot;;</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;exceptionAttribute&quot;</span> <span class="attr">value</span>=<span class="string">&quot;ex&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;exceptionMappings&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">props</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;java.lang.ArrayIndexOutOfBoundsException&quot;</span>&gt;</span>error<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">props</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>controller：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 定义视图映射页面</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/testSimpleMappingExceptionHandler&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testSimpleMappingExceptionHandler</span><span class="params">(Integer num)</span> &#123;</span><br><span class="line">    String[] str = <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">10</span>];</span><br><span class="line">    System.out.println(<span class="string">&quot;str[i] = &quot;</span> + str[num]);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="SpringMVC-视图"><a href="#SpringMVC-视图" class="headerlink" title="SpringMVC 视图"></a>SpringMVC 视图</h1><h1 id="SpringMVC-日志"><a href="#SpringMVC-日志" class="headerlink" title="SpringMVC 日志"></a>SpringMVC 日志</h1><h2 id="日志概述"><a href="#日志概述" class="headerlink" title="日志概述"></a>日志概述</h2><h2 id="日志替换"><a href="#日志替换" class="headerlink" title="日志替换"></a>日志替换</h2><h2 id="统一日志"><a href="#统一日志" class="headerlink" title="统一日志"></a>统一日志</h2><h2 id="日志配置文件说明"><a href="#日志配置文件说明" class="headerlink" title="日志配置文件说明"></a>日志配置文件说明</h2><h1 id="SSM-整合"><a href="#SSM-整合" class="headerlink" title="SSM 整合"></a>SSM 整合</h1><h2 id="Restful-CRUD"><a href="#Restful-CRUD" class="headerlink" title="Restful  CRUD"></a>Restful  CRUD</h2><h2 id="JSP-形式"><a href="#JSP-形式" class="headerlink" title="JSP 形式"></a>JSP 形式</h2><h2 id="前后端分离"><a href="#前后端分离" class="headerlink" title="前后端分离"></a>前后端分离</h2><h3 id="统一结果"><a href="#统一结果" class="headerlink" title="统一结果"></a>统一结果</h3><h3 id="统一异常"><a href="#统一异常" class="headerlink" title="统一异常"></a>统一异常</h3><h3 id="统一日志-1"><a href="#统一日志-1" class="headerlink" title="统一日志"></a>统一日志</h3><h1 id="Over"><a href="#Over" class="headerlink" title="Over!"></a>Over!</h1>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Fei</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">42</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Fei</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
