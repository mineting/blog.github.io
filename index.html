<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="MineTing">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="MineTing">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Fei">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>MineTing</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">MineTing</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/04/10/Mendix/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MineTing">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/04/10/Mendix/" class="post-title-link" itemprop="url">Mendix</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-04-10 00:00:00 / Modified: 22:07:20" itemprop="dateCreated datePublished" datetime="2023-04-10T00:00:00+08:00">2023-04-10</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <div align="center"><font size="70"><b>Mendix</b></font></div>

<blockquote>
<p>ã€èµ„æ–™æ–‡æ¡£ã€‘</p>
<p>å®˜ç½‘æ–‡æ¡£ï¼š</p>
<p>ä¸­æ–‡ç¤¾åŒºï¼š</p>
</blockquote>
<h1 id="Make-it-w-x2F-Mendixï¼ˆç”Ÿæ€ï¼‰"><a href="#Make-it-w-x2F-Mendixï¼ˆç”Ÿæ€ï¼‰" class="headerlink" title="Make it w&#x2F;Mendixï¼ˆç”Ÿæ€ï¼‰"></a>Make it w&#x2F;Mendixï¼ˆç”Ÿæ€ï¼‰</h1><h2 id="äº†è§£-Mendix-ç”Ÿæ€"><a href="#äº†è§£-Mendix-ç”Ÿæ€" class="headerlink" title="äº†è§£ Mendix ç”Ÿæ€"></a>äº†è§£ Mendix ç”Ÿæ€</h2><p><img src="/2023/04/10/Mendix/Mendix%E7%94%9F%E6%80%81.png" alt="Mendixç”Ÿæ€.png"></p>
<ul>
<li>Online Project Managementï¼šMendix æä¾›äº†åº”ç”¨çš„å¼€å‘ã€éƒ¨ç½²å¹³å°ç­‰</li>
<li>MarketPlaceï¼šMendix æ˜¯æ¨¡å—åŒ–çš„åº”ç”¨å¼€å‘</li>
<li>Atlas UIï¼šä¸€å¥—UI ç•Œé¢ï¼Œæ‹–æ‹½ç­‰ç•Œé¢é£æ ¼</li>
<li>Mendix Studioï¼šIDEï¼Œç½‘é¡µæµè§ˆå™¨ä¸­ç¼–è¾‘çš„ IDE</li>
<li>Mendix Studio Proï¼šæ›´ä¸“ä¸šçš„ IDEï¼Œæœ¬åœ°ä½¿ç”¨</li>
<li>Data Hubï¼šäº‘ç«¯æ•°æ®æ‰˜ç®¡æœåŠ¡</li>
<li>Supportï¼šå®¢æˆ·æ”¯æŒ</li>
<li>Communityï¼šæ´»è·ƒçš„ç¤¾åŒºï¼Œè´¡çŒ®ç»„ä»¶æ¨¡å—ã€æŠ€æœ¯æ”¯æŒç­‰</li>
<li>Academyï¼šå­¦é™¢å­¦ä¹ </li>
</ul>
<h1 id="Make-it-togetherï¼ˆæ•æ·å¼€å‘ï¼‰"><a href="#Make-it-togetherï¼ˆæ•æ·å¼€å‘ï¼‰" class="headerlink" title="Make it togetherï¼ˆæ•æ·å¼€å‘ï¼‰"></a>Make it togetherï¼ˆæ•æ·å¼€å‘ï¼‰</h1><h1 id="Make-it-w-x2F-Mendix-Studioï¼ˆIDEï¼‰"><a href="#Make-it-w-x2F-Mendix-Studioï¼ˆIDEï¼‰" class="headerlink" title="Make it w&#x2F;Mendix Studioï¼ˆIDEï¼‰"></a>Make it w&#x2F;Mendix Studioï¼ˆIDEï¼‰</h1><h1 id="Make-it-Dynamicï¼ˆå¤„ç†åŠ¨æ€æ•°æ®ï¼‰"><a href="#Make-it-Dynamicï¼ˆå¤„ç†åŠ¨æ€æ•°æ®ï¼‰" class="headerlink" title="Make it Dynamicï¼ˆå¤„ç†åŠ¨æ€æ•°æ®ï¼‰"></a>Make it Dynamicï¼ˆå¤„ç†åŠ¨æ€æ•°æ®ï¼‰</h1><h1 id="Make-it-Automatedï¼ˆå¤„ç†ä¸šåŠ¡é€»è¾‘ï¼‰"><a href="#Make-it-Automatedï¼ˆå¤„ç†ä¸šåŠ¡é€»è¾‘ï¼‰" class="headerlink" title="Make it Automatedï¼ˆå¤„ç†ä¸šåŠ¡é€»è¾‘ï¼‰"></a>Make it Automatedï¼ˆå¤„ç†ä¸šåŠ¡é€»è¾‘ï¼‰</h1><h1 id="Make-it-w-x2F-Mendix-Studio-Proï¼ˆIDEï¼‰"><a href="#Make-it-w-x2F-Mendix-Studio-Proï¼ˆIDEï¼‰" class="headerlink" title="Make it w&#x2F;Mendix Studio Proï¼ˆIDEï¼‰"></a>Make it w&#x2F;Mendix Studio Proï¼ˆIDEï¼‰</h1><h1 id="Make-it-Smartï¼ˆæ·±å…¥ï¼‰"><a href="#Make-it-Smartï¼ˆæ·±å…¥ï¼‰" class="headerlink" title="Make it Smartï¼ˆæ·±å…¥ï¼‰"></a>Make it Smartï¼ˆæ·±å…¥ï¼‰</h1><h1 id="Make-it-Valid-amp-Consistentï¼ˆç‰¹æ€§ï¼‰"><a href="#Make-it-Valid-amp-Consistentï¼ˆç‰¹æ€§ï¼‰" class="headerlink" title="Make it Valid &amp; Consistentï¼ˆç‰¹æ€§ï¼‰"></a>Make it Valid &amp; Consistentï¼ˆç‰¹æ€§ï¼‰</h1><h1 id="Make-it-Secureï¼ˆå®‰å…¨æ€§ï¼‰"><a href="#Make-it-Secureï¼ˆå®‰å…¨æ€§ï¼‰" class="headerlink" title="Make it Secureï¼ˆå®‰å…¨æ€§ï¼‰"></a>Make it Secureï¼ˆå®‰å…¨æ€§ï¼‰</h1><h1 id="Make-it-Mobileï¼ˆç§»åŠ¨ç«¯ï¼‰"><a href="#Make-it-Mobileï¼ˆç§»åŠ¨ç«¯ï¼‰" class="headerlink" title="Make it Mobileï¼ˆç§»åŠ¨ç«¯ï¼‰"></a>Make it Mobileï¼ˆç§»åŠ¨ç«¯ï¼‰</h1><h1 id="Go-Make-itï¼ˆStartï¼‰"><a href="#Go-Make-itï¼ˆStartï¼‰" class="headerlink" title="Go Make itï¼ˆStartï¼‰"></a>Go Make itï¼ˆStartï¼‰</h1><h1 id="å¼€å‘è€…è®¤è¯æµç¨‹"><a href="#å¼€å‘è€…è®¤è¯æµç¨‹" class="headerlink" title="å¼€å‘è€…è®¤è¯æµç¨‹"></a>å¼€å‘è€…è®¤è¯æµç¨‹</h1>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/04/08/Node/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MineTing">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/04/08/Node/" class="post-title-link" itemprop="url">Node</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-04-08 00:00:00 / Modified: 20:03:17" itemprop="dateCreated datePublished" datetime="2023-04-08T00:00:00+08:00">2023-04-08</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <div align="center"><font size="70"><b>Node</b></font></div>

<h1 id="Node-ç®€ä»‹"><a href="#Node-ç®€ä»‹" class="headerlink" title="Node ç®€ä»‹"></a>Node ç®€ä»‹</h1><ul>
<li><p>Node.js æ˜¯ä¸€ä¸ªèƒ½å¤Ÿåœ¨æœåŠ¡å™¨ç«¯è¿è¡ŒJavaScript çš„å¼€æ”¾æºä»£ç ã€ è·¨å¹³å° JavaScript è¿è¡Œç¯å¢ƒã€‚Node æ˜¯å¯¹ ES æ ‡å‡†ä¸€ä¸ªå®ç°ï¼ŒNode ä¹Ÿæ˜¯ä¸€ä¸ª JS å¼•æ“</p>
</li>
<li><p>Node å¤§éƒ¨åˆ†åŸºæœ¬æ¨¡å—éƒ½ç”¨ JavaScript ç¼–å†™ã€‚åœ¨ Node å‡ºç°ä¹‹å‰ï¼Œ JS é€šå¸¸ä½œä¸ºå®¢æˆ·ç«¯ç¨‹åºè®¾è®¡è¯­è¨€ä½¿ç”¨ï¼Œä»¥JS å†™å‡ºçš„ç¨‹åºå¸¸åœ¨ç”¨æˆ·çš„æµè§ˆå™¨ä¸Šè¿è¡Œ</p>
</li>
<li><p>Node é‡‡ç”¨ Google å¼€å‘çš„ V8 å¼•æ“è¿è¡Œ JS ä»£ç ï¼Œä½¿ç”¨äº‹ä»¶é©±åŠ¨ã€ éé˜»å¡å’Œå¼‚æ­¥I&#x2F;Oæ¨¡å‹ç­‰æŠ€æœ¯æ¥æé«˜æ€§èƒ½ï¼Œå¯ä¼˜åŒ–åº”ç”¨ç¨‹åºçš„ä¼ è¾“é‡å’Œè§„æ¨¡</p>
</li>
<li><p>é€šè¿‡ Node å¯ä»¥ä½¿ JS ä»£ç åœ¨æœåŠ¡å™¨ç«¯æ‰§è¡Œï¼Œä½†æ˜¯ä¸åŒ…å« DOM å’Œ BOMï¼ŒNode ä¸­å¯ä»¥ä½¿ç”¨æ‰€æœ‰çš„å†…å»ºå¯¹è±¡ï¼Œä½†æ˜¯å¯ä»¥ä½¿ç”¨ consoleï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å®šæ—¶å™¨ï¼ˆsetTimeout() setInterval()ï¼‰</p>
</li>
</ul>
<p>Node ç¼–å†™æœåŠ¡å™¨éƒ½æ˜¯å•çº¿ç¨‹çš„æœåŠ¡å™¨</p>
<h2 id="Node-å†å²"><a href="#Node-å†å²" class="headerlink" title="Node å†å²"></a>Node å†å²</h2><table>
<thead>
<tr>
<th>æ—¶é—´</th>
<th>äº‹ä»¶</th>
</tr>
</thead>
<tbody><tr>
<td>2009å¹´</td>
<td>ç‘å®‰Â·è¾¾å°”ï¼ˆRyan Dahlï¼‰åœ¨GitHubä¸Šå‘å¸ƒnodeçš„æœ€åˆç‰ˆæœ¬</td>
</tr>
<tr>
<td>2010å¹´1æœˆ</td>
<td>Nodeçš„åŒ…ç®¡ç†å™¨npmè¯ç”Ÿ</td>
</tr>
<tr>
<td>2010å¹´åº•</td>
<td>Joyentå…¬å¸èµåŠ©Nodeçš„å¼€å‘ï¼Œç‘å®‰Â·è¾¾å°”åŠ å…¥æ——ä¸‹ï¼Œå…¨èŒè´Ÿè´£Node</td>
</tr>
<tr>
<td>2011å¹´7æœˆ</td>
<td>Nodeåœ¨å¾®è½¯çš„å¸®åŠ©ä¸‹å‘å¸ƒäº†windowsç‰ˆæœ¬</td>
</tr>
<tr>
<td>2011å¹´11æœˆ</td>
<td>Nodeè¶…è¶ŠRuby on Railsï¼Œç§°ä¸ºGitHubä¸Šå…³æ³¨åº¦æœ€é«˜çš„é¡¹ç›®</td>
</tr>
<tr>
<td>2012å¹´1æœˆ</td>
<td>ç‘å®‰Â·è¾¾å°”ç¦»å¼€Nodeé¡¹ç›®</td>
</tr>
<tr>
<td>2014å¹´12æœˆ</td>
<td>Fedor Indutnyåœ¨2014å¹´12æœˆåˆ¶ä½œäº†åˆ†æ”¯ç‰ˆæœ¬ï¼Œå¹¶èµ·åâ€œio.jsâ€</td>
</tr>
<tr>
<td>2015å¹´åˆ</td>
<td>Node.jsåŸºé‡‘ä¼šæˆç«‹ï¼ˆIBMã€Intelã€å¾®è½¯ã€Joyentï¼‰</td>
</tr>
<tr>
<td>2015å¹´9æœˆ</td>
<td>Node.jså’Œio.jsåˆå¹¶ï¼ŒNode 4.0å‘å¸ƒ</td>
</tr>
<tr>
<td>2016å¹´</td>
<td>Node 6.0å‘å¸ƒ</td>
</tr>
<tr>
<td>2017å¹´</td>
<td>Node 8.0å‘å¸ƒ</td>
</tr>
</tbody></table>
<h2 id="Node-ä½¿ç”¨åœºæ™¯"><a href="#Node-ä½¿ç”¨åœºæ™¯" class="headerlink" title="Node ä½¿ç”¨åœºæ™¯"></a>Node ä½¿ç”¨åœºæ™¯</h2><ul>
<li>Web æœåŠ¡ APIï¼Œæ¯”å¦‚ REST</li>
<li>Web æœåŠ¡ APIï¼Œæ¯”å¦‚ REST</li>
<li>åç«¯çš„ Web æœåŠ¡ï¼Œä¾‹å¦‚è·¨åŸŸã€æœåŠ¡å™¨ç«¯çš„è¯·æ±‚</li>
<li>åŸºäº Web çš„åº”ç”¨</li>
<li>å¤šå®¢æˆ·ç«¯çš„é€šä¿¡ï¼Œå¦‚å³æ—¶é€šä¿¡</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/27/Docker/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MineTing">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/27/Docker/" class="post-title-link" itemprop="url">Docker</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-27 00:00:00" itemprop="dateCreated datePublished" datetime="2023-03-27T00:00:00+08:00">2023-03-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-04-02 09:34:54" itemprop="dateModified" datetime="2023-04-02T09:34:54+08:00">2023-04-02</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <div align="center"><font size="70"><b>Docker</b></font></div>

<hr>
<blockquote>
<p>ã€Referã€‘</p>
<p>å®˜ç½‘åœ°å€ï¼š<a target="_blank" rel="noopener" href="http://www.docker.com/">http://www.docker.com</a></p>
<p>Docker Hubï¼š<a target="_blank" rel="noopener" href="https://hub.docker.com/">https://hub.docker.com/</a></p>
<p>å‚è€ƒæ•™ç¨‹ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/">https://docs.docker.com/</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/get-started/overview/">https://docs.docker.com/get-started/overview/</a></p>
<p>è¯´æ˜ï¼šæ­¤å¤„ä»¥ <code>CentOS7.9</code> ä¸ºä¾‹ã€‚</p>
</blockquote>
<h1 id="Docker-æ¦‚è¿°"><a href="#Docker-æ¦‚è¿°" class="headerlink" title="Docker æ¦‚è¿°"></a>Docker æ¦‚è¿°</h1><h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>Docker is written in the <a target="_blank" rel="noopener" href="https://golang.org/">Go programming language</a> and takes advantage of several features of the Linux kernel to deliver its functionality. Docker uses a technology called <code>namespaces</code> to provide the isolated workspace called the <em>container</em>. When you run a container, Docker creates a set of <em>namespaces</em> for that container.</p>
<p>Docker ä½¿ç”¨ Go è¯­è¨€å¼€å‘ï¼Œä¸»è¦ç›®æ ‡æ˜¯ <code>&quot;Buildï¼ŒShip and Run Any App,  Anywhere&quot;</code>ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡å¯¹åº”ç”¨ç»„ä»¶çš„å°è£…ã€åˆ†å‘ã€éƒ¨ç½²ã€è¿è¡Œç­‰ç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†ï¼Œä½¿ç”¨æˆ·çš„ APP åŠå…¶è¿è¡Œç¯å¢ƒèƒ½å¤Ÿåšåˆ° â€œä¸€æ¬¡é•œåƒï¼Œå¤„å¤„è¿è¡Œâ€ã€‚</p>
<p><strong>è§£å†³äº†è¿è¡Œç¯å¢ƒå’Œé…ç½®é—®é¢˜çš„è½¯ä»¶å®¹å™¨ï¼Œæ–¹ä¾¿åšæŒç»­é›†æˆå¹¶æœ‰åŠ©äºæ•´ä½“å‘å¸ƒçš„å®¹å™¨è™šæ‹ŸåŒ–æŠ€æœ¯ã€‚</strong></p>
<h2 id="ä½œç”¨"><a href="#ä½œç”¨" class="headerlink" title="ä½œç”¨"></a>ä½œç”¨</h2><blockquote>
<ul>
<li><p>æ›´å¿«é€Ÿçš„åº”ç”¨äº¤ä»˜å’Œéƒ¨ç½²</p>
<p>åº”ç”¨å¼€å‘å®Œæˆååªéœ€è¦æä¾› DockerFile é•œåƒæ–‡ä»¶ï¼Œè€Œä¸éœ€è¦æä¾›å¤§é‡çš„é…ç½®è¯´æ˜ä»¥åŠå®‰è£…ç¨‹åºã€‚</p>
</li>
<li><p>æ›´ä¾¿æ·çš„å‡çº§å’Œæ‰©ç¼©å®¹</p>
<p>å½“ç°æœ‰çš„å®¹å™¨ä¸è¶³ä»¥æ”¯æ’‘ä¸šåŠ¡å¤„ç†æ—¶ï¼Œå¯é€šè¿‡é•œåƒè¿è¡Œæ–°çš„å®¹å™¨è¿›è¡Œå¿«é€Ÿæ‰©å®¹ã€‚</p>
</li>
<li><p>æ›´ç®€å•çš„ç³»ç»Ÿè¿ç»´</p>
<p>åº”ç”¨å®¹å™¨åŒ–è¿è¡Œåï¼Œç”Ÿäº§ç¯å¢ƒè¿è¡Œçš„åº”ç”¨å¯ä¸å¼€å‘ã€æµ‹è¯•ç¯å¢ƒçš„åº”ç”¨é«˜åº¦ä¸€è‡´ï¼Œå½“å‡ºç°ç¨‹åºå¼‚å¸¸æ—¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æµ‹è¯•ç¯å¢ƒçš„ç›¸åŒå®¹å™¨è¿›è¡Œå¿«é€Ÿå®šä½å’Œä¿®å¤ã€‚</p>
</li>
<li><p>æ›´é«˜æ•ˆçš„è®¡ç®—èµ„æºåˆ©ç”¨</p>
<p>Docker æ˜¯å†…æ ¸çº§è™šæ‹ŸåŒ–ï¼Œå…¶ä¸åƒä¼ ç»Ÿçš„è™šæ‹ŸåŒ–æŠ€æœ¯ä¸€æ ·éœ€è¦é¢å¤–çš„ Hypervisor æ”¯æŒï¼Œæ‰€ä»¥åœ¨ä¸€å°ç‰©ç†æœºä¸Šå¯ä»¥è¿è¡Œå¾ˆå¤šä¸ªå®¹å™¨å®ä¾‹ï¼Œå¯å¤§å¤§æå‡ç‰©ç†æœåŠ¡å™¨çš„ CPU å’Œå†…å­˜çš„åˆ©ç”¨ç‡ã€‚</p>
</li>
</ul>
</blockquote>
<blockquote>
<h2 id="What-can-I-use-Docker-for"><a href="#What-can-I-use-Docker-for" class="headerlink" title="What can I use Docker for?"></a>What can I use Docker for?</h2><p><strong>Fast, consistent delivery of your applications</strong></p>
<p>Docker streamlines the development lifecycle by allowing developers to work in standardized environments using local containers which provide your applications and services. Containers are great for continuous integration and continuous delivery (CI&#x2F;CD) workflows.</p>
<p>Consider the following example scenario:</p>
<ul>
<li>Your developers write code locally and share their work with their colleagues using Docker containers.</li>
<li>They use Docker to push their applications into a test environment and execute automated and manual tests.</li>
<li>When developers find bugs, they can fix them in the development environment and redeploy them to the test environment for testing and validation.</li>
<li>When testing is complete, getting the fix to the customer is as simple as pushing the updated image to the production environment.</li>
</ul>
<p><strong>Responsive deployment and scaling</strong></p>
<p>Dockerâ€™s container-based platform allows for highly portable workloads. Docker containers can run on a developerâ€™s local laptop, on physical or virtual machines in a data center, on cloud providers, or in a mixture of environments.</p>
<p>Dockerâ€™s portability and lightweight nature also make it easy to dynamically manage workloads, scaling up or tearing down applications and services as business needs dictate, in near real time.</p>
<p><strong>Running more workloads on the same hardware</strong></p>
<p>Docker is lightweight and fast. It provides a viable, cost-effective alternative to hypervisor-based virtual machines, so you can use more of your server capacity to achieve your business goals. Docker is perfect for high density environments and for small and medium deployments where you need to do more with fewer resources.</p>
</blockquote>
<h2 id="åŸºæœ¬ç»„æˆ"><a href="#åŸºæœ¬ç»„æˆ" class="headerlink" title="åŸºæœ¬ç»„æˆ"></a>åŸºæœ¬ç»„æˆ</h2><ul>
<li>é•œåƒ Imagesï¼šDocker å®¹å™¨æ¨¡æ¿ï¼Œç”¨äºè¿è¡Œå®¹å™¨ã€‚</li>
<li>å®¹å™¨ Containersï¼šå®¹å™¨ç±»ä¼¼äºä¸€ä¸ªè™šæ‹ŸåŒ–çš„è¿è¡Œç¯å¢ƒï¼Œæ˜¯ç”±é•œåƒåˆ›å»ºçš„è¿è¡Œå®ä¾‹ï¼Œå¯ä»¥ç‹¬ç«‹è¿è¡Œçš„ä¸€ä¸ªæˆ–ä¸€ç»„åº”ç”¨ï¼Œå®¹å™¨ä¸ºé•œåƒæä¾›äº†ä¸€ä¸ªæ ‡å‡†çš„å’Œéš”ç¦»çš„è¿è¡Œç¯å¢ƒï¼Œå®ƒå¯ä»¥è¢«å¯åŠ¨ã€å¼€å§‹ã€åœæ­¢ã€åˆ é™¤ï¼Œæ¯ä¸ªå®¹å™¨éƒ½æ˜¯ç›¸äº’éš”ç¦»çš„ã€ä¿è¯å®‰å…¨çš„å¹³å°ã€‚</li>
<li>ä»“åº“ Repositoryï¼šå­˜æ”¾é•œåƒæ–‡ä»¶ï¼ŒDocker å…¬å¸æä¾›çš„å®˜æ–¹ registry è¢«ç§°ä¸º Docker Hubï¼Œåˆ†ä¸ºå…¬å¼€ä»“åº“å’Œç§æœ‰ä»“åº“ã€‚</li>
</ul>
<p>Docker å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªå®¹å™¨è¿è¡Œè½½ä½“ï¼Œå¦‚æŠŠåº”ç”¨ç¨‹åºå’Œé…ç½®ä¾èµ–æ‰“åŒ…å¥½å½¢æˆä¸€ä¸ªå¯äº¤ä»˜çš„è¿è¡Œç¯å¢ƒï¼Œè¿™ä¸ªæ‰“åŒ…å¥½çš„è¿è¡Œç¯å¢ƒå°±æ˜¯ image é•œåƒæ–‡ä»¶ï¼Œå®¹å™¨å°±æ˜¯ä¸€ä¸ªé•œåƒå®ä¾‹ã€‚</p>
<p><strong>Docker åŸºç¡€æ¶æ„è¯´æ˜ï¼š</strong></p>
<p>â€‹		Docker ä½¿ç”¨å®¢æˆ·ç«¯-æœåŠ¡å™¨æ¶æ„ã€‚Docker å®¢æˆ·ç«¯ä¸ Docker å®ˆæŠ¤è¿›ç¨‹ï¼Œå®ƒè´Ÿè´£æ„å»ºã€è¿è¡Œå’Œåˆ†å‘æ‚¨çš„ Docker å®¹å™¨ã€‚</p>
<p>Docker å®¢æˆ·ç«¯å’Œå®ˆæŠ¤ç¨‹åºå¯ä»¥åœ¨åŒä¸€ç³»ç»Ÿä¸Šè¿è¡Œï¼Œä¹Ÿå¯ä»¥å°† Docker å®¢æˆ·ç«¯è¿æ¥åˆ°è¿œç¨‹ Docker å®ˆæŠ¤è¿›ç¨‹ã€‚</p>
<p>Docker å®¢æˆ·ç«¯å’Œå®ˆæŠ¤ç¨‹åºä½¿ç”¨ REST API é€šè¿‡ UNIX è¿›è¡Œé€šä¿¡å¥—æ¥å­—æˆ–ç½‘ç»œæ¥å£ã€‚</p>
<p>å¦ä¸€ä¸ª Docker å®¢æˆ·ç«¯æ˜¯ Docker Composeï¼Œ è¿™ä½¿æ‚¨å¯ä»¥å¤„ç†ç”±ä¸€ç»„å®¹å™¨ç»„æˆçš„åº”ç”¨ç¨‹åºã€‚</p>
<blockquote>
<h2 id="Docker-architectureğŸ”—"><a href="#Docker-architectureğŸ”—" class="headerlink" title="Docker architectureğŸ”—"></a>Docker architecture<a target="_blank" rel="noopener" href="https://docs.docker.com/get-started/overview/#docker-architecture">ğŸ”—</a></h2><p>Docker uses a client-server architecture. The Docker <em>client</em> talks to the Docker <em>daemon</em>, which does the heavy lifting of building, running, and distributing your Docker containers. The Docker client and daemon <em>can</em> run on the same system, or you can connect a Docker client to a remote Docker daemon. The Docker client and daemon communicate using a REST API, over UNIX sockets or a network interface. Another Docker client is Docker Compose, that lets you work with applications consisting of a set of containers.</p>
</blockquote>
<p><img src="/2023/03/27/Docker/DockerArchitecture.png" alt="DockerArchitecture"></p>
<h2 id="å®¹å™¨ä¸è™šæ‹Ÿæœºçš„å¯¹æ¯”"><a href="#å®¹å™¨ä¸è™šæ‹Ÿæœºçš„å¯¹æ¯”" class="headerlink" title="å®¹å™¨ä¸è™šæ‹Ÿæœºçš„å¯¹æ¯”"></a>å®¹å™¨ä¸è™šæ‹Ÿæœºçš„å¯¹æ¯”</h2><p><strong>ä¼ ç»Ÿè™šæ‹ŸæœºæŠ€æœ¯</strong></p>
<p>Virtual Machineï¼Œä¼ ç»Ÿè™šæ‹ŸæœºæŠ€æœ¯æ˜¯åŸºäºå®‰è£…åœ¨ä¸»æ“ä½œç³»ç»Ÿä¸Šçš„è™šæ‹Ÿæœºç®¡ç†ç³»ç»Ÿï¼Œç”±è¯¥ç³»ç»Ÿåˆ›å»ºå‡ºè™šæ‹Ÿæœºï¼Œè™šæ‹Ÿæœºå¯¹äºç³»ç»Ÿæ¥è¯´ä»…ä»…æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œè™šæ‹Ÿå‡ºå„ç§ç¡¬ä»¶ï¼Œä¹‹åå†è¯¥è™šæ‹Ÿæœºä¸Šå®‰è£…æ“ä½œç³»ç»Ÿï¼Œæœ€ååœ¨æ‰æ“ä½œç³»ç»Ÿä¸Šå®‰è£…åº”ç”¨ç¨‹åºã€‚</p>
<p>ç¼ºç‚¹ï¼šèµ„æºå ç”¨å¤šï¼Œå¯åŠ¨é€Ÿåº¦æ…¢ã€‚</p>
<p><strong>å®¹å™¨åŒ–è™šæ‹ŸæŠ€æœ¯</strong></p>
<p>ç”±äºå‰é¢è™šæ‹Ÿæœºå­˜åœ¨æŸäº›ç¼ºç‚¹ï¼ŒLinuxå‘å±•å‡ºäº†å¦ä¸€ç§è™šæ‹ŸåŒ–æŠ€æœ¯ï¼šLXCï¼ˆLinux Containersï¼ŒLinuxå®¹å™¨ ï¼‰</p>
<p>Linuxå®¹å™¨æ˜¯ä¸ç³»ç»Ÿå…¶ä»–éƒ¨åˆ†éš”ç¦»å¼€çš„ä¸€ç³»åˆ—è¿›ç¨‹ï¼Œä»å¦ä¸€ä¸ªé•œåƒè¿è¡Œï¼Œå¹¶ç”±è¯¥é•œåƒæä¾›æ”¯æŒè¿›ç¨‹æ‰€éœ€çš„å…¨éƒ¨æ–‡ä»¶ã€‚å®¹å™¨æä¾›çš„é•œåƒåŒ…å«äº†åº”ç”¨çš„æ‰€æœ‰ä¾èµ–é¡¹ï¼Œå› è€Œåœ¨ä»å¼€å‘åˆ°æµ‹è¯•å†åˆ°ç”Ÿäº§çš„æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œå®ƒéƒ½å…·æœ‰å¯ç§»æ¤æ€§å’Œä¸€è‡´æ€§ã€‚</p>
<p>Linux å®¹å™¨ä¸æ˜¯æ¨¡æ‹Ÿä¸€ä¸ªå®Œæ•´çš„æ“ä½œç³»ç»Ÿè€Œæ˜¯å¯¹è¿›ç¨‹è¿›è¡Œéš”ç¦»ã€‚æœ‰äº†å®¹å™¨ï¼Œå°±å¯ä»¥å°†è½¯ä»¶è¿è¡Œæ‰€éœ€çš„æ‰€æœ‰èµ„æºæ‰“åŒ…åˆ°ä¸€ä¸ªéš”ç¦»çš„å®¹å™¨ä¸­ã€‚<strong>å®¹å™¨ä¸è™šæ‹Ÿæœºä¸åŒï¼Œä¸éœ€è¦æ†ç»‘ä¸€æ•´å¥—æ“ä½œç³»ç»Ÿï¼Œåªéœ€è¦è½¯ä»¶å·¥ä½œæ‰€éœ€çš„åº“èµ„æºå’Œè®¾ç½®ã€‚ç³»ç»Ÿå› æ­¤è€Œå˜å¾—é«˜æ•ˆè½»é‡å¹¶ä¿è¯éƒ¨ç½²åœ¨ä»»ä½•ç¯å¢ƒä¸­çš„è½¯ä»¶éƒ½èƒ½å§‹ç»ˆå¦‚ä¸€åœ°è¿è¡Œã€‚</strong></p>
<p>Docker å®¹å™¨æ˜¯åœ¨æ“ä½œç³»ç»Ÿä¸Šå®ç°è™šæ‹ŸåŒ–ï¼Œç›´æ¥å¤ç”¨æœ¬åœ°çš„æ“ä½œç³»ç»Ÿï¼Œè€Œä¼ ç»Ÿè™šæ‹Ÿæœºæ˜¯åœ¨ç¡¬ä»¶å±‚é¢å®ç°è™šæ‹ŸåŒ–ï¼Œå› æ­¤å®¹å™¨å¯åŠ¨é€Ÿåº¦å¿«ï¼Œå ç”¨ä½“ç§¯å°ã€‚</p>
<p><strong>å¯¹æ¯”æ€»ç»“</strong></p>
<p>ä¼ ç»Ÿè™šæ‹ŸæœºæŠ€æœ¯æ˜¯è™šæ‹Ÿå‡ºä¸€å¥—ç¡¬ä»¶åï¼Œåœ¨å…¶ä¸Šè¿è¡Œä¸€ä¸ªå®Œæ•´æ“ä½œç³»ç»Ÿï¼Œåœ¨è¯¥ç³»ç»Ÿä¸Šå†è¿è¡Œæ‰€éœ€åº”ç”¨è¿›ç¨‹ï¼›<br>å®¹å™¨å†…çš„åº”ç”¨è¿›ç¨‹ç›´æ¥è¿è¡Œäºå®¿ä¸»çš„å†…æ ¸ï¼Œå®¹å™¨å†…æ²¡æœ‰è‡ªå·±çš„å†…æ ¸ä¸”ä¹Ÿæ²¡æœ‰è¿›è¡Œç¡¬ä»¶è™šæ‹Ÿã€‚å› æ­¤å®¹å™¨è¦æ¯”ä¼ ç»Ÿè™šæ‹Ÿæœºæ›´ä¸ºè½»ä¾¿ã€‚</p>
<p>æ¯ä¸ªå®¹å™¨ä¹‹é—´äº’ç›¸éš”ç¦»ï¼Œæ¯ä¸ªå®¹å™¨æœ‰è‡ªå·±çš„æ–‡ä»¶ç³»ç»Ÿ ï¼Œå®¹å™¨ä¹‹é—´è¿›ç¨‹ä¸ä¼šç›¸äº’å½±å“ï¼Œèƒ½åŒºåˆ†è®¡ç®—èµ„æºã€‚</p>
<ul>
<li>dockeræœ‰ç€æ¯”è™šæ‹Ÿæœºæ›´å°‘çš„æŠ½è±¡å±‚<br>ç”±äº docker ä¸éœ€è¦ Hypervisor ï¼ˆè™šæ‹Ÿæœºï¼‰å®ç°ç¡¬ä»¶èµ„æºè™šæ‹ŸåŒ–,è¿è¡Œåœ¨ docker å®¹å™¨ä¸Šçš„ç¨‹åºç›´æ¥ä½¿ç”¨çš„éƒ½æ˜¯å®é™…ç‰©ç†æœºçš„ç¡¬ä»¶èµ„æºã€‚å› æ­¤åœ¨ CPUã€å†…å­˜åˆ©ç”¨ç‡ä¸Š docker å°†ä¼šåœ¨æ•ˆç‡ä¸Šæœ‰æ˜æ˜¾ä¼˜åŠ¿ã€‚</li>
<li>docker åˆ©ç”¨çš„æ˜¯å®¿ä¸»æœºçš„å†…æ ¸,è€Œä¸éœ€è¦åŠ è½½æ“ä½œç³»ç»ŸOSå†…æ ¸<br>å½“æ–°å»ºä¸€ä¸ªå®¹å™¨æ—¶ï¼Œdockerä¸éœ€è¦å’Œè™šæ‹Ÿæœºä¸€æ ·é‡æ–°åŠ è½½ä¸€ä¸ªæ“ä½œç³»ç»Ÿå†…æ ¸ã€‚è¿›è€Œé¿å…å¼•å¯»ã€åŠ è½½æ“ä½œç³»ç»Ÿå†…æ ¸è¿”å›ç­‰æ¯”è¾ƒè´¹æ—¶è´¹èµ„æºçš„è¿‡ç¨‹ï¼Œå½“æ–°å»ºä¸€ä¸ªè™šæ‹Ÿæœºæ—¶ï¼Œè™šæ‹Ÿæœºè½¯ä»¶éœ€è¦åŠ è½½OSï¼Œè¿”å›æ–°å»ºè¿‡ç¨‹æ˜¯åˆ†é’Ÿçº§åˆ«çš„ã€‚è€Œdockerç”±äºç›´æ¥åˆ©ç”¨å®¿ä¸»æœºçš„æ“ä½œç³»ç»Ÿï¼Œåˆ™çœç•¥äº†è¿”å›è¿‡ç¨‹ï¼Œå› æ­¤æ–°å»ºä¸€ä¸ª docker å®¹å™¨åªéœ€è¦å‡ ç§’é’Ÿã€‚</li>
</ul>
<h1 id="Docker-å®‰è£…"><a href="#Docker-å®‰è£…" class="headerlink" title="Docker å®‰è£…"></a>Docker å®‰è£…</h1><h2 id="å‰ææ¡ä»¶"><a href="#å‰ææ¡ä»¶" class="headerlink" title="å‰ææ¡ä»¶"></a>å‰ææ¡ä»¶</h2><p>ã€Referã€‘<a target="_blank" rel="noopener" href="https://docs.docker.com/engine/install/centos/">https://docs.docker.com/engine/install/centos/</a></p>
<p><strong>æ¡ä»¶ï¼š64ä½ç³»ç»Ÿã€Linuxç³»ç»Ÿå†…æ ¸ç‰ˆæœ¬ä¸º 3.8ä»¥ä¸Šã€‚</strong></p>
<p>æŸ¥çœ‹å†…æ ¸ï¼š</p>
<ol>
<li>uname ã€å†…æ ¸ç‰ˆæœ¬å·ã€ç¡¬ä»¶æ¶æ„ã€ä¸»æœºåç§°å’Œæ“ä½œç³»ç»Ÿç±»å‹ã€‘</li>
<li>cat  &#x2F;etc&#x2F;redhat-release</li>
</ol>
<h2 id="å®‰è£…æ–¹å¼"><a href="#å®‰è£…æ–¹å¼" class="headerlink" title="å®‰è£…æ–¹å¼"></a>å®‰è£…æ–¹å¼</h2><p><strong>æ­¤å¤„ä½¿ç”¨ YUM å®‰è£…</strong></p>
<h2 id="Installation-methods"><a href="#Installation-methods" class="headerlink" title="Installation methods"></a>Installation methods</h2><p>You can install Docker Engine in different ways, depending on your needs:</p>
<ul>
<li>You can <a target="_blank" rel="noopener" href="https://docs.docker.com/engine/install/centos/#install-using-the-repository">set up Dockerâ€™s repositories</a> and install from them, for ease of installation and upgrade tasks. This is the recommended approach.</li>
<li>You can download the RPM package and <a target="_blank" rel="noopener" href="https://docs.docker.com/engine/install/centos/#install-from-a-package">install it manually</a> and manage upgrades completely manually. This is useful in situations such as installing Docker on air-gapped systems with no access to the internet.</li>
<li>In testing and development environments, you can use automated <a target="_blank" rel="noopener" href="https://docs.docker.com/engine/install/centos/#install-using-the-convenience-script">convenience scripts</a> to install Docker.</li>
</ul>
<h3 id="Install-using-the-repository"><a href="#Install-using-the-repository" class="headerlink" title="Install using the repository"></a>Install using the repository</h3><p>Before you install Docker Engine for the first time on a new host machine, you need to set up the Docker repository. Afterward, you can install and update Docker from the repository.</p>
<h2 id="å®‰è£…è¯´æ˜"><a href="#å®‰è£…è¯´æ˜" class="headerlink" title="å®‰è£…è¯´æ˜"></a>å®‰è£…è¯´æ˜</h2><h3 id="å¸è½½æ—§ç‰ˆæœ¬"><a href="#å¸è½½æ—§ç‰ˆæœ¬" class="headerlink" title="å¸è½½æ—§ç‰ˆæœ¬"></a>å¸è½½æ—§ç‰ˆæœ¬</h3><p><strong>Uninstall old versions</strong></p>
<p>Older versions of Docker went by the names of <code>docker</code> or <code>docker-engine</code>. Uninstall any such older versions before attempting to install a new version, along with associated dependencies:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ sudo yum remove docker \</span><br><span class="line">                  docker-client \</span><br><span class="line">                  docker-client-latest \</span><br><span class="line">                  docker-common \</span><br><span class="line">                  docker-latest \</span><br><span class="line">                  docker-latest-logrotate \</span><br><span class="line">                  docker-logrotate \</span><br><span class="line">                  docker-engine</span><br></pre></td></tr></table></figure>

<p>Itâ€™s OK if <code>yum</code> reports that none of these packages are installed.</p>
<p>Images, containers, volumes, and networks stored in <code>/var/lib/docker/</code> arenâ€™t automatically removed when you uninstall Docker.</p>
<p><strong>é•œåƒï¼Œå®¹å™¨ï¼Œæ•°æ®å·ï¼Œå’Œç½‘ç»œå­˜å‚¨åœ¨  <code>/var/lib/docker/</code> å¸è½½æ—¶ä¸ä¼šè‡ªåŠ¨ç§»é™¤ã€‚</strong></p>
<p>å¸è½½å¹¶åˆ é™¤ docker ç›¸å…³æ–‡ä»¶ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop docker </span><br><span class="line">yum remove docker-ce docker-ce-cli containerd.io</span><br><span class="line">rm -rf /var/lib/docker</span><br><span class="line">rm -rf /var/lib/containerd</span><br></pre></td></tr></table></figure>

<h3 id="å…·ä½“æ­¥éª¤"><a href="#å…·ä½“æ­¥éª¤" class="headerlink" title="å…·ä½“æ­¥éª¤"></a>å…·ä½“æ­¥éª¤</h3><h3 id="ç¬¬ä¸€æ­¥ï¼šå®‰è£…-gcc"><a href="#ç¬¬ä¸€æ­¥ï¼šå®‰è£…-gcc" class="headerlink" title="ç¬¬ä¸€æ­¥ï¼šå®‰è£… gcc"></a>ç¬¬ä¸€æ­¥ï¼šå®‰è£… gcc</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install gcc</span><br><span class="line">yum -y install gcc-c++</span><br></pre></td></tr></table></figure>

<h3 id="ç¬¬äºŒæ­¥ï¼šé…ç½®-YUM-é•œåƒæº"><a href="#ç¬¬äºŒæ­¥ï¼šé…ç½®-YUM-é•œåƒæº" class="headerlink" title="ç¬¬äºŒæ­¥ï¼šé…ç½® YUM é•œåƒæº"></a>ç¬¬äºŒæ­¥ï¼šé…ç½® YUM é•œåƒæº</h3><p>éœ€è¦å®‰è£…  yum-utilsï¼Œä½¿ç”¨ aliyun é•œåƒæº</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -y yum-utils</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ­¤å¤„ä½¿ç”¨ aliyun é•œåƒ</span></span><br><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure>

<h3 id="ç¬¬ä¸‰æ­¥ï¼šæ›´æ–°-YUM-ç´¢å¼•"><a href="#ç¬¬ä¸‰æ­¥ï¼šæ›´æ–°-YUM-ç´¢å¼•" class="headerlink" title="ç¬¬ä¸‰æ­¥ï¼šæ›´æ–° YUM ç´¢å¼•"></a>ç¬¬ä¸‰æ­¥ï¼šæ›´æ–° YUM ç´¢å¼•</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum makecache fast</span><br></pre></td></tr></table></figure>

<h3 id="ç¬¬å››æ­¥ï¼šå®‰è£…-Docker-CE"><a href="#ç¬¬å››æ­¥ï¼šå®‰è£…-Docker-CE" class="headerlink" title="ç¬¬å››æ­¥ï¼šå®‰è£… Docker CE"></a>ç¬¬å››æ­¥ï¼šå®‰è£… Docker CE</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></table></figure>

<h3 id="ç¬¬äº”æ­¥ï¼šå¯åŠ¨-Docker"><a href="#ç¬¬äº”æ­¥ï¼šå¯åŠ¨-Docker" class="headerlink" title="ç¬¬äº”æ­¥ï¼šå¯åŠ¨ Docker"></a>ç¬¬äº”æ­¥ï¼šå¯åŠ¨ Docker</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start docker</span><br></pre></td></tr></table></figure>

<h3 id="ç¬¬å…­æ­¥ï¼šæµ‹è¯•"><a href="#ç¬¬å…­æ­¥ï¼šæµ‹è¯•" class="headerlink" title="ç¬¬å…­æ­¥ï¼šæµ‹è¯•"></a>ç¬¬å…­æ­¥ï¼šæµ‹è¯•</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker --version</span><br><span class="line">Docker version 23.0.1, build a5ee5b1</span><br></pre></td></tr></table></figure>

<p>æ‹‰å–æµ‹è¯•é•œåƒï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker run hello-world</span><br><span class="line">Unable to find image &#x27;hello-world:latest&#x27; locally</span><br><span class="line">latest: Pulling from library/hello-world</span><br><span class="line">2db29710123e: Pull complete</span><br><span class="line">Digest: sha256:2498fce14358aa50ead0cc6c19990fc6ff866ce72aeb5546e1d59caac3d0d60f</span><br><span class="line">Status: Downloaded newer image for hello-world:latest</span><br><span class="line"></span><br><span class="line">Hello from Docker!</span><br><span class="line">This message shows that your installation appears to be working correctly.</span><br><span class="line"></span><br><span class="line">To generate this message, Docker took the following steps:</span><br><span class="line"> 1. The Docker client contacted the Docker daemon.</span><br><span class="line"> 2. The Docker daemon pulled the &quot;hello-world&quot; image from the Docker Hub.</span><br><span class="line">    (amd64)</span><br><span class="line"> 3. The Docker daemon created a new container from that image which runs the</span><br><span class="line">    executable that produces the output you are currently reading.</span><br><span class="line"> 4. The Docker daemon streamed that output to the Docker client, which sent it</span><br><span class="line">    to your terminal.</span><br><span class="line"></span><br><span class="line">To try something more ambitious, you can run an Ubuntu container with:</span><br><span class="line"><span class="meta prompt_"> $ </span><span class="language-bash">docker run -it ubuntu bash</span></span><br><span class="line"></span><br><span class="line">Share images, automate workflows, and more with a free Docker ID:</span><br><span class="line"> https://hub.docker.com/</span><br><span class="line"></span><br><span class="line">For more examples and ideas, visit:</span><br><span class="line"> https://docs.docker.com/get-started/</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="é…ç½®é•œåƒåŠ é€Ÿ"><a href="#é…ç½®é•œåƒåŠ é€Ÿ" class="headerlink" title="é…ç½®é•œåƒåŠ é€Ÿ"></a>é…ç½®é•œåƒåŠ é€Ÿ</h2><ol>
<li><p>ç™»å½•é˜¿é‡Œäº‘å¼€å‘è€…å¹³å°ï¼š<a target="_blank" rel="noopener" href="https://home.console.aliyun.com/home/dashboard/ProductAndService">https://home.console.aliyun.com/home/dashboard/ProductAndService</a></p>
</li>
<li><p>é€‰æ‹©å®¹å™¨é•œåƒæœåŠ¡ â€“&gt; é•œåƒå·¥å…· â€“&gt; é•œåƒåŠ é€Ÿå™¨</p>
</li>
<li><p>è·å–åŠ é€Ÿå™¨åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://utix41yg.mirror.aliyuncs.com/">https://utix41yg.mirror.aliyuncs.com</a></p>
</li>
<li><p>é…ç½®é•œåƒåœ°å€</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/docker</span><br><span class="line">vim  /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://utix41yg.mirror.aliyuncs.com&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>é‡å¯ Docker</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="Docker-å¸¸ç”¨å‘½ä»¤"><a href="#Docker-å¸¸ç”¨å‘½ä»¤" class="headerlink" title="Docker å¸¸ç”¨å‘½ä»¤"></a>Docker å¸¸ç”¨å‘½ä»¤</h1><h2 id="å¯åŠ¨å¸®åŠ©ç±»"><a href="#å¯åŠ¨å¸®åŠ©ç±»" class="headerlink" title="å¯åŠ¨å¸®åŠ©ç±»"></a>å¯åŠ¨å¸®åŠ©ç±»</h2><ol>
<li><p>å¯åŠ¨ã€é‡å¯ã€åœæ­¢ã€çŠ¶æ€ç­‰</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start/stop/restart/status docker</span><br></pre></td></tr></table></figure>
</li>
<li><p>å¸®åŠ©ä¿¡æ¯ï¼ˆ<strong>ä¸€èˆ¬å¤šä¸ªå•è¯ä½¿ç”¨ä¸¤ä¸ªä¸­åˆ’çº¿ï¼Œå•ä¸ªå•è¯ä½¿ç”¨ä¸€ä¸ªä¸­åˆ’çº¿</strong>ï¼‰</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker å‘½ä»¤ --help</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="é•œåƒå‘½ä»¤"><a href="#é•œåƒå‘½ä»¤" class="headerlink" title="é•œåƒå‘½ä»¤"></a>é•œåƒå‘½ä»¤</h2><h3 id="docker-images"><a href="#docker-images" class="headerlink" title="docker images"></a>docker images</h3><ul>
<li>åˆ—å‡ºæœ¬åœ°ä¸»æœºä¸Šçš„é•œåƒ</li>
<li>OPTIONSï¼š<ul>
<li>-a  åˆ—å‡ºæ‰€æœ‰</li>
<li>-q  åªæ˜¾ç¤ºé•œåƒID</li>
</ul>
</li>
</ul>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker images</span><br><span class="line">REPOSITORY    TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">ubuntu        latest    ba6acccedd29   16 months ago   72.8MB</span><br><span class="line">hello-world   latest    feb5d9fea6a5   17 months ago   13.3kB</span><br></pre></td></tr></table></figure>

<p>é€‰é¡¹è¯´æ˜ï¼š</p>
<table>
<thead>
<tr>
<th>REPOSITORY</th>
<th>ä»“åº“æº</th>
</tr>
</thead>
<tbody><tr>
<td>TAG</td>
<td>é•œåƒæ ‡ç­¾</td>
</tr>
<tr>
<td>IMAGE ID</td>
<td>é•œåƒ ID</td>
</tr>
<tr>
<td>CREATED</td>
<td>é•œåƒåˆ›å»ºæ—¶é—´</td>
</tr>
<tr>
<td>SIZE</td>
<td>é•œåƒå¤§å°</td>
</tr>
</tbody></table>
<h3 id="docker-search"><a href="#docker-search" class="headerlink" title="docker search"></a>docker search</h3><ul>
<li>docker search æ˜¯ä» <a target="_blank" rel="noopener" href="https://hub.docker.com/">https://hub.docker.com</a> æŸ¥è¯¢é•œåƒ</li>
<li>OPTIONSï¼š<ul>
<li>â€“limit	æ•°é‡é™åˆ¶ï¼Œé»˜è®¤ 25 ä¸ª</li>
</ul>
</li>
</ul>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker search --limit 5 tomcat</span><br><span class="line">NAME                          DESCRIPTION                      STARS     OFFICIAL   AUTOMATED</span><br><span class="line">tomcat                        Apache Tomcat is an open source 3496      [OK]</span><br><span class="line">tomee                         Apache TomEE is an all-Apache Ja103       [OK]</span><br><span class="line">bitnami/tomcat                Bitnami Tomcat Docker Image      48                   [OK]</span><br><span class="line">secoresearch/tomcat-varnish   Tomcat and Varnish 5.0           0                    [OK]</span><br><span class="line">wnprcehr/tomcat                                                0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="docker-pull"><a href="#docker-pull" class="headerlink" title="docker pull"></a>docker pull</h3><ul>
<li>ä¸‹è½½é•œåƒ</li>
<li>docker  pull  é•œåƒåç§°:TAG</li>
</ul>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker pull ubuntu</span><br><span class="line">Using default tag: latest</span><br><span class="line">latest: Pulling from library/ubuntu</span><br><span class="line">7b1a6ab2e44d: Pull complete</span><br><span class="line">Digest: sha256:626ffe58f6e7566e00254b638eb7e0f3b11d4da9675088f4781a50ae288f3322</span><br><span class="line">Status: Downloaded newer image for ubuntu:latest</span><br><span class="line">docker.io/library/ubuntu:latest</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="docker-system-df"><a href="#docker-system-df" class="headerlink" title="docker system df"></a>docker system df</h3><ul>
<li>æŸ¥çœ‹é•œåƒã€å®¹å™¨ã€æ•°æ®å·æ‰€å çš„ç©ºé—´</li>
</ul>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker system df</span><br><span class="line">TYPE            TOTAL     ACTIVE    SIZE      RECLAIMABLE</span><br><span class="line">Images          2         1         72.79MB   72.78MB (99%)</span><br><span class="line">Containers      1         0         0B        0B</span><br><span class="line">Local Volumes   0         0         0B        0B</span><br><span class="line">Build Cache     0         0         0B        0B</span><br></pre></td></tr></table></figure>

<h3 id="docker-rmi"><a href="#docker-rmi" class="headerlink" title="docker rmi"></a>docker rmi</h3><ul>
<li>åˆ é™¤é•œåƒ</li>
<li>åˆ é™¤å•ä¸ªï¼šdocker  rmi  -f  é•œåƒID</li>
<li>åˆ é™¤å¤šä¸ªï¼šdocker  rmi  -f  é•œåƒå1:TAG  é•œåƒå2:TAG</li>
<li>åˆ é™¤å…¨éƒ¨ï¼šdocker rmi -f $(docker images -qa)</li>
</ul>
<h3 id="è™šæ‚¬é•œåƒ"><a href="#è™šæ‚¬é•œåƒ" class="headerlink" title="è™šæ‚¬é•œåƒ"></a>è™šæ‚¬é•œåƒ</h3><ul>
<li>ä»“åº“åã€æ ‡ç­¾éƒ½æ˜¯ <none> çš„é•œåƒï¼Œä¿—ç§°è™šæ‚¬é•œåƒdangling image</none></li>
</ul>
<h2 id="å®¹å™¨å‘½ä»¤"><a href="#å®¹å™¨å‘½ä»¤" class="headerlink" title="å®¹å™¨å‘½ä»¤"></a>å®¹å™¨å‘½ä»¤</h2><h3 id="å¯åŠ¨å®¹å™¨"><a href="#å¯åŠ¨å®¹å™¨" class="headerlink" title="å¯åŠ¨å®¹å™¨"></a>å¯åŠ¨å®¹å™¨</h3><ul>
<li><strong>docker 	run 	[OPTIONS] 	IMAGE 	[COMMAND] 	[ARGâ€¦]</strong></li>
</ul>
<p>OPTIONS é€‰é¡¹è¯´æ˜ï¼š</p>
<table>
<thead>
<tr>
<th>option</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>â€“name</td>
<td>å®¹å™¨åç§°</td>
</tr>
<tr>
<td>-d</td>
<td>å¯åŠ¨å®ˆæŠ¤å¼å®¹å™¨ï¼Œåå°è¿è¡Œå®¹å™¨</td>
</tr>
<tr>
<td>-i</td>
<td>ä»¥äº¤äº’æ¨¡å¼è¿è¡Œå®¹å™¨ï¼Œé€šå¸¸ä¸ -t åŒæ—¶ä½¿ç”¨</td>
</tr>
<tr>
<td>-t</td>
<td>ä¸ºå®¹å™¨é‡æ–°åˆ†é…ä¸€ä¸ªä¼ªè¾“å…¥ç»ˆç«¯ï¼Œé€šå¸¸ä¸ -i åŒæ—¶ä½¿ç”¨</td>
</tr>
<tr>
<td>-P</td>
<td>éšæœºç«¯å£æ˜ å°„</td>
</tr>
<tr>
<td>-p</td>
<td>æŒ‡å®šç«¯å£æ˜ å°„</td>
</tr>
</tbody></table>
<p>-p å‚æ•°è¯´æ˜ï¼š</p>
<table>
<thead>
<tr>
<th>args</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>-p hostPort:containerPort</td>
<td>ç«¯å£æ˜ å°„               -p 8080:80</td>
</tr>
<tr>
<td>-p ip:hostPort:containerPort</td>
<td>é…ç½®ç›‘å¬åœ°å€       -p 192.168.100.100:8080:80</td>
</tr>
<tr>
<td>-p ip::containerPort</td>
<td>éšæœºåˆ†é…ç«¯å£       -p 192.168.100.100::80</td>
</tr>
<tr>
<td>-p hostPort:containerPort:tcp</td>
<td>æŒ‡å®šåè®®               -p 8080:80:udp</td>
</tr>
<tr>
<td>-p 8080:80  3306:3306</td>
<td>æŒ‡å®šå¤šä¸ªæ˜ å°„</td>
</tr>
</tbody></table>
<p><strong>ã€æ³¨æ„ï¼šã€‘</strong></p>
<p>å¯åŠ¨å®¹å™¨æœ‰ä¸¤ç§æ–¹å¼ï¼š<strong>åå°å®ˆæŠ¤å¼å¯åŠ¨ï¼Œå‰å°äº¤äº’å¼å¯åŠ¨</strong></p>
<p>å¦‚æœä»¥åå°å¯åŠ¨ï¼Œå¦‚ docker run -d ubuntuï¼Œå†ä½¿ç”¨ docker ps æŸ¥çœ‹æ—¶ï¼Œå‘ç°å®¹å™¨å·²ç»é€€å‡ºï¼ˆè‡ªæ€ï¼‰ï¼Œå› ä¸º Dockerå®¹å™¨åå°å¯åŠ¨ï¼Œå°±å¿…é¡»æœ‰ä¸€ä¸ªå‰å°è¿›ç¨‹ï¼Œå¦åˆ™å®ƒè§‰å¾—è‡ªå·±æ— äº‹å¯åšï¼Œä¾¿ä¼šé€€å‡ºã€‚</p>
<p><strong>é€šç”¨çš„è§£å†³æ–¹æ¡ˆï¼šå°†è¿è¡Œçš„ç¨‹åºä»¥å‰å°è¿›ç¨‹çš„å½¢å¼è¿è¡Œï¼Œå¦‚ä½¿ç”¨å‘½ä»¤ tailã€æ­»å¾ªç¯ã€å‘½ä»¤è¡Œæ¨¡å¼ç­‰ã€‚</strong></p>
<p>ç¤ºä¾‹ï¼š</p>
<ul>
<li><p>åå°å¯åŠ¨å®¹å™¨</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker images</span><br><span class="line">REPOSITORY    TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">ubuntu        latest    ba6acccedd29   17 months ago   72.8MB</span><br><span class="line">hello-world   latest    feb5d9fea6a5   18 months ago   13.3kB</span><br><span class="line">[root@localhost ~]# docker run -d ubuntu</span><br><span class="line">c1eb209f98c1e94e9ad767570ffd5e81f105e9664cf3332b2c29af109a295aad</span><br><span class="line">[root@localhost ~]# docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure>
</li>
<li><p>äº¤äº’æ–¹å¼å¯åŠ¨å®¹å™¨</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker run -it ubuntu</span><br><span class="line">root@21595e02b246:/# ll</span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x.   1 root root   6 Mar 31 07:19 ./</span><br><span class="line">drwxr-xr-x.   1 root root   6 Mar 31 07:19 ../</span><br><span class="line">-rwxr-xr-x.   1 root root   0 Mar 31 07:19 .dockerenv*</span><br><span class="line">lrwxrwxrwx.   1 root root   7 Oct  6  2021 bin -&gt; usr/bin/</span><br><span class="line">drwxr-xr-x.   2 root root   6 Apr 15  2020 boot/</span><br><span class="line">drwxr-xr-x.   5 root root 360 Mar 31 07:19 dev/</span><br><span class="line">drwxr-xr-x.   1 root root  66 Mar 31 07:19 etc/</span><br><span class="line">drwxr-xr-x.   2 root root   6 Apr 15  2020 home/</span><br><span class="line">lrwxrwxrwx.   1 root root   7 Oct  6  2021 lib -&gt; usr/lib/</span><br><span class="line">lrwxrwxrwx.   1 root root   9 Oct  6  2021 lib32 -&gt; usr/lib32/</span><br><span class="line">lrwxrwxrwx.   1 root root   9 Oct  6  2021 lib64 -&gt; usr/lib64/</span><br><span class="line">lrwxrwxrwx.   1 root root  10 Oct  6  2021 libx32 -&gt; usr/libx32/</span><br><span class="line">drwxr-xr-x.   2 root root   6 Oct  6  2021 media/</span><br><span class="line">drwxr-xr-x.   2 root root   6 Oct  6  2021 mnt/</span><br><span class="line">drwxr-xr-x.   2 root root   6 Oct  6  2021 opt/</span><br><span class="line">dr-xr-xr-x. 200 root root   0 Mar 31 07:19 proc/</span><br><span class="line">drwx------.   2 root root  37 Oct  6  2021 root/</span><br><span class="line">drwxr-xr-x.   5 root root  58 Oct  6  2021 run/</span><br><span class="line">lrwxrwxrwx.   1 root root   8 Oct  6  2021 sbin -&gt; usr/sbin/</span><br><span class="line">drwxr-xr-x.   2 root root   6 Oct  6  2021 srv/</span><br><span class="line">dr-xr-xr-x.  13 root root   0 Mar 31 07:08 sys/</span><br><span class="line">drwxrwxrwt.   2 root root   6 Oct  6  2021 tmp/</span><br><span class="line">drwxr-xr-x.  13 root root 145 Oct  6  2021 usr/</span><br><span class="line">drwxr-xr-x.  11 root root 139 Oct  6  2021 var/</span><br><span class="line">root@21595e02b246:/#</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="åˆ—å‡ºå®¹å™¨"><a href="#åˆ—å‡ºå®¹å™¨" class="headerlink" title="åˆ—å‡ºå®¹å™¨"></a>åˆ—å‡ºå®¹å™¨</h3><ul>
<li><strong>docker ps [OPTIONS]</strong></li>
</ul>
<p>options è¯´æ˜ï¼š</p>
<table>
<thead>
<tr>
<th>OPTIONS</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>-a</td>
<td>åˆ—å‡ºæ‰€æœ‰æ­£åœ¨è¿è¡Œçš„å®¹å™¨ï¼ŒåŒ…å«å†å²ä¸Šè¿è¡Œçš„</td>
</tr>
<tr>
<td>-l</td>
<td>æ˜¾ç¤ºæœ€è¿‘åˆ›å»ºçš„å®¹å™¨</td>
</tr>
<tr>
<td>-n</td>
<td>æ˜¾ç¤ºæœ€è¿‘ n ä¸ªåˆ›å»ºçš„å®¹å™¨</td>
</tr>
<tr>
<td>-q</td>
<td>åªæ˜¾ç¤ºå®¹å™¨ç¼–å·</td>
</tr>
</tbody></table>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker ps -a</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED              STATUS                      PORTS     NAMES</span><br><span class="line">bf91edb177d1   ubuntu    &quot;bash&quot;    42 seconds ago       Exited (0) 36 seconds ago             clever_brown</span><br><span class="line">ea0e7b47084c   ubuntu    &quot;bash&quot;    About a minute ago   Up About a minute                     busy_mcclintock</span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure>

<h3 id="é€€å‡ºå®¹å™¨"><a href="#é€€å‡ºå®¹å™¨" class="headerlink" title="é€€å‡ºå®¹å™¨"></a>é€€å‡ºå®¹å™¨</h3><ul>
<li><p>æ–¹å¼ä¸€ï¼šexit </p>
<ul>
<li><p>é€€å‡ºå®¹å™¨ï¼Œå®¹å™¨ä¼šåœæ­¢</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker run -it ubuntu</span><br><span class="line">root@bf91edb177d1:/# exit</span><br><span class="line">exit</span><br><span class="line">[root@localhost ~]# docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED              STATUS              PORTS     NAMES</span><br><span class="line">ea0e7b47084c   ubuntu    &quot;bash&quot;    About a minute ago   Up About a minute             busy_mcclintock</span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>æ–¹å¼äºŒï¼šCTRL + P + Q</p>
<ul>
<li><p>é€€å‡ºå®¹å™¨ï¼Œå®¹å™¨ä¸ä¼šåœæ­¢</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED          STATUS          PORTS     NAMES</span><br><span class="line">ea0e7b47084c   ubuntu    &quot;bash&quot;    33 seconds ago   Up 31 seconds             busy_mcclintock</span><br><span class="line">[root@localhost ~]# </span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="é‡å¯å®¹å™¨"><a href="#é‡å¯å®¹å™¨" class="headerlink" title="é‡å¯å®¹å™¨"></a>é‡å¯å®¹å™¨</h3><ul>
<li><strong>docker restart å®¹å™¨ ID æˆ–è€…å®¹å™¨åç§°</strong></li>
</ul>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker ps -a</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED              STATUS                      PORTS     NAMES</span><br><span class="line">bf91edb177d1   ubuntu    &quot;bash&quot;    42 seconds ago       Exited (0) 36 seconds ago             clever_brown</span><br><span class="line">ea0e7b47084c   ubuntu    &quot;bash&quot;    About a minute ago   Up About a minute                     busy_mcclintock</span><br><span class="line">[root@localhost ~]# docker restart bf91edb177d1</span><br><span class="line">bf91edb177d1</span><br><span class="line">[root@localhost ~]# docker ps -a</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED         STATUS         PORTS     NAMES</span><br><span class="line">bf91edb177d1   ubuntu    &quot;bash&quot;    3 minutes ago   Up 2 seconds             clever_brown</span><br><span class="line">ea0e7b47084c   ubuntu    &quot;bash&quot;    4 minutes ago   Up 4 minutes             busy_mcclintock</span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure>

<h3 id="åœæ­¢å®¹å™¨"><a href="#åœæ­¢å®¹å™¨" class="headerlink" title="åœæ­¢å®¹å™¨"></a>åœæ­¢å®¹å™¨</h3><ul>
<li><p><strong>docker stop å®¹å™¨ ID æˆ–è€…å®¹å™¨åç§°</strong></p>
</li>
<li><p><strong>å¼ºåˆ¶åœæ­¢å®¹å™¨ï¼šdocker kill å®¹å™¨ ID æˆ–å®¹å™¨åç§°</strong></p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker ps -a</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED         STATUS         PORTS     NAMES</span><br><span class="line">bf91edb177d1   ubuntu    &quot;bash&quot;    3 minutes ago   Up 2 seconds             clever_brown</span><br><span class="line">ea0e7b47084c   ubuntu    &quot;bash&quot;    4 minutes ago   Up 4 minutes             busy_mcclintock</span><br><span class="line">[root@localhost ~]# docker stop bf91edb177d1</span><br><span class="line">bf91edb177d1</span><br><span class="line">[root@localhost ~]# docker ps -a</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED          STATUS                     PORTS     NAMES</span><br><span class="line">bf91edb177d1   ubuntu    &quot;bash&quot;    21 minutes ago   Exited (0) 5 seconds ago             clever_brown</span><br><span class="line">ea0e7b47084c   ubuntu    &quot;bash&quot;    23 minutes ago   Up 23 minutes                        busy_mcclintock</span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure>

<h3 id="åˆ é™¤å®¹å™¨"><a href="#åˆ é™¤å®¹å™¨" class="headerlink" title="åˆ é™¤å®¹å™¨"></a>åˆ é™¤å®¹å™¨</h3><ul>
<li><p>åˆ é™¤å•ä¸ªï¼š<strong>docker rm å®¹å™¨ID</strong></p>
</li>
<li><p>åˆ é™¤å¤šä¸ª</p>
<ul>
<li>æ–¹å¼ä¸€ï¼šdocker rm -f $(docker ps -qa)</li>
<li>æ–¹å¼äºŒï¼šdocker ps -a -q | xargs docker rm</li>
</ul>
</li>
</ul>
<h3 id="æŸ¥çœ‹å®¹å™¨æ“ä½œæ—¥å¿—"><a href="#æŸ¥çœ‹å®¹å™¨æ“ä½œæ—¥å¿—" class="headerlink" title="æŸ¥çœ‹å®¹å™¨æ“ä½œæ—¥å¿—"></a>æŸ¥çœ‹å®¹å™¨æ“ä½œæ—¥å¿—</h3><ul>
<li>docker logs å®¹å™¨ ID</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker logs ea0e7b47084c</span><br><span class="line">root@ea0e7b47084c:/# ll</span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x.   1 root root   6 Mar 31 07:24 ./</span><br><span class="line">drwxr-xr-x.   1 root root   6 Mar 31 07:24 ../</span><br><span class="line">-rwxr-xr-x.   1 root root   0 Mar 31 07:24 .dockerenv*</span><br><span class="line">lrwxrwxrwx.   1 root root   7 Oct  6  2021 bin -&gt; usr/bin/</span><br><span class="line">drwxr-xr-x.   2 root root   6 Apr 15  2020 boot/</span><br><span class="line">drwxr-xr-x.   5 root root 360 Mar 31 07:24 dev/</span><br><span class="line">drwxr-xr-x.   1 root root  66 Mar 31 07:24 etc/</span><br><span class="line">drwxr-xr-x.   2 root root   6 Apr 15  2020 home/</span><br><span class="line">lrwxrwxrwx.   1 root root   7 Oct  6  2021 lib -&gt; usr/lib/</span><br><span class="line">lrwxrwxrwx.   1 root root   9 Oct  6  2021 lib32 -&gt; usr/lib32/</span><br><span class="line">lrwxrwxrwx.   1 root root   9 Oct  6  2021 lib64 -&gt; usr/lib64/</span><br><span class="line">lrwxrwxrwx.   1 root root  10 Oct  6  2021 libx32 -&gt; usr/libx32/</span><br><span class="line">drwxr-xr-x.   2 root root   6 Oct  6  2021 media/</span><br><span class="line">drwxr-xr-x.   2 root root   6 Oct  6  2021 mnt/</span><br><span class="line">drwxr-xr-x.   2 root root   6 Oct  6  2021 opt/</span><br><span class="line">dr-xr-xr-x. 200 root root   0 Mar 31 07:24 proc/</span><br><span class="line">drwx------.   2 root root  37 Oct  6  2021 root/</span><br><span class="line">drwxr-xr-x.   5 root root  58 Oct  6  2021 run/</span><br><span class="line">lrwxrwxrwx.   1 root root   8 Oct  6  2021 sbin -&gt; usr/sbin/</span><br><span class="line">drwxr-xr-x.   2 root root   6 Oct  6  2021 srv/</span><br><span class="line">dr-xr-xr-x.  13 root root   0 Mar 31 07:08 sys/</span><br><span class="line">drwxrwxrwt.   2 root root   6 Oct  6  2021 tmp/</span><br><span class="line">drwxr-xr-x.  13 root root 145 Oct  6  2021 usr/</span><br><span class="line">drwxr-xr-x.  11 root root 139 Oct  6  2021 var/</span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure>

<h3 id="æŸ¥çœ‹å®¹å™¨å†…è¿è¡Œçš„è¿›ç¨‹"><a href="#æŸ¥çœ‹å®¹å™¨å†…è¿è¡Œçš„è¿›ç¨‹" class="headerlink" title="æŸ¥çœ‹å®¹å™¨å†…è¿è¡Œçš„è¿›ç¨‹"></a>æŸ¥çœ‹å®¹å™¨å†…è¿è¡Œçš„è¿›ç¨‹</h3><ul>
<li>docker top å®¹å™¨ ID</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker top ea0e7b47084c</span><br><span class="line">UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD</span><br><span class="line">root                3732                3711                0                   15:24               pts/0               00:00:00            bash</span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure>

<h3 id="æŸ¥çœ‹å®¹å™¨å†…éƒ¨ç»†èŠ‚"><a href="#æŸ¥çœ‹å®¹å™¨å†…éƒ¨ç»†èŠ‚" class="headerlink" title="æŸ¥çœ‹å®¹å™¨å†…éƒ¨ç»†èŠ‚"></a>æŸ¥çœ‹å®¹å™¨å†…éƒ¨ç»†èŠ‚</h3><ul>
<li>docker inspect å®¹å™¨ ID</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker inspect ea0e7b47084c</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Id&quot;: &quot;ea0e7b47084cb385f1856efd38e3255d86f5c3af5f884d97ab0052e17c724d15&quot;,</span><br><span class="line">        &quot;Created&quot;: &quot;2023-03-31T07:24:03.622901668Z&quot;,</span><br><span class="line">        &quot;Path&quot;: &quot;bash&quot;,</span><br><span class="line">        &quot;Args&quot;: [],</span><br><span class="line">        &quot;State&quot;: &#123;</span><br><span class="line">            &quot;Status&quot;: &quot;running&quot;,</span><br><span class="line">            &quot;Running&quot;: true,</span><br><span class="line">            &quot;Paused&quot;: false,</span><br><span class="line">            &quot;Restarting&quot;: false,</span><br><span class="line">            &quot;OOMKilled&quot;: false,</span><br><span class="line">            &quot;Dead&quot;: false,</span><br><span class="line">            &quot;Pid&quot;: 3732,</span><br><span class="line">            &quot;ExitCode&quot;: 0,</span><br><span class="line">            &quot;Error&quot;: &quot;&quot;,</span><br><span class="line">            &quot;StartedAt&quot;: &quot;2023-03-31T07:24:04.54637059Z&quot;,</span><br><span class="line">            &quot;FinishedAt&quot;: &quot;0001-01-01T00:00:00Z&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Image&quot;: &quot;sha256:ba6acccedd2923aee4c2acc6a23780b14ed4b8a5fa4e14e252a23b846df9b6c1&quot;,</span><br><span class="line">        &quot;ResolvConfPath&quot;: &quot;/var/lib/docker/containers/ea0e7b47084cb385f1856efd38e3255d86f5c3af5f884d97ab0052e17c724d15/resolv.conf&quot;,</span><br><span class="line">        &quot;HostnamePath&quot;: &quot;/var/lib/docker/containers/ea0e7b47084cb385f1856efd38e3255d86f5c3af5f884d97ab0052e17c724d15/hostname&quot;,</span><br><span class="line">        &quot;HostsPath&quot;: &quot;/var/lib/docker/containers/ea0e7b47084cb385f1856efd38e3255d86f5c3af5f884d97ab0052e17c724d15/hosts&quot;,</span><br><span class="line">        &quot;LogPath&quot;: &quot;/var/lib/docker/containers/ea0e7b47084cb385f1856efd38e3255d86f5c3af5f884d97ab0052e17c724d15/ea0e7b47084cb385f1856efd38e3255d86f5c3af5f884d97ab0052e17c724d15-json.log&quot;,</span><br><span class="line">        &quot;Name&quot;: &quot;/busy_mcclintock&quot;,</span><br><span class="line">        &quot;RestartCount&quot;: 0,</span><br><span class="line">        &quot;Driver&quot;: &quot;overlay2&quot;,</span><br><span class="line">        &quot;Platform&quot;: &quot;linux&quot;,</span><br><span class="line">        &quot;MountLabel&quot;: &quot;&quot;,</span><br><span class="line">        &quot;ProcessLabel&quot;: &quot;&quot;,</span><br><span class="line">        &quot;AppArmorProfile&quot;: &quot;&quot;,</span><br><span class="line">        &quot;ExecIDs&quot;: null,</span><br><span class="line">        &quot;HostConfig&quot;: &#123;</span><br><span class="line">            &quot;Binds&quot;: null,</span><br><span class="line">            &quot;ContainerIDFile&quot;: &quot;&quot;,</span><br><span class="line">            &quot;LogConfig&quot;: &#123;</span><br><span class="line">                &quot;Type&quot;: &quot;json-file&quot;,</span><br><span class="line">                &quot;Config&quot;: &#123;&#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;NetworkMode&quot;: &quot;default&quot;,</span><br><span class="line">            &quot;PortBindings&quot;: &#123;&#125;,</span><br><span class="line">            &quot;RestartPolicy&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;no&quot;,</span><br><span class="line">                &quot;MaximumRetryCount&quot;: 0</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;AutoRemove&quot;: false,</span><br><span class="line">            &quot;VolumeDriver&quot;: &quot;&quot;,</span><br><span class="line">            &quot;VolumesFrom&quot;: null,</span><br><span class="line">            &quot;ConsoleSize&quot;: [</span><br><span class="line">                32,</span><br><span class="line">                108</span><br><span class="line">            ],</span><br><span class="line">            &quot;CapAdd&quot;: null,</span><br><span class="line">            &quot;CapDrop&quot;: null,</span><br><span class="line">            &quot;CgroupnsMode&quot;: &quot;host&quot;,</span><br><span class="line">            &quot;Dns&quot;: [],</span><br><span class="line">            &quot;DnsOptions&quot;: [],</span><br><span class="line">            &quot;DnsSearch&quot;: [],</span><br><span class="line">            &quot;ExtraHosts&quot;: null,</span><br><span class="line">            &quot;GroupAdd&quot;: null,</span><br><span class="line">            &quot;IpcMode&quot;: &quot;private&quot;,</span><br><span class="line">            &quot;Cgroup&quot;: &quot;&quot;,</span><br><span class="line">            &quot;Links&quot;: null,</span><br><span class="line">            &quot;OomScoreAdj&quot;: 0,</span><br><span class="line">            &quot;PidMode&quot;: &quot;&quot;,</span><br><span class="line">            &quot;Privileged&quot;: false,</span><br><span class="line">            &quot;PublishAllPorts&quot;: false,</span><br><span class="line">            &quot;ReadonlyRootfs&quot;: false,</span><br><span class="line">            &quot;SecurityOpt&quot;: null,</span><br><span class="line">            &quot;UTSMode&quot;: &quot;&quot;,</span><br><span class="line">            &quot;UsernsMode&quot;: &quot;&quot;,</span><br><span class="line">            &quot;ShmSize&quot;: 67108864,</span><br><span class="line">            &quot;Runtime&quot;: &quot;runc&quot;,</span><br><span class="line">            &quot;Isolation&quot;: &quot;&quot;,</span><br><span class="line">            &quot;CpuShares&quot;: 0,</span><br><span class="line">            &quot;Memory&quot;: 0,</span><br><span class="line">            &quot;NanoCpus&quot;: 0,</span><br><span class="line">            &quot;CgroupParent&quot;: &quot;&quot;,</span><br><span class="line">            &quot;BlkioWeight&quot;: 0,</span><br><span class="line">            &quot;BlkioWeightDevice&quot;: [],</span><br><span class="line">            &quot;BlkioDeviceReadBps&quot;: [],</span><br><span class="line">            &quot;BlkioDeviceWriteBps&quot;: [],</span><br><span class="line">            &quot;BlkioDeviceReadIOps&quot;: [],</span><br><span class="line">            &quot;BlkioDeviceWriteIOps&quot;: [],</span><br><span class="line">            &quot;CpuPeriod&quot;: 0,</span><br><span class="line">            &quot;CpuQuota&quot;: 0,</span><br><span class="line">            &quot;CpuRealtimePeriod&quot;: 0,</span><br><span class="line">            &quot;CpuRealtimeRuntime&quot;: 0,</span><br><span class="line">            &quot;CpusetCpus&quot;: &quot;&quot;,</span><br><span class="line">            &quot;CpusetMems&quot;: &quot;&quot;,</span><br><span class="line">            &quot;Devices&quot;: [],</span><br><span class="line">            &quot;DeviceCgroupRules&quot;: null,</span><br><span class="line">            &quot;DeviceRequests&quot;: null,</span><br><span class="line">            &quot;MemoryReservation&quot;: 0,</span><br><span class="line">            &quot;MemorySwap&quot;: 0,</span><br><span class="line">            &quot;MemorySwappiness&quot;: null,</span><br><span class="line">            &quot;OomKillDisable&quot;: false,</span><br><span class="line">            &quot;PidsLimit&quot;: null,</span><br><span class="line">            &quot;Ulimits&quot;: null,</span><br><span class="line">            &quot;CpuCount&quot;: 0,</span><br><span class="line">            &quot;CpuPercent&quot;: 0,</span><br><span class="line">            &quot;IOMaximumIOps&quot;: 0,</span><br><span class="line">            &quot;IOMaximumBandwidth&quot;: 0,</span><br><span class="line">            &quot;MaskedPaths&quot;: [</span><br><span class="line">                &quot;/proc/asound&quot;,</span><br><span class="line">                &quot;/proc/acpi&quot;,</span><br><span class="line">                &quot;/proc/kcore&quot;,</span><br><span class="line">                &quot;/proc/keys&quot;,</span><br><span class="line">                &quot;/proc/latency_stats&quot;,</span><br><span class="line">                &quot;/proc/timer_list&quot;,</span><br><span class="line">                &quot;/proc/timer_stats&quot;,</span><br><span class="line">                &quot;/proc/sched_debug&quot;,</span><br><span class="line">                &quot;/proc/scsi&quot;,</span><br><span class="line">                &quot;/sys/firmware&quot;</span><br><span class="line">            ],</span><br><span class="line">            &quot;ReadonlyPaths&quot;: [</span><br><span class="line">                &quot;/proc/bus&quot;,</span><br><span class="line">                &quot;/proc/fs&quot;,</span><br><span class="line">                &quot;/proc/irq&quot;,</span><br><span class="line">                &quot;/proc/sys&quot;,</span><br><span class="line">                &quot;/proc/sysrq-trigger&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;GraphDriver&quot;: &#123;</span><br><span class="line">            &quot;Data&quot;: &#123;</span><br><span class="line">                &quot;LowerDir&quot;: &quot;/var/lib/docker/overlay2/825586b10ac435676da8bf6ca0db72528b142c5ad86e2465d99bcc68b050f0b1-init/diff:/var/lib/docker/overlay2/1f445baeff340f97a257005c997958dfb3c3eb431f6d70a02fa6e86fec4f3563/diff&quot;,</span><br><span class="line">                &quot;MergedDir&quot;: &quot;/var/lib/docker/overlay2/825586b10ac435676da8bf6ca0db72528b142c5ad86e2465d99bcc68b050f0b1/merged&quot;,</span><br><span class="line">                &quot;UpperDir&quot;: &quot;/var/lib/docker/overlay2/825586b10ac435676da8bf6ca0db72528b142c5ad86e2465d99bcc68b050f0b1/diff&quot;,</span><br><span class="line">                &quot;WorkDir&quot;: &quot;/var/lib/docker/overlay2/825586b10ac435676da8bf6ca0db72528b142c5ad86e2465d99bcc68b050f0b1/work&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;Name&quot;: &quot;overlay2&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Mounts&quot;: [],</span><br><span class="line">        &quot;Config&quot;: &#123;</span><br><span class="line">            &quot;Hostname&quot;: &quot;ea0e7b47084c&quot;,</span><br><span class="line">            &quot;Domainname&quot;: &quot;&quot;,</span><br><span class="line">            &quot;User&quot;: &quot;&quot;,</span><br><span class="line">            &quot;AttachStdin&quot;: true,</span><br><span class="line">            &quot;AttachStdout&quot;: true,</span><br><span class="line">            &quot;AttachStderr&quot;: true,</span><br><span class="line">            &quot;Tty&quot;: true,</span><br><span class="line">            &quot;OpenStdin&quot;: true,</span><br><span class="line">            &quot;StdinOnce&quot;: true,</span><br><span class="line">            &quot;Env&quot;: [</span><br><span class="line">                &quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span><br><span class="line">            ],</span><br><span class="line">            &quot;Cmd&quot;: [</span><br><span class="line">                &quot;bash&quot;</span><br><span class="line">            ],</span><br><span class="line">            &quot;Image&quot;: &quot;ubuntu&quot;,</span><br><span class="line">            &quot;Volumes&quot;: null,</span><br><span class="line">            &quot;WorkingDir&quot;: &quot;&quot;,</span><br><span class="line">            &quot;Entrypoint&quot;: null,</span><br><span class="line">            &quot;OnBuild&quot;: null,</span><br><span class="line">            &quot;Labels&quot;: &#123;&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;NetworkSettings&quot;: &#123;</span><br><span class="line">            &quot;Bridge&quot;: &quot;&quot;,</span><br><span class="line">            &quot;SandboxID&quot;: &quot;004ee4c4581b6352283bb4aa7cea027b8a92fe23e595a648a5b205918d8e967d&quot;,</span><br><span class="line">            &quot;HairpinMode&quot;: false,</span><br><span class="line">            &quot;LinkLocalIPv6Address&quot;: &quot;&quot;,</span><br><span class="line">            &quot;LinkLocalIPv6PrefixLen&quot;: 0,</span><br><span class="line">            &quot;Ports&quot;: &#123;&#125;,</span><br><span class="line">            &quot;SandboxKey&quot;: &quot;/var/run/docker/netns/004ee4c4581b&quot;,</span><br><span class="line">            &quot;SecondaryIPAddresses&quot;: null,</span><br><span class="line">            &quot;SecondaryIPv6Addresses&quot;: null,</span><br><span class="line">            &quot;EndpointID&quot;: &quot;bc2fc248955e9a32c587b646e474874f6502ad23cd123a0a00d79160233db129&quot;,</span><br><span class="line">            &quot;Gateway&quot;: &quot;172.17.0.1&quot;,</span><br><span class="line">            &quot;GlobalIPv6Address&quot;: &quot;&quot;,</span><br><span class="line">            &quot;GlobalIPv6PrefixLen&quot;: 0,</span><br><span class="line">            &quot;IPAddress&quot;: &quot;172.17.0.2&quot;,</span><br><span class="line">            &quot;IPPrefixLen&quot;: 16,</span><br><span class="line">            &quot;IPv6Gateway&quot;: &quot;&quot;,</span><br><span class="line">            &quot;MacAddress&quot;: &quot;02:42:ac:11:00:02&quot;,</span><br><span class="line">            &quot;Networks&quot;: &#123;</span><br><span class="line">                &quot;bridge&quot;: &#123;</span><br><span class="line">                    &quot;IPAMConfig&quot;: null,</span><br><span class="line">                    &quot;Links&quot;: null,</span><br><span class="line">                    &quot;Aliases&quot;: null,</span><br><span class="line">                    &quot;NetworkID&quot;: &quot;6f7ab27ac7abd5c6d0cc880b7ab0edacd679292a4a046ca417e32ad058abb78e&quot;,</span><br><span class="line">                    &quot;EndpointID&quot;: &quot;bc2fc248955e9a32c587b646e474874f6502ad23cd123a0a00d79160233db129&quot;,</span><br><span class="line">                    &quot;Gateway&quot;: &quot;172.17.0.1&quot;,</span><br><span class="line">                    &quot;IPAddress&quot;: &quot;172.17.0.2&quot;,</span><br><span class="line">                    &quot;IPPrefixLen&quot;: 16,</span><br><span class="line">                    &quot;IPv6Gateway&quot;: &quot;&quot;,</span><br><span class="line">                    &quot;GlobalIPv6Address&quot;: &quot;&quot;,</span><br><span class="line">                    &quot;GlobalIPv6PrefixLen&quot;: 0,</span><br><span class="line">                    &quot;MacAddress&quot;: &quot;02:42:ac:11:00:02&quot;,</span><br><span class="line">                    &quot;DriverOpts&quot;: null</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure>

<h3 id="è¿›å…¥æ­£åœ¨è¿è¡Œçš„å®¹å™¨"><a href="#è¿›å…¥æ­£åœ¨è¿è¡Œçš„å®¹å™¨" class="headerlink" title="è¿›å…¥æ­£åœ¨è¿è¡Œçš„å®¹å™¨"></a>è¿›å…¥æ­£åœ¨è¿è¡Œçš„å®¹å™¨</h3><ul>
<li><p>æ–¹å¼ä¸€ã€æ¨èä½¿ç”¨ã€‘ï¼šdocker exec -it å®¹å™¨ ID bashShell</p>
<p>exec æ˜¯åœ¨å®¹å™¨ä¸­æ‰“å¼€æ–°çš„ç»ˆç«¯ï¼Œå¹¶ä¸”å¯åŠ¨æ–°çš„è¿›ç¨‹ï¼Œç”¨ exit é€€å‡ºï¼Œä¸ä¼šå¯¼è‡´å®¹å™¨çš„åœæ­¢ï¼ŒCTRL + P + Q ä¸ä¼šé€€å‡ºå®¹å™¨</p>
<p>å¦‚æœå‚æ•°ä¸º bashShell åˆ™ä¼šä»¥è¿™ç§ shell è¿›å…¥å®¹å™¨ï¼Œå¦‚æœå‚æ•°ä¸ºæ™®é€šå‘½ä»¤ï¼Œåˆ™ä¼šåªæ‰§è¡Œå‘½ä»¤ï¼Œä¸ä¼šè¿›å…¥å®¹å™¨ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker ps -a</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED          STATUS                      PORTS     NAMES</span><br><span class="line">bf91edb177d1   ubuntu    &quot;bash&quot;    31 minutes ago   Exited (0) 10 minutes ago             clever_brown</span><br><span class="line">ea0e7b47084c   ubuntu    &quot;bash&quot;    33 minutes ago   Up 3 seconds                          busy_mcclintock</span><br><span class="line">[root@localhost ~]# docker exec -it ea0e7b47084c /bin/bash</span><br><span class="line">root@ea0e7b47084c:/# exit</span><br><span class="line">exit</span><br><span class="line">[root@localhost ~]# docker ps -a</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED          STATUS                      PORTS     NAMES</span><br><span class="line">bf91edb177d1   ubuntu    &quot;bash&quot;    32 minutes ago   Exited (0) 10 minutes ago             clever_brown</span><br><span class="line">ea0e7b47084c   ubuntu    &quot;bash&quot;    33 minutes ago   Up 34 seconds                         busy_mcclintock</span><br><span class="line">[root@localhost ~]# docker exec -it ea0e7b47084c</span><br><span class="line">&quot;docker exec&quot; requires at least 2 arguments.</span><br><span class="line">See &#x27;docker exec --help&#x27;.</span><br><span class="line"></span><br><span class="line">Usage:  docker exec [OPTIONS] CONTAINER COMMAND [ARG...]</span><br><span class="line"></span><br><span class="line">Execute a command in a running container</span><br><span class="line">[root@localhost ~]# docker exec -it ea0e7b47084c pwd</span><br><span class="line">/</span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ–¹å¼äºŒï¼šdocker attach  å®¹å™¨ ID</p>
<p>attach ç›´æ¥è¿›å…¥å®¹å™¨å¯åŠ¨å‘½ä»¤çš„ç»ˆç«¯ï¼Œä¸ä¼šå¯åŠ¨æ–°çš„è¿›ç¨‹ï¼Œç”¨ exit é€€å‡ºï¼Œä¼šå¯¼è‡´å®¹å™¨çš„åœæ­¢ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker ps -a</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED          STATUS                     PORTS     NAMES</span><br><span class="line">bf91edb177d1   ubuntu    &quot;bash&quot;    30 minutes ago   Exited (0) 8 minutes ago             clever_brown</span><br><span class="line">ea0e7b47084c   ubuntu    &quot;bash&quot;    31 minutes ago   Up 31 minutes                        busy_mcclintock</span><br><span class="line">[root@localhost ~]# docker attach ea0e7b47084c</span><br><span class="line">root@ea0e7b47084c:/# pwd</span><br><span class="line">/</span><br><span class="line">root@ea0e7b47084c:/# exit</span><br><span class="line">exit</span><br><span class="line">[root@localhost ~]# docker ps -a</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED          STATUS                     PORTS     NAMES</span><br><span class="line">bf91edb177d1   ubuntu    &quot;bash&quot;    30 minutes ago   Exited (0) 8 minutes ago             clever_brown</span><br><span class="line">ea0e7b47084c   ubuntu    &quot;bash&quot;    31 minutes ago   Exited (0) 4 seconds ago             busy_mcclintock</span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="æ‹·è´æ–‡ä»¶"><a href="#æ‹·è´æ–‡ä»¶" class="headerlink" title="æ‹·è´æ–‡ä»¶"></a>æ‹·è´æ–‡ä»¶</h3><ul>
<li>docker  cp  å®¹å™¨ ID:å®¹å™¨å†…è·¯å¾„  ç›®çš„ä¸»æœºè·¯å¾„</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker exec -it ea0e7b47084c /bin/bash</span><br><span class="line">root@ea0e7b47084c:/# touch demo.txt</span><br><span class="line">root@ea0e7b47084c:/# exit</span><br><span class="line">exit</span><br><span class="line">[root@localhost ~]# docker cp ea0e7b47084c:/demo.txt /opt/temp</span><br><span class="line">Successfully copied 1.536kB to /opt/temp</span><br><span class="line">[root@localhost ~]# cd /optt/emp &amp;&amp; ll</span><br><span class="line">æ€»ç”¨é‡ 0</span><br><span class="line">-rw-r--r--. 1 root root   0 3æœˆ  31 16:05 demo.txt</span><br><span class="line">[root@localhost opt]#</span><br></pre></td></tr></table></figure>

<h3 id="å¯¼å…¥å’Œå¯¼å‡ºå®¹å™¨"><a href="#å¯¼å…¥å’Œå¯¼å‡ºå®¹å™¨" class="headerlink" title="å¯¼å…¥å’Œå¯¼å‡ºå®¹å™¨"></a>å¯¼å…¥å’Œå¯¼å‡ºå®¹å™¨</h3><ul>
<li>export	å¯¼å‡ºå®¹å™¨çš„å†…å®¹ç•™ä½œä¸ºä¸€ä¸ª tar å½’æ¡£æ–‡ä»¶<ul>
<li>docker export å®¹å™¨ID &gt; æ–‡ä»¶å.tar</li>
</ul>
</li>
<li>import    ä» tar åŒ…ä¸­çš„å†…å®¹åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶ç³»ç»Ÿå†å¯¼å…¥ä¸ºé•œåƒ<ul>
<li>cat æ–‡ä»¶å.tar | docker import - é•œåƒç”¨æˆ·&#x2F;é•œåƒå:é•œåƒç‰ˆæœ¬å·</li>
</ul>
</li>
</ul>
<h3 id="å…¶ä»–å¸¸ç”¨å‘½ä»¤"><a href="#å…¶ä»–å¸¸ç”¨å‘½ä»¤" class="headerlink" title="å…¶ä»–å¸¸ç”¨å‘½ä»¤"></a>å…¶ä»–å¸¸ç”¨å‘½ä»¤</h3><p><img src="/2023/03/27/Docker/Docker%E5%91%BD%E4%BB%A4.png" alt="Dockerå‘½ä»¤.png"></p>
<p>Docker å‘½ä»¤è¯´æ˜ï¼š</p>
<table>
<thead>
<tr>
<th>å‘½ä»¤</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>attach</td>
<td>åœ¨å½“å‰ shell ä¸‹ è¿æ¥æŒ‡å®šçš„é•œåƒ</td>
</tr>
<tr>
<td>build</td>
<td>é€šè¿‡ Dockerfile æ„å»ºé•œåƒ</td>
</tr>
<tr>
<td>commit</td>
<td>æäº¤å½“å‰å®¹å™¨ä¸ºæ–°çš„é•œåƒ</td>
</tr>
<tr>
<td>cp</td>
<td>ä»å®¹å™¨ä¸­æ‹·è´æŒ‡å®šæ–‡ä»¶æˆ–è€…ç›®å½•åˆ°å®¿ä¸»æœºä¸­</td>
</tr>
<tr>
<td>create</td>
<td>åˆ›å»ºä¸€ä¸ªæ–°çš„å®¹å™¨ï¼ŒåŒ runï¼Œä½†ä¸å¯åŠ¨å®¹å™¨</td>
</tr>
<tr>
<td>diff</td>
<td>æŸ¥çœ‹ docker å®¹å™¨å˜åŒ–</td>
</tr>
<tr>
<td>events</td>
<td>ä» docker æœåŠ¡è·å–å®¹å™¨å®æ—¶äº‹ä»¶</td>
</tr>
<tr>
<td>exec</td>
<td>åœ¨å·²å­˜åœ¨çš„å®¹å™¨ä¸Šè¿è¡Œå‘½ä»¤</td>
</tr>
<tr>
<td>export</td>
<td>å¯¼å‡ºå®¹å™¨çš„å†…å®¹æµä½œä¸ºä¸€ä¸ª tar å½’æ¡£æ–‡ä»¶ [å¯¹åº” import ]</td>
</tr>
<tr>
<td>history</td>
<td>å±•ç¤ºä¸€ä¸ªé•œåƒå½¢æˆå†å²</td>
</tr>
<tr>
<td>images</td>
<td>åˆ—å‡ºç³»ç»Ÿå½“å‰é•œåƒ</td>
</tr>
<tr>
<td>import</td>
<td>ä» tar åŒ…ä¸­çš„å†…å®¹åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶ç³»ç»Ÿæ˜ åƒ [å¯¹åº”export]</td>
</tr>
<tr>
<td>info</td>
<td>æ˜¾ç¤ºç³»ç»Ÿç›¸å…³ä¿¡æ¯</td>
</tr>
<tr>
<td>inspect</td>
<td>æŸ¥çœ‹å®¹å™¨è¯¦ç»†ä¿¡æ¯</td>
</tr>
<tr>
<td>kill</td>
<td>kill æŒ‡å®š docker å®¹å™¨</td>
</tr>
<tr>
<td>load</td>
<td>ä»ä¸€ä¸ª tar åŒ…ä¸­åŠ è½½ä¸€ä¸ªé•œåƒ [å¯¹åº” save]</td>
</tr>
<tr>
<td>login</td>
<td>æ³¨å†Œæˆ–è€…ç™»é™†ä¸€ä¸ª docker æºæœåŠ¡å™¨</td>
</tr>
<tr>
<td>logout</td>
<td>ä»å½“å‰ Docker registry é€€å‡º</td>
</tr>
<tr>
<td>logs</td>
<td>è¾“å‡ºå½“å‰å®¹å™¨æ—¥å¿—ä¿¡æ¯</td>
</tr>
<tr>
<td>port</td>
<td>æŸ¥çœ‹æ˜ å°„ç«¯å£å¯¹åº”çš„å®¹å™¨å†…éƒ¨æºç«¯å£</td>
</tr>
<tr>
<td>pause</td>
<td>æš‚åœå®¹å™¨</td>
</tr>
<tr>
<td>ps</td>
<td>åˆ—å‡ºå®¹å™¨åˆ—è¡¨</td>
</tr>
<tr>
<td>pull</td>
<td>ä» docker é•œåƒæºæœåŠ¡å™¨æ‹‰å–æŒ‡å®šé•œåƒæˆ–è€…åº“é•œåƒ</td>
</tr>
<tr>
<td>push</td>
<td>æ¨é€æŒ‡å®šé•œåƒæˆ–è€…åº“é•œåƒè‡³ docker æºæœåŠ¡å™¨</td>
</tr>
<tr>
<td>restart</td>
<td>é‡å¯è¿è¡Œçš„å®¹å™¨</td>
</tr>
<tr>
<td>rm</td>
<td>ç§»é™¤ä¸€ä¸ªæˆ–è€…å¤šä¸ªå®¹å™¨</td>
</tr>
<tr>
<td>rmi</td>
<td>ç§»é™¤ä¸€ä¸ªæˆ–å¤šä¸ªé•œåƒ[æ— å®¹å™¨ä½¿ç”¨è¯¥é•œåƒæ‰å¯åˆ é™¤ï¼Œå¦åˆ™éœ€åˆ é™¤ç›¸å…³å®¹å™¨æ‰å¯ç»§ç»­æˆ– -f å¼ºåˆ¶åˆ é™¤]</td>
</tr>
<tr>
<td>run</td>
<td>åˆ›å»ºä¸€ä¸ªæ–°çš„å®¹å™¨å¹¶è¿è¡Œä¸€ä¸ªå‘½ä»¤</td>
</tr>
<tr>
<td>save</td>
<td>ä¿å­˜ä¸€ä¸ªé•œåƒä¸ºä¸€ä¸ª tar åŒ… [å¯¹åº” load]</td>
</tr>
<tr>
<td>search</td>
<td>åœ¨ docker hub ä¸­æœç´¢é•œåƒ</td>
</tr>
<tr>
<td>start</td>
<td>å¯åŠ¨å®¹å™¨</td>
</tr>
<tr>
<td>stop</td>
<td>åœæ­¢å®¹å™¨</td>
</tr>
<tr>
<td>tag</td>
<td>ç»™æºä¸­é•œåƒæ‰“æ ‡ç­¾</td>
</tr>
<tr>
<td>top</td>
<td>æŸ¥çœ‹å®¹å™¨ä¸­è¿è¡Œçš„è¿›ç¨‹ä¿¡æ¯</td>
</tr>
<tr>
<td>unpause</td>
<td>å–æ¶ˆæš‚åœå®¹å™¨</td>
</tr>
<tr>
<td>version</td>
<td>æŸ¥çœ‹ docker ç‰ˆæœ¬å·</td>
</tr>
<tr>
<td>wait</td>
<td>æˆªå–å®¹å™¨åœæ­¢æ—¶çš„é€€å‡ºçŠ¶æ€å€¼</td>
</tr>
</tbody></table>
<h2 id="Docker-é•œåƒ"><a href="#Docker-é•œåƒ" class="headerlink" title="Docker é•œåƒ"></a>Docker é•œåƒ</h2><h3 id="é•œåƒ"><a href="#é•œåƒ" class="headerlink" title="é•œåƒ"></a>é•œåƒ</h3><p>â€‹		æ˜¯ä¸€ç§è½»é‡çº§ã€å¯æ‰§è¡Œçš„ç‹¬ç«‹è½¯ä»¶åŒ…ï¼Œå®ƒåŒ…å«è¿è¡ŒæŸä¸ªè½¯ä»¶æ‰€éœ€çš„æ‰€æœ‰å†…å®¹ï¼Œæˆ‘ä»¬æŠŠåº”ç”¨ç¨‹åºå’Œé…ç½®ä¾èµ–æ‰“åŒ…å¥½å½¢æˆä¸€ä¸ªå¯äº¤ä»˜çš„è¿è¡Œç¯å¢ƒï¼ˆåŒ…æ‹¬ä»£ç ã€è¿è¡Œæ—¶éœ€è¦çš„åº“ã€ç¯å¢ƒå˜é‡å’Œé…ç½®æ–‡ä»¶ç­‰ï¼‰ï¼Œè¿™ä¸ªæ‰“åŒ…å¥½çš„è¿è¡Œç¯å¢ƒå°±æ˜¯ image é•œåƒæ–‡ä»¶ã€‚</p>
<h3 id="Docker-é•œåƒ-1"><a href="#Docker-é•œåƒ-1" class="headerlink" title="Docker é•œåƒ"></a>Docker é•œåƒ</h3><p>Docker é•œåƒçš„åŸºç¡€æ˜¯ UnionFSï¼ˆè”åˆæ–‡ä»¶ç³»ç»Ÿï¼‰ï¼ŒUnionæ–‡ä»¶ç³»ç»Ÿï¼ˆUnionFSï¼‰æ˜¯ä¸€ç§åˆ†å±‚ã€è½»é‡çº§å¹¶ä¸”é«˜æ€§èƒ½çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒæ”¯æŒå¯¹æ–‡ä»¶ç³»ç»Ÿçš„ä¿®æ”¹ä½œä¸ºä¸€æ¬¡æäº¤æ¥ä¸€å±‚å±‚çš„å åŠ ï¼ŒåŒæ—¶å¯ä»¥å°†ä¸åŒç›®å½•æŒ‚è½½åˆ°åŒä¸€ä¸ªè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿä¸‹ï¼ˆunite several directories into a single virtual filesystemï¼‰ï¼›é•œåƒå¯ä»¥é€šè¿‡åˆ†å±‚æ¥è¿›è¡Œç»§æ‰¿ï¼ŒåŸºäºåŸºç¡€é•œåƒï¼ˆæ²¡æœ‰çˆ¶é•œåƒï¼‰ï¼Œå¯ä»¥åˆ¶ä½œå„ç§å…·ä½“çš„åº”ç”¨é•œåƒã€‚</p>
<p>UnionFS çš„ç‰¹æ€§ï¼šä¸€æ¬¡åŒæ—¶åŠ è½½å¤šä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œä½†ä»å¤–é¢çœ‹èµ·æ¥ï¼Œåªèƒ½çœ‹åˆ°ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œè”åˆåŠ è½½ä¼šæŠŠå„å±‚æ–‡ä»¶ç³»ç»Ÿå åŠ èµ·æ¥ï¼Œè¿™æ ·æœ€ç»ˆçš„æ–‡ä»¶ç³»ç»Ÿä¼šåŒ…å«æ‰€æœ‰åº•å±‚çš„æ–‡ä»¶å’Œç›®å½•</p>
<p>åˆ†å±‚çš„é•œåƒï¼šå¦‚æ‹‰å– tomcatï¼ŒæœŸé—´ä¼šæ‹‰å–å¤šä¸ªé•œåƒ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]# docker pull tomcat</span><br><span class="line">Using default tag: latest</span><br><span class="line">latest: Pulling from library/tomcat</span><br><span class="line">latest: Pulling from library/tomcat</span><br><span class="line">74ac377868f8: Pull complete</span><br><span class="line">a182a611d05b: Pull complete</span><br><span class="line">ad4fe29a3001: Pull complete</span><br><span class="line">9d52462c5181: Pull complete</span><br><span class="line">ac04a5bb8dd2: Pull complete</span><br><span class="line">9477858ddf22: Pull complete</span><br><span class="line">cc2062ac4c6a: Pull complete</span><br><span class="line">Digest: sha256:7e4f2ad5dd9a6c80990aa89c882148c3497dc1ddd5b8ac1724f759686d40b25c</span><br><span class="line">Status: Downloaded newer image for tomcat:latest</span><br><span class="line">docker.io/library/tomcat:latest</span><br><span class="line">[root@localhost opt]#</span><br></pre></td></tr></table></figure>

<p><strong>Docker é•œåƒåŠ è½½åŸç†</strong></p>
<p>Docker çš„é•œåƒå®é™…ä¸Šç”±ä¸€å±‚ä¸€å±‚çš„æ–‡ä»¶ç³»ç»Ÿç»„æˆï¼Œè¿™ç§å±‚çº§çš„æ–‡ä»¶ç³»ç»Ÿ UnionFSã€‚<br>bootfsï¼ˆboot file systemï¼‰ä¸»è¦åŒ…å« bootloader å’Œ kernel, bootloader ä¸»è¦æ˜¯å¼•å¯¼åŠ è½½ kernel, Linux åˆšå¯åŠ¨æ—¶ä¼šåŠ è½½bootfs æ–‡ä»¶ç³»ç»Ÿï¼Œåœ¨ Docker é•œåƒçš„æœ€åº•å±‚æ˜¯å¼•å¯¼æ–‡ä»¶ç³»ç»Ÿ bootfsã€‚è¿™ä¸€å±‚ä¸æˆ‘ä»¬å…¸å‹çš„ Linux&#x2F;Unix ç³»ç»Ÿæ˜¯ä¸€æ ·çš„ï¼ŒåŒ…å« boot åŠ è½½å™¨å’Œå†…æ ¸ã€‚å½“ boot åŠ è½½å®Œæˆä¹‹åæ•´ä¸ªå†…æ ¸å°±éƒ½åœ¨å†…å­˜ä¸­äº†ï¼Œæ­¤æ—¶å†…å­˜çš„ä½¿ç”¨æƒå·²ç”± bootfs è½¬äº¤ç»™å†…æ ¸ï¼Œæ­¤æ—¶ç³»ç»Ÿä¹Ÿä¼šå¸è½½ bootfsã€‚</p>
<p>rootfs (root file system) ï¼Œåœ¨bootfsä¹‹ä¸Šã€‚åŒ…å«çš„å°±æ˜¯å…¸å‹ Linux ç³»ç»Ÿä¸­çš„ &#x2F;dev, &#x2F;proc, &#x2F;bin, &#x2F;etc ç­‰æ ‡å‡†ç›®å½•å’Œæ–‡ä»¶ã€‚rootfs å°±æ˜¯å„ç§ä¸åŒçš„æ“ä½œç³»ç»Ÿå‘è¡Œç‰ˆï¼Œæ¯”å¦‚ Ubuntuï¼ŒCentOS ç­‰ã€‚ </p>
<p><img src="/2023/03/27/Docker/%E9%95%9C%E5%83%8F%E5%8A%A0%E8%BD%BD%E5%8E%9F%E7%90%86.png" alt="é•œåƒåŠ è½½åŸç†.png"></p>
<p>æ€è€ƒï¼šå®‰è£…è¿›è™šæ‹Ÿæœºçš„ CentOS éƒ½æ˜¯å¥½å‡ ä¸ª Gï¼Œä¸ºä»€ä¹ˆ Docker è¿™é‡Œæ‰ 200Mï¼Ÿ</p>
<p>å¯¹äºä¸€ä¸ªç²¾ç®€çš„ OSï¼Œrootfs å¯ä»¥å¾ˆå°ï¼Œåªéœ€è¦åŒ…æ‹¬æœ€åŸºæœ¬çš„å‘½ä»¤ã€å·¥å…·å’Œç¨‹åºåº“å°±å¯ä»¥äº†ï¼Œå› ä¸ºåº•å±‚ç›´æ¥ç”¨ Host çš„kernelï¼Œè‡ªå·±åªéœ€è¦æä¾› rootfs å°±è¡Œäº†ã€‚ç”±æ­¤å¯è§å¯¹äºä¸åŒçš„ linux å‘è¡Œç‰ˆ, bootfsåŸºæœ¬æ˜¯ä¸€è‡´çš„ï¼Œrootfs ä¼šæœ‰å·®åˆ«ï¼Œå› æ­¤ä¸åŒçš„å‘è¡Œç‰ˆå¯ä»¥å…¬ç”¨ bootfsã€‚</p>
<p><strong>é•œåƒåˆ†å±‚çš„å¥½å¤„ï¼š</strong></p>
<p>é•œåƒåˆ†å±‚æœ€å¤§çš„ä¸€ä¸ªå¥½å¤„å°±æ˜¯å…±äº«èµ„æºï¼Œæ–¹ä¾¿å¤åˆ¶è¿ç§»ï¼Œå°±æ˜¯ä¸ºäº†å¤ç”¨ã€‚</p>
<p>æ¯”å¦‚è¯´æœ‰å¤šä¸ªé•œåƒéƒ½ä»ç›¸åŒçš„ base é•œåƒæ„å»ºè€Œæ¥ï¼Œé‚£ä¹ˆ Docker Host åªéœ€åœ¨ç£ç›˜ä¸Šä¿å­˜ä¸€ä»½ base é•œåƒï¼›åŒæ—¶å†…å­˜ä¸­ä¹Ÿåªéœ€åŠ è½½ä¸€ä»½ base é•œåƒï¼Œå°±å¯ä»¥ä¸ºæ‰€æœ‰å®¹å™¨æœåŠ¡äº†ã€‚è€Œä¸”é•œåƒçš„æ¯ä¸€å±‚éƒ½å¯ä»¥è¢«å…±äº«ã€‚</p>
<p>Dockeré•œåƒå±‚éƒ½æ˜¯åªè¯»çš„ï¼Œå®¹å™¨å±‚æ˜¯å¯å†™çš„ï¼›å½“å®¹å™¨å¯åŠ¨æ—¶ï¼Œä¸€ä¸ªæ–°çš„å¯å†™å±‚è¢«åŠ è½½åˆ°é•œåƒçš„é¡¶éƒ¨ã€‚è¿™ä¸€å±‚é€šå¸¸è¢«ç§°ä½œ â€œå®¹å™¨å±‚â€ï¼Œâ€œå®¹å™¨å±‚â€ ä¹‹ä¸‹çš„éƒ½å« â€œé•œåƒå±‚â€ã€‚æ‰€æœ‰å¯¹å®¹å™¨çš„æ”¹åŠ¨ï¼šæ— è®ºæ·»åŠ ã€åˆ é™¤ã€è¿˜æ˜¯ä¿®æ”¹æ–‡ä»¶éƒ½åªä¼šå‘ç”Ÿåœ¨å®¹å™¨å±‚ä¸­ï¼Œåªæœ‰å®¹å™¨å±‚æ˜¯å¯å†™çš„ï¼Œå®¹å™¨å±‚ä¸‹é¢çš„æ‰€æœ‰é•œåƒå±‚éƒ½æ˜¯åªè¯»çš„ã€‚</p>
<p><img src="/2023/03/27/Docker/%E9%95%9C%E5%83%8F%E5%B1%82%E4%B8%8E%E5%AE%B9%E5%99%A8%E5%B1%82.png" alt="é•œåƒå±‚ä¸å®¹å™¨å±‚.png"></p>
<h3 id="æäº¤å®¹å™¨-docker-commit"><a href="#æäº¤å®¹å™¨-docker-commit" class="headerlink" title="æäº¤å®¹å™¨ docker commit"></a>æäº¤å®¹å™¨ docker commit</h3><ul>
<li>docker commitï¼šæäº¤å®¹å™¨å‰¯æœ¬ä½¿ä¹‹æˆä¸ºä¸€ä¸ªæ–°çš„é•œåƒ</li>
<li>docker commit -m&#x3D;â€æäº¤çš„æè¿°ä¿¡æ¯â€ -a&#x3D;â€ä½œè€…â€ å®¹å™¨ID è¦åˆ›å»ºçš„ç›®æ ‡é•œåƒå:[æ ‡ç­¾å]</li>
</ul>
<p>ç¤ºä¾‹ï¼šæ‹‰å–çš„ Ubuntu é»˜è®¤ä¸å®‰è£… Vimï¼Œè¿è¡Œå®¹å™¨ï¼Œå®‰è£… Vim ï¼Œæäº¤é•œåƒï¼Œè¿è¡Œæäº¤çš„é•œåƒæµ‹è¯• Vim</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]# docker images</span><br><span class="line">REPOSITORY    TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">tomcat        latest    608294908754   3 days ago      475MB</span><br><span class="line">ubuntu        latest    ba6acccedd29   17 months ago   72.8MB</span><br><span class="line">hello-world   latest    feb5d9fea6a5   18 months ago   13.3kB</span><br><span class="line">centos        latest    5d0da3dc9764   18 months ago   231MB</span><br><span class="line">[root@localhost opt]# docker run -it ubuntu</span><br><span class="line">root@f7a909fbc2be:/# vim</span><br><span class="line">bash: vim: command not found</span><br><span class="line">root@f7a909fbc2be:/# apt-get install -y vim</span><br><span class="line">Reading package lists... Done</span><br><span class="line">Building dependency tree</span><br><span class="line">Reading state information... Done</span><br><span class="line">E: Unable to locate package vim</span><br></pre></td></tr></table></figure>

<p>æ›´æ”¹ Ubuntu é•œåƒæºï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">root@f7a909fbc2be:/# mv /etc/apt/sources.list /etc/apt/sources.list.bak</span><br><span class="line">root@f7a909fbc2be:/# </span><br><span class="line">echo &quot;deb http://mirrors.aliyun.com/ubuntu/ trusty main restricted universe multiverse </span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ trusty-security main restricted universe multiverse </span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ trusty-updates main restricted universe multiverse </span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ trusty-proposed main restricted universe multiverse </span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ trusty-backports main restricted universe multiverse </span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ trusty main restricted universe multiverse </span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ trusty-security main restricted universe multiverse </span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ trusty-updates main restricted universe multiverse </span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ trusty-proposed main restricted universe multiverse </span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ trusty-backports main restricted universe multiverse&quot; &gt; /etc/apt/sources.list</span><br><span class="line">root@f7a909fbc2be:/# apt-get update</span><br><span class="line">Ign:1 http://mirrors.aliyun.com/ubuntu trusty InRelease</span><br><span class="line">Get:2 http://mirrors.aliyun.com/ubuntu trusty-security InRelease [56.4 kB]</span><br><span class="line">Get:3 http://mirrors.aliyun.com/ubuntu trusty-updates InRelease [56.4 kB]</span><br><span class="line">Get:4 http://mirrors.aliyun.com/ubuntu trusty-proposed InRelease [56.4 kB]</span><br><span class="line">Get:5 http://mirrors.aliyun.com/ubuntu trusty-backports InRelease [65.9 kB]</span><br><span class="line">Get:6 http://mirrors.aliyun.com/ubuntu trusty Release [58.5 kB]</span><br><span class="line">Get:7 http://mirrors.aliyun.com/ubuntu trusty-security/multiverse Sources [4253 B]</span><br><span class="line">Get:8 http://mirrors.aliyun.com/ubuntu trusty-security/universe Sources [188 kB]</span><br><span class="line">Get:9 http://mirrors.aliyun.com/ubuntu trusty-security/main Sources [314 kB]</span><br><span class="line">Get:10 http://mirrors.aliyun.com/ubuntu trusty-security/restricted Sources [7832 B]</span><br><span class="line">Get:11 http://mirrors.aliyun.com/ubuntu trusty-security/main amd64 Packages [1557 kB]</span><br><span class="line">Get:12 http://mirrors.aliyun.com/ubuntu trusty-security/universe amd64 Packages [529 kB]</span><br><span class="line">Get:13 http://mirrors.aliyun.com/ubuntu trusty-security/multiverse amd64 Packages [6133 B]</span><br><span class="line">Get:14 http://mirrors.aliyun.com/ubuntu trusty-security/restricted amd64 Packages [24.6 kB]</span><br><span class="line">Get:15 http://mirrors.aliyun.com/ubuntu trusty-updates/multiverse Sources [10.5 kB]</span><br><span class="line">Get:16 http://mirrors.aliyun.com/ubuntu trusty-updates/main Sources [809 kB]</span><br><span class="line">Get:17 http://mirrors.aliyun.com/ubuntu trusty Release.gpg [933 B]</span><br><span class="line"></span><br><span class="line">root@f7a909fbc2be:/# apt-get upgrade</span><br><span class="line">Reading package lists... Done</span><br><span class="line">Building dependency tree</span><br><span class="line">Reading state information... Done</span><br><span class="line">Calculating upgrade... Done</span><br><span class="line">0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å†æ¬¡å®‰è£… Vim</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@f7a909fbc2be:/# apt-get -y install vim</span><br><span class="line">Reading package lists... Done</span><br><span class="line">Building dependency tree</span><br><span class="line">Reading state information... Done</span><br><span class="line">Some packages could not be installed. This may mean that you have</span><br><span class="line">requested an impossible situation or if you are using the unstable</span><br><span class="line">distribution that some required packages have not yet been created</span><br><span class="line">or been moved out of Incoming.</span><br><span class="line">The following information may help to resolve the situation:</span><br><span class="line"></span><br><span class="line">The following packages have unmet dependencies:</span><br><span class="line"> vim : Depends: libpython2.7 (&gt;= 2.7) but it is not going to be installed</span><br><span class="line">       Depends: libtinfo5 but it is not going to be installed</span><br><span class="line">E: Unable to correct problems, you have held broken packages.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å‘ç°æŠ¥é”™ï¼šç¼ºå°‘ä¾èµ–åº“ï¼Œå…ˆå®‰è£…ä¾èµ–åº“ï¼šlibpython2.7 å’Œ libtinfo5</p>
<ul>
<li><p>å®‰è£… lintinfo5ï¼ŒæŒ‰ç…§æç¤ºè¾“å…¥  Yes, do as I say!</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">root@f7a909fbc2be:/# apt-get install libtinfo5</span><br><span class="line">Reading package lists... Done</span><br><span class="line">Building dependency tree</span><br><span class="line">Reading state information... Done</span><br><span class="line">The following additional packages will be installed:</span><br><span class="line">  multiarch-support</span><br><span class="line">The following packages will be REMOVED:</span><br><span class="line">  ncurses-base</span><br><span class="line">The following NEW packages will be installed:</span><br><span class="line">  libtinfo5 multiarch-support</span><br><span class="line">WARNING: The following essential packages will be removed.</span><br><span class="line">This should NOT be done unless you know exactly what you are doing!</span><br><span class="line">  ncurses-base</span><br><span class="line">0 upgraded, 2 newly installed, 1 to remove and 0 not upgraded.</span><br><span class="line">Need to get 79.5 kB of archives.</span><br><span class="line">After this operation, 301 kB of additional disk space will be used.</span><br><span class="line">You are about to do something potentially harmful.</span><br><span class="line">To continue type in the phrase &#x27;Yes, do as I say!&#x27;</span><br><span class="line"> ?] Yes, do as I say!</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>å®‰è£… python3.5ï¼ŒæŒ‰ç…§æç¤ºè¾“å…¥ Y</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root@f7a909fbc2be:/# apt-get install libpython3.5</span><br><span class="line">Reading package lists... Done</span><br><span class="line">Building dependency tree</span><br><span class="line">Reading state information... Done</span><br><span class="line">The following additional packages will be installed:</span><br><span class="line">  file libexpat1 libgpm2 libmagic1 libmpdec2 libncursesw5 libpython3.5-minimal libpython3.5-stdlib libreadline6</span><br><span class="line">  libsqlite3-0 libssl1.0.0 mime-support readline-common</span><br><span class="line">Suggested packages:</span><br><span class="line">  gpm</span><br><span class="line">The following NEW packages will be installed:</span><br><span class="line">  file libexpat1 libgpm2 libmagic1 libmpdec2 libncursesw5 libpython3.5 libpython3.5-minimal libpython3.5-stdlib</span><br><span class="line">  libreadline6 libsqlite3-0 libssl1.0.0 mime-support readline-common</span><br><span class="line">0 upgraded, 14 newly installed, 0 to remove and 0 not upgraded.</span><br><span class="line">Need to get 5829 kB of archives.</span><br><span class="line">After this operation, 26.9 MB of additional disk space will be used.</span><br><span class="line">Do you want to continue? [Y/n] Y</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>å†æ¬¡å®‰è£… Vim</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">root@f7a909fbc2be:/# apt-get install -y vim</span><br><span class="line">Reading package lists... Done</span><br><span class="line">Building dependency tree</span><br><span class="line">Reading state information... Done</span><br><span class="line">The following additional packages will be installed:</span><br><span class="line">  libffi6 libpython2.7 libpython2.7-minimal libpython2.7-stdlib vim-common vim-runtime</span><br><span class="line">Suggested packages:</span><br><span class="line">  ctags vim-doc vim-scripts</span><br><span class="line">The following NEW packages will be installed:</span><br><span class="line">  libffi6 libpython2.7 libpython2.7-minimal libpython2.7-stdlib vim vim-common vim-runtime</span><br><span class="line">0 upgraded, 7 newly installed, 0 to remove and 0 not upgraded.</span><br><span class="line">Need to get 9173 kB of archives.</span><br><span class="line">After this operation, 43.2 MB of additional disk space will be used.</span><br><span class="line">Get:1 http://mirrors.aliyun.com/ubuntu trusty-security/main amd64 libffi6 amd64 3.1~rc1+r3.0.13-12ubuntu0.2 [17.9 kB]</span><br><span class="line">Get:2 http://mirrors.aliyun.com/ubuntu trusty-security/main amd64 libpython2.7-minimal amd64 2.7.6-8ubuntu0.5 [308 kB]</span><br><span class="line">Get:3 http://mirrors.aliyun.com/ubuntu trusty-security/main amd64 libpython2.7-stdlib amd64 2.7.6-8ubuntu0.5 [1872 kB]</span><br><span class="line">Get:4 http://mirrors.aliyun.com/ubuntu trusty-security/main amd64 libpython2.7 amd64 2.7.6-8ubuntu0.5 [1041 kB]</span><br><span class="line">Get:5 http://mirrors.aliyun.com/ubuntu trusty-security/main amd64 vim-common amd64 2:7.4.052-1ubuntu3.1 [95.2 kB]</span><br><span class="line">Get:6 http://mirrors.aliyun.com/ubuntu trusty-security/main amd64 vim-runtime all 2:7.4.052-1ubuntu3.1 [4882 kB]</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<p>æäº¤é•œåƒï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>











<h2 id="Docker-å®¹å™¨æ•°æ®å·"><a href="#Docker-å®¹å™¨æ•°æ®å·" class="headerlink" title="Docker å®¹å™¨æ•°æ®å·"></a>Docker å®¹å™¨æ•°æ®å·</h2><h1 id="Docker-è½¯ä»¶å®‰è£…"><a href="#Docker-è½¯ä»¶å®‰è£…" class="headerlink" title="Docker è½¯ä»¶å®‰è£…"></a>Docker è½¯ä»¶å®‰è£…</h1>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/26/Dubbo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MineTing">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/26/Dubbo/" class="post-title-link" itemprop="url">Dubbo</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-26 00:00:00" itemprop="dateCreated datePublished" datetime="2023-03-26T00:00:00+08:00">2023-03-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-22 16:35:58" itemprop="dateModified" datetime="2023-03-22T16:35:58+08:00">2023-03-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <div align="center"><font size="70"><b>Dubbo</b></font></div>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/25/SpringCloud/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MineTing">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/25/SpringCloud/" class="post-title-link" itemprop="url">SpringCloud</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-25 00:00:00" itemprop="dateCreated datePublished" datetime="2023-03-25T00:00:00+08:00">2023-03-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-22 16:35:32" itemprop="dateModified" datetime="2023-03-22T16:35:32+08:00">2023-03-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <div align="center"><font size="70"><b>SpringCloud</b></font></div>

<h1 id="å¾®æœåŠ¡æ¦‚è¿°ä¸SpringCloud"><a href="#å¾®æœåŠ¡æ¦‚è¿°ä¸SpringCloud" class="headerlink" title="å¾®æœåŠ¡æ¦‚è¿°ä¸SpringCloud"></a>å¾®æœåŠ¡æ¦‚è¿°ä¸SpringCloud</h1><h2 id="å¾®æœåŠ¡ä¸å¾®æœåŠ¡æ¶æ„"><a href="#å¾®æœåŠ¡ä¸å¾®æœåŠ¡æ¶æ„" class="headerlink" title="å¾®æœåŠ¡ä¸å¾®æœåŠ¡æ¶æ„"></a>å¾®æœåŠ¡ä¸å¾®æœåŠ¡æ¶æ„</h2><h3 id="å¾®æœåŠ¡"><a href="#å¾®æœåŠ¡" class="headerlink" title="å¾®æœåŠ¡"></a>å¾®æœåŠ¡</h3><p>é©¬ä¸.ç¦å‹’ï¼ˆMartin Fowlerï¼‰å¯¹å¾®æœåŠ¡çš„æè¿°ï¼š<a target="_blank" rel="noopener" href="https://martinfowler.com/articles/microservices.html">https://martinfowler.com/articles/microservices.html</a></p>
<p>å¼ºè°ƒçš„æ˜¯æœåŠ¡çš„å¤§å°ï¼Œå®ƒå…³æ³¨çš„æ˜¯æŸä¸€ä¸ªç‚¹ï¼Œæ˜¯å…·ä½“è§£å†³æŸä¸€ä¸ªé—®é¢˜&#x2F;æä¾›è½åœ°å¯¹åº”æœåŠ¡çš„ä¸€ä¸ªæœåŠ¡åº”ç”¨ã€‚</p>
<blockquote>
<p>â€‹		å¾®æœåŠ¡æ¶æ„æ˜¯â¼€ç§æ¶æ„æ¨¡å¼ï¼Œå®ƒï¼Œ<mark>æå€¡å°†</mark>å•â¼€åº”â½¤ç¨‹åºåˆ’åˆ†æˆâ¼€ç»„â¼©çš„æœåŠ¡ï¼ŒæœåŠ¡ä¹‹é—´äº’ç›¸åè°ƒã€äº’ç›¸é…åˆï¼Œä¸ºâ½¤æˆ·æä¾›æœ€ç»ˆä»·å€¼ã€‚æ¯ä¸ªæœåŠ¡è¿â¾åœ¨å…¶ç‹¬â½´çš„è¿›ç¨‹ä¸­ï¼ŒæœåŠ¡ä¸æœåŠ¡é—´é‡‡â½¤è½»é‡çº§çš„é€šä¿¡æœºåˆ¶äº’ç›¸åä½œï¼ˆé€šå¸¸æ˜¯åŸºäºHTTPåè®®çš„RESTful APIï¼‰ã€‚æ¯ä¸ªæœåŠ¡éƒ½å›´ç»•ç€å…·ä½“ä¸šåŠ¡è¿›â¾æ„å»ºï¼Œå¹¶ä¸”èƒ½å¤Ÿè¢«ç‹¬â½´çš„éƒ¨ç½²åˆ°â½£äº§ç¯å¢ƒã€ç±»â½£äº§ç¯å¢ƒç­‰ã€‚å¦å¤–ï¼Œåº”å½“å°½é‡é¿å…ç»Ÿâ¼€çš„ã€é›†ä¸­å¼çš„æœåŠ¡ç®¡ç†æœºåˆ¶ï¼Œå¯¹å…·ä½“çš„â¼€ä¸ªæœåŠ¡â½½â¾”ï¼Œåº”æ ¹æ®ä¸šåŠ¡ä¸Šä¸‹â½‚ï¼Œé€‰æ‹©åˆé€‚çš„è¯­â¾”ã€â¼¯å…·å¯¹å…¶è¿›â¾æ„å»ºã€‚</p>
<p>æŠ€æœ¯è§’åº¦ç†è§£ï¼š</p>
<p>â€‹		å¾®æœåŠ¡åŒ–çš„æ ¸å¿ƒå°±æ˜¯å°†ä¼ ç»Ÿçš„ä¸€ç«™å¼åº”ç”¨ï¼Œæ ¹æ®ä¸šåŠ¡æ‹†åˆ†æˆä¸€ä¸ªä¸€ä¸ªçš„æœåŠ¡ï¼Œå½»åº•åœ°å»è€¦åˆï¼Œæ¯ä¸€ä¸ªå¾®æœåŠ¡æä¾›å•ä¸ªä¸šåŠ¡åŠŸèƒ½çš„æœåŠ¡ï¼Œä¸€ä¸ªæœåŠ¡åšä¸€ä»¶äº‹ï¼Œä»æŠ€æœ¯è§’åº¦çœ‹å°±æ˜¯ä¸€ç§å°è€Œç‹¬ç«‹çš„å¤„ç†è¿‡ç¨‹ï¼Œç±»ä¼¼è¿›ç¨‹æ¦‚å¿µï¼Œèƒ½å¤Ÿè‡ªè¡Œå•ç‹¬å¯åŠ¨æˆ–é”€æ¯ï¼Œæ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„æ•°æ®åº“ã€‚</p>
</blockquote>
<h3 id="å¾®æœåŠ¡çš„æŠ€æœ¯æ ˆ"><a href="#å¾®æœåŠ¡çš„æŠ€æœ¯æ ˆ" class="headerlink" title="å¾®æœåŠ¡çš„æŠ€æœ¯æ ˆ"></a>å¾®æœåŠ¡çš„æŠ€æœ¯æ ˆ</h3><h1 id="RestTemplateçš„ä½¿ç”¨"><a href="#RestTemplateçš„ä½¿ç”¨" class="headerlink" title="RestTemplateçš„ä½¿ç”¨"></a>RestTemplateçš„ä½¿ç”¨</h1><p>æ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/5.2.2.RELEASE/javadoc-api/org/springframework/web/client/RestTemplate.html">https://docs.spring.io/spring-framework/docs/5.2.2.RELEASE/javadoc-api/org/springframework/web/client/RestTemplate.html</a></p>
<p>Getè¯·æ±‚æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;T&gt; T <span class="title function_">getForObject</span><span class="params">(String url, Class&lt;T&gt; responseType, Object... uriVariables)</span>;</span><br><span class="line"> </span><br><span class="line">&lt;T&gt; T <span class="title function_">getForObject</span><span class="params">(String url, Class&lt;T&gt; responseType, Map&lt;String, ?&gt; uriVariables)</span>;</span><br><span class="line"> </span><br><span class="line">&lt;T&gt; T <span class="title function_">getForObject</span><span class="params">(URI url, Class&lt;T&gt; responseType)</span>;</span><br><span class="line"> </span><br><span class="line">&lt;T&gt; ResponseEntity&lt;T&gt; <span class="title function_">getForEntity</span><span class="params">(String url, Class&lt;T&gt; responseType, Object... uriVariables)</span>;</span><br><span class="line"> </span><br><span class="line">&lt;T&gt; ResponseEntity&lt;T&gt; <span class="title function_">getForEntity</span><span class="params">(String url, Class&lt;T&gt; responseType, Map&lt;String, ?&gt; uriVariables)</span>;</span><br><span class="line"> </span><br><span class="line">&lt;T&gt; ResponseEntity&lt;T&gt; <span class="title function_">getForEntity</span><span class="params">(URI var1, Class&lt;T&gt; responseType)</span>;</span><br></pre></td></tr></table></figure>

<p>Postè¯·æ±‚æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;T&gt; T <span class="title function_">postForObject</span><span class="params">(String url, <span class="meta">@Nullable</span> Object request, Class&lt;T&gt; responseType, Object... uriVariables)</span>;</span><br><span class="line"> </span><br><span class="line">&lt;T&gt; T <span class="title function_">postForObject</span><span class="params">(String url, <span class="meta">@Nullable</span> Object request, Class&lt;T&gt; responseType, Map&lt;String, ?&gt; uriVariables)</span>;</span><br><span class="line"> </span><br><span class="line">&lt;T&gt; T <span class="title function_">postForObject</span><span class="params">(URI url, <span class="meta">@Nullable</span> Object request, Class&lt;T&gt; responseType)</span>;</span><br><span class="line"> </span><br><span class="line">&lt;T&gt; ResponseEntity&lt;T&gt; <span class="title function_">postForEntity</span><span class="params">(String url, <span class="meta">@Nullable</span> Object request, Class&lt;T&gt; responseType, Object... uriVariables)</span>;</span><br><span class="line"> </span><br><span class="line">&lt;T&gt; ResponseEntity&lt;T&gt; <span class="title function_">postForEntity</span><span class="params">(String url, <span class="meta">@Nullable</span> Object request, Class&lt;T&gt; responseType, Map&lt;String, ?&gt; uriVariables)</span>;</span><br><span class="line"> </span><br><span class="line">&lt;T&gt; ResponseEntity&lt;T&gt; <span class="title function_">postForEntity</span><span class="params">(URI url, <span class="meta">@Nullable</span> Object request, Class&lt;T&gt; responseType)</span>;</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ï¼šgetForObjectæ–¹æ³•&#x2F;getForEntityæ–¹æ³•çš„åŒºåˆ«</p>
<blockquote>
<ol>
<li><p>getForObject() è¿”å›å¯¹è±¡ä¸ºå“åº”ä½“ä¸­æ•°æ®è½¬åŒ–æˆçš„å¯¹è±¡</p>
</li>
<li><p>getForEntity() è¿”å›å¯¹è±¡ä¸ºResponseEntityå¯¹è±¡ï¼ŒåŒ…å«äº†å“åº”ä¸­çš„ä¸€äº›é‡è¦ä¿¡æ¯ï¼Œæ¯”å¦‚å“åº”å¤´ã€å“åº”çŠ¶æ€ç ã€å“åº”ä½“ç­‰</p>
</li>
<li><p>ä½¿ç”¨ï¼š</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/consumer/payment/getForEntity/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title function_">getPaymentForEntityById</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">    ResponseEntity&lt;CommonResult&gt; entity =</span><br><span class="line">        restTemplate.getForEntity(</span><br><span class="line">        PAYMENT_INVOKE_URL + <span class="string">&quot;payment/get/&quot;</span> + id, CommonResult.class);</span><br><span class="line">    <span class="keyword">if</span> (entity.getStatusCode().is2xxSuccessful()) &#123;</span><br><span class="line">        <span class="keyword">return</span> entity.getBody();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>&lt;&gt;(<span class="number">40000</span>, <span class="string">&quot;failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/consumer/payment/createForEntity&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CommonResult&lt;Long&gt; <span class="title function_">postPaymentForEntity</span><span class="params">(Payment payment)</span> &#123;</span><br><span class="line">    ResponseEntity&lt;CommonResult&gt; entity =</span><br><span class="line">        restTemplate.postForEntity(</span><br><span class="line">        PAYMENT_INVOKE_URL + <span class="string">&quot;payment/create/&quot;</span>, payment, CommonResult.class);</span><br><span class="line">    <span class="keyword">if</span> (entity.getStatusCode().is2xxSuccessful()) &#123;</span><br><span class="line">        <span class="keyword">return</span> entity.getBody();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>&lt;&gt;(<span class="number">40000</span>, <span class="string">&quot;failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
</blockquote>
<h1 id="EurekaæœåŠ¡æ³¨å†Œä¸å‘ç°"><a href="#EurekaæœåŠ¡æ³¨å†Œä¸å‘ç°" class="headerlink" title="EurekaæœåŠ¡æ³¨å†Œä¸å‘ç°"></a>EurekaæœåŠ¡æ³¨å†Œä¸å‘ç°</h1><h2 id="æœåŠ¡æ²»ç†"><a href="#æœåŠ¡æ²»ç†" class="headerlink" title="æœåŠ¡æ²»ç†"></a>æœåŠ¡æ²»ç†</h2><p>æœåŠ¡æ²»ç†ï¼šç®¡ç†æœåŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚</p>
<blockquote>
<ol>
<li><p>Spring Cloud å°è£…äº† Netflix å…¬å¸å¼€å‘çš„ Eureka æ¨¡å—æ¥å®ç°æœåŠ¡æ²»ç†</p>
</li>
<li><p>åœ¨ä¼ ç»Ÿçš„rpcè¿œç¨‹è°ƒç”¨æ¡†æ¶ä¸­ï¼Œç®¡ç†æ¯ä¸ªæœåŠ¡ä¸æœåŠ¡ä¹‹é—´ä¾èµ–å…³ç³»æ¯”è¾ƒå¤æ‚ï¼Œç®¡ç†æ¯”è¾ƒå¤æ‚ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨æœåŠ¡æ²»ç†ï¼Œç®¡ç†æœåŠ¡äºæœåŠ¡ä¹‹é—´ä¾èµ–å…³ç³»ï¼Œå¯ä»¥å®ç°æœåŠ¡è°ƒç”¨ã€è´Ÿè½½å‡è¡¡ã€å®¹é”™ç­‰ï¼Œå®ç°æœåŠ¡å‘ç°ä¸æ³¨å†Œã€‚</p>
</li>
</ol>
</blockquote>
<h2 id="æœåŠ¡æ³¨å†Œä¸å‘ç°"><a href="#æœåŠ¡æ³¨å†Œä¸å‘ç°" class="headerlink" title="æœåŠ¡æ³¨å†Œä¸å‘ç°"></a>æœåŠ¡æ³¨å†Œä¸å‘ç°</h2><blockquote>
<ol>
<li>Eurekaé‡‡ç”¨äº†CSçš„è®¾è®¡æ¶æ„ï¼ŒEureka Server ä½œä¸ºæœåŠ¡æ³¨å†ŒåŠŸèƒ½çš„æœåŠ¡å™¨ï¼Œå®ƒæ˜¯æœåŠ¡æ³¨å†Œä¸­å¿ƒã€‚è€Œç³»ç»Ÿä¸­çš„å…¶ä»–å¾®æœåŠ¡ï¼Œä½¿ç”¨ Eurekaçš„å®¢æˆ·ç«¯è¿æ¥åˆ° Eureka Serverå¹¶ç»´æŒå¿ƒè·³è¿æ¥ã€‚è¿™æ ·ï¼Œç³»ç»Ÿçš„ç»´æŠ¤äººå‘˜å°±å¯ä»¥é€šè¿‡ Eureka Server æ¥ç›‘æ§ç³»ç»Ÿä¸­å„ä¸ªå¾®æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚</li>
<li>åœ¨æœåŠ¡æ³¨å†Œä¸å‘ç°ä¸­ï¼Œæœ‰ä¸€ä¸ªæ³¨å†Œä¸­å¿ƒã€‚å½“æœåŠ¡å™¨å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šæŠŠå½“å‰è‡ªå·±æœåŠ¡å™¨çš„ä¿¡æ¯æ¯”å¦‚ï¼šæœåŠ¡åœ°å€é€šè®¯åœ°å€ç­‰ä»¥åˆ«åæ–¹å¼æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒä¸Šã€‚å¦ä¸€æ–¹ï¼ˆæ¶ˆè´¹è€…æˆ–è€…æœåŠ¡æä¾›è€…ï¼‰ï¼Œä»¥è¯¥åˆ«åçš„æ–¹å¼å»æ³¨å†Œä¸­å¿ƒä¸Šè·å–åˆ°å®é™…çš„æœåŠ¡é€šè®¯åœ°å€ï¼Œç„¶åå†å®ç°æœ¬åœ°RPCè°ƒç”¨ã€‚</li>
<li>RPCè¿œç¨‹è°ƒç”¨æ¡†æ¶æ ¸å¿ƒè®¾è®¡æ€æƒ³ï¼šåœ¨äºæ³¨å†Œä¸­å¿ƒï¼Œå› ä¸ºä½¿ç”¨æ³¨å†Œä¸­å¿ƒç®¡ç†æ¯ä¸ªæœåŠ¡ä¸æœåŠ¡ä¹‹é—´çš„ä¸€ä¸ªä¾èµ–å…³ç³»ï¼ˆæœåŠ¡æ²»ç†æ¦‚å¿µï¼‰ã€‚åœ¨ä»»ä½•rpcè¿œç¨‹æ¡†æ¶ä¸­ï¼Œéƒ½ä¼šæœ‰ä¸€ä¸ªæ³¨å†Œä¸­å¿ƒã€å­˜æ”¾æœåŠ¡åœ°å€ç›¸å…³ä¿¡æ¯ã€‘</li>
</ol>
</blockquote>
<h2 id="EurekaServerä¸EurekaClient"><a href="#EurekaServerä¸EurekaClient" class="headerlink" title="EurekaServerä¸EurekaClient"></a>EurekaServerä¸EurekaClient</h2><blockquote>
<ol>
<li><p>EurekaåŒ…å«ä¸¤ä¸ªç»„ä»¶ï¼šEureka Serverå’ŒEureka Client</p>
</li>
<li><p>Eureka Serveræä¾›æœåŠ¡æ³¨å†ŒæœåŠ¡<br> å„ä¸ªå¾®æœåŠ¡èŠ‚ç‚¹é€šè¿‡é…ç½®å¯åŠ¨åï¼Œä¼šåœ¨EurekaServerä¸­è¿›è¡Œæ³¨å†Œï¼Œè¿™æ ·EurekaServerä¸­çš„æœåŠ¡æ³¨å†Œè¡¨ä¸­å°†ä¼šå­˜å‚¨æ‰€æœ‰å¯ç”¨æœåŠ¡èŠ‚ç‚¹çš„ä¿¡æ¯ï¼ŒæœåŠ¡èŠ‚ç‚¹çš„ä¿¡æ¯å¯ä»¥åœ¨ç•Œé¢ä¸­ç›´è§‚çœ‹åˆ°ã€‚</p>
</li>
<li><p>EurekaClienté€šè¿‡æ³¨å†Œä¸­å¿ƒè¿›è¡Œè®¿é—®<br> EurekaClientæ˜¯ä¸€ä¸ªJavaå®¢æˆ·ç«¯ï¼Œç”¨äºç®€åŒ–Eureka Serverçš„äº¤äº’ï¼Œå®¢æˆ·ç«¯åŒæ—¶ä¹Ÿå…·å¤‡ä¸€ä¸ªå†…ç½®çš„ã€ä½¿ç”¨è½®è¯¢(round-robin)è´Ÿè½½ç®—æ³•çš„è´Ÿè½½å‡è¡¡å™¨ã€‚</p>
</li>
<li><p>åœ¨åº”ç”¨å¯åŠ¨åï¼Œå°†ä¼šå‘Eureka Serverå‘é€å¿ƒè·³ï¼ˆé»˜è®¤å‘¨æœŸä¸º30ç§’ï¼‰ã€‚å¦‚æœEureka Serveråœ¨å¤šä¸ªå¿ƒè·³å‘¨æœŸå†…æ²¡æœ‰æ¥æ”¶åˆ°æŸä¸ªèŠ‚ç‚¹çš„å¿ƒè·³ï¼ŒEurekaServerå°†ä¼šä»æœåŠ¡æ³¨å†Œè¡¨ä¸­æŠŠè¿™ä¸ªæœåŠ¡èŠ‚ç‚¹ç§»é™¤ï¼ˆé»˜è®¤90ç§’ï¼‰</p>
</li>
</ol>
</blockquote>
<h2 id="æ­å»ºEurekaæœåŠ¡"><a href="#æ­å»ºEurekaæœåŠ¡" class="headerlink" title="æ­å»ºEurekaæœåŠ¡"></a>æ­å»ºEurekaæœåŠ¡</h2><h3 id="å•æœºç‰ˆ"><a href="#å•æœºç‰ˆ" class="headerlink" title="å•æœºç‰ˆ"></a>å•æœºç‰ˆ</h3><blockquote>
<p>ä¸»è¦æ­¥éª¤ï¼š</p>
<ol>
<li><p>ã€å¼•å…¥ä¾èµ–ï¼š<strong>spring-cloud-starter-netflix-eureka-server</strong>ã€‘</p>
</li>
<li><p>å¯åŠ¨ç±»æ·»åŠ  @EnableEurekaServer</p>
</li>
<li><p>é…ç½®ï¼š</p>
 <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7001</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="comment">#hostname: localhost #eurekaæœåŠ¡ç«¯çš„å®ä¾‹åç§°</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">eureka7001.com</span> <span class="comment">#eurekaæœåŠ¡ç«¯çš„å®ä¾‹åç§°</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment">#falseè¡¨ç¤ºä¸å‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œå½“å‰æœåŠ¡</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment">#falseè¡¨ç¤ºå½“å‰æœåŠ¡å°±æ˜¯æ³¨å†Œä¸­å¿ƒï¼Œä¸»è¦èŒè´£å°±æ˜¯ç»´æŠ¤æœåŠ¡å®ä¾‹ï¼Œå¹¶ä¸éœ€è¦å»æ£€ç´¢æœåŠ¡</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="comment">#è®¾ç½®ä¸Eureka Serveräº¤äº’çš„åœ°å€æŸ¥è¯¢æœåŠ¡å’Œæ³¨å†ŒæœåŠ¡éƒ½éœ€è¦ä¾èµ–è¿™ä¸ªåœ°å€</span></span><br><span class="line">      <span class="comment">#defaultZone: http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7002.com:7002/eureka/</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>è®¿é—®ï¼šlocalhost:7001</p>
</li>
</ol>
</blockquote>
<p>ç¬¬ä¸€æ­¥ï¼š&#x3D;&#x3D;æ–°&#x3D;&#x3D;<strong>å»ºå·¥ç¨‹</strong>ï¼šcloud-eureka-server7001</p>
<blockquote>
<p>åŒæ—¶æ·»åŠ åŸŸåæ˜ å°„ï¼Œ&#x3D;&#x3D;æ–¹ä¾¿æµ‹è¯•&#x3D;&#x3D;ï¼šC:\Windows\System32\drivers\etc\hosts</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1  eureka7001.com</span><br><span class="line">127.0.0.1  eureka7002.com</span><br><span class="line">127.0.0.1  eureka7003.com</span><br></pre></td></tr></table></figure>
</blockquote>
<p>ç¬¬äºŒæ­¥ï¼špom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸‰æ­¥ï¼š<mark>application.yml</mark></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7001</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="comment">#hostname: localhost #eurekaæœåŠ¡ç«¯çš„å®ä¾‹åç§°</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">eureka7001.com</span> <span class="comment">#eurekaæœåŠ¡ç«¯çš„å®ä¾‹åç§°</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment">#falseè¡¨ç¤ºä¸å‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œå½“å‰æœåŠ¡</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment">#falseè¡¨ç¤ºå½“å‰æœåŠ¡å°±æ˜¯æ³¨å†Œä¸­å¿ƒï¼Œä¸»è¦èŒè´£å°±æ˜¯ç»´æŠ¤æœåŠ¡å®ä¾‹ï¼Œå¹¶ä¸éœ€è¦å»æ£€ç´¢æœåŠ¡</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="comment">#è®¾ç½®ä¸Eureka Serveräº¤äº’çš„åœ°å€æŸ¥è¯¢æœåŠ¡å’Œæ³¨å†ŒæœåŠ¡éƒ½éœ€è¦ä¾èµ–è¿™ä¸ªåœ°å€</span></span><br><span class="line">      <span class="comment">#defaultZone: http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7002.com:7002/eureka/</span></span><br></pre></td></tr></table></figure>

<p>ç¬¬å››æ­¥ï¼šè®¿é—® <a target="_blank" rel="noopener" href="http://localhost:7001/">http://localhost:7001/</a></p>
<h3 id="é›†ç¾¤ç‰ˆ"><a href="#é›†ç¾¤ç‰ˆ" class="headerlink" title="é›†ç¾¤ç‰ˆ"></a>é›†ç¾¤ç‰ˆ</h3><p>IDEAä¸­ï¼Œå¤åˆ¶cloud-eureka-server7001ä¸ºcloud-eureka-server7002</p>
<p>å¤åˆ¶å·¥ç¨‹éœ€è¦æ³¨æ„ï¼š</p>
<ol>
<li>åœ¨çˆ¶å·¥ç¨‹æ·»åŠ module</li>
<li>ä¿®æ”¹cloud-eureka-server7002çš„ ã€<artifactId><name><description>ã€‘</description></name></artifactId></li>
<li>ä¿®æ”¹ä¸»å¯åŠ¨ç±»</li>
<li>å¦‚æœæ¨¡å—æ˜¾ç¤ºæœ‰é—®é¢˜ï¼Œæ‰“å¼€å·¥ç¨‹ç»“æ„ï¼Œé‡æ–°å¼•å…¥ cloud-eureka-server7002å³å¯ã€‚</li>
</ol>
<blockquote>
<p>é›†ç¾¤ç‰ˆåªéœ€è¦ä¿®æ”¹ yml é…ç½®æ–‡ä»¶å³å¯ã€‚</p>
<p>service-urlåœ°å€ï¼šâ€œç›¸äº’å®ˆæœ›â€</p>
<p>cloud-eureka-server7001 çš„é…ç½®</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7001</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="comment">#hostname: localhost #eurekaæœåŠ¡ç«¯çš„å®ä¾‹åç§°</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">eureka7001.com</span> <span class="comment">#eurekaæœåŠ¡ç«¯çš„å®ä¾‹åç§°</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment">#falseè¡¨ç¤ºä¸å‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œå½“å‰æœåŠ¡</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment">#falseè¡¨ç¤ºå½“å‰æœåŠ¡å°±æ˜¯æ³¨å†Œä¸­å¿ƒï¼Œä¸»è¦èŒè´£å°±æ˜¯ç»´æŠ¤æœåŠ¡å®ä¾‹ï¼Œå¹¶ä¸éœ€è¦å»æ£€ç´¢æœåŠ¡</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="comment">#è®¾ç½®ä¸Eureka Serveräº¤äº’çš„åœ°å€æŸ¥è¯¢æœåŠ¡å’Œæ³¨å†ŒæœåŠ¡éƒ½éœ€è¦ä¾èµ–è¿™ä¸ªåœ°å€</span></span><br><span class="line">      <span class="comment">#defaultZone: http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7002.com:7002/eureka/</span></span><br></pre></td></tr></table></figure>

<p>cloud-eureka-server7002 çš„é…ç½®</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7002</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="comment">#hostname: localhost #eurekaæœåŠ¡ç«¯çš„å®ä¾‹åç§°</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">eureka7002.com</span> <span class="comment">#eurekaæœåŠ¡ç«¯çš„å®ä¾‹åç§°</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment">#falseè¡¨ç¤ºä¸å‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œè‡ªå·±</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment">#falseè¡¨ç¤ºè‡ªå·±ç«¯å°±æ˜¯æ³¨å†Œä¸­å¿ƒï¼Œæˆ‘çš„èŒè´£å°±æ˜¯ç»´æŠ¤æœåŠ¡å®ä¾‹ï¼Œå¹¶ä¸éœ€è¦å»æ£€ç´¢æœåŠ¡</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="comment">#è®¾ç½®ä¸Eureka Serveräº¤äº’çš„åœ°å€æŸ¥è¯¢æœåŠ¡å’Œæ³¨å†ŒæœåŠ¡éƒ½éœ€è¦ä¾èµ–è¿™ä¸ªåœ°å€</span></span><br><span class="line">      <span class="comment">#defaultZone: http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka/</span></span><br></pre></td></tr></table></figure>


</blockquote>
<h3 id="å…¶ä»–æœåŠ¡æ³¨å†Œè¿›Eureka"><a href="#å…¶ä»–æœåŠ¡æ³¨å†Œè¿›Eureka" class="headerlink" title="å…¶ä»–æœåŠ¡æ³¨å†Œè¿›Eureka"></a>å…¶ä»–æœåŠ¡æ³¨å†Œè¿›Eureka</h3><blockquote>
<p>ä¸»è¦æ­¥éª¤ï¼š</p>
<ol>
<li><p>ã€å¼•å…¥ä¾èµ–ï¼šspring-cloud-starter-netflix-eureka-clientã€‘</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>å¯åŠ¨ç±»æ·»åŠ  @EnableEurekaClient</p>
</li>
<li><p>ä¿®æ”¹application.ymlé…ç½®ï¼š</p>
 <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8001</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-payment-service</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.100.100:3306/springcloud?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:/mapper/*.xml</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.example.springcloud.entities</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetchRegistry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka</span></span><br></pre></td></tr></table></figure></li>
</ol>
</blockquote>
<h2 id="è´Ÿè½½å‡è¡¡"><a href="#è´Ÿè½½å‡è¡¡" class="headerlink" title="è´Ÿè½½å‡è¡¡"></a>è´Ÿè½½å‡è¡¡</h2><h3 id="æœåŠ¡æä¾›æ–¹æ­å»ºé›†ç¾¤"><a href="#æœåŠ¡æä¾›æ–¹æ­å»ºé›†ç¾¤" class="headerlink" title="æœåŠ¡æä¾›æ–¹æ­å»ºé›†ç¾¤"></a>æœåŠ¡æä¾›æ–¹æ­å»ºé›†ç¾¤</h3><p>ä¸ºäº†ä½“ç°è´Ÿè½½å‡è¡¡ï¼Œæ¯æ¬¡è®¿é—®ä½¿ç”¨ serverPort åŒºåˆ†ï¼Œä¿®æ”¹Paymentçš„Controllerï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverPort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PaymentService paymentService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult <span class="title function_">getPaymentById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">        <span class="type">Payment</span> <span class="variable">payment</span> <span class="operator">=</span> paymentService.getPaymentById(id);</span><br><span class="line">        <span class="keyword">if</span> (payment != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>(<span class="number">200</span>, <span class="string">&quot;success, serverPort: &quot;</span>+serverPort, payment);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>(<span class="number">40000</span>, <span class="string">&quot;failed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>å¤åˆ¶cloud-provider-payment8001å·¥ç¨‹ä¸ºcloud-provider-payment8002ã€‚</p>
<h3 id="æœåŠ¡è°ƒç”¨æ–¹ä¿®æ”¹"><a href="#æœåŠ¡è°ƒç”¨æ–¹ä¿®æ”¹" class="headerlink" title="æœåŠ¡è°ƒç”¨æ–¹ä¿®æ”¹"></a>æœåŠ¡è°ƒç”¨æ–¹ä¿®æ”¹</h3><blockquote>
<p>æ³¨æ„ï¼š</p>
<ol>
<li>æ­¤æ—¶åº”è¯¥é€šè¿‡æœåŠ¡åå»è°ƒç”¨æä¾›æ–¹æ¥å£</li>
<li>åŒæ—¶ï¼Œä½¿ç”¨@LoadBanlanceèµ‹äºˆRestTemplateè´Ÿè½½å‡è¡¡çš„èƒ½åŠ›</li>
</ol>
</blockquote>
<p>ä¿®æ”¹OrderControllerï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line">    <span class="comment">//private static final String PAYMENT_INVOKE_URL = &quot;http://localhost:8001/&quot;;</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PAYMENT_INVOKE_URL</span> <span class="operator">=</span> <span class="string">&quot;http://CLOUD-PAYMENT-SERVICE/&quot;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>åŒæ—¶ä¿®æ”¹ï¼šã€@LoadBalancedã€‘</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApplicationConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span> <span class="comment">// èµ‹äºˆRestTemplateè´Ÿè½½å‡è¡¡çš„èƒ½åŠ›</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœä¸åŠ @LoadBalancedï¼ŒæŠ¥é”™ï¼š</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Caused by: java.net.UnknownHostException: CLOUD-PAYMENT-SERVICE</span><br><span class="line">	at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:184)</span><br><span class="line">	at java.net.PlainSocketImpl.connect(PlainSocketImpl.java:172)</span><br><span class="line">	at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:392)</span><br><span class="line">	at java.net.Socket.connect(Socket.java:589)</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶ï¼ŒæœåŠ¡è°ƒç”¨æ–¹ä¼šé»˜è®¤è½®è¯¢è®¿é—®æœåŠ¡æä¾›æ–¹çš„æ¥å£ã€‚</p>
<h2 id="actuatorå¾®æœåŠ¡ä¿¡æ¯å®Œå–„"><a href="#actuatorå¾®æœåŠ¡ä¿¡æ¯å®Œå–„" class="headerlink" title="actuatorå¾®æœåŠ¡ä¿¡æ¯å®Œå–„"></a>actuatorå¾®æœåŠ¡ä¿¡æ¯å®Œå–„</h2><p>æ­¤æ—¶çš„é—®é¢˜ï¼š</p>
<p><img src="/2023/03/25/SpringCloud/Java\Document\SpringCloud\images\image-20221227160300345.png" alt="image-20221227160300345"></p>
<p>ä¿®æ”¹application.ymlï¼šã€å¢åŠ instance-idã€‘</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">payment8002</span>	<span class="comment">#æ˜¾ç¤ºæœåŠ¡å®ä¾‹åç§°</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span>     <span class="comment">#è®¿é—®è·¯å¾„å¯ä»¥æ˜¾ç¤ºIPåœ°å€</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetchRegistry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="æœåŠ¡å‘ç°"><a href="#æœåŠ¡å‘ç°" class="headerlink" title="æœåŠ¡å‘ç°"></a>æœåŠ¡å‘ç°</h2><p>â€‹		å¯¹äºæ³¨å†Œè¿›eurekaé‡Œé¢çš„å¾®æœåŠ¡ï¼Œå¯ä»¥é€šè¿‡æœåŠ¡å‘ç°æ¥è·å¾—è¯¥æœåŠ¡çš„ä¿¡æ¯ã€‚</p>
<blockquote>
<ol>
<li><p>ä¿®æ”¹ PaymentController</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br><span class="line">    </span><br><span class="line"><span class="meta">@GetMapping(&quot;/payment/discovery&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">discovery</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;String&gt; serviceList = discoveryClient.getServices();</span><br><span class="line">    serviceList.forEach(service -&gt; System.out.println(<span class="string">&quot;Service: &quot;</span> + service));</span><br><span class="line">    List&lt;ServiceInstance&gt; instanceList =</span><br><span class="line">            discoveryClient.getInstances(<span class="string">&quot;CLOUD-PAYMENT-SERVICE&quot;</span>);</span><br><span class="line">    instanceList.forEach(instance -&gt;</span><br><span class="line">            System.out.println(<span class="string">&quot;Instance: &quot;</span> + instance.getServiceId() + <span class="string">&quot;\t&quot;</span> + instance.getHost() + <span class="string">&quot;\t&quot;</span> + instance.getPort()));</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.discoveryClient;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¸»å¯åŠ¨ç±»æ·»åŠ æ³¨è§£ï¼š@EnableDiscoveryClient</p>
</li>
<li><p>æµ‹è¯•ï¼Œæ§åˆ¶å°è¾“å‡ºï¼š</p>
 <figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Service: cloud-order-service</span><br><span class="line">Service: cloud-payment-service</span><br><span class="line">Instance: CLOUD-PAYMENT-SERVICE	localhost	8001</span><br><span class="line">Instance: CLOUD-PAYMENT-SERVICE	localhost	8002</span><br></pre></td></tr></table></figure></li>
</ol>
</blockquote>
<h2 id="Eurekaè‡ªæˆ‘ä¿æŠ¤"><a href="#Eurekaè‡ªæˆ‘ä¿æŠ¤" class="headerlink" title="Eurekaè‡ªæˆ‘ä¿æŠ¤"></a>Eurekaè‡ªæˆ‘ä¿æŠ¤</h2><h3 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h3><blockquote>
<ol>
<li><p>ä¿æŠ¤æ¨¡å¼ä¸»è¦ç”¨äºä¸€ç»„å®¢æˆ·ç«¯å’ŒEureka Serverä¹‹é—´å­˜åœ¨ç½‘ç»œåˆ†åŒºåœºæ™¯ä¸‹çš„ä¿æŠ¤ã€‚ä¸€æ—¦è¿›å…¥ä¿æŠ¤æ¨¡å¼ï¼Œ<br> Eureka Serverå°†ä¼šå°è¯•ä¿æŠ¤å…¶æœåŠ¡æ³¨å†Œè¡¨ä¸­çš„ä¿¡æ¯ï¼Œä¸å†åˆ é™¤æœåŠ¡æ³¨å†Œè¡¨ä¸­çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ä¸ä¼šæ³¨é”€ä»»ä½•å¾®æœåŠ¡ã€‚</p>
</li>
<li><p>å¦‚æœåœ¨Eureka Serverçš„é¦–é¡µçœ‹åˆ°ä»¥ä¸‹è¿™æ®µæç¤ºï¼Œåˆ™è¯´æ˜Eurekaè¿›å…¥äº†ä¿æŠ¤æ¨¡å¼ï¼š<br> EMERGENCY! EUREKA MAY BE INCORRECTLY CLAIMING INSTANCES ARE UP WHEN THEYâ€™RE NOT.<br> RENEWALS ARE LESSER THAN THRESHOLD AND HENCE THE INSTANCES ARE NOT BEING EXPIRED JUST TO BE SAFE</p>
</li>
</ol>
</blockquote>
<h3 id="å¯¼è‡´åŸå› "><a href="#å¯¼è‡´åŸå› " class="headerlink" title="å¯¼è‡´åŸå› "></a>å¯¼è‡´åŸå› </h3><blockquote>
<ol>
<li>ä¸ºäº†é˜²æ­¢EurekaClientå¯ä»¥æ­£å¸¸è¿è¡Œï¼Œä½†æ˜¯ä¸ EurekaServerç½‘ç»œä¸é€šæƒ…å†µä¸‹ï¼ŒEurekaServerä¸ä¼šç«‹åˆ»å°†EurekaClientæœåŠ¡å‰”é™¤</li>
<li>è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ï¼š<br> é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœEurekaServeråœ¨ä¸€å®šæ—¶é—´å†…æ²¡æœ‰æ¥æ”¶åˆ°æŸä¸ªå¾®æœåŠ¡å®ä¾‹çš„å¿ƒè·³ï¼ŒEurekaServerå°†ä¼šæ³¨é”€è¯¥å®ä¾‹ï¼ˆé»˜è®¤90ç§’ï¼‰ã€‚ä½†æ˜¯å½“ç½‘ç»œåˆ†åŒºæ•…éšœå‘ç”Ÿï¼ˆå»¶æ—¶ã€å¡é¡¿ã€æ‹¥æŒ¤ï¼‰æ—¶ï¼Œå¾®æœåŠ¡ä¸EurekaServerä¹‹é—´æ— æ³•æ­£å¸¸é€šä¿¡ï¼Œä»¥ä¸Šè¡Œä¸ºå¯èƒ½å˜å¾—éå¸¸å±é™©äº†ï¼Œå› ä¸ºå¾®æœåŠ¡æœ¬èº«å…¶å®æ˜¯å¥åº·çš„ï¼Œæ­¤æ—¶æœ¬ä¸åº”è¯¥æ³¨é”€è¿™ä¸ªå¾®æœåŠ¡ã€‚</li>
<li>Eurekaé€šè¿‡â€œè‡ªæˆ‘ä¿æŠ¤æ¨¡å¼â€æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼šå½“EurekaServerèŠ‚ç‚¹åœ¨çŸ­æ—¶é—´å†…ä¸¢å¤±è¿‡å¤šå®¢æˆ·ç«¯æ—¶ï¼ˆå¯èƒ½å‘ç”Ÿäº†ç½‘ç»œåˆ†åŒºæ•…éšœï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ªèŠ‚ç‚¹å°±ä¼šè¿›å…¥è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ã€‚</li>
<li><strong>åœ¨è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ä¸­ï¼ŒEureka Serverä¼šä¿æŠ¤æœåŠ¡æ³¨å†Œè¡¨ä¸­çš„ä¿¡æ¯ï¼Œä¸å†æ³¨é”€ä»»ä½•æœåŠ¡å®ä¾‹ã€‚</strong></li>
<li>è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼æ˜¯ä¸€ç§åº”å¯¹ç½‘ç»œå¼‚å¸¸çš„å®‰å…¨ä¿æŠ¤æªæ–½ã€‚å®ƒçš„æ¶æ„å“²å­¦æ˜¯å®å¯åŒæ—¶ä¿ç•™æ‰€æœ‰å¾®æœåŠ¡ï¼ˆå¥åº·çš„å¾®æœåŠ¡å’Œä¸å¥åº·çš„å¾®æœåŠ¡éƒ½ä¼šä¿ç•™ï¼‰ä¹Ÿä¸ç›²ç›®æ³¨é”€ä»»ä½•å¥åº·çš„å¾®æœåŠ¡ã€‚ä½¿ç”¨è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ï¼Œå¯ä»¥è®©Eurekaé›†ç¾¤æ›´åŠ çš„å¥å£®ã€ç¨³å®šã€‚</li>
<li>å±äºCAPé‡Œé¢çš„APåˆ†æ”¯ã€‚</li>
</ol>
</blockquote>
<h3 id="ç¦æ­¢è‡ªæˆ‘ä¿æŠ¤"><a href="#ç¦æ­¢è‡ªæˆ‘ä¿æŠ¤" class="headerlink" title="ç¦æ­¢è‡ªæˆ‘ä¿æŠ¤"></a>ç¦æ­¢è‡ªæˆ‘ä¿æŠ¤</h3><ol>
<li><p>EurekaServerç«¯å…³é—­è‡ªæˆ‘ä¿æŠ¤ï¼š<strong>eureka.server.enable-self-preservation&#x3D;true</strong></p>
 <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="comment">#hostname: localhost #eurekaæœåŠ¡ç«¯çš„å®ä¾‹åç§°</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">eureka7001.com</span> <span class="comment">#eurekaæœåŠ¡ç«¯çš„å®ä¾‹åç§°</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment">#falseè¡¨ç¤ºä¸å‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œå½“å‰æœåŠ¡</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment">#falseè¡¨ç¤ºå½“å‰æœåŠ¡å°±æ˜¯æ³¨å†Œä¸­å¿ƒï¼Œä¸»è¦èŒè´£å°±æ˜¯ç»´æŠ¤æœåŠ¡å®ä¾‹ï¼Œå¹¶ä¸éœ€è¦å»æ£€ç´¢æœåŠ¡</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="comment">#è®¾ç½®ä¸Eureka Serveräº¤äº’çš„åœ°å€æŸ¥è¯¢æœåŠ¡å’Œæ³¨å†ŒæœåŠ¡éƒ½éœ€è¦ä¾èµ–è¿™ä¸ªåœ°å€</span></span><br><span class="line">      <span class="comment">#defaultZone: http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7002.com:7002/eureka/</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="comment">#å…³é—­è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ï¼Œä¿è¯ä¸å¯ç”¨æœåŠ¡è¢«åŠæ—¶è¸¢é™¤</span></span><br><span class="line">    <span class="attr">enable-self-preservation:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">eviction-interval-timer-in-ms:</span> <span class="number">2000</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>æµ‹è¯•ï¼šç”Ÿäº§è€…ç«¯</p>
<p> è®¾ç½® lease-renewal-interval-in-seconds å’Œ lease-expiration-duration-in-seconds</p>
 <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">payment8001</span></span><br><span class="line">    <span class="comment">#Eurekaå®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€å¿ƒè·³çš„æ—¶é—´é—´éš”ï¼Œå•ä½ä¸ºç§’(é»˜è®¤æ˜¯30ç§’)</span></span><br><span class="line">    <span class="attr">lease-renewal-interval-in-seconds:</span> <span class="number">1</span></span><br><span class="line">    <span class="comment">#EurekaæœåŠ¡ç«¯åœ¨æ”¶åˆ°æœ€åä¸€æ¬¡å¿ƒè·³åç­‰å¾…æ—¶é—´ä¸Šé™ï¼Œå•ä½ä¸ºç§’(é»˜è®¤æ˜¯90ç§’)ï¼Œè¶…æ—¶å°†å‰”é™¤æœåŠ¡</span></span><br><span class="line">    <span class="attr">lease-expiration-duration-in-seconds:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetchRegistry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka</span></span><br></pre></td></tr></table></figure>

<p> ç»“æœï¼šå½“å®ä¾‹ä¸å¯ç”¨æ—¶ï¼ŒEurekaä¼šç«‹å³å‰”é™¤è¯¥å®ä¾‹ã€‚</p>
</li>
</ol>
<h1 id="Ribbonè´Ÿè½½å‡è¡¡"><a href="#Ribbonè´Ÿè½½å‡è¡¡" class="headerlink" title="Ribbonè´Ÿè½½å‡è¡¡"></a>Ribbonè´Ÿè½½å‡è¡¡</h1><h2 id="æ¦‚è¿°-1"><a href="#æ¦‚è¿°-1" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p>æ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="https://github.com/Netflix/ribbon/wiki/Getting-Started">https://github.com/Netflix/ribbon/wiki/Getting-Started</a></p>
<blockquote>
<ol>
<li><p>Spring Cloud Ribbonæ˜¯åŸºäºNetflix Ribbonå®ç°çš„ä¸€å¥—å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡çš„å·¥å…·ã€‚</p>
</li>
<li><p>Ribbonæ˜¯Netflixå‘å¸ƒçš„å¼€æºé¡¹ç›®ï¼Œä¸»è¦åŠŸèƒ½æ˜¯æä¾›å®¢æˆ·ç«¯çš„è½¯ä»¶è´Ÿè½½å‡è¡¡ç®—æ³•å’ŒæœåŠ¡è°ƒç”¨ã€‚Ribbonå®¢æˆ·ç«¯ç»„ä»¶æä¾›ä¸€ç³»åˆ—å®Œå–„çš„é…ç½®é¡¹å¦‚è¿æ¥è¶…æ—¶ï¼Œé‡è¯•ç­‰ã€‚</p>
</li>
<li><p>ç®€å•çš„è¯´ï¼Œå°±æ˜¯åœ¨é…ç½®æ–‡ä»¶ä¸­åˆ—å‡ºLoad Balancerï¼ˆç®€ç§°LBï¼‰åé¢æ‰€æœ‰çš„æœºå™¨ï¼ŒRibbonä¼šè‡ªåŠ¨çš„å¸®åŠ©ä½ åŸºäºæŸç§è§„åˆ™ï¼ˆå¦‚ç®€å•è½®è¯¢ï¼Œéšæœºè¿æ¥ç­‰ï¼‰å»è¿æ¥è¿™äº›æœºå™¨ã€‚å¾ˆå®¹æ˜“ä½¿ç”¨Ribbonå®ç°è‡ªå®šä¹‰çš„è´Ÿè½½å‡è¡¡ç®—æ³•ã€‚</p>
</li>
</ol>
</blockquote>
<h2 id="è´Ÿè½½å‡è¡¡-1"><a href="#è´Ÿè½½å‡è¡¡-1" class="headerlink" title="è´Ÿè½½å‡è¡¡"></a>è´Ÿè½½å‡è¡¡</h2><blockquote>
<p>LBè´Ÿè½½å‡è¡¡ï¼ˆLoad Balanceï¼‰æ˜¯ä»€ä¹ˆï¼Ÿ<br>ç®€å•çš„è¯´å°±æ˜¯å°†ç”¨æˆ·çš„è¯·æ±‚å¹³æ‘Šçš„åˆ†é…åˆ°å¤šä¸ªæœåŠ¡ä¸Šï¼Œä»è€Œè¾¾åˆ°ç³»ç»Ÿçš„HAï¼ˆé«˜å¯ç”¨ï¼‰ã€‚<br>å¸¸è§çš„è´Ÿè½½å‡è¡¡æœ‰è½¯ä»¶Nginxï¼ŒLVSï¼Œç¡¬ä»¶ F5ç­‰ã€‚</p>
<p>Ribbonæœ¬åœ°è´Ÿè½½å‡è¡¡å®¢æˆ·ç«¯ ä¸NginxæœåŠ¡ç«¯è´Ÿè½½å‡è¡¡åŒºåˆ«ï¼š</p>
<ol>
<li>Nginxæ˜¯æœåŠ¡å™¨è´Ÿè½½å‡è¡¡ï¼Œå®¢æˆ·ç«¯æ‰€æœ‰è¯·æ±‚éƒ½ä¼šäº¤ç»™nginxï¼Œç„¶åç”±nginxå®ç°è½¬å‘è¯·æ±‚ã€‚å³è´Ÿè½½å‡è¡¡æ˜¯ç”±æœåŠ¡ç«¯å®ç°çš„ã€‚</li>
<li>Ribbonæœ¬åœ°è´Ÿè½½å‡è¡¡ï¼Œåœ¨è°ƒç”¨å¾®æœåŠ¡æ¥å£æ—¶å€™ï¼Œä¼šåœ¨æ³¨å†Œä¸­å¿ƒä¸Šè·å–æ³¨å†Œä¿¡æ¯æœåŠ¡åˆ—è¡¨ä¹‹åç¼“å­˜åˆ°JVMæœ¬åœ°ï¼Œä»è€Œåœ¨æœ¬åœ°å®ç°RPCè¿œç¨‹æœåŠ¡è°ƒç”¨æŠ€æœ¯ã€‚</li>
</ol>
</blockquote>
<blockquote>
<p>é›†ä¸­å¼LBï¼š</p>
<p>â€‹		å³åœ¨æœåŠ¡çš„æ¶ˆè´¹æ–¹å’Œæä¾›æ–¹ä¹‹é—´ä½¿ç”¨ç‹¬ç«‹çš„LBè®¾æ–½(å¯ä»¥æ˜¯ç¡¬ä»¶ï¼Œå¦‚F5, ä¹Ÿå¯ä»¥æ˜¯è½¯ä»¶ï¼Œå¦‚nginx), ç”±è¯¥è®¾æ–½è´Ÿè´£æŠŠè®¿é—®è¯·æ±‚é€šè¿‡æŸç§ç­–ç•¥è½¬å‘è‡³æœåŠ¡çš„æä¾›æ–¹ï¼›</p>
<p>è¿›ç¨‹å†…LB</p>
<p>â€‹		å°†LBé€»è¾‘é›†æˆåˆ°æ¶ˆè´¹æ–¹ï¼Œæ¶ˆè´¹æ–¹ä»æœåŠ¡æ³¨å†Œä¸­å¿ƒè·çŸ¥æœ‰å“ªäº›åœ°å€å¯ç”¨ï¼Œç„¶åè‡ªå·±å†ä»è¿™äº›åœ°å€ä¸­é€‰æ‹©å‡ºä¸€ä¸ªåˆé€‚çš„æœåŠ¡å™¨ã€‚<strong>Ribbonå°±å±äºè¿›ç¨‹å†…LBï¼Œå®ƒåªæ˜¯ä¸€ä¸ªç±»åº“ï¼Œé›†æˆäºæ¶ˆè´¹æ–¹è¿›ç¨‹ï¼Œæ¶ˆè´¹æ–¹é€šè¿‡å®ƒæ¥è·å–åˆ°æœåŠ¡æä¾›æ–¹çš„åœ°å€ã€‚</strong></p>
</blockquote>
<h2 id="Ribbonå·¥ä½œæµç¨‹"><a href="#Ribbonå·¥ä½œæµç¨‹" class="headerlink" title="Ribbonå·¥ä½œæµç¨‹"></a>Ribbonå·¥ä½œæµç¨‹</h2><blockquote>
<p>ç¬¬ä¸€æ­¥ï¼šå…ˆé€‰æ‹© EurekaServer ,å®ƒä¼˜å…ˆé€‰æ‹©åœ¨åŒä¸€ä¸ªåŒºåŸŸå†…è´Ÿè½½è¾ƒå°‘çš„server.<br>ç¬¬äºŒæ­¥ï¼šå†æ ¹æ®ç”¨æˆ·æŒ‡å®šçš„ç­–ç•¥ï¼Œåœ¨ä»serverå–åˆ°çš„æœåŠ¡æ³¨å†Œåˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªåœ°å€ã€‚<br>å…¶ä¸­Ribbonæä¾›äº†å¤šç§ç­–ç•¥ï¼šæ¯”å¦‚è½®è¯¢ã€éšæœºå’Œæ ¹æ®å“åº”æ—¶é—´åŠ æƒã€‚</p>
<img src="/2023/03/25/SpringCloud/Java\Document\SpringCloud\images\image-20221227195336909.png" alt="image-20221227195336909" style="zoom:80%;">
</blockquote>
<h2 id="Ribbonæ ¸å¿ƒç»„ä»¶IRule"><a href="#Ribbonæ ¸å¿ƒç»„ä»¶IRule" class="headerlink" title="Ribbonæ ¸å¿ƒç»„ä»¶IRule"></a>Ribbonæ ¸å¿ƒç»„ä»¶IRule</h2><p>IRuleï¼šæ ¹æ®ç‰¹å®šç®—æ³•ä¸­ä»æœåŠ¡åˆ—è¡¨ä¸­é€‰å–ä¸€ä¸ªè¦è®¿é—®çš„æœåŠ¡</p>
<blockquote>
<ol>
<li><p>com.netflix.loadbalancer.RoundRobinRule	è½®è¯¢</p>
</li>
<li><p>com.netflix.loadbalancer.RandomRule			éšæœº</p>
</li>
<li><p>com.netflix.loadbalancer.RetryRule</p>
<p> å…ˆæŒ‰ç…§RoundRobinRuleçš„ç­–ç•¥è·å–æœåŠ¡ï¼Œå¦‚æœè·å–æœåŠ¡å¤±è´¥åˆ™åœ¨æŒ‡å®šæ—¶é—´å†…ä¼šè¿›è¡Œé‡è¯•ï¼Œè·å–å¯ç”¨çš„æœåŠ¡</p>
</li>
<li><p>WeightedResponseTimeRule</p>
<p> å¯¹RoundRobinRuleçš„æ‰©å±•ï¼Œå“åº”é€Ÿåº¦è¶Šå¿«çš„å®ä¾‹é€‰æ‹©æƒé‡è¶Šå¤§ï¼Œè¶Šå®¹æ˜“è¢«é€‰æ‹©</p>
</li>
<li><p>BestAvailableRule</p>
<p> ä¼šå…ˆè¿‡æ»¤æ‰ç”±äºå¤šæ¬¡è®¿é—®æ•…éšœè€Œå¤„äºæ–­è·¯å™¨è·³é—¸çŠ¶æ€çš„æœåŠ¡ï¼Œç„¶åé€‰æ‹©ä¸€ä¸ªå¹¶å‘é‡æœ€å°çš„æœåŠ¡</p>
</li>
<li><p>AvailabilityFilteringRule         å…ˆè¿‡æ»¤æ‰æ•…éšœå®ä¾‹ï¼Œå†é€‰æ‹©å¹¶å‘è¾ƒå°çš„å®ä¾‹</p>
</li>
<li><p>ZoneAvoidanceRule          é»˜è®¤è§„åˆ™,å¤åˆåˆ¤æ–­serveræ‰€åœ¨åŒºåŸŸçš„æ€§èƒ½å’Œserverçš„å¯ç”¨æ€§é€‰æ‹©æœåŠ¡å™¨</p>
</li>
</ol>
<img src="/2023/03/25/SpringCloud/Java\Document\SpringCloud\images\image-20221227200708508.png" alt="image-20221227200708508" style="zoom:80%;">
</blockquote>
<h2 id="æ›¿æ¢é»˜è®¤è§„åˆ™"><a href="#æ›¿æ¢é»˜è®¤è§„åˆ™" class="headerlink" title="æ›¿æ¢é»˜è®¤è§„åˆ™"></a>æ›¿æ¢é»˜è®¤è§„åˆ™</h2><blockquote>
<p>ä¸»è¦æ­¥éª¤ï¼š</p>
<ol>
<li><p>è‡ªå®šä¹‰IRuleå®ç°ç±»ï¼Œä¸èƒ½æ”¾åœ¨@ComponentScanæ‰€æ‰«æçš„å½“å‰åŒ…ä¸‹ä»¥åŠå­åŒ…ä¸‹ã€‚</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.rule;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.netflix.loadbalancer.IRule;</span><br><span class="line"><span class="keyword">import</span> com.netflix.loadbalancer.RandomRule;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MySelfRule</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> IRule <span class="title function_">myRule</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RandomRule</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å¯åŠ¨ç±»æ·»åŠ æ³¨è§£ï¼š@RibbonClient</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@RibbonClient(name = &quot;CLOUD-PAYMENT-SERVICE&quot;, configuration = MyRule.class)</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsumerApplication80</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ConsumerApplication80.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
</blockquote>
<p>æ³¨æ„äº‹é¡¹ï¼š</p>
<blockquote>
<p>è‡ªå®šä¹‰é…ç½®ç±»ä¸èƒ½æ”¾åœ¨@ComponentScanæ‰€æ‰«æçš„å½“å‰åŒ…ä¸‹ä»¥åŠå­åŒ…ä¸‹ï¼Œå¦åˆ™è‡ªå®šä¹‰çš„è¿™ä¸ªé…ç½®ç±»å°±ä¼šè¢«æ‰€æœ‰çš„Ribbonå®¢æˆ·ç«¯æ‰€å…±äº«ï¼Œè¾¾ä¸åˆ°ç‰¹æ®ŠåŒ–å®šåˆ¶çš„ç›®çš„ã€‚</p>
<img src="/2023/03/25/SpringCloud/Java\Document\SpringCloud\images\image-20221227200919952.png" alt="image-20221227200919952" style="zoom:80%;">
</blockquote>
<h2 id="Ribbonè´Ÿè½½å‡è¡¡ç®—æ³•"><a href="#Ribbonè´Ÿè½½å‡è¡¡ç®—æ³•" class="headerlink" title="Ribbonè´Ÿè½½å‡è¡¡ç®—æ³•"></a>Ribbonè´Ÿè½½å‡è¡¡ç®—æ³•</h2><blockquote>
<p>è´Ÿè½½å‡è¡¡ç®—æ³•ï¼šrestæ¥å£ç¬¬å‡ æ¬¡è¯·æ±‚æ•° % æœåŠ¡å™¨é›†ç¾¤æ€»æ•°é‡ &#x3D; å®é™…è°ƒç”¨æœåŠ¡å™¨ä½ç½®ä¸‹æ ‡ ï¼Œæ¯æ¬¡æœåŠ¡é‡å¯åŠ¨årestæ¥å£è®¡æ•°ä»1å¼€å§‹ã€‚</p>
<p>List<ServiceInstance> instances &#x3D; discoveryClient.getInstances(â€œCLOUD-PAYMENT-SERVICEâ€);</ServiceInstance></p>
</blockquote>
<h3 id="RoundRobinRuleæºç "><a href="#RoundRobinRuleæºç " class="headerlink" title="RoundRobinRuleæºç "></a>RoundRobinRuleæºç </h3><p>IRuleæ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IRule</span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * choose one alive server from lb.allServers or</span></span><br><span class="line"><span class="comment">     * lb.upServers according to key</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @return choosen Server object. NULL is returned if none</span></span><br><span class="line"><span class="comment">     *  server is available </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Server <span class="title function_">choose</span><span class="params">(Object key)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLoadBalancer</span><span class="params">(ILoadBalancer lb)</span>;</span><br><span class="line">    <span class="keyword">public</span> ILoadBalancer <span class="title function_">getLoadBalancer</span><span class="params">()</span>;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RoundRobinRuleï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RoundRobinRule</span> <span class="keyword">extends</span> <span class="title class_">AbstractLoadBalancerRule</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AtomicInteger nextServerCyclicCounter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">AVAILABLE_ONLY_SERVERS</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">ALL_SERVERS</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(RoundRobinRule.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RoundRobinRule</span><span class="params">()</span> &#123;</span><br><span class="line">        nextServerCyclicCounter = <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RoundRobinRule</span><span class="params">(ILoadBalancer lb)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>();</span><br><span class="line">        setLoadBalancer(lb);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Server <span class="title function_">choose</span><span class="params">(ILoadBalancer lb, Object key)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (lb == <span class="literal">null</span>) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;no load balancer&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Server</span> <span class="variable">server</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (server == <span class="literal">null</span> &amp;&amp; count++ &lt; <span class="number">10</span>) &#123;</span><br><span class="line">            List&lt;Server&gt; reachableServers = lb.getReachableServers();</span><br><span class="line">            List&lt;Server&gt; allServers = lb.getAllServers();</span><br><span class="line">            <span class="type">int</span> <span class="variable">upCount</span> <span class="operator">=</span> reachableServers.size();</span><br><span class="line">            <span class="type">int</span> <span class="variable">serverCount</span> <span class="operator">=</span> allServers.size();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((upCount == <span class="number">0</span>) || (serverCount == <span class="number">0</span>)) &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;No up servers available from load balancer: &quot;</span> + lb);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> <span class="variable">nextServerIndex</span> <span class="operator">=</span> incrementAndGetModulo(serverCount);</span><br><span class="line">            server = allServers.get(nextServerIndex);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (server == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">/* Transient. */</span></span><br><span class="line">                Thread.<span class="keyword">yield</span>();</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (server.isAlive() &amp;&amp; (server.isReadyToServe())) &#123;</span><br><span class="line">                <span class="keyword">return</span> (server);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Next.</span></span><br><span class="line">            server = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (count &gt;= <span class="number">10</span>) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;No available alive servers after 10 tries from load balancer: &quot;</span>+ lb);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> server;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Inspired by the implementation of &#123;<span class="doctag">@link</span> AtomicInteger#incrementAndGet()&#125;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> modulo The modulo to bound the value of the counter.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> The next value.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">incrementAndGetModulo</span><span class="params">(<span class="type">int</span> modulo)</span> &#123;</span><br><span class="line">        <span class="comment">// è‡ªæ—‹é”</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">current</span> <span class="operator">=</span> nextServerCyclicCounter.get();</span><br><span class="line">            <span class="type">int</span> <span class="variable">next</span> <span class="operator">=</span> (current + <span class="number">1</span>) % modulo;</span><br><span class="line">            <span class="keyword">if</span> (nextServerCyclicCounter.compareAndSet(current, next))</span><br><span class="line">                <span class="keyword">return</span> next;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Server <span class="title function_">choose</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> choose(getLoadBalancer(), key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initWithNiwsConfig</span><span class="params">(IClientConfig clientConfig)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="æ‰‹åŠ¨å®ç°"><a href="#æ‰‹åŠ¨å®ç°" class="headerlink" title="æ‰‹åŠ¨å®ç°"></a>æ‰‹åŠ¨å®ç°</h3><p>å‡†å¤‡å·¥ä½œï¼š</p>
<ol>
<li><p>ä¿®æ”¹PaymentæœåŠ¡çš„Controllerï¼š</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(value = &quot;/payment/lb&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">getPaymentLB</span><span class="params">()</span>&#123;</span><br><span class="line">       <span class="keyword">return</span> serverPort;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ApplicationContextBeanå»æ‰æ³¨è§£@LoadBalancedï¼Œä¿è¯ç”Ÿæ•ˆçš„æ˜¯è‡ªå®šä¹‰çš„</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApplicationContextBean</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="comment">// èµ‹äºˆRestTemplateè´Ÿè½½å‡è¡¡çš„èƒ½åŠ›</span></span><br><span class="line">    <span class="comment">// @LoadBalanced</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>è‡ªå®šä¹‰LoadBalanceræ¥å£</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.springcloud.lb;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.ServiceInstance;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">LoadBalancer</span> &#123;</span><br><span class="line">    ServiceInstance <span class="title function_">instances</span><span class="params">(List&lt;ServiceInstance&gt; serviceInstances)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å®ç°ç±»</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.springcloud.lb;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.ServiceInstance;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomLoadBalancer</span> <span class="keyword">implements</span> <span class="title class_">LoadBalancer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">AtomicInteger</span> <span class="variable">atomicInteger</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndIncrement</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> current;</span><br><span class="line">        <span class="type">int</span> next;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            current = <span class="built_in">this</span>.atomicInteger.get();</span><br><span class="line">            next = current &gt;= <span class="number">2147483647</span> ? <span class="number">0</span> : current + <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">while</span> (!<span class="built_in">this</span>.atomicInteger.compareAndSet(current, next));</span><br><span class="line">        System.out.println(<span class="string">&quot;==========next: &quot;</span> + next);</span><br><span class="line">        <span class="keyword">return</span> next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ServiceInstance <span class="title function_">instances</span><span class="params">(List&lt;ServiceInstance&gt; serviceInstances)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> getAndIncrement() % serviceInstances.size();</span><br><span class="line">        <span class="keyword">return</span> serviceInstances.get(index);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>OrderControllerä¿®æ”¹</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> LoadBalancer loadBalancer;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/consumer/payment/lb&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPaymentLB</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;ServiceInstance&gt; instanceList =</span><br><span class="line">                discoveryClient.getInstances(<span class="string">&quot;CLOUD-PAYMENT-SERVICE&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (instanceList == <span class="literal">null</span> || instanceList.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">ServiceInstance</span> <span class="variable">serviceInstance</span> <span class="operator">=</span> loadBalancer.instances(instanceList);</span><br><span class="line">        <span class="type">URI</span> <span class="variable">uri</span> <span class="operator">=</span> serviceInstance.getUri();</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(uri + <span class="string">&quot;/payment/lb&quot;</span>, String.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æµ‹è¯•ï¼š<a target="_blank" rel="noopener" href="http://localhost/consumer/payment/lb">http://localhost/consumer/payment/lb</a></p>
</li>
</ol>
<h1 id="OpenFeignæœåŠ¡æ¥å£è°ƒç”¨"><a href="#OpenFeignæœåŠ¡æ¥å£è°ƒç”¨" class="headerlink" title="OpenFeignæœåŠ¡æ¥å£è°ƒç”¨"></a>OpenFeignæœåŠ¡æ¥å£è°ƒç”¨</h1><p>æ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-static/Hoxton.SR1/reference/htmlsingle/#spring-cloud-openfeign">https://cloud.spring.io/spring-cloud-static/Hoxton.SR1/reference/htmlsingle/#spring-cloud-openfeign</a></p>
<p>GitHubï¼š<a target="_blank" rel="noopener" href="https://github.com/spring-cloud/spring-cloud-openfeign">https://github.com/spring-cloud/spring-cloud-openfeign</a></p>
<h2 id="æ¦‚è¿°-2"><a href="#æ¦‚è¿°-2" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><blockquote>
<ol>
<li>Feignæ˜¯ä¸€ä¸ªå£°æ˜å¼WebServiceå®¢æˆ·ç«¯ã€‚ä½¿ç”¨Feignèƒ½è®©ç¼–å†™Web Serviceå®¢æˆ·ç«¯æ›´åŠ ç®€å•ã€‚</li>
<li>å®ƒçš„ä½¿ç”¨æ–¹æ³•æ˜¯å®šä¹‰ä¸€ä¸ªæœåŠ¡æ¥å£ç„¶ååœ¨ä¸Šé¢æ·»åŠ æ³¨è§£ã€‚Feignä¹Ÿæ”¯æŒå¯æ‹”æ’å¼çš„ç¼–ç å™¨å’Œè§£ç å™¨</li>
<li>Spring Cloudå¯¹Feignè¿›è¡Œäº†å°è£…ï¼Œä½¿å…¶æ”¯æŒäº†Spring MVCæ ‡å‡†æ³¨è§£å’ŒHttpMessageConverters</li>
<li>Feignå¯ä»¥ä¸Eurekaå’ŒRibbonç»„åˆä½¿ç”¨ä»¥æ”¯æŒè´Ÿè½½å‡è¡¡ã€‚</li>
</ol>
</blockquote>
<h2 id="ä½œç”¨"><a href="#ä½œç”¨" class="headerlink" title="ä½œç”¨"></a>ä½œç”¨</h2><blockquote>
<ol>
<li><p>Feignæ—¨åœ¨ä½¿ç¼–å†™Java Httpå®¢æˆ·ç«¯å˜å¾—æ›´å®¹æ˜“ã€‚åœ¨ä½¿ç”¨Ribbon+RestTemplateæ—¶ï¼Œåˆ©ç”¨RestTemplateå¯¹httpè¯·æ±‚çš„å°è£…å¤„ç†ï¼Œå½¢æˆäº†ä¸€å¥—æ¨¡ç‰ˆåŒ–çš„è°ƒç”¨æ–¹æ³•ã€‚ä½†æ˜¯åœ¨å®é™…å¼€å‘ä¸­ï¼Œç”±äºå¯¹æœåŠ¡ä¾èµ–çš„è°ƒç”¨å¯èƒ½ä¸æ­¢ä¸€å¤„ï¼Œå¾€å¾€ä¸€ä¸ªæ¥å£ä¼šè¢«å¤šå¤„è°ƒç”¨ï¼Œæ‰€ä»¥é€šå¸¸éƒ½ä¼šé’ˆå¯¹æ¯ä¸ªå¾®æœåŠ¡è‡ªè¡Œå°è£…ä¸€äº›å®¢æˆ·ç«¯ç±»æ¥åŒ…è£…è¿™äº›ä¾èµ–æœåŠ¡çš„è°ƒç”¨ã€‚æ‰€ä»¥ï¼ŒFeignåœ¨æ­¤åŸºç¡€ä¸Šåšäº†è¿›ä¸€æ­¥å°è£…ï¼Œç”±å®ƒæ¥å¸®åŠ©æˆ‘ä»¬å®šä¹‰å’Œå®ç°ä¾èµ–æœåŠ¡æ¥å£çš„å®šä¹‰ã€‚</p>
</li>
<li><p>åœ¨Feignçš„å®ç°ä¸‹ï¼Œæˆ‘ä»¬åªéœ€åˆ›å»ºä¸€ä¸ªæ¥å£å¹¶ä½¿ç”¨æ³¨è§£çš„æ–¹å¼æ¥é…ç½®å®ƒï¼Œå³å¯å®Œæˆå¯¹æœåŠ¡æä¾›æ–¹çš„æ¥å£ç»‘å®šï¼Œç®€åŒ–äº†ä½¿ç”¨Spring cloud Ribbonæ—¶ï¼Œè‡ªåŠ¨å°è£…æœåŠ¡è°ƒç”¨å®¢æˆ·ç«¯çš„å¼€å‘é‡ã€‚</p>
</li>
<li><p>Feigné›†æˆäº†Ribbon<br> åˆ©ç”¨Ribbonç»´æŠ¤äº†Paymentçš„æœåŠ¡åˆ—è¡¨ä¿¡æ¯ï¼Œå¹¶ä¸”é€šè¿‡è½®è¯¢å®ç°äº†å®¢æˆ·ç«¯çš„è´Ÿè½½å‡è¡¡ã€‚è€Œä¸Ribbonä¸åŒçš„æ˜¯ï¼Œé€šè¿‡feignåªéœ€è¦å®šä¹‰æœåŠ¡ç»‘å®šæ¥å£ä¸”ä»¥å£°æ˜å¼çš„æ–¹æ³•ï¼Œä¼˜é›…è€Œç®€å•çš„å®ç°äº†æœåŠ¡è°ƒç”¨ã€‚</p>
</li>
</ol>
</blockquote>
<h2 id="Feignå’ŒOpenFeignçš„åŒºåˆ«"><a href="#Feignå’ŒOpenFeignçš„åŒºåˆ«" class="headerlink" title="Feignå’ŒOpenFeignçš„åŒºåˆ«"></a>Feignå’ŒOpenFeignçš„åŒºåˆ«</h2><p>Feignï¼š</p>
<blockquote>
<p>Feignæ˜¯Spring Cloudç»„ä»¶ä¸­çš„ä¸€ä¸ªè½»é‡çº§RESTfulçš„HTTPæœåŠ¡å®¢æˆ·ç«¯<br>Feignå†…ç½®äº†Ribbonï¼Œç”¨æ¥åšå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ï¼Œå»è°ƒç”¨æœåŠ¡æ³¨å†Œä¸­å¿ƒçš„æœåŠ¡ã€‚Feignçš„ä½¿ç”¨æ–¹å¼æ˜¯ï¼šä½¿ç”¨Feignçš„æ³¨è§£å®šä¹‰æ¥å£ï¼Œè°ƒç”¨è¿™ä¸ªæ¥å£ï¼Œå°±å¯ä»¥è°ƒç”¨æœåŠ¡æ³¨å†Œä¸­å¿ƒçš„æœåŠ¡</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-feign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>OpenFeignï¼š</p>
<blockquote>
<ol>
<li>OpenFeignæ˜¯Spring Cloud åœ¨Feignçš„åŸºç¡€ä¸Šæ”¯æŒäº†SpringMVCçš„æ³¨è§£ï¼Œå¦‚@RequesMappingç­‰ã€‚</li>
<li>OpenFeignçš„@FeignClientå¯ä»¥è§£æSpringMVCçš„@RequestMappingæ³¨è§£ä¸‹çš„æ¥å£ï¼Œå¹¶é€šè¿‡åŠ¨æ€ä»£ç†çš„æ–¹å¼äº§ç”Ÿå®ç°ç±»ï¼Œå®ç°ç±»ä¸­åšè´Ÿè½½å‡è¡¡å¹¶è°ƒç”¨å…¶ä»–æœåŠ¡ã€‚</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="OpenFeignä½¿ç”¨æ­¥éª¤"><a href="#OpenFeignä½¿ç”¨æ­¥éª¤" class="headerlink" title="OpenFeignä½¿ç”¨æ­¥éª¤"></a>OpenFeignä½¿ç”¨æ­¥éª¤</h2><blockquote>
<p>ä¸»è¦æ­¥éª¤ï¼š</p>
<ol>
<li><p>å¼•å…¥ä¾èµ–</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¸»å¯åŠ¨ç±»æ·»åŠ æ³¨è§£@EnableFeignClients</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsumerApplication80</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ConsumerApplication80.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å®šä¹‰ä¸šåŠ¡é€»è¾‘æ¥å£å¹¶æ·»åŠ @FeignClientæ³¨è§£å’Œ@Componentæ³¨è§£</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;CLOUD-PAYMENT-SERVICE&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PaymentFeignService</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title function_">getPaymentById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>Controllerè°ƒç”¨</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderFeignController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> PaymentFeignService paymentFeignService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/consumer/payment/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title function_">getPaymentById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> paymentFeignService.getPaymentById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
</blockquote>
<p>ä½¿ç”¨ç¤ºä¾‹ï¼š</p>
<ol>
<li><p>å¤åˆ¶cloud-consumer-order80 å·¥ç¨‹ä¸º cloud-consumer-feign-order80</p>
</li>
<li><p>pom.xml</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¸»å¯åŠ¨ç±»æ·»åŠ æ³¨è§£@EnableFeignClients</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@EnableEurekaClient</span><br><span class="line">@SpringBootApplication</span><br><span class="line">@EnableFeignClients</span><br><span class="line">public class ConsumerApplication80 &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(ConsumerApplication80.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å®šä¹‰ä¸šåŠ¡é€»è¾‘æ¥å£å¹¶æ·»åŠ @FeignClientæ³¨è§£å’Œ@Componentæ³¨è§£</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;CLOUD-PAYMENT-SERVICE&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PaymentFeignService</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title function_">getPaymentById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Controllerè°ƒç”¨</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderFeignController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> PaymentFeignService paymentFeignService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/consumer/payment/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title function_">getPaymentById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> paymentFeignService.getPaymentById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>æ³¨æ„ï¼šFeignè‡ªå¸¦è´Ÿè½½å‡è¡¡é…ç½®é¡¹</p>
<h2 id="OpenFeignè¶…æ—¶æ§åˆ¶"><a href="#OpenFeignè¶…æ—¶æ§åˆ¶" class="headerlink" title="OpenFeignè¶…æ—¶æ§åˆ¶"></a>OpenFeignè¶…æ—¶æ§åˆ¶</h2><blockquote>
<p>é»˜è®¤Feignå®¢æˆ·ç«¯åªç­‰å¾…ä¸€ç§’é’Ÿï¼Œä½†æ˜¯æœåŠ¡ç«¯å¤„ç†éœ€è¦è¶…è¿‡1ç§’é’Ÿï¼Œå¯¼è‡´Feignå®¢æˆ·ç«¯ä¸æƒ³ç­‰å¾…äº†ï¼Œç›´æ¥è¿”å›æŠ¥é”™ã€‚ä¸ºäº†é¿å…è¿™æ ·çš„æƒ…å†µï¼Œéœ€è¦è®¾ç½®Feignå®¢æˆ·ç«¯çš„è¶…æ—¶æ§åˆ¶ã€‚</p>
<p>åœ¨ymlæ–‡ä»¶ä¸­å¼€å¯é…ç½®ï¼š</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è®¾ç½®feignå®¢æˆ·ç«¯è¶…æ—¶æ—¶é—´(OpenFeigné»˜è®¤æ”¯æŒribbon)</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">default:</span></span><br><span class="line">        <span class="comment">#æŒ‡çš„æ˜¯å»ºç«‹è¿æ¥åä»æœåŠ¡å™¨è¯»å–åˆ°å¯ç”¨èµ„æºæ‰€ç”¨çš„æ—¶é—´</span></span><br><span class="line">        <span class="attr">connect-timeout:</span> <span class="number">5000</span></span><br><span class="line">        <span class="comment">#æŒ‡çš„æ˜¯å»ºç«‹è¿æ¥æ‰€ç”¨çš„æ—¶é—´ï¼Œé€‚ç”¨äºç½‘ç»œçŠ¶å†µæ­£å¸¸çš„æƒ…å†µä¸‹,ä¸¤ç«¯è¿æ¥æ‰€ç”¨çš„æ—¶é—´</span></span><br><span class="line">        <span class="attr">read-timeout:</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>OpenFeignè¶…æ—¶æ§åˆ¶ç¤ºä¾‹ï¼š</p>
<ol>
<li><p>ä¿®æ”¹PaymentControllerï¼Œæ–°å¢è¶…æ—¶æ¥å£</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(value = &quot;/payment/feign/timeout&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">paymentFeignTimeOut</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;PaymentFeignTimeOut From Port: &quot;</span> + serverPort);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> serverPort;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æœåŠ¡è°ƒç”¨æ–¹å¢åŠ OpenFeignæ¥å£</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;CLOUD-PAYMENT-SERVICE&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PaymentFeignService</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title function_">getPaymentById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/payment/feign/timeout&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentFeignTimeOut</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>OrderFeignControllerå¢åŠ è¶…æ—¶æµ‹è¯•æ¥å£</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/consumer/payment/feign/timeout&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">paymentFeignTimeOut</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> paymentFeignService.paymentFeignTimeOut();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æµ‹è¯•ï¼š<a target="_blank" rel="noopener" href="http://localhost/consumer/payment/feign/timeout">http://localhost/consumer/payment/feign/timeout</a></p>
 <figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">#</span> æŠ¥é”™</span><br><span class="line">This application has no explicit mapping for /error, so you are seeing this as a fallback.</span><br><span class="line"></span><br><span class="line">Tue Dec 27 22:08:40 CST 2022</span><br><span class="line">There was an unexpected error (type=Internal Server Error, status=500).</span><br><span class="line">status 404 reading PaymentFeignService<span class="params">#</span>paymentFeignTimeOut()</span><br><span class="line">feign.FeignException<span class="built_in">$</span>NotFound: status 404 reading PaymentFeignService<span class="params">#</span>paymentFeignTimeOut()</span><br><span class="line">	at feign.FeignException.clientErrorStatus(FeignException.java:165)</span><br><span class="line">	at feign.FeignException.errorStatus(FeignException.java:141)</span><br><span class="line">	at feign.FeignException.errorStatus(FeignException.java:133)</span><br><span class="line">	at feign.codec.ErrorDecoder<span class="built_in">$</span>Default.decode(ErrorDecoder.java:92)</span><br></pre></td></tr></table></figure>
</li>
<li><p>è§£å†³æ–¹æ¡ˆï¼šä¿®æ”¹é…ç½®</p>
 <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è®¾ç½®feignå®¢æˆ·ç«¯è¶…æ—¶æ—¶é—´(OpenFeigné»˜è®¤æ”¯æŒribbon)</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">default:</span></span><br><span class="line">        <span class="comment">#æŒ‡çš„æ˜¯å»ºç«‹è¿æ¥åä»æœåŠ¡å™¨è¯»å–åˆ°å¯ç”¨èµ„æºæ‰€ç”¨çš„æ—¶é—´</span></span><br><span class="line">        <span class="attr">connect-timeout:</span> <span class="number">5000</span></span><br><span class="line">        <span class="comment">#æŒ‡çš„æ˜¯å»ºç«‹è¿æ¥æ‰€ç”¨çš„æ—¶é—´ï¼Œé€‚ç”¨äºç½‘ç»œçŠ¶å†µæ­£å¸¸çš„æƒ…å†µä¸‹,ä¸¤ç«¯è¿æ¥æ‰€ç”¨çš„æ—¶é—´</span></span><br><span class="line">        <span class="attr">read-timeout:</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="OpenFeignæ—¥å¿—æ‰“å°åŠŸèƒ½"><a href="#OpenFeignæ—¥å¿—æ‰“å°åŠŸèƒ½" class="headerlink" title="OpenFeignæ—¥å¿—æ‰“å°åŠŸèƒ½"></a>OpenFeignæ—¥å¿—æ‰“å°åŠŸèƒ½</h2><blockquote>
<p>Feign æä¾›äº†æ—¥å¿—æ‰“å°åŠŸèƒ½ï¼Œå¯ä»¥é€šè¿‡é…ç½®æ¥è°ƒæ•´æ—¥å¿—çº§åˆ«ï¼Œä»è€Œäº†è§£ Feign ä¸­ Http è¯·æ±‚çš„ç»†èŠ‚ã€‚<br>å³å¯¹Feignæ¥å£çš„è°ƒç”¨æƒ…å†µè¿›è¡Œç›‘æ§å’Œè¾“å‡º</p>
</blockquote>
<h3 id="æ—¥å¿—çº§åˆ«"><a href="#æ—¥å¿—çº§åˆ«" class="headerlink" title="æ—¥å¿—çº§åˆ«"></a>æ—¥å¿—çº§åˆ«</h3><blockquote>
<p>NONEï¼šé»˜è®¤çš„ï¼Œä¸æ˜¾ç¤ºä»»ä½•æ—¥å¿—ï¼›</p>
<p>BASICï¼šä»…è®°å½•è¯·æ±‚æ–¹æ³•ã€URLã€å“åº”çŠ¶æ€ç åŠæ‰§è¡Œæ—¶é—´ï¼›</p>
<p>HEADERSï¼šé™¤äº† BASIC ä¸­å®šä¹‰çš„ä¿¡æ¯ä¹‹å¤–ï¼Œè¿˜æœ‰è¯·æ±‚å’Œå“åº”çš„å¤´ä¿¡æ¯ï¼›</p>
<p>FULLï¼šé™¤äº† HEADERS ä¸­å®šä¹‰çš„ä¿¡æ¯ä¹‹å¤–ï¼Œè¿˜æœ‰è¯·æ±‚å’Œå“åº”çš„æ­£æ–‡åŠå…ƒæ•°æ®ã€‚</p>
</blockquote>
<h3 id="é…ç½®Feignæ—¥å¿—çº§åˆ«"><a href="#é…ç½®Feignæ—¥å¿—çº§åˆ«" class="headerlink" title="é…ç½®Feignæ—¥å¿—çº§åˆ«"></a>é…ç½®Feignæ—¥å¿—çº§åˆ«</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.springcloud.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> feign.Logger;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeignConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Logger.Level <span class="title function_">feignLevel</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Logger.Level.FULL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ï¼šåŒæ—¶å¼€å¯SpringBootå¯¹æ¥å£çš„æ—¥å¿—çº§åˆ«</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="comment"># feignæ—¥å¿—</span></span><br><span class="line">    <span class="attr">com.example.springcloud.openfeign.PaymentFeignService:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•ï¼šæ‰“å°æ—¥å¿—</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">...[PaymentFeignService<span class="params">#</span>paymentFeignTimeOut] ---&gt; GET http://CLOUD-PAYMENT-SERVICE/payment/feign/timeout HTTP/1.1</span><br><span class="line">...[PaymentFeignService<span class="params">#</span>paymentFeignTimeOut] ---&gt; END HTTP (0-byte body)</span><br><span class="line">...[PaymentFeignService<span class="params">#</span>paymentFeignTimeOut] &lt;--- HTTP/1.1 200 (3017ms)</span><br><span class="line">...[PaymentFeignService<span class="params">#</span>paymentFeignTimeOut] connection: keep-alive</span><br><span class="line">...[PaymentFeignService<span class="params">#</span>paymentFeignTimeOut] content-length: 4</span><br><span class="line">...[PaymentFeignService<span class="params">#</span>paymentFeignTimeOut] content-type: text/plain;charset=UTF-8</span><br><span class="line">...[PaymentFeignService<span class="params">#</span>paymentFeignTimeOut] date: Tue, 27 Dec 2022 14:27:27 GMT</span><br><span class="line">...[PaymentFeignService<span class="params">#</span>paymentFeignTimeOut] keep-alive: timeout=60</span><br><span class="line">...[PaymentFeignService<span class="params">#</span>paymentFeignTimeOut] </span><br><span class="line">...[PaymentFeignService<span class="params">#</span>paymentFeignTimeOut] 8001</span><br><span class="line">...[PaymentFeignService<span class="params">#</span>paymentFeignTimeOut] &lt;--- END HTTP (4-byte body)</span><br></pre></td></tr></table></figure>

<h1 id="Hystrixæ–­è·¯å™¨"><a href="#Hystrixæ–­è·¯å™¨" class="headerlink" title="Hystrixæ–­è·¯å™¨"></a>Hystrixæ–­è·¯å™¨</h1><p>æ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="https://github.com/Netflix/Hystrix/wiki/How-To-Use">https://github.com/Netflix/Hystrix/wiki/How-To-Use</a></p>
<h2 id="æ¦‚è¿°-3"><a href="#æ¦‚è¿°-3" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><h3 id="åˆ†å¸ƒå¼ç³»ç»Ÿé¢ä¸´çš„é—®é¢˜"><a href="#åˆ†å¸ƒå¼ç³»ç»Ÿé¢ä¸´çš„é—®é¢˜" class="headerlink" title="åˆ†å¸ƒå¼ç³»ç»Ÿé¢ä¸´çš„é—®é¢˜"></a>åˆ†å¸ƒå¼ç³»ç»Ÿé¢ä¸´çš„é—®é¢˜</h3><blockquote>
<p>å¤æ‚åˆ†å¸ƒå¼ä½“ç³»ç»“æ„ä¸­çš„åº”ç”¨ç¨‹åºæœ‰æ•°åä¸ªä¾èµ–å…³ç³»ï¼Œæ¯ä¸ªä¾èµ–å…³ç³»åœ¨æŸäº›æ—¶å€™å°†ä¸å¯é¿å…åœ°å¤±è´¥ã€‚</p>
<p><img src="/2023/03/25/SpringCloud/Java\Document\SpringCloud\images\image-20221227223212482.png" alt="image-20221227223212482"></p>
</blockquote>
<h3 id="æœåŠ¡é›ªå´©"><a href="#æœåŠ¡é›ªå´©" class="headerlink" title="æœåŠ¡é›ªå´©"></a>æœåŠ¡é›ªå´©</h3><p>â€‹		å¤šä¸ªå¾®æœåŠ¡ä¹‹é—´è°ƒç”¨çš„æ—¶å€™ï¼Œå‡è®¾å¾®æœåŠ¡Aè°ƒç”¨å¾®æœåŠ¡Bå’Œå¾®æœåŠ¡Cï¼Œå¾®æœåŠ¡Bå’Œå¾®æœåŠ¡Cåˆè°ƒç”¨å…¶å®ƒçš„å¾®æœåŠ¡ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„â€œæ‰‡å‡ºâ€ã€‚å¦‚æœæ‰‡å‡ºçš„é“¾è·¯ä¸ŠæŸä¸ªå¾®æœåŠ¡çš„è°ƒç”¨å“åº”æ—¶é—´è¿‡é•¿æˆ–è€…ä¸å¯ç”¨ï¼Œå¯¹å¾®æœåŠ¡Açš„è°ƒç”¨å°±ä¼šå ç”¨è¶Šæ¥è¶Šå¤šçš„ç³»ç»Ÿèµ„æºï¼Œè¿›è€Œå¼•èµ·ç³»ç»Ÿå´©æºƒï¼Œæ‰€è°“çš„â€œé›ªå´©æ•ˆåº”â€ã€‚</p>
<p>â€‹		å¯¹äºé«˜æµé‡çš„åº”ç”¨æ¥è¯´ï¼Œå•ä¸€çš„åç«¯ä¾èµ–å¯èƒ½ä¼šå¯¼è‡´æ‰€æœ‰æœåŠ¡å™¨ä¸Šçš„æ‰€æœ‰èµ„æºéƒ½åœ¨å‡ ç§’é’Ÿå†…é¥±å’Œã€‚æ¯”å¤±è´¥æ›´ç³Ÿç³•çš„æ˜¯ï¼Œè¿™äº›åº”ç”¨ç¨‹åºè¿˜å¯èƒ½å¯¼è‡´æœåŠ¡ä¹‹é—´çš„å»¶è¿Ÿå¢åŠ ï¼Œå¤‡ä»½é˜Ÿåˆ—ï¼Œçº¿ç¨‹å’Œå…¶ä»–ç³»ç»Ÿèµ„æºç´§å¼ ï¼Œå¯¼è‡´æ•´ä¸ªç³»ç»Ÿå‘ç”Ÿæ›´å¤šçš„çº§è”æ•…éšœã€‚è¿™äº›éƒ½è¡¨ç¤ºéœ€è¦å¯¹æ•…éšœå’Œå»¶è¿Ÿè¿›è¡Œéš”ç¦»å’Œç®¡ç†ï¼Œä»¥ä¾¿å•ä¸ªä¾èµ–å…³ç³»çš„å¤±è´¥ï¼Œä¸èƒ½å–æ¶ˆæ•´ä¸ªåº”ç”¨ç¨‹åºæˆ–ç³»ç»Ÿã€‚</p>
<h3 id="å®šä¹‰"><a href="#å®šä¹‰" class="headerlink" title="å®šä¹‰"></a>å®šä¹‰</h3><p>â€‹		Hystrix æ˜¯ä¸€ä¸ªç”¨äºå¤„ç†åˆ†å¸ƒå¼ç³»ç»Ÿçš„å»¶è¿Ÿå’Œå®¹é”™çš„å¼€æºåº“ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿé‡Œï¼Œè®¸å¤šä¾èµ–ä¸å¯é¿å…çš„ä¼šè°ƒç”¨å¤±è´¥ï¼Œæ¯”å¦‚è¶…æ—¶ã€å¼‚å¸¸ç­‰ï¼ŒHystrix èƒ½å¤Ÿä¿è¯åœ¨ä¸€ä¸ªä¾èµ–å‡ºé—®é¢˜çš„æƒ…å†µä¸‹ï¼Œä¸ä¼šå¯¼è‡´æ•´ä½“æœåŠ¡å¤±è´¥ï¼Œé¿å…çº§è”æ•…éšœï¼Œä»¥æé«˜åˆ†å¸ƒå¼ç³»ç»Ÿçš„å¼¹æ€§ã€‚</p>
<p>â€‹		â€œæ–­è·¯å™¨â€ èº«æ˜¯ä¸€ç§å¼€å…³è£…ç½®ï¼Œå½“æŸä¸ªæœåŠ¡å•å…ƒå‘ç”Ÿæ•…éšœä¹‹åï¼Œé€šè¿‡æ–­è·¯å™¨çš„æ•…éšœç›‘æ§ï¼ˆç±»ä¼¼ç†”æ–­ä¿é™©ä¸ï¼‰ï¼Œå‘è°ƒç”¨æ–¹è¿”å›ä¸€ä¸ªç¬¦åˆé¢„æœŸçš„ã€å¯å¤„ç†çš„å¤‡é€‰å“åº”ï¼ˆFallBackï¼‰ï¼Œè€Œä¸æ˜¯é•¿æ—¶é—´çš„ç­‰å¾…æˆ–è€…æŠ›å‡ºè°ƒç”¨æ–¹æ— æ³•å¤„ç†çš„å¼‚å¸¸ï¼Œè¿™æ ·å°±ä¿è¯äº†æœåŠ¡è°ƒç”¨æ–¹çš„çº¿ç¨‹ä¸ä¼šè¢«é•¿æ—¶é—´ã€ä¸å¿…è¦åœ°å ç”¨ï¼Œä»è€Œé¿å…äº†æ•…éšœåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„è”“å»¶ï¼Œä¹ƒè‡³é›ªå´©ã€‚</p>
<p>Hystrixå®˜å®£ï¼Œåœæ›´è¿›ç»´ï¼š<a target="_blank" rel="noopener" href="https://github.com/Netflix/Hystrix">https://github.com/Netflix/Hystrix</a></p>
<h2 id="Hystrixé‡è¦æ¦‚å¿µ"><a href="#Hystrixé‡è¦æ¦‚å¿µ" class="headerlink" title="Hystrixé‡è¦æ¦‚å¿µ"></a>Hystrixé‡è¦æ¦‚å¿µ</h2><h3 id="æœåŠ¡ç†”æ–­"><a href="#æœåŠ¡ç†”æ–­" class="headerlink" title="æœåŠ¡ç†”æ–­"></a>æœåŠ¡ç†”æ–­</h3><blockquote>
<ol>
<li><strong>ç†”æ–­æœºåˆ¶æ˜¯åº”å¯¹é›ªå´©æ•ˆåº”çš„ä¸€ç§å¾®æœåŠ¡é“¾è·¯ä¿æŠ¤æœºåˆ¶ã€‚</strong></li>
<li>å½“æ‰‡å‡ºé“¾è·¯çš„æŸä¸ªå¾®æœåŠ¡ä¸å¯ç”¨æˆ–è€…å“åº”æ—¶é—´å¤ªé•¿æ—¶ï¼Œä¼šè¿›è¡ŒæœåŠ¡çš„é™çº§ï¼Œè¿›è€Œç†”æ–­è¯¥èŠ‚ç‚¹å¾®æœåŠ¡çš„è°ƒç”¨ï¼Œå¿«é€Ÿè¿”å› â€œé”™è¯¯â€ çš„å“åº”ä¿¡æ¯ã€‚å½“æ£€æµ‹åˆ°è¯¥èŠ‚ç‚¹å¾®æœåŠ¡è°ƒç”¨å“åº”æ­£å¸¸åæ¢å¤è°ƒç”¨é“¾è·¯ã€‚</li>
<li>åœ¨ SpringCloud æ¡†æ¶é‡Œç†”æ–­æœºåˆ¶é€šè¿‡ Hystrixå®ç°ã€‚Hystrix ä¼šç›‘æ§å¾®æœåŠ¡é—´è°ƒç”¨çš„çŠ¶å†µï¼Œå½“å¤±è´¥çš„è°ƒç”¨åˆ°ä¸€å®šé˜ˆå€¼ï¼Œ<strong>ç¼ºçœæ˜¯5ç§’å†…20æ¬¡è°ƒç”¨å¤±è´¥</strong> å°±ä¼šå¯åŠ¨ç†”æ–­æœºåˆ¶ã€‚</li>
<li>ç†”æ–­æœºåˆ¶çš„æ³¨è§£æ˜¯ @HystrixCommandã€‚</li>
</ol>
</blockquote>
<h3 id="æœåŠ¡é™çº§"><a href="#æœåŠ¡é™çº§" class="headerlink" title="æœåŠ¡é™çº§"></a>æœåŠ¡é™çº§</h3><blockquote>
<p>æ•´ä½“èµ„æºå¿«ä¸å¤Ÿäº†ï¼Œå¿ç—›å°†æŸäº›æœåŠ¡å…ˆå…³æ‰ï¼Œå¾…æ¸¡è¿‡éš¾å…³ï¼Œå†å¼€å¯å›æ¥ã€‚</p>
<p>æœåŠ¡å™¨å¿™ï¼Œè¯·ç¨åå†è¯•ï¼Œä¸è®©å®¢æˆ·ç«¯ç­‰å¾…å¹¶ç«‹åˆ»è¿”å›ä¸€ä¸ªå‹å¥½æç¤ºï¼Œfallbackå¤„ç†ã€‚</p>
<p>å¦‚ç³»ç»Ÿå¤„äºé«˜å³°æœŸï¼Œèµ„æºç´§å¼ ï¼Œå¯ä»¥è®©éæ ¸å¿ƒä¸šåŠ¡é™çº§è¿è¡Œï¼Œé™çº§ã€æŸäº›æœåŠ¡ä¸å¤„ç†ï¼Œæˆ–ç®€å•å¤„ç†ï¼Œå¦‚æŠ›å¼‚å¸¸ï¼Œè¿”å›NULLï¼Œè°ƒç”¨FallBackå¤„ç†ç­‰ã€‘</p>
<p>æœåŠ¡é™çº§å¤„ç†æ˜¯åœ¨å®¢æˆ·ç«¯å®ç°å®Œæˆçš„ï¼Œä¸æœåŠ¡ç«¯æ²¡æœ‰å…³ç³»ã€‚</p>
<p>é‚£äº›æƒ…å†µè§¦å‘æœåŠ¡é™çº§ï¼š</p>
<ol>
<li>ç¨‹åºå¼‚å¸¸</li>
<li>è¶…æ—¶</li>
<li>æœåŠ¡ç†”æ–­è§¦å‘é™çº§</li>
<li>çº¿ç¨‹æ± &#x2F;ä¿¡å·é‡æ‰“æ»¡ä¹Ÿä¼šå¯¼è‡´æœåŠ¡é™çº§</li>
</ol>
</blockquote>
<h3 id="æœåŠ¡é™æµ"><a href="#æœåŠ¡é™æµ" class="headerlink" title="æœåŠ¡é™æµ"></a>æœåŠ¡é™æµ</h3><blockquote>
<p>å¯¹äºç§’æ€é«˜å¹¶å‘ç­‰æ“ä½œï¼Œä¸¥ç¦ä¸€çªèœ‚çš„è¿‡æ¥æ‹¥æŒ¤ï¼Œå¤§å®¶æ’é˜Ÿï¼Œä¸€ç§’é’ŸNä¸ªï¼Œæœ‰åºè¿›è¡Œ</p>
</blockquote>
<h2 id="Hystrixç¤ºä¾‹"><a href="#Hystrixç¤ºä¾‹" class="headerlink" title="Hystrixç¤ºä¾‹"></a>Hystrixç¤ºä¾‹</h2><ol>
<li><p>æ–°å»ºå·¥ç¨‹ cloud-provider-hystrix-payment8001</p>
</li>
<li><p>pom.xml</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cloud-provider-payment8002</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="Zuul"><a href="#Zuul" class="headerlink" title="Zuul"></a>Zuul</h1><h1 id="Gateway"><a href="#Gateway" class="headerlink" title="Gateway"></a>Gateway</h1><p>æ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.1.RELEASE/reference/html/">https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.1.RELEASE/reference/html/</a></p>
<h2 id="æ¦‚è¿°-4"><a href="#æ¦‚è¿°-4" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><blockquote>
<p>SpringCloudå…¨å®¶æ¡¶ä¸­æœ‰ä¸ªå¾ˆé‡è¦çš„ç»„ä»¶å°±æ˜¯ç½‘å…³ï¼Œåœ¨1.xç‰ˆæœ¬ä¸­éƒ½æ˜¯é‡‡ç”¨çš„Zuulç½‘å…³ï¼›ä½†åœ¨2.xç‰ˆæœ¬ä¸­ï¼Œä½¿ç”¨Gatewayæ›¿ä»£åŸzuul1.xç‰ˆ</p>
<p>Gatewayæ˜¯åœ¨Springç”Ÿæ€ç³»ç»Ÿä¹‹ä¸Šæ„å»ºçš„APIç½‘å…³æœåŠ¡ï¼ŒåŸºäºSpring 5ï¼ŒSpring Boot 2å’Œ Project Reactorç­‰æŠ€æœ¯ã€‚<br>Gatewayæ—¨åœ¨æä¾›ä¸€ç§ç®€å•è€Œæœ‰æ•ˆçš„æ–¹å¼æ¥å¯¹APIè¿›è¡Œè·¯ç”±ï¼Œä»¥åŠæä¾›ä¸€äº›å¼ºå¤§çš„è¿‡æ»¤å™¨åŠŸèƒ½ï¼Œ ä¾‹å¦‚ï¼šç†”æ–­ã€é™æµã€é‡è¯•ç­‰ã€‚</p>
<p>SpringCloud Gateway æ˜¯ Spring Cloud çš„ä¸€ä¸ªå…¨æ–°é¡¹ç›®ï¼ŒåŸºäº Spring 5.0+Spring Boot 2.0 å’Œ Project Reactor ç­‰æŠ€æœ¯å¼€å‘çš„ç½‘å…³ï¼Œå®ƒæ—¨åœ¨ä¸ºå¾®æœåŠ¡æ¶æ„æä¾›ä¸€ç§ç®€å•æœ‰æ•ˆçš„ç»Ÿä¸€çš„ API è·¯ç”±ç®¡ç†æ–¹å¼ã€‚</p>
<p>SpringCloud Gateway ä½œä¸º Spring Cloud ç”Ÿæ€ç³»ç»Ÿä¸­çš„ç½‘å…³ï¼Œç›®æ ‡æ˜¯æ›¿ä»£ Zuulï¼Œåœ¨Spring Cloud 2.0ä»¥ä¸Šç‰ˆæœ¬ä¸­ï¼Œæ²¡æœ‰å¯¹æ–°ç‰ˆæœ¬çš„Zuul 2.0ä»¥ä¸Šæœ€æ–°é«˜æ€§èƒ½ç‰ˆæœ¬è¿›è¡Œé›†æˆï¼Œä»ç„¶è¿˜æ˜¯ä½¿ç”¨çš„Zuul 1.xéReactoræ¨¡å¼çš„è€ç‰ˆæœ¬ã€‚è€Œä¸ºäº†æå‡ç½‘å…³çš„æ€§èƒ½ï¼ŒSpringCloud Gatewayæ˜¯åŸºäºWebFluxæ¡†æ¶å®ç°çš„ï¼Œè€ŒWebFluxæ¡†æ¶åº•å±‚åˆ™ä½¿ç”¨äº†é«˜æ€§èƒ½çš„Reactoræ¨¡å¼é€šä¿¡æ¡†æ¶Nettyã€‚</p>
<p>ä½¿ç”¨çš„Webfluxä¸­çš„reactor-nettyå“åº”å¼ç¼–ç¨‹ç»„ä»¶ï¼Œåº•å±‚ä½¿ç”¨äº†Nettyé€šè®¯æ¡†æ¶ã€‚</p>
<p>Spring Cloud Gatewayçš„ç›®æ ‡æä¾›ç»Ÿä¸€çš„è·¯ç”±æ–¹å¼ä¸”åŸºäº Filter é“¾çš„æ–¹å¼æä¾›äº†ç½‘å…³åŸºæœ¬çš„åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼šå®‰å…¨ï¼Œç›‘æ§&#x2F;æŒ‡æ ‡ï¼Œå’Œé™æµã€‚</p>
</blockquote>
<h2 id="ä½œç”¨-1"><a href="#ä½œç”¨-1" class="headerlink" title="ä½œç”¨"></a>ä½œç”¨</h2><blockquote>
<p>åå‘ä»£ç†</p>
<p>é‰´æƒ</p>
<p>æµé‡æ§åˆ¶</p>
<p>ç†”æ–­</p>
<p>æ—¥å¿—ç›‘æ§</p>
</blockquote>
<h2 id="Gatewayç›¸æ¯”äºZuulçš„ä¼˜ç‚¹"><a href="#Gatewayç›¸æ¯”äºZuulçš„ä¼˜ç‚¹" class="headerlink" title="Gatewayç›¸æ¯”äºZuulçš„ä¼˜ç‚¹"></a>Gatewayç›¸æ¯”äºZuulçš„ä¼˜ç‚¹</h2><blockquote>
<p>ä¸€æ–¹é¢å› ä¸ºZuul1.0å·²ç»è¿›å…¥äº†ç»´æŠ¤é˜¶æ®µï¼Œè€Œä¸”<strong>Gatewayæ˜¯SpringCloudå›¢é˜Ÿç ”å‘çš„</strong>ï¼Œè€Œä¸”å¾ˆå¤šåŠŸèƒ½Zuuléƒ½æ²¡æœ‰ç”¨èµ·æ¥ä¹Ÿéå¸¸çš„ç®€å•ä¾¿æ·ã€‚</p>
<p>Gatewayæ˜¯åŸºäºå¼‚æ­¥éé˜»å¡æ¨¡å‹ä¸Šè¿›è¡Œå¼€å‘çš„ï¼Œæ€§èƒ½æ–¹é¢ä¸éœ€è¦æ‹…å¿ƒã€‚è™½ç„¶Netflixæ—©å°±å‘å¸ƒäº†æœ€æ–°çš„ Zuul 2.xï¼Œä½† Spring Cloud è²Œä¼¼æ²¡æœ‰æ•´åˆè®¡åˆ’ã€‚</p>
</blockquote>
<blockquote>
<p><strong>Spring Cloud Gateway å…·æœ‰å¦‚ä¸‹ç‰¹æ€§ï¼š</strong></p>
<ol>
<li>åŸºäºSpring Framework 5, Project Reactor å’Œ Spring Boot 2.0 è¿›è¡Œæ„å»ºï¼›</li>
<li>åŠ¨æ€è·¯ç”±ï¼šèƒ½å¤ŸåŒ¹é…ä»»ä½•è¯·æ±‚å±æ€§ï¼›</li>
<li>å¯ä»¥å¯¹è·¯ç”±æŒ‡å®š Predicateï¼ˆæ–­è¨€ï¼‰å’Œ Filterï¼ˆè¿‡æ»¤å™¨ï¼‰ï¼›</li>
<li>é›†æˆHystrixçš„æ–­è·¯å™¨åŠŸèƒ½ï¼›</li>
<li>é›†æˆ Spring Cloud æœåŠ¡å‘ç°åŠŸèƒ½ï¼›</li>
<li>æ˜“äºç¼–å†™çš„ Predicateï¼ˆæ–­è¨€ï¼‰å’Œ Filterï¼ˆè¿‡æ»¤å™¨ï¼‰ï¼›</li>
<li>è¯·æ±‚é™æµåŠŸèƒ½ï¼›</li>
<li>æ”¯æŒè·¯å¾„é‡å†™ã€‚</li>
</ol>
</blockquote>
<blockquote>
<p><strong>Spring Cloud Gateway ä¸ Zuulçš„åŒºåˆ«</strong><br>åœ¨SpringCloud Finchley æ­£å¼ç‰ˆä¹‹å‰ï¼ŒSpring Cloud æ¨èçš„ç½‘å…³æ˜¯ Netflix æä¾›çš„Zuulï¼š</p>
<ol>
<li><p>Zuul 1.xï¼Œæ˜¯ä¸€ä¸ªåŸºäºé˜»å¡ I&#x2F; O çš„ API Gateway</p>
</li>
<li><p>Zuul 1.x åŸºäºServlet 2. 5ä½¿ç”¨é˜»å¡æ¶æ„å®ƒä¸æ”¯æŒä»»ä½•é•¿è¿æ¥(å¦‚ WebSocket) Zuul çš„è®¾è®¡æ¨¡å¼å’ŒNginxè¾ƒåƒï¼Œæ¯æ¬¡ I&#x2F; O æ“ä½œéƒ½æ˜¯ä»å·¥ä½œçº¿ç¨‹ä¸­é€‰æ‹©ä¸€ä¸ªæ‰§è¡Œï¼Œè¯·æ±‚çº¿ç¨‹è¢«é˜»å¡åˆ°å·¥ä½œçº¿ç¨‹å®Œæˆï¼Œä½†æ˜¯å·®åˆ«æ˜¯Nginx ç”¨C++ å®ç°ï¼ŒZuul ç”¨ Java å®ç°ï¼Œè€Œ JVM æœ¬èº«ä¼šæœ‰ç¬¬ä¸€æ¬¡åŠ è½½è¾ƒæ…¢çš„æƒ…å†µï¼Œä½¿å¾—Zuul çš„æ€§èƒ½ç›¸å¯¹è¾ƒå·®ã€‚</p>
</li>
<li><p>Zuul 2.xç†å¿µæ›´å…ˆè¿›ï¼Œæƒ³åŸºäºNettyéé˜»å¡å’Œæ”¯æŒé•¿è¿æ¥ï¼Œä½†SpringCloudç›®å‰è¿˜æ²¡æœ‰æ•´åˆã€‚ Zuul 2.xçš„æ€§èƒ½è¾ƒ Zuul 1.x æœ‰è¾ƒå¤§æå‡ã€‚åœ¨æ€§èƒ½æ–¹é¢ï¼Œæ ¹æ®å®˜æ–¹æä¾›çš„åŸºå‡†æµ‹è¯•ï¼Œ Spring Cloud Gateway çš„ RPSï¼ˆæ¯ç§’è¯·æ±‚æ•°ï¼‰æ˜¯Zuul çš„ 1. 6 å€ã€‚</p>
</li>
<li><p>Spring Cloud Gateway å»ºç«‹ åœ¨ Spring Framework 5ã€ Project Reactor å’Œ Spring Boot 2 ä¹‹ä¸Šï¼Œ ä½¿ç”¨éé˜»å¡ APIã€‚</p>
</li>
<li><p>Spring Cloud Gateway è¿˜æ”¯æŒ WebSocketï¼Œ å¹¶ä¸”ä¸Springç´§å¯†é›†æˆæ‹¥æœ‰æ›´å¥½çš„å¼€å‘ä½“éªŒ</p>
</li>
</ol>
</blockquote>
<h2 id="Zuul1-xæ¨¡å‹"><a href="#Zuul1-xæ¨¡å‹" class="headerlink" title="Zuul1.xæ¨¡å‹"></a>Zuul1.xæ¨¡å‹</h2><blockquote>
<p>Springcloudä¸­æ‰€é›†æˆçš„Zuulç‰ˆæœ¬ï¼Œé‡‡ç”¨çš„æ˜¯Tomcatå®¹å™¨ï¼Œä½¿ç”¨çš„æ˜¯ä¼ ç»Ÿçš„Servlet IOå¤„ç†æ¨¡å‹ã€‚</p>
<p>servletç”±servlet containerè¿›è¡Œç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚<br>containerå¯åŠ¨æ—¶æ„é€ servletå¯¹è±¡å¹¶è°ƒç”¨servlet init()è¿›è¡Œåˆå§‹åŒ–ï¼›<br>containerè¿è¡Œæ—¶æ¥å—è¯·æ±‚ï¼Œå¹¶ä¸ºæ¯ä¸ªè¯·æ±‚åˆ†é…ä¸€ä¸ªçº¿ç¨‹ï¼ˆä¸€èˆ¬ä»çº¿ç¨‹æ± ä¸­è·å–ç©ºé—²çº¿ç¨‹ï¼‰ç„¶åè°ƒç”¨service()ã€‚<br>containerå…³é—­æ—¶è°ƒç”¨servlet destory()é”€æ¯servletï¼›</p>
<p>ä¸Šè¿°æ¨¡å¼çš„ç¼ºç‚¹ï¼š<br>servletæ˜¯ä¸€ä¸ªç®€å•çš„ç½‘ç»œIOæ¨¡å‹ï¼Œå½“è¯·æ±‚è¿›å…¥servlet containeræ—¶ï¼Œservlet containerå°±ä¼šä¸ºå…¶ç»‘å®šä¸€ä¸ªçº¿ç¨‹ï¼Œåœ¨å¹¶å‘ä¸é«˜çš„åœºæ™¯ä¸‹è¿™ç§æ¨¡å‹æ˜¯é€‚ç”¨çš„ã€‚ä½†æ˜¯ä¸€æ—¦é«˜å¹¶å‘(æ¯”å¦‚æŠ½é£ç”¨jemeterå‹)ï¼Œçº¿ç¨‹æ•°é‡å°±ä¼šä¸Šæ¶¨ï¼Œè€Œçº¿ç¨‹èµ„æºä»£ä»·æ˜¯æ˜‚è´µçš„ï¼ˆä¸Šçº¿æ–‡åˆ‡æ¢ï¼Œå†…å­˜æ¶ˆè€—å¤§ï¼‰ä¸¥é‡å½±å“è¯·æ±‚çš„å¤„ç†æ—¶é—´ã€‚åœ¨ä¸€äº›ç®€å•ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œä¸å¸Œæœ›ä¸ºæ¯ä¸ªrequeståˆ†é…ä¸€ä¸ªçº¿ç¨‹ï¼Œåªéœ€è¦1ä¸ªæˆ–å‡ ä¸ªçº¿ç¨‹å°±èƒ½åº”å¯¹æå¤§å¹¶å‘çš„è¯·æ±‚ï¼Œè¿™ç§ä¸šåŠ¡åœºæ™¯ä¸‹servletæ¨¡å‹æ²¡æœ‰ä¼˜åŠ¿</p>
<p>æ‰€ä»¥Zuul 1.Xæ˜¯åŸºäºservletä¹‹ä¸Šçš„ä¸€ä¸ªé˜»å¡å¼å¤„ç†æ¨¡å‹ï¼Œå³springå®ç°äº†å¤„ç†æ‰€æœ‰requestè¯·æ±‚çš„ä¸€ä¸ªservletï¼ˆDispatcherServletï¼‰å¹¶ç”±è¯¥servleté˜»å¡å¼å¤„ç†å¤„ç†ã€‚æ‰€ä»¥Springcloud Zuulæ— æ³•æ‘†è„±servletæ¨¡å‹çš„å¼Šç«¯</p>
</blockquote>
<h2 id="GateWayæ¨¡å‹"><a href="#GateWayæ¨¡å‹" class="headerlink" title="GateWayæ¨¡å‹"></a>GateWayæ¨¡å‹</h2><blockquote>
<p>WebFluxï¼š<a target="_blank" rel="noopener" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html#webflux-new-framework">https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html#webflux-new-framework</a></p>
<p>ä¼ ç»Ÿçš„Webæ¡†æ¶ï¼Œæ¯”å¦‚è¯´ï¼šstruts2ï¼Œspringmvcç­‰éƒ½æ˜¯åŸºäºServlet APIä¸Servletå®¹å™¨åŸºç¡€ä¹‹ä¸Šè¿è¡Œçš„ã€‚<br>ä½†æ˜¯<br>åœ¨Servlet3.1ä¹‹åæœ‰äº†å¼‚æ­¥éé˜»å¡çš„æ”¯æŒã€‚è€ŒWebFluxæ˜¯ä¸€ä¸ªå…¸å‹éé˜»å¡å¼‚æ­¥çš„æ¡†æ¶ï¼Œå®ƒçš„æ ¸å¿ƒæ˜¯åŸºäºReactorçš„ç›¸å…³APIå®ç°çš„ã€‚ç›¸å¯¹äºä¼ ç»Ÿçš„webæ¡†æ¶æ¥è¯´ï¼Œå®ƒå¯ä»¥è¿è¡Œåœ¨è¯¸å¦‚Nettyï¼ŒUndertowåŠæ”¯æŒServlet3.1çš„å®¹å™¨ä¸Šã€‚éé˜»å¡å¼+å‡½æ•°å¼ç¼–ç¨‹ï¼ˆSpring5å¿…é¡»è®©ä½ ä½¿ç”¨java8ï¼‰</p>
<p>Spring WebFlux æ˜¯ Spring 5.0 å¼•å…¥çš„æ–°çš„å“åº”å¼æ¡†æ¶ï¼ŒåŒºåˆ«äº Spring MVCï¼Œå®ƒä¸éœ€è¦ä¾èµ–Servlet APIï¼Œå®ƒæ˜¯å®Œå…¨å¼‚æ­¥éé˜»å¡çš„ï¼Œå¹¶ä¸”åŸºäº Reactor æ¥å®ç°å“åº”å¼æµè§„èŒƒã€‚</p>
</blockquote>
<h2 id="ä¸‰å¤§æ ¸å¿ƒæ¦‚å¿µ"><a href="#ä¸‰å¤§æ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="ä¸‰å¤§æ ¸å¿ƒæ¦‚å¿µ"></a>ä¸‰å¤§æ ¸å¿ƒæ¦‚å¿µ</h2><h3 id="è·¯ç”±ï¼ˆrouteï¼‰"><a href="#è·¯ç”±ï¼ˆrouteï¼‰" class="headerlink" title="è·¯ç”±ï¼ˆrouteï¼‰"></a>è·¯ç”±ï¼ˆrouteï¼‰</h3><p><strong>è·¯ç”±æ˜¯æ„å»ºç½‘å…³çš„åŸºæœ¬æ¨¡å—ï¼Œå®ƒç”±IDï¼Œç›®æ ‡URIï¼Œä¸€ç³»åˆ—çš„æ–­è¨€å’Œè¿‡æ»¤å™¨ç»„æˆï¼Œå¦‚æœæ–­è¨€ä¸ºtrueåˆ™åŒ¹é…è¯¥è·¯ç”±</strong></p>
<h3 id="æ–­è¨€ï¼ˆPredicateï¼‰"><a href="#æ–­è¨€ï¼ˆPredicateï¼‰" class="headerlink" title="æ–­è¨€ï¼ˆPredicateï¼‰"></a>æ–­è¨€ï¼ˆPredicateï¼‰</h3><p>å¼€å‘äººå‘˜å¯ä»¥åŒ¹é…HTTPè¯·æ±‚ä¸­çš„æ‰€æœ‰å†…å®¹ï¼ˆä¾‹å¦‚è¯·æ±‚å¤´æˆ–è¯·æ±‚å‚æ•°ï¼‰ï¼Œå¦‚æœè¯·æ±‚ä¸æ–­è¨€ç›¸åŒ¹é…åˆ™è¿›è¡Œè·¯ç”±</p>
<h3 id="è¿‡æ»¤ï¼ˆFilterï¼‰"><a href="#è¿‡æ»¤ï¼ˆFilterï¼‰" class="headerlink" title="è¿‡æ»¤ï¼ˆFilterï¼‰"></a>è¿‡æ»¤ï¼ˆFilterï¼‰</h3><p>æŒ‡çš„æ˜¯Springæ¡†æ¶ä¸­GatewayFilterçš„å®ä¾‹ï¼Œä½¿ç”¨è¿‡æ»¤å™¨ï¼Œå¯ä»¥åœ¨è¯·æ±‚è¢«è·¯ç”±å‰æˆ–è€…ä¹‹åå¯¹è¯·æ±‚è¿›è¡Œä¿®æ”¹ã€‚</p>
<blockquote>
<p>æ€»ä½“æ¥è¯´ï¼š</p>
<p>webè¯·æ±‚ï¼Œé€šè¿‡ä¸€äº›åŒ¹é…æ¡ä»¶ï¼Œå®šä½åˆ°çœŸæ­£çš„æœåŠ¡èŠ‚ç‚¹ã€‚å¹¶åœ¨è¿™ä¸ªè½¬å‘è¿‡ç¨‹çš„å‰åï¼Œè¿›è¡Œä¸€äº›ç²¾ç»†åŒ–æ§åˆ¶ã€‚å…¶ä¸­predicateå°±æ˜¯æˆ‘ä»¬çš„åŒ¹é…æ¡ä»¶ï¼›è€Œfilterå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæ‹¦æˆªå™¨ã€‚</p>
<p>æ ¸å¿ƒé€»è¾‘ï¼šè·¯ç”±è½¬å‘ + æ‰§è¡Œè¿‡æ»¤å™¨é“¾</p>
<img src="/2023/03/25/SpringCloud/Java\Document\SpringCloud\images\image-20221228111941484.png" alt="image-20221228111941484" style="zoom:80%;">

<p>å®¢æˆ·ç«¯å‘ Spring Cloud Gateway å‘å‡ºè¯·æ±‚ã€‚ç„¶ååœ¨ Gateway Handler Mapping ä¸­æ‰¾åˆ°ä¸è¯·æ±‚ç›¸åŒ¹é…çš„è·¯ç”±ï¼Œå°†å…¶å‘é€åˆ° Gateway Web Handlerã€‚</p>
<p>Handler å†é€šè¿‡æŒ‡å®šçš„è¿‡æ»¤å™¨é“¾æ¥å°†è¯·æ±‚å‘é€åˆ°æˆ‘ä»¬å®é™…çš„æœåŠ¡æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼Œç„¶åè¿”å›ã€‚<br>è¿‡æ»¤å™¨ä¹‹é—´ç”¨è™šçº¿åˆ†å¼€æ˜¯å› ä¸ºè¿‡æ»¤å™¨å¯èƒ½ä¼šåœ¨å‘é€ä»£ç†è¯·æ±‚ä¹‹å‰ï¼ˆâ€œpreâ€ï¼‰æˆ–ä¹‹åï¼ˆâ€œpostâ€ï¼‰æ‰§è¡Œä¸šåŠ¡é€»è¾‘ã€‚</p>
<p>Filteråœ¨â€œpreâ€ç±»å‹çš„è¿‡æ»¤å™¨å¯ä»¥åšå‚æ•°æ ¡éªŒã€æƒé™æ ¡éªŒã€æµé‡ç›‘æ§ã€æ—¥å¿—è¾“å‡ºã€åè®®è½¬æ¢ç­‰ï¼Œ<br>åœ¨â€œPOSTâ€ç±»å‹çš„è¿‡æ»¤å™¨ä¸­å¯ä»¥åšå“åº”å†…å®¹ã€å“åº”å¤´çš„ä¿®æ”¹ï¼Œæ—¥å¿—çš„è¾“å‡ºï¼Œæµé‡ç›‘æ§ç­‰æœ‰ç€éå¸¸é‡è¦çš„ä½œç”¨ã€‚</p>
</blockquote>
<h2 id="é…ç½®ç¤ºä¾‹"><a href="#é…ç½®ç¤ºä¾‹" class="headerlink" title="é…ç½®ç¤ºä¾‹"></a>é…ç½®ç¤ºä¾‹</h2><h3 id="æ–°å»ºå·¥ç¨‹"><a href="#æ–°å»ºå·¥ç¨‹" class="headerlink" title="æ–°å»ºå·¥ç¨‹"></a>æ–°å»ºå·¥ç¨‹</h3><blockquote>
<p>ä¸»è¦æ­¥éª¤ï¼š</p>
<ol>
<li><p>å¼•å…¥ä¾èµ–</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
</blockquote>
<ol>
<li><p>æ–°å»ºæ¨¡å— cloud-gateway-gateway9527</p>
</li>
<li><p>å¼•å…¥ä¾èµ–</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>é…ç½®æ–‡ä»¶yml</p>
 <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9527</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-gateway</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">cloud-gateway-service</span></span><br><span class="line">  <span class="attr">client:</span> <span class="comment">#æœåŠ¡æä¾›è€…provideræ³¨å†Œè¿›eurekaæœåŠ¡åˆ—è¡¨å†…</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>å¯åŠ¨ç±»</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GateWayMain9527</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(GateWayMain9527.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="è·¯ç”±æ˜ å°„ç¤ºä¾‹"><a href="#è·¯ç”±æ˜ å°„ç¤ºä¾‹" class="headerlink" title="è·¯ç”±æ˜ å°„ç¤ºä¾‹"></a>è·¯ç”±æ˜ å°„ç¤ºä¾‹</h3><p><strong>ç½‘å…³é…ç½®</strong></p>
<blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>


</blockquote>
<p>æµ‹è¯•ï¼š</p>
<p>è®¿é—®åœ°å€ç”± <a target="_blank" rel="noopener" href="http://localhost:8001/payment/get/1">http://localhost:8001/payment/get/1</a> æ”¹ä¸º <a target="_blank" rel="noopener" href="http://localhost:9527/payment/get/1">http://localhost:9527/payment/get/1</a></p>
<h3 id="é…ç½®è¯´æ˜"><a href="#é…ç½®è¯´æ˜" class="headerlink" title="é…ç½®è¯´æ˜"></a>é…ç½®è¯´æ˜</h3><p>Gatewayç½‘å…³è·¯ç”±æœ‰ä¸¤ç§é…ç½®æ–¹å¼ï¼š</p>
<p>ç¬¬ä¸€ç§ï¼šymlé…ç½®</p>
<p>ç¤ºä¾‹ï¼šlocalhost:9527?url&#x3D;baiduè·³è½¬è‡³<a target="_blank" rel="noopener" href="http://www.baidu.com,url=qqè·³è½¬è‡³http//www.qq.com">http://www.baidu.comï¼Œurl=qqè·³è½¬è‡³http://www.qq.com</a></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9527</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">baidu-route</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://www.baidu.com</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Query=url,baidu</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">qq-route</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://www.qq.com</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Query=url,qq</span></span><br></pre></td></tr></table></figure>

<p>ç¬¬äºŒç§ï¼šä»£ç é…ç½®</p>
<p>ä»£ç ä¸­æ³¨å…¥RouteLocatorçš„Bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GateWayConfig</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é…ç½®äº†ä¸€ä¸ªidä¸ºroute-nameçš„è·¯ç”±è§„åˆ™ï¼Œ</span></span><br><span class="line"><span class="comment">     * å½“è®¿é—®åœ°å€ http://localhost:9527/guoneiæ—¶</span></span><br><span class="line"><span class="comment">     * ä¼šè‡ªåŠ¨è½¬å‘åˆ°åœ°å€ï¼šhttp://news.baidu.com/guonei</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RouteLocator <span class="title function_">customRouteLocator</span><span class="params">(RouteLocatorBuilder builder)</span> &#123;</span><br><span class="line">        RouteLocatorBuilder.<span class="type">Builder</span> <span class="variable">routes</span> <span class="operator">=</span> builder.routes();</span><br><span class="line">        routes.route(<span class="string">&quot;path_route_example&quot;</span>, r -&gt; r.path(<span class="string">&quot;/guonei&quot;</span>).uri(<span class="string">&quot;http://news.baidu.com/guonei&quot;</span>)).build();</span><br><span class="line">        <span class="keyword">return</span> routes.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RouteLocator <span class="title function_">customRouteLocator2</span><span class="params">(RouteLocatorBuilder builder)</span> &#123;</span><br><span class="line">        RouteLocatorBuilder.<span class="type">Builder</span> <span class="variable">routes</span> <span class="operator">=</span> builder.routes();</span><br><span class="line">        routes.route(<span class="string">&quot;path_route_example2&quot;</span>, r -&gt; r.path(<span class="string">&quot;/guoji&quot;</span>).uri(<span class="string">&quot;http://news.baidu.com/guoji&quot;</span>)).build();</span><br><span class="line">        <span class="keyword">return</span> routes.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="é€šè¿‡å¾®æœåŠ¡åå®ç°åŠ¨æ€è·¯ç”±"><a href="#é€šè¿‡å¾®æœåŠ¡åå®ç°åŠ¨æ€è·¯ç”±" class="headerlink" title="é€šè¿‡å¾®æœåŠ¡åå®ç°åŠ¨æ€è·¯ç”±"></a>é€šè¿‡å¾®æœåŠ¡åå®ç°åŠ¨æ€è·¯ç”±</h3><p>é»˜è®¤æƒ…å†µä¸‹Gatewayä¼šæ ¹æ®æ³¨å†Œä¸­å¿ƒæ³¨å†Œçš„æœåŠ¡åˆ—è¡¨ï¼Œä»¥æ³¨å†Œä¸­å¿ƒä¸Šå¾®æœåŠ¡åä¸ºè·¯å¾„åˆ›å»ºåŠ¨æ€è·¯ç”±è¿›è¡Œè½¬å‘ï¼Œä»è€Œå®ç°åŠ¨æ€è·¯ç”±çš„åŠŸèƒ½ã€‚</p>
<p>cloud-gateway-gateway9527æ³¨å†Œè¿›Eureka</p>
<ol>
<li>application.ymlé…ç½®ï¼š</li>
</ol>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9527</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="comment">#å¼€å¯ä»æ³¨å†Œä¸­å¿ƒåŠ¨æ€åˆ›å»ºè·¯ç”±çš„åŠŸèƒ½ï¼Œåˆ©ç”¨å¾®æœåŠ¡åè¿›è¡Œè·¯ç”±</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="comment">#è·¯ç”±çš„IDï¼Œæ²¡æœ‰å›ºå®šè§„åˆ™ä½†è¦æ±‚å”¯ä¸€ï¼Œå»ºè®®é…åˆæœåŠ¡å</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh</span></span><br><span class="line">          <span class="comment">#uriçš„åè®®ä¸ºlbï¼Œlb://serviceName,è¡¨ç¤ºå¯ç”¨Gatewayçš„è´Ÿè½½å‡è¡¡åŠŸèƒ½</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://cloud-payment-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="comment"># æ–­è¨€ï¼Œè·¯å¾„ç›¸åŒ¹é…çš„è¿›è¡Œè·¯ç”±</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/payment/get/**</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh2</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://cloud-payment-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/payment/lb/**</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">cloud-gateway-service</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>æµ‹è¯•ï¼šå¯åŠ¨Eurekaå’Œä¸¤ä¸ªPaymentæä¾›è€…ï¼Œè®¿é—®<a target="_blank" rel="noopener" href="http://localhost:9527/payment/lb">http://localhost:9527/payment/lb</a></li>
</ol>
<h3 id="Predicateçš„ä½¿ç”¨"><a href="#Predicateçš„ä½¿ç”¨" class="headerlink" title="Predicateçš„ä½¿ç”¨"></a>Predicateçš„ä½¿ç”¨</h3><p>Predicateæ˜¯å®ç°ä¸€ç»„åŒ¹é…è§„åˆ™ï¼ŒåŒ¹é…å¯¹åº”çš„Routeè¿›è¡Œå¤„ç†ã€‚</p>
<p>å¸¸ç”¨çš„Route Predicateï¼šã€RoutePredicateFactoryå­ç±»ã€‘</p>
<h4 id="After-Route-Predicate"><a href="#After-Route-Predicate" class="headerlink" title="After Route Predicate"></a>After Route Predicate</h4><blockquote>
<p>æŒ‡å®šæ—¶é—´åæ‰å¯ä»¥è®¿é—®</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">routes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh_plus</span></span><br><span class="line">    <span class="attr">uri:</span> <span class="string">lb://cloud-payment-service</span></span><br><span class="line">    <span class="attr">predicates:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">Path=/payment/lb/**</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">After=2022-12-29T15:10:03.685+08:00[Asia/Shanghai]</span></span><br></pre></td></tr></table></figure>

<p>å¦åˆ™æŠ¥é”™ï¼š</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[ebf279f3] There was an unexpected error (type=Not Found, status=404).</span><br><span class="line">org.springframework.web.server.ResponseStatusException: 404 NOT<span class="built_in">_</span>FOUND</span><br><span class="line">	at org.springframework.web.reactive.resource.ResourceWebHandler.lambda<span class="built_in">$</span>handle<span class="built_in">$</span>0(ResourceWebHandler.java:325)</span><br><span class="line">	Suppressed: reactor.core.publisher.FluxOnAssembly<span class="built_in">$</span>OnAssemblyException: </span><br><span class="line">Error has been observed at the following site(s):</span><br><span class="line">	|<span class="built_in">_</span> checkpoint â‡¢ org.springframework.cloud.gateway.filter.WeightCalculatorWebFilter [DefaultWebFilterChain]</span><br><span class="line">	|<span class="built_in">_</span> checkpoint â‡¢ HTTP GET &quot;/payment/lb&quot; [ExceptionHandlingWebHandler]</span><br></pre></td></tr></table></figure>


</blockquote>
<h4 id="Before-Route-Predicate"><a href="#Before-Route-Predicate" class="headerlink" title="Before Route Predicate"></a>Before Route Predicate</h4><blockquote>
<p>åœ¨æŒ‡å®šæ—¶é—´å‰æ‰å¯ä»¥è®¿é—®</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh_plus</span></span><br><span class="line">  <span class="attr">uri:</span> <span class="string">lb://cloud-payment-service</span></span><br><span class="line">  <span class="attr">predicates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Path=/payment/lb/**</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">After=2022-12-25T15:10:00.000+08:00[Asia/Shanghai]</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Before=2023-12-25T15:10:00.000+08:00[Asia/Shanghai]</span></span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="Between-Route-Predicate"><a href="#Between-Route-Predicate" class="headerlink" title="Between Route Predicate"></a>Between Route Predicate</h4><blockquote>
<p>åœ¨æŒ‡å®šæ—¶é—´ä¹‹é—´æ‰å¯ä»¥è®¿é—®</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh_plus</span></span><br><span class="line">  <span class="attr">uri:</span> <span class="string">lb://cloud-payment-service</span></span><br><span class="line">  <span class="attr">predicates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Path=/payment/lb/**</span></span><br><span class="line">    <span class="comment">#åœ¨æŒ‡å®šæ—¶é—´ä¹‹åæ‰å¯ä»¥è®¿é—®</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">After=2022-12-25T15:10:00.000+08:00[Asia/Shanghai]</span></span><br><span class="line">    <span class="comment">#åœ¨æŒ‡å®šæ—¶é—´ä¹‹å‰æ‰å¯ä»¥è®¿é—®</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Before=2023-12-25T15:10:00.000+08:00[Asia/Shanghai]</span></span><br><span class="line">    <span class="comment">#åœ¨æŒ‡å®šæ—¶é—´ä¹‹é—´æ‰å¯ä»¥è®¿é—®</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Between=2020-02-02T17:45:06.206+08:00[Asia/Shanghai],2020-03-25T18:59:06.206+08:00[Asia/Shanghai]</span></span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="Cookie-Route-Predicate"><a href="#Cookie-Route-Predicate" class="headerlink" title="Cookie Route Predicate"></a>Cookie Route Predicate</h4><blockquote>
<p>Cookie Route Predicateéœ€è¦ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯ Cookie name ï¼Œä¸€ä¸ªæ˜¯æ­£åˆ™è¡¨è¾¾å¼ã€‚<br>è·¯ç”±è§„åˆ™ä¼šé€šè¿‡è·å–å¯¹åº”çš„ Cookie name çš„å€¼å’Œæ­£åˆ™è¡¨è¾¾å¼å»åŒ¹é…ï¼Œå¦‚æœåŒ¹é…ä¸Šå°±ä¼šæ‰§è¡Œè·¯ç”±ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…ä¸Šåˆ™ä¸æ‰§è¡Œ</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh_plus</span></span><br><span class="line">  <span class="attr">uri:</span> <span class="string">lb://cloud-payment-service</span></span><br><span class="line">  <span class="attr">predicates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Path=/payment/lb/**</span></span><br><span class="line">    <span class="comment">#åœ¨æŒ‡å®šæ—¶é—´ä¹‹åæ‰å¯ä»¥è®¿é—®</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">After=2022-12-25T15:10:00.000+08:00[Asia/Shanghai]</span></span><br><span class="line">    <span class="comment">#åœ¨æŒ‡å®šæ—¶é—´ä¹‹å‰æ‰å¯ä»¥è®¿é—®</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Before=2023-12-25T15:10:00.000+08:00[Asia/Shanghai]</span></span><br><span class="line">    <span class="comment">#åœ¨æŒ‡å®šæ—¶é—´ä¹‹é—´æ‰å¯ä»¥è®¿é—®</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Between=2020-02-02T17:45:06.206+08:00[Asia/Shanghai],2020-03-25T18:59:06.206+08:00[Asia/Shanghai]</span></span><br><span class="line">    <span class="comment">#æºå¸¦åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼liufeiçš„cookieæ‰èƒ½è®¿é—®</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Cookie=username,liufei</span></span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•ï¼š</p>
<p>curl <a target="_blank" rel="noopener" href="http://localhost:9527/payment/lb">http://localhost:9527/payment/lb</a> â€“cookie â€œusername&#x3D;liufeiâ€</p>
</blockquote>
<h4 id="Header-Route-Predicate"><a href="#Header-Route-Predicate" class="headerlink" title="Header Route Predicate"></a>Header Route Predicate</h4><p>ä¸¤ä¸ªå‚æ•°ï¼šä¸€ä¸ªæ˜¯å±æ€§åç§°å’Œä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œè¿™ä¸ªå±æ€§å€¼å’Œæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…åˆ™æ‰§è¡Œã€‚</p>
<blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh_plus</span></span><br><span class="line">  <span class="attr">uri:</span> <span class="string">lb://cloud-payment-service</span></span><br><span class="line">  <span class="attr">predicates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Path=/payment/lb/**</span></span><br><span class="line">    <span class="comment">#åœ¨æŒ‡å®šæ—¶é—´ä¹‹åæ‰å¯ä»¥è®¿é—®</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">After=2022-12-25T15:10:00.000+08:00[Asia/Shanghai]</span></span><br><span class="line">    <span class="comment">#åœ¨æŒ‡å®šæ—¶é—´ä¹‹å‰æ‰å¯ä»¥è®¿é—®</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Before=2023-12-25T15:10:00.000+08:00[Asia/Shanghai]</span></span><br><span class="line">    <span class="comment">#åœ¨æŒ‡å®šæ—¶é—´ä¹‹é—´æ‰å¯ä»¥è®¿é—®</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Between=2022-02-02T17:45:06.206+08:00[Asia/Shanghai],2024-03-25T18:59:06.206+08:00[Asia/Shanghai]</span></span><br><span class="line">    <span class="comment">#æºå¸¦åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼liufeiçš„cookieæ‰èƒ½è®¿é—®</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Cookie=username,liufei</span></span><br><span class="line">    <span class="comment">#è¯·æ±‚å¤´è¦æœ‰X-Request-Idå±æ€§å¹¶ä¸”å€¼ä¸ºæ•´æ•°çš„æ­£åˆ™è¡¨è¾¾å¼</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Header=X-Request-Id,</span> <span class="string">\d+</span></span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•ï¼šcurl <a target="_blank" rel="noopener" href="http://localhost:9527/payment/lb">http://localhost:9527/payment/lb</a> -H â€œX-Request-Id:123â€</p>
</blockquote>
<h4 id="Host-Route-Predicate"><a href="#Host-Route-Predicate" class="headerlink" title="Host Route Predicate"></a>Host Route Predicate</h4><p>Host Route Predicate æ¥æ”¶ä¸€ç»„å‚æ•°ï¼Œä¸€ç»„åŒ¹é…çš„åŸŸååˆ—è¡¨ï¼Œè¿™ä¸ªæ¨¡æ¿æ˜¯ä¸€ä¸ª ant åˆ†éš”çš„æ¨¡æ¿ï¼Œç”¨ . å·ä½œä¸ºåˆ†éš”ç¬¦ã€‚å®ƒé€šè¿‡å‚æ•°ä¸­çš„ä¸»æœºåœ°å€ä½œä¸ºåŒ¹é…è§„åˆ™ã€‚</p>
<blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh_plus</span></span><br><span class="line">  <span class="attr">uri:</span> <span class="string">lb://cloud-payment-service</span></span><br><span class="line">  <span class="attr">predicates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Path=/payment/lb/**</span></span><br><span class="line">    <span class="comment">#åœ¨æŒ‡å®šæ—¶é—´ä¹‹åæ‰å¯ä»¥è®¿é—®</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">After=2022-12-25T15:10:00.000+08:00[Asia/Shanghai]</span></span><br><span class="line">    <span class="comment">#åœ¨æŒ‡å®šæ—¶é—´ä¹‹å‰æ‰å¯ä»¥è®¿é—®</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Before=2023-12-25T15:10:00.000+08:00[Asia/Shanghai]</span></span><br><span class="line">    <span class="comment">#åœ¨æŒ‡å®šæ—¶é—´ä¹‹é—´æ‰å¯ä»¥è®¿é—®</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Between=2022-02-02T17:45:06.206+08:00[Asia/Shanghai],2024-03-25T18:59:06.206+08:00[Asia/Shanghai]</span></span><br><span class="line">    <span class="comment">#æºå¸¦åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼liufeiçš„cookieæ‰èƒ½è®¿é—®</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Cookie=username,liufei</span></span><br><span class="line">    <span class="comment">#è¯·æ±‚å¤´è¦æœ‰X-Request-Idå±æ€§å¹¶ä¸”å€¼ä¸ºæ•´æ•°çš„æ­£åˆ™è¡¨è¾¾å¼</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Header=X-Request-Id,</span> <span class="string">\d+</span></span><br><span class="line">    <span class="comment">#ä¸€ç»„åŒ¹é…çš„åŸŸååˆ—è¡¨</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Host=**.example.com</span></span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•ï¼š</p>
<p>æ­£ç¡®ï¼šcurl <a target="_blank" rel="noopener" href="http://localhost:9527/payment/lb">http://localhost:9527/payment/lb</a> -H â€œHost: java.example.comâ€<br>é”™è¯¯ï¼šcurl <a target="_blank" rel="noopener" href="http://localhost:9527/payment/lb">http://localhost:9527/payment/lb</a> -H â€œHost: java.example.netâ€</p>
</blockquote>
<h4 id="Method-Route-Predicate"><a href="#Method-Route-Predicate" class="headerlink" title="Method Route Predicate"></a>Method Route Predicate</h4><p>è¯·æ±‚æ–¹å¼æ–­è¨€</p>
<blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh_plus</span></span><br><span class="line">  <span class="attr">uri:</span> <span class="string">lb://cloud-payment-service</span></span><br><span class="line">  <span class="attr">predicates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Path=/payment/lb/**</span></span><br><span class="line">    <span class="comment">#åœ¨æŒ‡å®šæ—¶é—´ä¹‹åæ‰å¯ä»¥è®¿é—®</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">After=2022-12-25T15:10:00.000+08:00[Asia/Shanghai]</span></span><br><span class="line">    <span class="comment">#åœ¨æŒ‡å®šæ—¶é—´ä¹‹å‰æ‰å¯ä»¥è®¿é—®</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Before=2023-12-25T15:10:00.000+08:00[Asia/Shanghai]</span></span><br><span class="line">    <span class="comment">#åœ¨æŒ‡å®šæ—¶é—´ä¹‹é—´æ‰å¯ä»¥è®¿é—®</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Between=2022-02-02T17:45:06.206+08:00[Asia/Shanghai],2024-03-25T18:59:06.206+08:00[Asia/Shanghai]</span></span><br><span class="line">    <span class="comment">#æºå¸¦åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼liufeiçš„cookieæ‰èƒ½è®¿é—®</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Cookie=username,liufei</span></span><br><span class="line">    <span class="comment">#è¯·æ±‚å¤´è¦æœ‰X-Request-Idå±æ€§å¹¶ä¸”å€¼ä¸ºæ•´æ•°çš„æ­£åˆ™è¡¨è¾¾å¼</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Header=X-Request-Id,</span> <span class="string">\d+</span></span><br><span class="line">    <span class="comment">#ä¸€ç»„åŒ¹é…çš„åŸŸååˆ—è¡¨</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Host=**.example.com</span></span><br><span class="line">    <span class="comment">#è¯·æ±‚æ–¹å¼</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Method=GET</span></span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•ï¼šcurl -X -POST <a target="_blank" rel="noopener" href="http://localhost:9527/payment/lb">http://localhost:9527/payment/lb</a> </p>
</blockquote>
<h4 id="Path-Route-Predicate"><a href="#Path-Route-Predicate" class="headerlink" title="Path Route Predicate"></a>Path Route Predicate</h4><p>æ ¹æ®è·¯å¾„åŒ¹é…çš„è§„åˆ™</p>
<blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh_plus</span></span><br><span class="line">  <span class="attr">uri:</span> <span class="string">lb://cloud-payment-service</span></span><br><span class="line">  <span class="attr">predicates:</span></span><br><span class="line">  	<span class="comment">#æ ¹æ®è·¯å¾„åŒ¹é…</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Path=/payment/lb/**</span></span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="Query-Route-Predicate"><a href="#Query-Route-Predicate" class="headerlink" title="Query Route Predicate"></a>Query Route Predicate</h4><p>æ ¹æ®æŸ¥è¯¢å‚æ•°è¿›è¡ŒåŒ¹é…</p>
<blockquote>
<p>æ”¯æŒä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å±æ€§åï¼Œä¸€ä¸ªä¸ºå±æ€§å€¼ï¼Œå±æ€§å€¼å¯ä»¥æ˜¯æ­£åˆ™è¡¨è¾¾å¼ã€‚</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh_plus</span></span><br><span class="line">  <span class="attr">uri:</span> <span class="string">lb://cloud-payment-service</span></span><br><span class="line">  <span class="attr">predicates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Path=/payment/lb/**</span></span><br><span class="line">    <span class="comment">#åœ¨æŒ‡å®šæ—¶é—´ä¹‹åæ‰å¯ä»¥è®¿é—®</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">After=2022-12-25T15:10:00.000+08:00[Asia/Shanghai]</span></span><br><span class="line">    <span class="comment">#åœ¨æŒ‡å®šæ—¶é—´ä¹‹å‰æ‰å¯ä»¥è®¿é—®</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Before=2023-12-25T15:10:00.000+08:00[Asia/Shanghai]</span></span><br><span class="line">    <span class="comment">#åœ¨æŒ‡å®šæ—¶é—´ä¹‹é—´æ‰å¯ä»¥è®¿é—®</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Between=2022-02-02T17:45:06.206+08:00[Asia/Shanghai],2024-03-25T18:59:06.206+08:00[Asia/Shanghai]</span></span><br><span class="line">    <span class="comment">#æºå¸¦åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼liufeiçš„cookieæ‰èƒ½è®¿é—®</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Cookie=username,liufei</span></span><br><span class="line">    <span class="comment">#è¯·æ±‚å¤´è¦æœ‰X-Request-Idå±æ€§å¹¶ä¸”å€¼ä¸ºæ•´æ•°çš„æ­£åˆ™è¡¨è¾¾å¼</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Header=X-Request-Id,</span> <span class="string">\d+</span></span><br><span class="line">    <span class="comment">#ä¸€ç»„åŒ¹é…çš„åŸŸååˆ—è¡¨</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Host=**.example.com</span></span><br><span class="line">    <span class="comment">#è¯·æ±‚æ–¹å¼</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Method=GET</span></span><br><span class="line">    <span class="comment"># è¦æœ‰å‚æ•°åusernameå¹¶ä¸”å€¼è¿˜è¦æ˜¯æ•´æ•°æ‰èƒ½è·¯ç”±</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Query=username,</span> <span class="string">\d+</span></span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="Filterçš„ä½¿ç”¨"><a href="#Filterçš„ä½¿ç”¨" class="headerlink" title="Filterçš„ä½¿ç”¨"></a>Filterçš„ä½¿ç”¨</h3><h4 id="æ¦‚è¿°-5"><a href="#æ¦‚è¿°-5" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h4><blockquote>
<p>è·¯ç”±è¿‡æ»¤å™¨å¯ç”¨äºä¿®æ”¹è¿›å…¥çš„HTTPè¯·æ±‚å’Œè¿”å›çš„HTTPå“åº”ï¼Œè·¯ç”±è¿‡æ»¤å™¨åªèƒ½æŒ‡å®šè·¯ç”±è¿›è¡Œä½¿ç”¨ã€‚</p>
<p>Spring Cloud Gateway å†…ç½®äº†å¤šç§è·¯ç”±è¿‡æ»¤å™¨ï¼Œå®ƒä»¬éƒ½ç”±GatewayFilterçš„å·¥å‚ç±»æ¥äº§ç”Ÿã€‚</p>
<p>SpringCloudGatewayçš„Filterï¼šå‰ç½®åç½®</p>
<p>å¸¸ç”¨çš„GatewayFilterï¼š<a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.1.RELEASE/reference/html/#the-addrequestparameter-gatewayfilter-factory">https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.1.RELEASE/reference/html/#the-addrequestparameter-gatewayfilter-factory</a></p>
</blockquote>
<h4 id="è‡ªå®šä¹‰è¿‡æ»¤å™¨"><a href="#è‡ªå®šä¹‰è¿‡æ»¤å™¨" class="headerlink" title="è‡ªå®šä¹‰è¿‡æ»¤å™¨"></a>è‡ªå®šä¹‰è¿‡æ»¤å™¨</h4><p>ä½œç”¨ï¼šå…¨å±€æ—¥å¿—è®°å½•ï¼Œç»Ÿä¸€ç½‘å…³é‰´æƒ</p>
<p>ä¸»è¦æ­¥éª¤ï¼š<strong>implements GlobalFilter,Ordered</strong></p>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.springcloud.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilterChain;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GlobalFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.Ordered;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.server.ServerWebExchange;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyLogGateWayFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span>, Ordered &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Time: &quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>() + <span class="string">&quot; æ‰§è¡Œäº†è‡ªå®šä¹‰çš„å…¨å±€è¿‡æ»¤å™¨: MyLogGateWayFilter&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">uname</span> <span class="operator">=</span> exchange.getRequest().getQueryParams().getFirst(<span class="string">&quot;uname&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (uname == <span class="literal">null</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;ç”¨æˆ·åä¸ºnullï¼Œæ— æ³•ç™»å½•&quot;</span>);</span><br><span class="line">            exchange.getResponse().setStatusCode(HttpStatus.NOT_ACCEPTABLE);</span><br><span class="line">            <span class="keyword">return</span> exchange.getResponse().setComplete();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•ï¼šè®¿é—® <a target="_blank" rel="noopener" href="http://localhost:9527/payment/lb?uname=tom%EF%BC%8C%E5%A6%82%E6%9E%9C%E4%B8%8D%E5%8A%A0uname%E5%88%99%E6%97%A0%E6%B3%95%E6%AD%A3%E5%B8%B8%E8%B7%AF%E7%94%B1">http://localhost:9527/payment/lb?uname=tomï¼Œå¦‚æœä¸åŠ unameåˆ™æ— æ³•æ­£å¸¸è·¯ç”±</a></p>
<h1 id="SpringCloud-Config-åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒ"><a href="#SpringCloud-Config-åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒ" class="headerlink" title="SpringCloud Config åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒ"></a>SpringCloud Config åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒ</h1><h2 id="æ¦‚è¿°-6"><a href="#æ¦‚è¿°-6" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><blockquote>
<p><strong>åˆ†å¸ƒå¼ç³»ç»Ÿé¢ä¸´çš„é…ç½®é—®é¢˜ï¼š</strong></p>
<p>å¾®æœåŠ¡æ„å‘³ç€è¦å°†å•ä½“åº”ç”¨ä¸­çš„ä¸šåŠ¡æ‹†åˆ†æˆä¸€ä¸ªä¸ªå­æœåŠ¡ï¼Œæ¯ä¸ªæœåŠ¡çš„ç²’åº¦ç›¸å¯¹è¾ƒå°ï¼Œå› æ­¤ç³»ç»Ÿä¸­ä¼šå‡ºç°å¤§é‡çš„æœåŠ¡ã€‚ç”±äºæ¯ä¸ªæœåŠ¡éƒ½éœ€è¦å¿…è¦çš„é…ç½®ä¿¡æ¯æ‰èƒ½è¿è¡Œï¼Œæ‰€ä»¥ä¸€å¥—é›†ä¸­å¼çš„ã€åŠ¨æ€çš„é…ç½®ç®¡ç†è®¾æ–½æ˜¯å¿…ä¸å¯å°‘çš„ã€‚SpringCloudæä¾›äº†ConfigServeræ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æ¯ä¸€ä¸ªå¾®æœåŠ¡è‡ªå·±å¸¦ç€ä¸€ä¸ªapplication.ymlã€‚</p>
</blockquote>
<blockquote>
<p><strong>å®šä¹‰ï¼š</strong></p>
<p><img src="/2023/03/25/SpringCloud/Java\Document\SpringCloud\images\image-20221228134954874.png" alt="image-20221228134954874"></p>
<ol>
<li><p>SpringCloud Configä¸ºå¾®æœåŠ¡æ¶æ„ä¸­çš„å¾®æœåŠ¡æä¾›é›†ä¸­åŒ–çš„å¤–éƒ¨é…ç½®æ”¯æŒï¼Œé…ç½®æœåŠ¡å™¨ä¸ºå„ä¸ªä¸åŒå¾®æœåŠ¡åº”ç”¨çš„æ‰€æœ‰ç¯å¢ƒæä¾›äº†ä¸€ä¸ªä¸­å¿ƒåŒ–çš„å¤–éƒ¨é…ç½®ã€‚</p>
</li>
<li><p>SpringCloud Configåˆ†ä¸ºæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¸¤éƒ¨åˆ†ã€‚</p>
<p> ï¼ˆ1ï¼‰æœåŠ¡ç«¯ä¹Ÿç§°ä¸ºåˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒï¼Œå®ƒæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å¾®æœåŠ¡åº”ç”¨ï¼Œç”¨æ¥è¿æ¥é…ç½®æœåŠ¡å™¨å¹¶ä¸ºå®¢æˆ·ç«¯æä¾›è·å–é…ç½®ä¿¡æ¯ï¼ŒåŠ å¯†&#x2F;è§£å¯†ä¿¡æ¯ç­‰è®¿é—®æ¥å£ã€‚</p>
<p> ï¼ˆ2ï¼‰å®¢æˆ·ç«¯åˆ™æ˜¯é€šè¿‡æŒ‡å®šçš„é…ç½®ä¸­å¿ƒæ¥ç®¡ç†åº”ç”¨èµ„æºï¼Œä»¥åŠä¸ä¸šåŠ¡ç›¸å…³çš„é…ç½®å†…å®¹ï¼Œå¹¶åœ¨å¯åŠ¨çš„æ—¶å€™ä»é…ç½®ä¸­å¿ƒè·å–å’ŒåŠ è½½é…ç½®ä¿¡æ¯é…ç½®æœåŠ¡å™¨é»˜è®¤é‡‡ç”¨ git æ¥å­˜å‚¨é…ç½®ä¿¡æ¯ï¼Œè¿™æ ·å°±æœ‰åŠ©äºå¯¹ç¯å¢ƒé…ç½®è¿›è¡Œç‰ˆæœ¬ç®¡ç†ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡gitå®¢æˆ·ç«¯å·¥å…·æ¥æ–¹ä¾¿çš„ç®¡ç†å’Œè®¿é—®é…ç½®å†…å®¹ã€‚</p>
</li>
</ol>
</blockquote>
<h2 id="ä½œç”¨-2"><a href="#ä½œç”¨-2" class="headerlink" title="ä½œç”¨"></a>ä½œç”¨</h2><blockquote>
<ol>
<li>é›†ä¸­ç®¡ç†é…ç½®æ–‡ä»¶</li>
<li>ä¸åŒç¯å¢ƒä¸åŒé…ç½®ï¼ŒåŠ¨æ€åŒ–çš„é…ç½®æ›´æ–°ï¼Œåˆ†ç¯å¢ƒéƒ¨ç½²æ¯”å¦‚ dev&#x2F;test&#x2F;prod&#x2F;beta&#x2F;release</li>
<li>è¿è¡ŒæœŸé—´åŠ¨æ€è°ƒæ•´é…ç½®ï¼Œä¸å†éœ€è¦åœ¨æ¯ä¸ªæœåŠ¡éƒ¨ç½²çš„æœºå™¨ä¸Šç¼–å†™é…ç½®æ–‡ä»¶ï¼ŒæœåŠ¡ä¼šå‘é…ç½®ä¸­å¿ƒç»Ÿä¸€æ‹‰å–é…ç½®è‡ªå·±çš„ä¿¡æ¯</li>
<li>å½“é…ç½®å‘ç”Ÿå˜åŠ¨æ—¶ï¼ŒæœåŠ¡ä¸éœ€è¦é‡å¯å³å¯æ„ŸçŸ¥åˆ°é…ç½®çš„å˜åŒ–å¹¶åº”ç”¨æ–°çš„é…ç½®</li>
<li>å°†é…ç½®ä¿¡æ¯ä»¥RESTæ¥å£çš„å½¢å¼æš´éœ²</li>
</ol>
</blockquote>
<p><strong>è¯´æ˜ï¼šç”±äºSpringCloud Configé»˜è®¤ä½¿ç”¨Gitæ¥å­˜å‚¨é…ç½®æ–‡ä»¶(ä¹Ÿæœ‰å…¶å®ƒæ–¹å¼,æ¯”å¦‚æ”¯æŒSVNå’Œæœ¬åœ°æ–‡ä»¶)ï¼Œä½†æœ€æ¨èçš„è¿˜æ˜¯Gitï¼Œè€Œä¸”ä½¿ç”¨çš„æ˜¯http&#x2F;httpsè®¿é—®çš„å½¢å¼ã€‚</strong></p>
<p>æ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-static/spring-cloud-config/2.2.1.RELEASE/reference/html/">https://cloud.spring.io/spring-cloud-static/spring-cloud-config/2.2.1.RELEASE/reference/html/</a></p>
<h2 id="ConfigæœåŠ¡ç«¯é…ç½®ä¸æµ‹è¯•"><a href="#ConfigæœåŠ¡ç«¯é…ç½®ä¸æµ‹è¯•" class="headerlink" title="ConfigæœåŠ¡ç«¯é…ç½®ä¸æµ‹è¯•"></a>ConfigæœåŠ¡ç«¯é…ç½®ä¸æµ‹è¯•</h2><blockquote>
<p>ä¸»è¦æ­¥éª¤ï¼š</p>
<ol>
<li><p>åœ¨githubæ–°å»ºä»“åº“ springcloud-configï¼Œä¿å­˜é…ç½®æ–‡ä»¶ ï¼Œæ¨¡æ‹Ÿå…¬å…±é…ç½®</p>
<p> config-dev.yml</p>
 <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">config:</span></span><br><span class="line">  <span class="attr">info:</span> <span class="string">master</span> <span class="string">branch,</span> <span class="string">springcloud-config/config-dev.yml,</span> <span class="string">version</span> <span class="string">=</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p> config-test.yml</p>
 <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">config:</span></span><br><span class="line">  <span class="attr">info:</span> <span class="string">master</span> <span class="string">branch,</span> <span class="string">springcloud-config/config-test.yml,</span> <span class="string">version</span> <span class="string">=</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p> config-prod.yml</p>
 <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">config:</span></span><br><span class="line">  <span class="attr">info:</span> <span class="string">master</span> <span class="string">branch,</span> <span class="string">springcloud-config/config-prod.yml,</span> <span class="string">version</span> <span class="string">=</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>æ–°å»ºæ¨¡å— cloud-config-center-3344 ä½œä¸ºSpringCloudçš„é…ç½®ä¸­å¿ƒæ¨¡å—</p>
<p> å¼•å…¥ä¾èµ–ï¼š</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p> ymlé…ç½®ï¼š</p>
 <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3344</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-config-center</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">          <span class="comment">#ä½¿ç”¨httpsä¸æŠ¥é”™</span></span><br><span class="line">          <span class="comment">#uri: git@gitee.com:mineting/springcloud-config.git</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://gitee.com/mineting/springcloud-config.git</span></span><br><span class="line">          <span class="attr">username:</span> <span class="number">18220549581</span></span><br><span class="line">          <span class="attr">password:</span> <span class="string">169683liufei</span></span><br><span class="line">          <span class="comment">#æœç´¢ç›®å½•</span></span><br><span class="line">          <span class="attr">search-paths:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">springcloud-config</span></span><br><span class="line">      <span class="comment">#åˆ†æ”¯</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka</span></span><br></pre></td></tr></table></figure>

<p> å¯åŠ¨ç±»ï¼š</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableConfigServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigCenterMain3344</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ConfigCenterMain3344.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æµ‹è¯•ï¼šé€šè¿‡Configå¾®æœåŠ¡æ˜¯å¦å¯ä»¥ä»GitHubä¸Šè·å–é…ç½®å†…å®¹</p>
<p> è®¿é—®ï¼š<a target="_blank" rel="noopener" href="http://config-3344.com:3344/master/config-dev.yml">http://config-3344.com:3344/master/config-dev.yml</a></p>
<p> æ­¤æ—¶SpringCloud Configå·²ç»é€šè¿‡GitHubè·å–é…ç½®ä¿¡æ¯ã€‚</p>
</li>
</ol>
</blockquote>
<h2 id="é…ç½®è¯»å–è§„åˆ™"><a href="#é…ç½®è¯»å–è§„åˆ™" class="headerlink" title="é…ç½®è¯»å–è§„åˆ™"></a>é…ç½®è¯»å–è§„åˆ™</h2><ol>
<li><p>æ ¹æ®åˆ†æ”¯ï¼š**&#x2F;{label}&#x2F;{application}-{profile}.yml**</p>
<p> masteråˆ†æ”¯ï¼š<a target="_blank" rel="noopener" href="http://config-3344.com:3344/master/config-dev.yml">http://config-3344.com:3344/master/config-dev.yml</a></p>
<p> devåˆ†æ”¯ï¼š<a target="_blank" rel="noopener" href="http://config-3344.com:3344/dev/config-dev.yml">http://config-3344.com:3344/dev/config-dev.yml</a></p>
</li>
<li><p>ä¸å¸¦åˆ†æ”¯ï¼Œé»˜è®¤ä½¿ç”¨é…ç½®æ–‡ä»¶çš„labelï¼Œ**&#x2F;{application}-{profile}.yml**</p>
<p> <a target="_blank" rel="noopener" href="http://config-3344.com:3344/config-dev.yml">http://config-3344.com:3344/config-dev.yml</a></p>
</li>
<li><p>é¡ºåºä¸åŒï¼Œ&#x2F;{application}&#x2F;{profile}[&#x2F;{label}]</p>
<p> <a target="_blank" rel="noopener" href="http://config-3344.com:3344/config/dev/master">http://config-3344.com:3344/config/dev/master</a></p>
<p> <a target="_blank" rel="noopener" href="http://config-3344.com:3344/config/test/dev">http://config-3344.com:3344/config/test/dev</a></p>
</li>
</ol>
<h2 id="Configå®¢æˆ·ç«¯é…ç½®ä¸æµ‹è¯•"><a href="#Configå®¢æˆ·ç«¯é…ç½®ä¸æµ‹è¯•" class="headerlink" title="Configå®¢æˆ·ç«¯é…ç½®ä¸æµ‹è¯•"></a>Configå®¢æˆ·ç«¯é…ç½®ä¸æµ‹è¯•</h2><ol>
<li><p>æ–°å»ºæ¨¡å— cloud-config-client-3355</p>
</li>
<li><p>pom.xml</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>é…ç½®æ–‡ä»¶</p>
<blockquote>
<p>æ³¨æ„ï¼šã€æ­¤å¤„ä½¿ç”¨bootstrrap.ymlã€‘</p>
<p>applicaiton.ymlæ˜¯ç”¨æˆ·çº§çš„èµ„æºé…ç½®é¡¹ï¼Œbootstrap.ymlæ˜¯ç³»ç»Ÿçº§çš„ï¼Œä¼˜å…ˆçº§æ›´åŠ é«˜ã€‚</p>
<p>Spring Cloudä¼šåˆ›å»ºä¸€ä¸ªâ€œBootstrap Contextâ€ï¼Œä½œä¸ºSpringåº”ç”¨çš„<code>Application Context</code>çš„çˆ¶ä¸Šä¸‹æ–‡ã€‚åˆå§‹åŒ–çš„æ—¶å€™ï¼Œ<code>Bootstrap Context</code>è´Ÿè´£ä»å¤–éƒ¨æºåŠ è½½é…ç½®å±æ€§å¹¶è§£æé…ç½®ã€‚è¿™ä¸¤ä¸ªä¸Šä¸‹æ–‡å…±äº«ä¸€ä¸ªä»å¤–éƒ¨è·å–çš„<code>Environment</code>ã€‚</p>
<p><code>Bootstrap</code>å±æ€§æœ‰é«˜ä¼˜å…ˆçº§ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒä»¬ä¸ä¼šè¢«æœ¬åœ°é…ç½®è¦†ç›–ã€‚ <code>Bootstrap context</code>å’Œ<code>Application Context</code>æœ‰ç€ä¸åŒçš„çº¦å®šï¼Œæ‰€ä»¥æ–°å¢äº†ä¸€ä¸ª<code>bootstrap.yml</code>æ–‡ä»¶ï¼Œä¿è¯<code>Bootstrap Context</code>å’Œ<code>Application Context</code>é…ç½®çš„åˆ†ç¦»ã€‚</p>
<p>è¦å°†Clientæ¨¡å—ä¸‹çš„application.ymlæ–‡ä»¶æ”¹ä¸ºbootstrap.yml,è¿™æ˜¯å¾ˆå…³é”®çš„ï¼Œå› ä¸ºbootstrap.ymlæ˜¯æ¯”application.ymlå…ˆåŠ è½½çš„ã€‚bootstrap.ymlä¼˜å…ˆçº§é«˜äºapplication.ymlã€‚</p>
<p> bootstrap.ymlï¼š</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3355</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">config-client</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="comment">#Configå®¢æˆ·ç«¯é…ç½®ï¼šhttp://config-3344.com:3344/master/config-dev.yml</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span></span><br><span class="line">      <span class="comment">#é…ç½®æ–‡ä»¶åç§°</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">      <span class="comment">#&#123;profile&#125;åç§°</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">dev</span></span><br><span class="line">      <span class="comment">#é…ç½®ä¸­å¿ƒåœ°å€</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://config-3344.com:3344</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka</span></span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>å¯åŠ¨ç±»</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigClientMain3355</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ConfigClientMain3355.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Controller</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigClientController</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;config.info&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String configInfo;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/configInfo&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getConfigInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> configInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æµ‹è¯•ï¼š<a target="_blank" rel="noopener" href="http://localhost:3355/configInfo">http://localhost:3355/configInfo</a></p>
</li>
</ol>
<blockquote>
<p>æ³¨æ„ï¼šæ­¤æ—¶å­˜åœ¨çš„é—®é¢˜ï¼šåŠ¨æ€åˆ·æ–°é…ç½®</p>
<ol>
<li>Linuxè¿ç»´ä¿®æ”¹GitHubä¸Šçš„é…ç½®æ–‡ä»¶å†…å®¹åšè°ƒæ•´</li>
<li>åˆ·æ–°3344ï¼Œå‘ç°ConfigServeré…ç½®ä¸­å¿ƒç«‹åˆ»å“åº”</li>
<li>åˆ·æ–°3355ï¼Œå‘ç°ConfigClientå®¢æˆ·ç«¯æ²¡æœ‰ä»»ä½•å“åº”</li>
<li>3355æ²¡æœ‰å˜åŒ–é™¤éè‡ªå·±é‡å¯æˆ–è€…é‡æ–°åŠ è½½<strong>ã€é—®é¢˜ã€‘</strong></li>
</ol>
</blockquote>
<h2 id="Configå®¢æˆ·ç«¯ä¹‹åŠ¨æ€åˆ·æ–°"><a href="#Configå®¢æˆ·ç«¯ä¹‹åŠ¨æ€åˆ·æ–°" class="headerlink" title="Configå®¢æˆ·ç«¯ä¹‹åŠ¨æ€åˆ·æ–°"></a>Configå®¢æˆ·ç«¯ä¹‹åŠ¨æ€åˆ·æ–°</h2><p>ä¸»è¦è§£å†³ï¼šæ¯æ¬¡æ›´æ–°é…ç½®éƒ½è¦é‡å¯å®¢æˆ·ç«¯å¾®æœåŠ¡3355</p>
<p>ä¸»è¦ä¿®æ”¹ï¼š</p>
<blockquote>
<ol>
<li><p>å¼•å…¥ä¾èµ–</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¿®æ”¹ymlé…ç½®ï¼Œæš´éœ²æ–­ç‚¹</p>
 <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æš´éœ²ç›‘æ§ç«¯ç‚¹</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¿®æ”¹Controllerï¼Œæ·»åŠ  @RefreshScope</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="comment">//åŠ¨æ€åˆ·æ–°é…ç½®</span></span><br><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigClientController</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;config.info&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String configInfo;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/configInfo&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getConfigInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> configInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>åŒæ—¶éœ€è¦è¿ç»´äººå‘˜å‘é€Postè¯·æ±‚åˆ·æ–°3355</p>
<p> curl -X POST â€œ<a target="_blank" rel="noopener" href="http://localhost:3355/actuator/refresh">http://localhost:3355/actuator/refresh</a>â€œ</p>
</li>
<li><p>æµ‹è¯•ï¼Œæ­¤æ—¶è®¿é—® <a target="_blank" rel="noopener" href="http://localhost:3355/configInfo">http://localhost:3355/configInfo</a> å³å¯æ­£å¸¸åˆ·æ–°</p>
</li>
</ol>
</blockquote>
<p><strong>æ³¨æ„ï¼šæ­¤æ—¶è™½ç„¶é¿å…äº†é‡æ–°æœåŠ¡åˆ·æ–°é…ç½®ï¼Œä½†æ˜¯ä»ç„¶å­˜åœ¨é—®é¢˜ï¼š</strong></p>
<p><strong>æ¯”å¦‚ï¼Œå¦‚æœæœ‰å¤šä¸ªé…ç½®ï¼Œæ¯ä¸ªå¾®æœåŠ¡éƒ½è¦æ‰§è¡Œä¸€æ¬¡postè¯·æ±‚ï¼Œä¾ç„¶éœ€è¦æ‰‹åŠ¨åˆ·æ–°</strong></p>
<h1 id="SpringCloud-Bus-æ¶ˆæ¯æ€»çº¿"><a href="#SpringCloud-Bus-æ¶ˆæ¯æ€»çº¿" class="headerlink" title="SpringCloud Bus æ¶ˆæ¯æ€»çº¿"></a>SpringCloud Bus æ¶ˆæ¯æ€»çº¿</h1><h2 id="æ¦‚è¿°-7"><a href="#æ¦‚è¿°-7" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><blockquote>
<p>Spring Cloud Bus é…åˆ Spring Cloud Config ä½¿ç”¨å¯ä»¥å®ç°é…ç½®çš„åŠ¨æ€åˆ·æ–°ã€‚</p>
<p><img src="/2023/03/25/SpringCloud/Java\Document\SpringCloud\images\image-20221230125359725.png" alt="image-20221230125359725"></p>
<p>Spring Cloud Busæ˜¯ç”¨æ¥å°†åˆ†å¸ƒå¼ç³»ç»Ÿçš„èŠ‚ç‚¹ä¸è½»é‡çº§æ¶ˆæ¯ç³»ç»Ÿé“¾æ¥èµ·æ¥çš„æ¡†æ¶ï¼Œå®ƒæ•´åˆäº†Javaçš„äº‹ä»¶å¤„ç†æœºåˆ¶å’Œæ¶ˆæ¯ä¸­é—´ä»¶çš„åŠŸèƒ½ã€‚Spring Clud Busç›®å‰æ”¯æŒRabbitMQå’ŒKafkaã€‚</p>
</blockquote>
<h2 id="ä½œç”¨-3"><a href="#ä½œç”¨-3" class="headerlink" title="ä½œç”¨"></a>ä½œç”¨</h2><blockquote>
<p>Spring Cloud Busèƒ½ç®¡ç†å’Œä¼ æ’­åˆ†å¸ƒå¼ç³»ç»Ÿé—´çš„æ¶ˆæ¯ï¼Œå°±åƒä¸€ä¸ªåˆ†å¸ƒå¼æ‰§è¡Œå™¨ï¼Œå¯ç”¨äºå¹¿æ’­çŠ¶æ€æ›´æ”¹ã€äº‹ä»¶æ¨é€ç­‰ï¼Œä¹Ÿå¯ä»¥å½“ä½œå¾®æœåŠ¡é—´çš„é€šä¿¡é€šé“ã€‚</p>
<img src="/2023/03/25/SpringCloud/Java\Document\SpringCloud\images\image-20221230125547174.png" alt="image-20221230125547174" style="zoom:80%;">
</blockquote>
<h2 id="æ€»çº¿"><a href="#æ€»çº¿" class="headerlink" title="æ€»çº¿"></a>æ€»çº¿</h2><blockquote>
<p>â€‹		åœ¨å¾®æœåŠ¡æ¶æ„çš„ç³»ç»Ÿä¸­ï¼Œé€šå¸¸ä¼šä½¿ç”¨è½»é‡çº§çš„æ¶ˆæ¯ä»£ç†æ¥æ„å»ºä¸€ä¸ªå…±ç”¨çš„æ¶ˆæ¯ä¸»é¢˜ï¼Œå¹¶è®©ç³»ç»Ÿä¸­æ‰€æœ‰å¾®æœåŠ¡å®ä¾‹éƒ½è¿æ¥ä¸Šæ¥ã€‚ç”±äºè¯¥ä¸»é¢˜ä¸­äº§ç”Ÿçš„æ¶ˆæ¯ä¼šè¢«æ‰€æœ‰å®ä¾‹ç›‘å¬å’Œæ¶ˆè´¹ï¼Œæ‰€ä»¥ç§°å®ƒä¸ºæ¶ˆæ¯æ€»çº¿ã€‚åœ¨æ€»çº¿ä¸Šçš„å„ä¸ªå®ä¾‹ï¼Œéƒ½å¯ä»¥æ–¹ä¾¿åœ°å¹¿æ’­ä¸€äº›éœ€è¦è®©å…¶ä»–è¿æ¥åœ¨è¯¥ä¸»é¢˜ä¸Šçš„å®ä¾‹éƒ½çŸ¥é“çš„æ¶ˆæ¯ã€‚</p>
<p>åŸºæœ¬åŸç†<br>ConfigClientå®ä¾‹éƒ½ç›‘å¬MQä¸­åŒä¸€ä¸ªtopicï¼ˆé»˜è®¤æ˜¯springCloudBusï¼‰ã€‚å½“ä¸€ä¸ªæœåŠ¡åˆ·æ–°æ•°æ®çš„æ—¶å€™ï¼Œå®ƒä¼šæŠŠè¿™ä¸ªä¿¡æ¯æ”¾å…¥åˆ°Topicä¸­ï¼Œè¿™æ ·å…¶å®ƒç›‘å¬åŒä¸€Topicçš„æœåŠ¡å°±èƒ½å¾—åˆ°é€šçŸ¥ï¼Œç„¶åå»æ›´æ–°è‡ªèº«çš„é…ç½®ã€‚</p>
</blockquote>
<h2 id="è®¾è®¡æ€æƒ³"><a href="#è®¾è®¡æ€æƒ³" class="headerlink" title="è®¾è®¡æ€æƒ³"></a>è®¾è®¡æ€æƒ³</h2><blockquote>
<p>æ–¹å¼ä¸€ï¼šåˆ©ç”¨æ¶ˆæ¯æ€»çº¿è§¦å‘ä¸€ä¸ªå®¢æˆ·ç«¯&#x2F;bus&#x2F;refresh,è€Œåˆ·æ–°æ‰€æœ‰å®¢æˆ·ç«¯çš„é…ç½®</p>
<img src="/2023/03/25/SpringCloud/Java\Document\SpringCloud\images\image-20221230131107872.png" alt="image-20221230131107872" style="zoom:80%;">

<p>æ–¹å¼äºŒï¼šåˆ©ç”¨æ¶ˆæ¯æ€»çº¿è§¦å‘ä¸€ä¸ªæœåŠ¡ç«¯ConfigServerçš„&#x2F;bus&#x2F;refreshç«¯ç‚¹ï¼Œè€Œåˆ·æ–°æ‰€æœ‰å®¢æˆ·ç«¯çš„é…ç½®</p>
<img src="/2023/03/25/SpringCloud/Java\Document\SpringCloud\images\image-20221230131141545.png" alt="image-20221230131141545" style="zoom:80%;">

<p>æ–¹å¼ä¸€çš„ç¼ºç‚¹ï¼š</p>
<ol>
<li>æ‰“ç ´äº†å¾®æœåŠ¡çš„èŒè´£å•ä¸€æ€§ï¼Œå› ä¸ºå¾®æœåŠ¡æœ¬èº«æ˜¯ä¸šåŠ¡æ¨¡å—ï¼Œå®ƒæœ¬ä¸åº”è¯¥æ‰¿æ‹…é…ç½®åˆ·æ–°çš„èŒè´£ã€‚</li>
<li>ç ´åäº†å¾®æœåŠ¡å„èŠ‚ç‚¹çš„å¯¹ç­‰æ€§ã€‚</li>
<li>æœ‰ä¸€å®šçš„å±€é™æ€§ã€‚ä¾‹å¦‚ï¼Œå¾®æœåŠ¡åœ¨è¿ç§»æ—¶ï¼Œå®ƒçš„ç½‘ç»œåœ°å€å¸¸å¸¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œæ­¤æ—¶å¦‚æœæƒ³è¦åšåˆ°è‡ªåŠ¨åˆ·æ–°ï¼Œé‚£å°±ä¼šå¢åŠ æ›´å¤šçš„ä¿®æ”¹ã€‚</li>
</ol>
</blockquote>
<h2 id="RabbitMQç¯å¢ƒé…ç½®"><a href="#RabbitMQç¯å¢ƒé…ç½®" class="headerlink" title="RabbitMQç¯å¢ƒé…ç½®"></a>RabbitMQç¯å¢ƒé…ç½®</h2><blockquote>
<ol>
<li><p>å®‰è£…Erlangï¼Œä¸‹è½½åœ°å€ï¼š<a target="_blank" rel="noopener" href="http://erlang.org/download/otp_win64_21.3.exe">http://erlang.org/download/otp_win64_21.3.exe</a>	</p>
</li>
<li><p>å®‰è£…RabbitMQï¼Œä¸‹è½½åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://github.com/rabbitmq/rabbitmq-server/releases/tag/v3.11.5">https://github.com/rabbitmq/rabbitmq-server/releases/tag/v3.11.5</a></p>
</li>
<li><p>å¯ç”¨å¯è§†åŒ–æ’ä»¶ç®¡ç†åŠŸèƒ½</p>
<p> è¿›å…¥ rabbitmq_server-3.7.14\sbinç›®å½•ï¼Œæ‰§è¡Œ rabbitmq-plugins enable rabbitmq_management</p>
</li>
<li><p>å¯åŠ¨ ï¼Œè®¿é—® <a target="_blank" rel="noopener" href="http://localhost:15672/%EF%BC%8C%E5%88%9D%E5%A7%8B%E7%94%A8%E6%88%B7%E5%AF%86%E7%A0%81%EF%BC%9Aguest/guest">http://localhost:15672/ï¼Œåˆå§‹ç”¨æˆ·å¯†ç ï¼šguest/guest</a></p>
</li>
</ol>
</blockquote>
<h2 id="SpringCloud-BusåŠ¨æ€åˆ·æ–°å…¨å±€å¹¿æ’­ç¤ºä¾‹"><a href="#SpringCloud-BusåŠ¨æ€åˆ·æ–°å…¨å±€å¹¿æ’­ç¤ºä¾‹" class="headerlink" title="SpringCloud BusåŠ¨æ€åˆ·æ–°å…¨å±€å¹¿æ’­ç¤ºä¾‹"></a>SpringCloud BusåŠ¨æ€åˆ·æ–°å…¨å±€å¹¿æ’­ç¤ºä¾‹</h2><p>ä¸ºæ¼”ç¤ºå¹¿æ’­æ•ˆæœï¼Œä»¥3355ä¸ºæ¨¡æ¿å†å¢åŠ ä¸€ä¸ª3366</p>
<ol>
<li>ä¿®æ”¹Controllerï¼š</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigClientController</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverPort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;config.info&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String configInfo;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/configInfo&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getConfigInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;configInfo: &quot;</span> + configInfo + <span class="string">&quot;, serverPort: &quot;</span> + serverPort;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p><strong>ç»™cloud-config-center-3344 é…ç½®ä¸­å¿ƒæœåŠ¡ç«¯æ·»åŠ æ¶ˆæ¯æ€»çº¿æ”¯æŒ</strong></p>
<p> pom.xml</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--æ·»åŠ æ¶ˆæ¯æ€»çº¿RabbitMQæ”¯æŒ--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p> ymlï¼š</p>
 <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3344</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-config-center</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">          <span class="comment">#ä½¿ç”¨httpsä¸æŠ¥é”™</span></span><br><span class="line">          <span class="comment">#uri: git@gitee.com:mineting/springcloud-config.git</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://gitee.com/mineting/springcloud-config.git</span></span><br><span class="line">          <span class="attr">username:</span> <span class="number">18220549581</span></span><br><span class="line">          <span class="attr">password:</span> <span class="string">169683liufei</span></span><br><span class="line">          <span class="comment">#æœç´¢ç›®å½•</span></span><br><span class="line">          <span class="attr">search-paths:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">springcloud-config</span></span><br><span class="line">      <span class="comment">#åˆ†æ”¯</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#rabbitmqç›¸å…³é…ç½®</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#rabbitmqç›¸å…³é…ç½®,æš´éœ²busåˆ·æ–°é…ç½®çš„ç«¯ç‚¹</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span> <span class="comment">#æš´éœ²busåˆ·æ–°é…ç½®çš„ç«¯ç‚¹</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;bus-refresh&#x27;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>ç»™cloud-config-client-3355å’Œ3366å®¢æˆ·ç«¯æ·»åŠ æ¶ˆæ¯æ€»çº¿æ”¯æŒ</strong></p>
<p> pom.xml</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--æ·»åŠ æ¶ˆæ¯æ€»çº¿RabbitMQæ”¯æŒ--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p> yml</p>
 <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3355</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">config-client</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="comment">#Configå®¢æˆ·ç«¯é…ç½®ï¼šhttp://config-3344.com:3344/master/config-dev.yml</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span></span><br><span class="line">      <span class="comment">#é…ç½®æ–‡ä»¶åç§°</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">      <span class="comment">#&#123;profile&#125;åç§°</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">dev</span></span><br><span class="line">      <span class="comment">#é…ç½®ä¸­å¿ƒåœ°å€</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://config-3344.com:3344</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#rabbitmqç›¸å…³é…ç½® 15672æ˜¯Webç®¡ç†ç•Œé¢çš„ç«¯å£ï¼›5672æ˜¯MQè®¿é—®çš„ç«¯å£</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æš´éœ²ç›‘æ§ç«¯ç‚¹</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>æµ‹è¯•</p>
<p> ä¿®æ”¹githubé…ç½®ï¼Œå‘é€POSTè¯·æ±‚ï¼šcurl -X POST â€œ<a target="_blank" rel="noopener" href="http://localhost:3344/actuator/bus-refresh">http://localhost:3344/actuator/bus-refresh</a>â€œ</p>
<p> ç»“æœï¼šé…ç½®ä¸­å¿ƒå’Œå®¢æˆ·ç«¯æ•°æ®éƒ½å‘ç”Ÿå˜åŒ–</p>
<p> <a target="_blank" rel="noopener" href="http://config-3344.com:3344/config-dev.yml">http://config-3344.com:3344/config-dev.yml</a></p>
<p> <a target="_blank" rel="noopener" href="http://localhost:3355/configInfo">http://localhost:3355/configInfo</a></p>
<p> <a target="_blank" rel="noopener" href="http://localhost:3366/configInfo">http://localhost:3366/configInfo</a></p>
</li>
<li><p>å®šç‚¹é€šçŸ¥</p>
<p> ä¸æƒ³å…¨éƒ¨é€šçŸ¥ï¼Œåªæƒ³å®šç‚¹é€šçŸ¥ï¼›åªé€šçŸ¥3355ï¼Œä¸é€šçŸ¥3366</p>
<blockquote>
<p><a href="http://localhost:é…ç½®ä¸­å¿ƒçš„ç«¯å£å·/actuator/bus-refresh/{destination}">http://localhost:é…ç½®ä¸­å¿ƒçš„ç«¯å£å·/actuator/bus-refresh/{destination}</a></p>
<p>&#x2F;bus&#x2F;refreshè¯·æ±‚ä¸å†å‘é€åˆ°å…·ä½“çš„æœåŠ¡å®ä¾‹ä¸Šï¼Œè€Œæ˜¯å‘ç»™config serverå¹¶é€šè¿‡destinationå‚æ•°ç±»æŒ‡å®šéœ€è¦æ›´æ–°é…ç½®çš„æœåŠ¡æˆ–å®ä¾‹ã€‚</p>
<p>ç¤ºä¾‹ï¼šcurl -X POST â€œ<a target="_blank" rel="noopener" href="http://localhost:3344/actuator/bus-refresh/config-client:3355">http://localhost:3344/actuator/bus-refresh/config-client:3355</a>â€œ</p>
</blockquote>
</li>
<li><p>æ€»ç»“</p>
 <img src="/2023/03/25/SpringCloud/Java\Document\SpringCloud\images\image-20221230132726592.png" alt="image-20221230132726592" style="zoom:80%;"></li>
</ol>
<h1 id="SpringCloud-Stream-æ¶ˆæ¯é©±åŠ¨"><a href="#SpringCloud-Stream-æ¶ˆæ¯é©±åŠ¨" class="headerlink" title="SpringCloud Stream æ¶ˆæ¯é©±åŠ¨"></a>SpringCloud Stream æ¶ˆæ¯é©±åŠ¨</h1><h2 id="æ¶ˆæ¯é©±åŠ¨æ¦‚è¿°"><a href="#æ¶ˆæ¯é©±åŠ¨æ¦‚è¿°" class="headerlink" title="æ¶ˆæ¯é©±åŠ¨æ¦‚è¿°"></a>æ¶ˆæ¯é©±åŠ¨æ¦‚è¿°</h2><blockquote>
<p>æ–‡æ¡£ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud-stream#overview">https://spring.io/projects/spring-cloud-stream#overview</a></p>
<p><a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-static/spring-cloud-stream/3.0.1.RELEASE/reference/html/">https://cloud.spring.io/spring-cloud-static/spring-cloud-stream/3.0.1.RELEASE/reference/html/</a></p>
<p><a target="_blank" rel="noopener" href="https://m.wang1314.com/doc/webapp/topic/20971999.html">https://m.wang1314.com/doc/webapp/topic/20971999.html</a></p>
<p>ä»€ä¹ˆæ˜¯SpringCloudStream<br>å®˜æ–¹å®šä¹‰ Spring Cloud Stream æ˜¯ä¸€ä¸ªæ„å»ºæ¶ˆæ¯é©±åŠ¨å¾®æœåŠ¡çš„æ¡†æ¶ã€‚</p>
<p>åº”ç”¨ç¨‹åºé€šè¿‡ inputs æˆ–è€… outputs æ¥ä¸ Spring Cloud Streamä¸­binderå¯¹è±¡äº¤äº’ã€‚<br>é€šè¿‡æˆ‘ä»¬é…ç½®æ¥binding(ç»‘å®š) ï¼Œè€Œ Spring Cloud Stream çš„ binderå¯¹è±¡è´Ÿè´£ä¸æ¶ˆæ¯ä¸­é—´ä»¶äº¤äº’ã€‚<br>æ‰€ä»¥ï¼Œæˆ‘ä»¬åªéœ€è¦ææ¸…æ¥šå¦‚ä½•ä¸ Spring Cloud Stream äº¤äº’å°±å¯ä»¥æ–¹ä¾¿ä½¿ç”¨æ¶ˆæ¯é©±åŠ¨çš„æ–¹å¼ã€‚</p>
<p>é€šè¿‡ä½¿ç”¨Spring Integrationæ¥è¿æ¥æ¶ˆæ¯ä»£ç†ä¸­é—´ä»¶ä»¥å®ç°æ¶ˆæ¯äº‹ä»¶é©±åŠ¨ã€‚<br>Spring Cloud Stream ä¸ºä¸€äº›ä¾›åº”å•†çš„æ¶ˆæ¯ä¸­é—´ä»¶äº§å“æä¾›äº†ä¸ªæ€§åŒ–çš„è‡ªåŠ¨åŒ–é…ç½®å®ç°ï¼Œå¼•ç”¨äº†å‘å¸ƒ-è®¢é˜…ã€æ¶ˆè´¹ç»„ã€åˆ†åŒºçš„ä¸‰ä¸ªæ ¸å¿ƒæ¦‚å¿µã€‚</p>
<p>Spring Cloud Streamæ˜¯ç”¨äºæ„å»ºä¸å…±äº«æ¶ˆæ¯ä¼ é€’ç³»ç»Ÿè¿æ¥çš„é«˜åº¦å¯ä¼¸ç¼©çš„äº‹ä»¶é©±åŠ¨å¾®æœåŠ¡æ¡†æ¶ï¼Œè¯¥æ¡†æ¶æä¾›äº†ä¸€ä¸ªçµæ´»çš„ç¼–ç¨‹æ¨¡å‹ï¼Œå®ƒå»ºç«‹åœ¨å·²ç»å»ºç«‹å’Œç†Ÿæ‚‰çš„Springç†Ÿè¯­å’Œæœ€ä½³å®è·µä¸Šï¼ŒåŒ…æ‹¬æ”¯æŒæŒä¹…åŒ–çš„å‘å¸ƒ&#x2F;è®¢é˜…ã€æ¶ˆè´¹ç»„ä»¥åŠæ¶ˆæ¯åˆ†åŒºè¿™ä¸‰ä¸ªæ ¸å¿ƒæ¦‚å¿µ</p>
<p>ç›®å‰ä»…æ”¯æŒRabbitMQã€Kafkaã€‚</p>
<p><strong>ç®€å•æ€»ç»“ï¼šå±è”½åº•å±‚æ¶ˆæ¯ä¸­é—´ä»¶çš„å·®å¼‚,é™ä½åˆ‡æ¢æˆæœ¬ï¼Œç»Ÿä¸€æ¶ˆæ¯çš„ç¼–ç¨‹æ¨¡å‹</strong></p>
</blockquote>
<h1 id="SpringCloud-Sleuth-åˆ†å¸ƒå¼è¯·æ±‚é“¾è·¯è·Ÿè¸ª"><a href="#SpringCloud-Sleuth-åˆ†å¸ƒå¼è¯·æ±‚é“¾è·¯è·Ÿè¸ª" class="headerlink" title="SpringCloud Sleuth åˆ†å¸ƒå¼è¯·æ±‚é“¾è·¯è·Ÿè¸ª"></a>SpringCloud Sleuth åˆ†å¸ƒå¼è¯·æ±‚é“¾è·¯è·Ÿè¸ª</h1><h1 id="SpringCloud-Alibaba-æ¦‚è¿°"><a href="#SpringCloud-Alibaba-æ¦‚è¿°" class="headerlink" title="SpringCloud Alibaba æ¦‚è¿°"></a>SpringCloud Alibaba æ¦‚è¿°</h1><blockquote>
<p><strong>ä¸ºä»€ä¹ˆä¼šå‡ºç°SpringCloud alibaba</strong></p>
<p>Spring Cloud Netflixé¡¹ç›®è¿›å…¥ç»´æŠ¤æ¨¡å¼ï¼šSpring Cloud Netflix Projects Entering Maintenance Mode</p>
<ol>
<li><p>å°†æ¨¡å—ç½®äºç»´æŠ¤æ¨¡å¼ï¼Œæ„å‘³ç€ Spring Cloud å›¢é˜Ÿå°†ä¸ä¼šå†å‘æ¨¡å—æ·»åŠ æ–°åŠŸèƒ½ã€‚<br> æˆ‘ä»¬å°†ä¿®å¤ block çº§åˆ«çš„ bug ä»¥åŠå®‰å…¨é—®é¢˜ï¼Œæˆ‘ä»¬ä¹Ÿä¼šè€ƒè™‘å¹¶å®¡æŸ¥ç¤¾åŒºçš„å°å‹ pull requestã€‚</p>
</li>
<li><p>Spring Cloud Netflix å°†ä¸å†å¼€å‘æ–°çš„ç»„ä»¶<br> æˆ‘ä»¬éƒ½çŸ¥é“Spring Cloud ç‰ˆæœ¬è¿­ä»£ç®—æ˜¯æ¯”è¾ƒå¿«çš„ï¼Œå› è€Œå‡ºç°äº†å¾ˆå¤šé‡å¤§ISSUEéƒ½è¿˜æ¥ä¸åŠFixå°±åˆæ¨å¦ä¸€ä¸ªReleaseäº†ã€‚è¿›å…¥ç»´æŠ¤æ¨¡å¼æ„æ€å°±æ˜¯ç›®å‰ä¸€ç›´ä»¥åä¸€æ®µæ—¶é—´Spring Cloud Netflixæä¾›çš„æœåŠ¡å’ŒåŠŸèƒ½å°±è¿™ä¹ˆå¤šäº†ï¼Œä¸åœ¨å¼€å‘æ–°çš„ç»„ä»¶å’ŒåŠŸèƒ½äº†ã€‚ä»¥åå°†ä»¥ç»´æŠ¤å’ŒMergeåˆ†æ”¯Full Requestä¸ºä¸»ã€‚</p>
<p> æ–°ç»„ä»¶åŠŸèƒ½å°†ä»¥å…¶ä»–æ›¿ä»£å¹³ä»£æ›¿çš„æ–¹å¼å®ç°ã€‚</p>
</li>
</ol>
<p><strong>SpringCloudAlibabaè¯´æ˜</strong></p>
<p>è¯ç”Ÿï¼š2018.10.31ï¼ŒSpring Cloud Alibaba æ­£å¼å…¥é©»äº† Spring Cloud å®˜æ–¹å­µåŒ–å™¨ï¼Œå¹¶åœ¨ Maven ä¸­å¤®åº“å‘å¸ƒäº†ç¬¬ä¸€ä¸ªç‰ˆæœ¬ã€‚</p>
<p><strong>Spring Cloud Alibaba è‡´åŠ›äºæä¾›å¾®æœåŠ¡å¼€å‘çš„ä¸€ç«™å¼è§£å†³æ–¹æ¡ˆã€‚æ­¤é¡¹ç›®åŒ…å«å¼€å‘åˆ†å¸ƒå¼åº”ç”¨å¾®æœåŠ¡çš„å¿…éœ€ç»„ä»¶ï¼Œæ–¹ä¾¿å¼€å‘è€…é€šè¿‡ Spring Cloud ç¼–ç¨‹æ¨¡å‹è½»æ¾ä½¿ç”¨è¿™äº›ç»„ä»¶æ¥å¼€å‘åˆ†å¸ƒå¼åº”ç”¨æœåŠ¡ã€‚</strong></p>
<p><strong>ä¾æ‰˜ Spring Cloud Alibabaï¼Œæ‚¨åªéœ€è¦æ·»åŠ ä¸€äº›æ³¨è§£å’Œå°‘é‡é…ç½®ï¼Œå°±å¯ä»¥å°† Spring Cloud åº”ç”¨æ¥å…¥é˜¿é‡Œå¾®æœåŠ¡è§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡é˜¿é‡Œä¸­é—´ä»¶æ¥è¿…é€Ÿæ­å»ºåˆ†å¸ƒå¼åº”ç”¨ç³»ç»Ÿã€‚</strong></p>
<p>æ–‡æ¡£ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/spring-cloud-alibaba/blob/master/README-zh.md">https://github.com/alibaba/spring-cloud-alibaba/blob/master/README-zh.md</a></p>
<p><a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud-alibaba#overview">https://spring.io/projects/spring-cloud-alibaba#overview</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/spring-cloud-alibaba">https://github.com/alibaba/spring-cloud-alibaba</a></p>
<p><a target="_blank" rel="noopener" href="https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html">https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/spring-cloud-alibaba/blob/master/README-zh.md">https://github.com/alibaba/spring-cloud-alibaba/blob/master/README-zh.md</a></p>
<p>ä½œç”¨ï¼š</p>
<ol>
<li>æœåŠ¡é™æµé™çº§ï¼šé»˜è®¤æ”¯æŒ Servletã€Feignã€RestTemplateã€Dubbo å’Œ RocketMQ é™æµé™çº§åŠŸèƒ½çš„æ¥å…¥ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶é€šè¿‡æ§åˆ¶å°å®æ—¶ä¿®æ”¹é™æµé™çº§è§„åˆ™ï¼Œè¿˜æ”¯æŒæŸ¥çœ‹é™æµé™çº§ Metrics ç›‘æ§ã€‚</li>
<li>æœåŠ¡æ³¨å†Œä¸å‘ç°ï¼šé€‚é… Spring Cloud æœåŠ¡æ³¨å†Œä¸å‘ç°æ ‡å‡†ï¼Œé»˜è®¤é›†æˆäº† Ribbon çš„æ”¯æŒã€‚</li>
<li>åˆ†å¸ƒå¼é…ç½®ç®¡ç†ï¼šæ”¯æŒåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„å¤–éƒ¨åŒ–é…ç½®ï¼Œé…ç½®æ›´æ”¹æ—¶è‡ªåŠ¨åˆ·æ–°ã€‚</li>
<li>æ¶ˆæ¯é©±åŠ¨èƒ½åŠ›ï¼šåŸºäº Spring Cloud Stream ä¸ºå¾®æœåŠ¡åº”ç”¨æ„å»ºæ¶ˆæ¯é©±åŠ¨èƒ½åŠ›ã€‚</li>
<li>é˜¿é‡Œäº‘å¯¹è±¡å­˜å‚¨ï¼šé˜¿é‡Œäº‘æä¾›çš„æµ·é‡ã€å®‰å…¨ã€ä½æˆæœ¬ã€é«˜å¯é çš„äº‘å­˜å‚¨æœåŠ¡ã€‚æ”¯æŒåœ¨ä»»ä½•åº”ç”¨ã€ä»»ä½•æ—¶é—´ã€ä»»ä½•åœ°ç‚¹å­˜å‚¨å’Œè®¿é—®ä»»æ„ç±»å‹çš„æ•°æ®ã€‚</li>
<li>åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦ï¼šæä¾›ç§’çº§ã€ç²¾å‡†ã€é«˜å¯é ã€é«˜å¯ç”¨çš„å®šæ—¶ï¼ˆåŸºäº Cron è¡¨è¾¾å¼ï¼‰ä»»åŠ¡è°ƒåº¦æœåŠ¡ã€‚åŒæ—¶æä¾›åˆ†å¸ƒå¼çš„ä»»åŠ¡æ‰§è¡Œæ¨¡å‹ï¼Œå¦‚ç½‘æ ¼ä»»åŠ¡ã€‚ç½‘æ ¼ä»»åŠ¡æ”¯æŒæµ·é‡å­ä»»åŠ¡å‡åŒ€åˆ†é…åˆ°æ‰€æœ‰ Workerï¼ˆschedulerx-clientï¼‰ä¸Šæ‰§è¡Œã€‚</li>
</ol>
</blockquote>
<h1 id="SpringCloud-Alibaba-NacosæœåŠ¡æ³¨å†Œå’Œé…ç½®ä¸­å¿ƒ"><a href="#SpringCloud-Alibaba-NacosæœåŠ¡æ³¨å†Œå’Œé…ç½®ä¸­å¿ƒ" class="headerlink" title="SpringCloud Alibaba NacosæœåŠ¡æ³¨å†Œå’Œé…ç½®ä¸­å¿ƒ"></a>SpringCloud Alibaba NacosæœåŠ¡æ³¨å†Œå’Œé…ç½®ä¸­å¿ƒ</h1><h2 id="Nacosç®€ä»‹"><a href="#Nacosç®€ä»‹" class="headerlink" title="Nacosç®€ä»‹"></a>Nacosç®€ä»‹</h2><blockquote>
<p>å‰å››ä¸ªå­—æ¯åˆ†åˆ«ä¸ºNamingå’ŒConfigurationçš„å‰ä¸¤ä¸ªå­—æ¯ï¼Œæœ€åçš„sä¸ºServiceã€‚</p>
<p>Nacos: Dynamic Naming and Configuration Service</p>
<p>ä¸€ä¸ªæ›´æ˜“äºæ„å»ºäº‘åŸç”Ÿåº”ç”¨çš„åŠ¨æ€æœåŠ¡å‘ç°ã€é…ç½®ç®¡ç†å’ŒæœåŠ¡ç®¡ç†å¹³å°ã€‚</p>
<p>ç®€å•æ¥è¯´ï¼šNacoså°±æ˜¯æ³¨å†Œä¸­å¿ƒ + é…ç½®ä¸­å¿ƒçš„ç»„åˆã€Nacos &#x3D; Eureka+Config +Busã€‘</p>
<p>æ›¿ä»£EurekaåšæœåŠ¡æ³¨å†Œä¸­å¿ƒï¼Œæ›¿ä»£ConfigåšæœåŠ¡é…ç½®ä¸­å¿ƒ</p>
<p>æ–‡æ¡£ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/Nacos">https://github.com/alibaba/Nacos</a></p>
<p><a target="_blank" rel="noopener" href="https://nacos.io/zh-cn/index.html">https://nacos.io/zh-cn/index.html</a></p>
<p><a target="_blank" rel="noopener" href="https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html#_spring_cloud_alibaba_nacos_discovery">https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html#_spring_cloud_alibaba_nacos_discovery</a></p>
<p><strong>å„ä¸ªæ³¨å†Œä¸­å¿ƒæ¯”è¾ƒ</strong></p>
<table>
<thead>
<tr>
<th>æœåŠ¡æ³¨å†Œä¸å‘ç°</th>
<th>CAPæ¨¡å‹</th>
<th>æ§åˆ¶å°ç®¡ç†</th>
<th>ç¤¾åŒºæ´»è·ƒåº¦</th>
</tr>
</thead>
<tbody><tr>
<td>Eureka</td>
<td>AP</td>
<td>æ”¯æŒ</td>
<td>ä½</td>
</tr>
<tr>
<td>Zookeeper</td>
<td>CP</td>
<td>ä¸æ”¯æŒ</td>
<td>ä¸­</td>
</tr>
<tr>
<td>Consul</td>
<td>CP</td>
<td>æ”¯æŒ</td>
<td>é«˜</td>
</tr>
<tr>
<td>Nacos</td>
<td>AP</td>
<td>æ”¯æŒ</td>
<td>é«˜</td>
</tr>
</tbody></table>
</blockquote>
<h2 id="å®‰è£…è¿è¡Œ"><a href="#å®‰è£…è¿è¡Œ" class="headerlink" title="å®‰è£…è¿è¡Œ"></a>å®‰è£…è¿è¡Œ</h2><ol>
<li>ä¸‹è½½åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://github.com/alibaba/nacos/releases">https://github.com/alibaba/nacos/releases</a></li>
<li>è¿è¡Œã€å•æœºç‰ˆã€‘ï¼šbin&#x2F;startup.cmd -m standalone</li>
<li>è®¿é—®ï¼š<a target="_blank" rel="noopener" href="http://localhost:8848/nacos%EF%BC%8C%E9%BB%98%E8%AE%A4%E7%94%A8%E6%88%B7%E5%90%8D%E5%AF%86%E7%A0%81%EF%BC%9Anacos/nacos">http://localhost:8848/nacosï¼Œé»˜è®¤ç”¨æˆ·åå¯†ç ï¼šnacos/nacos</a></li>
</ol>
<h2 id="Nacosä½œä¸ºæœåŠ¡æ³¨å†Œä¸­å¿ƒæ¼”ç¤º"><a href="#Nacosä½œä¸ºæœåŠ¡æ³¨å†Œä¸­å¿ƒæ¼”ç¤º" class="headerlink" title="Nacosä½œä¸ºæœåŠ¡æ³¨å†Œä¸­å¿ƒæ¼”ç¤º"></a>Nacosä½œä¸ºæœåŠ¡æ³¨å†Œä¸­å¿ƒæ¼”ç¤º</h2><p>æ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html#_spring_cloud_alibaba_nacos_config">https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html#_spring_cloud_alibaba_nacos_config</a></p>
<h3 id="åŸºäºNacosçš„æœåŠ¡æä¾›è€…"><a href="#åŸºäºNacosçš„æœåŠ¡æä¾›è€…" class="headerlink" title="åŸºäºNacosçš„æœåŠ¡æä¾›è€…"></a>åŸºäºNacosçš„æœåŠ¡æä¾›è€…</h3><ol>
<li><p>æ–°å»ºæ¨¡å— cloudalibaba-provider-payment9001</p>
</li>
<li><p>pomæ–‡ä»¶</p>
<p> çˆ¶pomï¼š</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p> å­pomï¼š</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>yml</p>
 <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-payment-provider</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>å¯åŠ¨ç±»</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NacosPayment9001</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(NacosPayment9001.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Controller</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentController</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverPort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/payment/nacos/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPayment</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Nacos Registry, serverPort: &quot;</span> + serverPort + <span class="string">&quot;, id&quot;</span> + id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æµ‹è¯•ï¼šå¯åŠ¨æœåŠ¡ï¼ŒæŸ¥çœ‹NacosæœåŠ¡åˆ—è¡¨</p>
<p> <img src="/2023/03/25/SpringCloud/Java\Document\SpringCloud\images\image-20221230142133542.png" alt="image-20221230142133542"></p>
</li>
<li><p>ä¸ºæ¼”ç¤ºè´Ÿè½½å‡è¡¡ï¼Œå¤åˆ¶cloudalibaba-provider-payment9001 ä¸º cloudalibaba-provider-payment9002</p>
</li>
</ol>
<h3 id="åŸºäºNacosçš„æœåŠ¡æ¶ˆè´¹è€…"><a href="#åŸºäºNacosçš„æœåŠ¡æ¶ˆè´¹è€…" class="headerlink" title="åŸºäºNacosçš„æœåŠ¡æ¶ˆè´¹è€…"></a>åŸºäºNacosçš„æœåŠ¡æ¶ˆè´¹è€…</h3><ol>
<li><p>æ–°å»ºæ¨¡å— cloudalibaba-consumer-nacos-order83</p>
</li>
<li><p>pom.xml</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>yml</p>
</li>
</ol>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">83</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-order-consumer</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#è‡ªå®šä¹‰é…ç½®ï¼šæ¶ˆè´¹è€…å°†è¦å»è®¿é—®çš„å¾®æœåŠ¡åç§°(æ³¨å†ŒæˆåŠŸè¿›nacosçš„å¾®æœåŠ¡æä¾›è€…)</span></span><br><span class="line"><span class="attr">service-url:</span></span><br><span class="line">  <span class="attr">nacos-user-service:</span> <span class="string">http://nacos-payment-provider</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li><p>å¯åŠ¨ç±»</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderNacosMain83</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(OrderNacosMain83.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> é…ç½®ç±»</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.springcloud.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.loadbalancer.LoadBalanced;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApplicationContextConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        å¦‚æœä¸åŠ @LoadBalancedæŠ¥é”™ï¼š</span></span><br><span class="line"><span class="comment">        There was an unexpected error (type=Internal Server Error, status=500).</span></span><br><span class="line"><span class="comment">        I/O error on GET request for &quot;http://nacos-payment-provider/payment/nacos/13&quot;: nacos-payment-provider; nested exception is java.net.UnknownHostException: nacos-payment-provider</span></span><br><span class="line"><span class="comment">        org.springframework.web.client.ResourceAccessException: I/O error on GET request for &quot;http://nacos-payment-provider/payment/nacos/13&quot;: nacos-payment-provider; nested exception is java.net.UnknownHostException: nacos-payment-provider</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Controller</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NacosOrderController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;service-url.nacos-user-service&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serviceUrl;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/consumer/payment/nacos/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPayment</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(serviceUrl + <span class="string">&quot;/payment/nacos/&quot;</span> + id, String.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æµ‹è¯•è´Ÿè½½å‡è¡¡</p>
<p> <a target="_blank" rel="noopener" href="http://localhost:83/consumer/payment/nacos/13">http://localhost:83/consumer/payment/nacos/13</a></p>
</li>
</ol>
<h3 id="æœåŠ¡æ³¨å†Œä¸­å¿ƒå¯¹æ¯”"><a href="#æœåŠ¡æ³¨å†Œä¸­å¿ƒå¯¹æ¯”" class="headerlink" title="æœåŠ¡æ³¨å†Œä¸­å¿ƒå¯¹æ¯”"></a>æœåŠ¡æ³¨å†Œä¸­å¿ƒå¯¹æ¯”</h3><blockquote>
<p>Nacosä¸å…¶ä»–æ³¨å†Œä¸­å¿ƒå¯¹æ¯”</p>
<table>
<thead>
<tr>
<th></th>
<th>Nacos</th>
<th>Eureka</th>
<th>Consul</th>
<th>CoreDns</th>
<th>Zookeeper</th>
</tr>
</thead>
<tbody><tr>
<td>ä¸€è‡´æ€§åè®®</td>
<td>CP+AP</td>
<td>AP</td>
<td>CP</td>
<td>&#x2F;</td>
<td>CP</td>
</tr>
<tr>
<td>å¥åº·æ£€æŸ¥</td>
<td>TCP&#x2F;HTTP&#x2F;MYSQL&#x2F;Client Beat</td>
<td>Client Beat</td>
<td>TCP&#x2F;HTTP&#x2F;gRPC&#x2F;Cmd</td>
<td>&#x2F;</td>
<td>Client Beat</td>
</tr>
<tr>
<td>è´Ÿè½½å‡è¡¡</td>
<td>æƒé‡&#x2F;DSL&#x2F;metadata&#x2F;cmdb</td>
<td>Ribbon</td>
<td>Fabio</td>
<td>RR</td>
<td>&#x2F;</td>
</tr>
<tr>
<td>é›ªå´©ä¿æŠ¤</td>
<td>æ”¯æŒ</td>
<td>æ”¯æŒ</td>
<td>ä¸æ”¯æŒ</td>
<td>ä¸æ”¯æŒ</td>
<td>ä¸æ”¯æŒ</td>
</tr>
<tr>
<td>è‡ªåŠ¨æ³¨é”€å®ä¾‹</td>
<td>æ”¯æŒ</td>
<td>æ”¯æŒ</td>
<td>ä¸æ”¯æŒ</td>
<td>ä¸æ”¯æŒ</td>
<td>æ”¯æŒ</td>
</tr>
<tr>
<td>è®¿é—®åè®®</td>
<td>HTTP&#x2F;DNS&#x2F;UDP</td>
<td>HTTP</td>
<td>HTTP&#x2F;DNS</td>
<td>DNS</td>
<td>TCP</td>
</tr>
<tr>
<td>ç›‘å¬æ”¯æŒ</td>
<td>æ”¯æŒ</td>
<td>æ”¯æŒ</td>
<td>æ”¯æŒ</td>
<td>ä¸æ”¯æŒ</td>
<td>æ”¯æŒ</td>
</tr>
<tr>
<td>å¤šæ•°æ®ä¸­å¿ƒ</td>
<td>æ”¯æŒ</td>
<td>æ”¯æŒ</td>
<td>æ”¯æŒ</td>
<td>ä¸æ”¯æŒ</td>
<td>ä¸æ”¯æŒ</td>
</tr>
<tr>
<td>è·¨æ³¨å†Œä¸­å¿ƒ</td>
<td>æ”¯æŒ</td>
<td>ä¸æ”¯æŒ</td>
<td>æ”¯æŒ</td>
<td>ä¸æ”¯æŒ</td>
<td>ä¸æ”¯æŒ</td>
</tr>
<tr>
<td>SpringCloudé›†æˆ</td>
<td>æ”¯æŒ</td>
<td>æ”¯æŒ</td>
<td>æ”¯æŒ</td>
<td>ä¸æ”¯æŒ</td>
<td>ä¸æ”¯æŒ</td>
</tr>
<tr>
<td>Dubboé›†æˆ</td>
<td>æ”¯æŒ</td>
<td>ä¸æ”¯æŒ</td>
<td>ä¸æ”¯æŒ</td>
<td>ä¸æ”¯æŒ</td>
<td>æ”¯æŒ</td>
</tr>
<tr>
<td>K8Sé›†æˆ</td>
<td>æ”¯æŒ</td>
<td>ä¸æ”¯æŒ</td>
<td>æ”¯æŒ</td>
<td>æ”¯æŒ</td>
<td>ä¸æ”¯æŒ</td>
</tr>
</tbody></table>
<img src="/2023/03/25/SpringCloud/Java\Document\SpringCloud\images\image-20221230162722001.png" alt="image-20221230162722001" style="zoom:80%;">
</blockquote>
<h3 id="Nacos-æ”¯æŒAPå’ŒCPæ¨¡å¼çš„åˆ‡æ¢"><a href="#Nacos-æ”¯æŒAPå’ŒCPæ¨¡å¼çš„åˆ‡æ¢" class="headerlink" title="Nacos æ”¯æŒAPå’ŒCPæ¨¡å¼çš„åˆ‡æ¢"></a>Nacos æ”¯æŒAPå’ŒCPæ¨¡å¼çš„åˆ‡æ¢</h3><blockquote>
<p>Cæ˜¯æ‰€æœ‰èŠ‚ç‚¹åœ¨åŒä¸€æ—¶é—´çœ‹åˆ°çš„æ•°æ®æ˜¯ä¸€è‡´çš„ï¼›è€Œ A çš„å®šä¹‰æ˜¯æ‰€æœ‰çš„è¯·æ±‚éƒ½ä¼šæ”¶åˆ°å“åº”ã€‚</p>
<p>ä½•æ—¶é€‰æ‹©ä½¿ç”¨ä½•ç§æ¨¡å¼ï¼Ÿ<br>ä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœä¸éœ€è¦å­˜å‚¨æœåŠ¡çº§åˆ«çš„ä¿¡æ¯ä¸”æœåŠ¡å®ä¾‹æ˜¯é€šè¿‡nacos-clientæ³¨å†Œï¼Œå¹¶èƒ½å¤Ÿä¿æŒå¿ƒè·³ä¸ŠæŠ¥ï¼Œé‚£ä¹ˆå°±å¯ä»¥é€‰æ‹©APæ¨¡å¼ã€‚å½“å‰ä¸»æµçš„æœåŠ¡å¦‚ Spring cloud å’Œ Dubbo æœåŠ¡ï¼Œéƒ½é€‚ç”¨äºAPæ¨¡å¼ï¼ŒAPæ¨¡å¼ä¸ºäº†æœåŠ¡çš„å¯èƒ½æ€§è€Œå‡å¼±äº†ä¸€è‡´æ€§ï¼Œå› æ­¤APæ¨¡å¼ä¸‹åªæ”¯æŒæ³¨å†Œä¸´æ—¶å®ä¾‹ã€‚</p>
<p>å¦‚æœéœ€è¦åœ¨æœåŠ¡çº§åˆ«ç¼–è¾‘æˆ–è€…å­˜å‚¨é…ç½®ä¿¡æ¯ï¼Œé‚£ä¹ˆ CP æ˜¯å¿…é¡»ï¼ŒK8SæœåŠ¡å’ŒDNSæœåŠ¡åˆ™é€‚ç”¨äºCPæ¨¡å¼ã€‚<br>CPæ¨¡å¼ä¸‹åˆ™æ”¯æŒæ³¨å†ŒæŒä¹…åŒ–å®ä¾‹ï¼Œæ­¤æ—¶åˆ™æ˜¯ä»¥ Raft åè®®ä¸ºé›†ç¾¤è¿è¡Œæ¨¡å¼ï¼Œè¯¥æ¨¡å¼ä¸‹æ³¨å†Œå®ä¾‹ä¹‹å‰å¿…é¡»å…ˆæ³¨å†ŒæœåŠ¡ï¼Œå¦‚æœæœåŠ¡ä¸å­˜åœ¨ï¼Œåˆ™ä¼šè¿”å›é”™è¯¯ã€‚</p>
<p>curl -X PUT â€˜$NACOS_SERVER:8848&#x2F;nacos&#x2F;v1&#x2F;ns&#x2F;operator&#x2F;switches?entry&#x3D;serverMode&amp;value&#x3D;CPâ€™</p>
</blockquote>
<h2 id="Nacosä½œä¸ºæœåŠ¡é…ç½®ä¸­å¿ƒæ¼”ç¤º"><a href="#Nacosä½œä¸ºæœåŠ¡é…ç½®ä¸­å¿ƒæ¼”ç¤º" class="headerlink" title="Nacosä½œä¸ºæœåŠ¡é…ç½®ä¸­å¿ƒæ¼”ç¤º"></a>Nacosä½œä¸ºæœåŠ¡é…ç½®ä¸­å¿ƒæ¼”ç¤º</h2><h3 id="åŸºç¡€é…ç½®ç¤ºä¾‹"><a href="#åŸºç¡€é…ç½®ç¤ºä¾‹" class="headerlink" title="åŸºç¡€é…ç½®ç¤ºä¾‹"></a>åŸºç¡€é…ç½®ç¤ºä¾‹</h3><ol>
<li><p>æ–°å»ºæ¨¡å— </p>
</li>
<li><p>ymlé…ç½®</p>
<p> NacosåŒspringcloud-configä¸€æ ·ï¼Œåœ¨é¡¹ç›®åˆå§‹åŒ–æ—¶ï¼Œè¦ä¿è¯å…ˆä»é…ç½®ä¸­å¿ƒè¿›è¡Œé…ç½®æ‹‰å–ï¼Œ<br> æ‹‰å–é…ç½®ä¹‹åï¼Œæ‰èƒ½ä¿è¯é¡¹ç›®çš„æ­£å¸¸å¯åŠ¨ã€‚springbootä¸­é…ç½®æ–‡ä»¶çš„åŠ è½½æ˜¯å­˜åœ¨ä¼˜å…ˆçº§é¡ºåºçš„ï¼Œbootstrapä¼˜å…ˆçº§é«˜äºapplicationã€‚</p>
<p> <strong>bootstrap.yml</strong></p>
 <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3377</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-config-client</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="comment">#NacosæœåŠ¡æ³¨å†Œä¸­å¿ƒåœ°å€</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="comment">#Nacosä½œä¸ºé…ç½®ä¸­å¿ƒåœ°å€</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">        <span class="comment">#æŒ‡å®šé…ç½®æ–‡ä»¶æ‰©å±•å</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># $&#123;spring.application.name&#125;-$&#123;spring.profile.active&#125;.$&#123;spring.cloud.nacos.config.file-extension&#125;</span></span><br></pre></td></tr></table></figure>

<p> application.yml</p>
 <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>å¯åŠ¨ç±»</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NacosConfigClientMain3377</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(NacosConfigClientMain3377.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Controller</p>
<p> æ³¨æ„ï¼š<strong>ã€@RefreshScopeä¿è¯Nacosé…ç½®çš„åŠ¨æ€åˆ·æ–°åŠŸèƒ½ã€‘</strong></p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="comment">//åœ¨æ§åˆ¶å™¨ç±»åŠ å…¥@RefreshScopeæ³¨è§£ä½¿å½“å‰ç±»ä¸‹çš„é…ç½®æ”¯æŒNacosçš„åŠ¨æ€åˆ·æ–°åŠŸèƒ½ã€‚</span></span><br><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigClientController</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;config.info&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String configInfo;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/config/info&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getConfigInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> configInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Nacosæ·»åŠ é…ç½®ä¿¡æ¯</p>
<blockquote>
<p>Nacosä¸­çš„dataidçš„ç»„æˆæ ¼å¼åŠä¸SpringBooté…ç½®æ–‡ä»¶ä¸­çš„åŒ¹é…è§„åˆ™ï¼š</p>
<p>æ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="https://nacos.io/zh-cn/docs/quick-start-spring-cloud.html">https://nacos.io/zh-cn/docs/quick-start-spring-cloud.html</a></p>
<p>åœ¨ Nacos Spring Cloud ä¸­ï¼Œ<code>dataId</code> çš„å®Œæ•´æ ¼å¼å¦‚ä¸‹ï¼š</p>
<p>${prefix}-${spring.profiles.active}.${file-extension}</p>
<ul>
<li><code>prefix</code> é»˜è®¤ä¸º <code>spring.application.name</code> çš„å€¼ï¼Œä¹Ÿå¯ä»¥é€šè¿‡é…ç½®é¡¹ <code>spring.cloud.nacos.config.prefix</code>æ¥é…ç½®ã€‚</li>
<li><code>spring.profiles.active</code> å³ä¸ºå½“å‰ç¯å¢ƒå¯¹åº”çš„ profileï¼Œè¯¦æƒ…å¯ä»¥å‚è€ƒ <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-profiles.html#boot-features-profiles">Spring Bootæ–‡æ¡£</a>ã€‚ <strong>æ³¨æ„ï¼šå½“ <code>spring.profiles.active</code> ä¸ºç©ºæ—¶ï¼Œå¯¹åº”çš„è¿æ¥ç¬¦ <code>-</code> ä¹Ÿå°†ä¸å­˜åœ¨ï¼ŒdataId çš„æ‹¼æ¥æ ¼å¼å˜æˆ <code>$&#123;prefix&#125;.$&#123;file-extension&#125;</code></strong></li>
<li><code>file-exetension</code> ä¸ºé…ç½®å†…å®¹çš„æ•°æ®æ ¼å¼ï¼Œå¯ä»¥é€šè¿‡é…ç½®é¡¹ <code>spring.cloud.nacos.config.file-extension</code> æ¥é…ç½®ã€‚ç›®å‰åªæ”¯æŒ <code>properties</code> å’Œ <code>yaml</code> ç±»å‹ã€‚</li>
</ul>
<p>é€šè¿‡ Spring Cloud åŸç”Ÿæ³¨è§£ <code>@RefreshScope</code> å®ç°é…ç½®è‡ªåŠ¨æ›´æ–°</p>
</blockquote>
<p> é…ç½®ç¤ºä¾‹ï¼š</p>
 <img src="/2023/03/25/SpringCloud/Java\Document\SpringCloud\images\image-20221230170903498.png" alt="image-20221230170903498" style="zoom:80%;">

<p> å†å²é…ç½®ï¼š</p>
<p> Nacosä¼šè®°å½•é…ç½®æ–‡ä»¶çš„å†å²ç‰ˆæœ¬é»˜è®¤ä¿ç•™30å¤©ï¼Œæ­¤å¤–è¿˜æœ‰ä¸€é”®å›æ»šåŠŸèƒ½ï¼Œå›æ»šæ“ä½œå°†ä¼šè§¦å‘é…ç½®æ›´æ–°</p>
</li>
<li><p>æµ‹è¯•</p>
<p> è¿è¡Œcloud-config-nacos-client3377ï¼Œè®¿é—®ï¼š<a target="_blank" rel="noopener" href="http://localhost:3377/config/info">http://localhost:3377/config/info</a></p>
<p> ä¿®æ”¹ä¸‹Nacosä¸­çš„yamlé…ç½®æ–‡ä»¶ï¼Œå†æ¬¡è°ƒç”¨æŸ¥çœ‹é…ç½®çš„æ¥å£ï¼Œå°±ä¼šå‘ç°é…ç½®å·²ç»åˆ·æ–°</p>
</li>
</ol>
<h3 id="åˆ†ç±»é…ç½®"><a href="#åˆ†ç±»é…ç½®" class="headerlink" title="åˆ†ç±»é…ç½®"></a>åˆ†ç±»é…ç½®</h3><p>ç›®å‰å•ä¸€é…ç½®å­˜åœ¨çš„é—®é¢˜ï¼š</p>
<blockquote>
<p>é—®é¢˜1ï¼š<br>å®é™…å¼€å‘ä¸­ï¼Œé€šå¸¸ä¸€ä¸ªç³»ç»Ÿä¼šå‡†å¤‡ devå¼€å‘ç¯å¢ƒï¼Œtestæµ‹è¯•ç¯å¢ƒï¼Œprodç”Ÿäº§ç¯å¢ƒã€‚<br>å¦‚ä½•ä¿è¯æŒ‡å®šç¯å¢ƒå¯åŠ¨æ—¶æœåŠ¡èƒ½æ­£ç¡®è¯»å–åˆ°Nacosä¸Šç›¸åº”ç¯å¢ƒçš„é…ç½®æ–‡ä»¶ï¼Ÿ</p>
<p>é—®é¢˜2ï¼š<br>ä¸€ä¸ªå¤§å‹åˆ†å¸ƒå¼å¾®æœåŠ¡ç³»ç»Ÿä¼šæœ‰å¾ˆå¤šå¾®æœåŠ¡å­é¡¹ç›®ï¼Œæ¯ä¸ªå¾®æœåŠ¡é¡¹ç›®åˆéƒ½ä¼šæœ‰ç›¸åº”çš„å¼€å‘ç¯å¢ƒã€æµ‹è¯•ç¯å¢ƒã€é¢„å‘ç¯å¢ƒã€æ­£å¼ç¯å¢ƒâ€¦â€¦é‚£æ€ä¹ˆå¯¹è¿™äº›å¾®æœåŠ¡é…ç½®è¿›è¡Œç®¡ç†å‘¢ï¼Ÿ</p>
</blockquote>
<p>Nacoså¼•å…¥äº† Namespace+Group+Data IDè¿›è¡Œé…ç½®ã€‚</p>
<blockquote>
<p>æœ€å¤–å±‚çš„namespaceæ˜¯å¯ä»¥ç”¨äºåŒºåˆ†éƒ¨ç½²ç¯å¢ƒçš„ï¼ŒGroupå’ŒDataIDé€»è¾‘ä¸ŠåŒºåˆ†ä¸¤ä¸ªç›®æ ‡å¯¹è±¡ã€‚</p>
<img src="/2023/03/25/SpringCloud/Java\Document\SpringCloud\images\image-20221230171530839.png" alt="image-20221230171530839" style="zoom:60%;">

<p>é»˜è®¤æƒ…å†µï¼š<br>Namespace&#x3D;publicï¼ŒGroup&#x3D;DEFAULT_GROUPï¼Œé»˜è®¤Clusteræ˜¯DEFAULT</p>
<ol>
<li><p>Nacosé»˜è®¤çš„å‘½åç©ºé—´æ˜¯publicï¼ŒNamespaceä¸»è¦ç”¨æ¥å®ç°éš”ç¦»ã€‚<br> æ¯”æ–¹è¯´æˆ‘ä»¬ç°åœ¨æœ‰ä¸‰ä¸ªç¯å¢ƒï¼šå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ›å»ºä¸‰ä¸ªNamespaceï¼Œä¸åŒçš„Namespaceä¹‹é—´æ˜¯éš”ç¦»çš„ã€‚</p>
</li>
<li><p>Groupé»˜è®¤æ˜¯DEFAULT_GROUPï¼ŒGroupå¯ä»¥æŠŠä¸åŒçš„å¾®æœåŠ¡åˆ’åˆ†åˆ°åŒä¸€ä¸ªåˆ†ç»„é‡Œé¢å»</p>
<p> Serviceå°±æ˜¯å¾®æœåŠ¡ï¼›ä¸€ä¸ªServiceå¯ä»¥åŒ…å«å¤šä¸ªClusterï¼ˆé›†ç¾¤ï¼‰ï¼ŒNacosé»˜è®¤Clusteræ˜¯DEFAULT</p>
</li>
<li><p>Clusteræ˜¯å¯¹æŒ‡å®šå¾®æœåŠ¡çš„ä¸€ä¸ªè™šæ‹Ÿåˆ’åˆ†ã€‚<br> æ¯”æ–¹è¯´ä¸ºäº†å®¹ç¾ï¼Œå°†Serviceå¾®æœåŠ¡åˆ†åˆ«éƒ¨ç½²åœ¨äº†æ­å·æœºæˆ¿å’Œå¹¿å·æœºæˆ¿ï¼Œè¿™æ—¶å°±å¯ä»¥ç»™æ­å·æœºæˆ¿çš„Serviceå¾®æœåŠ¡èµ·ä¸€ä¸ªé›†ç¾¤åç§°ï¼ˆHZï¼‰ï¼Œç»™å¹¿å·æœºæˆ¿çš„Serviceå¾®æœåŠ¡èµ·ä¸€ä¸ªé›†ç¾¤åç§°ï¼ˆGZï¼‰ï¼Œè¿˜å¯ä»¥å°½é‡è®©åŒä¸€ä¸ªæœºæˆ¿çš„å¾®æœåŠ¡äº’ç›¸è°ƒç”¨ï¼Œä»¥æå‡æ€§èƒ½ã€‚</p>
</li>
<li><p>æœ€åæ˜¯Instanceï¼Œå°±æ˜¯å¾®æœåŠ¡çš„å®ä¾‹ã€‚</p>
</li>
</ol>
</blockquote>
<h3 id="ä¸‰ç§æ–¹æ¡ˆåŠ è½½é…ç½®ç¤ºä¾‹"><a href="#ä¸‰ç§æ–¹æ¡ˆåŠ è½½é…ç½®ç¤ºä¾‹" class="headerlink" title="ä¸‰ç§æ–¹æ¡ˆåŠ è½½é…ç½®ç¤ºä¾‹"></a>ä¸‰ç§æ–¹æ¡ˆåŠ è½½é…ç½®ç¤ºä¾‹</h3><h4 id="DataIDæ–¹æ¡ˆ"><a href="#DataIDæ–¹æ¡ˆ" class="headerlink" title="DataIDæ–¹æ¡ˆ"></a>DataIDæ–¹æ¡ˆ</h4><blockquote>
<p>é»˜è®¤ç©ºé—´+é»˜è®¤åˆ†ç»„+æ–°å»ºdevå’Œtestä¸¤ä¸ªDataID</p>
<ol>
<li><p>Nacosæ–°å»ºé…ç½®æ–‡ä»¶ï¼šnacos-config-client-dev.yamlå’Œnacos-config-client-test.yaml</p>
<p> <img src="/2023/03/25/SpringCloud/Java\Document\SpringCloud\images\image-20221230172300692.png" alt="image-20221230172300692"></p>
</li>
<li><p>åœ¨é¡¹ç›®ä¸­é€šè¿‡spring.profile.activeå±æ€§å°±èƒ½è¿›è¡Œå¤šç¯å¢ƒä¸‹é…ç½®æ–‡ä»¶çš„è¯»å–</p>
 <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line"><span class="comment">#    active: dev</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">test</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>æµ‹è¯•ï¼š<a target="_blank" rel="noopener" href="http://localhost:3377/config/info">http://localhost:3377/config/info</a></p>
</li>
</ol>
</blockquote>
<h4 id="Groupæ–¹æ¡ˆ"><a href="#Groupæ–¹æ¡ˆ" class="headerlink" title="Groupæ–¹æ¡ˆ"></a>Groupæ–¹æ¡ˆ</h4><blockquote>
<p>é€šè¿‡Groupå®ç°ç¯å¢ƒåŒºåˆ†</p>
<ol>
<li><p>Nacosæ–°å»ºé…ç½®nacos-config-client-info.yamlå’Œnacos-config-client-info.yaml</p>
</li>
<li><p>Nacosæ–°å»ºé…ç½®æ—¶æŒ‡å®šç»„åï¼šDEV_GROUP å’Œ TEST_GROUP</p>
<p> <img src="/2023/03/25/SpringCloud/Java\Document\SpringCloud\images\image-20221230172817528.png" alt="image-20221230172817528"></p>
</li>
<li><p>bootstrap.ymlé…ç½®ä¸­æ–°å¢ groupé…ç½®ï¼š</p>
<p> bootstrap.yml</p>
 <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3377</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-config-client</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="comment">#NacosæœåŠ¡æ³¨å†Œä¸­å¿ƒåœ°å€</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="comment">#Nacosä½œä¸ºé…ç½®ä¸­å¿ƒåœ°å€</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">        <span class="comment">#æŒ‡å®šé…ç½®æ–‡ä»¶æ‰©å±•å</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">DEV_GROUP</span></span><br></pre></td></tr></table></figure>

<p> application.yml</p>
 <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line"><span class="comment">#    active: dev</span></span><br><span class="line"><span class="comment">#    active: test</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">info</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>æµ‹è¯•ï¼š<a target="_blank" rel="noopener" href="http://localhost:3377/config/info">http://localhost:3377/config/info</a></p>
</li>
</ol>
</blockquote>
<h4 id="Namespaceæ–¹æ¡ˆ"><a href="#Namespaceæ–¹æ¡ˆ" class="headerlink" title="Namespaceæ–¹æ¡ˆ"></a>Namespaceæ–¹æ¡ˆ</h4><blockquote>
<ol>
<li><p>æ–°å»ºdev&#x2F;test çš„ Namespace</p>
<p> <img src="/2023/03/25/SpringCloud/Java\Document\SpringCloud\images\image-20221230173250497.png" alt="image-20221230173250497"></p>
</li>
<li><p>æ–°å»ºé…ç½®æ–‡ä»¶</p>
<p> <img src="/2023/03/25/SpringCloud/Java\Document\SpringCloud\images\image-20221230173635811.png" alt="image-20221230173635811"></p>
</li>
<li><p>bootstrap.ymlæ–°å¢NameSpaceé…ç½®</p>
<p> bootstrap.yml</p>
 <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3377</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-config-client</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="comment">#NacosæœåŠ¡æ³¨å†Œä¸­å¿ƒåœ°å€</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="comment">#Nacosä½œä¸ºé…ç½®ä¸­å¿ƒåœ°å€</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">        <span class="comment">#æŒ‡å®šé…ç½®æ–‡ä»¶æ‰©å±•å</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">DEV_GROUP</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">2af700b7-c643-428f-9229-acfb40df35ad</span></span><br></pre></td></tr></table></figure>

<p> application.yml</p>
 <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line"><span class="comment">#    active: test</span></span><br><span class="line"><span class="comment">#    active: info</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>æµ‹è¯•ï¼šè®¿é—® <a target="_blank" rel="noopener" href="http://localhost:3377/config/info">http://localhost:3377/config/info</a></p>
</li>
</ol>
</blockquote>
<h2 id="Nacosé›†ç¾¤å’ŒæŒä¹…åŒ–é…ç½®"><a href="#Nacosé›†ç¾¤å’ŒæŒä¹…åŒ–é…ç½®" class="headerlink" title="Nacosé›†ç¾¤å’ŒæŒä¹…åŒ–é…ç½®"></a>Nacosé›†ç¾¤å’ŒæŒä¹…åŒ–é…ç½®</h2><h3 id="æ¦‚è¿°-8"><a href="#æ¦‚è¿°-8" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h3><blockquote>
<p>æ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="https://nacos.io/zh-cn/docs/cluster-mode-quick-start.html">https://nacos.io/zh-cn/docs/cluster-mode-quick-start.html</a></p>
<img src="/2023/03/25/SpringCloud/Java\Document\SpringCloud\images\image-20221230174024654.png" alt="image-20221230174024654" style="zoom:80%;">

<p>Nacosé»˜è®¤ä½¿ç”¨åµŒå…¥å¼æ•°æ®åº“å®ç°æ•°æ®çš„å­˜å‚¨ã€‚æ‰€ä»¥å¦‚æœå¯åŠ¨å¤šä¸ªé»˜è®¤é…ç½®ä¸‹çš„NacosèŠ‚ç‚¹ï¼Œæ•°æ®å­˜å‚¨æ˜¯å­˜åœ¨ä¸€è‡´æ€§é—®é¢˜çš„ã€‚<br>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒNacosé‡‡ç”¨äº†é›†ä¸­å¼å­˜å‚¨çš„æ–¹å¼æ¥æ”¯æŒé›†ç¾¤åŒ–éƒ¨ç½²ï¼Œç›®å‰åªæ”¯æŒMySQLçš„å­˜å‚¨ã€‚</p>
<p>æ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="https://nacos.io/zh-cn/docs/deployment.html">https://nacos.io/zh-cn/docs/deployment.html</a></p>
<p><strong>å•æœºæ¨¡å¼æ”¯æŒmysql</strong></p>
<p>åœ¨0.7ç‰ˆæœ¬ä¹‹å‰ï¼Œåœ¨å•æœºæ¨¡å¼æ—¶nacosä½¿ç”¨åµŒå…¥å¼æ•°æ®åº“å®ç°æ•°æ®çš„å­˜å‚¨ï¼Œä¸æ–¹ä¾¿è§‚å¯Ÿæ•°æ®å­˜å‚¨çš„åŸºæœ¬æƒ…å†µã€‚0.7ç‰ˆæœ¬å¢åŠ äº†æ”¯æŒmysqlæ•°æ®æºèƒ½åŠ›ï¼Œå…·ä½“çš„æ“ä½œæ­¥éª¤ï¼š</p>
<ul>
<li><p>1.å®‰è£…æ•°æ®åº“ï¼Œç‰ˆæœ¬è¦æ±‚ï¼š5.6.5+</p>
</li>
<li><p>2.åˆå§‹åŒ–mysqlæ•°æ®åº“ï¼Œæ•°æ®åº“åˆå§‹åŒ–æ–‡ä»¶ï¼šmysql-schema.sql</p>
</li>
<li><p>3.ä¿®æ”¹conf&#x2F;application.propertiesæ–‡ä»¶ï¼Œå¢åŠ æ”¯æŒmysqlæ•°æ®æºé…ç½®ï¼ˆç›®å‰åªæ”¯æŒmysqlï¼‰ï¼Œæ·»åŠ mysqlæ•°æ®æºçš„urlã€ç”¨æˆ·åå’Œå¯†ç ã€‚</p>
  <figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.datasource.platform</span>=<span class="string">mysql</span></span><br><span class="line"></span><br><span class="line"><span class="attr">db.num</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">db.url.0</span>=<span class="string">jdbc:mysql://11.162.196.16:3306/nacos_devtest?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true</span></span><br><span class="line"><span class="attr">db.user</span>=<span class="string">nacos_devtest</span></span><br><span class="line"><span class="attr">db.password</span>=<span class="string">youdontknow</span></span><br></pre></td></tr></table></figure>

<p>  å†ä»¥å•æœºæ¨¡å¼å¯åŠ¨nacosï¼Œnacosæ‰€æœ‰å†™åµŒå…¥å¼æ•°æ®åº“çš„æ•°æ®éƒ½å†™åˆ°äº†mysql</p>
</li>
</ul>
</blockquote>
<h3 id="NacosæŒä¹…åŒ–é…ç½®"><a href="#NacosæŒä¹…åŒ–é…ç½®" class="headerlink" title="NacosæŒä¹…åŒ–é…ç½®"></a>NacosæŒä¹…åŒ–é…ç½®</h3><blockquote>
<p>Nacosé»˜è®¤è‡ªå¸¦çš„æ˜¯åµŒå…¥å¼æ•°æ®åº“derby</p>
<p>æ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="https://github.com/alibaba/nacos/blob/develop/config/pom.xml">https://github.com/alibaba/nacos/blob/develop/config/pom.xml</a></p>
<p><strong>derbyåˆ°mysqlåˆ‡æ¢é…ç½®æ­¥éª¤ï¼š</strong></p>
<ol>
<li><p>æ‰§è¡Œnacos\confç›®å½•ä¸‹SQLè„šæœ¬ nacos-mysql.sql</p>
</li>
<li><p>ä¿®æ”¹é…ç½®nacos\conf\application.properties</p>
 <figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">db.num</span>=<span class="string">1</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Connect URL of DB:</span></span><br><span class="line"><span class="attr">db.url.0</span>=<span class="string">jdbc:mysql://192.168.100.100:3306/nacos_config?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=UTC</span></span><br><span class="line"><span class="attr">db.user.0</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">db.password.0</span>=<span class="string">root</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>é‡å¯Nacosï¼Œå¯ä»¥çœ‹åˆ°æ˜¯ä¸ªå…¨æ–°çš„ç©ºè®°å½•ç•Œé¢ï¼Œä»¥å‰æ˜¯è®°å½•è¿›derby</p>
</li>
</ol>
</blockquote>
<h3 id="Linuxç‰ˆNacos-MySQLç”Ÿäº§ç¯å¢ƒé…ç½®"><a href="#Linuxç‰ˆNacos-MySQLç”Ÿäº§ç¯å¢ƒé…ç½®" class="headerlink" title="Linuxç‰ˆNacos+MySQLç”Ÿäº§ç¯å¢ƒé…ç½®"></a>Linuxç‰ˆNacos+MySQLç”Ÿäº§ç¯å¢ƒé…ç½®</h3><p>é¢„è®¡éœ€è¦ï¼š1ä¸ªNginx + 3ä¸ªnacosæ³¨å†Œä¸­å¿ƒ + 1ä¸ªmysql</p>
<h4 id="ä¸‹è½½"><a href="#ä¸‹è½½" class="headerlink" title="ä¸‹è½½"></a>ä¸‹è½½</h4><p>åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://github.com/alibaba/nacos/releases/tag/">https://github.com/alibaba/nacos/releases/tag/</a></p>
<p>è§£å‹å¹¶å®‰è£…</p>
<p>å»ºè®®: ç”Ÿäº§ç¯å¢ƒ 3 ä¸ªèŠ‚ç‚¹ åŠå…¶ä»¥ä¸Š</p>
<h4 id="é›†ç¾¤é…ç½®æ­¥éª¤"><a href="#é›†ç¾¤é…ç½®æ­¥éª¤" class="headerlink" title="é›†ç¾¤é…ç½®æ­¥éª¤"></a>é›†ç¾¤é…ç½®æ­¥éª¤</h4><ol>
<li><p>æ‰§è¡Œnacos\confç›®å½•ä¸‹SQLè„šæœ¬ nacos-mysql.sql</p>
</li>
<li><p>ä¿®æ”¹é…ç½®nacos\conf\application.properties</p>
 <figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">db.num</span>=<span class="string">1</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Connect URL of DB:</span></span><br><span class="line"><span class="attr">db.url.0</span>=<span class="string">jdbc:mysql://192.168.100.100:3306/nacos_config?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=UTC</span></span><br><span class="line"><span class="attr">db.user.0</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">db.password.0</span>=<span class="string">root</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="SpringCloud-Alibaba-Sentinelå®ç°ç†”æ–­ä¸é™æµ"><a href="#SpringCloud-Alibaba-Sentinelå®ç°ç†”æ–­ä¸é™æµ" class="headerlink" title="SpringCloud Alibaba Sentinelå®ç°ç†”æ–­ä¸é™æµ"></a>SpringCloud Alibaba Sentinelå®ç°ç†”æ–­ä¸é™æµ</h1><h2 id="Sentinelæ¦‚è¿°"><a href="#Sentinelæ¦‚è¿°" class="headerlink" title="Sentinelæ¦‚è¿°"></a>Sentinelæ¦‚è¿°</h2><h3 id="ä¸‹è½½-1"><a href="#ä¸‹è½½-1" class="headerlink" title="ä¸‹è½½"></a>ä¸‹è½½</h3><p>æ–‡æ¡£ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel">https://github.com/alibaba/Sentinel</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki/%E4%BB%8B%E7%BB%8D">https://github.com/alibaba/Sentinel/wiki/%E4%BB%8B%E7%BB%8D</a></p>
<p>ä¸‹è½½åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/releases">https://github.com/alibaba/Sentinel/releases</a></p>
<h3 id="ä½œç”¨-4"><a href="#ä½œç”¨-4" class="headerlink" title="ä½œç”¨"></a>ä½œç”¨</h3><blockquote>
<p><strong>æœåŠ¡é›ªå´©ã€æœåŠ¡ç†”æ–­ã€æœåŠ¡é™çº§ã€æœåŠ¡é™æµ</strong></p>
</blockquote>
<h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><p><a target="_blank" rel="noopener" href="https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html#_spring_cloud_alibaba_sentinel">https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html#_spring_cloud_alibaba_sentinel</a></p>
<h2 id="å®‰è£…Sentinelæ§åˆ¶å°"><a href="#å®‰è£…Sentinelæ§åˆ¶å°" class="headerlink" title="å®‰è£…Sentinelæ§åˆ¶å°"></a>å®‰è£…Sentinelæ§åˆ¶å°</h2><p>ä¸‹è½½ï¼š<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/releases">https://github.com/alibaba/Sentinel/releases</a></p>
<p>è¿è¡Œï¼šjava -jar sentinel-dashboard-1.8.6.jar</p>
<p>è®¿é—®ç•Œé¢ï¼š<a target="_blank" rel="noopener" href="http://localhost:8080/">http://localhost:8080</a> 	åˆå§‹ç”¨æˆ·å¯†ç ï¼šsentinel&#x2F;sentinel</p>
<h2 id="åˆå§‹åŒ–æ¼”ç¤ºå·¥ç¨‹"><a href="#åˆå§‹åŒ–æ¼”ç¤ºå·¥ç¨‹" class="headerlink" title="åˆå§‹åŒ–æ¼”ç¤ºå·¥ç¨‹"></a>åˆå§‹åŒ–æ¼”ç¤ºå·¥ç¨‹</h2><ol>
<li><p>æ–°å»ºæ¨¡å— cloudalibaba-sentinel-service8401</p>
</li>
<li><p>pom.xml</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--SpringCloud ailibaba sentinel-datasource-nacos åšæŒä¹…åŒ–ä½¿ç”¨--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-datasource-nacos<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--SpringCloud ailibaba sentinel --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--openfeign--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.6.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>yml</p>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/24/Netty/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MineTing">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/24/Netty/" class="post-title-link" itemprop="url">Netty</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-24 00:00:00" itemprop="dateCreated datePublished" datetime="2023-03-24T00:00:00+08:00">2023-03-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-22 16:35:09" itemprop="dateModified" datetime="2023-03-22T16:35:09+08:00">2023-03-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <div align="center"><font size="70"><b>Netty</b></font></div>

<h1 id="Netty-åŸºæœ¬ä»‹ç»"><a href="#Netty-åŸºæœ¬ä»‹ç»" class="headerlink" title="Netty åŸºæœ¬ä»‹ç»"></a>Netty åŸºæœ¬ä»‹ç»</h1><p>å®˜ç½‘åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://netty.io/">https://netty.io/</a></p>
<p>GitHubåœ°å€ï¼š<a target="_blank" rel="noopener" href="https://github.com/netty">https://github.com/netty</a></p>
<blockquote>
<p>Netty is <em>an asynchronous event-driven network application framework</em><br>for rapid development of maintainable high performance protocol servers &amp; clients.</p>
<img src="/2023/03/24/Netty/Java\Document\Netty\Netty å‚çœ‹æ–‡æ¡£.assets\components.png" alt="components" style="zoom:100%;">
</blockquote>
<ol>
<li>Netty æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ã€åŸºäºäº‹ä»¶é©±åŠ¨çš„ç½‘ç»œåº”ç”¨æ¡†æ¶ï¼Œç”¨ä»¥å¿«é€Ÿå¼€å‘é«˜æ€§èƒ½ã€é«˜å¯é æ€§çš„ç½‘ç»œIOç¨‹åºã€‚</li>
<li>Netty æ˜¯ç”± JBOSS æä¾›çš„ä¸€ä¸ª Java å¼€æºæ¡†æ¶ï¼Œç°ä¸º Github ä¸Šçš„ç‹¬ç«‹é¡¹ç›®ã€‚</li>
<li>Netty ä¸»è¦é’ˆå¯¹åœ¨ TCP åè®®ä¸‹ï¼Œé¢å‘ Clients ç«¯çš„é«˜å¹¶å‘åº”ç”¨ï¼Œæˆ–è€… Peer-to-Peer åœºæ™¯ä¸‹çš„å¤§é‡æ•°æ®æŒç»­ä¼ è¾“çš„åº”ç”¨ã€‚</li>
<li>Netty æœ¬è´¨æ˜¯ä¸€ä¸ª NIO æ¡†æ¶ï¼Œé€‚ç”¨äºæœåŠ¡å™¨é€šè®¯ç›¸å…³çš„å¤šç§åº”ç”¨åœºæ™¯</li>
</ol>
<p>åº”ç”¨åœºæ™¯ï¼š</p>
<ol>
<li><p>å¼‚æ­¥é«˜æ€§èƒ½çš„é€šä¿¡æ¡†æ¶ï¼Œå¦‚åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„ RPC æ¡†æ¶</p>
</li>
<li><p>ç§æœ‰åè®®çš„å®šåˆ¶å¼€å‘</p>
</li>
<li><p>ç½‘ç»œæ¸¸æˆï¼Œåœ°å›¾å¼€å‘ç­‰</p>
</li>
<li><p>å¤§æ•°æ®é¢†åŸŸï¼š</p>
<p> â€‹	ç»å…¸çš„ Hadoop çš„é«˜æ€§èƒ½é€šä¿¡å’Œåºåˆ—åŒ–ç»„ä»¶ Avro çš„ RPC æ¡†æ¶ï¼Œé»˜è®¤é‡‡ç”¨ Netty è¿›è¡Œè·¨ç•Œç‚¹é€šä¿¡ã€‚</p>
<p> â€‹	å®ƒçš„ Netty Service åŸºäº Netty æ¡†æ¶äºŒæ¬¡å°è£…å®ç°ã€‚</p>
</li>
</ol>
<p>	</p>
<p>å‚è€ƒä¹¦ç±ï¼š</p>
<ol>
<li>Netty In Action</li>
<li>Netty æƒå¨æŒ‡å—ï¼ˆåŸºäºNettyï¼‰</li>
</ol>
<h1 id="IO-æ¨¡å‹"><a href="#IO-æ¨¡å‹" class="headerlink" title="IO æ¨¡å‹"></a>IO æ¨¡å‹</h1><p>Java å…±æ”¯æŒ 3 ç§ç½‘ç»œç¼–ç¨‹æ¨¡å‹&#x2F;IO æ¨¡å¼ï¼šBIOã€NIOã€AIO</p>
<h2 id="Java-BIO"><a href="#Java-BIO" class="headerlink" title="Java BIO"></a>Java BIO</h2><p>â€‹		åŒæ­¥é˜»å¡å‹ï¼ˆBlocking IOï¼‰ï¼ŒæœåŠ¡å™¨å®ç°æ¨¡å¼ä¸ºä¸€ä¸ªè¿æ¥ä¸€ä¸ªçº¿ç¨‹ï¼Œå³å®¢æˆ·ç«¯æœ‰è¿æ¥è¯·æ±‚æ—¶æœåŠ¡å™¨ç«¯å°±éœ€è¦å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œå¤„ç†ï¼Œå¦‚æœè¿™ä¸ªè¿æ¥ä¸åšä»»ä½•äº‹æƒ…ä¼šé€ æˆä¸å¿…è¦çš„çº¿ç¨‹å¼€é”€ã€‚</p>
<p>â€‹	é€‚ç”¨äºè¿æ¥æ•°ç›®æ¯”è¾ƒå°ä¸”å›ºå®šçš„æ¶æ„ï¼Œè¿™ç§æ–¹å¼å¯¹æœåŠ¡å™¨èµ„æºè¦æ±‚æ¯”è¾ƒé«˜ï¼Œå¹¶å‘å±€é™äºåº”ç”¨ä¸­ï¼ŒJDK1.4ä»¥å‰çš„å”¯ä¸€é€‰æ‹©ã€‚</p>
<h2 id="Java-NIO"><a href="#Java-NIO" class="headerlink" title="Java NIO"></a>Java NIO</h2><p>â€‹		åŒæ­¥éé˜»å¡ï¼ŒæœåŠ¡å™¨å®ç°æ¨¡å¼ä¸ºä¸€ä¸ªçº¿ç¨‹å¤„ç†å¤šä¸ªè¯·æ±‚ï¼Œå³å®¢æˆ·ç«¯å‘é€çš„è¿æ¥è¯·æ±‚éƒ½ä¼šæ³¨å†Œåˆ°å¤šè·¯å¤ç”¨å™¨ä¸Šï¼Œå¤šè·¯å¤ç”¨å™¨è½®è¯¢åˆ°è¿æ¥æœ‰ I&#x2F;O è¯·æ±‚å°±è¿›è¡Œå¤„ç†ã€‚</p>
<p>â€‹		é€‚ç”¨äºç”¨äºè¿æ¥æ•°ç›®å¤šä¸”è¿æ¥æ¯”è¾ƒçŸ­ï¼ˆè½»æ“ä½œï¼‰çš„æ¶æ„ï¼Œæ¯”å¦‚èŠå¤©æœåŠ¡å™¨ï¼Œå¼¹å¹•ç³»ç»Ÿï¼ŒæœåŠ¡å™¨é—´é€šè®¯ç­‰ï¼ŒJDK1.4 å¼€å§‹æ”¯æŒã€‚</p>
<h2 id="Java-AIO-NIO-2"><a href="#Java-AIO-NIO-2" class="headerlink" title="Java AIO(NIO.2)"></a>Java AIO(NIO.2)</h2><p>â€‹		å¼‚æ­¥éé˜»å¡ï¼ŒAIO å¼•å…¥å¼‚æ­¥é€šé“çš„æ¦‚å¿µï¼Œé‡‡ç”¨äº† Proactor æ¨¡å¼ï¼Œç®€åŒ–äº†ç¨‹åºç¼–å†™ï¼Œæœ‰æ•ˆçš„è¯·æ±‚æ‰å¯åŠ¨çº¿ç¨‹ï¼Œå®ƒçš„ç‰¹ç‚¹æ˜¯å…ˆç”±æ“ä½œç³»ç»Ÿå®Œæˆåæ‰é€šçŸ¥æœåŠ¡ç«¯ç¨‹åºå¯åŠ¨çº¿ç¨‹å»å¤„ç†ï¼Œä¸€èˆ¬é€‚ç”¨äºè¿æ¥æ•°è¾ƒå¤šä¸”è¿æ¥æ—¶é—´è¾ƒé•¿çš„åº”ç”¨ã€‚</p>
<p>â€‹		é€‚ç”¨äºè¿æ¥æ•°ç›®å¤šä¸”è¿æ¥æ¯”è¾ƒé•¿ï¼ˆé‡æ“ä½œï¼‰çš„æ¶æ„ï¼Œæ¯”å¦‚ç›¸å†ŒæœåŠ¡å™¨ï¼Œå……åˆ†è°ƒç”¨OS å‚ä¸å¹¶å‘æ“ä½œï¼Œç¼–ç¨‹æ¯”è¾ƒå¤æ‚ï¼ŒJDK7 å¼€å§‹æ”¯æŒã€‚</p>
<h1 id="BIO-ç¼–ç¨‹"><a href="#BIO-ç¼–ç¨‹" class="headerlink" title="BIO ç¼–ç¨‹"></a>BIO ç¼–ç¨‹</h1><h2 id="åŸºæœ¬ä»‹ç»"><a href="#åŸºæœ¬ä»‹ç»" class="headerlink" title="åŸºæœ¬ä»‹ç»"></a>åŸºæœ¬ä»‹ç»</h2><ol>
<li><p>Java BIO å°±æ˜¯ä¼ ç»Ÿçš„ java io ç¼–ç¨‹ï¼Œå…¶ç›¸å…³çš„ç±»å’Œæ¥å£åœ¨ java.ioã€‚</p>
</li>
<li><p>åŒæ­¥é˜»å¡IOï¼ŒæœåŠ¡å™¨å®ç°æ¨¡å¼ä¸ºä¸€ä¸ªè¿æ¥å¯¹åº”ä¸€ä¸ªçº¿ç¨‹ï¼Œå³å®¢æˆ·ç«¯æœ‰è¿æ¥è¯·æ±‚æ—¶æœåŠ¡å™¨ç«¯å°±ä¼šå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œå¤„ç†ï¼Œå¦‚æœè¿™ä¸ªè¿æ¥ä¸åšä»»ä½•äº‹æƒ…ä¼šé€ æˆä¸å¿…è¦çš„çº¿ç¨‹å¼€é”€ï¼Œå¯ä»¥é€šè¿‡çº¿ç¨‹æ± æœºåˆ¶æ”¹å–„ï¼ˆå®ç°å¤šä¸ªå®¢æˆ·è¿æ¥æœåŠ¡å™¨ï¼‰ã€‚</p>
</li>
<li><p>é€‚ç”¨äºè¿æ¥æ•°ç›®æ¯”è¾ƒå°ä¸”å›ºå®šçš„æ¶æ„ï¼Œè¿™ç§æ–¹å¼å¯¹æœåŠ¡å™¨èµ„æºè¦æ±‚æ¯”è¾ƒé«˜ï¼Œå¹¶å‘å±€é™äºåº”ç”¨ä¸­ã€‚</p>
</li>
</ol>
<h2 id="åŸç†è¯´æ˜"><a href="#åŸç†è¯´æ˜" class="headerlink" title="åŸç†è¯´æ˜"></a>åŸç†è¯´æ˜</h2><p>â€‹		æœåŠ¡å™¨å¯åŠ¨ä¸€ä¸ª ServerSocket è¿›è¡Œç«¯å£ç›‘å¬ï¼Œå®¢æˆ·ç«¯å¯åŠ¨ä¸€ä¸ª Socket ä¸æœåŠ¡å™¨è¿›è¡Œé€šä¿¡ï¼Œè¿æ¥å»ºç«‹åï¼Œå¦‚æœæœåŠ¡å™¨æœ‰ç©ºé—²çº¿ç¨‹å»ºç«‹ï¼Œå°±ä¼šæ–°å»ºçº¿ç¨‹å¤„ç†å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚</p>
<p>ç¨‹åºé˜»å¡çš„ä½ç½®ï¼š</p>
<h2 id="åº”ç”¨ç¤ºä¾‹"><a href="#åº”ç”¨ç¤ºä¾‹" class="headerlink" title="åº”ç”¨ç¤ºä¾‹"></a>åº”ç”¨ç¤ºä¾‹</h2><p>ç¨‹åºï¼šç›‘å¬6000ç«¯å£ï¼Œå¯ä»¥è¿æ¥å¤šä¸ªå®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯è¯·æ±‚ä½¿ç”¨ telnet ä¸ä¹‹é€šä¿¡ã€‚</p>
<blockquote>
<p>telnetå‘½ä»¤ï¼štelnetï¼štelnet 127.0.0.1 6000</p>
<p>ä½¿ç”¨ CTRL + [ï¼Œè¾“å…¥ send  [æ¶ˆæ¯]</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.bio;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.ServerSocket;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * BIOServerï¼šç›‘å¬6000ç«¯å£ï¼Œå¯ä»¥è¿æ¥å¤šä¸ªå®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯è¯·æ±‚ä½¿ç”¨ telnet ä¸ä¹‹é€šä¿¡ã€‚</span></span><br><span class="line"><span class="comment"> * é˜»å¡ä»£ç ï¼š</span></span><br><span class="line"><span class="comment"> * 1. accept()  è¿æ¥é˜»å¡</span></span><br><span class="line"><span class="comment"> * 2. read()/write()    è¯»å†™æ•°æ®é˜»å¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BIOServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">threadPool</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line">        <span class="type">ServerSocket</span> <span class="variable">serverSocket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(<span class="number">6000</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;BIOServer start...&quot;</span>);</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Waiting Clients Connect...&quot;</span>);</span><br><span class="line">            <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> serverSocket.accept();</span><br><span class="line">            System.out.println(<span class="string">&quot;Clients Connect...&quot;</span>);</span><br><span class="line">            threadPool.execute(() -&gt; &#123;</span><br><span class="line">                handler(socket);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">handler</span><span class="params">(Socket socket)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Thread Id: &quot;</span> + Thread.currentThread().getId() + <span class="string">&quot;, ThreadName: &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="type">int</span> <span class="variable">read</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> socket.getInputStream();</span><br><span class="line">            <span class="comment">//while ((read = in.read(bytes)) != -1) &#123;&#125;</span></span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;handler will read...&quot;</span>);</span><br><span class="line">                read = in.read(bytes);</span><br><span class="line">                <span class="keyword">if</span> (read != -<span class="number">1</span>) &#123;</span><br><span class="line">                    System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(bytes, <span class="number">0</span>, read));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                socket.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å­˜åœ¨é—®é¢˜"><a href="#å­˜åœ¨é—®é¢˜" class="headerlink" title="å­˜åœ¨é—®é¢˜"></a>å­˜åœ¨é—®é¢˜</h2><ol>
<li>æ¯ä¸ªè¯·æ±‚éƒ½éœ€è¦åˆ›å»ºç‹¬ç«‹çš„çº¿ç¨‹ï¼Œä¸å¯¹åº”çš„å®¢æˆ·ç«¯è¿›è¡Œæ•°æ® Readï¼Œä¸šåŠ¡å¤„ç†ï¼Œæ•°æ®Write ã€‚</li>
<li>å½“å¹¶å‘æ•°è¾ƒå¤§æ—¶ï¼Œéœ€è¦åˆ›å»ºå¤§é‡çº¿ç¨‹æ¥å¤„ç†è¿æ¥ï¼Œç³»ç»Ÿèµ„æºå ç”¨è¾ƒå¤§ã€‚</li>
<li>è¿æ¥å»ºç«‹åï¼Œå¦‚æœå½“å‰çº¿ç¨‹æš‚æ—¶æ²¡æœ‰æ•°æ®å¯è¯»ï¼Œåˆ™çº¿ç¨‹å°±é˜»å¡åœ¨ Read æ“ä½œä¸Šï¼Œé€ æˆçº¿ç¨‹èµ„æºæµªè´¹ã€‚</li>
</ol>
<h1 id="NIOç¼–ç¨‹"><a href="#NIOç¼–ç¨‹" class="headerlink" title="NIOç¼–ç¨‹"></a>NIOç¼–ç¨‹</h1><h2 id="åŸºæœ¬ä»‹ç»-1"><a href="#åŸºæœ¬ä»‹ç»-1" class="headerlink" title="åŸºæœ¬ä»‹ç»"></a>åŸºæœ¬ä»‹ç»</h2><ol>
<li><p>Java NIO å…¨ç§° java non-blocking IOï¼Œæ˜¯æŒ‡ JDK æä¾›çš„æ–° APIã€‚ä» JDK1.4 å¼€å§‹ï¼ŒJava æä¾›äº†ä¸€ç³»åˆ—æ”¹è¿›çš„è¾“å…¥&#x2F;è¾“å‡ºçš„æ–°ç‰¹æ€§ï¼Œè¢«ç»Ÿç§°ä¸º NIOï¼ˆå³ New IOï¼‰ï¼Œæ˜¯åŒæ­¥éé˜»å¡çš„ï¼ŒNIO ç›¸å…³ç±»éƒ½è¢«æ”¾åœ¨ java.nio åŒ…åŠå­åŒ…ä¸‹ã€‚</p>
</li>
<li><p>NIO æœ‰ä¸‰å¤§æ ¸å¿ƒéƒ¨åˆ†ï¼šChannelï¼ˆé€šé“ï¼‰ï¼ŒBufferï¼ˆç¼“å†²åŒº)ï¼‰, Selectorï¼ˆé€‰æ‹©å™¨ï¼‰</p>
</li>
<li><p>NIO æ˜¯ é¢å‘ç¼“å†²åŒº ï¼Œæˆ–è€…é¢å‘ å— ç¼–ç¨‹çš„ã€‚æ•°æ®è¯»å–åˆ°ä¸€ä¸ªå®ƒç¨åå¤„ç†çš„ç¼“å†²åŒºï¼Œéœ€è¦æ—¶å¯åœ¨ç¼“å†²åŒºä¸­å‰åç§»åŠ¨ï¼Œè¿™å°±å¢åŠ äº†å¤„ç†è¿‡ç¨‹ä¸­çš„çµæ´»æ€§ï¼Œä½¿ç”¨å®ƒå¯ä»¥æä¾›éé˜»å¡å¼çš„é«˜ä¼¸ç¼©æ€§ç½‘ç»œã€‚</p>
</li>
<li><p>Java NIO çš„éé˜»å¡æ¨¡å¼ï¼Œä½¿ä¸€ä¸ªçº¿ç¨‹ä»æŸé€šé“å‘é€è¯·æ±‚æˆ–è€…è¯»å–æ•°æ®ï¼Œä½†æ˜¯å®ƒä»…èƒ½å¾—åˆ°ç›®å‰å¯ç”¨çš„æ•°æ®ï¼Œå¦‚æœç›®å‰æ²¡æœ‰æ•°æ®å¯ç”¨æ—¶ï¼Œå°±ä»€ä¹ˆéƒ½ä¸ä¼šè·å–ï¼Œè€Œä¸æ˜¯ä¿æŒçº¿ç¨‹é˜»å¡ï¼Œæ‰€ä»¥ç›´è‡³æ•°æ®å˜çš„å¯ä»¥è¯»å–ä¹‹å‰ï¼Œè¯¥çº¿ç¨‹å¯ä»¥ç»§ç»­åšå…¶ä»–çš„äº‹æƒ…ã€‚ éé˜»å¡å†™ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œä¸€ä¸ªçº¿ç¨‹è¯·æ±‚å†™å…¥ä¸€äº›æ•°æ®åˆ°æŸé€šé“ï¼Œä½†ä¸éœ€è¦ç­‰å¾…å®ƒå®Œå…¨å†™å…¥ï¼Œè¿™ä¸ªçº¿ç¨‹åŒæ—¶å¯ä»¥å»åšåˆ«çš„äº‹æƒ…ã€‚</p>
</li>
<li><p>é€šä¿—ç†è§£ï¼šNIO æ˜¯å¯ä»¥åšåˆ°ç”¨ä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†å¤šä¸ªæ“ä½œçš„ã€‚å‡è®¾æœ‰ 10000 ä¸ªè¯·æ±‚è¿‡æ¥,æ ¹æ®å®é™…æƒ…å†µï¼Œå¯ä»¥åˆ†é…50 æˆ–è€… 100 ä¸ªçº¿ç¨‹æ¥å¤„ç†ã€‚ä¸åƒä¹‹å‰çš„é˜»å¡ IO é‚£æ ·ï¼Œéå¾—åˆ†é… 10000 ä¸ªã€‚</p>
</li>
</ol>
<h2 id="NIO-ä¸‰å¤§ç»„ä»¶è¯´æ˜"><a href="#NIO-ä¸‰å¤§ç»„ä»¶è¯´æ˜" class="headerlink" title="NIO ä¸‰å¤§ç»„ä»¶è¯´æ˜"></a>NIO ä¸‰å¤§ç»„ä»¶è¯´æ˜</h2><ol>
<li>æ¯ä¸ª Selector å¯¹åº”ä¸€ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ª Channel ï¼Œæ¯ä¸ª Channel å¯¹åº”ä¸€ä¸ª Bufferã€‚</li>
<li>å¤šä¸ª Channel ä¼šæ³¨å†Œåˆ° Selector ä¸Šï¼ŒSelector æ ¹æ® Event ï¼Œåœ¨å„ä¸ª Channel ä¸Šè¿›è¡Œåˆ‡æ¢ã€‚</li>
<li>æ•°æ®çš„è¯»å†™é€šè¿‡ Buffer , Bufferæ˜¯åŒå‘çš„ï¼Œæ˜¯ä¸€ä¸ªå†…å­˜å—ï¼Œåº•å±‚æ˜¯æ•°ç»„ï¼Œä¸åŒäº BIO çš„è¾“å…¥è¾“å‡ºæµï¼ŒNIO çš„ Buffer å¯è¯»å¯å†™ï¼Œéœ€è¦ä½¿ç”¨ flip() æ–¹æ³•è½¬æ¢ã€‚</li>
</ol>
<h2 id="NIO-ä¸-BIO-çš„æ¯”è¾ƒ"><a href="#NIO-ä¸-BIO-çš„æ¯”è¾ƒ" class="headerlink" title="NIO ä¸ BIO çš„æ¯”è¾ƒ"></a>NIO ä¸ BIO çš„æ¯”è¾ƒ</h2><ol>
<li>BIO ä»¥æµçš„æ–¹å¼å¤„ç†æ•°æ®ï¼Œè€Œ NIO ä»¥å—çš„æ–¹å¼å¤„ç†æ•°æ®ï¼Œå— I&#x2F;O çš„æ•ˆç‡æ¯”æµ I&#x2F;O é«˜å¾ˆå¤šã€‚</li>
<li>BIO æ˜¯é˜»å¡çš„ï¼ŒNIO åˆ™æ˜¯éé˜»å¡çš„ã€‚</li>
<li>BIO åŸºäºå­—èŠ‚æµå’Œå­—ç¬¦æµè¿›è¡Œæ“ä½œï¼Œè€Œ NIO åŸºäº Channel(é€šé“)å’Œ Bufferï¼ˆç¼“å†²åŒºï¼‰è¿›è¡Œæ“ä½œï¼Œæ•°æ®æ€»æ˜¯ä»é€šé“è¯»å–åˆ°ç¼“å†²åŒºä¸­ï¼Œæˆ–è€…ä»ç¼“å†²åŒºå†™å…¥åˆ°é€šé“ä¸­ã€‚Selectorï¼ˆé€‰æ‹©å™¨ï¼‰ç”¨äºç›‘å¬å¤šä¸ªé€šé“çš„äº‹ä»¶ï¼ˆæ¯”å¦‚ï¼šè¿æ¥è¯·æ±‚ï¼Œæ•°æ®åˆ°è¾¾ç­‰ï¼‰ï¼Œå› æ­¤ä½¿ç”¨å•ä¸ªçº¿ç¨‹å°±å¯ä»¥ç›‘å¬å¤šä¸ªå®¢æˆ·ç«¯é€šé“ã€‚</li>
</ol>
<h2 id="ç¼“å†²åŒº-Buffer"><a href="#ç¼“å†²åŒº-Buffer" class="headerlink" title="ç¼“å†²åŒº Buffer"></a>ç¼“å†²åŒº Buffer</h2><h3 id="åŸºæœ¬ä»‹ç»-2"><a href="#åŸºæœ¬ä»‹ç»-2" class="headerlink" title="åŸºæœ¬ä»‹ç»"></a>åŸºæœ¬ä»‹ç»</h3><p>â€‹		ç¼“å†²åŒºï¼ˆBufferï¼‰ï¼šç¼“å†²åŒºæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå¯ä»¥è¯»å†™æ•°æ®çš„å†…å­˜å—ï¼Œå¯ä»¥ç†è§£æˆæ˜¯ä¸€ä¸ªå®¹å™¨å¯¹è±¡ï¼ˆå«æ•°ç»„ï¼‰ï¼Œè¯¥å¯¹è±¡æä¾›äº†ä¸€ç»„æ–¹æ³•ï¼Œå¯ä»¥æ›´è½»æ¾åœ°ä½¿ç”¨å†…å­˜å—ï¼Œç¼“å†²åŒºå¯¹è±¡å†…ç½®äº†ä¸€äº›æœºåˆ¶ï¼Œèƒ½å¤Ÿè·Ÿè¸ªå’Œè®°å½•ç¼“å†²åŒºçš„çŠ¶æ€å˜åŒ–æƒ…å†µã€‚Channel æä¾›ä»æ–‡ä»¶ã€ç½‘ç»œè¯»å–æ•°æ®çš„æ¸ é“ï¼Œä½†æ˜¯è¯»å–æˆ–å†™å…¥çš„æ•°æ®éƒ½å¿…é¡»ç»ç”±Bufferã€‚</p>
<h3 id="Buffer-ç±»åŠå…¶å­ç±»"><a href="#Buffer-ç±»åŠå…¶å­ç±»" class="headerlink" title="Buffer ç±»åŠå…¶å­ç±»"></a>Buffer ç±»åŠå…¶å­ç±»</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Buffer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The characteristics of Spliterators that traverse and split elements</span></span><br><span class="line"><span class="comment">     * maintained in Buffers.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SPLITERATOR_CHARACTERISTICS</span> <span class="operator">=</span></span><br><span class="line">        Spliterator.SIZED | Spliterator.SUBSIZED | Spliterator.ORDERED;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Invariants: mark &lt;= position &lt;= limit &lt;= capacity</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">mark</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">position</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> limit;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> capacity;</span><br></pre></td></tr></table></figure>

<p>å®ç°å­ç±»ï¼š</p>
<p>Buffer</p>
<p>â€‹		|â€”- IntBuffer</p>
<p>â€‹		|â€”- FloatBuffer 		</p>
<p>â€‹		|â€”- DoubleBuffer 		</p>
<p>â€‹		|â€”- CharBuffer 		</p>
<p>â€‹		|â€”- ShortBuffer 		</p>
<p>â€‹		|â€”- LongBuffer 		</p>
<p>â€‹		|â€”- ByteBuffer 		</p>
<p>â€‹				|â€”- HeapByteBuffer</p>
<p>â€‹						|â€”- HeapByteBufferR</p>
<p>â€‹				|â€”- MappedByteBuffer</p>
<p>â€‹						|â€”- DireByteBUffer</p>
<p>â€‹								|â€”- DirectByteBufferR</p>
<h3 id="ä½¿ç”¨ç¤ºä¾‹"><a href="#ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="ä½¿ç”¨ç¤ºä¾‹"></a>ä½¿ç”¨ç¤ºä¾‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.nio;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.IntBuffer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BufferDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">IntBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> IntBuffer.allocate(<span class="number">5</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; buffer.capacity(); i++) &#123;</span><br><span class="line">            buffer.put(i * <span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è¯»å†™åˆ‡æ¢</span></span><br><span class="line">        buffer.flip();</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        public final Buffer flip() &#123;</span></span><br><span class="line"><span class="comment">            limit = position;</span></span><br><span class="line"><span class="comment">            position = 0;</span></span><br><span class="line"><span class="comment">            mark = -1;</span></span><br><span class="line"><span class="comment">            return this;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (buffer.hasRemaining()) &#123;</span><br><span class="line">            System.out.println(buffer.get());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å››ä¸ªå±æ€§è¯´æ˜"><a href="#å››ä¸ªå±æ€§è¯´æ˜" class="headerlink" title="å››ä¸ªå±æ€§è¯´æ˜"></a>å››ä¸ªå±æ€§è¯´æ˜</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="variable">mark</span> <span class="operator">=</span> -<span class="number">1</span>;			<span class="comment">// æ ‡è®°</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="variable">position</span> <span class="operator">=</span> <span class="number">0</span>;		<span class="comment">// ä¸‹ä¸€ä¸ªè¯»å†™çš„å…ƒç´ ç´¢å¼•</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> limit;				<span class="comment">// å½“å‰ç¼“å†²åŒºçš„ç»ˆç‚¹ï¼Œä¸èƒ½å¯¹è¶…è¿‡ limit çš„ç¼“å†²åŒºè¿›è¡Œæ“ä½œ</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> capacity;			<span class="comment">// å®¹é‡ï¼Œç¼“å†²åŒºåˆ›å»ºæ—¶è®¾å®š</span></span><br></pre></td></tr></table></figure>

<h3 id="Buffer-ç±»çš„ç›¸å…³æ–¹æ³•"><a href="#Buffer-ç±»çš„ç›¸å…³æ–¹æ³•" class="headerlink" title="Buffer ç±»çš„ç›¸å…³æ–¹æ³•"></a>Buffer ç±»çš„ç›¸å…³æ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Buffer</span> &#123;</span><br><span class="line">    <span class="comment">//JDK1.4æ—¶ï¼Œå¼•å…¥çš„api</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">capacity</span><span class="params">( )</span>	<span class="comment">//è¿”å›æ­¤ç¼“å†²åŒºçš„å®¹é‡</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">position</span><span class="params">( )</span>	<span class="comment">//è¿”å›æ­¤ç¼“å†²åŒºçš„ä½ç½®</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Buffer <span class="title function_">position</span> <span class="params">(<span class="type">int</span> newPositio)</span>	<span class="comment">//è®¾ç½®æ­¤ç¼“å†²åŒºçš„ä½ç½®</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">limit</span><span class="params">( )</span>	<span class="comment">//è¿”å›æ­¤ç¼“å†²åŒºçš„é™åˆ¶</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Buffer <span class="title function_">limit</span> <span class="params">(<span class="type">int</span> newLimit)</span>	<span class="comment">//è®¾ç½®æ­¤ç¼“å†²åŒºçš„é™åˆ¶</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Buffer <span class="title function_">mark</span><span class="params">( )</span>		<span class="comment">//åœ¨æ­¤ç¼“å†²åŒºçš„ä½ç½®è®¾ç½®æ ‡è®°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Buffer <span class="title function_">reset</span><span class="params">( )</span>	<span class="comment">//å°†æ­¤ç¼“å†²åŒºçš„ä½ç½®é‡ç½®ä¸ºä»¥å‰æ ‡è®°çš„ä½ç½®</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Buffer <span class="title function_">clear</span><span class="params">( )</span>	<span class="comment">//æ¸…é™¤æ­¤ç¼“å†²åŒº, å³å°†å„ä¸ªæ ‡è®°æ¢å¤åˆ°åˆå§‹çŠ¶æ€ï¼Œä½†æ•°æ®å¹¶æ²¡æœ‰çœŸæ­£æ“¦é™¤, åé¢æ“ä½œä¼šè¦†ç›–</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Buffer <span class="title function_">flip</span><span class="params">( )</span>		<span class="comment">//åè½¬æ­¤ç¼“å†²åŒº</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Buffer <span class="title function_">rewind</span><span class="params">( )</span>	<span class="comment">//é‡ç»•æ­¤ç¼“å†²åŒº</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">remaining</span><span class="params">( )</span>	<span class="comment">//è¿”å›å½“å‰ä½ç½®ä¸é™åˆ¶ä¹‹é—´çš„å…ƒç´ æ•°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">hasRemaining</span><span class="params">( )</span>	<span class="comment">//å‘ŠçŸ¥åœ¨å½“å‰ä½ç½®å’Œé™åˆ¶ä¹‹é—´æ˜¯å¦æœ‰å…ƒç´ </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="type">boolean</span> <span class="title function_">isReadOnly</span><span class="params">( )</span>;	<span class="comment">//å‘ŠçŸ¥æ­¤ç¼“å†²åŒºæ˜¯å¦ä¸ºåªè¯»ç¼“å†²åŒº</span></span><br><span class="line">    <span class="comment">//JDK1.6æ—¶å¼•å…¥çš„api</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="type">boolean</span> <span class="title function_">hasArray</span><span class="params">()</span>;		<span class="comment">//å‘ŠçŸ¥æ­¤ç¼“å†²åŒºæ˜¯å¦å…·æœ‰å¯è®¿é—®çš„åº•å±‚å®ç°æ•°ç»„</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> Object <span class="title function_">array</span><span class="params">()</span>;			<span class="comment">//è¿”å›æ­¤ç¼“å†²åŒºçš„åº•å±‚å®ç°æ•°ç»„</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="type">int</span> <span class="title function_">arrayOffset</span><span class="params">()</span>;		<span class="comment">//è¿”å›æ­¤ç¼“å†²åŒºçš„åº•å±‚å®ç°æ•°ç»„ä¸­ç¬¬ä¸€ä¸ªç¼“å†²åŒºå…ƒç´ çš„åç§»é‡</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="type">boolean</span> <span class="title function_">isDirect</span><span class="params">()</span>;		<span class="comment">//å‘ŠçŸ¥æ­¤ç¼“å†²åŒºæ˜¯å¦ä¸ºç›´æ¥ç¼“å†²åŒº</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>flip() å’Œ clear() çš„åŒºåˆ«ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°†å„ä¸ªæ ‡è®°æ¢å¤åˆ°åˆå§‹çŠ¶æ€,ä½†æ•°æ®å¹¶æ²¡æœ‰çœŸæ­£æ“¦é™¤</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> Buffer <span class="title function_">clear</span><span class="params">()</span> &#123;</span><br><span class="line">    position = <span class="number">0</span>;</span><br><span class="line">    limit = capacity;</span><br><span class="line">    mark = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// åè½¬æ­¤ç¼“å†²åŒº</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> Buffer <span class="title function_">flip</span><span class="params">()</span> &#123;</span><br><span class="line">    limit = position;</span><br><span class="line">    position = <span class="number">0</span>;</span><br><span class="line">    mark = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ByteBuffer"><a href="#ByteBuffer" class="headerlink" title="ByteBuffer"></a>ByteBuffer</h3><p>â€‹		å¯¹äº Java ä¸­çš„åŸºæœ¬æ•°æ®ç±»å‹ï¼ˆbooleané™¤å¤–ï¼‰ï¼Œéƒ½æœ‰ä¸€ä¸ª Buffer ç±»å‹ä¸ä¹‹ç›¸å¯¹åº”ï¼Œç½‘ç»œç¼–ç¨‹ä¸­æœ€å¸¸ç”¨çš„æ˜¯ByteBuffer ç±»ï¼ˆäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œè¯¥ç±»çš„ä¸»è¦æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">ByteBuffer</span> &#123;</span><br><span class="line">    <span class="comment">//ç¼“å†²åŒºåˆ›å»ºç›¸å…³api</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ByteBuffer <span class="title function_">allocateDirect</span><span class="params">(<span class="type">int</span> capacity)</span>	<span class="comment">//åˆ›å»ºç›´æ¥ç¼“å†²åŒº</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ByteBuffer <span class="title function_">allocate</span><span class="params">(<span class="type">int</span> capacity)</span>		<span class="comment">//è®¾ç½®ç¼“å†²åŒºçš„åˆå§‹å®¹é‡</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ByteBuffer <span class="title function_">wrap</span><span class="params">(<span class="type">byte</span>[] array)</span>		<span class="comment">//æŠŠä¸€ä¸ªæ•°ç»„æ”¾åˆ°ç¼“å†²åŒºä¸­ä½¿ç”¨</span></span><br><span class="line">        </span><br><span class="line">    <span class="comment">//æ„é€ åˆå§‹åŒ–ä½ç½®offsetå’Œä¸Šç•Œlengthçš„ç¼“å†²åŒº</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ByteBuffer <span class="title function_">wrap</span><span class="params">(<span class="type">byte</span>[] array,<span class="type">int</span> offset, <span class="type">int</span> length)</span></span><br><span class="line">	</span><br><span class="line">     <span class="comment">//ç¼“å­˜åŒºå­˜å–ç›¸å…³API</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="type">byte</span> <span class="title function_">get</span><span class="params">( )</span>;		<span class="comment">//ä»å½“å‰ä½ç½®positionä¸Šgetï¼Œgetä¹‹åï¼Œpositionä¼šè‡ªåŠ¨+1</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="type">byte</span> <span class="title function_">get</span> <span class="params">(<span class="type">int</span> index)</span>;		<span class="comment">//ä»ç»å¯¹ä½ç½®get</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuffer <span class="title function_">put</span> <span class="params">(<span class="type">byte</span> b)</span>;		<span class="comment">//ä»å½“å‰ä½ç½®ä¸Šæ·»åŠ ï¼Œputä¹‹åï¼Œpositionä¼šè‡ªåŠ¨+1</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuffer <span class="title function_">put</span> <span class="params">(<span class="type">int</span> index, <span class="type">byte</span> b)</span>;		<span class="comment">//ä»ç»å¯¹ä½ç½®ä¸Šput</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h2 id="é€šé“-Channel"><a href="#é€šé“-Channel" class="headerlink" title="é€šé“ Channel"></a>é€šé“ Channel</h2><h3 id="åŸºæœ¬ä»‹ç»-3"><a href="#åŸºæœ¬ä»‹ç»-3" class="headerlink" title="åŸºæœ¬ä»‹ç»"></a>åŸºæœ¬ä»‹ç»</h3><ol>
<li><p>NIO ä¸­çš„æµå¯ä»¥å¼‚æ­¥è¯»å†™æ•°æ®ï¼Œä¸åŒäº BIO ä¸­çš„å•å‘ Streamã€‚</p>
</li>
<li><p>Channel åœ¨ NIO ä¸­æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå¸¸ç”¨çš„ Channel ç±»æœ‰ï¼š FileChannelã€DatagramChannelã€ServerSocketChannel å’Œ SocketChannelã€‚</p>
<ul>
<li><p>FileChannel ç”¨äºæ–‡ä»¶çš„æ•°æ®è¯»å†™</p>
</li>
<li><p>DatagramChannel ç”¨äº UDP çš„æ•°æ®è¯»å†™</p>
</li>
<li><p>ServerSocketChannel å’Œ SocketChannel ç”¨äº TCP çš„æ•°æ®è¯»å†™</p>
</li>
</ul>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">FileChannel</span></span><br><span class="line">    <span class="keyword">extends</span> <span class="title class_">AbstractInterruptibleChannel</span></span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">SeekableByteChannel</span>, GatheringByteChannel, ScatteringByteChannel</span><br><span class="line">&#123;</span><br></pre></td></tr></table></figure>

<p>å®ç°å­ç±»ï¼š</p>
<img src="/2023/03/24/Netty/Java\Document\Netty\Netty å‚çœ‹æ–‡æ¡£.assets\image-20220917154502387.png" alt="image-20220917154502387" style="zoom:80%;">

<h3 id="FileChannel"><a href="#FileChannel" class="headerlink" title="FileChannel"></a>FileChannel</h3><p>FileChannel ä¸»è¦å¯¹æœ¬åœ°æ–‡ä»¶è¿›è¡Œ IO æ“ä½œã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">read</span><span class="params">(ByteBuffer dst)</span> 	ä»é€šé“è¯»å–æ•°æ®å¹¶æ”¾åˆ°ç¼“å†²åŒºä¸­</span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">write</span><span class="params">(ByteBuffer src)</span> 	æŠŠç¼“å†²åŒºçš„æ•°æ®å†™åˆ°é€šé“ä¸­</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">transferFrom</span><span class="params">(ReadableByteChannel src, <span class="type">long</span> position, <span class="type">long</span> count)</span> ä»ç›®æ ‡é€šé“ä¸­å¤åˆ¶æ•°æ®åˆ°å½“å‰é€šé“ï¬ <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">transferTo</span><span class="params">(<span class="type">long</span> position, <span class="type">long</span> count, WritableByteChannel target)</span> æŠŠæ•°æ®ä»å½“å‰é€šé“å¤åˆ¶ç»™ç›®æ ‡é€šé“</span><br></pre></td></tr></table></figure>

<p>è¯»å†™æ–‡ä»¶ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.nio;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.FileChannel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileChannelDemo</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å°†æ•°æ®å†™å…¥æ–‡ä»¶</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testWrite</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;TestDir/01.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// FileChannel çš„çœŸå®ç±»å‹ä¸º FileChannelImpl</span></span><br><span class="line">        <span class="type">FileChannel</span> <span class="variable">channel</span> <span class="operator">=</span> fos.getChannel();</span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">byteBuffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">        byteBuffer.put(<span class="string">&quot;Hello ä¸–ç•Œ&quot;</span>.getBytes());</span><br><span class="line"></span><br><span class="line">        byteBuffer.flip();</span><br><span class="line">        channel.write(byteBuffer);</span><br><span class="line">        fos.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testRead</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;TestDir/01.txt&quot;</span>);</span><br><span class="line">        <span class="type">FileChannel</span> <span class="variable">channel</span> <span class="operator">=</span> fis.getChannel();</span><br><span class="line">        <span class="comment">//æ³¨æ„æ•°æ®æº¢å‡º</span></span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">byteBuffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">read</span> <span class="operator">=</span> channel.read(byteBuffer);</span><br><span class="line">        byteBuffer.flip();</span><br><span class="line">        System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(byteBuffer.array()));</span><br><span class="line">        fis.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä½¿ç”¨ä¸€ä¸ª buffer å¤åˆ¶æ–‡ä»¶</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testCopyByBuffer</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;TestDir/01.txt&quot;</span>);</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;TestDir/02.txt&quot;</span>);</span><br><span class="line">        <span class="type">FileChannel</span> <span class="variable">fisChannel</span> <span class="operator">=</span> fis.getChannel();</span><br><span class="line">        <span class="type">FileChannel</span> <span class="variable">fosChannel</span> <span class="operator">=</span> fos.getChannel();</span><br><span class="line">        <span class="type">int</span> <span class="variable">read</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">32</span>);</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="comment">// å‘ buffer ä¸­å†™å…¥æ•°æ®æ—¶ï¼Œå…ˆå°†å„ä¸ªæ ‡è¯†å½’ä½ï¼Œé˜²æ­¢è¯»å–ä¸åˆ°æ•°æ®</span></span><br><span class="line">            buffer.clear();</span><br><span class="line">            read = fisChannel.read(buffer);</span><br><span class="line">            <span class="keyword">if</span> (read != -<span class="number">1</span>) &#123;</span><br><span class="line">                buffer.flip();</span><br><span class="line">                fosChannel.write(buffer);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        fis.close();</span><br><span class="line">        fos.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä½¿ç”¨ transForm å¤åˆ¶æ–‡ä»¶</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testTransFormApi</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;TestDir/01.txt&quot;</span>);</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;TestDir/02.txt&quot;</span>);</span><br><span class="line">        <span class="type">FileChannel</span> <span class="variable">fisChannel</span> <span class="operator">=</span> fis.getChannel();</span><br><span class="line">        <span class="type">FileChannel</span> <span class="variable">fosChannel</span> <span class="operator">=</span> fos.getChannel();</span><br><span class="line">        <span class="comment">//fisChannel.transferTo(0,fisChannel.size(),fosChannel);</span></span><br><span class="line">        fosChannel.transferFrom(fisChannel, <span class="number">0</span>, fisChannel.size());</span><br><span class="line">        fis.close();</span><br><span class="line">        fos.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Buffer-å’Œ-Channel-çš„æ³¨æ„äº‹é¡¹"><a href="#Buffer-å’Œ-Channel-çš„æ³¨æ„äº‹é¡¹" class="headerlink" title="Buffer å’Œ Channel çš„æ³¨æ„äº‹é¡¹"></a>Buffer å’Œ Channel çš„æ³¨æ„äº‹é¡¹</h2><h3 id="Buffer-ç±»å‹åŒ–"><a href="#Buffer-ç±»å‹åŒ–" class="headerlink" title="Buffer ç±»å‹åŒ–"></a>Buffer ç±»å‹åŒ–</h3><p>â€‹		Buffer æ”¯æŒç±»å‹åŒ–çš„ put å’Œ getï¼Œput æ”¾å…¥çš„æ˜¯ä»€ä¹ˆæ•°æ®ç±»å‹ï¼Œget å°±åº”è¯¥ä½¿ç”¨ç›¸åº”çš„æ•°æ®ç±»å‹æ¥å–å‡ºï¼Œå¦åˆ™å¯èƒ½æœ‰ BufferUnderflowException å¼‚å¸¸ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Buffer ç±»å‹åŒ–ï¼šæ”¾å…¥æ—¶æ˜¯ä»€ä¹ˆç±»å‹ï¼Œå–å‡ºæ—¶ä¹Ÿåº”è¯¥æŒ‰ç…§ä»€ä¹ˆç±»å‹</span></span><br><span class="line"><span class="comment"> * put()</span></span><br><span class="line"><span class="comment"> * putInt()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testBufferType</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">4</span>);</span><br><span class="line">    buffer.putInt(<span class="number">10</span>);</span><br><span class="line">    buffer.putLong(<span class="number">10L</span>);</span><br><span class="line">    buffer.putChar(<span class="string">&#x27;A&#x27;</span>);</span><br><span class="line">    buffer.putShort((<span class="type">short</span>) <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    buffer.flip();</span><br><span class="line">    <span class="comment">// java.nio.BufferOverflowException</span></span><br><span class="line">    buffer.getChar();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Buffer-åªè¯»"><a href="#Buffer-åªè¯»" class="headerlink" title="Buffer åªè¯»"></a>Buffer åªè¯»</h3><p>â€‹		åªè¯» bufferï¼Œè¿”å›çš„ buffer åªè¯»ï¼ŒByteBuffer readOnlyBuffer &#x3D; buffer.asReadOnlyBuffer();</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * åªè¯»Buffer</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testReadOnlyBuffer</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">2</span>);</span><br><span class="line">       buffer.put((<span class="type">byte</span>) <span class="number">10</span>);</span><br><span class="line">       buffer.flip();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// è¿”å›çš„ buffer åªè¯»</span></span><br><span class="line">       <span class="type">ByteBuffer</span> <span class="variable">readOnlyBuffer</span> <span class="operator">=</span> buffer.asReadOnlyBuffer();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// java.nio.ReadOnlyBufferException</span></span><br><span class="line">       readOnlyBuffer.put((<span class="type">byte</span>) <span class="number">12</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="MappedByteBuffer"><a href="#MappedByteBuffer" class="headerlink" title="MappedByteBuffer"></a>MappedByteBuffer</h3><p>â€‹		MappedByteBufferï¼Œå¯ä»¥è®©æ–‡ä»¶ç›´æ¥åœ¨å†…å­˜ï¼ˆå †å¤–çš„å†…å­˜ï¼‰ä¸­è¿›è¡Œä¿®æ”¹ï¼Œè€Œå¦‚ä½•åŒæ­¥åˆ°æ–‡ä»¶ç”±NIO æ¥å®Œæˆã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æµ‹è¯• MappedByteBuffer</span></span><br><span class="line"><span class="comment"> * å¯ä»¥è®©æ–‡ä»¶ç›´æ¥åœ¨å†…å­˜ï¼ˆå †å¤–çš„å†…å­˜ï¼‰ä¸­è¿›è¡Œä¿®æ”¹ï¼Œè€Œå¦‚ä½•åŒæ­¥åˆ°æ–‡ä»¶ç”± NIOæ¥å®Œæˆã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testMappedByteBuffer</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">RandomAccessFile</span> <span class="variable">rw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(<span class="string">&quot;TestDir/01.txt&quot;</span>, <span class="string">&quot;rw&quot;</span>);</span><br><span class="line">    <span class="type">FileChannel</span> <span class="variable">channel</span> <span class="operator">=</span> rw.getChannel();</span><br><span class="line">    <span class="comment">// map(æ¨¡å¼,position,size)</span></span><br><span class="line">    <span class="type">MappedByteBuffer</span> <span class="variable">mappedByteBuffer</span> <span class="operator">=</span> channel.map(FileChannel.MapMode.READ_WRITE, <span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line">    mappedByteBuffer.put(<span class="number">0</span>, (<span class="type">byte</span>) <span class="string">&#x27;M&#x27;</span>);</span><br><span class="line">    mappedByteBuffer.put(<span class="number">2</span>, (<span class="type">byte</span>) <span class="string">&#x27;T&#x27;</span>);</span><br><span class="line">    <span class="comment">// java.lang.IndexOutOfBoundsException</span></span><br><span class="line">    <span class="comment">// mappedByteBuffer.put(3, (byte) &#x27;M&#x27;);</span></span><br><span class="line">    rw.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Scattering-Gathering"><a href="#Scattering-Gathering" class="headerlink" title="Scattering Gathering"></a>Scattering Gathering</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æµ‹è¯•ScatteringAndGathering</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">ServerSocketChannel</span> <span class="variable">serverSocketChannel</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line">    serverSocketChannel.socket().bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">8000</span>));</span><br><span class="line"></span><br><span class="line">    ByteBuffer[] byteBuffers = <span class="keyword">new</span> <span class="title class_">ByteBuffer</span>[<span class="number">2</span>];</span><br><span class="line">    byteBuffers[<span class="number">0</span>] = ByteBuffer.allocate(<span class="number">5</span>);</span><br><span class="line">    byteBuffers[<span class="number">1</span>] = ByteBuffer.allocate(<span class="number">3</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥...&quot;</span>);</span><br><span class="line">    <span class="type">SocketChannel</span> <span class="variable">socketChannel</span> <span class="operator">=</span> serverSocketChannel.accept();</span><br><span class="line">    <span class="comment">// å›ºå®šä»å®¢æˆ·ç«¯æ¥æ”¶ 8 ä¸ªå­—èŠ‚</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">maxLength</span> <span class="operator">=</span> <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">readLength</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (readLength &lt; maxLength) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;ç­‰å¾…å®¢æˆ·ç«¯å‘é€æ•°æ®...&quot;</span>);</span><br><span class="line">            <span class="type">long</span> <span class="variable">read</span> <span class="operator">=</span> socketChannel.read(byteBuffers);</span><br><span class="line">            readLength += read;</span><br><span class="line">            System.out.println(<span class="string">&quot;read: &quot;</span> + readLength);</span><br><span class="line">            Arrays.stream(byteBuffers).map(buffer -&gt; <span class="string">&quot;position: &quot;</span> + buffer.position() +</span><br><span class="line">                    <span class="string">&quot;, limit: &quot;</span> + buffer.limit()).forEach(System.out::println);</span><br><span class="line">        &#125;</span><br><span class="line">        Arrays.stream(byteBuffers).forEach(Buffer::flip);</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">writeLength</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (writeLength &lt; maxLength) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">write</span> <span class="operator">=</span> socketChannel.write(byteBuffers);</span><br><span class="line">            writeLength += write;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Arrays.stream(byteBuffers).forEach(Buffer::clear);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;readLength = &quot;</span> + readLength + <span class="string">&quot;, writeLength =&quot;</span> + writeLength +</span><br><span class="line">                <span class="string">&quot;, maxLength = &quot;</span> + maxLength);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="é€‰æ‹©å™¨-Selector"><a href="#é€‰æ‹©å™¨-Selector" class="headerlink" title="é€‰æ‹©å™¨ Selector"></a>é€‰æ‹©å™¨ Selector</h2><h3 id="Selector-åŸºæœ¬ä»‹ç»"><a href="#Selector-åŸºæœ¬ä»‹ç»" class="headerlink" title="Selector åŸºæœ¬ä»‹ç»"></a>Selector åŸºæœ¬ä»‹ç»</h3><ol>
<li><p>Java çš„ NIOï¼Œç”¨éé˜»å¡çš„ IO æ–¹å¼ã€‚å¯ä»¥ç”¨ä¸€ä¸ªçº¿ç¨‹ï¼Œå¤„ç†å¤šä¸ªçš„å®¢æˆ·ç«¯è¿æ¥ï¼Œå°±ä¼šä½¿ç”¨åˆ° Selectorï¼ˆé€‰æ‹©å™¨ï¼‰ã€‚</p>
</li>
<li><p>Selector èƒ½å¤Ÿæ£€æµ‹å¤šä¸ªæ³¨å†Œçš„é€šé“ä¸Šæ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿï¼Œå¦‚æœæœ‰äº‹ä»¶å‘ç”Ÿï¼Œå†é’ˆå¯¹æ¯ä¸ªäº‹ä»¶è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚è¿™æ ·å°±å¯ä»¥åªç”¨ä¸€ä¸ªå•çº¿ç¨‹å»ç®¡ç†å¤šä¸ªé€šé“ï¼ˆè¿æ¥ï¼‰ã€‚</p>
</li>
<li><p>åªæœ‰åœ¨è¿æ¥&#x2F;é€šé“ çœŸæ­£æœ‰è¯»å†™äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œæ‰ä¼šè¿›è¡Œè¯»å†™ï¼Œå°±å¤§å¤§åœ°å‡å°‘äº†ç³»ç»Ÿå¼€é”€ï¼Œå¹¶ä¸”ä¸å¿…ä¸ºæ¯ä¸ªè¿æ¥éƒ½åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œé¿å…äº†å¤šçº¿ç¨‹ä¹‹é—´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¯¼è‡´çš„å¼€é”€ã€‚</p>
</li>
</ol>
<h3 id="ç¤ºæ„å›¾"><a href="#ç¤ºæ„å›¾" class="headerlink" title="ç¤ºæ„å›¾"></a>ç¤ºæ„å›¾</h3><h3 id="ç‰¹ç‚¹è¯´æ˜"><a href="#ç‰¹ç‚¹è¯´æ˜" class="headerlink" title="ç‰¹ç‚¹è¯´æ˜"></a>ç‰¹ç‚¹è¯´æ˜</h3><ol>
<li><p>Netty çš„ IO çº¿ç¨‹ NioEventLoop èšåˆäº† Selector(é€‰æ‹©å™¨ï¼Œä¹Ÿå«å¤šè·¯å¤ç”¨å™¨)ï¼Œå¯ä»¥åŒæ—¶å¹¶å‘å¤„ç†æˆç™¾ä¸Šåƒä¸ªå®¢æˆ·ç«¯è¿æ¥ã€‚</p>
</li>
<li><p>å½“çº¿ç¨‹ä»æŸå®¢æˆ·ç«¯ Socket é€šé“è¿›è¡Œè¯»å†™æ•°æ®æ—¶ï¼Œè‹¥æ²¡æœ‰æ•°æ®å¯ç”¨æ—¶ï¼Œè¯¥çº¿ç¨‹å¯ä»¥è¿›è¡Œå…¶ä»–ä»»åŠ¡ã€‚</p>
</li>
<li><p>çº¿ç¨‹é€šå¸¸å°†éé˜»å¡ IO çš„ç©ºé—²æ—¶é—´ç”¨äºåœ¨å…¶ä»–é€šé“ä¸Šæ‰§è¡Œ IO æ“ä½œï¼Œæ‰€ä»¥å•ç‹¬çš„çº¿ç¨‹å¯ä»¥ç®¡ç†å¤šä¸ªè¾“å…¥å’Œè¾“å‡ºé€šé“ã€‚</p>
</li>
<li><p>ç”±äºè¯»å†™æ“ä½œéƒ½æ˜¯éé˜»å¡çš„ï¼Œè¿™å°±å¯ä»¥å……åˆ†æå‡ IO çº¿ç¨‹çš„è¿è¡Œæ•ˆç‡ï¼Œé¿å…ç”±äºé¢‘ç¹ I&#x2F;O é˜»å¡å¯¼è‡´çš„çº¿ç¨‹æŒ‚èµ·ã€‚</p>
</li>
<li><p>ä¸€ä¸ª I&#x2F;O çº¿ç¨‹å¯ä»¥å¹¶å‘å¤„ç† N ä¸ªå®¢æˆ·ç«¯è¿æ¥å’Œè¯»å†™æ“ä½œï¼Œè¿™ä»æ ¹æœ¬ä¸Šè§£å†³äº†ä¼ ç»ŸåŒæ­¥é˜»å¡ I&#x2F;O ä¸€è¿æ¥ä¸€çº¿ç¨‹æ¨¡å‹ï¼Œæ¶æ„çš„æ€§èƒ½ã€å¼¹æ€§		ä¼¸ç¼©èƒ½åŠ›å’Œå¯é æ€§éƒ½å¾—åˆ°äº†æå¤§çš„æå‡ã€‚</p>
</li>
</ol>
<h3 id="Selector-ç±»çš„ç›¸å…³æ–¹æ³•"><a href="#Selector-ç±»çš„ç›¸å…³æ–¹æ³•" class="headerlink" title="Selector ç±»çš„ç›¸å…³æ–¹æ³•"></a>Selector ç±»çš„ç›¸å…³æ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Selector</span> <span class="keyword">implements</span> <span class="title class_">Closeable</span> &#123; </span><br><span class="line">	<span class="comment">// å¾—åˆ°ä¸€ä¸ªé€‰æ‹©å™¨å¯¹è±¡</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> Selector <span class="title function_">open</span><span class="params">()</span>;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// ç›‘æ§æ‰€æœ‰æ³¨å†Œçš„é€šé“ï¼Œå½“å…¶ä¸­æœ‰ IO æ“ä½œå¯ä»¥è¿›è¡Œæ—¶ï¼Œå°†å¯¹åº”çš„ SelectionKey åŠ å…¥åˆ°å†…éƒ¨é›†åˆä¸­å¹¶è¿”å›ï¼Œå‚æ•°ç”¨æ¥è®¾ç½®è¶…æ—¶æ—¶é—´</span></span><br><span class="line">	<span class="keyword">public</span> <span class="type">int</span> <span class="title function_">select</span><span class="params">(<span class="type">long</span> timeout)</span>;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// ä»å†…éƒ¨é›†åˆä¸­å¾—åˆ°æ‰€æœ‰çš„ SelectionKey</span></span><br><span class="line">	<span class="keyword">public</span> Set&lt;SelectionKey&gt; <span class="title function_">selectedKeys</span><span class="params">()</span>;</span><br><span class="line">    </span><br><span class="line">    selector.select()		<span class="comment">// é˜»å¡</span></span><br><span class="line">	selector.select(<span class="number">1000</span>);	<span class="comment">// é˜»å¡1000æ¯«ç§’ï¼Œåœ¨1000æ¯«ç§’åè¿”å›</span></span><br><span class="line">	selector.wakeup();		<span class="comment">// å”¤é†’selector</span></span><br><span class="line">	selector.selectNow();	<span class="comment">// ä¸é˜»å¡ï¼Œç«‹é©¬è¿”è¿˜</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="NIO-éé˜»å¡-ç½‘ç»œç¼–ç¨‹åŸç†åˆ†æå›¾"><a href="#NIO-éé˜»å¡-ç½‘ç»œç¼–ç¨‹åŸç†åˆ†æå›¾" class="headerlink" title="NIO éé˜»å¡ ç½‘ç»œç¼–ç¨‹åŸç†åˆ†æå›¾"></a>NIO éé˜»å¡ ç½‘ç»œç¼–ç¨‹åŸç†åˆ†æå›¾</h3><p><strong>å¯¹è¯¥å›¾çš„è¯´æ˜</strong></p>
<ol>
<li><p>å½“å®¢æˆ·ç«¯è¿æ¥æ—¶ï¼Œä¼šé€šè¿‡ServerSocketChannel å¾—åˆ° SocketChannelã€‚</p>
</li>
<li><p>Selector è¿›è¡Œç›‘å¬ select æ–¹æ³•, è¿”å›æœ‰äº‹ä»¶å‘ç”Ÿçš„é€šé“çš„ä¸ªæ•°ã€‚</p>
</li>
<li><p>å°†socketChannelæ³¨å†Œåˆ°Selectorä¸Š, register(Selector sel, int ops), ä¸€ä¸ªselectorä¸Šå¯ä»¥æ³¨å†Œå¤šä¸ªSocketChannelã€‚</p>
</li>
<li><p>æ³¨å†Œåè¿”å›ä¸€ä¸ª SelectionKey, ä¼šå’Œè¯¥Selector å…³è”(é›†åˆ)ã€‚</p>
</li>
<li><p>è¿›ä¸€æ­¥å¾—åˆ°å„ä¸ª SelectionKey (æœ‰äº‹ä»¶å‘ç”Ÿ)ã€‚</p>
</li>
<li><p>åœ¨é€šè¿‡ SelectionKeyåå‘è·å– SocketChannel , æ–¹æ³• channel()ã€‚</p>
</li>
<li><p>å¯ä»¥é€šè¿‡å¾—åˆ°çš„ channel , å®Œæˆä¸šåŠ¡å¤„ç†ã€‚</p>
</li>
</ol>
<h3 id="ä½¿ç”¨ç¤ºä¾‹-1"><a href="#ä½¿ç”¨ç¤ºä¾‹-1" class="headerlink" title="ä½¿ç”¨ç¤ºä¾‹"></a>ä½¿ç”¨ç¤ºä¾‹</h3><p>ç¨‹åºåŠŸèƒ½ï¼šé€šè¿‡ NIO å®ç°æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯ä¹‹é—´çš„æ•°æ®ç®€å•é€šè®¯ã€‚</p>
<p>NIOServerï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.nio;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NIOServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»º ServerScoketChannelå¯¹è±¡å¹¶ç»‘å®šç«¯å£</span></span><br><span class="line">        <span class="type">ServerSocketChannel</span> <span class="variable">serverSocketChannel</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line">        serverSocketChannel.socket().bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">8000</span>));</span><br><span class="line">        <span class="comment">// åˆ›å»º Selector å¯¹è±¡</span></span><br><span class="line">        <span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> Selector.open();</span><br><span class="line">        <span class="comment">// è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼</span></span><br><span class="line">        serverSocketChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">        <span class="comment">// å°† serverSocketChannel æ³¨å†Œåˆ° Selector,å…³å¿ƒäº‹ä»¶ä¸ºç›‘å¬</span></span><br><span class="line">        serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (selector.select(<span class="number">3000</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœç­‰å¾… 1 ç§’æ²¡æœ‰äº‹ä»¶å‘ç”Ÿ</span></span><br><span class="line">                System.out.println(<span class="string">&quot;Server Waiting 3s...&quot;</span>);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Set&lt;SelectionKey&gt; selectionKeys = selector.selectedKeys();</span><br><span class="line">            System.out.println(<span class="string">&quot;SelectionKeys Nums: &quot;</span> + selector.keys().size());</span><br><span class="line">            Iterator&lt;SelectionKey&gt; iterator = selectionKeys.iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">                <span class="comment">// æ ¹æ®äº‹ä»¶ç±»å‹ä½œç›¸åº”å¤„ç†</span></span><br><span class="line">                <span class="keyword">if</span> (key.isAcceptable()) &#123;</span><br><span class="line">                    <span class="type">SocketChannel</span> <span class="variable">socketChannel</span> <span class="operator">=</span> serverSocketChannel.accept();</span><br><span class="line">                    System.out.println(<span class="string">&quot;å®¢æˆ·ç«¯è¿æ¥æˆåŠŸ,ç”ŸæˆSocketChannel, hashCode: &quot;</span> +</span><br><span class="line">                            socketChannel.hashCode());</span><br><span class="line">                    </span><br><span class="line">                    socketChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">                    <span class="comment">// å…³è”ä¸€ä¸ª buffer</span></span><br><span class="line">                    socketChannel.register(selector, SelectionKey.OP_READ, ByteBuffer.allocate(<span class="number">1024</span>));</span><br><span class="line">                    System.out.println(<span class="string">&quot;å®¢æˆ·ç«¯è¿æ¥æˆåŠŸå, SelectionKeys æ•°é‡: &quot;</span> + selector.keys().size());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (key.isReadable()) &#123;</span><br><span class="line">                    <span class="type">SocketChannel</span> <span class="variable">channel</span> <span class="operator">=</span> (SocketChannel) key.channel();</span><br><span class="line">                    <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> (ByteBuffer) key.attachment();</span><br><span class="line">                    channel.read(buffer);</span><br><span class="line">                    System.out.println(<span class="string">&quot;å®¢æˆ·ç«¯å‘é€çš„æ•°æ®: &quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(buffer.array()));</span><br><span class="line">                &#125;</span><br><span class="line">				<span class="comment">// ç§»é™¤SelectionKey, é˜²æ­¢å¤šçº¿ç¨‹ç¯å¢ƒä¸‹,å¯¹ key é‡å¤æ“ä½œ</span></span><br><span class="line">                iterator.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NIOClientï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.nio;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SocketChannel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NIOClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">SocketChannel</span> <span class="variable">socketChannel</span> <span class="operator">=</span> SocketChannel.open();</span><br><span class="line">        socketChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">        <span class="type">InetSocketAddress</span> <span class="variable">inetSocketAddress</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8000</span>);</span><br><span class="line">        <span class="keyword">if</span> (!socketChannel.connect(inetSocketAddress)) &#123;</span><br><span class="line">            <span class="keyword">while</span> (!socketChannel.finishConnect()) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;è¿æ¥éœ€è¦æ—¶é—´ï¼Œå®¢æˆ·ç«¯ä¸ä¼šé˜»å¡ï¼Œå¯ä»¥åšå…¶å®ƒå·¥ä½œ...&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//è¿æ¥æˆåŠŸ,å‘é€æ•°æ®</span></span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.wrap(<span class="string">&quot;Hello NIOServer&quot;</span>.getBytes());</span><br><span class="line">        socketChannel.write(buffer);</span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Selectorç›¸å…³API"><a href="#Selectorç›¸å…³API" class="headerlink" title="Selectorç›¸å…³API"></a>Selectorç›¸å…³API</h3><h4 id="SelectionKey"><a href="#SelectionKey" class="headerlink" title="SelectionKey"></a>SelectionKey</h4><p>SelectionKeyï¼Œè¡¨ç¤º Selector å’Œç½‘ç»œé€šé“çš„æ³¨å†Œå…³ç³», å…±å››ç§:</p>
<p>int OP_ACCEPTï¼šæœ‰æ–°çš„ç½‘ç»œè¿æ¥å¯ä»¥ acceptï¼Œå€¼ä¸º 16</p>
<p>int OP_CONNECTï¼šä»£è¡¨è¿æ¥å·²ç»å»ºç«‹ï¼Œå€¼ä¸º 8</p>
<p>int OP_READï¼šä»£è¡¨è¯»æ“ä½œï¼Œå€¼ä¸º 1 </p>
<p>int OP_WRITEï¼šä»£è¡¨å†™æ“ä½œï¼Œå€¼ä¸º 4</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">OP_READ</span> <span class="operator">=</span> <span class="number">1</span> &lt;&lt; <span class="number">0</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">OP_WRITE</span> <span class="operator">=</span> <span class="number">1</span> &lt;&lt; <span class="number">2</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">OP_CONNECT</span> <span class="operator">=</span> <span class="number">1</span> &lt;&lt; <span class="number">3</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">OP_ACCEPT</span> <span class="operator">=</span> <span class="number">1</span> &lt;&lt; <span class="number">4</span>;</span><br></pre></td></tr></table></figure>

<h4 id="SelectionKey-1"><a href="#SelectionKey-1" class="headerlink" title="SelectionKey"></a>SelectionKey</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">SelectionKey</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">abstract</span> Selector <span class="title function_">selector</span><span class="params">()</span>;	<span class="comment">//å¾—åˆ°ä¸ä¹‹å…³è”çš„ Selector å¯¹è±¡</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">abstract</span> SelectableChannel <span class="title function_">channel</span><span class="params">()</span>;	<span class="comment">//å¾—åˆ°ä¸ä¹‹å…³è”çš„é€šé“</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title function_">attachment</span><span class="params">()</span>;	<span class="comment">//å¾—åˆ°ä¸ä¹‹å…³è”çš„å…±äº«æ•°æ®</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">abstract</span> SelectionKey <span class="title function_">interestOps</span><span class="params">(<span class="type">int</span> ops)</span>;	<span class="comment">//è®¾ç½®æˆ–æ”¹å˜ç›‘å¬äº‹ä»¶</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">isAcceptable</span><span class="params">()</span>;	<span class="comment">//æ˜¯å¦å¯ä»¥ accept</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">isReadable</span><span class="params">()</span>;	<span class="comment">//æ˜¯å¦å¯ä»¥è¯»</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">isWritable</span><span class="params">()</span>;	<span class="comment">//æ˜¯å¦å¯ä»¥å†™</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">cancel</span><span class="params">()</span>;		<span class="comment">//å–æ¶ˆæ³¨å†Œ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ServerSocketChannel"><a href="#ServerSocketChannel" class="headerlink" title="ServerSocketChannel"></a>ServerSocketChannel</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">ServerSocketChannel</span> <span class="keyword">extends</span> <span class="title class_">AbstractSelectableChannel</span> <span class="keyword">implements</span> <span class="title class_">NetworkChannel</span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> ServerSocketChannel <span class="title function_">open</span><span class="params">()</span>	<span class="comment">// å¾—åˆ°ä¸€ä¸ª ServerSocketChannel é€šé“</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">final</span> ServerSocketChannel <span class="title function_">bind</span><span class="params">(SocketAddress local)</span>	<span class="comment">// è®¾ç½®æœåŠ¡å™¨ç«¯ç«¯å£å·</span></span><br><span class="line">    <span class="comment">// è®¾ç½®é˜»å¡æˆ–éé˜»å¡æ¨¡å¼ï¼Œå–å€¼ false è¡¨ç¤ºé‡‡ç”¨éé˜»å¡æ¨¡å¼</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">final</span> SelectableChannel <span class="title function_">configureBlocking</span><span class="params">(<span class="type">boolean</span> block)</span>	</span><br><span class="line">	<span class="keyword">public</span> SocketChannel <span class="title function_">accept</span><span class="params">()</span>	<span class="comment">// æ¥å—ä¸€ä¸ªè¿æ¥ï¼Œè¿”å›ä»£è¡¨è¿™ä¸ªè¿æ¥çš„é€šé“å¯¹è±¡</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">final</span> SelectionKey <span class="title function_">register</span><span class="params">(Selector sel, <span class="type">int</span> ops)</span><span class="comment">// æ³¨å†Œä¸€ä¸ªé€‰æ‹©å™¨å¹¶è®¾ç½®ç›‘å¬äº‹ä»¶</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="SocketChannel"><a href="#SocketChannel" class="headerlink" title="SocketChannel"></a>SocketChannel</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">SocketChannel</span> <span class="keyword">extends</span> <span class="title class_">AbstractSelectableChannel</span> <span class="keyword">implements</span> <span class="title class_">ByteChannel</span>, ScatteringByteChannel, GatheringByteChannel, NetworkChannel&#123;</span><br><span class="line">	<span class="comment">// å¾—åˆ°ä¸€ä¸ª SocketChannel é€šé“</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> SocketChannel <span class="title function_">open</span><span class="params">()</span>;</span><br><span class="line">	<span class="comment">// è®¾ç½®é˜»å¡æˆ–éé˜»å¡æ¨¡å¼ï¼Œå–å€¼ false è¡¨ç¤ºé‡‡ç”¨éé˜»å¡æ¨¡å¼</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">final</span> SelectableChannel <span class="title function_">configureBlocking</span><span class="params">(<span class="type">boolean</span> block)</span>;</span><br><span class="line">	<span class="comment">// è¿æ¥æœåŠ¡å™¨</span></span><br><span class="line">	<span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">connect</span><span class="params">(SocketAddress remote)</span>;</span><br><span class="line">	<span class="comment">// å¦‚æœä¸Šé¢çš„æ–¹æ³•è¿æ¥å¤±è´¥ï¼Œæ¥ä¸‹æ¥å°±è¦é€šè¿‡è¯¥æ–¹æ³•å®Œæˆè¿æ¥æ“ä½œ</span></span><br><span class="line">	<span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">finishConnect</span><span class="params">()</span>;</span><br><span class="line">	<span class="comment">// å¾€é€šé“é‡Œå†™æ•°æ®</span></span><br><span class="line">	<span class="keyword">public</span> <span class="type">int</span> <span class="title function_">write</span><span class="params">(ByteBuffer src)</span>;</span><br><span class="line">	<span class="comment">// ä»é€šé“é‡Œè¯»æ•°æ®</span></span><br><span class="line">	<span class="keyword">public</span> <span class="type">int</span> <span class="title function_">read</span><span class="params">(ByteBuffer dst)</span>;</span><br><span class="line">	<span class="comment">// æ³¨å†Œä¸€ä¸ªé€‰æ‹©å™¨å¹¶è®¾ç½®ç›‘å¬äº‹ä»¶ï¼Œæœ€åä¸€ä¸ªå‚æ•°å¯ä»¥è®¾ç½®å…±äº«æ•°æ®</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">final</span> SelectionKey <span class="title function_">register</span><span class="params">(Selector sel, <span class="type">int</span> ops, Object att)</span>;</span><br><span class="line">	<span class="comment">// å…³é—­é€šé“</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="NIO-ç½‘ç»œç¼–ç¨‹ï¼šç¾¤èŠ"><a href="#NIO-ç½‘ç»œç¼–ç¨‹ï¼šç¾¤èŠ" class="headerlink" title="NIO ç½‘ç»œç¼–ç¨‹ï¼šç¾¤èŠ"></a>NIO ç½‘ç»œç¼–ç¨‹ï¼šç¾¤èŠ</h3><p>ç¨‹åºè¦æ±‚ï¼šå®ç°å¤šäººç¾¤èŠ</p>
<p>â€‹		æœåŠ¡å™¨ç«¯ï¼šç›‘æµ‹ç”¨æˆ·ä¸Šçº¿ï¼Œç¦»çº¿ï¼Œå¹¶å®ç°æ¶ˆæ¯è½¬å‘åŠŸèƒ½</p>
<p>â€‹		å®¢æˆ·ç«¯ï¼š é€šè¿‡channel å¯ä»¥æ— é˜»å¡å‘é€æ¶ˆæ¯ç»™å…¶å®ƒæ‰€æœ‰ç”¨æˆ·ï¼ŒåŒæ—¶å¯ä»¥æ¥å—å…¶å®ƒç”¨æˆ·æ¶ˆæ¯</p>
<p>æœåŠ¡å™¨ç«¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.nio;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç¾¤èŠæœåŠ¡ç«¯</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GroupChatServer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PORT</span> <span class="operator">=</span> <span class="number">8000</span>;</span><br><span class="line">    <span class="keyword">private</span> Selector selector;</span><br><span class="line">    <span class="keyword">private</span> ServerSocketChannel serverSocketChannel;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GroupChatServer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            serverSocketChannel = ServerSocketChannel.open();</span><br><span class="line">            serverSocketChannel.socket().bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(PORT));</span><br><span class="line">            serverSocketChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">            selector = Selector.open();</span><br><span class="line">            serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line">            listen();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">listen</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;listen thread: &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (selector.select() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    Iterator&lt;SelectionKey&gt; iterator = selector.selectedKeys().iterator();</span><br><span class="line">                    <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                        <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">                        <span class="keyword">if</span> (key.isAcceptable()) &#123;</span><br><span class="line">                            <span class="type">SocketChannel</span> <span class="variable">socketChannel</span> <span class="operator">=</span> serverSocketChannel.accept();</span><br><span class="line">                            socketChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">                            socketChannel.register(selector, SelectionKey.OP_READ);</span><br><span class="line">                            System.out.println(socketChannel.getRemoteAddress() + <span class="string">&quot;: ä¸Šçº¿...&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (key.isReadable()) &#123;</span><br><span class="line">                            readData(key);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//å½“å‰é€šé“å¤„ç†å®Œæˆ,ç§»é™¤,é˜²æ­¢å¤šçº¿ç¨‹ç¯å¢ƒä¸‹é‡å¤æ“ä½œ</span></span><br><span class="line">                        iterator.remove();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readData</span><span class="params">(SelectionKey key)</span> &#123;</span><br><span class="line">        <span class="type">SocketChannel</span> <span class="variable">channel</span> <span class="operator">=</span> (SocketChannel) key.channel();</span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">        <span class="comment">// æ­¤å¤„ åº”è¯¥å‘ buffer å¾ªç¯è¯»å–æ•°æ®</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> channel.read(buffer);</span><br><span class="line">            <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(buffer.array());</span><br><span class="line">                System.out.println(channel.getRemoteAddress() + <span class="string">&quot; å‘é€æ¶ˆæ¯: &quot;</span> + message);</span><br><span class="line">                forwardToOthers(message, channel);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;ç¦»çº¿å¼‚å¸¸: &quot;</span> + e.getMessage());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(channel.getRemoteAddress() + <span class="string">&quot;: ç¦»çº¿äº†...&quot;</span>);</span><br><span class="line">                key.cancel();</span><br><span class="line">                channel.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">                ex.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">forwardToOthers</span><span class="params">(String message, SocketChannel self)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æœåŠ¡å™¨è½¬å‘æ¶ˆæ¯ä¸­...&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (SelectionKey key : selector.keys()) &#123;</span><br><span class="line">            <span class="type">SelectableChannel</span> <span class="variable">channel</span> <span class="operator">=</span> key.channel();</span><br><span class="line">            <span class="keyword">if</span> (channel <span class="keyword">instanceof</span> SocketChannel &amp;&amp; channel != self) &#123;</span><br><span class="line">                <span class="type">SocketChannel</span> <span class="variable">dest</span> <span class="operator">=</span> (SocketChannel) channel;</span><br><span class="line">                <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.wrap(message.getBytes());</span><br><span class="line">                dest.write(buffer);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">GroupChatServer</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®¢æˆ·ç«¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.nio;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SelectionKey;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.Selector;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç¾¤èŠå®¢æˆ·ç«¯</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GroupChatClient</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">IP</span> <span class="operator">=</span> <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PORT</span> <span class="operator">=</span> <span class="number">8000</span>;</span><br><span class="line">    <span class="keyword">private</span> Selector selector;</span><br><span class="line">    <span class="keyword">private</span> SocketChannel socketChannel;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GroupChatClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            selector = Selector.open();</span><br><span class="line">            socketChannel = SocketChannel.open(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(IP, PORT));</span><br><span class="line">            socketChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">            socketChannel.register(selector, SelectionKey.OP_READ);</span><br><span class="line">            System.out.println(socketChannel.getLocalAddress().toString());</span><br><span class="line">            username = socketChannel.getLocalAddress().toString().substring(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendInfo</span><span class="params">(String info)</span> &#123;</span><br><span class="line">        info = username + <span class="string">&quot; : &quot;</span> + info;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            socketChannel.write(ByteBuffer.wrap(info.getBytes()));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> selector.select();</span><br><span class="line">            <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                Iterator&lt;SelectionKey&gt; iterator = selector.selectedKeys().iterator();</span><br><span class="line">                <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                    <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">                    <span class="keyword">if</span> (key.isReadable()) &#123;</span><br><span class="line">                        <span class="type">SocketChannel</span> <span class="variable">channel</span> <span class="operator">=</span> (SocketChannel) key.channel();</span><br><span class="line">                        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">                        channel.read(buffer);</span><br><span class="line">                        System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(buffer.array()).trim());</span><br><span class="line">                    &#125;</span><br><span class="line">                    iterator.remove();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">GroupChatClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GroupChatClient</span>();</span><br><span class="line">        <span class="comment">// å¯åŠ¨çº¿ç¨‹è¯»å–æœåŠ¡å™¨å‘é€çš„æ•°æ®</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    client.receiveInfo();</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">        <span class="keyword">while</span> (scanner.hasNextLine()) &#123;</span><br><span class="line">            client.sendInfo(scanner.nextLine());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="é›¶æ‹·è´ï¼ˆç•¥ï¼‰"><a href="#é›¶æ‹·è´ï¼ˆç•¥ï¼‰" class="headerlink" title="é›¶æ‹·è´ï¼ˆç•¥ï¼‰"></a>é›¶æ‹·è´ï¼ˆç•¥ï¼‰</h2><p>â€‹		åœ¨ Java ç¨‹åºä¸­ï¼Œå¸¸ç”¨çš„é›¶æ‹·è´æœ‰ mmap(å†…å­˜æ˜ å°„) å’Œ sendFileã€‚</p>
<p>ä¼ ç»Ÿçš„ IO æ•°æ®è¯»å†™ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;test.txt&quot;</span>);</span><br><span class="line"><span class="type">RandomAccessFile</span> <span class="variable">raf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(file,<span class="string">&quot;rw&quot;</span>);</span><br><span class="line"><span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">bytes</span>[(<span class="type">int</span>)file.length()];</span><br><span class="line">raf.read(bytes);</span><br><span class="line"><span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(<span class="number">8000</span>).accept();</span><br><span class="line">socket.getOutputStream().write(bytes);</span><br></pre></td></tr></table></figure>

<h3 id="mmap-ä¼˜åŒ–"><a href="#mmap-ä¼˜åŒ–" class="headerlink" title="mmap ä¼˜åŒ–"></a>mmap ä¼˜åŒ–</h3><p>â€‹		mmap é€šè¿‡å†…å­˜æ˜ å°„ï¼Œå°†æ–‡ä»¶æ˜ å°„åˆ°å†…æ ¸ç¼“å†²åŒºï¼ŒåŒæ—¶ï¼Œç”¨æˆ·ç©ºé—´å¯ä»¥å…±äº«å†…æ ¸ç©ºé—´çš„æ•°æ®ã€‚è¿™æ ·ï¼Œåœ¨è¿›è¡Œç½‘ç»œä¼ è¾“æ—¶ï¼Œå°±å¯ä»¥å‡å°‘å†…æ ¸ç©ºé—´åˆ°ç”¨æˆ·æ§ä»¶çš„æ‹·è´æ¬¡æ•°ã€‚å¦‚ä¸‹å›¾</p>
<p>mmapç¤ºæ„å›¾</p>
<h3 id="sendFile-ä¼˜åŒ–"><a href="#sendFile-ä¼˜åŒ–" class="headerlink" title="sendFile ä¼˜åŒ–"></a>sendFile ä¼˜åŒ–</h3><p>Linux 2.1 ç‰ˆæœ¬ æä¾›äº† sendFile å‡½æ•°ï¼Œå…¶åŸºæœ¬åŸç†å¦‚ä¸‹ï¼šæ•°æ®æ ¹æœ¬ä¸ç»è¿‡ç”¨æˆ·æ€ï¼Œç›´æ¥ä»å†…æ ¸ç¼“å†²åŒºè¿›å…¥åˆ° Socket Bufferï¼ŒåŒæ—¶ï¼Œç”±äºå’Œç”¨æˆ·æ€å®Œå…¨æ— å…³ï¼Œå°±å‡å°‘äº†ä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚</p>
<p>ç¤ºæ„å›¾å’Œå°ç»“</p>
<p>æç¤ºï¼šé›¶æ‹·è´ä»æ“ä½œç³»ç»Ÿè§’åº¦ï¼Œæ˜¯æ²¡æœ‰cpu æ‹·è´</p>
<p>Linux åœ¨ 2.4 ç‰ˆæœ¬ä¸­ï¼Œåšäº†ä¸€äº›ä¿®æ”¹ï¼Œé¿å…äº†ä»å†…æ ¸ç¼“å†²åŒºæ‹·è´åˆ° Socket buffer çš„æ“ä½œï¼Œç›´æ¥æ‹·è´åˆ°åè®®æ ˆï¼Œä»è€Œå†ä¸€æ¬¡å‡å°‘äº†æ•°æ®æ‹·è´ã€‚å…·ä½“å¦‚ä¸‹å›¾å’Œå°ç»“ï¼š</p>
<p>è¿™é‡Œå…¶å®æœ‰ ä¸€æ¬¡cpu æ‹·è´</p>
<p>kernel buffer -&gt; socket buffer</p>
<p>ä½†æ˜¯ï¼Œæ‹·è´çš„ä¿¡æ¯å¾ˆå°‘ï¼Œæ¯”å¦‚</p>
<p>lenght , offset , æ¶ˆè€—ä½ï¼Œå¯ä»¥å¿½ç•¥</p>
<h3 id="é›¶æ‹·è´çš„å†æ¬¡ç†è§£"><a href="#é›¶æ‹·è´çš„å†æ¬¡ç†è§£" class="headerlink" title="é›¶æ‹·è´çš„å†æ¬¡ç†è§£"></a>é›¶æ‹·è´çš„å†æ¬¡ç†è§£</h3><p>â€‹		æˆ‘ä»¬è¯´é›¶æ‹·è´ï¼Œæ˜¯ä»æ“ä½œç³»ç»Ÿçš„è§’åº¦æ¥è¯´çš„ã€‚å› ä¸ºå†…æ ¸ç¼“å†²åŒºä¹‹é—´ï¼Œæ²¡æœ‰æ•°æ®æ˜¯é‡å¤çš„ï¼ˆåªæœ‰ kernel buffer æœ‰ä¸€ä»½æ•°æ®ï¼‰ã€‚</p>
<p>é›¶æ‹·è´ä¸ä»…ä»…å¸¦æ¥æ›´å°‘çš„æ•°æ®å¤åˆ¶ï¼Œè¿˜èƒ½å¸¦æ¥å…¶ä»–çš„æ€§èƒ½ä¼˜åŠ¿ï¼Œä¾‹å¦‚æ›´å°‘çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæ›´å°‘çš„ CPU ç¼“å­˜ä¼ªå…±äº«ä»¥åŠæ—  CPU æ ¡éªŒå’Œè®¡ç®—ã€‚</p>
<h3 id="mmap-å’Œ-sendFile-çš„åŒºåˆ«"><a href="#mmap-å’Œ-sendFile-çš„åŒºåˆ«" class="headerlink" title="mmap å’Œ sendFile çš„åŒºåˆ«"></a>mmap å’Œ sendFile çš„åŒºåˆ«</h3><ol>
<li><p>mmap é€‚åˆå°æ•°æ®é‡è¯»å†™ï¼ŒsendFile é€‚åˆå¤§æ–‡ä»¶ä¼ è¾“ã€‚</p>
</li>
<li><p>mmap éœ€è¦ 4 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œ3 æ¬¡æ•°æ®æ‹·è´ï¼›sendFile éœ€è¦ 3 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæœ€å°‘ 2 æ¬¡æ•°æ®æ‹·è´ã€‚</p>
</li>
<li><p>sendFile å¯ä»¥åˆ©ç”¨ DMA æ–¹å¼ï¼Œå‡å°‘ CPU æ‹·è´ï¼Œmmap åˆ™ä¸èƒ½ï¼ˆå¿…é¡»ä»å†…æ ¸æ‹·è´åˆ° Socket ç¼“å†²åŒºï¼‰ã€‚</p>
</li>
</ol>
<h1 id="AIOç¼–ç¨‹"><a href="#AIOç¼–ç¨‹" class="headerlink" title="AIOç¼–ç¨‹"></a>AIOç¼–ç¨‹</h1><p>â€‹		JDK 7 å¼•å…¥äº† Asynchronous I&#x2F;Oï¼Œå³ AIOã€‚åœ¨è¿›è¡Œ I&#x2F;O ç¼–ç¨‹ä¸­ï¼Œå¸¸ç”¨åˆ°ä¸¤ç§æ¨¡å¼ï¼šReactorå’Œ Proactorã€‚Java çš„ NIO å°±æ˜¯Reactorï¼Œå½“æœ‰äº‹ä»¶è§¦å‘æ—¶ï¼ŒæœåŠ¡å™¨ç«¯å¾—åˆ°é€šçŸ¥ï¼Œè¿›è¡Œç›¸åº”çš„å¤„ç†AIO å³ NIO2.0ï¼Œå«åšå¼‚æ­¥ä¸é˜»å¡çš„ IOã€‚AIO å¼•å…¥å¼‚æ­¥é€šé“çš„æ¦‚å¿µï¼Œé‡‡ç”¨äº† Proactor æ¨¡å¼ï¼Œç®€åŒ–äº†ç¨‹åºç¼–å†™ï¼Œæœ‰æ•ˆçš„è¯·æ±‚æ‰å¯åŠ¨çº¿ç¨‹ï¼Œå®ƒçš„ç‰¹ç‚¹æ˜¯å…ˆç”±æ“ä½œç³»ç»Ÿå®Œæˆåæ‰é€šçŸ¥æœåŠ¡ç«¯ç¨‹åºå¯åŠ¨çº¿ç¨‹å»å¤„ç†ï¼Œä¸€èˆ¬é€‚ç”¨äºè¿æ¥æ•°è¾ƒå¤šä¸”è¿æ¥æ—¶é—´è¾ƒé•¿çš„åº”ç”¨ã€‚</p>
<p>â€‹		ç›®å‰ AIO è¿˜æ²¡æœ‰å¹¿æ³›åº”ç”¨ï¼ŒNetty ä¹Ÿæ˜¯åŸºäºNIO, è€Œä¸æ˜¯AIOï¼ŒAIO å¯ä»¥å‚è€ƒ Javaæ–°ä¸€ä»£ç½‘ç»œç¼–ç¨‹æ¨¡å‹AIOåŸç†åŠLinuxç³»ç»ŸAIOä»‹ç»</p>
<p><a target="_blank" rel="noopener" href="http://www.52im.net/thread-306-1-1.html">http://www.52im.net/thread-306-1-1.html</a> </p>
<h1 id="Nettyæ¦‚è¿°"><a href="#Nettyæ¦‚è¿°" class="headerlink" title="Nettyæ¦‚è¿°"></a>Nettyæ¦‚è¿°</h1><h2 id="åŸç”ŸNIOå­˜åœ¨çš„é—®é¢˜"><a href="#åŸç”ŸNIOå­˜åœ¨çš„é—®é¢˜" class="headerlink" title="åŸç”ŸNIOå­˜åœ¨çš„é—®é¢˜"></a>åŸç”ŸNIOå­˜åœ¨çš„é—®é¢˜</h2><ol>
<li><p>NIO çš„ç±»åº“å’Œ API ç¹æ‚ï¼Œä½¿ç”¨éº»çƒ¦ï¼šéœ€è¦ç†Ÿç»ƒæŒæ¡ Selectorã€ServerSocketChannelã€SocketChannelã€ByteBuffer ç­‰ã€‚</p>
</li>
<li><p>éœ€è¦å…·å¤‡å…¶ä»–çš„é¢å¤–æŠ€èƒ½ï¼šè¦ç†Ÿæ‚‰ Java å¤šçº¿ç¨‹ç¼–ç¨‹ï¼Œå› ä¸º NIO ç¼–ç¨‹æ¶‰åŠåˆ° Reactor æ¨¡å¼ï¼Œä½ å¿…é¡»å¯¹å¤šçº¿ç¨‹å’Œç½‘ç»œç¼–ç¨‹éå¸¸ç†Ÿæ‚‰ï¼Œæ‰		èƒ½ç¼–å†™å‡ºé«˜è´¨é‡çš„ NIO ç¨‹åºã€‚</p>
</li>
<li><p>å¼€å‘å·¥ä½œé‡å’Œéš¾åº¦éƒ½éå¸¸å¤§ï¼šä¾‹å¦‚å®¢æˆ·ç«¯é¢ä¸´æ–­è¿é‡è¿ã€ç½‘ç»œé—ªæ–­ã€åŠåŒ…è¯»å†™ã€å¤±è´¥ç¼“å­˜ã€ç½‘ç»œæ‹¥å¡å’Œå¼‚å¸¸æµçš„å¤„ç†ç­‰ã€‚</p>
</li>
<li><p>JDK NIO çš„ Bugï¼šä¾‹å¦‚è‡­åæ˜­è‘—çš„ Epoll Bugï¼Œå®ƒä¼šå¯¼è‡´ Selector ç©ºè½®è¯¢ï¼Œæœ€ç»ˆå¯¼è‡´ CPU 100%ã€‚ç›´åˆ° JDK 1.7 ç‰ˆæœ¬è¯¥é—®é¢˜ä»æ—§å­˜		åœ¨ï¼Œæ²¡æœ‰è¢«æ ¹æœ¬è§£å†³ã€‚</p>
</li>
</ol>
<h2 id="Nettyçš„ä¼˜ç‚¹"><a href="#Nettyçš„ä¼˜ç‚¹" class="headerlink" title="Nettyçš„ä¼˜ç‚¹"></a>Nettyçš„ä¼˜ç‚¹</h2><ol>
<li><p>Netty å¯¹ JDK è‡ªå¸¦çš„ NIO çš„ API è¿›è¡Œäº†å°è£…ï¼Œè§£å†³äº†ä¸Šè¿°é—®é¢˜ã€‚</p>
</li>
<li><p>è®¾è®¡ä¼˜é›…ï¼šé€‚ç”¨äºå„ç§ä¼ è¾“ç±»å‹çš„ç»Ÿä¸€ API é˜»å¡å’Œéé˜»å¡ Socketï¼›åŸºäºçµæ´»ä¸”å¯æ‰©å±•çš„äº‹ä»¶æ¨¡å‹ï¼Œå¯ä»¥æ¸…æ™°åœ°åˆ†ç¦»å…³æ³¨ç‚¹ï¼›é«˜åº¦å¯		å®šåˆ¶çš„çº¿ç¨‹æ¨¡å‹ - å•çº¿ç¨‹ï¼Œä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹æ± .</p>
</li>
<li><p>ä½¿ç”¨æ–¹ä¾¿ï¼šè¯¦ç»†è®°å½•çš„ Javadocï¼Œç”¨æˆ·æŒ‡å—å’Œç¤ºä¾‹ï¼›æ²¡æœ‰å…¶ä»–ä¾èµ–é¡¹ï¼ŒJDK 5ï¼ˆNetty 3.xï¼‰æˆ– 6ï¼ˆNetty 4.xï¼‰å°±è¶³å¤Ÿäº†ã€‚</p>
</li>
<li><p>é«˜æ€§èƒ½ã€ååé‡æ›´é«˜ï¼šå»¶è¿Ÿæ›´ä½ï¼›å‡å°‘èµ„æºæ¶ˆè€—ï¼›æœ€å°åŒ–ä¸å¿…è¦çš„å†…å­˜å¤åˆ¶ã€‚</p>
</li>
</ol>
<p>â€‹		å®‰å…¨ï¼šå®Œæ•´çš„ SSL&#x2F;TLS å’Œ StartTLS æ”¯æŒã€‚</p>
<ol start="5">
<li>ç¤¾åŒºæ´»è·ƒã€ä¸æ–­æ›´æ–°ï¼šç¤¾åŒºæ´»è·ƒï¼Œç‰ˆæœ¬è¿­ä»£å‘¨æœŸçŸ­ï¼Œå‘ç°çš„ Bug å¯ä»¥è¢«åŠæ—¶ä¿®å¤ï¼ŒåŒæ—¶ï¼Œæ›´å¤šçš„æ–°åŠŸèƒ½ä¼šè¢«åŠ å…¥</li>
</ol>
<h2 id="Nettyç‰ˆæœ¬è¯´æ˜"><a href="#Nettyç‰ˆæœ¬è¯´æ˜" class="headerlink" title="Nettyç‰ˆæœ¬è¯´æ˜"></a>Nettyç‰ˆæœ¬è¯´æ˜</h2><ol>
<li>nettyç‰ˆæœ¬åˆ†ä¸º netty3.x å’Œ netty4.xã€netty5.x</li>
<li>å› ä¸ºNetty5å‡ºç°é‡å¤§bugï¼Œå·²ç»è¢«å®˜ç½‘åºŸå¼ƒäº†ï¼Œç›®å‰æ¨èä½¿ç”¨çš„æ˜¯Netty4.xçš„ç¨³å®šç‰ˆæœ¬ã€‚</li>
<li>ç›®å‰åœ¨å®˜ç½‘å¯ä¸‹è½½çš„ç‰ˆæœ¬ netty3.x netty4.0.x å’Œ netty4.1.x</li>
<li>netty ä¸‹è½½åœ°å€ï¼š <a target="_blank" rel="noopener" href="https://bintray.com/netty/downloads/netty/">https://bintray.com/netty/downloads/netty/</a></li>
</ol>
<h1 id="Netty-é«˜æ€§èƒ½æ¶æ„è®¾è®¡"><a href="#Netty-é«˜æ€§èƒ½æ¶æ„è®¾è®¡" class="headerlink" title="Netty é«˜æ€§èƒ½æ¶æ„è®¾è®¡"></a>Netty é«˜æ€§èƒ½æ¶æ„è®¾è®¡</h1><h2 id="çº¿ç¨‹æ¨¡å‹åŸºæœ¬ä»‹ç»"><a href="#çº¿ç¨‹æ¨¡å‹åŸºæœ¬ä»‹ç»" class="headerlink" title="çº¿ç¨‹æ¨¡å‹åŸºæœ¬ä»‹ç»"></a>çº¿ç¨‹æ¨¡å‹åŸºæœ¬ä»‹ç»</h2><p>â€‹		ä¸åŒçš„çº¿ç¨‹æ¨¡å¼ï¼Œå¯¹ç¨‹åºçš„æ€§èƒ½æœ‰å¾ˆå¤§å½±å“ï¼Œç›®å‰å­˜åœ¨çš„çº¿ç¨‹æ¨¡å‹æœ‰ï¼š<strong>ä¼ ç»Ÿé˜»å¡ I&#x2F;O æœåŠ¡æ¨¡å‹ï¼ŒReactor æ¨¡å¼</strong></p>
<p>æ ¹æ® Reactor çš„æ•°é‡å’Œå¤„ç†èµ„æºæ± çº¿ç¨‹çš„æ•°é‡ä¸åŒï¼Œæœ‰ 3 ç§å…¸å‹çš„å®ç°ï¼š</p>
<ul>
<li><p>å• Reactor å•çº¿ç¨‹ï¼›</p>
</li>
<li><p>å• Reactor å¤šçº¿ç¨‹ï¼›</p>
</li>
<li><p>ä¸»ä» Reactor å¤šçº¿ç¨‹</p>
<p>  Netty çº¿ç¨‹æ¨¡å¼ï¼ˆNetty ä¸»è¦åŸºäºä¸»ä» Reactor å¤šçº¿ç¨‹æ¨¡å‹åšäº†ä¸€å®šçš„æ”¹è¿›ï¼Œå…¶ä¸­ä¸»ä» Reactor å¤šçº¿ç¨‹æ¨¡å‹æœ‰å¤šä¸ª Reactorï¼‰ã€‚</p>
</li>
</ul>
<h2 id="ä¼ ç»Ÿé˜»å¡-I-x2F-O-æœåŠ¡æ¨¡å‹"><a href="#ä¼ ç»Ÿé˜»å¡-I-x2F-O-æœåŠ¡æ¨¡å‹" class="headerlink" title="ä¼ ç»Ÿé˜»å¡ I&#x2F;O æœåŠ¡æ¨¡å‹"></a>ä¼ ç»Ÿé˜»å¡ I&#x2F;O æœåŠ¡æ¨¡å‹</h2><h3 id="å·¥ä½œåŸç†å›¾"><a href="#å·¥ä½œåŸç†å›¾" class="headerlink" title="å·¥ä½œåŸç†å›¾"></a>å·¥ä½œåŸç†å›¾</h3><img src="/2023/03/24/Netty/Java\Document\Netty\Netty å‚çœ‹æ–‡æ¡£.assets\image-20220919092414543.png" alt="image-20220919092414543" style="zoom:150%;">

<h3 id="æ¨¡å‹ç‰¹ç‚¹"><a href="#æ¨¡å‹ç‰¹ç‚¹" class="headerlink" title="æ¨¡å‹ç‰¹ç‚¹"></a><strong>æ¨¡å‹ç‰¹ç‚¹</strong></h3><p>é‡‡ç”¨é˜»å¡IOæ¨¡å¼è·å–è¾“å…¥çš„æ•°æ®</p>
<p>æ¯ä¸ªè¿æ¥éƒ½éœ€è¦ç‹¬ç«‹çš„çº¿ç¨‹å®Œæˆæ•°æ®çš„è¾“å…¥ï¼Œä¸šåŠ¡å¤„ç†ï¼Œæ•°æ®è¿”å›</p>
<h3 id="é—®é¢˜åˆ†æ"><a href="#é—®é¢˜åˆ†æ" class="headerlink" title="é—®é¢˜åˆ†æ"></a><strong>é—®é¢˜åˆ†æ</strong></h3><ol>
<li><p>å½“å¹¶å‘æ•°å¾ˆå¤§ï¼Œå°±ä¼šåˆ›å»ºå¤§é‡çš„çº¿ç¨‹ï¼Œå ç”¨å¾ˆå¤§ç³»ç»Ÿèµ„æº</p>
</li>
<li><p>è¿æ¥åˆ›å»ºåï¼Œå¦‚æœå½“å‰çº¿ç¨‹æš‚æ—¶æ²¡æœ‰æ•°æ®å¯è¯»ï¼Œè¯¥çº¿ç¨‹ä¼šé˜»å¡åœ¨read æ“ä½œï¼Œé€ æˆçº¿ç¨‹èµ„æºæµªè´¹ã€‚</p>
</li>
</ol>
<h2 id="Reactor-æ¨¡å¼"><a href="#Reactor-æ¨¡å¼" class="headerlink" title="Reactor æ¨¡å¼"></a>Reactor æ¨¡å¼</h2><h3 id="Reactoræ¨¡å¼æ¦‚è¿°"><a href="#Reactoræ¨¡å¼æ¦‚è¿°" class="headerlink" title="Reactoræ¨¡å¼æ¦‚è¿°"></a>Reactoræ¨¡å¼æ¦‚è¿°</h3><p>Reactor æ¨¡å¼ä¹Ÿç§°ä¸ºï¼šååº”å™¨æ¨¡å¼ã€åˆ†å‘è€…æ¨¡å¼ï¼ˆDispatcherï¼‰ã€é€šçŸ¥è€…æ¨¡å¼ï¼ˆnotifierï¼‰</p>
<p>é’ˆå¯¹ä¼ ç»Ÿé˜»å¡ I&#x2F;O æœåŠ¡æ¨¡å‹çš„ 2 ä¸ªç¼ºç‚¹ï¼Œè§£å†³æ–¹æ¡ˆï¼š</p>
<ol>
<li><p>åŸºäº I&#x2F;O å¤ç”¨æ¨¡å‹ï¼šå¤šä¸ªè¿æ¥å…±ç”¨ä¸€ä¸ªé˜»å¡å¯¹è±¡ï¼Œåº”ç”¨ç¨‹åºåªéœ€è¦åœ¨ä¸€ä¸ªé˜»å¡å¯¹è±¡ç­‰å¾…ï¼Œæ— éœ€é˜»å¡ç­‰å¾…æ‰€æœ‰è¿æ¥ã€‚å½“æŸä¸ªè¿æ¥æœ‰æ–°çš„æ•°æ®å¯ä»¥å¤„ç†æ—¶ï¼Œæ“ä½œç³»ç»Ÿé€šçŸ¥åº”ç”¨ç¨‹åºï¼Œçº¿ç¨‹ä»é˜»å¡çŠ¶æ€è¿”å›ï¼Œå¼€å§‹è¿›è¡Œä¸šåŠ¡å¤„ç†ã€‚</p>
</li>
<li><p>åŸºäºçº¿ç¨‹æ± å¤ç”¨çº¿ç¨‹èµ„æºï¼šä¸å¿…å†ä¸ºæ¯ä¸ªè¿æ¥åˆ›å»ºçº¿ç¨‹ï¼Œå°†è¿æ¥å®Œæˆåçš„ä¸šåŠ¡å¤„ç†ä»»åŠ¡åˆ†é…ç»™çº¿ç¨‹è¿›è¡Œå¤„ç†ï¼Œä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤„ç†å¤šä¸ªè¿æ¥çš„ä¸šåŠ¡ã€‚</p>
</li>
</ol>
<p><strong>I&#x2F;O å¤ç”¨ç»“åˆçº¿ç¨‹æ± ï¼Œå°±æ˜¯ Reactor æ¨¡å¼åŸºæœ¬è®¾è®¡æ€æƒ³ï¼Œå¦‚å›¾ï¼š</strong></p>
<img src="/2023/03/24/Netty/Java\Document\Netty\Netty å‚çœ‹æ–‡æ¡£.assets\image-20220919092954069.png" alt="image-20220919092954069" style="zoom:150%;">

<p>è¯´æ˜ï¼š</p>
<p>Reactor æ¨¡å¼ï¼Œå³é€šè¿‡ä¸€ä¸ªæˆ–å¤šä¸ªè¾“å…¥åŒæ—¶ä¼ é€’ç»™æœåŠ¡å¤„ç†å™¨çš„æ¨¡å¼ï¼ˆåŸºäºäº‹ä»¶é©±åŠ¨ï¼‰</p>
<p>æœåŠ¡å™¨ç«¯ç¨‹åºå¤„ç†ä¼ å…¥çš„å¤šä¸ªè¯·æ±‚ï¼Œå¹¶å°†å®ƒä»¬åŒæ­¥åˆ†æ´¾åˆ°ç›¸åº”çš„å¤„ç†çº¿ç¨‹ï¼Œå› æ­¤ Reactor æ¨¡å¼ä¹Ÿå« Dispatcher æ¨¡å¼ã€‚</p>
<p>Reactor æ¨¡å¼ä½¿ç”¨ IOå¤ç”¨ ç›‘å¬äº‹ä»¶ï¼Œæ”¶åˆ°äº‹ä»¶åï¼Œåˆ†å‘ç»™æŸä¸ªçº¿ç¨‹(è¿›ç¨‹)ï¼Œè¿™ç‚¹å°±æ˜¯ç½‘ç»œæœåŠ¡å™¨é«˜å¹¶å‘å¤„ç†å…³é”®ã€‚</p>
<p>Reactor æ¨¡å¼ä¸­æ ¸å¿ƒç»„æˆï¼š</p>
<p><strong>Reactor</strong>ï¼šReactor åœ¨ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ä¸­è¿è¡Œï¼Œè´Ÿè´£ç›‘å¬å’Œåˆ†å‘äº‹ä»¶ï¼Œåˆ†å‘ç»™é€‚å½“çš„å¤„ç†ç¨‹åºæ¥å¯¹ IO äº‹ä»¶åšå‡ºååº”ã€‚ å®ƒå°±åƒå…¬å¸çš„ç”µè¯æ¥çº¿å‘˜ï¼Œå®ƒæ¥å¬æ¥è‡ªå®¢æˆ·çš„ç”µè¯å¹¶å°†çº¿è·¯è½¬ç§»åˆ°é€‚å½“çš„è”ç³»äººï¼›</p>
<p><strong>Handlers</strong>ï¼šå¤„ç†ç¨‹åºæ‰§è¡Œ I&#x2F;O äº‹ä»¶è¦å®Œæˆçš„å®é™…äº‹ä»¶ï¼Œç±»ä¼¼äºå®¢æˆ·æƒ³è¦ä¸ä¹‹äº¤è°ˆçš„å…¬å¸ä¸­çš„èŒå‘˜ã€‚Reactor é€šè¿‡è°ƒåº¦é€‚å½“çš„å¤„ç†ç¨‹åºæ¥å“åº” I&#x2F;O äº‹ä»¶ï¼Œå¤„ç†ç¨‹åºæ‰§è¡Œéé˜»å¡æ“ä½œã€‚</p>
<h3 id="Reactor-æ¨¡å¼åˆ†ç±»"><a href="#Reactor-æ¨¡å¼åˆ†ç±»" class="headerlink" title="Reactor æ¨¡å¼åˆ†ç±»"></a>Reactor æ¨¡å¼åˆ†ç±»</h3><p>æ ¹æ® Reactor çš„æ•°é‡å’Œå¤„ç†èµ„æºæ± çº¿ç¨‹çš„æ•°é‡ä¸åŒï¼Œæœ‰ 3 ç§å…¸å‹çš„å®ç°</p>
<ol>
<li><p>å• Reactor å•çº¿ç¨‹</p>
</li>
<li><p>å• Reactor å¤šçº¿ç¨‹</p>
</li>
<li><p>ä¸»ä» Reactor å¤šçº¿ç¨‹</p>
</li>
</ol>
<h3 id="å•-Reactor-å•çº¿ç¨‹"><a href="#å•-Reactor-å•çº¿ç¨‹" class="headerlink" title="å• Reactor å•çº¿ç¨‹"></a>å• Reactor å•çº¿ç¨‹</h3><h4 id="å·¥ä½œåŸç†å›¾-1"><a href="#å·¥ä½œåŸç†å›¾-1" class="headerlink" title="å·¥ä½œåŸç†å›¾"></a>å·¥ä½œåŸç†å›¾</h4><img src="/2023/03/24/Netty/Java\Document\Netty\Netty å‚çœ‹æ–‡æ¡£.assets\image-20220919093450325.png" alt="image-20220919093450325" style="zoom:150%;">

<h4 id="æ–¹æ¡ˆè¯´æ˜"><a href="#æ–¹æ¡ˆè¯´æ˜" class="headerlink" title="æ–¹æ¡ˆè¯´æ˜"></a>æ–¹æ¡ˆè¯´æ˜</h4><ol>
<li><p>Select æ˜¯å‰é¢ I&#x2F;O å¤ç”¨æ¨¡å‹ä»‹ç»çš„æ ‡å‡†ç½‘ç»œç¼–ç¨‹ APIï¼Œå¯ä»¥å®ç°åº”ç”¨ç¨‹åºé€šè¿‡ä¸€ä¸ªé˜»å¡å¯¹è±¡ç›‘å¬å¤šè·¯è¿æ¥è¯·æ±‚ã€‚</p>
</li>
<li><p>Reactor å¯¹è±¡é€šè¿‡ Select ç›‘æ§å®¢æˆ·ç«¯è¯·æ±‚äº‹ä»¶ï¼Œæ”¶åˆ°äº‹ä»¶åé€šè¿‡ Dispatch è¿›è¡Œåˆ†å‘ã€‚</p>
</li>
<li><p>å¦‚æœæ˜¯å»ºç«‹è¿æ¥è¯·æ±‚äº‹ä»¶ï¼Œåˆ™ç”± Acceptor é€šè¿‡ Accept å¤„ç†è¿æ¥è¯·æ±‚ï¼Œç„¶ååˆ›å»ºä¸€ä¸ª Handler å¯¹è±¡å¤„ç†è¿æ¥å®Œæˆåçš„åç»­ä¸šåŠ¡ã€‚</p>
</li>
<li><p>å¦‚æœä¸æ˜¯å»ºç«‹è¿æ¥äº‹ä»¶ï¼Œåˆ™ Reactor ä¼šåˆ†å‘è°ƒç”¨è¿æ¥å¯¹åº”çš„ Handler æ¥å“åº”ï¼ŒHandler ä¼šå®Œæˆ Readâ†’ä¸šåŠ¡å¤„ç†â†’Send çš„å®Œæ•´ä¸šåŠ¡æµç¨‹ã€‚</p>
</li>
<li><p>æœåŠ¡å™¨ç«¯ç”¨ä¸€ä¸ªçº¿ç¨‹é€šè¿‡å¤šè·¯å¤ç”¨å®Œæˆæ‰€æœ‰çš„ IO æ“ä½œï¼ˆåŒ…æ‹¬è¿æ¥ï¼Œè¯»ã€å†™ç­‰ï¼‰ï¼Œç¼–ç ç®€å•ï¼Œä½†æ˜¯å¦‚æœå®¢æˆ·ç«¯è¿æ¥æ•°é‡è¾ƒå¤šï¼Œå°†æ— æ³•æ”¯æ’‘ï¼Œå‰é¢çš„ NIO æ¡ˆä¾‹å°±å±äºè¿™ç§æ¨¡å‹ã€‚</p>
</li>
</ol>
<h4 id="ä¼˜ç¼ºç‚¹åˆ†æ"><a href="#ä¼˜ç¼ºç‚¹åˆ†æ" class="headerlink" title="ä¼˜ç¼ºç‚¹åˆ†æ"></a>ä¼˜ç¼ºç‚¹åˆ†æ</h4><p>ä¼˜ç‚¹ï¼šæ¨¡å‹ç®€å•ï¼Œæ²¡æœ‰å¤šçº¿ç¨‹ã€è¿›ç¨‹é€šä¿¡ã€ç«äº‰çš„é—®é¢˜ï¼Œå…¨éƒ¨éƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å®Œæˆã€‚</p>
<p>ç¼ºç‚¹ï¼š</p>
<ol>
<li><p>æ€§èƒ½é—®é¢˜ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œæ— æ³•å®Œå…¨å‘æŒ¥å¤šæ ¸ CPU çš„æ€§èƒ½ã€‚Handler åœ¨å¤„ç†æŸä¸ªè¿æ¥ä¸Šçš„ä¸šåŠ¡æ—¶ï¼Œæ•´ä¸ªè¿›ç¨‹æ— æ³•å¤„ç†å…¶ä»–è¿æ¥äº‹ä»¶ï¼Œå¾ˆå®¹æ˜“å¯¼è‡´æ€§èƒ½ç“¶é¢ˆã€‚</p>
</li>
<li><p>å¯é æ€§é—®é¢˜ï¼Œçº¿ç¨‹æ„å¤–ç»ˆæ­¢ï¼Œæˆ–è€…è¿›å…¥æ­»å¾ªç¯ï¼Œä¼šå¯¼è‡´æ•´ä¸ªç³»ç»Ÿé€šä¿¡æ¨¡å—ä¸å¯ç”¨ï¼Œä¸èƒ½æ¥æ”¶å’Œå¤„ç†å¤–éƒ¨æ¶ˆæ¯ï¼Œé€ æˆèŠ‚ç‚¹æ•…éšœã€‚</p>
<p> ä½¿ç”¨åœºæ™¯ï¼šå®¢æˆ·ç«¯çš„æ•°é‡æœ‰é™ï¼Œä¸šåŠ¡å¤„ç†éå¸¸å¿«é€Ÿï¼Œæ¯”å¦‚ Redis åœ¨ä¸šåŠ¡å¤„ç†çš„æ—¶é—´å¤æ‚åº¦ O(1) çš„æƒ…å†µã€‚</p>
</li>
</ol>
<h3 id="å•-Reactor-å¤šçº¿ç¨‹"><a href="#å•-Reactor-å¤šçº¿ç¨‹" class="headerlink" title="å• Reactor å¤šçº¿ç¨‹"></a>å• Reactor å¤šçº¿ç¨‹</h3><h4 id="å·¥ä½œåŸç†å›¾-2"><a href="#å·¥ä½œåŸç†å›¾-2" class="headerlink" title="å·¥ä½œåŸç†å›¾"></a>å·¥ä½œåŸç†å›¾</h4><img src="/2023/03/24/Netty/Java\Document\Netty\Netty å‚çœ‹æ–‡æ¡£.assets\image-20220919094021418.png" alt="image-20220919094021418" style="zoom:150%;">

<h4 id="æ–¹æ¡ˆè¯´æ˜-1"><a href="#æ–¹æ¡ˆè¯´æ˜-1" class="headerlink" title="æ–¹æ¡ˆè¯´æ˜"></a>æ–¹æ¡ˆè¯´æ˜</h4><ol>
<li><p>Reactor å¯¹è±¡é€šè¿‡ select ç›‘æ§å®¢æˆ·ç«¯è¯·æ±‚äº‹ä»¶ï¼Œæ”¶åˆ°äº‹ä»¶åï¼Œé€šè¿‡dispatchè¿›è¡Œåˆ†å‘ã€‚</p>
</li>
<li><p>å¦‚æœå»ºç«‹è¿æ¥è¯·æ±‚ï¼Œåˆ™ç”± Acceptor é€šè¿‡ accept å¤„ç†è¿æ¥è¯·æ±‚ï¼Œ ç„¶ååˆ›å»ºä¸€ä¸ª Handler å¯¹è±¡å¤„ç†å®Œæˆè¿æ¥åçš„å„ç§äº‹ä»¶ã€‚</p>
</li>
<li><p>å¦‚æœä¸æ˜¯è¿æ¥è¯·æ±‚ï¼Œåˆ™ç”± reactor åˆ†å‘è°ƒç”¨è¿æ¥å¯¹åº”çš„ handler æ¥å¤„ç†ã€‚</p>
</li>
<li><p>handler åªè´Ÿè´£å“åº”äº‹ä»¶ï¼Œä¸åšå…·ä½“çš„ä¸šåŠ¡å¤„ç†ï¼Œ<strong>é€šè¿‡ read è¯»å–æ•°æ®å</strong>ï¼Œä¼šåˆ†å‘ç»™åé¢çš„ worker çº¿ç¨‹æ± çš„æŸä¸ªçº¿ç¨‹å¤„ç†ä¸šåŠ¡ã€‚</p>
</li>
<li><p>worker çº¿ç¨‹æ± ä¼šåˆ†é…ç‹¬ç«‹çº¿ç¨‹å®ŒæˆçœŸæ­£çš„ä¸šåŠ¡ï¼Œå¹¶å°†ç»“æœè¿”å›ç»™ handlerã€‚</p>
</li>
<li><p>handleræ”¶åˆ°å“åº”åï¼Œé€šè¿‡send å°†ç»“æœè¿”å›ç»™clientã€‚</p>
</li>
</ol>
<h4 id="ä¼˜ç¼ºç‚¹åˆ†æ-1"><a href="#ä¼˜ç¼ºç‚¹åˆ†æ-1" class="headerlink" title="ä¼˜ç¼ºç‚¹åˆ†æ"></a>ä¼˜ç¼ºç‚¹åˆ†æ</h4><p>ä¼˜ç‚¹ï¼šå¯ä»¥å……åˆ†çš„åˆ©ç”¨å¤šæ ¸cpu çš„å¤„ç†èƒ½åŠ›</p>
<p>ç¼ºç‚¹ï¼š å¤šçº¿ç¨‹æ•°æ®å…±äº«å’Œè®¿é—®æ¯”è¾ƒå¤æ‚ï¼Œreactor å¤„ç†æ‰€æœ‰çš„äº‹ä»¶çš„ç›‘å¬å’Œå“åº”ï¼Œåœ¨å•çº¿ç¨‹è¿è¡Œï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯å®¹æ˜“å‡ºç°æ€§èƒ½ç“¶é¢ˆã€‚</p>
<h3 id="ä¸»ä»-Reactor-å¤šçº¿ç¨‹"><a href="#ä¸»ä»-Reactor-å¤šçº¿ç¨‹" class="headerlink" title="ä¸»ä» Reactor å¤šçº¿ç¨‹"></a>ä¸»ä» Reactor å¤šçº¿ç¨‹</h3><h4 id="å·¥ä½œåŸç†å›¾-3"><a href="#å·¥ä½œåŸç†å›¾-3" class="headerlink" title="å·¥ä½œåŸç†å›¾"></a>å·¥ä½œåŸç†å›¾</h4><p>é’ˆå¯¹å• Reactor å¤šçº¿ç¨‹æ¨¡å‹ä¸­ï¼ŒReactor åœ¨å•çº¿ç¨‹ä¸­è¿è¡Œï¼Œé«˜å¹¶å‘åœºæ™¯ä¸‹å®¹æ˜“æˆä¸ºæ€§èƒ½ç“¶é¢ˆï¼Œå¯ä»¥è®© Reactor åœ¨å¤šçº¿ç¨‹ä¸­è¿è¡Œã€‚</p>
<img src="/2023/03/24/Netty/Java\Document\Netty\Netty å‚çœ‹æ–‡æ¡£.assets\image-20220919094446646.png" alt="image-20220919094446646" style="zoom:150%;">

<h4 id="æ–¹æ¡ˆè¯´æ˜-2"><a href="#æ–¹æ¡ˆè¯´æ˜-2" class="headerlink" title="æ–¹æ¡ˆè¯´æ˜"></a>æ–¹æ¡ˆè¯´æ˜</h4><ol>
<li><p>Reactorä¸»çº¿ç¨‹ MainReactor å¯¹è±¡é€šè¿‡select ç›‘å¬è¿æ¥äº‹ä»¶, æ”¶åˆ°äº‹ä»¶åï¼Œé€šè¿‡Acceptor å¤„ç†è¿æ¥äº‹ä»¶ã€‚</p>
</li>
<li><p>å½“ Acceptor å¤„ç†è¿æ¥äº‹ä»¶åï¼ŒMainReactor å°†è¿æ¥åˆ†é…ç»™ SubReactor ã€‚</p>
</li>
<li><p>Subreactor å°†è¿æ¥åŠ å…¥åˆ°è¿æ¥é˜Ÿåˆ—è¿›è¡Œç›‘å¬ï¼Œå¹¶åˆ›å»º handler è¿›è¡Œå„ç§äº‹ä»¶å¤„ç†ã€‚</p>
</li>
<li><p>å½“æœ‰æ–°äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œ Subreactor å°±ä¼šè°ƒç”¨å¯¹åº”çš„ handler å¤„ç†ã€‚</p>
</li>
<li><p>handler é€šè¿‡ read è¯»å–æ•°æ®ï¼Œåˆ†å‘ç»™åé¢çš„ worker çº¿ç¨‹å¤„ç†ã€‚</p>
</li>
<li><p>worker çº¿ç¨‹æ± åˆ†é…ç‹¬ç«‹çš„ worker çº¿ç¨‹è¿›è¡Œä¸šåŠ¡å¤„ç†ï¼Œå¹¶è¿”å›ç»“æœã€‚</p>
</li>
<li><p>handler æ”¶åˆ°å“åº”çš„ç»“æœåï¼Œå†é€šè¿‡ send å°†ç»“æœè¿”å›ç»™ clientã€‚</p>
</li>
<li><p><strong>Reactor ä¸»çº¿ç¨‹å¯ä»¥å¯¹åº”å¤šä¸ª Reactor å­çº¿ç¨‹ï¼Œå³ MainRecator å¯ä»¥å…³è”å¤šä¸ªSubReactor</strong>ã€‚</p>
</li>
</ol>
<h4 id="ä¼˜ç¼ºç‚¹åˆ†æ-2"><a href="#ä¼˜ç¼ºç‚¹åˆ†æ-2" class="headerlink" title="ä¼˜ç¼ºç‚¹åˆ†æ"></a>ä¼˜ç¼ºç‚¹åˆ†æ</h4><p>ä¼˜ç‚¹ï¼š</p>
<ol>
<li><p>çˆ¶çº¿ç¨‹ä¸å­çº¿ç¨‹çš„æ•°æ®äº¤äº’ç®€å•èŒè´£æ˜ç¡®ï¼Œçˆ¶çº¿ç¨‹åªéœ€è¦æ¥æ”¶æ–°è¿æ¥ï¼Œå­çº¿ç¨‹å®Œæˆåç»­çš„ä¸šåŠ¡å¤„ç†ã€‚</p>
</li>
<li><p>ä¼˜ç‚¹ï¼šçˆ¶çº¿ç¨‹ä¸å­çº¿ç¨‹çš„æ•°æ®äº¤äº’ç®€å•ï¼ŒReactor ä¸»çº¿ç¨‹åªéœ€è¦æŠŠæ–°è¿æ¥ä¼ ç»™å­çº¿ç¨‹ï¼Œå­çº¿ç¨‹æ— éœ€è¿”å›æ•°æ®ã€‚</p>
</li>
</ol>
<p>ç¼ºç‚¹ï¼šç¼–ç¨‹å¤æ‚åº¦è¾ƒé«˜</p>
<p>ç»“åˆå®ä¾‹ï¼šè¿™ç§æ¨¡å‹åœ¨è®¸å¤šé¡¹ç›®ä¸­å¹¿æ³›ä½¿ç”¨ï¼ŒåŒ…æ‹¬ Nginx ä¸»ä» Reactor å¤šè¿›ç¨‹æ¨¡å‹ï¼ŒMemcached ä¸»ä»å¤šçº¿ç¨‹ï¼ŒNetty ä¸»ä»å¤šçº¿ç¨‹æ¨¡å‹çš„æ”¯æŒã€‚</p>
<h4 id="Scalable-IO-in-Java-å¯¹-Multiple-Reactors-çš„åŸç†å›¾è§£"><a href="#Scalable-IO-in-Java-å¯¹-Multiple-Reactors-çš„åŸç†å›¾è§£" class="headerlink" title="Scalable IO in Java å¯¹ Multiple Reactors çš„åŸç†å›¾è§£"></a>Scalable IO in Java å¯¹ Multiple Reactors çš„åŸç†å›¾è§£</h4><img src="/2023/03/24/Netty/Java\Document\Netty\Netty å‚çœ‹æ–‡æ¡£.assets\image-20220919100722867.png" alt="image-20220919100722867" style="zoom:150%;">

<h3 id="Reactor-æ¨¡å¼å°ç»“"><a href="#Reactor-æ¨¡å¼å°ç»“" class="headerlink" title="Reactor æ¨¡å¼å°ç»“"></a>Reactor æ¨¡å¼å°ç»“</h3><p>3 ç§æ¨¡å¼ç”¨ç”Ÿæ´»æ¡ˆä¾‹æ¥ç†è§£</p>
<p>Ã˜ å• Reactor å•çº¿ç¨‹ï¼Œå‰å°æ¥å¾…å‘˜å’ŒæœåŠ¡å‘˜æ˜¯åŒä¸€ä¸ªäººï¼Œå…¨ç¨‹ä¸ºé¡¾å®¢æœåŠ¡</p>
<p>Ã˜ å• Reactor å¤šçº¿ç¨‹ï¼Œ1 ä¸ªå‰å°æ¥å¾…å‘˜ï¼Œå¤šä¸ªæœåŠ¡å‘˜ï¼Œæ¥å¾…å‘˜åªè´Ÿè´£æ¥å¾…</p>
<p>Ã˜ ä¸»ä» Reactor å¤šçº¿ç¨‹ï¼Œå¤šä¸ªå‰å°æ¥å¾…å‘˜ï¼Œå¤šä¸ªæœåŠ¡ç”Ÿ</p>
<p>Reactor æ¨¡å¼å…·æœ‰å¦‚ä¸‹çš„ä¼˜ç‚¹</p>
<ol>
<li><p>å“åº”å¿«ï¼Œä¸å¿…ä¸ºå•ä¸ªåŒæ­¥æ—¶é—´æ‰€é˜»å¡ï¼Œè™½ç„¶ Reactor æœ¬èº«ä¾ç„¶æ˜¯åŒæ­¥çš„ã€‚</p>
</li>
<li><p>å¯ä»¥æœ€å¤§ç¨‹åº¦çš„é¿å…å¤æ‚çš„å¤šçº¿ç¨‹åŠåŒæ­¥é—®é¢˜ï¼Œå¹¶ä¸”é¿å…äº†å¤šçº¿ç¨‹&#x2F;è¿›ç¨‹çš„åˆ‡æ¢å¼€é”€ã€‚</p>
</li>
<li><p>æ‰©å±•æ€§å¥½ï¼Œå¯ä»¥æ–¹ä¾¿çš„é€šè¿‡å¢åŠ  Reactor å®ä¾‹ä¸ªæ•°æ¥å……åˆ†åˆ©ç”¨ CPU èµ„æºã€‚</p>
</li>
<li><p>å¤ç”¨æ€§å¥½ï¼ŒReactor æ¨¡å‹æœ¬èº«ä¸å…·ä½“äº‹ä»¶å¤„ç†é€»è¾‘æ— å…³ï¼Œå…·æœ‰å¾ˆé«˜çš„å¤ç”¨æ€§ã€‚</p>
</li>
</ol>
<h2 id="Nettyæ¨¡å‹"><a href="#Nettyæ¨¡å‹" class="headerlink" title="Nettyæ¨¡å‹"></a>Nettyæ¨¡å‹</h2><h3 id="å·¥ä½œåŸç†å›¾ï¼šç®€å•ç‰ˆ"><a href="#å·¥ä½œåŸç†å›¾ï¼šç®€å•ç‰ˆ" class="headerlink" title="å·¥ä½œåŸç†å›¾ï¼šç®€å•ç‰ˆ"></a>å·¥ä½œåŸç†å›¾ï¼šç®€å•ç‰ˆ</h3><img src="/2023/03/24/Netty/Java\Document\Netty\Netty å‚çœ‹æ–‡æ¡£.assets\image-20220919100436410.png" alt="image-20220919100436410" style="zoom:150%;">

<p>è¯´æ˜ï¼š</p>
<ol>
<li><p>Netty ä¸»è¦åŸºäºä¸»ä» Reactors å¤šçº¿ç¨‹æ¨¡å‹ï¼ˆå¦‚å›¾ï¼‰åšäº†ä¸€å®šçš„æ”¹è¿›ï¼Œå…¶ä¸­ä¸»ä» Reactor å¤šçº¿ç¨‹æ¨¡å‹æœ‰å¤šä¸ª Reactorã€‚</p>
</li>
<li><p>BossGroup çº¿ç¨‹ç»´æŠ¤Selector ï¼Œåªå…³æ³¨Accecptã€‚</p>
</li>
<li><p>å½“æ¥æ”¶åˆ°Acceptäº‹ä»¶ï¼Œè·å–åˆ°å¯¹åº”çš„ SocketChannelï¼Œå°è£…æˆ NIOScoketChannel å¹¶æ³¨å†Œåˆ° Worker çº¿ç¨‹ï¼ˆäº‹ä»¶å¾ªç¯ç»„ï¼‰, å¹¶è¿›è¡Œç»´		æŠ¤ã€‚</p>
</li>
<li><p>å½“ Worker çº¿ç¨‹ç›‘å¬åˆ° Selector ä¸­é€šé“å‘ç”Ÿè‡ªå·±æ„Ÿå…´è¶£çš„äº‹ä»¶åï¼Œå°±ç”±handlerè¿›è¡Œå¤„ç†ï¼Œæ³¨æ„ Handler å·²ç»åŠ å…¥åˆ°é€šé“ã€‚</p>
</li>
</ol>
<h3 id="å·¥ä½œåŸç†å›¾ï¼šè¿›é˜¶ç‰ˆ"><a href="#å·¥ä½œåŸç†å›¾ï¼šè¿›é˜¶ç‰ˆ" class="headerlink" title="å·¥ä½œåŸç†å›¾ï¼šè¿›é˜¶ç‰ˆ"></a>å·¥ä½œåŸç†å›¾ï¼šè¿›é˜¶ç‰ˆ</h3><p>Netty ä¸»è¦åŸºäºä¸»ä» Reactors å¤šçº¿ç¨‹æ¨¡å‹ï¼ˆå¦‚å›¾ï¼‰åšäº†ä¸€å®šçš„æ”¹è¿›ï¼Œå…¶ä¸­ä¸»ä»Reactor å¤šçº¿ç¨‹æ¨¡å‹æœ‰å¤šä¸ª Reactorã€‚</p>
<img src="/2023/03/24/Netty/Java\Document\Netty\Netty å‚çœ‹æ–‡æ¡£.assets\image-20220919100632295.png" alt="image-20220919100632295" style="zoom:150%;">

<h3 id="å·¥ä½œåŸç†å›¾ï¼šè¯¦ç»†ç‰ˆ"><a href="#å·¥ä½œåŸç†å›¾ï¼šè¯¦ç»†ç‰ˆ" class="headerlink" title="å·¥ä½œåŸç†å›¾ï¼šè¯¦ç»†ç‰ˆ"></a>å·¥ä½œåŸç†å›¾ï¼šè¯¦ç»†ç‰ˆ</h3><img src="/2023/03/24/Netty/Java\Document\Netty\Netty å‚çœ‹æ–‡æ¡£.assets\image-20220919100839638.png" alt="image-20220919100839638" style="zoom:150%;">

<p>è¯´æ˜ï¼š</p>
<ol>
<li><p>NettyæŠ½è±¡å‡ºä¸¤ç»„çº¿ç¨‹æ±  BossGroup ä¸“é—¨è´Ÿè´£æ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥ï¼ŒWorkerGroup ä¸“é—¨è´Ÿè´£ç½‘ç»œçš„è¯»å†™ã€‚</p>
</li>
<li><p>BossGroup å’Œ WorkerGroup ç±»å‹éƒ½æ˜¯ NioEventLoopGroupã€‚</p>
</li>
<li><p>NioEventLoopGroup ç›¸å½“äºä¸€ä¸ªäº‹ä»¶å¾ªç¯ç»„, è¿™ä¸ªç»„ä¸­å«æœ‰å¤šä¸ªäº‹ä»¶å¾ªç¯ï¼Œæ¯ä¸€ä¸ªäº‹ä»¶å¾ªç¯æ˜¯ NioEventLoopã€‚</p>
</li>
<li><p>NioEventLoop è¡¨ç¤ºä¸€ä¸ªä¸æ–­å¾ªç¯çš„æ‰§è¡Œå¤„ç†ä»»åŠ¡çš„çº¿ç¨‹ï¼Œæ¯ä¸ªNioEventLoop éƒ½æœ‰ä¸€ä¸ªselector , ç”¨äºç›‘å¬ç»‘å®šåœ¨å…¶ä¸Šçš„socketçš„ç½‘		ç»œé€šè®¯ã€‚</p>
</li>
<li><p>NioEventLoopGroup å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œå³å¯ä»¥å«æœ‰å¤šä¸ªNioEventLoopã€‚</p>
</li>
<li><p>æ¯ä¸ªBossNioEventLoop å¾ªç¯æ‰§è¡Œçš„æ­¥éª¤æœ‰3æ­¥ï¼š</p>
</li>
</ol>
<ol>
<li><p>è½®è¯¢ accept äº‹ä»¶ã€‚</p>
</li>
<li><p>å¤„ç† accept äº‹ä»¶ , ä¸ client å»ºç«‹è¿æ¥ , ç”ŸæˆNioScocketChannel , å¹¶å°†å…¶æ³¨å†Œåˆ°æŸä¸ªworker NIOEventLoop ä¸Šçš„ selector ã€‚</p>
</li>
<li><p>å¤„ç†ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡ï¼Œå³ runAllTasksã€‚</p>
</li>
</ol>
<ol start="7">
<li>æ¯ä¸ªWorker NIOEventLoop å¾ªç¯æ‰§è¡Œçš„æ­¥éª¤ï¼š</li>
</ol>
<ol>
<li><p>è½®è¯¢ read, write äº‹ä»¶ã€‚</p>
</li>
<li><p>å¤„ç† I&#x2F;O äº‹ä»¶ï¼Œå³ read, write äº‹ä»¶ï¼Œåœ¨å¯¹åº” NioScocketChannel å¤„ç†ã€‚</p>
</li>
<li><p>å¤„ç†ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡ï¼Œå³ runAllTasksã€‚</p>
</li>
</ol>
<ol start="8">
<li>æ¯ä¸ªWorker NIOEventLoop å¤„ç†ä¸šåŠ¡æ—¶ï¼Œä¼šä½¿ç”¨pipeline(ç®¡é“)ï¼Œpipeline ä¸­åŒ…å«äº† channel , å³é€šè¿‡pipeline å¯ä»¥è·å–åˆ°å¯¹åº”é€šé“,</li>
</ol>
<p>â€‹		ç®¡é“ä¸­ç»´æŠ¤äº†å¾ˆå¤šçš„å¤„ç†å™¨ã€‚</p>
<h3 id="Netty-å…¥é—¨ç¤ºä¾‹ï¼šTCPæœåŠ¡"><a href="#Netty-å…¥é—¨ç¤ºä¾‹ï¼šTCPæœåŠ¡" class="headerlink" title="Netty å…¥é—¨ç¤ºä¾‹ï¼šTCPæœåŠ¡"></a>Netty å…¥é—¨ç¤ºä¾‹ï¼šTCPæœåŠ¡</h3><p>ç¨‹åºè¦æ±‚ï¼šç›‘å¬8000ç«¯å£ï¼Œå®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ï¼ŒæœåŠ¡ç«¯è¿›è¡Œå“åº”ã€‚</p>
<p>NettyServerï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.netty.simple;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.ServerBootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelFuture;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInitializer;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelOption;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            1. åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ç»„ bossGroupå’ŒWorkerGroup</span></span><br><span class="line"><span class="comment">            2. bossGroupåªè´Ÿè´£å¤„ç†è¿æ¥è¯·æ±‚ï¼ŒçœŸæ­£çš„å’Œå®¢æˆ·ç«¯è¿›è¡Œä¸šåŠ¡å¤„ç†çš„ä¼šäº¤ç»™ workerGroup</span></span><br><span class="line"><span class="comment">            3. ä¸¤ä¸ªéƒ½æ˜¯æ— é™å¾ªç¯ä¸ª</span></span><br><span class="line"><span class="comment">            4. bossGroupå’ŒworkerGroupå«æœ‰å­çº¿ç¨‹ï¼ˆNioEventLoopï¼‰çš„æ•°ï¼Œé»˜è®¤å®é™… CPUæ ¸æ•° * 2</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">bossGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">workerGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//åˆ›å»ºæœåŠ¡å™¨ç«¯çš„å¯åŠ¨å¯¹è±¡ï¼Œé…ç½®å‚æ•°</span></span><br><span class="line">            <span class="type">ServerBootstrap</span> <span class="variable">serverBootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">            serverBootstrap</span><br><span class="line">                    <span class="comment">// è®¾ç½®ä¸¤ä¸ªçº¿ç¨‹ç»„</span></span><br><span class="line">                    .group(bossGroup, workerGroup)</span><br><span class="line">                    <span class="comment">// æœåŠ¡ç«¯ä½¿ç”¨ NioServerSocketChannel ä½œä¸ºæœåŠ¡å™¨çš„é€šé“å®ç°</span></span><br><span class="line">                    .channel(NioServerSocketChannel.class)</span><br><span class="line">                    <span class="comment">// è®¾ç½®çº¿ç¨‹é˜Ÿåˆ—å¾—åˆ°è¿æ¥ä¸ªæ•°</span></span><br><span class="line">                    .option(ChannelOption.SO_BACKLOG, <span class="number">128</span>)</span><br><span class="line">                    <span class="comment">// è®¾ç½®ä¿æŒæ´»åŠ¨è¿æ¥çŠ¶æ€</span></span><br><span class="line">                    .childOption(ChannelOption.SO_KEEPALIVE, <span class="literal">true</span>)</span><br><span class="line">                    <span class="comment">// è®¾ç½®æœåŠ¡ç«¯æ“ä½œ</span></span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.INFO))</span><br><span class="line">                    .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            <span class="comment">// ç»™workerGroupçš„EventLoopå¯¹åº”çš„ç®¡é“è®¾ç½®å¤„ç†å™¨</span></span><br><span class="line">                            socketChannel.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">NettyServerHandler</span>());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            System.out.println(<span class="string">&quot;Netty Server Is Ready...&quot;</span>);</span><br><span class="line">            <span class="comment">//ç»‘å®šç«¯å£å¹¶ä¸”åŒæ­¥ï¼Œå¯åŠ¨æœåŠ¡å™¨ï¼Œç”Ÿæˆä¸€ä¸ªChannelFutureå¯¹è±¡</span></span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">cf</span> <span class="operator">=</span> serverBootstrap.bind(<span class="number">8000</span>).sync();</span><br><span class="line">            <span class="comment">// å¯¹å…³é—­é€šé“äº‹ä»¶è¿›è¡Œç›‘å¬ï¼Œæ³¨æ„æ­¤å¤„æ˜¯ closeFuture è€Œä¸æ˜¯ close,å¦åˆ™å¯åŠ¨ä¾¿ä¼šå…³é—­</span></span><br><span class="line">            cf.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NettyServerHandlerï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.netty.simple;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.ByteBuf;</span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.Unpooled;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.Channel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInboundHandlerAdapter;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelPipeline;</span><br><span class="line"><span class="keyword">import</span> io.netty.util.CharsetUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyServerHandler</span> <span class="keyword">extends</span> <span class="title class_">ChannelInboundHandlerAdapter</span> &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        å½“é€šé“ç”±è¯»å–äº‹ä»¶å‘ç”Ÿæ—¶å°±ä¼šè§¦å‘è¯¥æ–¹æ³•</span></span><br><span class="line"><span class="comment">        ChannelHandlerContext ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œå«æœ‰ç®¡é“pipelineï¼Œé€šé“channelï¼Œåœ°å€ç­‰ä¿¡æ¯</span></span><br><span class="line"><span class="comment">        Object msg å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼Œé»˜è®¤Objectï¼Œå¯ä»¥æŒ‡å®šæ³›å‹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æœåŠ¡å™¨è¯»å–çº¿ç¨‹ï¼š&quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        System.out.println(<span class="string">&quot;server ctx: &quot;</span> + ctx);</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> ctx.channel();</span><br><span class="line">        <span class="comment">//æœ¬è´¨æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œå…·æœ‰å‡ºæ ˆå…¥æ ˆ</span></span><br><span class="line">        <span class="type">ChannelPipeline</span> <span class="variable">pipeline</span> <span class="operator">=</span> ctx.pipeline();</span><br><span class="line">        <span class="comment">//å°†msgè½¬ä¸ºByteBuf  ByteBufæ˜¯ç”±Nettyæä¾›çš„ï¼Œä¸æ˜¯NIOçš„ByteBuffer</span></span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">byteBuf</span> <span class="operator">=</span> (ByteBuf) msg;</span><br><span class="line">        System.out.println(<span class="string">&quot;å®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯ï¼š&quot;</span> + byteBuf.toString(CharsetUtil.UTF_8));</span><br><span class="line">        <span class="comment">//System.out.println(&quot;å®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯ï¼š&quot; + byteBuf.toString(StandardCharsets.UTF_8));</span></span><br><span class="line">        <span class="comment">//System.out.println(&quot;å®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯ï¼š&quot; + byteBuf.toString(Charset.forName(&quot;utf-8&quot;)));</span></span><br><span class="line">        System.out.println(<span class="string">&quot;å®¢æˆ·ç«¯çš„åœ°å€ï¼š&quot;</span> + channel.remoteAddress());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ•°æ®è¯»å–å®Œæ¯•</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//å°†æ•°æ®å†™å…¥åˆ°ç¼“å­˜ï¼Œå¹¶åˆ·æ–°ï¼Œä¸€èˆ¬å¯¹å‘é€çš„æ•°æ®è¿›è¡Œç¼–ç </span></span><br><span class="line">        ctx.writeAndFlush(Unpooled.copiedBuffer(<span class="string">&quot;Hello,Client!&quot;</span>, StandardCharsets.UTF_8));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¤„ç†å¼‚å¸¸ï¼Œä¸€èˆ¬æ˜¯å…³é—­é€šé“</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NettyClientï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.netty.simple;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.Bootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelFuture;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInitializer;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioSocketChannel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//å®¢æˆ·ç«¯éœ€è¦ä¸€ä¸ªäº‹ä»¶å¾ªç¯ç»„</span></span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">eventLoopGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//åˆ›å»ºå®¢æˆ·ç«¯å¯åŠ¨å¯¹è±¡,æ³¨æ„å®¢æˆ·ç«¯ä½¿ç”¨çš„æ˜¯Bootstrap,ä¸æ˜¯ServerBootstrap</span></span><br><span class="line">            <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">            bootstrap</span><br><span class="line">                    .group(eventLoopGroup)</span><br><span class="line">                    .channel(NioSocketChannel.class)</span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            socketChannel.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">NettyClientHandler</span>());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            System.out.println(<span class="string">&quot;Client Is Ready...&quot;</span>);</span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">channelFuture</span> <span class="operator">=</span> bootstrap.connect(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8000</span>).sync();</span><br><span class="line">            <span class="comment">//ç›‘å¬é€šé“å…³é—­</span></span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            eventLoopGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NettyClientHandlerï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.netty.simple;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.ByteBuf;</span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.Unpooled;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInboundHandlerAdapter;</span><br><span class="line"><span class="keyword">import</span> io.netty.util.CharsetUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyClientHandler</span> <span class="keyword">extends</span> <span class="title class_">ChannelInboundHandlerAdapter</span> &#123;</span><br><span class="line">    <span class="comment">//å½“é€šé“å°±ç»ªå°±ä¼šè§¦å‘è¯¥æ–¹æ³•</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;client: &quot;</span> + ctx);</span><br><span class="line">        ctx.channel().writeAndFlush(Unpooled.copiedBuffer(<span class="string">&quot;Hello,Server!&quot;</span>, CharsetUtil.UTF_8));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å½“é€šé“ç”±è¯»å–äº‹ä»¶å‘ç”Ÿæ—¶å°±ä¼šè§¦å‘</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">byteBuf</span> <span class="operator">=</span> (ByteBuf) msg;</span><br><span class="line">        System.out.println(<span class="string">&quot;æœåŠ¡å™¨å›å¤çš„æ¶ˆæ¯ï¼š&quot;</span> + byteBuf.toString(StandardCharsets.UTF_8));</span><br><span class="line">        System.out.println(<span class="string">&quot;æœåŠ¡å™¨ç«¯çš„åœ°å€ï¼š&quot;</span> + ctx.channel().remoteAddress());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¼‚å¸¸å¤„ç†</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯• Nettyåˆ›å»ºçº¿ç¨‹æ•°é‡ï¼Œé»˜è®¤CPUæ ¸æ•° * 2</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyCpuTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;CPUæ ¸æ•°ï¼š&quot;</span> + NettyRuntime.availableProcessors());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„-Task-3-ç§å…¸å‹ä½¿ç”¨åœºæ™¯"><a href="#ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„-Task-3-ç§å…¸å‹ä½¿ç”¨åœºæ™¯" class="headerlink" title="ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ Task 3 ç§å…¸å‹ä½¿ç”¨åœºæ™¯"></a>ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ Task 3 ç§å…¸å‹ä½¿ç”¨åœºæ™¯</h3><ol>
<li><p>ç”¨æˆ·ç¨‹åºè‡ªå®šä¹‰çš„æ™®é€šä»»åŠ¡</p>
</li>
<li><p>ç”¨æˆ·è‡ªå®šä¹‰å®šæ—¶ä»»åŠ¡</p>
</li>
<li><p>éå½“å‰ Reactor çº¿ç¨‹è°ƒç”¨ Channel çš„å„ç§æ–¹æ³•ã€‚ä¾‹å¦‚åœ¨æ¨é€ç³»ç»Ÿçš„ä¸šåŠ¡çº¿ç¨‹é‡Œé¢ï¼Œæ ¹æ®ç”¨æˆ·çš„æ ‡è¯†ï¼Œæ‰¾åˆ°å¯¹åº”çš„ Channel å¼•ç”¨ï¼Œç„¶		åè°ƒç”¨ Write ç±»æ–¹æ³•å‘è¯¥ç”¨æˆ·æ¨é€æ¶ˆæ¯ï¼Œå°±ä¼šè¿›å…¥åˆ°è¿™ç§åœºæ™¯ã€‚æœ€ç»ˆçš„ Write ä¼šæäº¤åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­åè¢«å¼‚æ­¥æ¶ˆè´¹ã€‚</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">       <span class="comment">// å¯¹äºæ¯”è¾ƒè€—æ—¶çš„ä»»åŠ¡ï¼ˆè‡ªå®šä¹‰çš„æ™®é€šä»»åŠ¡ï¼Œä¼šæäº¤åˆ° TaskQueue ä¸­ï¼‰ï¼š--&gt;å¼‚æ­¥æ‰§è¡Œ</span></span><br><span class="line">       ctx.channel().eventLoop().execute(() -&gt; &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">               ctx.writeAndFlush(Unpooled.copiedBuffer(<span class="string">&quot;HelloClient2...&quot;</span>, CharsetUtil.UTF_8));</span><br><span class="line">               System.out.println(<span class="string">&quot;channel2 code: &quot;</span> + ctx.channel().hashCode());</span><br><span class="line">           &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">               e.printStackTrace();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">       <span class="comment">// ç”¨æˆ·è‡ªå®šä¹‰å®šæ—¶ä»»åŠ¡ï¼Œè¯¥ä»»åŠ¡ä¼šæäº¤åˆ° scheduleTaskQueue ä¸­</span></span><br><span class="line">       ctx.channel().eventLoop().schedule(() -&gt; &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">               ctx.writeAndFlush(Unpooled.copiedBuffer(<span class="string">&quot;HelloClient3...&quot;</span>, CharsetUtil.UTF_8));</span><br><span class="line">               System.out.println(<span class="string">&quot;channel3 code: &quot;</span> + ctx.channel().hashCode());</span><br><span class="line">           &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">               e.printStackTrace();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;, <span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line">       <span class="comment">// éå½“å‰ Reactor çº¿ç¨‹è°ƒç”¨ Channel çš„å„ç§æ–¹æ³•ï¼Œå¦‚æ¨é€ä¸šåŠ¡ï¼šæ‹¿åˆ°å„ä¸ª Channel ,åœ¨eventLoopä¸­éå†æ·»åŠ äº‹ä»¶</span></span><br><span class="line">       System.out.println(<span class="string">&quot;go on ...&quot;</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç¤ºä¾‹æ€»ç»“"><a href="#ç¤ºä¾‹æ€»ç»“" class="headerlink" title="ç¤ºä¾‹æ€»ç»“"></a>ç¤ºä¾‹æ€»ç»“</h3><ol>
<li><p>Netty æŠ½è±¡å‡ºä¸¤ç»„çº¿ç¨‹æ± ï¼ŒBossGroup ä¸“é—¨è´Ÿè´£æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥ï¼ŒWorkerGroup ä¸“é—¨è´Ÿè´£ç½‘ç»œè¯»å†™æ“ä½œã€‚</p>
</li>
<li><p>NioEventLoop è¡¨ç¤ºä¸€ä¸ªä¸æ–­å¾ªç¯æ‰§è¡Œå¤„ç†ä»»åŠ¡çš„çº¿ç¨‹ï¼Œæ¯ä¸ª NioEventLoop éƒ½æœ‰ä¸€ä¸ª selectorï¼Œç”¨äºç›‘å¬ç»‘å®šåœ¨å…¶ä¸Šçš„ socket ç½‘ç»œ		é€šé“ã€‚</p>
</li>
<li><p>NioEventLoop å†…éƒ¨é‡‡ç”¨ä¸²è¡ŒåŒ–è®¾è®¡ï¼Œä»æ¶ˆæ¯çš„è¯»å– â€“&gt; è§£ç  â€“&gt; å¤„ç† â€“&gt; ç¼–ç  â€“&gt; å‘é€ï¼Œå§‹ç»ˆç”± IO çº¿ç¨‹ NioEventLoop è´Ÿè´£ã€‚</p>
</li>
<li><p>NioEventLoopGroup ä¸‹åŒ…å«å¤šä¸ª NioEventLoopï¼š</p>
</li>
</ol>
<ul>
<li>æ¯ä¸ª NioEventLoop ä¸­åŒ…å«æœ‰ä¸€ä¸ª Selectorï¼Œä¸€ä¸ª taskQueueã€‚</li>
<li>æ¯ä¸ª NioEventLoop çš„ Selector ä¸Šå¯ä»¥æ³¨å†Œç›‘å¬å¤šä¸ª NioChannelã€‚</li>
<li>æ¯ä¸ª NioChannel åªä¼šç»‘å®šåœ¨å”¯ä¸€çš„ NioEventLoop ä¸Šã€‚</li>
<li>æ¯ä¸ª NioChannel éƒ½ç»‘å®šæœ‰ä¸€ä¸ªè‡ªå·±çš„ ChannelPipelineã€‚</li>
</ul>
<h3 id="å¼‚æ­¥æ¨¡å‹"><a href="#å¼‚æ­¥æ¨¡å‹" class="headerlink" title="å¼‚æ­¥æ¨¡å‹"></a>å¼‚æ­¥æ¨¡å‹</h3><h4 id="åŸºæœ¬ä»‹ç»-4"><a href="#åŸºæœ¬ä»‹ç»-4" class="headerlink" title="åŸºæœ¬ä»‹ç»"></a>åŸºæœ¬ä»‹ç»</h4><p>â€‹		å¼‚æ­¥çš„æ¦‚å¿µå’ŒåŒæ­¥ç›¸å¯¹ã€‚å½“ä¸€ä¸ªå¼‚æ­¥è¿‡ç¨‹è°ƒç”¨å‘å‡ºåï¼Œè°ƒç”¨è€…ä¸èƒ½ç«‹åˆ»å¾—åˆ°ç»“æœã€‚å®é™…å¤„ç†è¿™ä¸ªè°ƒç”¨çš„ç»„ä»¶åœ¨å®Œæˆåï¼Œé€šè¿‡çŠ¶æ€ã€é€šçŸ¥å’Œå›è°ƒæ¥é€šçŸ¥è°ƒç”¨è€…ã€‚</p>
<p>Netty ä¸­çš„ I&#x2F;O æ“ä½œæ˜¯å¼‚æ­¥çš„ï¼ŒåŒ…æ‹¬ <strong>Bindã€Writeã€Connect</strong> ç­‰æ“ä½œä¼šç®€å•çš„è¿”å›ä¸€ä¸ª ChannelFutureã€‚</p>
<p>è°ƒç”¨è€…å¹¶ä¸èƒ½ç«‹åˆ»è·å¾—ç»“æœï¼Œè€Œæ˜¯é€šè¿‡ Future-Listener æœºåˆ¶ï¼Œç”¨æˆ·å¯ä»¥æ–¹ä¾¿çš„ä¸»åŠ¨è·å–æˆ–è€…é€šè¿‡é€šçŸ¥æœºåˆ¶è·å¾— IO æ“ä½œç»“æœã€‚</p>
<p>Netty çš„å¼‚æ­¥æ¨¡å‹æ˜¯å»ºç«‹åœ¨ future å’Œ callback ä¹‹ä¸Šçš„ã€‚callback å°±æ˜¯å›è°ƒã€‚é‡ç‚¹è¯´ Futureï¼Œå®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šå‡è®¾ä¸€ä¸ªæ–¹æ³• funï¼Œè®¡ç®—è¿‡ç¨‹å¯èƒ½éå¸¸è€—æ—¶ï¼Œç­‰å¾… funè¿”å›æ˜¾ç„¶ä¸åˆé€‚ã€‚é‚£ä¹ˆå¯ä»¥åœ¨è°ƒç”¨ fun çš„æ—¶å€™ï¼Œç«‹é©¬è¿”å›ä¸€ä¸ª Futureï¼Œåç»­å¯ä»¥é€šè¿‡ Futureå»ç›‘æ§æ–¹æ³• fun çš„å¤„ç†è¿‡ç¨‹(å³ ï¼šFuture-Listener æœºåˆ¶)ã€‚</p>
<h4 id="Future-è¯´æ˜"><a href="#Future-è¯´æ˜" class="headerlink" title="Future è¯´æ˜"></a>Future è¯´æ˜</h4><p>â€‹		Future è¡¨ç¤ºå¼‚æ­¥çš„æ‰§è¡Œç»“æœï¼Œå¯ä»¥é€šè¿‡å®ƒæä¾›çš„æ–¹æ³•æ¥æ£€æµ‹æ‰§è¡Œæ˜¯å¦å®Œæˆï¼Œæ¯”å¦‚æ£€ç´¢ã€è®¡ç®—ç­‰ã€‚</p>
<p>ChannelFuture æ˜¯ä¸€ä¸ªæ¥å£ ï¼š </p>
<p>public interface ChannelFuture extends Future<Void></Void></p>
<p>å¯ä»¥æ·»åŠ ç›‘å¬å™¨ï¼Œå½“ç›‘å¬çš„äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå°±ä¼šé€šçŸ¥åˆ°ç›‘å¬å™¨ã€‚</p>
<h4 id="å·¥ä½œåŸç†å›¾-4"><a href="#å·¥ä½œåŸç†å›¾-4" class="headerlink" title="å·¥ä½œåŸç†å›¾"></a>å·¥ä½œåŸç†å›¾</h4><img src="/2023/03/24/Netty/Java\Document\Netty\Netty å‚çœ‹æ–‡æ¡£.assets\image-20220919113947886.png" alt="image-20220919113947886" style="zoom:150%;">

<p>è¯´æ˜</p>
<p>â€‹		åœ¨ä½¿ç”¨ Netty è¿›è¡Œç¼–ç¨‹æ—¶ï¼Œæ‹¦æˆªæ“ä½œå’Œè½¬æ¢å‡ºå…¥ç«™æ•°æ®åªéœ€è¦æ‚¨æä¾› callback æˆ–åˆ©ç”¨ future å³å¯ã€‚è¿™ä½¿å¾—é“¾å¼æ“ä½œç®€å•ã€é«˜æ•ˆï¼Œå¹¶æœ‰åˆ©äºç¼–å†™å¯é‡ç”¨çš„ã€é€šç”¨çš„ä»£ç ã€‚Netty æ¡†æ¶çš„ç›®æ ‡å°±æ˜¯è®©ä½ çš„ä¸šåŠ¡é€»è¾‘ä»ç½‘ç»œåŸºç¡€åº”ç”¨ç¼–ç ä¸­åˆ†ç¦»å‡ºæ¥ã€è§£è„±å‡ºæ¥ã€‚</p>
<h4 id="Future-Listener-æœºåˆ¶"><a href="#Future-Listener-æœºåˆ¶" class="headerlink" title="Future-Listener æœºåˆ¶"></a>Future-Listener æœºåˆ¶</h4><p>â€‹		å½“ Future å¯¹è±¡åˆšåˆšåˆ›å»ºæ—¶ï¼Œå¤„äºæœªå®ŒæˆçŠ¶æ€ï¼Œè°ƒç”¨è€…å¯ä»¥é€šè¿‡è¿”å›çš„ ChannelFuture æ¥è·å–æ“ä½œæ‰§è¡Œçš„çŠ¶æ€ï¼Œæ³¨å†Œç›‘å¬å‡½æ•°æ¥æ‰§è¡Œå®Œæˆåçš„æ“ä½œã€‚</p>
<p>å¸¸è§æœ‰å¦‚ä¸‹æ“ä½œï¼š</p>
<ul>
<li>é€šè¿‡ isDone æ–¹æ³•æ¥åˆ¤æ–­å½“å‰æ“ä½œæ˜¯å¦å®Œæˆï¼›</li>
<li>é€šè¿‡ isSuccess æ–¹æ³•æ¥åˆ¤æ–­å·²å®Œæˆçš„å½“å‰æ“ä½œæ˜¯å¦æˆåŠŸï¼›</li>
<li>é€šè¿‡ getCause æ–¹æ³•æ¥è·å–å·²å®Œæˆçš„å½“å‰æ“ä½œå¤±è´¥çš„åŸå› ï¼›</li>
<li>é€šè¿‡ isCancelled æ–¹æ³•æ¥åˆ¤æ–­å·²å®Œæˆçš„å½“å‰æ“ä½œæ˜¯å¦è¢«å–æ¶ˆï¼›</li>
</ul>
<p>é€šè¿‡ addListener æ–¹æ³•æ¥æ³¨å†Œç›‘å¬å™¨ï¼Œå½“æ“ä½œå·²å®Œæˆï¼ˆisDone æ–¹æ³•è¿”å›å®Œæˆï¼‰ï¼Œå°†ä¼šé€šçŸ¥æŒ‡å®šçš„ç›‘å¬å™¨ï¼›å¦‚æœ Future å¯¹è±¡å·²å®Œæˆï¼Œåˆ™é€šçŸ¥æŒ‡å®šçš„ç›‘å¬å™¨ã€‚</p>
<p>ç¤ºä¾‹ï¼šç»‘å®šç«¯å£æ˜¯å¼‚æ­¥æ“ä½œï¼Œå½“ç»‘å®šæ“ä½œå¤„ç†å®Œï¼Œå°†ä¼šè°ƒç”¨ç›¸åº”çš„ç›‘å¬å™¨å¤„ç†é€»è¾‘ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cf.addListener(<span class="keyword">new</span> <span class="title class_">ChannelFutureListener</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">operationComplete</span><span class="params">(ChannelFuture channelFuture)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (channelFuture.isSuccess()) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;ç›‘å¬ç«¯å£æˆåŠŸ&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;ç›‘å¬ç«¯å£å¤±è´¥&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>ç›¸æ¯”ä¼ ç»Ÿé˜»å¡ I&#x2F;Oï¼Œæ‰§è¡Œ I&#x2F;O æ“ä½œåçº¿ç¨‹ä¼šè¢«é˜»å¡ä½, ç›´åˆ°æ“ä½œå®Œæˆï¼›</p>
<p>å¼‚æ­¥å¤„ç†çš„å¥½å¤„æ˜¯ä¸ä¼šé€ æˆçº¿ç¨‹é˜»å¡ï¼Œçº¿ç¨‹åœ¨ I&#x2F;O æ“ä½œæœŸé—´å¯ä»¥æ‰§è¡Œåˆ«çš„ç¨‹åºï¼Œåœ¨é«˜å¹¶å‘æƒ…å½¢ä¸‹ä¼šæ›´ç¨³å®šå’Œæ›´é«˜çš„ååé‡ã€‚</p>
<h3 id="Netty-ç¤ºä¾‹ï¼šHttpæœåŠ¡"><a href="#Netty-ç¤ºä¾‹ï¼šHttpæœåŠ¡" class="headerlink" title="Netty ç¤ºä¾‹ï¼šHttpæœåŠ¡"></a>Netty ç¤ºä¾‹ï¼šHttpæœåŠ¡</h3><p>ç¨‹åºè¦æ±‚ï¼šæµè§ˆå™¨å‘é€è¯·æ±‚ï¼šlocalhost:&#x2F;&#x2F;8000&#x2F;helloï¼ŒæœåŠ¡ç«¯å“åº” Hello Client!ï¼ŒåŒæ—¶è¿‡æ»¤ ç‰¹å®šè¯·æ±‚èµ„æºï¼Œå¦‚ &#x2F;favicon.ico</p>
<p>NettyServerï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.netty.http;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.ServerBootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelFuture;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInitializer;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelOption;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.HttpRequestDecoder;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.HttpResponseEncoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyHttpServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">listenGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">handlerGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServerBootstrap</span> <span class="variable">serverBootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">            serverBootstrap</span><br><span class="line">                    .group(listenGroup, handlerGroup)</span><br><span class="line">                    .channel(NioServerSocketChannel.class)</span><br><span class="line">                    .option(ChannelOption.SO_BACKLOG, <span class="number">128</span>)</span><br><span class="line">                    .childOption(ChannelOption.SO_KEEPALIVE, <span class="literal">true</span>)</span><br><span class="line">                    .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                                åœ¨ç®¡é“åŠ å…¥ HttpServerCodec,HttpServerCodec æ˜¯nettyæä¾›çš„ http çš„ç¼–è§£ç å™¨</span></span><br><span class="line"><span class="comment">                                server ç«¯æ¥æ”¶çš„æ˜¯ httpRequestï¼Œéœ€è¦ä½¿ç”¨ HttpRequestDecoder è¿›è¡Œè§£ç </span></span><br><span class="line"><span class="comment">                                server ç«¯å“åº”çš„æ˜¯ httpResponseï¼Œéœ€è¦ä½¿ç”¨ HttpResponseEncoder è¿›è¡Œç¼–ç </span></span><br><span class="line"><span class="comment">                             * */</span></span><br><span class="line">                            socketChannel.pipeline()</span><br><span class="line">                                    .addLast(<span class="string">&quot;MyHttpRequestDecoder&quot;</span>, <span class="keyword">new</span> <span class="title class_">HttpRequestDecoder</span>())</span><br><span class="line">                                    .addLast(<span class="string">&quot;HttpResponseEncoder&quot;</span>, <span class="keyword">new</span> <span class="title class_">HttpResponseEncoder</span>())</span><br><span class="line">                                    .addLast(<span class="string">&quot;TestHttpServerHandler&quot;</span>, <span class="keyword">new</span> <span class="title class_">TestHttpServerHandler</span>());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">channelFuture</span> <span class="operator">=</span> serverBootstrap.bind(<span class="number">8000</span>).sync();</span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            listenGroup.shutdownGracefully();</span><br><span class="line">            handlerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ ChannelInitializer å¯ä»¥å•ç‹¬å†™åœ¨ä¸€ä¸ªç±»ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.netty.http;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInitializer;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.HttpRequestDecoder;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.HttpResponseEncoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyChannelInitializer</span> <span class="keyword">extends</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            åœ¨ç®¡é“åŠ å…¥ HttpServerCodec,HttpServerCodec æ˜¯nettyæä¾›çš„ http çš„ç¼–è§£ç å™¨</span></span><br><span class="line"><span class="comment">            server ç«¯æ¥æ”¶çš„æ˜¯ httpRequestï¼Œéœ€è¦ä½¿ç”¨ HttpRequestDecoder è¿›è¡Œè§£ç </span></span><br><span class="line"><span class="comment">            server ç«¯å“åº”çš„æ˜¯ httpResponseï¼Œéœ€è¦ä½¿ç”¨ HttpResponseEncoder è¿›è¡Œç¼–ç </span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        socketChannel.pipeline()</span><br><span class="line">                .addLast(<span class="string">&quot;MyHttpRequestDecoder&quot;</span>, <span class="keyword">new</span> <span class="title class_">HttpRequestDecoder</span>())</span><br><span class="line">                .addLast(<span class="string">&quot;HttpResponseEncoder&quot;</span>, <span class="keyword">new</span> <span class="title class_">HttpResponseEncoder</span>())</span><br><span class="line">                .addLast(<span class="string">&quot;TestHttpServerHandler&quot;</span>, <span class="keyword">new</span> <span class="title class_">TestHttpServerHandler</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TestHttpServerHandlerï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.netty.http;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.ByteBuf;</span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.Unpooled;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.*;</span><br><span class="line"><span class="keyword">import</span> io.netty.util.CharsetUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * SimpleChannelInboundHandleræ˜¯ChannelInBoundHandlerAdapterçš„å­ç±»</span></span><br><span class="line"><span class="comment"> * HttpObject å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ç›¸äº’é€šè®¯çš„æ•°æ®è¢«å°è£…ä¸ºHttpObject</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestHttpServerHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;HttpObject&gt; &#123;</span><br><span class="line">    <span class="comment">// è¯»å–å®¢æˆ·ç«¯æ•°æ®</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, HttpObject msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;å¯¹åº”çš„channel=&quot;</span> + ctx.channel() + <span class="string">&quot; pipeline=&quot;</span> + ctx</span><br><span class="line">                .pipeline() + <span class="string">&quot; é€šè¿‡pipelineè·å–channel&quot;</span> + ctx.pipeline().channel());</span><br><span class="line">        System.out.println(<span class="string">&quot;å½“å‰ctxçš„handler=&quot;</span> + ctx.handler());</span><br><span class="line">        <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> HttpRequest) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;ctx ç±»å‹=&quot;</span> + ctx.getClass());</span><br><span class="line">            System.out.println(<span class="string">&quot;pipeline hashcode&quot;</span> + ctx.pipeline().hashCode() + <span class="string">&quot; TestHttpServerHandler hash=&quot;</span> + <span class="built_in">this</span>.hashCode());</span><br><span class="line">            System.out.println(<span class="string">&quot;msg ç±»å‹ï¼š &quot;</span> + msg.getClass());</span><br><span class="line">            System.out.println(<span class="string">&quot;å®¢æˆ·ç«¯åœ°å€ï¼š &quot;</span> + ctx.channel().remoteAddress());</span><br><span class="line">            <span class="type">HttpRequest</span> <span class="variable">httpRequest</span> <span class="operator">=</span> (HttpRequest) msg;</span><br><span class="line">            <span class="type">URI</span> <span class="variable">uri</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URI</span>(httpRequest.uri());</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;/favicon.ico&quot;</span>.equals(uri.getPath())) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;å®¢æˆ·ç«¯è¯·æ±‚ favicon.ico, ä¸åšå“åº”&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// è®¾ç½®å“åº”ä¿¡æ¯</span></span><br><span class="line">            <span class="type">ByteBuf</span> <span class="variable">content</span> <span class="operator">=</span> Unpooled.copiedBuffer(<span class="string">&quot;Hello,Browser&quot;</span>, CharsetUtil.UTF_8);</span><br><span class="line">            <span class="type">DefaultFullHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultFullHttpResponse</span>(HttpVersion.HTTP_1_1, HttpResponseStatus.OK, content);</span><br><span class="line">            response.headers().set(HttpHeaderNames.CONTENT_TYPE, <span class="string">&quot;text/plain&quot;</span>);</span><br><span class="line">            response.headers().set(HttpHeaderNames.CONTENT_LENGTH, content.readableBytes());</span><br><span class="line">            ctx.channel().writeAndFlush(response);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Netty-æ ¸å¿ƒæ¨¡å—ç»„ä»¶"><a href="#Netty-æ ¸å¿ƒæ¨¡å—ç»„ä»¶" class="headerlink" title="Netty æ ¸å¿ƒæ¨¡å—ç»„ä»¶"></a>Netty æ ¸å¿ƒæ¨¡å—ç»„ä»¶</h1><h2 id="Bootstrapã€ServerBootstrap"><a href="#Bootstrapã€ServerBootstrap" class="headerlink" title="Bootstrapã€ServerBootstrap"></a>Bootstrapã€ServerBootstrap</h2><p>â€‹		Bootstrap æ„æ€æ˜¯å¼•å¯¼ï¼Œä¸€ä¸ª Netty åº”ç”¨é€šå¸¸ç”±ä¸€ä¸ª Bootstrap å¼€å§‹ï¼Œ<strong>ä¸»è¦ä½œç”¨æ˜¯é…ç½®æ•´ä¸ª Netty ç¨‹åºï¼Œä¸²è”å„ä¸ªç»„ä»¶</strong>ï¼ŒNetty ä¸­ Bootstrap ç±»æ˜¯å®¢æˆ·ç«¯ç¨‹åºçš„å¯åŠ¨å¼•å¯¼ç±»ï¼ŒServerBootstrap æ˜¯æœåŠ¡ç«¯å¯åŠ¨å¼•å¯¼ç±»ã€‚</p>
<p>å¸¸è§çš„æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è¯¥æ–¹æ³•ç”¨äºæœåŠ¡å™¨ç«¯ï¼Œç”¨æ¥è®¾ç½®ä¸¤ä¸ª EventLoop</span></span><br><span class="line"><span class="keyword">public</span> ServerBootstrap <span class="title function_">group</span><span class="params">(EventLoopGroup parentGroup, EventLoopGroup childGroup)</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//è¯¥æ–¹æ³•ç”¨äºå®¢æˆ·ç«¯ï¼Œç”¨æ¥è®¾ç½®ä¸€ä¸ª EventLoop</span></span><br><span class="line"><span class="keyword">public</span> ServerBootstrap <span class="title function_">group</span><span class="params">(EventLoopGroup group)</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//è¯¥æ–¹æ³•ç”¨æ¥è®¾ç½®ä¸€ä¸ªæœåŠ¡å™¨ç«¯çš„é€šé“å®ç°</span></span><br><span class="line"><span class="keyword">public</span> ServerBootstrap <span class="title function_">channel</span><span class="params">(Class&lt;? extends C&gt; channelClass)</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//ç”¨æ¥ç»™ ServerChannel æ·»åŠ é…ç½®</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; ServerBootstrap <span class="title function_">option</span><span class="params">(ChannelOption&lt;T&gt; option, T value)</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//ç”¨æ¥ç»™æ¥æ”¶åˆ°çš„é€šé“æ·»åŠ é…ç½®</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; ServerBootstrap <span class="title function_">childOption</span><span class="params">(ChannelOption&lt;T&gt; childOption, T value)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//è¯¥æ–¹æ³•ç”¨æ¥è®¾ç½®ä¸šåŠ¡å¤„ç†ç±»ï¼ˆè‡ªå®šä¹‰çš„ handlerï¼‰</span></span><br><span class="line"><span class="keyword">public</span> ServerBootstrap <span class="title function_">childHandler</span><span class="params">(ChannelHandler childHandler)</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//è¯¥æ–¹æ³•ç”¨äºæœåŠ¡å™¨ç«¯ï¼Œç”¨æ¥è®¾ç½®å ç”¨çš„ç«¯å£å·</span></span><br><span class="line"><span class="keyword">public</span> ChannelFuture <span class="title function_">bind</span><span class="params">(<span class="type">int</span> inetPort)</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//è¯¥æ–¹æ³•ç”¨äºå®¢æˆ·ç«¯ï¼Œç”¨æ¥è¿æ¥æœåŠ¡å™¨ç«¯</span></span><br><span class="line"><span class="keyword">public</span> ChannelFuture <span class="title function_">connect</span><span class="params">(String inetHost, <span class="type">int</span> inetPort)</span></span><br></pre></td></tr></table></figure>

<h2 id="Futureã€ChannelFuture"><a href="#Futureã€ChannelFuture" class="headerlink" title="Futureã€ChannelFuture"></a>Futureã€ChannelFuture</h2><p>Netty ä¸­æ‰€æœ‰çš„ IO æ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„ï¼Œä¸èƒ½ç«‹åˆ»å¾—çŸ¥æ¶ˆæ¯æ˜¯å¦è¢«æ­£ç¡®å¤„ç†ã€‚ä½†æ˜¯å¯ä»¥è¿‡ä¸€ä¼šç­‰å®ƒæ‰§è¡Œå®Œæˆæˆ–è€…ç›´æ¥æ³¨å†Œä¸€ä¸ªç›‘å¬ï¼Œå…·ä½“çš„å®ç°å°±æ˜¯é€šè¿‡ Future å’Œ ChannelFuturesï¼Œä»–ä»¬å¯ä»¥æ³¨å†Œä¸€ä¸ªç›‘å¬ï¼Œå½“æ“ä½œæ‰§è¡ŒæˆåŠŸæˆ–å¤±è´¥æ—¶ç›‘å¬ä¼šè‡ªåŠ¨è§¦å‘æ³¨å†Œçš„ç›‘å¬äº‹ä»¶ã€‚</p>
<p>å¸¸è§çš„æ–¹æ³•ï¼š</p>
<p>Channel channel()     è¿”å›å½“å‰æ­£åœ¨è¿›è¡Œ IO æ“ä½œçš„é€šé“ã€‚</p>
<p>ChannelFuture sync()   ç­‰å¾…å¼‚æ­¥æ“ä½œæ‰§è¡Œå®Œæ¯•ã€‚</p>
<h2 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h2><ol>
<li><p>Netty ç½‘ç»œé€šä¿¡çš„ç»„ä»¶ï¼Œèƒ½å¤Ÿç”¨äºæ‰§è¡Œç½‘ç»œ I&#x2F;O æ“ä½œã€‚</p>
</li>
<li><p>é€šè¿‡Channel å¯è·å¾—å½“å‰ç½‘ç»œè¿æ¥çš„é€šé“çš„çŠ¶æ€ã€‚</p>
</li>
<li><p>é€šè¿‡Channel å¯è·å¾—ç½‘ç»œè¿æ¥çš„é…ç½®å‚æ•°ï¼ˆä¾‹å¦‚æ¥æ”¶ç¼“å†²åŒºå¤§å°ï¼‰ã€‚</p>
</li>
<li><p>Channel æä¾›å¼‚æ­¥çš„ç½‘ç»œ I&#x2F;O æ“ä½œ(å¦‚å»ºç«‹è¿æ¥ï¼Œè¯»å†™ï¼Œç»‘å®šç«¯å£)ï¼Œå¼‚æ­¥è°ƒç”¨æ„å‘³ç€ä»»ä½• I&#x2F;O è°ƒç”¨éƒ½å°†ç«‹å³è¿”å›ï¼Œå¹¶ä¸”ä¸ä¿è¯åœ¨è°ƒç”¨		ç»“æŸæ—¶æ‰€è¯·æ±‚çš„ I&#x2F;O æ“ä½œå·²å®Œæˆã€‚</p>
</li>
<li><p>è°ƒç”¨ç«‹å³è¿”å›ä¸€ä¸ª ChannelFuture å®ä¾‹ï¼Œé€šè¿‡æ³¨å†Œç›‘å¬å™¨åˆ° ChannelFuture ä¸Šï¼Œå¯ä»¥ I&#x2F;O æ“ä½œæˆåŠŸã€å¤±è´¥æˆ–å–æ¶ˆæ—¶å›è°ƒé€šçŸ¥è°ƒç”¨		æ–¹ã€‚</p>
</li>
<li><p>æ”¯æŒå…³è” I&#x2F;O æ“ä½œä¸å¯¹åº”çš„å¤„ç†ç¨‹åºã€‚</p>
</li>
<li><p>ä¸åŒåè®®ã€ä¸åŒçš„é˜»å¡ç±»å‹çš„è¿æ¥éƒ½æœ‰ä¸åŒçš„ Channel ç±»å‹ä¸ä¹‹å¯¹åº”ï¼Œå¸¸ç”¨çš„ Channel ç±»å‹ï¼š</p>
</li>
</ol>
<ul>
<li><p>â€‹	NioSocketChannelï¼šå¼‚æ­¥çš„å®¢æˆ·ç«¯ TCP Socket è¿æ¥ã€‚</p>
</li>
<li><p>â€‹	NioServerSocketChannelï¼šå¼‚æ­¥çš„æœåŠ¡å™¨ç«¯ TCP Socket è¿æ¥ã€‚</p>
</li>
<li><p>â€‹	NioDatagramChannelï¼šå¼‚æ­¥çš„ UDP è¿æ¥ã€‚</p>
</li>
<li><p>â€‹	NioSctpChannelï¼šå¼‚æ­¥çš„å®¢æˆ·ç«¯ Sctp è¿æ¥ã€‚</p>
</li>
<li><p>â€‹	NioSctpServerChannelï¼šå¼‚æ­¥çš„ Sctp æœåŠ¡å™¨ç«¯è¿æ¥ï¼Œè¿™äº›é€šé“æ¶µç›–äº† UDP å’Œ TCP ç½‘ç»œ IO ä»¥åŠæ–‡ä»¶ IOã€‚</p>
</li>
</ul>
<h2 id="Selector"><a href="#Selector" class="headerlink" title="Selector"></a>Selector</h2><ol>
<li><p>Netty åŸºäº Selector å¯¹è±¡å®ç° I&#x2F;O å¤šè·¯å¤ç”¨ï¼Œé€šè¿‡ Selectorä¸€ä¸ªçº¿ç¨‹å¯ä»¥ç›‘å¬å¤šä¸ªè¿æ¥çš„ Channel äº‹ä»¶ã€‚</p>
</li>
<li><p>å½“å‘ä¸€ä¸ª Selector ä¸­æ³¨å†Œ Channel åï¼ŒSelector å†…éƒ¨çš„æœºåˆ¶å°±å¯ä»¥ä¸æ–­è½®è¯¢è¿™äº›æ³¨å†Œçš„ Channel æ˜¯å¦æœ‰å·²å°±ç»ªçš„ I&#x2F;O äº‹ä»¶ï¼ˆä¾‹å¦‚å¯è¯»ï¼Œå¯å†™ï¼Œç½‘ç»œè¿æ¥å®Œæˆç­‰ï¼‰ï¼Œè¿™æ ·ç¨‹åºå°±å¯ä»¥ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹é«˜æ•ˆåœ°ç®¡ç†å¤šä¸ª Channelã€‚</p>
</li>
</ol>
<h2 id="ChannelHandler-åŠå…¶å®ç°ç±»"><a href="#ChannelHandler-åŠå…¶å®ç°ç±»" class="headerlink" title="ChannelHandler åŠå…¶å®ç°ç±»"></a>ChannelHandler åŠå…¶å®ç°ç±»</h2><ol>
<li><p>ChannelHandler æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå¤„ç† I&#x2F;O äº‹ä»¶æˆ–æ‹¦æˆª I&#x2F;O æ“ä½œï¼Œå¹¶å°†å…¶è½¬å‘åˆ°å…¶ ChannelPipeline(ä¸šåŠ¡å¤„ç†é“¾)ä¸­çš„ä¸‹ä¸€ä¸ªå¤„ç†ç¨‹åºã€‚</p>
</li>
<li><p>ChannelHandler æœ¬èº«å¹¶æ²¡æœ‰æä¾›å¾ˆå¤šæ–¹æ³•ï¼Œå› ä¸ºè¿™ä¸ªæ¥å£æœ‰è®¸å¤šçš„æ–¹æ³•éœ€è¦å®ç°ï¼Œæ–¹ä¾¿ä½¿ç”¨æœŸé—´ï¼Œå¯ä»¥ç»§æ‰¿å®ƒçš„å­ç±»ã€‚</p>
</li>
<li><p>ChannelHandler åŠå…¶å®ç°ç±»ä¸€è§ˆå›¾</p>
</li>
</ol>
<p>![image-20220919130347051](C:\Java\Document\Netty\Netty å‚çœ‹æ–‡æ¡£.assets\image-20220919130347051.png)</p>
<p>ChannelInboundHandler 		ç”¨äºå¤„ç†å…¥ç«™ I&#x2F;O äº‹ä»¶ã€‚</p>
<p>ChannelOutboundHandler 		ç”¨äºå¤„ç†å‡ºç«™ I&#x2F;O æ“ä½œã€‚</p>
<p>ChannelInboundHandlerAdapter 		ç”¨äºå¤„ç†å…¥ç«™ I&#x2F;O äº‹ä»¶ã€‚</p>
<p>ChannelOutboundHandlerAdapter 	ç”¨äºå¤„ç†å‡ºç«™ I&#x2F;O æ“ä½œã€‚</p>
<p>ChannelDuplexHandler 		ç”¨äºå¤„ç†å…¥ç«™å’Œå‡ºç«™äº‹ä»¶ã€‚</p>
<p>4ï¼‰ç”¨æˆ·éœ€è¦è‡ªå®šä¹‰ä¸€ä¸ª Handler ç±»å»ç»§æ‰¿ ChannelInboundHandlerAdapterï¼Œç„¶åé‡å†™ç›¸åº”æ–¹æ³•å®ç°ä¸šåŠ¡é€»è¾‘ã€‚</p>
<p>â€‹	ç›¸å…³æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChannelInboundHandlerAdapter</span> <span class="keyword">extends</span> <span class="title class_">ChannelHandlerAdapter</span> <span class="keyword">implements</span> <span class="title class_">ChannelInboundHandler</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ChannelInboundHandlerAdapter</span><span class="params">()</span> &#123; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRegistered</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ctx.fireChannelRegistered();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelUnregistered</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ctx.fireChannelUnregistered();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é€šé“å°±ç»ªäº‹ä»¶</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ctx.fireChannelActive();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é€šé“æ–­å¼€æ—¶é—´</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelInactive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ctx.fireChannelInactive();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é€šé“è¯»å–æ•°æ®äº‹ä»¶</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ctx.fireChannelRead(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ•°æ®è¯»å–å®Œæ¯•äº‹ä»¶</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ctx.fireChannelReadComplete();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è§¦å‘ä¸‹ä¸€ä¸ªhandler</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">userEventTriggered</span><span class="params">(ChannelHandlerContext ctx, Object evt)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ctx.fireUserEventTriggered(evt);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelWritabilityChanged</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ctx.fireChannelWritabilityChanged();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//é€šé“å‘ç”Ÿå¼‚å¸¸äº‹ä»¶</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ctx.fireExceptionCaught(cause);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Pipeline-å’Œ-ChannelPipeline"><a href="#Pipeline-å’Œ-ChannelPipeline" class="headerlink" title="Pipeline å’Œ ChannelPipeline"></a>Pipeline å’Œ ChannelPipeline</h2><ol>
<li><p>ChannelPipeline æ˜¯ä¸€ä¸ª Handler çš„é›†åˆï¼Œå®ƒè´Ÿè´£å¤„ç†å’Œæ‹¦æˆª inbound æˆ–è€… outbound çš„äº‹ä»¶å’Œæ“ä½œï¼Œç›¸å½“äºä¸€ä¸ªè´¯ç©¿ Netty çš„é“¾ã€‚(ä¹Ÿå¯ä»¥è¿™æ ·ç†è§£ï¼š<strong>ChannelPipeline æ˜¯ ä¿å­˜ ChannelHandler çš„ List</strong>ï¼Œç”¨äºå¤„ç†æˆ–æ‹¦æˆª Channel çš„å…¥ç«™äº‹ä»¶å’Œå‡ºç«™æ“ä½œ)ã€‚</p>
</li>
<li><p>ChannelPipeline å®ç°äº†ä¸€ç§é«˜çº§å½¢å¼çš„æ‹¦æˆªè¿‡æ»¤å™¨æ¨¡å¼ï¼Œä½¿ç”¨æˆ·å¯ä»¥å®Œå…¨æ§åˆ¶äº‹ä»¶çš„å¤„ç†æ–¹å¼ï¼Œä»¥åŠ Channel ä¸­å„ä¸ªçš„ ChannelHandler å¦‚ä½•ç›¸äº’äº¤äº’ã€‚</p>
</li>
<li><p>åœ¨ Netty ä¸­æ¯ä¸ª Channel éƒ½æœ‰ä¸”ä»…æœ‰ä¸€ä¸ª ChannelPipeline ä¸ä¹‹å¯¹åº”ï¼Œå®ƒä»¬çš„ç»„æˆå…³ç³»å¦‚ä¸‹ï¼š</p>
 <img src="/2023/03/24/Netty/Java\Document\Netty\Netty å‚çœ‹æ–‡æ¡£.assets\image-20220919130911495.png" alt="image-20220919130911495" style="zoom:150%;">

<ul>
<li><p>ä¸€ä¸ª Channel åŒ…å«äº†ä¸€ä¸ª ChannelPipelineï¼Œè€Œ ChannelPipeline ä¸­åˆç»´æŠ¤äº†ä¸€ä¸ªç”± ChannelHandlerContext ç»„æˆçš„åŒå‘é“¾è¡¨ï¼Œå¹¶ä¸”æ¯ä¸ª ChannelHandlerContext ä¸­åˆå…³è”ç€ä¸€ä¸ª ChannelHandlerã€‚</p>
</li>
<li><p>å…¥ç«™äº‹ä»¶å’Œå‡ºç«™äº‹ä»¶åœ¨ä¸€ä¸ªåŒå‘é“¾è¡¨ä¸­ï¼Œå…¥ç«™äº‹ä»¶ä¼šä»é“¾è¡¨ head å¾€åä¼ é€’åˆ°æœ€åä¸€ä¸ªå…¥ç«™çš„ handlerï¼Œå‡ºç«™äº‹ä»¶ä¼šä»é“¾è¡¨ tail å¾€å‰ä¼ é€’åˆ°æœ€å‰ä¸€ä¸ªå‡ºç«™çš„ handlerï¼Œä¸¤ç§ç±»å‹çš„ handler äº’ä¸å¹²æ‰°ã€‚</p>
</li>
</ul>
</li>
</ol>
<p><strong>å¸¸ç”¨æ–¹æ³•</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æŠŠä¸€ä¸ªä¸šåŠ¡å¤„ç†ç±»ï¼ˆhandlerï¼‰æ·»åŠ åˆ°é“¾ä¸­çš„ç¬¬ä¸€ä¸ªä½ç½®</span></span><br><span class="line">ChannelPipeline <span class="title function_">addFirst</span><span class="params">(ChannelHandler... handlers)</span></span><br><span class="line"><span class="comment">//æŠŠä¸€ä¸ªä¸šåŠ¡å¤„ç†ç±»ï¼ˆhandlerï¼‰æ·»åŠ åˆ°é“¾ä¸­çš„æœ€åä¸€ä¸ªä½ç½®</span></span><br><span class="line">ChannelPipeline <span class="title function_">addLast</span><span class="params">(ChannelHandler... handlers)</span></span><br></pre></td></tr></table></figure>

<h2 id="ChannelHandlerContext"><a href="#ChannelHandlerContext" class="headerlink" title="ChannelHandlerContext"></a>ChannelHandlerContext</h2><ol>
<li><p>ä¿å­˜Channelç›¸å…³çš„æ‰€æœ‰ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ŒåŒæ—¶å…³è”ä¸€ä¸ªChannelHandlerå¯¹è±¡ã€‚</p>
</li>
<li><p>å³ChannelHandlerContextä¸­åŒ…å«ä¸€ä¸ªå…·ä½“çš„äº‹ä»¶å¤„ç†å™¨ChannelHandlerï¼ŒåŒæ—¶ChannelHandlerContextä¸­ä¹Ÿç»‘å®šäº†å¯¹åº”çš„</p>
</li>
</ol>
<p>â€‹		pipelineå’ŒChannelçš„ä¿¡æ¯ï¼Œæ–¹ä¾¿å¯¹ChannelHandlerè¿›è¡Œè°ƒç”¨ã€‚</p>
<ol start="3">
<li>å¸¸ç”¨æ–¹æ³•</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ChannelFuture <span class="title function_">close</span><span class="params">()</span> 	å…³é—­é€šé“</span><br><span class="line">ChannelOutboundInvoker <span class="title function_">flush</span><span class="params">()</span> 	åˆ·æ–°</span><br><span class="line">ChannelFuture <span class="title function_">writeAndFlush</span><span class="params">(Object msg)</span> å°†æ•°æ®å†™åˆ°ChannelPipelineä¸­å½“å‰ChannelHandlerçš„ä¸‹ä¸€ä¸ªChannelHandlerå¼€å§‹å¤„ç†ï¼ˆå‡ºç«™ï¼‰ã€‚</span><br></pre></td></tr></table></figure>

<h2 id="ChannelOption"><a href="#ChannelOption" class="headerlink" title="ChannelOption"></a>ChannelOption</h2><p>Netty åœ¨åˆ›å»º Channel å®ä¾‹åï¼Œä¸€èˆ¬éƒ½éœ€è¦è®¾ç½® ChannelOption å‚æ•°ã€‚</p>
<p>ChannelOption å‚æ•°å¦‚ä¸‹ï¼š</p>
<p>ChannelOption.SO_BACKLOG</p>
<p>â€‹	å¯¹åº” TCP&#x2F;IP åè®® listen å‡½æ•°ä¸­çš„ backlog å‚æ•°ï¼Œç”¨æ¥åˆå§‹åŒ–æœåŠ¡å™¨å¯è¿æ¥é˜Ÿåˆ—å¤§å°ã€‚æœåŠ¡ç«¯å¤„ç†å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚æ˜¯é¡ºåºå¤„ç†çš„ï¼Œæ‰€ä»¥åŒä¸€æ—¶é—´åªèƒ½å¤„ç†ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥ã€‚å¤šä¸ªå®¢æˆ·ç«¯æ¥çš„æ—¶å€™ï¼ŒæœåŠ¡ç«¯å°†ä¸èƒ½å¤„ç†çš„å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚æ”¾åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…å¤„ç†ï¼Œbacklog å‚æ•°æŒ‡å®šäº†é˜Ÿåˆ—çš„å¤§å°ã€‚</p>
<p>ChannelOption.SO_KEEPALIVEï¼š ä¸€ç›´ä¿æŒè¿æ¥æ´»åŠ¨çŠ¶æ€ã€‚</p>
<h2 id="EventLoopGroup-åŠ-NioEventLoopGroup"><a href="#EventLoopGroup-åŠ-NioEventLoopGroup" class="headerlink" title="EventLoopGroup åŠ NioEventLoopGroup"></a>EventLoopGroup åŠ NioEventLoopGroup</h2><ol>
<li>EventLoopGroup æ˜¯ä¸€ç»„ EventLoop çš„æŠ½è±¡ï¼ŒNetty ä¸ºäº†æ›´å¥½çš„åˆ©ç”¨å¤šæ ¸ CPU èµ„æºï¼Œä¸€èˆ¬ä¼šæœ‰å¤šä¸ª EventLoop åŒæ—¶å·¥ä½œï¼Œæ¯ä¸ª</li>
</ol>
<p>â€‹		EventLoop ç»´æŠ¤ç€ä¸€ä¸ª Selector å®ä¾‹ã€‚</p>
<ol start="2">
<li>EventLoopGroup æä¾› next æ¥å£ï¼Œå¯ä»¥ä»ç»„é‡Œé¢æŒ‰ç…§ä¸€å®šè§„åˆ™è·å–å…¶ä¸­ä¸€ä¸ª EventLoopæ¥å¤„ç†ä»»åŠ¡ã€‚åœ¨ Netty æœåŠ¡å™¨ç«¯ç¼–ç¨‹ä¸­ï¼Œ</li>
</ol>
<p>â€‹		ä¸€èˆ¬éƒ½éœ€è¦æä¾›ä¸¤ä¸ª EventLoopGroupï¼Œä¾‹å¦‚ï¼šBossEventLoopGroup å’Œ WorkerEventLoopGroupã€‚</p>
<ol start="3">
<li>é€šå¸¸ä¸€ä¸ªæœåŠ¡ç«¯å£å³ä¸€ä¸ª ServerSocketChannelå¯¹åº”ä¸€ä¸ªSelector å’Œä¸€ä¸ªEventLoopçº¿ç¨‹ã€‚BossEventLoop è´Ÿè´£æ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥</li>
</ol>
<p>â€‹		å¹¶å°† SocketChannel äº¤ç»™ WorkerEventLoopGroup æ¥è¿›è¡Œ IO å¤„ç†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<img src="/2023/03/24/Netty/Java\Document\Netty\Netty å‚çœ‹æ–‡æ¡£.assets\image-20220919133039295.png" alt="image-20220919133039295" style="zoom:150%;">

<p>è¯´æ˜ï¼š</p>
<ol>
<li><p>BossEventLoopGroup é€šå¸¸æ˜¯ä¸€ä¸ªå•çº¿ç¨‹çš„ EventLoopï¼ŒEventLoop ç»´æŠ¤ç€ä¸€ä¸ªæ³¨å†Œäº†ServerSocketChannel çš„ Selector å®ä¾‹BossEventLoop ä¸æ–­è½®è¯¢ Selector å°†è¿æ¥äº‹ä»¶åˆ†ç¦»å‡ºæ¥ã€‚</p>
</li>
<li><p>é€šå¸¸æ˜¯ OP_ACCEPT äº‹ä»¶ï¼Œç„¶åå°†æ¥æ”¶åˆ°çš„ SocketChannel äº¤ç»™ WorkerEventLoopGroupã€‚</p>
</li>
<li><p>WorkerEventLoopGroup ä¼šç”± next é€‰æ‹©å…¶ä¸­ä¸€ä¸ª EventLoopæ¥å°†è¿™ä¸ª SocketChannel æ³¨å†Œåˆ°å…¶ç»´æŠ¤çš„ Selector å¹¶å¯¹å…¶åç»­çš„ IO äº‹ä»¶è¿›è¡Œå¤„ç†ã€‚</p>
</li>
</ol>
<p>å¸¸ç”¨æ–¹æ³•</p>
<p>public NioEventLoopGroup()   æ„é€ æ–¹æ³•</p>
<p>public Future&lt;?&gt; shutdownGracefully()    æ–­å¼€è¿æ¥ï¼Œå…³é—­çº¿ç¨‹ã€‚</p>
<h2 id="Unpooled-ç±»"><a href="#Unpooled-ç±»" class="headerlink" title="Unpooled ç±»"></a>Unpooled ç±»</h2><ol>
<li><p>Netty æä¾›ä¸€ä¸ªä¸“é—¨ç”¨æ¥æ“ä½œç¼“å†²åŒº(å³Nettyçš„æ•°æ®å®¹å™¨)çš„å·¥å…·ç±»ã€‚</p>
</li>
<li><p>å¸¸ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š</p>
</li>
</ol>
<p>â€‹		&#x2F;&#x2F; é€šè¿‡ç»™å®šçš„æ•°æ®å’Œå­—ç¬¦ç¼–ç è¿”å›ä¸€ä¸ª ByteBuf å¯¹è±¡ï¼ˆç±»ä¼¼äº NIO ä¸­çš„ ByteBuffer ä½†æœ‰åŒºåˆ«ï¼‰</p>
<p>â€‹		public static ByteBuf copiedBuffer(CharSequence string, Charset charset)</p>
<p>â€‹		ByteBuf buffer &#x3D; Unpooled.buffer(10);	&#x2F;&#x2F; åˆ›å»ºå®¹é‡ä¸º10çš„buffer</p>
<p>3ï¼‰Unpooled è·å– Nettyçš„æ•°æ®å®¹å™¨ByteBufï¼š</p>
<img src="/2023/03/24/Netty/Java\Document\Netty\Netty å‚çœ‹æ–‡æ¡£.assets\image-20220919133244906.png" alt="image-20220919133244906" style="zoom:150%;">

<ol>
<li><p>åœ¨nettyçš„bufferä¸­ï¼Œä¸éœ€è¦ä½¿ç”¨flip è¿›è¡Œåè½¬ã€‚</p>
</li>
<li><p>åº•å±‚ç»´æŠ¤äº†readerindex å’Œ writerIndexã€‚</p>
</li>
<li><p>é€šè¿‡readerindexå’ŒwriterIndex å’Œcapacityï¼Œå°†bufferåˆ†æˆä¸‰ä¸ªåŒºåŸŸã€‚</p>
<p> 0 â€” readerindex   		å·²ç»è¯»å–çš„åŒºåŸŸ</p>
<p> readerindex â€” writerIndex  		å¯è¯»çš„åŒºåŸŸ</p>
<p> writerIndex â€” capacity  		å¯å†™çš„åŒºåŸŸ</p>
</li>
</ol>
<p>ä½¿ç”¨ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testByteBuf01</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ByteBuf</span> <span class="variable">buffer</span> <span class="operator">=</span> Unpooled.buffer(<span class="number">5</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; buffer.capacity(); i++) &#123;</span><br><span class="line">        buffer.writeByte(i);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;capacity: &quot;</span> + buffer.capacity());</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; buffer.capacity(); i++) &#123;</span><br><span class="line">        <span class="comment">// System.out.println(buffer.getByte(i));</span></span><br><span class="line">        System.out.println(buffer.readByte());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testByteBuf02</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ByteBuf</span> <span class="variable">byteBuf</span> <span class="operator">=</span> Unpooled.copiedBuffer(<span class="string">&quot;hello,world!&quot;</span>, Charset.forName(<span class="string">&quot;utf-8&quot;</span>));</span><br><span class="line">    <span class="keyword">if</span> (byteBuf.hasArray()) &#123;</span><br><span class="line">        <span class="type">byte</span>[] array = byteBuf.array();</span><br><span class="line">        System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(array, StandardCharsets.UTF_8)); <span class="comment">//hello,world!</span></span><br><span class="line">        System.out.println(<span class="string">&quot;byteBuf&quot;</span> + byteBuf);</span><br><span class="line">        <span class="comment">//byteBufUnpooledByteBufAllocator$InstrumentedUnpooledUnsafeHeapByteBuf(ridx: 0, widx: 12, cap: 36)</span></span><br><span class="line">        System.out.println(byteBuf.arrayOffset()); <span class="comment">//0</span></span><br><span class="line">        System.out.println(byteBuf.readerIndex()); <span class="comment">//0</span></span><br><span class="line">        System.out.println(byteBuf.writerIndex()); <span class="comment">//12</span></span><br><span class="line">        System.out.println(byteBuf.capacity()); <span class="comment">//36</span></span><br><span class="line">        System.out.println(byteBuf.getByte(<span class="number">0</span>)); <span class="comment">//104</span></span><br><span class="line">        System.out.println(byteBuf.readableBytes()); <span class="comment">//12</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; byteBuf.readableBytes(); i++) &#123;</span><br><span class="line">            System.out.println((<span class="type">char</span>) byteBuf.getByte(i)); <span class="comment">//h e l l o ,.....</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//index , length, charset</span></span><br><span class="line">        System.out.println(byteBuf.getCharSequence(<span class="number">0</span>, <span class="number">4</span>, StandardCharsets.UTF_8));<span class="comment">//hello</span></span><br><span class="line">        System.out.println(byteBuf.getCharSequence(<span class="number">4</span>, <span class="number">6</span>, Charset.forName(<span class="string">&quot;utf-8&quot;</span>)));<span class="comment">//o,worl</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Nettyåº”ç”¨å®ä¾‹-ç¾¤èŠç³»ç»Ÿ"><a href="#Nettyåº”ç”¨å®ä¾‹-ç¾¤èŠç³»ç»Ÿ" class="headerlink" title="Nettyåº”ç”¨å®ä¾‹-ç¾¤èŠç³»ç»Ÿ"></a>Nettyåº”ç”¨å®ä¾‹-ç¾¤èŠç³»ç»Ÿ</h2><p>ç¨‹åºè¦æ±‚ï¼šå®ç°æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯ä¹‹é—´çš„æ•°æ®ç®€å•é€šè®¯ï¼ˆéé˜»å¡ï¼‰</p>
<p>GroupChatServerï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.netty.groupchat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.ServerBootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelFuture;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInitializer;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelOption;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.string.StringDecoder;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.string.StringEncoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GroupChatServer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> port;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GroupChatServer</span><span class="params">(<span class="type">int</span> port)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.port = port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">listenGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">handlerGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServerBootstrap</span> <span class="variable">serverBootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">            serverBootstrap</span><br><span class="line">                    .group(listenGroup, handlerGroup)</span><br><span class="line">                    .channel(NioServerSocketChannel.class)</span><br><span class="line">                    .option(ChannelOption.SO_BACKLOG, <span class="number">128</span>)</span><br><span class="line">                    .childOption(ChannelOption.SO_KEEPALIVE, <span class="literal">true</span>)</span><br><span class="line">                    .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            socketChannel.pipeline()</span><br><span class="line">                                    .addLast(<span class="string">&quot;StringDecoder&quot;</span>, <span class="keyword">new</span> <span class="title class_">StringDecoder</span>())</span><br><span class="line">                                    .addLast(<span class="string">&quot;StringEncoder&quot;</span>, <span class="keyword">new</span> <span class="title class_">StringEncoder</span>())</span><br><span class="line">                                    .addLast(<span class="string">&quot;GroupChatServerHandler&quot;</span>, <span class="keyword">new</span> <span class="title class_">GroupChatServerHandler</span>());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">channelFuture</span> <span class="operator">=</span> serverBootstrap.bind(port).sync();</span><br><span class="line">            System.out.println(<span class="string">&quot;GroupServer Start...&quot;</span>);</span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            listenGroup.shutdownGracefully();</span><br><span class="line">            handlerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">GroupChatServer</span>(<span class="number">8000</span>).run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>GroupChatServerHandlerï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.netty.groupchat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.channel.Channel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInboundHandlerAdapter;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.group.ChannelGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.group.DefaultChannelGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.util.concurrent.GlobalEventExecutor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GroupChatServerHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;String&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        ç¾¤èŠï¼š</span></span><br><span class="line"><span class="comment">        ç§èŠï¼šä½¿ç”¨ä¸€ä¸ªMapç®¡ç†å¤šä¸ª Channel</span></span><br><span class="line"><span class="comment">        ç¾¤èŠæ–¹å¼ä¸€ï¼šå®šä¹‰ä¸€ä¸ªListç®¡ç†æ‰€æœ‰ Channel</span></span><br><span class="line"><span class="comment">        ç¾¤èŠæ–¹å¼äºŒï¼šå®šä¹‰ä¸€ä¸ª channel ç»„ï¼Œç®¡ç†æ‰€æœ‰çš„channel</span></span><br><span class="line"><span class="comment">        GlobalEventExecutor.INSTANCE) æ˜¯å…¨å±€çš„äº‹ä»¶æ‰§è¡Œå™¨ï¼Œæ˜¯ä¸€ä¸ªå•ä¾‹</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">ChannelGroup</span> <span class="variable">channelGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultChannelGroup</span>(GlobalEventExecutor.INSTANCE);</span><br><span class="line">    <span class="type">SimpleDateFormat</span> <span class="variable">sdf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd hh:mm:ss&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//handlerAdded è¡¨ç¤ºè¿æ¥å»ºç«‹ï¼Œä¸€æ—¦è¿æ¥ï¼Œç¬¬ä¸€ä¸ªè¢«æ‰§è¡Œ</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handlerAdded</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> ctx.channel();</span><br><span class="line">        <span class="comment">// è¯¥æ–¹æ³•ä¼šéå†æ‰€æœ‰çš„channelï¼Œå°†è¯¥ Channel åŠ å…¥ChannelGroupå‰ï¼Œéå†</span></span><br><span class="line">        channelGroup.writeAndFlush(<span class="string">&quot;[å®¢æˆ·ç«¯ï¼š]&quot;</span> + channel.remoteAddress() + <span class="string">&quot; åŠ å…¥èŠå¤© &quot;</span> + sdf.format(<span class="keyword">new</span> <span class="title class_">Date</span>()) + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        channelGroup.add(channel);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ–­å¼€è¿æ¥, å°†å®¢æˆ·ç«¯ç¦»å¼€ä¿¡æ¯æ¨é€ç»™å½“å‰åœ¨çº¿çš„å®¢æˆ·</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handlerRemoved</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> ctx.channel();</span><br><span class="line">        System.out.println(<span class="string">&quot;[å®¢æˆ·ç«¯ï¼š]&quot;</span> + channel.remoteAddress() + <span class="string">&quot; ç¦»å¼€äº†\n&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;GroupChannelSize: &quot;</span> + channelGroup.size());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¡¨ç¤ºchannelå¤„äºä¸æ´»åŠ¨çš„çŠ¶æ€ï¼Œæç¤ºXXç¦»çº¿äº†</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelInactive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(ctx.channel().remoteAddress() + <span class="string">&quot; ç¦»çº¿äº†\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¡¨ç¤ºchannelå¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œæç¤ºXXä¸Šçº¿äº†</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(ctx.channel().remoteAddress() + <span class="string">&quot; ä¸Šçº¿äº†&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, String msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> ctx.channel();</span><br><span class="line">        channelGroup.forEach(ch -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (channel != ch) &#123;</span><br><span class="line">                ch.writeAndFlush(<span class="string">&quot;å®¢æˆ·ç«¯ï¼š&quot;</span> + channel.remoteAddress() + <span class="string">&quot; å‘é€äº†æ¶ˆæ¯ï¼š &quot;</span> + msg + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ch.writeAndFlush(<span class="string">&quot;è‡ªå·±å‘é€äº†æ¶ˆæ¯ï¼š&quot;</span> + msg + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>GroupChatClientï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.netty.groupchat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.Bootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.Channel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelFuture;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInitializer;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelPipeline;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioSocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.string.StringDecoder;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.string.StringEncoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GroupChatClient</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> port;</span><br><span class="line">    <span class="keyword">private</span> String ip;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GroupChatClient</span><span class="params">(String ip, <span class="type">int</span> port)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.port = port;</span><br><span class="line">        <span class="built_in">this</span>.ip = ip;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">group</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>().group(group)</span><br><span class="line">                    .channel(NioSocketChannel.class)</span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            <span class="type">ChannelPipeline</span> <span class="variable">pipeline</span> <span class="operator">=</span> ch.pipeline();</span><br><span class="line">                            pipeline.addLast(<span class="string">&quot;StringDecoder&quot;</span>, <span class="keyword">new</span> <span class="title class_">StringDecoder</span>());</span><br><span class="line">                            pipeline.addLast(<span class="string">&quot;StringEncoder&quot;</span>, <span class="keyword">new</span> <span class="title class_">StringEncoder</span>());</span><br><span class="line">                            pipeline.addLast(<span class="keyword">new</span> <span class="title class_">GroupChatClientHandler</span>());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            <span class="comment">//å»ºç«‹è¿æ¥</span></span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">channelFuture</span> <span class="operator">=</span> bootstrap.connect(ip, port).sync();</span><br><span class="line">            <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> channelFuture.channel();</span><br><span class="line">            System.out.println(channel.localAddress() + <span class="string">&quot; start...&quot;</span>);</span><br><span class="line">            <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">            <span class="keyword">while</span> (scanner.hasNextLine()) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> scanner.nextLine();</span><br><span class="line">                channel.writeAndFlush(msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            group.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">GroupChatClient</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8000</span>).run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>GroupChatClientHandlerï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.netty.groupchat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GroupChatClientHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;String&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext channelHandlerContext, String s)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(s.trim());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Netty-å¿ƒè·³æ£€æµ‹æœºåˆ¶"><a href="#Netty-å¿ƒè·³æ£€æµ‹æœºåˆ¶" class="headerlink" title="Netty å¿ƒè·³æ£€æµ‹æœºåˆ¶"></a>Netty å¿ƒè·³æ£€æµ‹æœºåˆ¶</h2><p>ç¨‹åºè¦æ±‚ï¼š</p>
<ol>
<li><p>ç¼–å†™ä¸€ä¸ª Nettyå¿ƒè·³æ£€æµ‹æœºåˆ¶æ¡ˆä¾‹, å½“æœåŠ¡å™¨è¶…è¿‡3ç§’æ²¡æœ‰è¯»æ—¶ï¼Œå°±æç¤ºè¯»ç©ºé—²ã€‚</p>
</li>
<li><p>å½“æœåŠ¡å™¨è¶…è¿‡5ç§’æ²¡æœ‰å†™æ“ä½œæ—¶ï¼Œå°±æç¤ºå†™ç©ºé—²ã€‚</p>
</li>
<li><p><strong>ä½¿ç”¨å®¢æˆ·ç«¯è¿æ¥</strong>ï¼Œå¦‚æœæœåŠ¡å™¨è¶…è¿‡7ç§’æ²¡æœ‰è¯»æˆ–è€…å†™æ“ä½œæ—¶ï¼Œå°±æç¤ºè¯»å†™ç©ºé—²ã€‚</p>
</li>
</ol>
<p>HeartBeatServerï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.netty.heartbeat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.ServerBootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelFuture;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInitializer;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelPipeline;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.logging.LogLevel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.logging.LoggingHandler;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.timeout.IdleStateHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HeartBeatServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">bossGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">workerGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServerBootstrap</span> <span class="variable">serverBootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">            serverBootstrap.group(bossGroup, workerGroup).channel(NioServerSocketChannel.class)</span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.INFO))</span><br><span class="line">                    .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            <span class="type">ChannelPipeline</span> <span class="variable">pipeline</span> <span class="operator">=</span> ch.pipeline();</span><br><span class="line">                            <span class="comment">//åŠ å…¥ä¸€ä¸ªnetty æä¾› IdleStateHandler</span></span><br><span class="line">                            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                            è¯´æ˜</span></span><br><span class="line"><span class="comment">                            1. IdleStateHandler æ˜¯netty æä¾›çš„å¤„ç†ç©ºé—²çŠ¶æ€çš„å¤„ç†å™¨</span></span><br><span class="line"><span class="comment">                            2. long readerIdleTime : è¡¨ç¤ºå¤šé•¿æ—¶é—´æ²¡æœ‰è¯», å°±ä¼šå‘é€ä¸€ä¸ªå¿ƒè·³æ£€æµ‹åŒ…æ£€æµ‹æ˜¯å¦è¿æ¥</span></span><br><span class="line"><span class="comment">                            3. long writerIdleTime : è¡¨ç¤ºå¤šé•¿æ—¶é—´æ²¡æœ‰å†™, å°±ä¼šå‘é€ä¸€ä¸ªå¿ƒè·³æ£€æµ‹åŒ…æ£€æµ‹æ˜¯å¦è¿æ¥</span></span><br><span class="line"><span class="comment">                            4. long allIdleTime : è¡¨ç¤ºå¤šé•¿æ—¶é—´æ²¡æœ‰è¯»å†™, å°±ä¼šå‘é€ä¸€ä¸ªå¿ƒè·³æ£€æµ‹åŒ…æ£€æµ‹æ˜¯å¦è¿æ¥</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                            5. æ–‡æ¡£è¯´æ˜</span></span><br><span class="line"><span class="comment">                            triggers an &#123;@link IdleStateEvent&#125; when a &#123;@link Channel&#125; has not performed read, write, or both operation for a while.</span></span><br><span class="line"><span class="comment">                             6. å½“ IdleStateEvent è§¦å‘å , å°±ä¼šä¼ é€’ç»™ç®¡é“ çš„ä¸‹ä¸€ä¸ªhandlerå»å¤„ç†</span></span><br><span class="line"><span class="comment">                             é€šè¿‡è°ƒç”¨(è§¦å‘)ä¸‹ä¸€ä¸ªhandler çš„ userEventTriggered , åœ¨è¯¥æ–¹æ³•ä¸­å»å¤„ç† IdleStateEvent(è¯»ç©ºé—²ï¼Œå†™ç©ºé—²ï¼Œè¯»å†™ç©ºé—²)</span></span><br><span class="line"><span class="comment">                             */</span></span><br><span class="line">                            pipeline.addLast(<span class="keyword">new</span> <span class="title class_">IdleStateHandler</span>(<span class="number">5</span>, <span class="number">7</span>, <span class="number">3</span>, TimeUnit.SECONDS));</span><br><span class="line">                            pipeline.addLast(<span class="keyword">new</span> <span class="title class_">HeartBeatHandler</span>());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">channelFuture</span> <span class="operator">=</span> serverBootstrap.bind(<span class="number">8000</span>).sync();</span><br><span class="line">            System.out.println(<span class="string">&quot;HeartBeat Server Start...&quot;</span>);</span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>HeartBeatHandlerï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.netty.heartbeat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInboundHandlerAdapter;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.timeout.IdleStateEvent;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HeartBeatHandler</span> <span class="keyword">extends</span> <span class="title class_">ChannelInboundHandlerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">userEventTriggered</span><span class="params">(ChannelHandlerContext ctx, Object evt)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (evt <span class="keyword">instanceof</span> IdleStateEvent) &#123;</span><br><span class="line">            <span class="type">IdleStateEvent</span> <span class="variable">event</span> <span class="operator">=</span> (IdleStateEvent) evt;</span><br><span class="line">            <span class="type">String</span> <span class="variable">eventType</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">switch</span> (event.state()) &#123;</span><br><span class="line">                <span class="keyword">case</span> READER_IDLE:</span><br><span class="line">                    eventType = <span class="string">&quot;è¯»ç©ºé—²&quot;</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> WRITER_IDLE:</span><br><span class="line">                    eventType = <span class="string">&quot;å†™ç©ºé—²&quot;</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> ALL_IDLE:</span><br><span class="line">                    eventType = <span class="string">&quot;è¯»å†™ç©ºé—²&quot;</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(ctx.channel().remoteAddress() + <span class="string">&quot;...è¶…æ—¶æ—¶é—´...&quot;</span> + eventType);</span><br><span class="line">            <span class="comment">// å¦‚æœå‘ç”Ÿç©ºé—²ï¼Œå…³é—­é€šé“</span></span><br><span class="line">            <span class="comment">// ctx.channel().close();</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>HeartBeatClientï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.netty.heartbeat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.mineting.netty.groupchat.GroupChatClientHandler;</span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.Bootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.Channel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelFuture;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInitializer;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelPipeline;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioSocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.string.StringDecoder;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.string.StringEncoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HeartBeatClient</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> port;</span><br><span class="line">    <span class="keyword">private</span> String ip;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HeartBeatClient</span><span class="params">(String ip, <span class="type">int</span> port)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.port = port;</span><br><span class="line">        <span class="built_in">this</span>.ip = ip;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">group</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>().group(group)</span><br><span class="line">                    .channel(NioSocketChannel.class)</span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            <span class="type">ChannelPipeline</span> <span class="variable">pipeline</span> <span class="operator">=</span> ch.pipeline();</span><br><span class="line">                            pipeline.addLast(<span class="string">&quot;StringDecoder&quot;</span>, <span class="keyword">new</span> <span class="title class_">StringDecoder</span>());</span><br><span class="line">                            pipeline.addLast(<span class="string">&quot;StringEncoder&quot;</span>, <span class="keyword">new</span> <span class="title class_">StringEncoder</span>());</span><br><span class="line">                            pipeline.addLast(<span class="keyword">new</span> <span class="title class_">GroupChatClientHandler</span>());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            <span class="comment">//å»ºç«‹è¿æ¥</span></span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">channelFuture</span> <span class="operator">=</span> bootstrap.connect(ip, port).sync();</span><br><span class="line">            <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> channelFuture.channel();</span><br><span class="line">            System.out.println(channel.localAddress() + <span class="string">&quot; start...&quot;</span>);</span><br><span class="line">            <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">            <span class="keyword">while</span> (scanner.hasNextLine()) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> scanner.nextLine();</span><br><span class="line">                channel.writeAndFlush(msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            group.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">HeartBeatClient</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8000</span>).run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Netty-WebSocketé•¿è¿æ¥"><a href="#Netty-WebSocketé•¿è¿æ¥" class="headerlink" title="Netty WebSocketé•¿è¿æ¥"></a>Netty WebSocketé•¿è¿æ¥</h2><p>ç¨‹åºè¦æ±‚ï¼šå®ç°åŸºäºwebSocketçš„é•¿è¿æ¥çš„å…¨åŒå·¥çš„äº¤äº’ï¼Œå®¢æˆ·ç«¯æµè§ˆå™¨å’ŒæœåŠ¡å™¨ç«¯ä¼šç›¸äº’æ„ŸçŸ¥ï¼ŒæœåŠ¡å™¨å¯ä»¥å‘é€æ¶ˆæ¯ç»™æµè§ˆå™¨ã€‚</p>
<p>WebSocketServerï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.netty.websocket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.ServerBootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelFuture;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInitializer;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelOption;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelPipeline;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.HttpObjectAggregator;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.HttpServerCodec;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.websocketx.WebSocketServerProtocolHandler;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.logging.LogLevel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.logging.LoggingHandler;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.stream.ChunkedWriteHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">listenGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">handlerGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServerBootstrap</span> <span class="variable">serverBootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">            serverBootstrap.group(listenGroup, handlerGroup)</span><br><span class="line">                    .channel(NioServerSocketChannel.class)</span><br><span class="line">                    .option(ChannelOption.SO_BACKLOG, <span class="number">128</span>)</span><br><span class="line">                    .childOption(ChannelOption.SO_KEEPALIVE, <span class="literal">true</span>)</span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.INFO))</span><br><span class="line">                    .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            <span class="type">ChannelPipeline</span> <span class="variable">channel</span> <span class="operator">=</span> socketChannel.pipeline();</span><br><span class="line">                            <span class="comment">// åŸºäºhttpåè®®ï¼Œä½¿ç”¨httpçš„ç¼–ç å’Œè§£ç å™¨</span></span><br><span class="line">                            channel.addLast(<span class="keyword">new</span> <span class="title class_">HttpServerCodec</span>());</span><br><span class="line">                            <span class="comment">// æ˜¯ä»¥å—æ–¹å¼å†™ï¼Œæ·»åŠ ChunkedWriteHandlerå¤„ç†å™¨</span></span><br><span class="line">                            channel.addLast(<span class="keyword">new</span> <span class="title class_">ChunkedWriteHandler</span>());</span><br><span class="line">                            <span class="comment">// httpæ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æ˜¯åˆ†æ®µ, HttpObjectAggregator ï¼Œå°±æ˜¯å¯ä»¥å°†å¤šä¸ªæ®µèšåˆ</span></span><br><span class="line">                            <span class="comment">// å½“æµè§ˆå™¨å‘é€å¤§é‡æ•°æ®æ—¶ï¼Œå°±ä¼šå‘å‡ºå¤šæ¬¡httpè¯·æ±‚</span></span><br><span class="line">                            channel.addLast(<span class="keyword">new</span> <span class="title class_">HttpObjectAggregator</span>(<span class="number">8192</span>));</span><br><span class="line">                            <span class="comment">// å¯¹åº”websocket ï¼Œå®ƒçš„æ•°æ®æ˜¯ä»¥ å¸§(frame) å½¢å¼ä¼ é€’</span></span><br><span class="line">                            <span class="comment">// æµè§ˆå™¨è¯·æ±‚æ—¶ ws://localhost:7000/hello è¡¨ç¤ºè¯·æ±‚çš„uri</span></span><br><span class="line">                            <span class="comment">// WebSocketServerProtocolHandler æ ¸å¿ƒåŠŸèƒ½æ˜¯å°† httpåè®®å‡çº§ä¸º wsåè®® , ä¿æŒé•¿è¿æ¥</span></span><br><span class="line">                            channel.addLast(<span class="keyword">new</span> <span class="title class_">WebSocketServerProtocolHandler</span>(<span class="string">&quot;/ws01&quot;</span>));</span><br><span class="line">                            <span class="comment">// è‡ªå®šä¹‰çš„handler ï¼Œå¤„ç†ä¸šåŠ¡é€»è¾‘, å‰å°é€šè¿‡ textarea æäº¤æ•°æ®</span></span><br><span class="line">                            channel.addLast(<span class="keyword">new</span> <span class="title class_">MyTextWebSocketFrameHandler</span>());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">channelFuture</span> <span class="operator">=</span> serverBootstrap.bind(<span class="number">8000</span>).sync();</span><br><span class="line">            System.out.println(<span class="string">&quot;WebSocket Server Start....&quot;</span>);</span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            listenGroup.shutdownGracefully();</span><br><span class="line">            handlerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MyTextWebSocketFrameHandlerï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.netty.websocket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.websocketx.TextWebSocketFrame;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * TextWebSocketFrame: è¡¨ç¤ºä¸€ä¸ªæ–‡æœ¬å¸§</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyTextWebSocketFrameHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;TextWebSocketFrame&gt; &#123;</span><br><span class="line">    <span class="comment">// æœ‰æ•°æ®è¯»å†™æ—¶è§¦å‘</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, TextWebSocketFrame textFrame)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;WebSocket Server: &quot;</span> + textFrame.text());</span><br><span class="line">        ctx.writeAndFlush(<span class="keyword">new</span> <span class="title class_">TextWebSocketFrame</span>(<span class="string">&quot;WebSocket Server: &quot;</span> + LocalDateTime.now() + <span class="string">&quot; &quot;</span> + textFrame.text()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å½“å®¢æˆ·ç«¯è¿æ¥æ—¶è§¦å‘</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handlerAdded</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;handlerAdded: &quot;</span> + ctx.channel().id().asLongText());</span><br><span class="line">        System.out.println(<span class="string">&quot;handlerAdded: &quot;</span> + ctx.channel().id().asShortText());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å½“å®¢æˆ·ç«¯è¿æ¥æ—¶è§¦å‘</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handlerRemoved</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;handlerRemoved: &quot;</span> + ctx.channel().id().asShortText());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;å¼‚å¸¸å‘ç”Ÿ &quot;</span> + cause.getMessage());</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ws.htmlï¼š</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// æ³¨æ„ä½¿ç”¨ var ç»™ window æ·»åŠ å±æ€§ï¼Œè€Œä¸æ˜¯let</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> socket;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// åˆ¤æ–­æµè§ˆå™¨æ˜¯å¦æ”¯æŒWebSocket</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">WebSocket</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            socket = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">&quot;ws://localhost:8000/ws01&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// æ”¶åˆ°æœåŠ¡å™¨å›å¤çš„æ¶ˆæ¯</span></span></span><br><span class="line"><span class="language-javascript">            socket.<span class="property">onmessage</span> = <span class="keyword">function</span> (<span class="params">ev</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> ret = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;responseText&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">                ret.<span class="property">value</span> = ret.<span class="property">value</span> + <span class="string">&quot;\n&quot;</span> + ev.<span class="property">data</span></span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// è¿æ¥å°±ç»ª</span></span></span><br><span class="line"><span class="language-javascript">            socket.<span class="property">onopen</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> ret = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;responseText&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">                ret.<span class="property">value</span> = <span class="string">&quot;è¿æ¥å°±ç»ª...&quot;</span></span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// è¿æ¥å…³é—­</span></span></span><br><span class="line"><span class="language-javascript">            socket.<span class="property">onclose</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> ret = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;responseText&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">                ret.<span class="property">value</span> = ret.<span class="property">value</span> + <span class="string">&quot;\n&quot;</span> + <span class="string">&quot;è¿æ¥æ–­å¼€&quot;</span></span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">alert</span>(<span class="string">&quot;å½“å‰æµè§ˆå™¨ä¸æ”¯æŒWebSocket&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">send</span>(<span class="params">message</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// socketæ˜¯å¦åˆ›å»ºå¥½</span></span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">window</span>.<span class="property">socket</span>)</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (!<span class="variable language_">window</span>.<span class="property">socket</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">return</span></span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (socket.<span class="property">readyState</span> == <span class="title class_">WebSocket</span>.<span class="property">OPEN</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                socket.<span class="title function_">send</span>(message)</span></span><br><span class="line"><span class="language-javascript">            &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">alert</span>(<span class="string">&quot;è¿æ¥æ²¡æœ‰å¼€å¯&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">onsubmit</span>=<span class="string">&quot;return false&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">name</span>=<span class="string">&quot;message&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:300px;height:300px&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">value</span>=<span class="string">&quot;å‘é€æ¶ˆæ¯&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;send(this.form.message.value)&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">id</span>=<span class="string">&quot;responseText&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:300px;height: 300px&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;document.getElementById(&#x27;responseText&#x27;).value = &#x27;&#x27;&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h1 id="Google-Protobufï¼ˆç•¥ï¼‰"><a href="#Google-Protobufï¼ˆç•¥ï¼‰" class="headerlink" title="Google Protobufï¼ˆç•¥ï¼‰"></a>Google Protobufï¼ˆç•¥ï¼‰</h1><h1 id="Nettyç¼–è§£ç å™¨å’Œhandlerçš„è°ƒç”¨æœºåˆ¶"><a href="#Nettyç¼–è§£ç å™¨å’Œhandlerçš„è°ƒç”¨æœºåˆ¶" class="headerlink" title="Nettyç¼–è§£ç å™¨å’Œhandlerçš„è°ƒç”¨æœºåˆ¶"></a>Nettyç¼–è§£ç å™¨å’Œhandlerçš„è°ƒç”¨æœºåˆ¶</h1><h1 id="TCP-ç²˜åŒ…å’Œæ‹†åŒ…åŠè§£å†³æ–¹æ¡ˆ"><a href="#TCP-ç²˜åŒ…å’Œæ‹†åŒ…åŠè§£å†³æ–¹æ¡ˆ" class="headerlink" title="TCP ç²˜åŒ…å’Œæ‹†åŒ…åŠè§£å†³æ–¹æ¡ˆ"></a>TCP ç²˜åŒ…å’Œæ‹†åŒ…åŠè§£å†³æ–¹æ¡ˆ</h1><h2 id="åŸºæœ¬ä»‹ç»-5"><a href="#åŸºæœ¬ä»‹ç»-5" class="headerlink" title="åŸºæœ¬ä»‹ç»"></a>åŸºæœ¬ä»‹ç»</h2><ol>
<li><p>TCPæ˜¯é¢å‘è¿æ¥çš„ï¼Œé¢å‘æµçš„ï¼Œæä¾›é«˜å¯é æ€§æœåŠ¡ã€‚æ”¶å‘ä¸¤ç«¯ï¼ˆå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯ï¼‰éƒ½è¦æœ‰ä¸€ä¸€æˆå¯¹çš„socketï¼Œå› æ­¤ï¼Œå‘é€ç«¯ä¸ºäº†å°†		å¤šä¸ªå‘ç»™æ¥æ”¶ç«¯çš„åŒ…ï¼Œæ›´æœ‰æ•ˆçš„å‘ç»™å¯¹æ–¹ï¼Œä½¿ç”¨äº†ä¼˜åŒ–æ–¹æ³•ï¼ˆNagleç®—æ³•ï¼‰ï¼Œå°†å¤šæ¬¡é—´éš”è¾ƒå°ä¸”æ•°æ®é‡å°çš„æ•°æ®ï¼Œåˆå¹¶æˆä¸€ä¸ªå¤§çš„æ•°		æ®å—ï¼Œç„¶åè¿›è¡Œå°åŒ…ã€‚è¿™æ ·åšè™½ç„¶æé«˜äº†æ•ˆç‡ï¼Œä½†æ˜¯æ¥æ”¶ç«¯å°±éš¾äºåˆ†è¾¨å‡ºå®Œæ•´çš„æ•°æ®åŒ…äº†ï¼Œå› ä¸ºé¢å‘æµçš„é€šä¿¡æ˜¯æ— æ¶ˆæ¯ä¿æŠ¤è¾¹ç•Œçš„ã€‚</p>
</li>
<li><p>ç”±äºTCPæ— æ¶ˆæ¯ä¿æŠ¤è¾¹ç•Œ, éœ€è¦åœ¨æ¥æ”¶ç«¯å¤„ç†æ¶ˆæ¯è¾¹ç•Œé—®é¢˜ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„ç²˜åŒ…ã€æ‹†åŒ…é—®é¢˜, çœ‹ä¸€å¼ å›¾ã€‚</p>
</li>
</ol>
<img src="/2023/03/24/Netty/Java\Document\Netty\Netty å‚çœ‹æ–‡æ¡£.assets\image-20220920173939976.png" alt="image-20220920173939976" style="zoom:150%;">

<p>è¯´æ˜ï¼š</p>
<p>â€‹		å‡è®¾å®¢æˆ·ç«¯åˆ†åˆ«å‘é€äº†ä¸¤ä¸ªæ•°æ®åŒ…D1å’ŒD2ç»™æœåŠ¡ç«¯ï¼Œç”±äºæœåŠ¡ç«¯ä¸€æ¬¡è¯»å–åˆ°å­—èŠ‚æ•°æ˜¯ä¸ç¡®å®šçš„ï¼Œæ•…å¯èƒ½å­˜åœ¨ä»¥ä¸‹å››ç§æƒ…å†µï¼š</p>
<ol>
<li><p>æœåŠ¡ç«¯åˆ†ä¸¤æ¬¡è¯»å–åˆ°äº†ä¸¤ä¸ªç‹¬ç«‹çš„æ•°æ®åŒ…ï¼Œåˆ†åˆ«æ˜¯D1å’ŒD2ï¼Œæ²¡æœ‰ç²˜åŒ…å’Œæ‹†åŒ…ã€‚</p>
</li>
<li><p>æœåŠ¡ç«¯ä¸€æ¬¡æ¥å—åˆ°äº†ä¸¤ä¸ªæ•°æ®åŒ…ï¼ŒD1å’ŒD2ç²˜åˆåœ¨ä¸€èµ·ï¼Œç§°ä¹‹ä¸ºTCPç²˜åŒ…ã€‚</p>
</li>
<li><p>æœåŠ¡ç«¯åˆ†ä¸¤æ¬¡è¯»å–åˆ°äº†æ•°æ®åŒ…ï¼Œç¬¬ä¸€æ¬¡è¯»å–åˆ°äº†å®Œæ•´çš„D1åŒ…å’ŒD2åŒ…çš„éƒ¨åˆ†å†…å®¹ï¼Œç¬¬äºŒæ¬¡è¯»å–åˆ°äº†D2åŒ…çš„å‰©ä½™å†…å®¹ï¼Œè¿™ç§°ä¹‹ä¸ºTCPæ‹†		åŒ…ã€‚</p>
</li>
<li><p>æœåŠ¡ç«¯åˆ†ä¸¤æ¬¡è¯»å–åˆ°äº†æ•°æ®åŒ…ï¼Œç¬¬ä¸€æ¬¡è¯»å–åˆ°äº†D1åŒ…çš„éƒ¨åˆ†å†…å®¹D1_1ï¼Œç¬¬äºŒæ¬¡è¯»å–åˆ°äº†D1åŒ…çš„å‰©ä½™éƒ¨åˆ†å†…å®¹D1_2å’Œå®Œæ•´çš„D2åŒ…ã€‚</p>
</li>
</ol>
<h2 id="ä»£ç ç¤ºä¾‹"><a href="#ä»£ç ç¤ºä¾‹" class="headerlink" title="ä»£ç ç¤ºä¾‹"></a>ä»£ç ç¤ºä¾‹</h2><h3 id="ç²˜åŒ…ç¤ºä¾‹"><a href="#ç²˜åŒ…ç¤ºä¾‹" class="headerlink" title="ç²˜åŒ…ç¤ºä¾‹"></a>ç²˜åŒ…ç¤ºä¾‹</h3><p>Server</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.netty.tcp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.ServerBootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelFuture;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInitializer;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelOption;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.logging.LogLevel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.logging.LoggingHandler;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Tcp: ç²˜åŒ…</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">listenGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">handlerGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServerBootstrap</span> <span class="variable">serverBootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">            serverBootstrap.group(listenGroup,handlerGroup)</span><br><span class="line">                    .channel(NioServerSocketChannel.class)</span><br><span class="line">                    .option(ChannelOption.SO_BACKLOG,<span class="number">128</span>)</span><br><span class="line">                    .childOption(ChannelOption.SO_KEEPALIVE,<span class="literal">true</span>)</span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.INFO))</span><br><span class="line">                    .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            socketChannel.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">MyServerHandler</span>());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">channelFuture</span> <span class="operator">=</span> serverBootstrap.bind(<span class="number">8000</span>).sync();</span><br><span class="line">            System.out.println(<span class="string">&quot;Server Start...&quot;</span>);</span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            listenGroup.shutdownGracefully();</span><br><span class="line">            handlerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ServerHandler</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.netty.tcp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.ByteBuf;</span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.Unpooled;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;</span><br><span class="line"><span class="keyword">import</span> io.netty.util.CharsetUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyServerHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;ByteBuf&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">packageCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, ByteBuf byteBuf)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[byteBuf.readableBytes()];</span><br><span class="line">        byteBuf.readBytes(bytes);</span><br><span class="line">        System.out.println(<span class="string">&quot;Server: &quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(bytes, CharsetUtil.UTF_8));</span><br><span class="line">        System.out.println(<span class="string">&quot;Server packageCount: &quot;</span> + (++<span class="built_in">this</span>.packageCount));</span><br><span class="line">        <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> UUID.randomUUID().toString().replaceAll(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>).substring(<span class="number">0</span>, <span class="number">8</span>);</span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">response</span> <span class="operator">=</span> Unpooled.copiedBuffer(text, CharsetUtil.UTF_8);</span><br><span class="line">        ctx.writeAndFlush(response);</span><br><span class="line">        <span class="comment">//å¦‚æœå½“åšä¸€ä¸ªåŒ…æ¥æ”¶ï¼Œåˆ™åœ¨å¯åŠ¨ä¸€ä¸ªclient</span></span><br><span class="line">        <span class="comment">//Server: HelloServer: 0HelloServer: 1HelloServer: 2HelloServer: 3HelloServer: 4HelloServer: 5HelloServer: 6HelloServer: 7HelloServer: 8HelloServer: 9</span></span><br><span class="line">        <span class="comment">//Server packageCount: 1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Server: &quot;</span> + cause.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Client</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.netty.tcp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.Bootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelFuture;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInitializer;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioSocketChannel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">group</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">        bootstrap.group(group)</span><br><span class="line">                .channel(NioSocketChannel.class)</span><br><span class="line">                .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                        socketChannel.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">MyClientHandler</span>());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">channelFuture</span> <span class="operator">=</span> bootstrap.connect(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8000</span>).sync();</span><br><span class="line">            System.out.println(<span class="string">&quot;Client Start...&quot;</span>);</span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            group.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ClientHandler</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.netty.tcp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.ByteBuf;</span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.Unpooled;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyClientHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;ByteBuf&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">packageCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> Unpooled.copiedBuffer(<span class="string">&quot;HelloServer: &quot;</span> + i, Charset.forName(<span class="string">&quot;utf-8&quot;</span>));</span><br><span class="line">            ctx.channel().writeAndFlush(buf);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, ByteBuf byteBuf)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[byteBuf.readableBytes()];</span><br><span class="line">        byteBuf.readBytes(bytes);</span><br><span class="line">        System.out.println(<span class="string">&quot;Client: &quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(bytes, Charset.forName(<span class="string">&quot;utf-8&quot;</span>)));</span><br><span class="line">        System.out.println(<span class="string">&quot;Client packageCount: &quot;</span> + (++packageCount));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        cause.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h3><p>â€‹		å…³é”®åœ¨äºè§£å†³æœåŠ¡å™¨ç«¯æ¯æ¬¡è¯»å–æ•°æ®é•¿åº¦çš„é—®é¢˜, å°±ä¸ä¼šå‡ºç°æœåŠ¡å™¨å¤šè¯»æˆ–å°‘è¯»æ•°æ®çš„é—®é¢˜ï¼Œä»è€Œé¿å…çš„TCP ç²˜åŒ…ã€æ‹†åŒ…</p>
<p>åè®®æ•°æ®ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.netty.tcp.protocol;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åè®®æ•°æ®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageProtocol</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> length;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span>[] content;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getLength</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLength</span><span class="params">(<span class="type">int</span> length)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.length = length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] getContent() &#123;</span><br><span class="line">        <span class="keyword">return</span> content;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setContent</span><span class="params">(<span class="type">byte</span>[] content)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.content = content;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p> Server</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.netty.tcp.protocol;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.ServerBootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelFuture;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInitializer;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelOption;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.logging.LogLevel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.logging.LoggingHandler;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Tcp: ç²˜åŒ…</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">listenGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">handlerGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServerBootstrap</span> <span class="variable">serverBootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">            serverBootstrap.group(listenGroup, handlerGroup)</span><br><span class="line">                    .channel(NioServerSocketChannel.class)</span><br><span class="line">                    .option(ChannelOption.SO_BACKLOG, <span class="number">128</span>)</span><br><span class="line">                    .childOption(ChannelOption.SO_KEEPALIVE, <span class="literal">true</span>)</span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.INFO))</span><br><span class="line">                    .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            <span class="comment">// æ³¨æ„ç¼–ç å™¨å’Œè§£ç å™¨åœ¨ handler ä¹‹å‰</span></span><br><span class="line">                            socketChannel.pipeline()</span><br><span class="line">                                    .addLast(<span class="keyword">new</span> <span class="title class_">MyMessageDecoder</span>())</span><br><span class="line">                                    .addLast(<span class="keyword">new</span> <span class="title class_">MyMessageEncoder</span>())</span><br><span class="line">                                    .addLast(<span class="keyword">new</span> <span class="title class_">MyServerHandler</span>());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">channelFuture</span> <span class="operator">=</span> serverBootstrap.bind(<span class="number">8000</span>).sync();</span><br><span class="line">            System.out.println(<span class="string">&quot;Server Start...&quot;</span>);</span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            listenGroup.shutdownGracefully();</span><br><span class="line">            handlerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¼–ç å™¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.netty.tcp.protocol;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.ByteBuf;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.MessageToByteEncoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyMessageEncoder</span> <span class="keyword">extends</span> <span class="title class_">MessageToByteEncoder</span>&lt;MessageProtocol&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">encode</span><span class="params">(ChannelHandlerContext ctx, MessageProtocol messageProtocol, ByteBuf byteBuf)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;MyMessageEncoder encode...&quot;</span>);</span><br><span class="line">        byteBuf.writeInt(messageProtocol.getLength());</span><br><span class="line">        byteBuf.writeBytes(messageProtocol.getContent());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è§£ç å™¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.netty.tcp.protocol;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.ByteBuf;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.ReplayingDecoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyMessageDecoder</span> <span class="keyword">extends</span> <span class="title class_">ReplayingDecoder</span>&lt;MessageProtocol&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">decode</span><span class="params">(ChannelHandlerContext channelHandlerContext, ByteBuf byteBuf, List&lt;Object&gt; list)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;MyMessageDecoder decode...&quot;</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> byteBuf.readInt();</span><br><span class="line">        <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[length];</span><br><span class="line">        byteBuf.readBytes(bytes);</span><br><span class="line">        <span class="type">MessageProtocol</span> <span class="variable">protocol</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageProtocol</span>();</span><br><span class="line">        protocol.setLength(length);</span><br><span class="line">        protocol.setContent(bytes);</span><br><span class="line">        list.add(protocol);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Client</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.netty.tcp.protocol;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.Bootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelFuture;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInitializer;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioSocketChannel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">group</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">        bootstrap.group(group)</span><br><span class="line">                .channel(NioSocketChannel.class)</span><br><span class="line">                .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                        <span class="comment">// æ³¨æ„ç¼–ç å™¨å’Œè§£ç å™¨åœ¨ handler ä¹‹å‰</span></span><br><span class="line">                        socketChannel.pipeline()</span><br><span class="line">                                .addLast(<span class="keyword">new</span> <span class="title class_">MyMessageEncoder</span>())</span><br><span class="line">                                .addLast(<span class="keyword">new</span> <span class="title class_">MyMessageDecoder</span>())</span><br><span class="line">                                .addLast(<span class="keyword">new</span> <span class="title class_">MyClientHandler</span>());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">channelFuture</span> <span class="operator">=</span> bootstrap.connect(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8000</span>).sync();</span><br><span class="line">            System.out.println(<span class="string">&quot;Client Start...&quot;</span>);</span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            group.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ClientHandler</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.netty.tcp.protocol;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.ByteBuf;</span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.Unpooled;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyClientHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;MessageProtocol&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">packageCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> <span class="string">&quot;abandon&quot;</span>;</span><br><span class="line">            <span class="type">MessageProtocol</span> <span class="variable">protocol</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageProtocol</span>();</span><br><span class="line">            protocol.setLength(content.getBytes(StandardCharsets.UTF_8).length);</span><br><span class="line">            protocol.setContent(content.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">            ctx.writeAndFlush(protocol);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, MessageProtocol protocol)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Client: Length: &quot;</span> + protocol.getLength() + <span class="string">&quot;, Content: &quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(protocol.getContent(), StandardCharsets.UTF_8));</span><br><span class="line">        System.out.println(<span class="string">&quot;Client packageCount: &quot;</span> + (++packageCount));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        cause.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="Netty-å®ç°-RPC-è°ƒç”¨"><a href="#Netty-å®ç°-RPC-è°ƒç”¨" class="headerlink" title="Netty å®ç° RPC è°ƒç”¨"></a>Netty å®ç° RPC è°ƒç”¨</h1><h2 id="RPCåŸºæœ¬ä»‹ç»"><a href="#RPCåŸºæœ¬ä»‹ç»" class="headerlink" title="RPCåŸºæœ¬ä»‹ç»"></a>RPCåŸºæœ¬ä»‹ç»</h2><ol>
<li><p>RPCï¼ˆRemote Procedure Callï¼‰â€” è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼Œæ˜¯ä¸€ä¸ªè®¡ç®—æœºé€šä¿¡åè®®ã€‚è¯¥åè®®å…è®¸è¿è¡Œäºä¸€å°è®¡ç®—æœºçš„ç¨‹åºè°ƒç”¨å¦ä¸€å°è®¡ç®—æœº		çš„å­ç¨‹åºï¼Œè€Œç¨‹åºå‘˜æ— éœ€é¢å¤–åœ°ä¸ºè¿™ä¸ªäº¤äº’ä½œç”¨ç¼–ç¨‹ã€‚</p>
</li>
<li><p>ä¸¤ä¸ªæˆ–å¤šä¸ªåº”ç”¨ç¨‹åºéƒ½åˆ†å¸ƒåœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸Šï¼Œå®ƒä»¬ä¹‹é—´çš„è°ƒç”¨éƒ½åƒæ˜¯æœ¬åœ°æ–¹æ³•è°ƒç”¨ä¸€æ ·(å¦‚å›¾)ã€‚</p>
</li>
<li><p>å¸¸è§çš„ RPC æ¡†æ¶æœ‰: æ¯”è¾ƒçŸ¥åçš„å¦‚é˜¿é‡Œçš„Dubboã€googleçš„gRPCã€Goè¯­è¨€çš„rpcxã€Apacheçš„thriftï¼Œ Spring æ——ä¸‹çš„ SpringCloudã€‚</p>
</li>
</ol>
<h2 id="RPCè°ƒç”¨æµç¨‹"><a href="#RPCè°ƒç”¨æµç¨‹" class="headerlink" title="RPCè°ƒç”¨æµç¨‹"></a>RPCè°ƒç”¨æµç¨‹</h2><img src="/2023/03/24/Netty/Java\Document\Netty\Netty å‚çœ‹æ–‡æ¡£.assets\image-20220921115701760.png" alt="image-20220921115701760" style="zoom:150%;">

<p>è¯´æ˜ï¼š</p>
<ol>
<li><p>æœåŠ¡æ¶ˆè´¹æ–¹ä»¥æœ¬åœ°è°ƒç”¨æ–¹å¼è°ƒç”¨æœåŠ¡</p>
</li>
<li><p>client stub æ¥æ”¶åˆ°è°ƒç”¨åè´Ÿè´£å°†æ–¹æ³•ã€å‚æ•°ç­‰å°è£…æˆèƒ½å¤Ÿè¿›è¡Œç½‘ç»œä¼ è¾“çš„æ¶ˆæ¯ä½“</p>
</li>
<li><p>client stub å°†æ¶ˆæ¯è¿›è¡Œç¼–ç å¹¶å‘é€åˆ°æœåŠ¡ç«¯</p>
</li>
<li><p>server stub æ”¶åˆ°æ¶ˆæ¯åè¿›è¡Œè§£ç </p>
</li>
<li><p>server stub æ ¹æ®è§£ç ç»“æœè°ƒç”¨æœ¬åœ°çš„æœåŠ¡</p>
</li>
<li><p>æœ¬åœ°æœåŠ¡æ‰§è¡Œå¹¶å°†ç»“æœè¿”å›ç»™ server stub</p>
</li>
<li><p>server stub å°†è¿”å›å¯¼å…¥ç»“æœè¿›è¡Œç¼–ç å¹¶å‘é€è‡³æ¶ˆè´¹æ–¹</p>
</li>
<li><p>client stub æ¥æ”¶åˆ°æ¶ˆæ¯å¹¶è¿›è¡Œè§£ç </p>
</li>
<li><p>æœåŠ¡æ¶ˆè´¹æ–¹å¾—åˆ°ç»“æœ</p>
</li>
</ol>
<h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><p>ç¨‹åºåŠŸèƒ½ï¼šæ¶ˆè´¹è€…å’Œæä¾›è€…çº¦å®šæ¥å£å’Œåè®®ï¼Œæ¶ˆè´¹è€…è¿œç¨‹è°ƒç”¨æä¾›è€…çš„æœåŠ¡ï¼Œæä¾›è€…è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ¶ˆè´¹è€…æ‰“å°æä¾›è€…è¿”å›çš„æ•°æ®ã€‚</p>
<p>å…¬å…±æ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.netty.dubborpc.publicinterface;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HelloService</span> &#123;</span><br><span class="line">    String <span class="title function_">hello</span><span class="params">(String info)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœåŠ¡æä¾›æ–¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.netty.dubborpc.provider;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.mineting.netty.dubborpc.publicinterface.HelloService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">HelloService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> invokeCount;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(String info)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Server Provider: &quot;</span> + info);</span><br><span class="line">        <span class="keyword">if</span> (info != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Hello Client, Message: &quot;</span> + info + <span class="string">&quot;, InvokeCount: &quot;</span> + invokeCount;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Hello Client, Message: &quot;</span> + <span class="string">&quot;&quot;</span> + <span class="string">&quot;, InvokeCount: &quot;</span> + invokeCount;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.netty.dubborpc.provider;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.mineting.netty.dubborpc.netty.NettyRpcServer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcServerBootStrap</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        NettyRpcServer.startServer(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">8000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.netty.dubborpc.netty;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.ServerBootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelFuture;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInitializer;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.string.StringDecoder;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.string.StringEncoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyRpcServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">startServer</span><span class="params">(String host, <span class="type">int</span> port)</span> &#123;</span><br><span class="line">        startServer0(host, port);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">startServer0</span><span class="params">(String host, <span class="type">int</span> port)</span> &#123;</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">listenGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">handlerGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServerBootstrap</span> <span class="variable">serverBootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">            serverBootstrap.group(listenGroup, handlerGroup)</span><br><span class="line">                    .channel(NioServerSocketChannel.class)</span><br><span class="line">                    .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            socketChannel.pipeline()</span><br><span class="line">                                    .addLast(<span class="keyword">new</span> <span class="title class_">StringDecoder</span>())</span><br><span class="line">                                    .addLast(<span class="keyword">new</span> <span class="title class_">StringEncoder</span>())</span><br><span class="line">                                    .addLast(<span class="keyword">new</span> <span class="title class_">NettyRpcServerHandler</span>());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">channelFuture</span> <span class="operator">=</span> serverBootstrap.bind(host,port).sync();</span><br><span class="line">            System.out.println(<span class="string">&quot;RpcServer Start...&quot;</span>);</span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            listenGroup.shutdownGracefully();</span><br><span class="line">            handlerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.netty.dubborpc.netty;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.mineting.netty.dubborpc.customer.RpcClientBootstrap;</span><br><span class="line"><span class="keyword">import</span> com.example.mineting.netty.dubborpc.provider.HelloServiceImpl;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInboundHandlerAdapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyRpcServerHandler</span> <span class="keyword">extends</span> <span class="title class_">ChannelInboundHandlerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> msg.toString();</span><br><span class="line">        System.out.println(<span class="string">&quot;æ¶ˆè´¹è€…å‘é€çš„æ¶ˆæ¯ msgï¼š&quot;</span> + text);</span><br><span class="line">        <span class="keyword">if</span> (msg.toString().startsWith(RpcClientBootstrap.PROTOCOL_NAME)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HelloServiceImpl</span>().hello(msg.toString().substring(msg.toString().lastIndexOf(<span class="string">&quot;#&quot;</span>) + <span class="number">1</span>));</span><br><span class="line">            ctx.writeAndFlush(result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœåŠ¡æ¶ˆè´¹æ–¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.netty.dubborpc.customer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.mineting.netty.dubborpc.netty.NettyRpcClient;</span><br><span class="line"><span class="keyword">import</span> com.example.mineting.netty.dubborpc.publicinterface.HelloService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcClientBootstrap</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PROTOCOL_NAME</span> <span class="operator">=</span> <span class="string">&quot;HelloService#hello#&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">NettyRpcClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NettyRpcClient</span>();</span><br><span class="line">        <span class="type">HelloService</span> <span class="variable">helloService</span> <span class="operator">=</span> (HelloService) client.getBean(HelloService.class, PROTOCOL_NAME);</span><br><span class="line">        <span class="keyword">for</span> (; ; ) &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">ret</span> <span class="operator">=</span> helloService.hello(<span class="string">&quot;Hello DubboRpc&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;result: &quot;</span> + ret);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.netty.dubborpc.netty;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.Bootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInitializer;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelOption;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelPipeline;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioSocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.string.StringDecoder;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.string.StringEncoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyRpcClient</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(Runtime.getRuntime().availableProcessors());</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> NettyRpcClientHandler clientHandler;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> clientInvokeCount;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getBean</span><span class="params">(Class&lt;?&gt; serviceClass, String protocolName)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;serviceClass&#125;, (proxy, method, args) -&gt; &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;Client getBean clientInvokeCount: &quot;</span> + (++clientInvokeCount));</span><br><span class="line">                    <span class="keyword">if</span> (clientHandler == <span class="literal">null</span>) &#123;</span><br><span class="line">                        initRpcClientHandler();</span><br><span class="line">                    &#125;</span><br><span class="line">                    clientHandler.setParam(protocolName + args[<span class="number">0</span>]);</span><br><span class="line">                    <span class="comment">//invokeHandlerï¼šæ‰§è¡Œç»“æœçš„è¿”å›å€¼</span></span><br><span class="line">                    <span class="keyword">return</span> executorService.submit(clientHandler).get();</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">initRpcClientHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        clientHandler = <span class="keyword">new</span> <span class="title class_">NettyRpcClientHandler</span>();</span><br><span class="line">        <span class="type">NioEventLoopGroup</span> <span class="variable">group</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">        bootstrap.group(group)</span><br><span class="line">                .channel(NioSocketChannel.class)</span><br><span class="line">                .option(ChannelOption.TCP_NODELAY, <span class="literal">true</span>)</span><br><span class="line">                .handler(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                                <span class="type">ChannelPipeline</span> <span class="variable">pipeline</span> <span class="operator">=</span> ch.pipeline();</span><br><span class="line">                                pipeline.addLast(<span class="keyword">new</span> <span class="title class_">StringDecoder</span>());</span><br><span class="line">                                pipeline.addLast(<span class="keyword">new</span> <span class="title class_">StringEncoder</span>());</span><br><span class="line">                                pipeline.addLast(clientHandler);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                );</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            bootstrap.connect(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8000</span>).sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mineting.netty.dubborpc.netty;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInboundHandlerAdapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Callable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyRpcClientHandler</span> <span class="keyword">extends</span> <span class="title class_">ChannelInboundHandlerAdapter</span> <span class="keyword">implements</span> <span class="title class_">Callable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String param;</span><br><span class="line">    <span class="keyword">private</span> String result;</span><br><span class="line">    <span class="keyword">private</span> ChannelHandlerContext ctx;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setParam</span><span class="params">(String param)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.param = param;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="built_in">this</span>.ctx = ctx;</span><br><span class="line">        System.out.println(<span class="string">&quot;NettyRpcClientHandler channelActive...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;NettyRpcClientHandler channelRead...&quot;</span>);</span><br><span class="line">        result = msg.toString();</span><br><span class="line">        notify();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> Object <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;NettyRpcClientHandler call...&quot;</span>);</span><br><span class="line">        ctx.writeAndFlush(param);</span><br><span class="line">        wait();</span><br><span class="line">        System.out.println(<span class="string">&quot;NettyRpcClientHandler call wait...&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(cause.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/23/Elasticsearch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MineTing">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/23/Elasticsearch/" class="post-title-link" itemprop="url">Elasticsearch</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-23 00:00:00" itemprop="dateCreated datePublished" datetime="2023-03-23T00:00:00+08:00">2023-03-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-22 16:34:42" itemprop="dateModified" datetime="2023-03-22T16:34:42+08:00">2023-03-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <div align="center"><font size="70"><b>Elasticsearch</b></font></div>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/22/RocketMQ/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MineTing">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/22/RocketMQ/" class="post-title-link" itemprop="url">RocketMQ</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-03-22 00:00:00 / Modified: 16:33:50" itemprop="dateCreated datePublished" datetime="2023-03-22T00:00:00+08:00">2023-03-22</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <div align="center"><font size="70"><b>RocketMQ</b></font></div>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/21/Kafka/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MineTing">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/21/Kafka/" class="post-title-link" itemprop="url">Kafka</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-21 00:00:00" itemprop="dateCreated datePublished" datetime="2023-03-21T00:00:00+08:00">2023-03-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-31 14:40:57" itemprop="dateModified" datetime="2023-03-31T14:40:57+08:00">2023-03-31</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <div align="center"><font size="70"><b>Kafka</b></font></div>

<blockquote>
<p>ã€Referã€‘</p>
<p>å®˜ç½‘åœ°å€ï¼š</p>
<p>å®˜æ–¹æ–‡æ¡£ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1vr4y1677k/?spm_id_from=333.337.search-card.all.click">ã€å°šç¡…è°·ã€‘Kafka3.xæ•™ç¨‹ï¼ˆä»å…¥é—¨åˆ°è°ƒä¼˜ï¼Œæ·±å…¥å…¨é¢ï¼‰_å“”å“©å“”å“©_bilibili</a></p>
</blockquote>
<h1 id="kafka-å…¥é—¨"><a href="#kafka-å…¥é—¨" class="headerlink" title="kafka å…¥é—¨"></a>kafka å…¥é—¨</h1><h2 id="Kafka-æ¦‚è¿°"><a href="#Kafka-æ¦‚è¿°" class="headerlink" title="Kafka æ¦‚è¿°"></a>Kafka æ¦‚è¿°</h2><h3 id="æ¶ˆæ¯é˜Ÿåˆ—"><a href="#æ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="æ¶ˆæ¯é˜Ÿåˆ—"></a>æ¶ˆæ¯é˜Ÿåˆ—</h3><p>æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ˜¯æ¶ˆæ¯ä¹Ÿæ˜¯é˜Ÿåˆ—ï¼›ç›®å‰ä¼ä¸šä¸­å¸¸è§çš„æ¶ˆæ¯é˜Ÿåˆ—äº§å“ä¸»è¦æœ‰ Kafkaã€ActiveMQ ã€RabbitMQ ã€ RocketMQ ç­‰ã€‚</p>
<p>åœ¨å¤§æ•°æ®åœºæ™¯ä¸»è¦é‡‡ç”¨ Kafka ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ã€‚åœ¨ JavaEE å¼€å‘ä¸­ä¸»è¦é‡‡ç”¨ ActiveMQã€ RabbitMQã€RocketMQ</p>
<h3 id="ä¼ ç»Ÿæ¶ˆæ¯é˜Ÿåˆ—çš„åº”ç”¨åœºæ™¯"><a href="#ä¼ ç»Ÿæ¶ˆæ¯é˜Ÿåˆ—çš„åº”ç”¨åœºæ™¯" class="headerlink" title="ä¼ ç»Ÿæ¶ˆæ¯é˜Ÿåˆ—çš„åº”ç”¨åœºæ™¯"></a>ä¼ ç»Ÿæ¶ˆæ¯é˜Ÿåˆ—çš„åº”ç”¨åœºæ™¯</h3><p>ä¸»è¦åº”ç”¨åœºæ™¯åŒ…æ‹¬ï¼šç¼“å­˜&#x2F;æ¶ˆå³°ã€è§£è€¦å’Œå¼‚æ­¥é€šä¿¡</p>
<ul>
<li><p>ç¼“å†²&#x2F;æ¶ˆå³°ï¼šæœ‰åŠ©äºæ§åˆ¶å’Œä¼˜åŒ–æ•°æ®æµç»è¿‡ç³»ç»Ÿçš„é€Ÿåº¦ï¼Œè§£å†³ç”Ÿäº§æ¶ˆæ¯å’Œæ¶ˆè´¹æ¶ˆæ¯çš„å¤„ç†é€Ÿåº¦ä¸ä¸€è‡´çš„æƒ…å†µã€‚</p>
<p><img src="/2023/03/21/Kafka/Kafka%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97-%E5%89%8A%E5%B3%B0.png" alt="Kafkaæ¶ˆæ¯é˜Ÿåˆ—-å‰Šå³°.png"></p>
</li>
<li><p>è§£è€¦ï¼šå…è®¸ä½ ç‹¬ç«‹çš„æ‰©å±•æˆ–ä¿®æ”¹ä¸¤è¾¹çš„å¤„ç†è¿‡ç¨‹ï¼Œåªè¦ç¡®ä¿å®ƒä»¬éµå®ˆåŒæ ·çš„æ¥å£çº¦æŸã€‚</p>
<p><img src="/2023/03/21/Kafka/Kafka%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97-%E8%A7%A3%E8%80%A6.png" alt="Kafkaæ¶ˆæ¯é˜Ÿåˆ—-è§£è€¦.png"></p>
</li>
<li><p>å¼‚æ­¥é€šä¿¡ï¼šå…è®¸ç”¨æˆ·æŠŠä¸€ä¸ªæ¶ˆæ¯æ”¾å…¥é˜Ÿåˆ—ï¼Œä½†å¹¶ä¸ç«‹å³å¤„ç†å®ƒï¼Œç„¶ååœ¨éœ€è¦çš„æ—¶å€™å†å»å¤„ç†å®ƒä»¬ã€‚</p>
<p><img src="/2023/03/21/Kafka/Kafka%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97-%E5%BC%82%E6%AD%A5.png" alt="Kafkaæ¶ˆæ¯é˜Ÿåˆ—-å¼‚æ­¥.png"></p>
</li>
</ul>
<h3 id="æ¶ˆæ¯é˜Ÿåˆ—çš„ä¸¤ç§æ¨¡å¼"><a href="#æ¶ˆæ¯é˜Ÿåˆ—çš„ä¸¤ç§æ¨¡å¼" class="headerlink" title="æ¶ˆæ¯é˜Ÿåˆ—çš„ä¸¤ç§æ¨¡å¼"></a>æ¶ˆæ¯é˜Ÿåˆ—çš„ä¸¤ç§æ¨¡å¼</h3><h4 id="ç‚¹å¯¹ç‚¹æ¨¡å¼"><a href="#ç‚¹å¯¹ç‚¹æ¨¡å¼" class="headerlink" title="ç‚¹å¯¹ç‚¹æ¨¡å¼"></a>ç‚¹å¯¹ç‚¹æ¨¡å¼</h4><ul>
<li><p>æ¶ˆè´¹è€…ä¸»åŠ¨æ‹‰å–æ•°æ®ï¼Œæ¶ˆæ¯æ”¶åˆ°åæ¸…é™¤æ¶ˆæ¯</p>
<p><img src="/2023/03/21/Kafka/Kakfa%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97-%E7%82%B9%E5%AF%B9%E7%82%B9%E6%A8%A1%E5%BC%8F.png" alt="Kakfaæ¶ˆæ¯é˜Ÿåˆ—-ç‚¹å¯¹ç‚¹æ¨¡å¼.png"></p>
</li>
</ul>
<h4 id="å‘å¸ƒ-x2F-è®¢é˜…æ¨¡å¼"><a href="#å‘å¸ƒ-x2F-è®¢é˜…æ¨¡å¼" class="headerlink" title="å‘å¸ƒ &#x2F; è®¢é˜…æ¨¡å¼"></a>å‘å¸ƒ &#x2F; è®¢é˜…æ¨¡å¼</h4><ul>
<li><p>å¯ä»¥æœ‰å¤šä¸ªtopicä¸»é¢˜</p>
</li>
<li><p>æ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ®ä¹‹åï¼Œä¸åˆ é™¤æ•°æ®</p>
</li>
<li><p>æ¯ä¸ªæ¶ˆè´¹è€…ç›¸äº’ç‹¬ç«‹ï¼Œéƒ½å¯ä»¥æ¶ˆè´¹åˆ°æ•°æ®</p>
<p><img src="/2023/03/21/Kafka/Kafka%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97-%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F.png" alt="Kafkaæ¶ˆæ¯é˜Ÿåˆ—-å‘å¸ƒè®¢é˜…æ¨¡å¼.png"></p>
</li>
</ul>
<h3 id="Kafka-åŸºç¡€æ¶æ„"><a href="#Kafka-åŸºç¡€æ¶æ„" class="headerlink" title="Kafka åŸºç¡€æ¶æ„"></a>Kafka åŸºç¡€æ¶æ„</h3><p><img src="/2023/03/21/Kafka/Kafka%E5%9F%BA%E6%9C%AC%E6%9E%B6%E6%9E%84.png" alt="KafkaåŸºæœ¬æ¶æ„.png"></p>
<blockquote>
<p><strong>å„ä¸ªç»„ä»¶è¯´æ˜ï¼š</strong></p>
<ol>
<li><p><strong>Producerï¼šæ¶ˆæ¯ç”Ÿäº§è€…ï¼Œå°±æ˜¯å‘ Kafka broker å‘æ¶ˆæ¯çš„å®¢æˆ·ç«¯</strong></p>
</li>
<li><p><strong>Consumerï¼šæ¶ˆæ¯æ¶ˆè´¹è€…ï¼Œå‘ Kafka broker å–æ¶ˆæ¯çš„å®¢æˆ·ç«¯</strong></p>
</li>
<li><p><strong>Consumer Groupï¼ˆCGï¼‰ï¼šæ¶ˆè´¹è€…ç»„ï¼Œç”±å¤šä¸ª consumer ç»„æˆã€‚æ¶ˆè´¹è€…ç»„å†…æ¯ä¸ªæ¶ˆè´¹è€…è´Ÿè´£æ¶ˆè´¹ä¸åŒåˆ†åŒºçš„æ•°æ®ï¼Œä¸€ä¸ªåˆ†åŒºåªèƒ½ç”±ä¸€ä¸ªç»„å†…æ¶ˆè´¹è€…æ¶ˆè´¹ï¼›æ¶ˆè´¹è€…ç»„ä¹‹é—´äº’ä¸å½±å“ã€‚æ‰€æœ‰çš„æ¶ˆè´¹è€…éƒ½å±äºæŸä¸ªæ¶ˆè´¹è€…ç»„ï¼Œå³æ¶ˆè´¹è€…ç»„æ˜¯é€»è¾‘ä¸Šçš„ä¸€ä¸ªè®¢é˜…è€…ã€‚</strong></p>
</li>
<li><p><strong>Brokerï¼šä¸€å° Kafka æœåŠ¡å™¨å°±æ˜¯ä¸€ä¸ª brokerã€‚ä¸€ä¸ªé›†ç¾¤ç”±å¤šä¸ª broker ç»„æˆã€‚ä¸€ä¸ª broker å¯ä»¥å®¹çº³å¤šä¸ª topic</strong></p>
</li>
<li><p><strong>Topicï¼šå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªé˜Ÿåˆ—ï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…é¢å‘çš„éƒ½æ˜¯ä¸€ä¸ª topic</strong></p>
</li>
<li><p><strong>Partitionï¼šä¸ºäº†å®ç°æ‰©å±•æ€§ï¼Œä¸€ä¸ªéå¸¸å¤§çš„ topic å¯ä»¥åˆ†å¸ƒåˆ°å¤šä¸ª brokerï¼ˆå³æœ åŠ¡å™¨ï¼‰ä¸Šï¼Œä¸€ä¸ª topic å¯ä»¥åˆ†ä¸ºå¤šä¸ª partitionï¼Œæ¯ä¸ª partition æ˜¯ä¸€ä¸ªæœ‰åºçš„é˜Ÿåˆ—ã€‚</strong></p>
</li>
<li><p><strong>Replicaï¼šå‰¯æœ¬ï¼Œä¸€ä¸ª topic çš„æ¯ä¸ªåˆ†åŒºéƒ½æœ‰è‹¥å¹²ä¸ªå‰¯æœ¬ï¼Œä¸€ä¸ª Leader å’Œè‹¥å¹²ä¸ª Followerã€‚</strong></p>
</li>
<li><p><strong>Leaderï¼šæ¯ä¸ªåˆ†åŒºå¤šä¸ªå‰¯æœ¬çš„ â€œä¸»â€ï¼Œç”Ÿäº§è€…å‘é€æ•°æ®çš„å¯¹è±¡ï¼Œä»¥åŠæ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ®çš„å¯¹è±¡éƒ½æ˜¯ Leaderã€‚</strong></p>
</li>
<li><p><strong>Followerï¼šæ¯ä¸ªåˆ†åŒºå¤šä¸ªå‰¯æœ¬ä¸­çš„ â€œä»â€ï¼Œå®æ—¶ä» Leader ä¸­åŒæ­¥æ•°æ®ï¼Œä¿æŒå’Œ Leader æ•°æ®çš„åŒæ­¥ã€‚Leader å‘ç”Ÿæ•…éšœæ—¶ï¼ŒæŸä¸ª Follower ä¼šæˆä¸ºæ–°çš„ Leaderã€‚</strong></p>
</li>
</ol>
</blockquote>
<h2 id="Kafka-å…¥é—¨ç¤ºä¾‹"><a href="#Kafka-å…¥é—¨ç¤ºä¾‹" class="headerlink" title="Kafka å…¥é—¨ç¤ºä¾‹"></a>Kafka å…¥é—¨ç¤ºä¾‹</h2><h3 id="é¢„å…ˆå‡†å¤‡"><a href="#é¢„å…ˆå‡†å¤‡" class="headerlink" title="é¢„å…ˆå‡†å¤‡"></a>é¢„å…ˆå‡†å¤‡</h3><h4 id="é…ç½®-Java-ç¯å¢ƒ"><a href="#é…ç½®-Java-ç¯å¢ƒ" class="headerlink" title="é…ç½® Java ç¯å¢ƒ"></a>é…ç½® Java ç¯å¢ƒ</h4><ul>
<li>å¸è½½è‡ªå¸¦çš„ OpenJDK</li>
<li>é…ç½® Java ç¯å¢ƒå˜é‡</li>
</ul>
<h4 id="é…ç½®é›†ç¾¤å…å¯†ç™»å½•"><a href="#é…ç½®é›†ç¾¤å…å¯†ç™»å½•" class="headerlink" title="é…ç½®é›†ç¾¤å…å¯†ç™»å½•"></a>é…ç½®é›†ç¾¤å…å¯†ç™»å½•</h4><ul>
<li><p>é…ç½®é›†ç¾¤ ip æ˜ å°„</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost kafka3.x]# cat /etc/hosts</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.100.100 hadoop01</span><br><span class="line">192.168.100.110 hadoop02</span><br><span class="line">192.168.100.120 hadoop03</span><br></pre></td></tr></table></figure>
</li>
<li><p>ç”Ÿæˆç§˜é’¥</p>
<p>ä¼šåœ¨ ~ ç›®å½•ä¸‹ç”Ÿæˆ .ssh ç›®å½•</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ssh-keygen -t rsa</span><br></pre></td></tr></table></figure>
</li>
<li><p>åˆ†å‘ç§˜é’¥</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ssh-copy-id 192.168.0.200</span><br><span class="line">[root@localhost ~]# ssh-copy-id 192.168.0.201</span><br><span class="line">[root@localhost ~]# ssh-copy-id 192.168.0.202</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="åˆ†å‘è„šæœ¬-xsync-sh"><a href="#åˆ†å‘è„šæœ¬-xsync-sh" class="headerlink" title="åˆ†å‘è„šæœ¬ xsync.sh"></a>åˆ†å‘è„šæœ¬ xsync.sh</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ¤æ–­å‚æ•°ä¸ªæ•°</span></span><br><span class="line">if [ $# -lt 1 ]</span><br><span class="line">then</span><br><span class="line">        echo &quot;Not  Enough Arguments&quot;</span><br><span class="line">        exit</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">éå†æ‰€æœ‰ä¸»æœº</span></span><br><span class="line">for host in 192.168.100.100 192.168.100.110 192.168.100.120</span><br><span class="line">do</span><br><span class="line">        echo ========$host========</span><br><span class="line">        # éå†æ‰€æœ‰ç›®å½•</span><br><span class="line">        for file in $@</span><br><span class="line">        do</span><br><span class="line">                if [ -e $file ]</span><br><span class="line">                then</span><br><span class="line">                        # å¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œè·å–çˆ¶ç›®å½•ï¼Œ</span><br><span class="line">                        # pwd -Pï¼šå¦‚æœç›®å½•æ˜¯é“¾æ¥æ—¶ï¼Œæ˜¾ç¤ºå‡ºå®é™…è·¯å¾„ï¼Œè€Œéä½¿ç”¨è¿æ¥ï¼ˆlinkï¼‰è·¯å¾„ã€‚pwdé˜²æ­¢ä¼ å…¥ç›¸å¯¹è·¯å¾„</span><br><span class="line">                        # cd -P:å¦‚æœç›®å½•æ˜¯é“¾æ¥æ—¶ï¼Œåˆ‡æ¢åˆ°å®é™…è·¯å¾„çš„ç›®å½•ã€‚</span><br><span class="line">                        pdir=$(cd -P $(dirname $file);pwd)</span><br><span class="line">                        # è·å–æ–‡ä»¶åç§°</span><br><span class="line">                        filename=$(basename $file)</span><br><span class="line">                        ssh $host &quot;mkdir -p $pdir&quot;</span><br><span class="line">                        rsync -av $pdir/$filename $host:$pdir</span><br><span class="line">                else</span><br><span class="line">                        echo $file not exist!</span><br><span class="line">                fi</span><br><span class="line">        done</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h4 id="æŸ¥çœ‹-Java-è¿›ç¨‹-jspall-sh"><a href="#æŸ¥çœ‹-Java-è¿›ç¨‹-jspall-sh" class="headerlink" title="æŸ¥çœ‹ Java è¿›ç¨‹ jspall.sh"></a>æŸ¥çœ‹ Java è¿›ç¨‹ jspall.sh</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">for host in 192.168.100.100 192.168.100.110 192.168.100.120</span><br><span class="line">do</span><br><span class="line"> echo ========$host========</span><br><span class="line"> ssh $host  &quot;source /etc/profile &amp;&amp; jps | grep -v jps &quot;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h3 id="å®‰è£…æ­¥éª¤"><a href="#å®‰è£…æ­¥éª¤" class="headerlink" title="å®‰è£…æ­¥éª¤"></a>å®‰è£…æ­¥éª¤</h3><p>ä»¥ <code>apache-zookeeper-3.5.7-bin.tar.gz</code> ã€<code>kafka_2.12-3.0.0.tgz</code> ä¸ºä¾‹ã€‚</p>
<h4 id="å®‰è£…-Zookeeper"><a href="#å®‰è£…-Zookeeper" class="headerlink" title="å®‰è£… Zookeeper"></a>å®‰è£… Zookeeper</h4><h5 id="å•æœºç‰ˆ"><a href="#å•æœºç‰ˆ" class="headerlink" title="å•æœºç‰ˆ"></a>å•æœºç‰ˆ</h5><p>Zookeeper åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://zookeeper.apache.org/releases.html">https://zookeeper.apache.org/releases.html</a></p>
<p>Zookeeper  ç‰ˆæœ¬ï¼šapache-zookeeper-3.5.7-bin.tar.gzï¼Œè§£å‹è‡³ &#x2F;opt&#x2F;zookeeper&#x2F;</p>
<p>å®‰è£…å‡†å¤‡ï¼šå…ˆå®‰è£… JDK</p>
<h5 id="é›†ç¾¤ç‰ˆ"><a href="#é›†ç¾¤ç‰ˆ" class="headerlink" title="é›†ç¾¤ç‰ˆ"></a>é›†ç¾¤ç‰ˆ</h5><h4 id="å®‰è£…-Kafka"><a href="#å®‰è£…-Kafka" class="headerlink" title="å®‰è£… Kafka"></a>å®‰è£… Kafka</h4><p>å®˜æ–¹ä¸‹è½½åœ°å€ï¼š<a target="_blank" rel="noopener" href="http://kafka.apache.org/downloads.html">http://kafka.apache.org/downloads.html</a></p>
<ul>
<li><p>é›†ç¾¤ä¸»æœºï¼š<code>192.168.100.100 ã€192.168.100.110 ã€192.168.100.120</code></p>
</li>
<li><p>ä¸Šä¼ å¹¶è§£å‹åˆ° &#x2F;opt&#x2F;kafka&#x2F;kafka3.x</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost kafka3.x]# ll</span><br><span class="line">æ€»ç”¨é‡ 68</span><br><span class="line">drwxr-xr-x. 3 root root  4096 3æœˆ  21 12:55 bin</span><br><span class="line">drwxr-xr-x. 3 root root  4096 3æœˆ  21 11:44 config</span><br><span class="line">drwxr-xr-x. 2 root root   187 3æœˆ  22 00:33 datas</span><br><span class="line">drwxr-xr-x. 2 root root  8192 3æœˆ  21 09:59 libs</span><br><span class="line">-rw-r--r--. 1 root root 14521 9æœˆ   9 2021 LICENSE</span><br><span class="line">drwxr-xr-x. 2 root root   262 9æœˆ   9 2021 licenses</span><br><span class="line">drwxr-xr-x. 2 root root  4096 3æœˆ  22 00:00 logs</span><br><span class="line">-rw-r--r--. 1 root root 28184 9æœˆ   9 2021 NOTICE</span><br><span class="line">drwxr-xr-x. 2 root root    44 9æœˆ   9 2021 site-docs</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼šconfig&#x2F;server.properties</p>
<p>ä¸»è¦ä¿®æ”¹ï¼š<code>broker.id</code> ã€ <code>log.dirs</code> ã€<code>zookeeper.connect</code></p>
<ul>
<li>broker.idï¼šbroker çš„å…¨å±€å”¯ä¸€ç¼–å·ï¼Œä¸èƒ½é‡å¤ï¼Œåªèƒ½æ˜¯æ•°å­—</li>
<li>log.dirsï¼škafka è¿è¡Œæ—¥å¿—(æ•°æ®)å­˜æ”¾çš„è·¯å¾„ï¼Œè·¯å¾„ä¸éœ€è¦æå‰åˆ›å»ºï¼Œkafka è‡ªåŠ¨åˆ›å»ºï¼Œå¯ä»¥é…ç½®å¤šä¸ªç£ç›˜è·¯å¾„ï¼Œè·¯å¾„ä¸è·¯å¾„ä¹‹é—´å¯ä»¥ç”¨ â€œï¼Œâ€åˆ†éš”</li>
<li>zookeeper.connectï¼šé…ç½®è¿æ¥ Zookeeper é›†ç¾¤åœ°å€ï¼ˆåœ¨ zk æ ¹ç›®å½•ä¸‹åˆ›å»º&#x2F;kafkaï¼Œæ–¹ä¾¿ç®¡ç†ï¼‰</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">broker çš„å…¨å±€å”¯ä¸€ç¼–å·ï¼Œä¸èƒ½é‡å¤ï¼Œåªèƒ½æ˜¯æ•°å­—</span></span><br><span class="line">broker.id=0</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">å¤„ç†ç½‘ç»œè¯·æ±‚çš„çº¿ç¨‹æ•°é‡</span></span><br><span class="line">num.network.threads=3</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ç”¨æ¥å¤„ç†ç£ç›˜ IO çš„çº¿ç¨‹æ•°é‡</span></span><br><span class="line">num.io.threads=8</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">å‘é€å¥—æ¥å­—çš„ç¼“å†²åŒºå¤§å°</span></span><br><span class="line">socket.send.buffer.bytes=102400</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">æ¥æ”¶å¥—æ¥å­—çš„ç¼“å†²åŒºå¤§å°</span></span><br><span class="line">socket.receive.buffer.bytes=102400</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">è¯·æ±‚å¥—æ¥å­—çš„ç¼“å†²åŒºå¤§å°</span></span><br><span class="line">socket.request.max.bytes=104857600</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">kafka è¿è¡Œæ—¥å¿—(æ•°æ®)å­˜æ”¾çš„è·¯å¾„ï¼Œè·¯å¾„ä¸éœ€è¦æå‰åˆ›å»ºï¼Œkafka è‡ªåŠ¨åˆ›å»ºï¼Œå¯ä»¥</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">é…ç½®å¤šä¸ªç£ç›˜è·¯å¾„ï¼Œè·¯å¾„ä¸è·¯å¾„ä¹‹é—´å¯ä»¥ç”¨<span class="string">&quot;ï¼Œ&quot;</span>åˆ†éš”</span></span><br><span class="line">log.dirs=/opt/module/kafka/datas</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">topic åœ¨å½“å‰ broker ä¸Šçš„åˆ†åŒºä¸ªæ•°</span></span><br><span class="line">num.partitions=1</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ç”¨æ¥æ¢å¤å’Œæ¸…ç† data ä¸‹æ•°æ®çš„çº¿ç¨‹æ•°é‡</span></span><br><span class="line">num.recovery.threads.per.data.dir=1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ¯ä¸ª topic åˆ›å»ºæ—¶çš„å‰¯æœ¬æ•°ï¼Œé»˜è®¤æ—¶ 1 ä¸ªå‰¯æœ¬</span></span><br><span class="line">offsets.topic.replication.factor=1</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">segment æ–‡ä»¶ä¿ç•™çš„æœ€é•¿æ—¶é—´ï¼Œè¶…æ—¶å°†è¢«åˆ é™¤</span></span><br><span class="line">log.retention.hours=168</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">æ¯ä¸ª segment æ–‡ä»¶çš„å¤§å°ï¼Œé»˜è®¤æœ€å¤§ 1G</span></span><br><span class="line">log.segment.bytes=1073741824</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥è¿‡æœŸæ•°æ®çš„æ—¶é—´ï¼Œé»˜è®¤ 5 åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡æ˜¯å¦æ•°æ®è¿‡æœŸ</span></span><br><span class="line">log.retention.check.interval.ms=300000</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">é…ç½®è¿æ¥ Zookeeper é›†ç¾¤åœ°å€ï¼ˆåœ¨ zk æ ¹ç›®å½•ä¸‹åˆ›å»º/kafkaï¼Œæ–¹ä¾¿ç®¡ç†ï¼‰</span></span><br><span class="line">zookeeper.connect=hadoop102:2181,hadoop103:2181,hadoop104:2181/ka</span><br><span class="line">fka</span><br></pre></td></tr></table></figure>
</li>
<li><p>åˆ†å‘ Kafka ç›®å½•å¹¶ä¿®æ”¹ broker.id</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost kafka]#  xsync kafka3.x/</span><br></pre></td></tr></table></figure>

<p>ä¿®æ”¹ 192.168.100.110 ã€192.168.100.120 çš„ kafka3.x&#x2F;config&#x2F;server.propertis ä¸­çš„ broker.id</p>
<p> 192.168.100.110 ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">############################ Server Basics #############################</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The <span class="built_in">id</span> of the broker. This must be <span class="built_in">set</span> to a unique <span class="built_in">integer</span> <span class="keyword">for</span> each broker.</span></span><br><span class="line">broker.id=1</span><br></pre></td></tr></table></figure>

<p> 192.168.100.1120ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">############################ Server Basics #############################</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The <span class="built_in">id</span> of the broker. This must be <span class="built_in">set</span> to a unique <span class="built_in">integer</span> <span class="keyword">for</span> each broker.</span></span><br><span class="line">broker.id=1</span><br></pre></td></tr></table></figure>
</li>
<li><p>é…ç½® Kafka ç¯å¢ƒå˜é‡å¹¶åˆ·æ–°</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">java</span></span><br><span class="line">export JAVA_HOME=/opt/java/jdk1.8.0_131</span><br><span class="line">export JRE_HOME=/opt/java/jdk1.8.0_131/jre</span><br><span class="line">export CLASSPATH=.:%JAVA_HOME%/lib:%JAVA_HOME%/lib</span><br><span class="line">export PATH=$JAVA_HOME/bin:$PATH</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">zookeeper</span></span><br><span class="line">export ZOOKEEPER_HOME=/opt/zookeeper/zookeeper-3.5.7</span><br><span class="line">export PATH=$ZOOKEEPER_HOME/bin:$PATH</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">KAFKA_HOME</span></span><br><span class="line">export KAFKA_HOME=/opt/kafka/kafka3.x</span><br><span class="line">export PATH=$PATH:$KAFKA_HOME/bin</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>åˆ·æ–°ç¯å¢ƒå˜é‡ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost kafka3.x]#  source /etc/profile</span><br></pre></td></tr></table></figure>
</li>
<li><p>åˆ†å‘ç¯å¢ƒå˜é‡å¹¶åˆ·æ–°</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost kafka]#  xsync kafka3.x/</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> 192.168.100.110ã€192.168.100.120</span></span><br><span class="line">[root@localhost kafka]#  source /etc/profile</span><br></pre></td></tr></table></figure>
</li>
<li><p>å¯åŠ¨é›†ç¾¤</p>
<ul>
<li><p>ç¬¬ä¸€æ­¥ï¼šå¯åŠ¨ Zookeeper é›†ç¾¤</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost kafka3.x]#  zk.sh start</span><br></pre></td></tr></table></figure>
</li>
<li><p>ç¬¬äºŒæ­¥ï¼šä¾æ¬¡å¯åŠ¨ <code>192.168.100.100 ã€192.168.100.110 ã€192.168.100.120</code> çš„ Kafka</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost kafka3.x]# /opt/kafka/kafka3.x/bin/kafka-server-start.sh -daemon /opt/kafka/kafka3.x/config/server.properties</span><br></pre></td></tr></table></figure>
</li>
<li><p>æŸ¥çœ‹è¿›ç¨‹</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost kafka3.x]# jpsall.sh</span><br><span class="line">========192.168.100.100========</span><br><span class="line">4577 QuorumPeerMain</span><br><span class="line">4978 Kafka</span><br><span class="line">5093 Jps</span><br><span class="line">========192.168.100.110========</span><br><span class="line">11639 Kafka</span><br><span class="line">11738 Jps</span><br><span class="line">11151 QuorumPeerMain</span><br><span class="line">========192.168.100.120========</span><br><span class="line">11169 QuorumPeerMain</span><br><span class="line">11735 Jps</span><br><span class="line">11644 Kafka</span><br></pre></td></tr></table></figure>
</li>
<li><p>é›†ç¾¤å¯åœè„šæœ¬ kf.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">! /bin/bash</span></span><br><span class="line">case $1 in</span><br><span class="line">&quot;start&quot;)&#123;</span><br><span class="line">        for i in 192.168.100.100 192.168.100.110 192.168.100.120</span><br><span class="line">                do</span><br><span class="line">                        echo &quot; --------Start $i Kafka-------&quot;</span><br><span class="line">                        ssh $i &quot;/opt/kafka/kafka3.x/bin/kafka-server-start.sh -daemon /opt/kafka/kafka3.x/config/server.properties&quot;</span><br><span class="line">                done</span><br><span class="line">&#125;;;</span><br><span class="line">&quot;stop&quot;)&#123;</span><br><span class="line">        for i in 192.168.100.100 192.168.100.110 192.168.100.120</span><br><span class="line">                do</span><br><span class="line">                        echo &quot; --------Stop $i Kafka-------&quot;</span><br><span class="line">                        ssh $i &quot;/opt/kafka/kafka3.x/bin/kafka-server-stop.sh &quot;</span><br><span class="line">                done</span><br><span class="line">&#125;;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>

<p>è®¾ç½®æƒé™å¹¶æ‹·è´åˆ° &#x2F;usr&#x2F;bin ç›®å½•ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost shell]# chmod +x kf.sh</span><br><span class="line">[root@localhost shell]# cp kf.sh /usr/bin/</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>åœæ­¢é›†ç¾¤</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost kafka3.x]# /opt/kafka/kafka3.x/bin/kafka-server-stop.sh</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ï¼šåœæ­¢ Kafka é›†ç¾¤æ—¶ï¼Œä¸€å®šè¦ç­‰ Kafka æ‰€æœ‰èŠ‚ç‚¹è¿›ç¨‹å…¨éƒ¨åœæ­¢åå†åœæ­¢ Zookeeper é›†ç¾¤ã€‚å› ä¸º Zookeeper é›†ç¾¤å½“ä¸­è®°å½•ç€ Kafka é›†ç¾¤ç›¸å…³ä¿¡æ¯ï¼ŒZookeeper é›†ç¾¤ä¸€æ—¦å…ˆåœæ­¢ï¼Œ Kafka é›†ç¾¤å°±æ²¡æœ‰åŠæ³•å†è·å–åœæ­¢è¿›ç¨‹çš„ä¿¡æ¯ï¼Œåªèƒ½æ‰‹åŠ¨æ€æ­» Kafka è¿›ç¨‹ã€‚</p>
</li>
<li><p>æ³¨æ„äº‹é¡¹</p>
<p>å¯åŠ¨ Kafka å‡ ç§’åè¿›ç¨‹é€€å‡º</p>
<p><strong>è§£å†³æ–¹æ¡ˆï¼šæŸ¥çœ‹å¯åŠ¨æ—¥å¿—</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost kafka3.x]# cat log/server.log</span><br><span class="line">[2023-01-12 23:22:11,589] INFO Cluster ID = Zc7nlyfTQ5qPbhY2d8I_3A (kafka.server.KafkaServer)</span><br><span class="line">[2023-01-12 23:22:11,598] ERROR Fatal error during KafkaServer startup. Prepare to shutdown (kafka.server.KafkaServer)</span><br><span class="line">kafka.common.InconsistentClusterIdException: The Cluster ID 1_3tWXR8Q16qq7H2vwhIng doesn&#x27;t match s tored clusterId Some(ivQZIX9gTB-dj05be_i_-w) in meta.properties. The broker is trying to join the wrong cluster. Configured zookeeper.connect may be wrong.</span><br><span class="line">    at kafka.server.KafkaServer.startup(KafkaServer.scala:228)</span><br><span class="line">    at kafka.Kafka$.main(Kafka.scala:109)</span><br><span class="line">    at kafka.Kafka.main(Kafka.scala)</span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸€æ­¥ï¼šç¡®å®šå†…å­˜å¤Ÿç”¨ï¼Œå¯ä»¥ä¿®æ”¹ï¼ŒKafka é»˜è®¤ 1G</p>
<p>ç¬¬äºŒæ­¥ï¼šmeta.properties å’Œ cluster_id ä¸ä¸€è‡´ï¼Œè¦ä¹ˆåˆ é™¤ç›®å½• <code>log.dirs=/opt/module/kafka/datas </code>åé‡æ–°å¯åŠ¨ï¼ˆæ¨èï¼‰ï¼Œè¦ä¹ˆæ‰‹åŠ¨ä¿®æ”¹ï¼ˆä¸æ¨èï¼‰</p>
</li>
</ul>
<h3 id="å‘½ä»¤è¡Œæ“ä½œ"><a href="#å‘½ä»¤è¡Œæ“ä½œ" class="headerlink" title="å‘½ä»¤è¡Œæ“ä½œ"></a>å‘½ä»¤è¡Œæ“ä½œ</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost kafka3.x]# cd bin &amp;&amp; ls</span><br><span class="line">connect-distributed.sh        kafka-dump-log.sh              kafka-storage.sh</span><br><span class="line">connect-mirror-maker.sh       kafka-features.sh              kafka-streams-application-reset.sh</span><br><span class="line">connect-standalone.sh         kafka-get-offsets.sh           kafka-topics.sh</span><br><span class="line">kafka-acls.sh                 kafka-leader-election.sh       kafka-transactions.sh</span><br><span class="line">kafka-broker-api-versions.sh  kafka-log-dirs.sh              kafka-verifiable-consumer.sh</span><br><span class="line">kafka-cluster.sh              kafka-metadata-shell.sh        kafka-verifiable-producer.sh</span><br><span class="line">kafka-configs.sh              kafka-mirror-maker.sh          trogdor.sh</span><br><span class="line">kafka-console-consumer.sh     kafka-producer-perf-test.sh    windows</span><br><span class="line">kafka-console-producer.sh     kafka-reassign-partitions.sh   zookeeper-security-migration.sh</span><br><span class="line">kafka-consumer-groups.sh      kafka-replica-verification.sh  zookeeper-server-start.sh</span><br><span class="line">kafka-consumer-perf-test.sh   kafka-run-class.sh             zookeeper-server-stop.sh</span><br><span class="line">kafka-delegation-tokens.sh    kafka-server-start.sh          zookeeper-shell.sh</span><br><span class="line">kafka-delete-records.sh       kafka-server-stop.sh</span><br><span class="line">[root@localhost kafka3.x]#</span><br></pre></td></tr></table></figure>

<h4 id="ä¸»é¢˜ç›¸å…³å‘½ä»¤"><a href="#ä¸»é¢˜ç›¸å…³å‘½ä»¤" class="headerlink" title="ä¸»é¢˜ç›¸å…³å‘½ä»¤"></a>ä¸»é¢˜ç›¸å…³å‘½ä»¤</h4><p>æŸ¥çœ‹ä¸»é¢˜æ“ä½œçš„ç›¸å…³å‘½ä»¤å‚æ•°ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ä¸»é¢˜å‘½ä»¤</span></span><br><span class="line">[root@localhost kafka3.x]# bin/kafka-topics.sh</span><br></pre></td></tr></table></figure>

<p>å¸¸ç”¨å‚æ•°ï¼š</p>
<table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>â€“bootstrap-server &lt;String: server to connect to&gt;</td>
<td>è¿æ¥çš„ Kafka Broker ä¸»æœºåç§°å’Œç«¯å£å·</td>
</tr>
<tr>
<td>â€“topic &lt;String: topic&gt;</td>
<td>topic çš„åç§°</td>
</tr>
<tr>
<td>â€“create</td>
<td>åˆ›å»ºä¸»é¢˜</td>
</tr>
<tr>
<td>â€“delete</td>
<td>åˆ é™¤ä¸»é¢˜</td>
</tr>
<tr>
<td>â€“alter</td>
<td>ä¿®æ”¹ä¸»é¢˜</td>
</tr>
<tr>
<td>â€“list</td>
<td>æŸ¥çœ‹æ‰€æœ‰ä¸»é¢˜</td>
</tr>
<tr>
<td>â€“describe</td>
<td>æŸ¥çœ‹ä¸»é¢˜è¯¦ç»†æè¿°ä¿¡æ¯</td>
</tr>
<tr>
<td>â€“partitions &lt;Integer: # of partitions&gt;</td>
<td>è®¾ç½®åˆ†åŒºæ•°</td>
</tr>
<tr>
<td>â€“replication-factor</td>
<td>è®¾ç½®åˆ†åŒºå‰¯æœ¬</td>
</tr>
<tr>
<td>â€“config &lt;String: name&#x3D;value&gt;</td>
<td>æ›´æ–°ç³»ç»Ÿé»˜è®¤çš„é…ç½®</td>
</tr>
</tbody></table>
<p>ç¤ºä¾‹ï¼š</p>
<ul>
<li><p>æŸ¥çœ‹æ‰€æœ‰ä¸»é¢˜</p>
<p>å¤šä¸ª broker ä»¥é€—å·éš”å¼€</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost kafka3.x]# bin/kafka-topics.sh --bootstrap-server 192.168.100.100:9092 --list</span><br><span class="line"></span><br><span class="line">[root@localhost kafka3.x]# bin/kafka-topics.sh --bootstrap-server 192.168.100.100:9092,192.168.100.110:9092 --list</span><br><span class="line"></span><br><span class="line">[root@localhost kafka3.x]#</span><br></pre></td></tr></table></figure>
</li>
<li><p>åˆ›å»ºä¸»é¢˜ first</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost kafka3.x]# bin/kafka-topics.sh --bootstrap-server 192.168.100.100:9092 --create --partitions 1 --replication-factor 3 --topic first</span><br><span class="line">Created topic first.</span><br></pre></td></tr></table></figure>
</li>
<li><p>æŸ¥çœ‹ä¸»é¢˜è¯¦æƒ…</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost kafka3.x]# bin/kafka-topics.sh --bootstrap-server 192.168.100.100:9092 --describe --topic first</span><br><span class="line">Topic: first    TopicId: RO0D3TvwR8yI3TX50bRZKQ PartitionCount: 1       ReplicationFactor: 3    Configs: segment.bytes=1073741824</span><br><span class="line">        Topic: first    Partition: 0    Leader: 2       Replicas: 2,1,0 Isr: 2,1,0</span><br></pre></td></tr></table></figure>
</li>
<li><p>å¢åŠ ä¸»é¢˜åˆ†åŒºæ•°é‡ï¼Œåªèƒ½å¢åŠ ä¸èƒ½å‡å°‘</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost kafka3.x]# bin/kafka-topics.sh --bootstrap-server 192.168.100.100:9092 --alter --partitions 2 --topic first</span><br></pre></td></tr></table></figure>
</li>
<li><p>é‡æ–°æŸ¥çœ‹</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost kafka3.x]# bin/kafka-topics.sh --bootstrap-server 192.168.100.100:9092 --describe --topic first  Topic: first    TopicId: RO0D3TvwR8yI3TX50bRZKQ PartitionCount: 2       ReplicationFactor: 3    Configs: segment.bytes=1073741824</span><br><span class="line">        Topic: first    Partition: 0    Leader: 2       Replicas: 2,1,0 Isr: 2,1,0</span><br><span class="line">        Topic: first    Partition: 1    Leader: 0       Replicas: 0,1,2 Isr: 0,1,2</span><br></pre></td></tr></table></figure>
</li>
<li><p>åˆ é™¤ä¸»é¢˜</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost kafka3.x]# bin/kafka-topics.sh --bootstrap-server 192.168.100.100:9092 --delete --topic first</span><br><span class="line">[root@localhost kafka3.x]#</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="ç”Ÿäº§è€…ç›¸å…³å‘½ä»¤"><a href="#ç”Ÿäº§è€…ç›¸å…³å‘½ä»¤" class="headerlink" title="ç”Ÿäº§è€…ç›¸å…³å‘½ä»¤"></a>ç”Ÿäº§è€…ç›¸å…³å‘½ä»¤</h4><p>ç”Ÿäº§è€…æ“ä½œè„šæœ¬ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost bin]# kafka-console-consumer.sh</span><br></pre></td></tr></table></figure>

<p>ç›¸å…³å‚æ•°ï¼š</p>
<table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>â€“bootstrap-server &lt;String: server to connect to&gt;</td>
<td>è¿æ¥çš„ Kafka Broker ä¸»æœºåç§°å’Œç«¯å£å·</td>
</tr>
<tr>
<td>â€“topic &lt;String: topic&gt;</td>
<td>æ“ä½œçš„ topic åç§°</td>
</tr>
</tbody></table>
<p>ç¤ºä¾‹ï¼š</p>
<ul>
<li><p>å‘é€æ¶ˆæ¯</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-console-producer.sh --bootstrap-server 192.168.100.100:9092 --topic first</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="æ¶ˆè´¹è€…å…ˆç›¸å…³å‘½ä»¤"><a href="#æ¶ˆè´¹è€…å…ˆç›¸å…³å‘½ä»¤" class="headerlink" title="æ¶ˆè´¹è€…å…ˆç›¸å…³å‘½ä»¤"></a>æ¶ˆè´¹è€…å…ˆç›¸å…³å‘½ä»¤</h4><h2 id="kafka-ç”Ÿäº§è€…"><a href="#kafka-ç”Ÿäº§è€…" class="headerlink" title="kafka ç”Ÿäº§è€…"></a>kafka ç”Ÿäº§è€…</h2><h2 id="Kafka-Broker"><a href="#Kafka-Broker" class="headerlink" title="Kafka Broker"></a>Kafka Broker</h2><h2 id="Kafka-æ¶ˆè´¹è€…"><a href="#Kafka-æ¶ˆè´¹è€…" class="headerlink" title="Kafka æ¶ˆè´¹è€…"></a>Kafka æ¶ˆè´¹è€…</h2><h2 id="Kafka-Eagle-ç›‘æ§"><a href="#Kafka-Eagle-ç›‘æ§" class="headerlink" title="Kafka-Eagle ç›‘æ§"></a>Kafka-Eagle ç›‘æ§</h2><h2 id="Kafka-Kraft-æ¨¡å¼"><a href="#Kafka-Kraft-æ¨¡å¼" class="headerlink" title="Kafka-Kraft æ¨¡å¼"></a>Kafka-Kraft æ¨¡å¼</h2><h1 id="Kafka-é›†æˆ"><a href="#Kafka-é›†æˆ" class="headerlink" title="Kafka é›†æˆ"></a>Kafka é›†æˆ</h1><h2 id="é›†æˆ-Flume"><a href="#é›†æˆ-Flume" class="headerlink" title="é›†æˆ Flume"></a>é›†æˆ Flume</h2><h2 id="é›†æˆ-Flink"><a href="#é›†æˆ-Flink" class="headerlink" title="é›†æˆ Flink"></a>é›†æˆ Flink</h2><h2 id="é›†æˆ-SpringBoot"><a href="#é›†æˆ-SpringBoot" class="headerlink" title="é›†æˆ SpringBoot"></a>é›†æˆ SpringBoot</h2><h2 id="é›†æˆ-Spark"><a href="#é›†æˆ-Spark" class="headerlink" title="é›†æˆ Spark"></a>é›†æˆ Spark</h2><h1 id="æºç è§£æ"><a href="#æºç è§£æ" class="headerlink" title="æºç è§£æ"></a>æºç è§£æ</h1><h2 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><h2 id="ç”Ÿäº§è€…æºç "><a href="#ç”Ÿäº§è€…æºç " class="headerlink" title="ç”Ÿäº§è€…æºç "></a>ç”Ÿäº§è€…æºç </h2><h2 id="æ¶ˆè´¹è€…æºç "><a href="#æ¶ˆè´¹è€…æºç " class="headerlink" title="æ¶ˆè´¹è€…æºç "></a>æ¶ˆè´¹è€…æºç </h2><h2 id="æœåŠ¡å™¨æºç "><a href="#æœåŠ¡å™¨æºç " class="headerlink" title="æœåŠ¡å™¨æºç "></a>æœåŠ¡å™¨æºç </h2><h1 id="ç”Ÿäº§è°ƒä¼˜"><a href="#ç”Ÿäº§è°ƒä¼˜" class="headerlink" title="ç”Ÿäº§è°ƒä¼˜"></a>ç”Ÿäº§è°ƒä¼˜</h1><h2 id="Kafka-ç¡¬ä»¶é…ç½®é€‰æ‹©"><a href="#Kafka-ç¡¬ä»¶é…ç½®é€‰æ‹©" class="headerlink" title="Kafka ç¡¬ä»¶é…ç½®é€‰æ‹©"></a>Kafka ç¡¬ä»¶é…ç½®é€‰æ‹©</h2><h2 id="Kafka-ç”Ÿäº§è€…"><a href="#Kafka-ç”Ÿäº§è€…" class="headerlink" title="Kafka ç”Ÿäº§è€…"></a>Kafka ç”Ÿäº§è€…</h2><h2 id="kafka-Broker"><a href="#kafka-Broker" class="headerlink" title="kafka Broker"></a>kafka Broker</h2><h2 id="Kafka-æ¶ˆè´¹è€…-1"><a href="#Kafka-æ¶ˆè´¹è€…-1" class="headerlink" title="Kafka æ¶ˆè´¹è€…"></a>Kafka æ¶ˆè´¹è€…</h2><h2 id="kafka-æ€»ä½“"><a href="#kafka-æ€»ä½“" class="headerlink" title="kafka æ€»ä½“"></a>kafka æ€»ä½“</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/20/RabbitMQ/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MineTing">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/20/RabbitMQ/" class="post-title-link" itemprop="url">RabbitMQ</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-20 00:00:00" itemprop="dateCreated datePublished" datetime="2023-03-20T00:00:00+08:00">2023-03-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-22 16:32:59" itemprop="dateModified" datetime="2023-03-22T16:32:59+08:00">2023-03-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <div align="center"><font size="70"><b>RabbitMQ</b></font></div>

<h1 id="MQ-æ¦‚è¿°"><a href="#MQ-æ¦‚è¿°" class="headerlink" title="MQ æ¦‚è¿°"></a>MQ æ¦‚è¿°</h1><h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>â€‹		MQï¼ŒMessage Queueï¼Œæœ¬è´¨æ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼Œé˜Ÿåˆ—ä¸­å­˜æ”¾çš„æ˜¯æ¶ˆæ¯ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸€ç§è·¨è¿›ç¨‹çš„é€šä¿¡æœºåˆ¶ï¼Œç”¨äºä¸Šä¸‹æ¸¸ä¼ é€’æ•°æ®ã€‚</p>
<h2 id="ä½œç”¨"><a href="#ä½œç”¨" class="headerlink" title="ä½œç”¨"></a>ä½œç”¨</h2><h3 id="æµé‡æ¶ˆå³°"><a href="#æµé‡æ¶ˆå³°" class="headerlink" title="æµé‡æ¶ˆå³°"></a>æµé‡æ¶ˆå³°</h3><p>â€‹		ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœè®¢å•ç³»ç»Ÿæœ€å¤šèƒ½å¤„ç†ä¸€ä¸‡æ¬¡è®¢å•ï¼Œè¿™ä¸ªå¤„ç†èƒ½åŠ›åº”ä»˜æ­£å¸¸æ—¶æ®µçš„ä¸‹å•æ—¶ç»°ç»°æœ‰ä½™ï¼Œæ­£å¸¸æ—¶æ®µæˆ‘ä»¬ä¸‹å•ä¸€ç§’åå°±èƒ½è¿”å›ç»“æœã€‚ä½†æ˜¯åœ¨é«˜å³°æœŸï¼Œå¦‚æœæœ‰ä¸¤ä¸‡æ¬¡ä¸‹å•æ“ä½œç³»ç»Ÿæ˜¯å¤„ç†ä¸äº†çš„ï¼Œåªèƒ½é™åˆ¶è®¢å•è¶…è¿‡ä¸€ä¸‡åä¸å…è®¸ç”¨æˆ·ä¸‹å•ã€‚ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—åšç¼“å†²ï¼Œæˆ‘ä»¬å¯ä»¥å–æ¶ˆè¿™ä¸ªé™åˆ¶ï¼ŒæŠŠä¸€ç§’å†…ä¸‹çš„è®¢å•åˆ†æ•£æˆä¸€æ®µæ—¶é—´æ¥å¤„ç†ï¼Œè¿™æ—¶æœ‰äº›ç”¨æˆ·å¯èƒ½åœ¨ä¸‹å•åå‡ ç§’åæ‰èƒ½æ”¶åˆ°ä¸‹å•æˆåŠŸçš„æ“ä½œï¼Œä½†æ˜¯æ¯”ä¸èƒ½ä¸‹å•çš„ä½“éªŒè¦å¥½ã€‚</p>
<h3 id="åº”ç”¨è§£è€¦"><a href="#åº”ç”¨è§£è€¦" class="headerlink" title="åº”ç”¨è§£è€¦"></a>åº”ç”¨è§£è€¦</h3><p>â€‹		ä»¥ç”µå•†åº”ç”¨ä¸ºä¾‹ï¼Œåº”ç”¨ä¸­æœ‰è®¢å•ç³»ç»Ÿã€åº“å­˜ç³»ç»Ÿã€ç‰©æµç³»ç»Ÿã€æ”¯ä»˜ç³»ç»Ÿã€‚ç”¨æˆ·åˆ›å»ºè®¢å•åï¼Œå¦‚æœè€¦åˆè°ƒç”¨åº“å­˜ç³»ç»Ÿã€ç‰©æµç³»ç»Ÿã€æ”¯ä»˜ç³»ç»Ÿï¼Œä»»ä½•ä¸€ä¸ªå­ç³»ç»Ÿå‡ºäº†æ•…éšœï¼Œéƒ½ä¼šé€ æˆä¸‹å•æ“ä½œå¼‚å¸¸ã€‚å½“è½¬å˜æˆåŸºäºæ¶ˆæ¯é˜Ÿåˆ—çš„æ–¹å¼åï¼Œç³»ç»Ÿé—´è°ƒç”¨çš„é—®é¢˜ä¼šå‡å°‘å¾ˆå¤šï¼Œæ¯”å¦‚ç‰©æµç³»ç»Ÿå› ä¸ºå‘ç”Ÿæ•…éšœï¼Œéœ€è¦å‡ åˆ†é’Ÿæ¥ä¿®å¤ã€‚åœ¨è¿™å‡ åˆ†é’Ÿçš„æ—¶é—´é‡Œï¼Œç‰©æµç³»ç»Ÿè¦å¤„ç†çš„å†…å­˜è¢«ç¼“å­˜åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œç”¨æˆ·çš„ä¸‹å•æ“ä½œå¯ä»¥æ­£å¸¸å®Œæˆã€‚å½“ç‰©æµç³»ç»Ÿæ¢å¤åï¼Œç»§ç»­å¤„ç†è®¢å•ä¿¡æ¯å³å¯ï¼Œä¸­å•ç”¨æˆ·æ„Ÿå—ä¸åˆ°ç‰©æµç³»ç»Ÿçš„æ•…éšœï¼Œæå‡ç³»ç»Ÿçš„å¯ç”¨æ€§ã€‚</p>
<h3 id="å¼‚æ­¥å¤„ç†"><a href="#å¼‚æ­¥å¤„ç†" class="headerlink" title="å¼‚æ­¥å¤„ç†"></a>å¼‚æ­¥å¤„ç†</h3><p>â€‹		æœ‰äº›æœåŠ¡é—´è°ƒç”¨æ˜¯å¼‚æ­¥çš„ï¼Œä¾‹å¦‚ A è°ƒç”¨ Bï¼ŒB éœ€è¦èŠ±è´¹å¾ˆé•¿æ—¶é—´æ‰§è¡Œï¼Œä½†æ˜¯ A éœ€è¦çŸ¥é“ B ä»€ä¹ˆæ—¶å€™å¯ ä»¥æ‰§è¡Œå®Œï¼Œä»¥å‰ä¸€èˆ¬æœ‰ä¸¤ç§æ–¹å¼ï¼ŒA è¿‡ä¸€æ®µæ—¶é—´å»è°ƒç”¨ B çš„æŸ¥è¯¢ api æŸ¥è¯¢ã€‚æˆ–è€… A æä¾›ä¸€ä¸ª callback apiï¼Œ B æ‰§è¡Œå®Œä¹‹åè°ƒç”¨ api é€šçŸ¥ A æœåŠ¡ã€‚è¿™ä¸¤ç§æ–¹å¼éƒ½ä¸æ˜¯å¾ˆä¼˜é›…ï¼Œä½¿ç”¨æ¶ˆæ¯æ€»çº¿ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ A è°ƒç”¨ B æœåŠ¡åï¼Œåªéœ€è¦ç›‘å¬ B å¤„ç†å®Œæˆçš„æ¶ˆæ¯ï¼Œå½“ B å¤„ç†å®Œæˆåï¼Œä¼šå‘é€ä¸€æ¡æ¶ˆæ¯ç»™ MQï¼ŒMQ ä¼šå°†æ­¤ æ¶ˆæ¯è½¬å‘ç»™ A æœåŠ¡ã€‚è¿™æ · A æœåŠ¡æ—¢ä¸ç”¨å¾ªç¯è°ƒç”¨ B çš„æŸ¥è¯¢ apiï¼Œä¹Ÿä¸ç”¨æä¾› callback apiã€‚åŒæ · B æœåŠ¡ä¹Ÿä¸ ç”¨åšè¿™äº›æ“ä½œã€‚A æœåŠ¡è¿˜èƒ½åŠæ—¶çš„å¾—åˆ°å¼‚æ­¥å¤„ç†æˆåŠŸçš„æ¶ˆæ¯ã€‚</p>
<h2 id="MQ-çš„åˆ†ç±»"><a href="#MQ-çš„åˆ†ç±»" class="headerlink" title="MQ çš„åˆ†ç±»"></a>MQ çš„åˆ†ç±»</h2><h3 id="ActiveMQ"><a href="#ActiveMQ" class="headerlink" title="ActiveMQ"></a>ActiveMQ</h3><p>ä¼˜ç‚¹ï¼šå•æœºååé‡ä¸‡çº§ï¼Œæ—¶æ•ˆæ€§ ms çº§ï¼Œå¯ç”¨æ€§é«˜ï¼ŒåŸºäºä¸»ä»æ¶æ„å®ç°é«˜å¯ç”¨æ€§ï¼Œæ¶ˆæ¯å¯é æ€§è¾ƒä½çš„æ¦‚ç‡ä¸¢å¤±æ•°æ®ã€‚</p>
<p>ç¼ºç‚¹ï¼šå®˜æ–¹ç¤¾åŒºç°åœ¨å¯¹ ActiveMQ 5.x ç»´æŠ¤è¶Šæ¥è¶Šå°‘ï¼Œé«˜ååé‡åœºæ™¯è¾ƒå°‘ä½¿ç”¨ã€‚ </p>
<h3 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a>Kafka</h3><p>â€‹		å¤§æ•°æ®çš„æ€æ‰‹é”ï¼Œè°ˆåˆ°å¤§æ•°æ®é¢†åŸŸå†…çš„æ¶ˆæ¯ä¼ è¾“ï¼Œåˆ™ç»•ä¸å¼€ Kafkaï¼Œè¿™æ¬¾ä¸ºå¤§æ•°æ®è€Œç”Ÿçš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œ ä»¥å…¶ç™¾ä¸‡çº§ TPS çš„ååé‡åå£°å¤§å™ªï¼Œè¿…é€Ÿæˆä¸ºå¤§æ•°æ®é¢†åŸŸçš„å® å„¿ï¼Œåœ¨æ•°æ®é‡‡é›†ã€ä¼ è¾“ã€å­˜å‚¨çš„è¿‡ç¨‹ä¸­å‘æŒ¥ç€ä¸¾è¶³è½»é‡çš„ä½œç”¨ã€‚ç›®å‰å·²ç»è¢« LinkedInï¼ŒUber, Twitter, Netflix ç­‰å¤§å…¬å¸æ‰€é‡‡çº³ã€‚ </p>
<p>ä¼˜ç‚¹: æ€§èƒ½å“è¶Šï¼Œå•æœºå†™å…¥ TPS çº¦åœ¨ç™¾ä¸‡æ¡&#x2F;ç§’ï¼Œæœ€å¤§çš„ä¼˜ç‚¹ï¼Œå°±æ˜¯ååé‡é«˜ã€‚æ—¶æ•ˆæ€§ ms çº§å¯ç”¨æ€§é å¸¸é«˜ï¼Œkafka æ˜¯åˆ†å¸ƒå¼çš„ï¼Œä¸€ä¸ªæ•°æ®å¤šä¸ªå‰¯æœ¬ï¼Œå°‘æ•°æœºå™¨å®•æœºï¼Œä¸ä¼šä¸¢å¤±æ•°æ®ï¼Œä¸ä¼šå¯¼è‡´ä¸å¯ç”¨ï¼Œæ¶ˆè´¹è€…é‡‡ç”¨ Pull æ–¹å¼è·å–æ¶ˆæ¯, æ¶ˆæ¯æœ‰åº, é€šè¿‡æ§åˆ¶èƒ½å¤Ÿä¿è¯æ‰€æœ‰æ¶ˆæ¯è¢«æ¶ˆè´¹ä¸”ä»…è¢«æ¶ˆè´¹ä¸€æ¬¡;æœ‰ä¼˜ç§€çš„ç¬¬ä¸‰æ–¹ Kafka Web ç®¡ç†ç•Œé¢ Kafka-Managerï¼›åœ¨æ—¥å¿—é¢†åŸŸæ¯”è¾ƒæˆç†Ÿï¼Œè¢«å¤šå®¶å…¬å¸å’Œå¤šä¸ªå¼€æºé¡¹ç›®ä½¿ç”¨ï¼›åŠŸèƒ½æ”¯æŒï¼š åŠŸèƒ½è¾ƒä¸ºç®€å•ï¼Œä¸»è¦æ”¯æŒç®€å•çš„ MQ åŠŸèƒ½ï¼Œåœ¨å¤§æ•°æ®é¢†åŸŸçš„å®æ—¶è®¡ç®—ä»¥åŠæ—¥å¿—é‡‡é›†è¢«å¤§è§„æ¨¡ä½¿ç”¨ã€‚</p>
<p>ç¼ºç‚¹ï¼šKafka å•æœºè¶…è¿‡ 64 ä¸ªé˜Ÿåˆ—&#x2F;åˆ†åŒºï¼ŒLoad ä¼šå‘ç”Ÿæ˜æ˜¾çš„é£™é«˜ç°è±¡ï¼Œé˜Ÿåˆ—è¶Šå¤šï¼Œload è¶Šé«˜ï¼Œå‘é€æ¶ˆæ¯å“åº”æ—¶é—´å˜é•¿ï¼Œä½¿ç”¨çŸ­è½®è¯¢æ–¹å¼ï¼Œå®æ—¶æ€§å–å†³äºè½®è¯¢é—´éš”æ—¶é—´ï¼Œæ¶ˆè´¹å¤±è´¥ä¸æ”¯æŒé‡è¯•ï¼›æ”¯æŒæ¶ˆæ¯é¡ºåºï¼Œ ä½†æ˜¯ä¸€å°ä»£ç†å®•æœºåï¼Œå°±ä¼šäº§ç”Ÿæ¶ˆæ¯ä¹±åºï¼Œç¤¾åŒºæ›´æ–°è¾ƒæ…¢ï¼›</p>
<h3 id="RocketMQ"><a href="#RocketMQ" class="headerlink" title="RocketMQ"></a>RocketMQ</h3><p>â€‹		RocketMQ å‡ºè‡ªé˜¿é‡Œå·´å·´çš„å¼€æºäº§å“ï¼Œç”¨ Java è¯­è¨€å®ç°ï¼Œåœ¨è®¾è®¡æ—¶å‚è€ƒäº† Kafkaï¼Œå¹¶åšå‡ºäº†è‡ªå·±çš„ä¸€ äº›æ”¹è¿›ã€‚è¢«é˜¿é‡Œå·´å·´å¹¿æ³›åº”ç”¨åœ¨è®¢å•ï¼Œäº¤æ˜“ï¼Œå……å€¼ï¼Œæµè®¡ç®—ï¼Œæ¶ˆæ¯æ¨é€ï¼Œæ—¥å¿—æµå¼å¤„ç†ï¼Œbinglog åˆ†å‘ç­‰åœº æ™¯ã€‚</p>
<p>ç¼ºç‚¹ï¼šæ”¯æŒçš„å®¢æˆ·ç«¯è¯­è¨€ä¸å¤šï¼Œç›®å‰æ˜¯ java åŠ c++ï¼Œå…¶ä¸­ c++ä¸æˆç†Ÿï¼›ç¤¾åŒºæ´»è·ƒåº¦ä¸€èˆ¬ï¼Œæ²¡æœ‰åœ¨ MQ æ ¸å¿ƒä¸­å»å®ç° JMS ç­‰æ¥å£ï¼Œæœ‰äº›ç³»ç»Ÿè¦è¿ç§»éœ€è¦ä¿®æ”¹å¤§é‡ä»£ç ã€‚</p>
<h3 id="RabbitMQ"><a href="#RabbitMQ" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h3><p>â€‹		2007 å¹´å‘å¸ƒï¼Œæ˜¯ä¸€ä¸ªåœ¨ AMQPï¼ˆé«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼‰åŸºç¡€ä¸Šå®Œæˆçš„ï¼Œå¯å¤ç”¨çš„ä¼ä¸šæ¶ˆæ¯ç³»ç»Ÿï¼Œæ˜¯å½“å‰æœ€ä¸»æµçš„æ¶ˆæ¯ä¸­é—´ä»¶ä¹‹ä¸€ã€‚ </p>
<p>ä¼˜ç‚¹ï¼šç”±äº erlang è¯­è¨€çš„é«˜å¹¶å‘ç‰¹æ€§ï¼Œæ€§èƒ½è¾ƒå¥½ï¼›ååé‡åˆ°ä¸‡çº§ï¼ŒMQ åŠŸèƒ½æ¯”è¾ƒå®Œå¤‡,å¥å£®ã€ç¨³å®šã€æ˜“ ç”¨ã€è·¨å¹³å°ã€æ”¯æŒå¤šç§è¯­è¨€ å¦‚ï¼šPythonã€Rubyã€.NETã€Javaã€JMSã€Cã€PHPã€ActionScriptã€XMPPã€STOMP ç­‰ï¼Œæ”¯æŒ AJAX æ–‡æ¡£é½å…¨ï¼›å¼€æºæä¾›çš„ç®¡ç†ç•Œé¢éå¸¸æ£’ï¼Œç”¨èµ·æ¥å¾ˆå¥½ç”¨,ç¤¾åŒºæ´»è·ƒåº¦é«˜ï¼›æ›´æ–°é¢‘ç‡ç›¸å½“é«˜ã€‚</p>
<p>ç¼ºç‚¹ï¼šå•†ä¸šç‰ˆéœ€è¦æ”¶è´¹ï¼Œå­¦ä¹ æˆæœ¬è¾ƒé«˜</p>
<h2 id="MQ-çš„é€‰æ‹©"><a href="#MQ-çš„é€‰æ‹©" class="headerlink" title="MQ çš„é€‰æ‹©"></a>MQ çš„é€‰æ‹©</h2><h3 id="Kafka-1"><a href="#Kafka-1" class="headerlink" title="Kafka"></a>Kafka</h3><p>â€‹		Kafka ä¸»è¦ç‰¹ç‚¹æ˜¯åŸºäº Pull çš„æ¨¡å¼æ¥å¤„ç†æ¶ˆæ¯æ¶ˆè´¹ï¼Œè¿½æ±‚é«˜ååé‡ï¼Œä¸€å¼€å§‹çš„ç›®çš„å°±æ˜¯ç”¨äºæ—¥å¿—æ”¶é›† å’Œä¼ è¾“ï¼Œé€‚åˆäº§ç”Ÿå¤§é‡æ•°æ®çš„äº’è”ç½‘æœåŠ¡çš„æ•°æ®æ”¶é›†ä¸šåŠ¡ã€‚å¤§å‹å…¬å¸å»ºè®®å¯ä»¥é€‰ç”¨ï¼Œå¦‚æœæœ‰æ—¥å¿—é‡‡é›†åŠŸèƒ½ï¼Œ è‚¯å®šæ˜¯é¦–é€‰ kafka äº†ã€‚</p>
<h3 id="RocketMQ-1"><a href="#RocketMQ-1" class="headerlink" title="RocketMQ"></a>RocketMQ</h3><p>â€‹		å¤©ç”Ÿä¸ºé‡‘èäº’è”ç½‘é¢†åŸŸè€Œç”Ÿï¼Œå¯¹äºå¯é æ€§è¦æ±‚å¾ˆé«˜çš„åœºæ™¯ï¼Œå°¤å…¶æ˜¯ç”µå•†é‡Œé¢çš„è®¢å•æ‰£æ¬¾ï¼Œä»¥åŠä¸šåŠ¡å‰Šå³°ï¼Œåœ¨å¤§é‡äº¤æ˜“æ¶Œå…¥æ—¶ï¼Œåç«¯å¯èƒ½æ— æ³•åŠæ—¶å¤„ç†çš„æƒ…å†µã€‚RoketMQ åœ¨ç¨³å®šæ€§ä¸Šå¯èƒ½æ›´å€¼å¾—ä¿¡èµ–ï¼Œè¿™äº›ä¸šåŠ¡åœºæ™¯åœ¨é˜¿é‡ŒåŒ 11 å·²ç»ç»å†äº†å¤šæ¬¡è€ƒéªŒï¼Œå¦‚æœä½ çš„ä¸šåŠ¡æœ‰ä¸Šè¿°å¹¶å‘åœºæ™¯ï¼Œå»ºè®®å¯ä»¥é€‰æ‹© RocketMQã€‚</p>
<h3 id="RabbitMQ-1"><a href="#RabbitMQ-1" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h3><p>â€‹		ç»“åˆ erlang è¯­è¨€æœ¬èº«çš„å¹¶å‘ä¼˜åŠ¿ï¼Œæ€§èƒ½å¥½æ—¶æ•ˆæ€§å¾®ç§’çº§ï¼Œç¤¾åŒºæ´»è·ƒåº¦ä¹Ÿæ¯”è¾ƒé«˜ï¼Œç®¡ç†ç•Œé¢ç”¨èµ·æ¥ååˆ†æ–¹ä¾¿ï¼Œå¦‚æœä½ çš„æ•°æ®é‡æ²¡æœ‰é‚£ä¹ˆå¤§ï¼Œä¸­å°å‹å…¬å¸ä¼˜å…ˆé€‰æ‹©åŠŸèƒ½æ¯”è¾ƒå®Œå¤‡çš„ RabbitMQã€‚</p>
<h2 id="RabbitMQ-2"><a href="#RabbitMQ-2" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h2><p>åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/">https://www.rabbitmq.com</a></p>
<h3 id="å››å¤§æ ¸å¿ƒæ¦‚å¿µ"><a href="#å››å¤§æ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="å››å¤§æ ¸å¿ƒæ¦‚å¿µ"></a>å››å¤§æ ¸å¿ƒæ¦‚å¿µ</h3><h4 id="ç”Ÿäº§è€…"><a href="#ç”Ÿäº§è€…" class="headerlink" title="ç”Ÿäº§è€…"></a>ç”Ÿäº§è€…</h4><p>â€‹		äº§ç”Ÿæ•°æ®å‘é€æ¶ˆæ¯çš„ç¨‹åºæ˜¯ç”Ÿäº§è€…</p>
<h4 id="äº¤æ¢æœº"><a href="#äº¤æ¢æœº" class="headerlink" title="äº¤æ¢æœº"></a>äº¤æ¢æœº</h4><p>â€‹		äº¤æ¢æœºæ˜¯ RabbitMQ éå¸¸é‡è¦çš„ä¸€ä¸ªéƒ¨ä»¶ï¼Œä¸€æ–¹é¢å®ƒæ¥æ”¶æ¥è‡ªç”Ÿäº§è€…çš„æ¶ˆæ¯ï¼Œå¦ä¸€æ–¹é¢å®ƒå°†æ¶ˆæ¯æ¨é€åˆ°é˜Ÿåˆ—ä¸­ã€‚äº¤æ¢æœºå¿…é¡»ç¡®åˆ‡çŸ¥é“å¦‚ä½•å¤„ç†å®ƒæ¥æ”¶åˆ°çš„æ¶ˆæ¯ï¼Œæ˜¯å°†è¿™äº›æ¶ˆæ¯æ¨é€åˆ°ç‰¹å®šé˜Ÿåˆ—è¿˜æ˜¯æ¨é€åˆ°å¤šä¸ªé˜Ÿåˆ—ï¼Œäº¦æˆ–è€…æ˜¯æŠŠæ¶ˆæ¯ä¸¢å¼ƒï¼Œè¿™ä¸ªå¾—æœ‰äº¤æ¢æœºç±»å‹å†³å®šã€‚</p>
<h4 id="é˜Ÿåˆ—"><a href="#é˜Ÿåˆ—" class="headerlink" title="é˜Ÿåˆ—"></a>é˜Ÿåˆ—</h4><p>â€‹		é˜Ÿåˆ—æ˜¯ RabbitMQ å†…éƒ¨ä½¿ç”¨çš„ä¸€ç§æ•°æ®ç»“æ„ï¼Œå°½ç®¡æ¶ˆæ¯æµç» RabbitMQ å’Œåº”ç”¨ç¨‹åºï¼Œä½†å®ƒä»¬åªèƒ½å­˜å‚¨åœ¨é˜Ÿåˆ—ä¸­ã€‚é˜Ÿåˆ—ä»…å—ä¸»æœºçš„å†…å­˜å’Œç£ç›˜é™åˆ¶çš„çº¦æŸï¼Œ<strong>æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå¤§çš„æ¶ˆæ¯ç¼“å†²åŒº</strong>ã€‚è®¸å¤šç”Ÿäº§è€…å¯ ä»¥å°†æ¶ˆæ¯å‘é€åˆ°ä¸€ä¸ªé˜Ÿåˆ—ï¼Œè®¸å¤šæ¶ˆè´¹è€…å¯ä»¥å°è¯•ä»ä¸€ä¸ªé˜Ÿåˆ—æ¥æ”¶æ•°æ®ã€‚</p>
<h4 id="æ¶ˆè´¹è€…"><a href="#æ¶ˆè´¹è€…" class="headerlink" title="æ¶ˆè´¹è€…"></a>æ¶ˆè´¹è€…</h4><p>â€‹		æ¶ˆè´¹ä¸æ¥æ”¶å…·æœ‰ç›¸ä¼¼çš„å«ä¹‰ã€‚æ¶ˆè´¹è€…å¤§å¤šæ—¶å€™æ˜¯ä¸€ä¸ªç­‰å¾…æ¥æ”¶æ¶ˆæ¯çš„ç¨‹åºã€‚è¯·æ³¨æ„ç”Ÿäº§è€…ï¼Œæ¶ˆè´¹è€…å’Œæ¶ˆæ¯ä¸­é—´ä»¶å¾ˆå¤šæ—¶å€™å¹¶ä¸åœ¨åŒä¸€æœºå™¨ä¸Šã€‚åŒä¸€ä¸ªåº”ç”¨ç¨‹åºæ—¢å¯ä»¥æ˜¯ç”Ÿäº§è€…åˆæ˜¯å¯ä»¥æ˜¯æ¶ˆè´¹è€…ã€‚</p>
<h3 id="RabbitMQ-æ ¸å¿ƒéƒ¨åˆ†"><a href="#RabbitMQ-æ ¸å¿ƒéƒ¨åˆ†" class="headerlink" title="RabbitMQ æ ¸å¿ƒéƒ¨åˆ†"></a>RabbitMQ æ ¸å¿ƒéƒ¨åˆ†</h3><p><img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221014144642167.png" alt="image-20221014144642167"></p>
<h3 id="å„ä¸ªåè¯ä»‹ç»"><a href="#å„ä¸ªåè¯ä»‹ç»" class="headerlink" title="å„ä¸ªåè¯ä»‹ç»"></a>å„ä¸ªåè¯ä»‹ç»</h3><img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221014144657597.png" alt="image-20221014144657597" style="zoom:80%;">

<ul>
<li>Brokerï¼šæ¥æ”¶å’Œåˆ†å‘æ¶ˆæ¯çš„åº”ç”¨ï¼ŒRabbitMQ Server å°±æ˜¯ Message Brokerã€‚</li>
<li>Virtual hostï¼šå‡ºäºå¤šç§Ÿæˆ·å’Œå®‰å…¨å› ç´ è®¾è®¡çš„ï¼ŒæŠŠ AMQP çš„åŸºæœ¬ç»„ä»¶åˆ’åˆ†åˆ°ä¸€ä¸ªè™šæ‹Ÿçš„åˆ†ç»„ä¸­ï¼Œç±»ä¼¼äºç½‘ç»œä¸­çš„ namespace æ¦‚å¿µã€‚å½“å¤šä¸ªä¸åŒçš„ç”¨æˆ·ä½¿ç”¨åŒä¸€ä¸ª RabbitMQ server æä¾›çš„æœåŠ¡æ—¶ï¼Œå¯ä»¥åˆ’åˆ†å‡ºå¤šä¸ª vhostï¼Œæ¯ä¸ªç”¨æˆ·åœ¨è‡ªå·±çš„ vhost åˆ›å»º exchangeï¼queue ç­‰ã€‚</li>
<li>Connectionï¼špublisherï¼consumer å’Œ broker ä¹‹é—´çš„ TCP è¿æ¥ Channelï¼šå¦‚æœæ¯ä¸€æ¬¡è®¿é—® RabbitMQ éƒ½å»ºç«‹ä¸€ä¸ª Connectionï¼Œåœ¨æ¶ˆæ¯é‡å¤§çš„æ—¶å€™å»ºç«‹ TCP Connection çš„å¼€é”€å°†æ˜¯å·¨å¤§çš„ï¼Œæ•ˆç‡ä¹Ÿè¾ƒä½ã€‚Channel æ˜¯åœ¨ connection å†…éƒ¨å»ºç«‹çš„é€»è¾‘è¿æ¥ï¼Œå¦‚æœåº”ç”¨ç¨‹åºæ”¯æŒå¤šçº¿ç¨‹ï¼Œé€šå¸¸æ¯ä¸ª thread åˆ›å»ºå•ç‹¬çš„ channel è¿›è¡Œé€šè®¯ï¼Œ<strong>AMQP method åŒ…å«äº† channel id å¸®åŠ©å®¢ æˆ·ç«¯å’Œ message broker è¯†åˆ« channel</strong>ï¼Œæ‰€ä»¥ channel ä¹‹é—´æ˜¯å®Œå…¨éš”ç¦»çš„ã€‚Channel ä½œä¸ºè½»é‡çº§çš„ Connection æå¤§å‡å°‘äº†æ“ä½œç³»ç»Ÿå»ºç«‹ TCP connection çš„å¼€é”€ã€‚</li>
<li>Exchangeï¼šmessage åˆ°è¾¾ broker çš„ç¬¬ä¸€ç«™ï¼Œæ ¹æ®åˆ†å‘è§„åˆ™ï¼ŒåŒ¹é…æŸ¥è¯¢è¡¨ä¸­çš„ routing keyï¼Œåˆ†å‘æ¶ˆæ¯åˆ° queue ä¸­å»ã€‚å¸¸ç”¨çš„ç±»å‹æœ‰ï¼šdirect (point-to-point), topic (publish-subscribe) and fanout (multicast) </li>
<li>Queueï¼šæ¶ˆæ¯æœ€ç»ˆè¢«é€åˆ°è¿™é‡Œç­‰å¾… consumer å–èµ°ã€‚</li>
<li>Bindingï¼šexchange å’Œ queue ä¹‹é—´çš„è™šæ‹Ÿè¿æ¥ï¼Œbinding ä¸­å¯ä»¥åŒ…å« routing keyï¼ŒBinding ä¿¡æ¯è¢«ä¿å­˜åˆ° exchange ä¸­çš„æŸ¥è¯¢è¡¨ä¸­ï¼Œç”¨äº message çš„åˆ†å‘ä¾æ®ã€‚</li>
</ul>
<h3 id="å®‰è£…åŠå¯åŠ¨"><a href="#å®‰è£…åŠå¯åŠ¨" class="headerlink" title="å®‰è£…åŠå¯åŠ¨"></a>å®‰è£…åŠå¯åŠ¨</h3><p>ä¸‹è½½åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/download.html">https://www.rabbitmq.com/download.html</a></p>
<p>ä»¥ rabbitmq-server-3.8.8-1.el7.noarch.rpm ã€ erlang-21.3-1.el7.x86_64.rpm ä¸ºä¾‹ï¼š</p>
<h4 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h4><p>ä¸Šä¼ è‡³ &#x2F;usr&#x2F;local&#x2F;src ç›®å½•ä¸‹ï¼Œé€šè¿‡ rpm å®‰è£…ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# cd /usr/local/src/</span><br><span class="line">[root@localhost src]# ls</span><br><span class="line">erlang-21.3-1.el7.x86_64.rpm rabbitmq-server-3.8.8-1.el7.noarch.rpm</span><br><span class="line">    </span><br><span class="line">[root@localhost src]# rpm -ivh erlang-21.3-1.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line">[root@localhost src]# yum install socat -y</span><br><span class="line"></span><br><span class="line">[root@localhost src]# rpm -ivh rabbitmq-server-3.8.8-1.el7.noarch.rpm</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å¼€æœºè‡ªå¯åŠ¨</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost src]# chkconfig rabbitmq-server on</span><br></pre></td></tr></table></figure>

<p>å¯åŠ¨æœåŠ¡</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost src]# /sbin/service rabbitmq-server start</span><br></pre></td></tr></table></figure>

<p>æŸ¥çœ‹æœåŠ¡çŠ¶æ€</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost src]# /sbin/service rabbitmq-server status</span><br></pre></td></tr></table></figure>

<p>åœæ­¢æœåŠ¡</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost src]# /sbin/service rabbitmq-server stop </span><br></pre></td></tr></table></figure>

<p>å¼€å¯ web ç®¡ç†æ’ä»¶</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost src]# rabbitmq-plugins enable rabbitmq_management</span><br></pre></td></tr></table></figure>

<p>å…³é—­é˜²ç«å¢™ï¼Œä½¿ç”¨é»˜è®¤è´¦å·ï¼ˆguestï¼‰ï¼Œå¯†ç ï¼ˆguestï¼‰ç™»å½•ï¼š192.168.100.100:15672</p>
<img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221014150804190.png" alt="image-20221014150804190" style="zoom:80%;">

<p>å‡ºç°æƒé™é—®é¢˜ï¼š</p>
<p>â€‹		ç”¨æˆ·åªèƒ½é€šè¿‡æœ¬åœ°ä¸»æœºç™»å½•ã€‚</p>
<h4 id="æ·»åŠ ç”¨æˆ·"><a href="#æ·»åŠ ç”¨æˆ·" class="headerlink" title="æ·»åŠ ç”¨æˆ·"></a>æ·»åŠ ç”¨æˆ·</h4><p>åˆ›å»ºè´¦å·</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost src]# rabbitmqctl add_user admin admin</span><br></pre></td></tr></table></figure>

<p>è®¾ç½®ç”¨æˆ·è§’è‰²</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost src]# rabbitmqctl set_user_tags admin administrator </span><br></pre></td></tr></table></figure>

<p>è®¾ç½®ç”¨æˆ·æƒé™</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">set_permissions [-p &lt;vhostpath&gt;] &lt;user&gt; &lt;conf&gt; &lt;write&gt; &lt;<span class="built_in">read</span>&gt;</span></span><br><span class="line">[root@localhost src]# rabbitmqctl set_permissions -p &quot;/&quot; admin &quot;.*&quot; &quot;.*&quot; &quot;.*&quot; </span><br></pre></td></tr></table></figure>

<p>ç”¨æˆ· user_admin å…·æœ‰ &#x2F;vhost1 è¿™ä¸ª virtual host ä¸­æ‰€æœ‰èµ„æºçš„é…ç½®ã€å†™ã€è¯»æƒé™ </p>
<p>å½“å‰ç”¨æˆ·å’Œè§’è‰²</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost src]# rabbitmqctl list_users</span><br></pre></td></tr></table></figure>

<p>å†æ¬¡åˆ©ç”¨ admin ç”¨æˆ·ç™»å½•ï¼š</p>
<p><img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221014151648674.png" alt="image-20221014151648674"></p>
<h4 id="é‡ç½®å‘½ä»¤"><a href="#é‡ç½®å‘½ä»¤" class="headerlink" title="é‡ç½®å‘½ä»¤"></a>é‡ç½®å‘½ä»¤</h4><p>å…³é—­åº”ç”¨çš„å‘½ä»¤</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl stop_app</span><br></pre></td></tr></table></figure>

<p>æ¸…é™¤çš„å‘½ä»¤</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl reset</span><br></pre></td></tr></table></figure>

<p>é‡æ–°å¯åŠ¨å‘½ä»¤</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl start_app</span><br></pre></td></tr></table></figure>

<h1 id="ç®€å•ç¤ºä¾‹"><a href="#ç®€å•ç¤ºä¾‹" class="headerlink" title="ç®€å•ç¤ºä¾‹"></a>ç®€å•ç¤ºä¾‹</h1><h2 id="HelloWorld"><a href="#HelloWorld" class="headerlink" title="HelloWorld"></a>HelloWorld</h2><p>å¼•å…¥ä¾èµ–ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.rabbitmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>amqp-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>è¿æ¥ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.rabbitmq.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitConnectUtil</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Channel <span class="title function_">getChannel</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        factory.setHost(<span class="string">&quot;192.168.100.100&quot;</span>);</span><br><span class="line">        factory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        factory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line">        <span class="keyword">return</span> connection.createChannel();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”Ÿäº§è€…ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.rabbitmq.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.rabbitmq.util.RabbitConnectUtil;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;demo&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitConnectUtil.getChannel();</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * ç”Ÿæˆä¸€ä¸ªé˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">         * 1. é˜Ÿåˆ—åç§°</span></span><br><span class="line"><span class="comment">         * 2. é˜Ÿåˆ—é‡Œé¢çš„æ¶ˆæ¯æ˜¯å¦æŒä¹…åŒ–ï¼Œé»˜è®¤æ¶ˆæ¯å­˜å‚¨åœ¨å†…å­˜ä¸­</span></span><br><span class="line"><span class="comment">         * 3. è¯¥é˜Ÿåˆ—æ˜¯å¦åªä¾›ä¸€ä¸ªæ¶ˆè´¹è€…è¿›è¡Œæ¶ˆè´¹ï¼Œæ˜¯å¦è¿›è¡Œå…±äº«ï¼Œé»˜è®¤trueï¼Œå¯ä»¥å¤šä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹</span></span><br><span class="line"><span class="comment">         * 4. æ˜¯å¦è‡ªåŠ¨åˆ é™¤ï¼šæœ€åä¸€ä¸ªæ¶ˆè´¹è€…ç«¯å¼€è¿æ¥ä»¥åï¼Œè¯¥é˜Ÿåˆ—æ˜¯å¦è‡ªåŠ¨åˆ é™¤ï¼Œtrueï¼šè‡ªåŠ¨åˆ é™¤</span></span><br><span class="line"><span class="comment">         * 5. å…¶ä»–å‚æ•°</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;Hello RabbitMQ&quot;</span>;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * å‘é€æ¶ˆæ¯</span></span><br><span class="line"><span class="comment">         * 1. å‘é€åˆ°é‚£ä¸ªäº¤æ¢æœº</span></span><br><span class="line"><span class="comment">         * 2. è·¯ç”±çš„ key</span></span><br><span class="line"><span class="comment">         * 3. å…¶ä»–çš„å‚æ•°ä¿¡æ¯</span></span><br><span class="line"><span class="comment">         * 4. å‘é€æ¶ˆæ¯çš„æ¶ˆæ¯ä½“</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        channel.basicPublish(<span class="string">&quot;&quot;</span>, QUEUE_NAME, <span class="literal">null</span>, message.getBytes());</span><br><span class="line">        System.out.println(<span class="string">&quot;æ¶ˆæ¯å‘é€å®Œæ¯•...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¶ˆè´¹è€…ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.rabbitmq.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.rabbitmq.util.RabbitConnectUtil;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.CancelCallback;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.DeliverCallback;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Delivery;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;demo&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitConnectUtil.getChannel();</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * æ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯</span></span><br><span class="line"><span class="comment">         * 1.æ¶ˆè´¹å“ªä¸ªé˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">         * 2.æ¶ˆè´¹æˆåŠŸä¹‹åæ˜¯å¦è¦è‡ªåŠ¨åº”ç­” true ä»£è¡¨è‡ªåŠ¨åº”ç­” false æ‰‹åŠ¨åº”ç­”</span></span><br><span class="line"><span class="comment">         * 3.æ¶ˆè´¹è€…æœªæˆåŠŸæ¶ˆè´¹çš„å›è°ƒ</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        channel.basicConsume(</span><br><span class="line">                QUEUE_NAME,</span><br><span class="line">                <span class="literal">true</span>,</span><br><span class="line">                <span class="comment">// æ¨é€çš„æ¶ˆæ¯è¿›è¡Œæ¶ˆè´¹çš„å›è°ƒ</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DeliverCallback</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s, Delivery delivery)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                        System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody()));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="comment">// å–æ¶ˆæ¶ˆè´¹çš„å›è°ƒ</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">CancelCallback</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;æ¶ˆæ¯æ¶ˆè´¹è¢«ä¸­æ–­&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•ï¼š</p>
<p>â€‹		å…ˆå¯åŠ¨ç”Ÿäº§è€…ï¼Œåœ¨å¯åŠ¨æ¶ˆè´¹è€…ã€‚</p>
<h2 id="Work-Queues"><a href="#Work-Queues" class="headerlink" title="Work Queues"></a>Work Queues</h2><p>â€‹		å·¥ä½œé˜Ÿåˆ—ï¼ˆåˆç§°ä»»åŠ¡é˜Ÿåˆ—ï¼‰ä¸»è¦æ€æƒ³ï¼š<strong>é¿å…ç«‹å³æ‰§è¡Œèµ„æºå¯†é›†å‹ä»»åŠ¡ï¼Œè€Œä¸å¾—ä¸ç­‰å¾…å®ƒå®Œæˆã€‚</strong> ç›¸åæˆ‘ä»¬å®‰æ’ä»»åŠ¡åœ¨ä¹‹åæ‰§è¡Œã€‚æˆ‘ä»¬æŠŠä»»åŠ¡å°è£…ä¸ºæ¶ˆæ¯å¹¶å°†å…¶å‘é€åˆ°é˜Ÿåˆ—ã€‚åœ¨åå°è¿è¡Œçš„å·¥ä½œè¿› ç¨‹å°†å¼¹å‡ºä»»åŠ¡å¹¶æœ€ç»ˆæ‰§è¡Œä½œä¸šã€‚å½“æœ‰å¤šä¸ªå·¥ä½œçº¿ç¨‹æ—¶ï¼Œè¿™äº›å·¥ä½œçº¿ç¨‹å°†ä¸€èµ·å¤„ç†è¿™äº›ä»»åŠ¡ã€‚</p>
<h3 id="è½®è®­åˆ†å‘æ¶ˆæ¯"><a href="#è½®è®­åˆ†å‘æ¶ˆæ¯" class="headerlink" title="è½®è®­åˆ†å‘æ¶ˆæ¯"></a>è½®è®­åˆ†å‘æ¶ˆæ¯</h3><p>â€‹		å¯åŠ¨ä¸¤ä¸ªæ¶ˆè´¹è€…ï¼Œä¸€ä¸ªç”Ÿäº§è€…ï¼Œä¼šå‘ç°å¯¹äºç”Ÿäº§çš„æ¶ˆæ¯ä¼šè½®è¯¢ä¾æ¬¡è¿›è¡Œæ¶ˆè´¹ã€‚</p>
<p>ç”Ÿäº§è€…ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.rabbitmq.workqueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.rabbitmq.util.RabbitConnectUtil;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;demo&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitConnectUtil.getChannel();</span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">sc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">        <span class="keyword">while</span> (sc.hasNext()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> sc.nextLine();</span><br><span class="line">            channel.basicPublish(<span class="string">&quot;&quot;</span>, QUEUE_NAME, <span class="literal">null</span>, message.getBytes());</span><br><span class="line">            System.out.println(<span class="string">&quot;æ¶ˆæ¯å‘é€å®Œæˆï¼š&quot;</span> + message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¶ˆè´¹è€…ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.rabbitmq.workqueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.rabbitmq.util.RabbitConnectUtil;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.CancelCallback;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.DeliverCallback;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Delivery;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;demo&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitConnectUtil.getChannel();</span><br><span class="line">        System.out.println(<span class="string">&quot;ç­‰å¾…æ¥å—æ¶ˆæ¯...&quot;</span>);</span><br><span class="line">        channel.basicConsume(QUEUE_NAME, <span class="literal">true</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DeliverCallback</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s, Delivery delivery)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;Consumer æ”¶åˆ°æ¶ˆæ¯ï¼š&quot;</span> + </span><br><span class="line">                                           <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody()));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">CancelCallback</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                        System.out.println(s + <span class="string">&quot;æ¶ˆè´¹è€…å–æ¶ˆæ¶ˆè´¹æ¥å£å›è°ƒé€»è¾‘&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        );</span><br><span class="line">        System.out.println(<span class="string">&quot;Consumer01 ç­‰å¾…...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•ï¼š</p>
<p>ç”Ÿäº§è€…ä¾æ¬¡å‘é€ï¼šA	B	C	D</p>
<p>æ¶ˆè´¹è€…ä¸€æ”¶åˆ°ï¼šA	Cï¼Œæ¶ˆè´¹è€…äºŒæ”¶åˆ°ï¼šB	D</p>
<h3 id="æ¶ˆæ¯åº”ç­”"><a href="#æ¶ˆæ¯åº”ç­”" class="headerlink" title="æ¶ˆæ¯åº”ç­”"></a>æ¶ˆæ¯åº”ç­”</h3><p>â€‹		æ¶ˆè´¹è€…å®Œæˆä¸€ä¸ªä»»åŠ¡å¯èƒ½éœ€è¦ä¸€æ®µæ—¶é—´ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªæ¶ˆè´¹è€…å¤„ç†ä¸€ä¸ªé•¿çš„ä»»åŠ¡å¹¶ä»…åªå®Œæˆäº†éƒ¨åˆ†çªç„¶å®ƒæŒ‚æ‰äº†ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µã€‚RabbitMQ ä¸€æ—¦å‘æ¶ˆè´¹è€…ä¼ é€’äº†ä¸€æ¡æ¶ˆæ¯ï¼Œä¾¿ç«‹å³å°†è¯¥æ¶ˆæ¯æ ‡è®°ä¸ºåˆ é™¤ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œçªç„¶æœ‰ä¸ªæ¶ˆè´¹è€…æŒ‚æ‰äº†ï¼Œæˆ‘ä»¬å°†ä¸¢å¤±æ­£åœ¨å¤„ç†çš„æ¶ˆæ¯ã€‚ä»¥åŠåç»­å‘é€ç»™è¯¥æ¶ˆè´¹è€…çš„æ¶ˆæ¯ï¼Œå› ä¸ºå®ƒæ— æ³•æ¥æ”¶åˆ°ã€‚</p>
<p>â€‹		ä¸ºäº†ä¿è¯æ¶ˆæ¯åœ¨å‘é€è¿‡ç¨‹ä¸­ä¸ä¸¢å¤±ï¼Œrabbitmq å¼•å…¥æ¶ˆæ¯åº”ç­”æœºåˆ¶ï¼Œæ¶ˆæ¯åº”ç­”å°±æ˜¯ï¼šæ¶ˆè´¹è€…åœ¨æ¥æ”¶åˆ°æ¶ˆæ¯å¹¶ä¸”å¤„ç†è¯¥æ¶ˆæ¯ä¹‹åï¼Œå‘Šè¯‰ rabbitmq å®ƒå·²ç»å¤„ç†äº†ï¼Œrabbitmq å¯ä»¥æŠŠè¯¥æ¶ˆæ¯åˆ é™¤äº†ã€‚</p>
<h4 id="è‡ªåŠ¨åº”ç­”"><a href="#è‡ªåŠ¨åº”ç­”" class="headerlink" title="è‡ªåŠ¨åº”ç­”"></a>è‡ªåŠ¨åº”ç­”</h4><p>â€‹		æ¶ˆæ¯å‘é€åç«‹å³è¢«è®¤ä¸ºå·²ç»ä¼ é€æˆåŠŸï¼Œè¿™ç§æ¨¡å¼éœ€è¦åœ¨é«˜ååé‡å’Œæ•°æ®ä¼ è¾“å®‰å…¨æ€§æ–¹é¢åšæƒ è¡¡,å› ä¸ºè¿™ç§æ¨¡å¼å¦‚æœæ¶ˆæ¯åœ¨æ¥æ”¶åˆ°ä¹‹å‰ï¼Œæ¶ˆè´¹è€…é‚£è¾¹å‡ºç°è¿æ¥æˆ–è€… channel å…³é—­ï¼Œé‚£ä¹ˆæ¶ˆæ¯å°±ä¸¢ å¤±äº†,å½“ç„¶å¦ä¸€æ–¹é¢è¿™ç§æ¨¡å¼æ¶ˆè´¹è€…é‚£è¾¹å¯ä»¥ä¼ é€’è¿‡è½½çš„æ¶ˆæ¯ï¼Œæ²¡æœ‰å¯¹ä¼ é€’çš„æ¶ˆæ¯æ•°é‡è¿›è¡Œé™åˆ¶ï¼Œ å½“ç„¶è¿™æ ·æœ‰å¯èƒ½ä½¿å¾—æ¶ˆè´¹è€…è¿™è¾¹ç”±äºæ¥æ”¶å¤ªå¤šè¿˜æ¥ä¸åŠå¤„ç†çš„æ¶ˆæ¯ï¼Œå¯¼è‡´è¿™äº›æ¶ˆæ¯çš„ç§¯å‹ï¼Œæœ€ç»ˆä½¿å¾—å†…å­˜è€—å°½ï¼Œæœ€ç»ˆè¿™äº›æ¶ˆè´¹è€…çº¿ç¨‹è¢«æ“ä½œç³»ç»Ÿæ€æ­»ï¼Œæ‰€ä»¥è¿™ç§æ¨¡å¼ä»…é€‚ç”¨åœ¨æ¶ˆè´¹è€…å¯ä»¥é«˜æ•ˆå¹¶ ä»¥æŸç§é€Ÿç‡èƒ½å¤Ÿå¤„ç†è¿™äº›æ¶ˆæ¯çš„æƒ…å†µä¸‹ä½¿ç”¨ã€‚</p>
<h4 id="æ¶ˆæ¯åº”ç­”çš„æ–¹æ³•"><a href="#æ¶ˆæ¯åº”ç­”çš„æ–¹æ³•" class="headerlink" title="æ¶ˆæ¯åº”ç­”çš„æ–¹æ³•"></a>æ¶ˆæ¯åº”ç­”çš„æ–¹æ³•</h4><ul>
<li>Channel.basicAckï¼ˆç”¨äºè‚¯å®šç¡®è®¤ï¼‰ï¼šRabbitMQ å·²çŸ¥é“è¯¥æ¶ˆæ¯å¹¶ä¸”æˆåŠŸçš„å¤„ç†æ¶ˆæ¯ï¼Œå¯ä»¥å°†å…¶ä¸¢å¼ƒäº†</li>
<li>Channel.basicNackï¼ˆç”¨äºå¦å®šç¡®è®¤ï¼‰ </li>
<li>Channel.basicRejectï¼ˆç”¨äºå¦å®šç¡®è®¤ï¼‰ï¼šä¸ Channel.basicNack ç›¸æ¯”å°‘ä¸€ä¸ªå‚æ•°ï¼Œç›´æ¥æ‹’ç»å¤„ç†æ”¹å‚æ•°ï¼Œå¯ä»¥ä¸¢å¼ƒ</li>
</ul>
<h4 id="Multiple"><a href="#Multiple" class="headerlink" title="Multiple"></a>Multiple</h4><p>â€‹		æ‰‹åŠ¨åº”ç­”çš„å¥½å¤„æ˜¯å¯ä»¥æ‰¹é‡åº”ç­”å¹¶ä¸”å‡å°‘ç½‘ç»œæ‹¥å µ ã€‚</p>
<p>multiple çš„ true å’Œ false ä»£è¡¨ä¸åŒæ„æ€ï¼š</p>
<p>trueï¼šä»£è¡¨æ‰¹é‡åº”ç­”channel ä¸Šæœªåº”ç­”çš„æ¶ˆæ¯ï¼Œæ¯”å¦‚è¯´ channel ä¸Šæœ‰ä¼ é€ tag çš„æ¶ˆæ¯ 5, 6, 7, 8 ï¼Œå½“å‰ tag æ˜¯ 8 ï¼Œé‚£ä¹ˆæ­¤æ—¶ 5-8 çš„è¿™äº›è¿˜æœªåº”ç­”çš„æ¶ˆæ¯éƒ½ä¼šè¢«ç¡®è®¤æ”¶åˆ°æ¶ˆæ¯åº”ç­”ã€‚</p>
<p>falseï¼šåŒä¸Šé¢ç›¸æ¯”åªä¼šåº”ç­” tag&#x3D;8 çš„æ¶ˆæ¯ 5, 6, 7 è¿™ä¸‰ä¸ªæ¶ˆæ¯ä¾ç„¶ä¸ä¼šè¢«ç¡®è®¤æ”¶åˆ°æ¶ˆæ¯åº”ç­”ã€‚</p>
<p><img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221014164805126.png" alt="image-20221014164805126"></p>
<p><strong>ä¸€èˆ¬é‡‡ç”¨ falseï¼Œä¿è¯æ•°æ®ä¸ä¼šä¸¢å¤±</strong>ï¼Œä»¥ä¸Šæ‰¹é‡å¯èƒ½ä¼šå¯¼è‡´ 5ï¼Œ6, 7ä¸¢å¤±ã€‚</p>
<h4 id="æ¶ˆæ¯è‡ªåŠ¨é‡æ–°å…¥é˜Ÿ"><a href="#æ¶ˆæ¯è‡ªåŠ¨é‡æ–°å…¥é˜Ÿ" class="headerlink" title="æ¶ˆæ¯è‡ªåŠ¨é‡æ–°å…¥é˜Ÿ"></a>æ¶ˆæ¯è‡ªåŠ¨é‡æ–°å…¥é˜Ÿ</h4><p>â€‹		å¦‚æœæ¶ˆè´¹è€…ç”±äºæŸäº›åŸå› å¤±å»è¿æ¥ï¼ˆå…¶é€šé“å·²å…³é—­ï¼Œè¿æ¥å·²å…³é—­æˆ– TCP è¿æ¥ä¸¢å¤±ï¼‰ï¼Œå¯¼è‡´æ¶ˆæ¯ æœªå‘é€ ACK ç¡®è®¤ï¼ŒRabbitMQ å°†äº†è§£åˆ°æ¶ˆæ¯æœªå®Œå…¨å¤„ç†ï¼Œå¹¶å°†å¯¹å…¶é‡æ–°æ’é˜Ÿã€‚å¦‚æœæ­¤æ—¶å…¶ä»–æ¶ˆè´¹è€… å¯ä»¥å¤„ç†ï¼Œå®ƒå°†å¾ˆå¿«å°†å…¶é‡æ–°åˆ†å‘ç»™å¦ä¸€ä¸ªæ¶ˆè´¹è€…ã€‚è¿™æ ·å³ä½¿æŸä¸ªæ¶ˆè´¹è€…å¶å°”æ­»äº¡ï¼Œä¹Ÿå¯ä»¥ç¡®ä¿ä¸ä¼šä¸¢å¤±ä»»ä½•æ¶ˆæ¯ã€‚</p>
<h4 id="æ‰‹åŠ¨åº”ç­”ç¤ºä¾‹"><a href="#æ‰‹åŠ¨åº”ç­”ç¤ºä¾‹" class="headerlink" title="æ‰‹åŠ¨åº”ç­”ç¤ºä¾‹"></a>æ‰‹åŠ¨åº”ç­”ç¤ºä¾‹</h4><p>â€‹		é»˜è®¤æ¶ˆæ¯é‡‡ç”¨çš„æ˜¯è‡ªåŠ¨åº”ç­”ã€‚</p>
<p>â€‹		åˆ›å»ºä¸¤ä¸ªæ¶ˆè´¹è€…ï¼Œåˆ†åˆ« sleep ä¸€å®šæ—¶é—´ã€‚</p>
<p>ç”Ÿäº§è€…ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.rabbitmq.ack;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.rabbitmq.util.RabbitConnectUtil;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;ack_queue&quot;</span>;</span><br><span class="line">	</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitConnectUtil.getChannel();</span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">sc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">        <span class="keyword">while</span> (sc.hasNext()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> sc.nextLine();</span><br><span class="line">            channel.basicPublish(<span class="string">&quot;&quot;</span>, QUEUE_NAME, <span class="literal">null</span>, message.getBytes());</span><br><span class="line">            System.out.println(<span class="string">&quot;æ¶ˆæ¯å‘é€å®Œæˆï¼š&quot;</span> + message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¶ˆè´¹è€…ä¸€ï¼šsleep 2ç§’</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.rabbitmq.ack;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.rabbitmq.util.RabbitConnectUtil;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.DeliverCallback;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Delivery;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æµ‹è¯•æ¶ˆæ¯åº”ç­”</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;ack_queue&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitConnectUtil.getChannel();</span><br><span class="line">        System.out.println(<span class="string">&quot;Consumer01ç­‰å¾…æ¥å—æ¶ˆæ¯...&quot;</span>);</span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DeliverCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s, Delivery delivery)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                System.out.println(s); <span class="comment">// amq.ctag-Gi369GilFESPvGyykhK3pg</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">                    System.out.println(<span class="string">&quot;Consumerï¼š&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody()));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// å‚æ•°ä¸€ï¼šæ¶ˆæ¯æ ‡è®°ï¼Œå‚æ•°äºŒï¼šæ˜¯å¦æ‰¹é‡åº”ç­”</span></span><br><span class="line">                channel.basicAck(delivery.getEnvelope().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// æ‰‹åŠ¨åº”ç­”</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">autoAck</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        channel.basicConsume(QUEUE_NAME, autoAck, deliverCallback, (consumerTag) -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;æ¶ˆè´¹è€…å–æ¶ˆæ¶ˆè´¹æ¥å£å›è°ƒé€»è¾‘&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¶ˆè´¹è€…äºŒï¼šsleep 20ç§’</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.rabbitmq.ack;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.rabbitmq.util.RabbitConnectUtil;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.DeliverCallback;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Delivery;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æµ‹è¯•æ¶ˆæ¯åº”ç­”</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;ack_queue&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitConnectUtil.getChannel();</span><br><span class="line">        System.out.println(<span class="string">&quot;Consumer02ç­‰å¾…æ¥å—æ¶ˆæ¯...&quot;</span>);</span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DeliverCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s, Delivery delivery)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                System.out.println(s); <span class="comment">// amq.ctag-Gi369GilFESPvGyykhK3pg</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">20</span>);</span><br><span class="line">                    System.out.println(<span class="string">&quot;Consumerï¼š&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody()));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// å‚æ•°ä¸€ï¼šæ¶ˆæ¯æ ‡è®°ï¼Œå‚æ•°äºŒï¼šæ˜¯å¦æ‰¹é‡åº”ç­”</span></span><br><span class="line">                channel.basicAck(delivery.getEnvelope().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// æ‰‹åŠ¨åº”ç­”</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">autoAck</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        channel.basicConsume(QUEUE_NAME, autoAck, deliverCallback, (consumerTag) -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;æ¶ˆè´¹è€…å–æ¶ˆæ¶ˆè´¹æ¥å£å›è°ƒé€»è¾‘&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•ï¼š</p>
<p>â€‹		æ­£å¸¸æƒ…å†µä¸‹æ¶ˆæ¯å‘é€æ–¹å‘é€ä¸¤ä¸ªæ¶ˆæ¯ C1 å’Œ C2 åˆ†åˆ«æ¥æ”¶åˆ°æ¶ˆæ¯å¹¶è¿›è¡Œå¤„ç†ã€‚å¦‚æœä¸­é—´ C2 å¼‚å¸¸ä¸­æ–­ï¼Œé‚£ä¹ˆæ¶ˆæ¯ä¼šé‡æ–°å…¥é˜Ÿï¼Œç”± C1 è¿›è¡Œæ¶ˆè´¹ã€‚</p>
<p><img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221014171616373.png" alt="image-20221014171616373"></p>
<h3 id="RabbitMQ-æŒä¹…åŒ–"><a href="#RabbitMQ-æŒä¹…åŒ–" class="headerlink" title="RabbitMQ æŒä¹…åŒ–"></a>RabbitMQ æŒä¹…åŒ–</h3><p>â€‹		åˆšåˆšå·²ç»çœ‹åˆ°äº†å¦‚ä½•å¤„ç†ä»»åŠ¡ä¸ä¸¢å¤±çš„æƒ…å†µï¼Œä½†æ˜¯<strong>å¦‚ä½•ä¿éšœå½“ RabbitMQ æœåŠ¡åœæ‰ä»¥åæ¶ˆ æ¯ç”Ÿäº§è€…å‘é€è¿‡æ¥çš„æ¶ˆæ¯ä¸ä¸¢å¤±</strong>ã€‚é»˜è®¤æƒ…å†µä¸‹ RabbitMQ é€€å‡ºæˆ–ç”±äºæŸç§åŸå› å´©æºƒæ—¶ï¼Œå®ƒå¿½è§†é˜Ÿåˆ—å’Œæ¶ˆæ¯ï¼Œé™¤éå‘ŠçŸ¥å®ƒä¸è¦è¿™æ ·åšã€‚ç¡®ä¿æ¶ˆæ¯ä¸ä¼šä¸¢å¤±éœ€è¦åšä¸¤ä»¶äº‹ï¼š<strong>éœ€è¦å°†é˜Ÿåˆ—å’Œæ¶ˆæ¯éƒ½æ ‡è®°ä¸ºæŒä¹…åŒ–ã€‚</strong></p>
<h4 id="é˜Ÿåˆ—æŒä¹…åŒ–"><a href="#é˜Ÿåˆ—æŒä¹…åŒ–" class="headerlink" title="é˜Ÿåˆ—æŒä¹…åŒ–"></a>é˜Ÿåˆ—æŒä¹…åŒ–</h4><p>â€‹		ä¹‹å‰æˆ‘ä»¬åˆ›å»ºçš„é˜Ÿåˆ—éƒ½æ˜¯éæŒä¹…åŒ–çš„ï¼Œrabbitmq å¦‚æœé‡å¯çš„åŒ–ï¼Œè¯¥é˜Ÿåˆ—å°±ä¼šè¢«åˆ é™¤æ‰ï¼Œå¦‚æœ è¦é˜Ÿåˆ—å®ç°æŒä¹…åŒ–éœ€è¦åœ¨å£°æ˜é˜Ÿåˆ—çš„æ—¶å€™æŠŠ durable å‚æ•°è®¾ç½®ä¸ºæŒä¹…åŒ–ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¾ç½®é˜Ÿåˆ—ä¸ºæŒä¹…åŒ–</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">durable</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">channel.queueDeclare(QUEUE_NAME, durable, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br></pre></td></tr></table></figure>

<p>â€‹		ä½†æ˜¯éœ€è¦æ³¨æ„çš„å°±æ˜¯å¦‚æœä¹‹å‰å£°æ˜çš„é˜Ÿåˆ—ä¸æ˜¯æŒä¹…åŒ–çš„ï¼Œéœ€è¦æŠŠåŸå…ˆé˜Ÿåˆ—å…ˆåˆ é™¤ï¼Œæˆ–è€…é‡æ–°åˆ›å»ºä¸€ä¸ªæŒä¹…åŒ–çš„é˜Ÿåˆ—ï¼Œä¸ç„¶å°±ä¼šå‡ºç°é”™è¯¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Caused by: com.rabbitmq.client.ShutdownSignalException: channel error; protocol method: #method&lt;channel.close&gt;(reply-code=<span class="number">406</span>, reply-text=PRECONDITION_FAILED - inequivalent arg <span class="string">&#x27;durable&#x27;</span> <span class="keyword">for</span> queue <span class="string">&#x27;ack_queue&#x27;</span> in vhost <span class="string">&#x27;/&#x27;</span>: received <span class="string">&#x27;true&#x27;</span> but current is <span class="string">&#x27;false&#x27;</span>, class-id=<span class="number">50</span>, method-id=<span class="number">10</span>)</span><br><span class="line">	at com.rabbitmq.utility.ValueOrException.getValue(ValueOrException.java:<span class="number">66</span>)</span><br></pre></td></tr></table></figure>

<p>åˆ é™¤ä¹‹å‰çš„é˜Ÿåˆ—ï¼š</p>
<p><img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221014215102286.png" alt="image-20221014215102286"></p>
<p>é‡æ–°åˆ›å»ºé˜Ÿåˆ—ï¼Œæ ‡è¯† D æ ‡è¯†æŒä¹…é˜Ÿåˆ—ï¼š</p>
<p><img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221014231741320.png" alt="image-20221014231741320"></p>
<h4 id="æ¶ˆæ¯æŒä¹…åŒ–"><a href="#æ¶ˆæ¯æŒä¹…åŒ–" class="headerlink" title="æ¶ˆæ¯æŒä¹…åŒ–"></a>æ¶ˆæ¯æŒä¹…åŒ–</h4><p>â€‹		è®©æ¶ˆæ¯å®ç°æŒä¹…åŒ–éœ€è¦åœ¨æ¶ˆæ¯ç”Ÿäº§è€…ä¿®æ”¹ä»£ç ï¼ŒMessageProperties.PERSISTENT_TEXT_PLAIN æ·» åŠ è¿™ä¸ªå±æ€§ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// channel.basicPublish(&quot;&quot;, QUEUE_NAME, null, message.getBytes());</span></span><br><span class="line">channel.basicPublish(<span class="string">&quot;&quot;</span>, QUEUE_NAME, MessageProperties.PERSISTENT_TEXT_PLAIN, message.getBytes());</span><br></pre></td></tr></table></figure>

<p>â€‹		å°†æ¶ˆæ¯æ ‡è®°ä¸ºæŒä¹…åŒ–å¹¶ä¸èƒ½å®Œå…¨ä¿è¯ä¸ä¼šä¸¢å¤±æ¶ˆæ¯ã€‚å°½ç®¡å®ƒå‘Šè¯‰ RabbitMQ å°†æ¶ˆæ¯ä¿å­˜åˆ°ç£ç›˜ï¼Œä½†æ˜¯è¿™é‡Œä¾ç„¶å­˜åœ¨å½“æ¶ˆæ¯åˆšå‡†å¤‡å­˜å‚¨åœ¨ç£ç›˜çš„æ—¶å€™ä½†æ˜¯è¿˜æ²¡æœ‰å­˜å‚¨å®Œï¼Œæ¶ˆæ¯è¿˜åœ¨ç¼“å­˜çš„ä¸€ä¸ªé—´éš”ç‚¹ï¼Œæ­¤æ—¶å¹¶æ²¡æœ‰çœŸæ­£å†™å…¥ç£ç›˜ã€‚</p>
<h4 id="ä¸å…¬å¹³åˆ†å‘"><a href="#ä¸å…¬å¹³åˆ†å‘" class="headerlink" title="ä¸å…¬å¹³åˆ†å‘"></a>ä¸å…¬å¹³åˆ†å‘</h4><p>â€‹		RabbitMQ åˆ†å‘æ¶ˆæ¯é‡‡ç”¨çš„è½®è®­åˆ†å‘ï¼Œä½†æ˜¯åœ¨æŸç§åœºæ™¯ä¸‹è¿™ç§ç­–ç•¥å¹¶ä¸æ˜¯å¾ˆå¥½ï¼Œæ¯”æ–¹è¯´æœ‰ä¸¤ä¸ªæ¶ˆè´¹è€…åœ¨å¤„ç†ä»»åŠ¡ï¼Œå…¶ä¸­æœ‰ä¸ªæ¶ˆè´¹è€… 1 å¤„ç†ä»»åŠ¡çš„é€Ÿåº¦éå¸¸å¿«ï¼Œè€Œå¦å¤–ä¸€ä¸ªæ¶ˆè´¹è€… 2 å¤„ç†é€Ÿåº¦å´å¾ˆæ…¢ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬è¿˜æ˜¯é‡‡ç”¨è½®è®­åˆ†å‘çš„åŒ–å°±ä¼šåˆ°è¿™å¤„ç†é€Ÿåº¦å¿«çš„è¿™ä¸ªæ¶ˆè´¹è€…å¾ˆå¤§ä¸€éƒ¨åˆ†æ—¶é—´å¤„äºç©ºé—²çŠ¶æ€ï¼Œè€Œå¤„ç†æ…¢çš„é‚£ä¸ªæ¶ˆè´¹è€…ä¸€ç›´åœ¨å¹²æ´»ï¼Œè¿™ç§åˆ†é…æ–¹å¼åœ¨è¿™ç§æƒ…å†µä¸‹å…¶å®å°±ä¸å¤ªå¥½ï¼Œä½†æ˜¯ RabbitMQ å¹¶ä¸çŸ¥é“è¿™ç§æƒ…å†µå®ƒä¾ç„¶å¾ˆå…¬å¹³çš„è¿›è¡Œåˆ†å‘ã€‚</p>
<p>â€‹		ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œå¯ä»¥è®¾ç½®æ¶ˆè´¹è€…å‚æ•° <strong>channel.basicQos(1);</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸å…¬å¹³åˆ†å‘</span></span><br><span class="line">channel.basicQos(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// æ‰‹åŠ¨åº”ç­”</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">autoAck</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">channel.basicConsume(QUEUE_NAME, autoAck, deliverCallback, cancleCallBack&#125;);</span><br></pre></td></tr></table></figure>

<p>â€‹		æ„æ€å°±æ˜¯å¦‚æœè¿™ä¸ªä»»åŠ¡æˆ‘è¿˜æ²¡æœ‰å¤„ç†å®Œæˆ–è€…æˆ‘è¿˜æ²¡æœ‰åº”ç­”ä½ ï¼Œä½ å…ˆåˆ«åˆ†é…ç»™æˆ‘ï¼Œæˆ‘ç›®å‰åªèƒ½å¤„ç†ä¸€ä¸ªä»»åŠ¡ï¼Œç„¶å rabbitmq å°±ä¼šæŠŠè¯¥ä»»åŠ¡åˆ†é…ç»™æ²¡æœ‰é‚£ä¹ˆå¿™çš„é‚£ä¸ªç©ºé—²æ¶ˆè´¹è€…ï¼Œ<strong>å½“ç„¶å¦‚æœæ‰€æœ‰çš„æ¶ˆè´¹è€…éƒ½æ²¡æœ‰å®Œæˆæ‰‹ä¸Šä»»åŠ¡ï¼Œé˜Ÿåˆ—è¿˜åœ¨ä¸åœçš„æ·»åŠ æ–°ä»»åŠ¡ï¼Œé˜Ÿåˆ—æœ‰å¯èƒ½å°±ä¼šé‡åˆ°é˜Ÿåˆ—è¢«æ’‘æ»¡çš„æƒ…å†µï¼Œè¿™ä¸ªæ—¶å€™å°±åªèƒ½æ·»åŠ æ–°çš„ worker æˆ–è€…æ”¹å˜å…¶ä»–å­˜å‚¨ä»»åŠ¡çš„ç­–ç•¥ã€‚</strong></p>
<p><img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221014233054025.png" alt="image-20221014233054025"></p>
<h4 id="é¢„å–å€¼"><a href="#é¢„å–å€¼" class="headerlink" title="é¢„å–å€¼"></a>é¢„å–å€¼</h4><p>â€‹		æœ¬èº«æ¶ˆæ¯çš„å‘é€å°±æ˜¯å¼‚æ­¥å‘é€çš„ï¼Œæ‰€ä»¥åœ¨ä»»ä½•æ—¶å€™ï¼Œchannel ä¸Šè‚¯å®šä¸æ­¢åªæœ‰ä¸€ä¸ªæ¶ˆæ¯å¦å¤–æ¥è‡ªæ¶ˆè´¹è€…çš„æ‰‹åŠ¨ç¡®è®¤æœ¬è´¨ä¸Šä¹Ÿæ˜¯å¼‚æ­¥çš„ã€‚å› æ­¤è¿™é‡Œå°±å­˜åœ¨ä¸€ä¸ªæœªç¡®è®¤çš„æ¶ˆæ¯ç¼“å†²åŒºï¼Œå› æ­¤å¸Œæœ›å¼€å‘äººå‘˜èƒ½é™åˆ¶æ­¤ç¼“å†²åŒºçš„å¤§å°ï¼Œä»¥é¿å…ç¼“å†²åŒºé‡Œé¢æ— é™åˆ¶çš„æœªç¡®è®¤æ¶ˆæ¯é—®é¢˜ã€‚</p>
<p>â€‹		è¿™ä¸ªæ—¶å€™å°±å¯ä»¥é€šè¿‡ä½¿ç”¨ basic.qos æ–¹æ³•è®¾ ç½® â€œé¢„å–è®¡æ•°â€ å€¼æ¥å®Œæˆçš„ã€‚<strong>è¯¥å€¼å®šä¹‰é€šé“ä¸Šå…è®¸çš„æœªç¡®è®¤æ¶ˆæ¯çš„æœ€å¤§æ•°é‡ã€‚ä¸€æ—¦æ•°é‡è¾¾åˆ°é…ç½®çš„æ•°é‡ï¼Œ RabbitMQ å°†åœæ­¢åœ¨é€šé“ä¸Šä¼ é€’æ›´å¤šæ¶ˆæ¯ï¼Œé™¤éè‡³å°‘æœ‰ä¸€ä¸ªæœªå¤„ç†çš„æ¶ˆæ¯è¢«ç¡®è®¤</strong>ã€‚</p>
<p>â€‹		ä¾‹å¦‚å‡è®¾åœ¨é€šé“ä¸Šæœ‰æœªç¡®è®¤çš„æ¶ˆæ¯ 5ã€6ã€7ï¼Œ8ï¼Œå¹¶ä¸”é€šé“çš„é¢„å–è®¡æ•°è®¾ç½®ä¸º 4ï¼Œæ­¤æ—¶ RabbitMQ å°†ä¸ä¼šåœ¨è¯¥é€šé“ä¸Šå†ä¼ é€’ä»»ä½•æ¶ˆæ¯ï¼Œé™¤éè‡³å°‘æœ‰ä¸€ä¸ªæœªåº”ç­”çš„æ¶ˆæ¯è¢« ackã€‚æ¯”æ–¹è¯´ tag&#x3D;6 è¿™ä¸ªæ¶ˆæ¯åˆšåˆšè¢«ç¡®è®¤ ACKï¼ŒRabbitMQ å°†ä¼šæ„ŸçŸ¥è¿™ä¸ªæƒ…å†µåˆ°å¹¶å†å‘é€ä¸€æ¡æ¶ˆæ¯ã€‚<strong>æ¶ˆæ¯åº”ç­”å’Œ QoS é¢„å–å€¼å¯¹ç”¨æˆ·ååé‡æœ‰é‡å¤§å½±å“</strong>ã€‚é€šå¸¸ï¼Œå¢åŠ é¢„å–å°†æé«˜å‘æ¶ˆè´¹è€…ä¼ é€’æ¶ˆæ¯çš„é€Ÿåº¦ã€‚è™½ç„¶è‡ªåŠ¨åº”ç­”ä¼ è¾“æ¶ˆæ¯é€Ÿç‡æ˜¯æœ€ä½³çš„ï¼Œä½†æ˜¯ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹å·²ä¼ é€’ä½†å°šæœªå¤„ç†çš„æ¶ˆæ¯çš„æ•°é‡ä¹Ÿä¼šå¢åŠ ï¼Œä»è€Œå¢åŠ äº†æ¶ˆè´¹è€…çš„ RAM æ¶ˆè€—åº”è¯¥å°å¿ƒä½¿ç”¨å…·æœ‰æ— é™é¢„å¤„ç†çš„è‡ªåŠ¨ç¡®è®¤æ¨¡å¼æˆ–æ‰‹åŠ¨ç¡®è®¤æ¨¡å¼ï¼Œæ¶ˆè´¹è€…æ¶ˆè´¹äº†å¤§é‡çš„æ¶ˆæ¯å¦‚æœæ²¡æœ‰ç¡®è®¤çš„è¯ï¼Œä¼šå¯¼è‡´æ¶ˆè´¹è€…è¿æ¥èŠ‚ç‚¹çš„å†…å­˜æ¶ˆè€—å˜å¤§ï¼Œæ‰€ä»¥æ‰¾åˆ°åˆé€‚çš„é¢„å–å€¼æ˜¯ä¸€ä¸ªåå¤è¯•éªŒçš„è¿‡ç¨‹ã€‚</p>
<p>â€‹		ä¸åŒçš„è´Ÿè½½è¯¥å€¼å–å€¼ä¹Ÿä¸åŒ 100 åˆ° 300 èŒƒ å›´å†…çš„å€¼é€šå¸¸å¯æä¾›æœ€ä½³çš„ååé‡ï¼Œå¹¶ä¸”ä¸ä¼šç»™æ¶ˆè´¹è€…å¸¦æ¥å¤ªå¤§çš„é£é™©ã€‚é¢„å–å€¼ä¸º 1 æ˜¯æœ€ä¿å®ˆçš„ã€‚å½“ç„¶è¿™å°†ä½¿ååé‡å˜å¾—å¾ˆä½ï¼Œç‰¹åˆ«æ˜¯æ¶ˆè´¹è€…è¿æ¥å»¶è¿Ÿå¾ˆä¸¥é‡çš„æƒ…å†µä¸‹ï¼Œç‰¹åˆ«æ˜¯åœ¨æ¶ˆè´¹è€…è¿æ¥ç­‰å¾…æ—¶é—´è¾ƒé•¿çš„ç¯å¢ƒä¸­ã€‚å¯¹äºå¤§å¤šæ•°åº”ç”¨æ¥è¯´ï¼Œç¨å¾®é«˜ä¸€ç‚¹çš„å€¼å°†æ˜¯æœ€ä½³çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è®¾ç½®Qos=0ï¼šæ ‡è¯†è½®è¯¢</span></span><br><span class="line"><span class="comment"> * è®¾ç½®Qos=1ï¼šè¡¨ç¤ºä¸å…¬å¹³åˆ†å‘</span></span><br><span class="line"><span class="comment"> * è®¾ç½®ä¸ºå…¶ä»–ï¼šè¡¨ç¤ºæŒ‡å®šé¢„å–å€¼</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// channel.basicQos(1);</span></span><br><span class="line">channel.basicQos(<span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•ï¼š</p>
<p>ä¸¤ä¸ªæ¶ˆè´¹è€…ï¼Œä¸€ä¸ªé¢„å–å€¼è®¾ç½®ä¸º2ï¼Œä¸€ä¸ªè®¾ç½®ä¸º5ï¼Œå¯¹åº”çš„ç¡çœ æ—¶é—´åˆ†åˆ«ä¸º 2 å’Œ 30Sï¼Œé¢„å–å€¼åªæ˜¯ä¸€ä¸ªç¼“å†²åŒºï¼Œåªè¦æ¶ˆè´¹è€…æ¶ˆè´¹æ‰æ¶ˆæ¯å°±ä¼šé‡æ–°æ¶ˆè´¹å…¶ä»–çš„æ¶ˆæ¯ï¼Œæ‰€ä»¥æµ‹è¯•çš„ç»“æœä¸­ï¼Œç¬¬äºŒä¸ªæ¶ˆè´¹è€…èƒ½å †ç§¯  5 æ¡æ¶ˆæ¯ã€‚</p>
<p>Producerï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;durable_queue&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitConnectUtil.getChannel();</span><br><span class="line">        <span class="comment">// è®¾ç½®é˜Ÿåˆ—ä¸ºæŒä¹…åŒ–</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">durable</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, durable, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">sc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">        <span class="keyword">while</span> (sc.hasNext()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> sc.nextLine();</span><br><span class="line">            <span class="comment">// channel.basicPublish(&quot;&quot;, QUEUE_NAME, null, message.getBytes());</span></span><br><span class="line">            channel.basicPublish(<span class="string">&quot;&quot;</span>, QUEUE_NAME, MessageProperties.PERSISTENT_TEXT_PLAIN, message.getBytes());</span><br><span class="line">            System.out.println(<span class="string">&quot;æ¶ˆæ¯å‘é€å®Œæˆï¼š&quot;</span> + message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Consumerï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;durable_queue&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitConnectUtil.getChannel();</span><br><span class="line">        System.out.println(<span class="string">&quot;Consumer01ç­‰å¾…æ¥å—æ¶ˆæ¯...&quot;</span>);</span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DeliverCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s, Delivery delivery)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                System.out.println(s); <span class="comment">// amq.ctag-Gi369GilFESPvGyykhK3pg</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">                    System.out.println(<span class="string">&quot;Consumerï¼š&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody()));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// å‚æ•°ä¸€ï¼šæ¶ˆæ¯æ ‡è®°ï¼Œå‚æ•°äºŒï¼šæ˜¯å¦æ‰¹é‡åº”ç­”</span></span><br><span class="line">                channel.basicAck(delivery.getEnvelope().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * è®¾ç½®Qos=0ï¼šæ ‡è¯†è½®è¯¢</span></span><br><span class="line"><span class="comment">         * è®¾ç½®Qos=1ï¼šè¡¨ç¤ºä¸å…¬å¹³åˆ†å‘</span></span><br><span class="line"><span class="comment">         * è®¾ç½®ä¸ºå…¶ä»–ï¼šè¡¨ç¤ºæŒ‡å®šé¢„å–å€¼</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// channel.basicQos(1);</span></span><br><span class="line">        channel.basicQos(<span class="number">2</span>);</span><br><span class="line">        <span class="comment">// æ‰‹åŠ¨åº”ç­”</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">autoAck</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        channel.basicConsume(QUEUE_NAME, autoAck, deliverCallback, (consumerTag) -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;æ¶ˆè´¹è€…å–æ¶ˆæ¶ˆè´¹æ¥å£å›è°ƒé€»è¾‘&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å‘å¸ƒç¡®è®¤"><a href="#å‘å¸ƒç¡®è®¤" class="headerlink" title="å‘å¸ƒç¡®è®¤"></a>å‘å¸ƒç¡®è®¤</h3><h4 id="å‘å¸ƒç¡®è®¤åŸç†"><a href="#å‘å¸ƒç¡®è®¤åŸç†" class="headerlink" title="å‘å¸ƒç¡®è®¤åŸç†"></a>å‘å¸ƒç¡®è®¤åŸç†</h4><p>â€‹		ç”Ÿäº§è€…å°†ä¿¡é“è®¾ç½®æˆ confirm æ¨¡å¼ï¼Œä¸€æ—¦ä¿¡é“è¿›å…¥ confirm æ¨¡å¼ï¼Œæ‰€æœ‰åœ¨è¯¥ä¿¡é“ä¸Šé¢å‘å¸ƒçš„æ¶ˆæ¯éƒ½å°†ä¼šè¢«æŒ‡æ´¾ä¸€ä¸ªå”¯ä¸€çš„ IDï¼ˆä» 1 å¼€å§‹ï¼‰ï¼Œ<strong>ä¸€æ—¦æ¶ˆæ¯è¢«æŠ•é€’åˆ°æ‰€æœ‰åŒ¹é…çš„é˜Ÿåˆ—ä¹‹åï¼Œbroker å°±ä¼šå‘é€ä¸€ä¸ªç¡®è®¤ç»™ç”Ÿäº§è€…</strong>ï¼ˆåŒ…å«æ¶ˆæ¯çš„å”¯ä¸€ IDï¼‰ï¼Œè¿™å°±ä½¿å¾—ç”Ÿäº§è€…çŸ¥é“æ¶ˆæ¯å·²ç»æ­£ç¡®åˆ°è¾¾ç›®çš„é˜Ÿåˆ—äº†ï¼Œå¦‚æœæ¶ˆæ¯å’Œé˜Ÿåˆ—æ˜¯å¯æŒä¹…åŒ–çš„ï¼Œé‚£ä¹ˆç¡®è®¤æ¶ˆæ¯ä¼šåœ¨å°†æ¶ˆæ¯å†™å…¥ç£ç›˜ä¹‹åå‘å‡ºï¼Œbroker å›ä¼ ç»™ç”Ÿäº§è€…çš„ç¡®è®¤æ¶ˆæ¯ä¸­ delivery-tag åŸŸåŒ…å«äº†ç¡®è®¤æ¶ˆæ¯çš„åºåˆ—å·ï¼Œæ­¤å¤– broker ä¹Ÿå¯ä»¥è®¾ç½® basic.ack çš„ multiple åŸŸï¼Œè¡¨ç¤ºåˆ°è¿™ä¸ªåºåˆ—å·ä¹‹å‰çš„æ‰€æœ‰æ¶ˆæ¯éƒ½å·²ç»å¾—åˆ°äº†å¤„ç†ã€‚</p>
<p>â€‹		<strong>confirm æ¨¡å¼æœ€å¤§çš„å¥½å¤„åœ¨äºå®ƒæ˜¯å¼‚æ­¥çš„ï¼Œä¸€æ—¦å‘å¸ƒä¸€æ¡æ¶ˆæ¯ï¼Œç”Ÿäº§è€…åº”ç”¨ç¨‹åºå°±å¯ä»¥åœ¨ç­‰ä¿¡é“è¿”å›ç¡®è®¤çš„åŒæ—¶ç»§ç»­å‘é€ä¸‹ä¸€æ¡æ¶ˆæ¯ï¼Œå½“æ¶ˆæ¯æœ€ç»ˆå¾—åˆ°ç¡®è®¤ä¹‹åï¼Œç”Ÿäº§è€…åº”ç”¨ä¾¿å¯ä»¥é€šè¿‡å›è°ƒæ–¹æ³•æ¥å¤„ç†è¯¥ç¡®è®¤æ¶ˆæ¯ï¼Œå¦‚æœ RabbitMQ å› ä¸ºè‡ªèº«å†…éƒ¨é”™è¯¯å¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ï¼Œå°±ä¼šå‘é€ä¸€æ¡ nack æ¶ˆ æ¯ï¼Œç”Ÿäº§è€…åº”ç”¨ç¨‹åºåŒæ ·å¯ä»¥åœ¨å›è°ƒæ–¹æ³•ä¸­å¤„ç†è¯¥ nack æ¶ˆæ¯ã€‚</strong></p>
<h4 id="å‘å¸ƒç¡®è®¤çš„ç­–ç•¥"><a href="#å‘å¸ƒç¡®è®¤çš„ç­–ç•¥" class="headerlink" title="å‘å¸ƒç¡®è®¤çš„ç­–ç•¥"></a>å‘å¸ƒç¡®è®¤çš„ç­–ç•¥</h4><h5 id="å¼€å¯å‘å¸ƒç¡®è®¤"><a href="#å¼€å¯å‘å¸ƒç¡®è®¤" class="headerlink" title="å¼€å¯å‘å¸ƒç¡®è®¤"></a>å¼€å¯å‘å¸ƒç¡®è®¤</h5><p>â€‹		å‘å¸ƒç¡®è®¤é»˜è®¤æ˜¯æ²¡æœ‰å¼€å¯çš„ï¼Œå¦‚æœè¦å¼€å¯éœ€è¦è°ƒç”¨æ–¹æ³• confirmSelectï¼Œæ¯å½“ä½ è¦æƒ³ä½¿ç”¨å‘å¸ƒç¡®è®¤ï¼Œéƒ½éœ€è¦åœ¨ channel ä¸Šè°ƒç”¨è¯¥æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"><span class="comment">// å¼€å¯ç¡®è®¤å‘å¸ƒ</span></span><br><span class="line">channel.confirmSelect();</span><br></pre></td></tr></table></figure>

<h5 id="å•ä¸ªç¡®è®¤å‘å¸ƒ"><a href="#å•ä¸ªç¡®è®¤å‘å¸ƒ" class="headerlink" title="å•ä¸ªç¡®è®¤å‘å¸ƒ"></a>å•ä¸ªç¡®è®¤å‘å¸ƒ</h5><p>â€‹		è¿™æ˜¯ä¸€ç§ç®€å•çš„ç¡®è®¤æ–¹å¼ï¼Œå®ƒæ˜¯ä¸€ç§åŒæ­¥ç¡®è®¤å‘å¸ƒçš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯<strong>å‘å¸ƒä¸€ä¸ªæ¶ˆæ¯ä¹‹ååªæœ‰å®ƒè¢«ç¡®è®¤å‘å¸ƒï¼Œåç»­çš„æ¶ˆæ¯æ‰èƒ½ç»§ç»­å‘å¸ƒ</strong>ï¼ŒwaitForConfirmsOrDie(long) è¿™ä¸ªæ–¹æ³•åªæœ‰åœ¨æ¶ˆæ¯è¢«ç¡®è®¤çš„æ—¶å€™æ‰è¿”å›ï¼Œå¦‚æœåœ¨æŒ‡å®šæ—¶é—´èŒƒå›´å†…è¿™ä¸ªæ¶ˆæ¯æ²¡æœ‰è¢«ç¡®è®¤é‚£ä¹ˆå®ƒå°†æŠ›å‡ºå¼‚å¸¸ã€‚ </p>
<p>â€‹		è¿™ç§ç¡®è®¤æ–¹å¼æœ‰ä¸€ä¸ªæœ€å¤§çš„ç¼ºç‚¹å°±æ˜¯ï¼šå‘å¸ƒé€Ÿåº¦ç‰¹åˆ«çš„æ…¢ï¼Œå› ä¸ºå¦‚æœæ²¡æœ‰ç¡®è®¤å‘å¸ƒçš„æ¶ˆæ¯å°±ä¼šé˜»å¡æ‰€æœ‰åç»­æ¶ˆæ¯çš„å‘å¸ƒï¼Œè¿™ç§æ–¹å¼æœ€å¤šæä¾›æ¯ç§’ä¸è¶…è¿‡æ•°ç™¾æ¡å‘å¸ƒæ¶ˆæ¯çš„ååé‡ã€‚å½“ç„¶å¯¹äºæŸäº›åº”ç”¨ç¨‹åºæ¥è¯´è¿™å¯èƒ½å·²ç»è¶³å¤Ÿäº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MESSAGE_COUNT</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å•ä¸ªæ¶ˆæ¯å‘å¸ƒ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">singleMessagePublish</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitConnectUtil.getChannel();</span><br><span class="line">    <span class="type">String</span> <span class="variable">queue_name</span> <span class="operator">=</span> UUID.randomUUID().toString().substring(<span class="number">0</span>, <span class="number">8</span>);</span><br><span class="line">    <span class="comment">// è®¾ç½®é˜Ÿåˆ—ä¸ºæŒä¹…åŒ–</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">durable</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    channel.queueDeclare(queue_name, durable, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">    <span class="comment">// å¼€å¯ç¡®è®¤å‘å¸ƒ</span></span><br><span class="line">    channel.confirmSelect();</span><br><span class="line">    <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; MESSAGE_COUNT; i++) &#123;</span><br><span class="line">        channel.basicPublish(<span class="string">&quot;&quot;</span>, queue_name, <span class="literal">null</span>, String.valueOf(i).getBytes());</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">ret</span> <span class="operator">=</span> channel.waitForConfirms();</span><br><span class="line">        <span class="comment">//æœåŠ¡ç«¯è¿”å› false æˆ–è¶…æ—¶æ—¶é—´å†…æœªè¿”å›ï¼Œç”Ÿäº§è€…å¯ä»¥æ¶ˆæ¯é‡å‘</span></span><br><span class="line">        <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;æ¶ˆæ¯å‘é€æˆåŠŸ&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    System.out.println(<span class="string">&quot;å‘å¸ƒ&quot;</span> + MESSAGE_COUNT + <span class="string">&quot;ä¸ªå•ç‹¬ç¡®è®¤æ¶ˆæ¯,è€—æ—¶&quot;</span> + (end - start) + <span class="string">&quot;ms&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="æ‰¹é‡ç¡®è®¤å‘å¸ƒ"><a href="#æ‰¹é‡ç¡®è®¤å‘å¸ƒ" class="headerlink" title="æ‰¹é‡ç¡®è®¤å‘å¸ƒ"></a>æ‰¹é‡ç¡®è®¤å‘å¸ƒ</h5><p>â€‹		ä¸Šé¢é‚£ç§æ–¹å¼éå¸¸æ…¢ï¼Œä¸å•ä¸ªç­‰å¾…ç¡®è®¤æ¶ˆæ¯ç›¸æ¯”ï¼Œå…ˆå‘å¸ƒä¸€æ‰¹æ¶ˆæ¯ç„¶åä¸€èµ·ç¡®è®¤å¯ä»¥æå¤§åœ°æé«˜ååé‡ï¼Œå½“ç„¶è¿™ç§æ–¹å¼çš„ç¼ºç‚¹æ˜¯ï¼šå½“å‘ç”Ÿæ•…éšœå¯¼è‡´å‘å¸ƒå‡ºç°é—®é¢˜æ—¶ï¼Œä¸çŸ¥é“æ˜¯å“ªä¸ªæ¶ˆæ¯å‡ºç°é—®é¢˜äº†ï¼Œæˆ‘ä»¬å¿…é¡»å°†æ•´ä¸ªæ‰¹å¤„ç†ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œä»¥è®°å½•é‡è¦çš„ä¿¡æ¯è€Œåé‡æ–°å‘å¸ƒæ¶ˆæ¯ã€‚å½“ç„¶è¿™ç§æ–¹æ¡ˆä»ç„¶æ˜¯åŒæ­¥çš„ï¼Œä¹Ÿä¸€æ ·é˜»å¡æ¶ˆæ¯çš„å‘å¸ƒã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ‰¹é‡æ¶ˆæ¯å‘å¸ƒ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">batchMessagePublish</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitConnectUtil.getChannel();</span><br><span class="line">    <span class="type">String</span> <span class="variable">queue_name</span> <span class="operator">=</span> UUID.randomUUID().toString().substring(<span class="number">0</span>, <span class="number">8</span>);</span><br><span class="line">    channel.confirmSelect();</span><br><span class="line">    channel.queueDeclare(queue_name, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">    <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; MESSAGE_COUNT; i++) &#123;</span><br><span class="line">        channel.basicPublish(<span class="string">&quot;&quot;</span>, queue_name, <span class="literal">null</span>, String.valueOf(i).getBytes());</span><br><span class="line">        <span class="comment">// æ¯100ä¸ªæ¶ˆæ¯æ‰¹é‡ç¡®è®¤ä¸€æ¬¡</span></span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">100</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            channel.waitForConfirms();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    System.out.println(<span class="string">&quot;å‘å¸ƒ&quot;</span> + MESSAGE_COUNT + <span class="string">&quot;ä¸ªå•æ‰¹é‡ç¡®è®¤æ¶ˆæ¯,è€—æ—¶&quot;</span> + (end - start) + <span class="string">&quot;ms&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="å¼‚æ­¥ç¡®è®¤å‘å¸ƒ"><a href="#å¼‚æ­¥ç¡®è®¤å‘å¸ƒ" class="headerlink" title="å¼‚æ­¥ç¡®è®¤å‘å¸ƒ"></a>å¼‚æ­¥ç¡®è®¤å‘å¸ƒ</h5><p>â€‹		å¼‚æ­¥ç¡®è®¤è™½ç„¶ç¼–ç¨‹é€»è¾‘æ¯”ä¸Šä¸¤ä¸ªè¦å¤æ‚ï¼Œä½†æ˜¯æ€§ä»·æ¯”æœ€é«˜ï¼Œæ— è®ºæ˜¯å¯é æ€§è¿˜æ˜¯æ•ˆç‡éƒ½æ²¡å¾—è¯´ï¼Œ <strong>å®ƒæ˜¯åˆ©ç”¨å›è°ƒå‡½æ•°æ¥è¾¾åˆ°æ¶ˆæ¯å¯é æ€§ä¼ é€’çš„</strong>ï¼Œè¿™ä¸ªä¸­é—´ä»¶ä¹Ÿæ˜¯é€šè¿‡å‡½æ•°å›è°ƒæ¥ä¿è¯æ˜¯å¦æŠ•é€’æˆåŠŸï¼Œ ä¸‹é¢å°±è®©æˆ‘ä»¬æ¥è¯¦ç»†è®²è§£å¼‚æ­¥ç¡®è®¤æ˜¯æ€ä¹ˆå®ç°çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¼‚æ­¥æ¶ˆæ¯å‘å¸ƒ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">asyncPublishMessage</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitConnectUtil.getChannel();</span><br><span class="line">    <span class="type">String</span> <span class="variable">queue_name</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">    channel.queueDeclare(queue_name, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">    channel.confirmSelect();</span><br><span class="line">    <span class="comment">// å­˜æ”¾æ¶ˆæ¯ç¼–å·ä¸å…·ä½“ä¿¡æ¯</span></span><br><span class="line">    ConcurrentSkipListMap&lt;Long, String&gt; outstandingConfirms =</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConcurrentSkipListMap</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç¡®è®¤æ”¶åˆ°æ¶ˆæ¯çš„ä¸€ä¸ªå›è°ƒ</span></span><br><span class="line"><span class="comment">     * å‚æ•°ä¸€ï¼šæ¶ˆæ¯åºåˆ—å·</span></span><br><span class="line"><span class="comment">     * å‚æ•°äºŒï¼štrue ï¼ˆæ‰¹é‡åˆ é™¤ï¼‰å¯ä»¥ç¡®è®¤å°äºç­‰äºå½“å‰åºåˆ—å·çš„æ¶ˆæ¯ï¼Œfalse ç¡®è®¤å½“å‰åºåˆ—å·æ¶ˆæ¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">ConfirmCallback</span> <span class="variable">confirmCallback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConfirmCallback</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(<span class="type">long</span> sequenceNumber, <span class="type">boolean</span> multiple)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="comment">// æ‰¹é‡åˆ é™¤</span></span><br><span class="line">            <span class="keyword">if</span> (multiple) &#123;</span><br><span class="line">                <span class="comment">//è¿”å›çš„æ˜¯å°äºç­‰äºå½“å‰åºåˆ—å·çš„æœªç¡®è®¤æ¶ˆæ¯ æ˜¯ä¸€ä¸ª map</span></span><br><span class="line">                ConcurrentNavigableMap&lt;Long, String&gt; confirmed =</span><br><span class="line">                    outstandingConfirms.headMap(sequenceNumber, <span class="literal">true</span>);</span><br><span class="line">                <span class="comment">//æ¸…é™¤è¯¥éƒ¨åˆ†æœªç¡®è®¤æ¶ˆæ¯(æ‰¹é‡æ¸…é™¤)</span></span><br><span class="line">                confirmed.clear();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//åªæ¸…é™¤å½“å‰åºåˆ—å·çš„æ¶ˆæ¯ï¼ˆå•ä¸ªåˆ é™¤ï¼‰</span></span><br><span class="line">                outstandingConfirms.remove(sequenceNumber);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">ConfirmCallback</span> <span class="variable">nackCallback</span> <span class="operator">=</span> (sequenceNumber, multiple) -&gt; &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> outstandingConfirms.get(sequenceNumber);</span><br><span class="line">        System.out.println(<span class="string">&quot;å‘å¸ƒçš„æ¶ˆæ¯&quot;</span> + message + <span class="string">&quot;æœªè¢«ç¡®è®¤ï¼Œåºåˆ—å·&quot;</span> + sequenceNumber);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ·»åŠ ä¸€ä¸ªå¼‚æ­¥ç¡®è®¤çš„ç›‘å¬å™¨</span></span><br><span class="line"><span class="comment">     * 1.ç¡®è®¤æ”¶åˆ°æ¶ˆæ¯çš„å›è°ƒ</span></span><br><span class="line"><span class="comment">     * 2.æœªæ”¶åˆ°æ¶ˆæ¯çš„å›è°ƒ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    channel.addConfirmListener(confirmCallback, nackCallback);</span><br><span class="line">    <span class="type">long</span> <span class="variable">begin</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; MESSAGE_COUNT; i++) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;æ¶ˆæ¯&quot;</span> + i;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * channel.getNextPublishSeqNo()è·å–ä¸‹ä¸€ä¸ªæ¶ˆæ¯çš„åºåˆ—å·</span></span><br><span class="line"><span class="comment">         * é€šè¿‡åºåˆ—å·ä¸æ¶ˆæ¯ä½“è¿›è¡Œä¸€ä¸ªå…³è”</span></span><br><span class="line"><span class="comment">         * å…¨éƒ¨éƒ½æ˜¯æœªç¡®è®¤çš„æ¶ˆæ¯ä½“</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        outstandingConfirms.put(channel.getNextPublishSeqNo(), message);</span><br><span class="line">        channel.basicPublish(<span class="string">&quot;&quot;</span>, queue_name, <span class="literal">null</span>, message.getBytes());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    System.out.println(<span class="string">&quot;å‘å¸ƒ&quot;</span> + MESSAGE_COUNT + <span class="string">&quot;ä¸ªå¼‚æ­¥ç¡®è®¤æ¶ˆæ¯,è€—æ—¶&quot;</span> + (end - begin) + <span class="string">&quot;ms&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="å¦‚ä½•å¤„ç†å¼‚æ­¥æœªç¡®è®¤æ¶ˆæ¯"><a href="#å¦‚ä½•å¤„ç†å¼‚æ­¥æœªç¡®è®¤æ¶ˆæ¯" class="headerlink" title="å¦‚ä½•å¤„ç†å¼‚æ­¥æœªç¡®è®¤æ¶ˆæ¯"></a>å¦‚ä½•å¤„ç†å¼‚æ­¥æœªç¡®è®¤æ¶ˆæ¯</h5><p>â€‹		æœ€å¥½çš„è§£å†³çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯æŠŠæœªç¡®è®¤çš„æ¶ˆæ¯æ”¾åˆ°ä¸€ä¸ªåŸºäºå†…å­˜çš„èƒ½è¢«å‘å¸ƒçº¿ç¨‹è®¿é—®çš„é˜Ÿåˆ—ï¼Œ æ¯”å¦‚è¯´ç”¨ ConcurrentLinkedQueue è¿™ä¸ªé˜Ÿåˆ—åœ¨ confirm callbacks ä¸å‘å¸ƒçº¿ç¨‹ä¹‹é—´è¿›è¡Œæ¶ˆæ¯çš„ä¼  é€’ã€‚</p>
<h5 id="æ€»ç»“å¯¹æ¯”"><a href="#æ€»ç»“å¯¹æ¯”" class="headerlink" title="æ€»ç»“å¯¹æ¯”"></a>æ€»ç»“å¯¹æ¯”</h5><ul>
<li>å•ç‹¬å‘å¸ƒæ¶ˆæ¯ï¼šåŒæ­¥ç­‰å¾…ç¡®è®¤ï¼Œç®€å•ï¼Œä½†ååé‡éå¸¸æœ‰é™ã€‚ </li>
<li>æ‰¹é‡å‘å¸ƒæ¶ˆæ¯ï¼šæ‰¹é‡åŒæ­¥ç­‰å¾…ç¡®è®¤ï¼Œç®€å•ï¼Œåˆç†çš„ååé‡ï¼Œä¸€æ—¦å‡ºç°é—®é¢˜ä½†å¾ˆéš¾æ¨æ–­å‡ºæ˜¯é‚£æ¡æ¶ˆæ¯å‡ºç°äº†é—®é¢˜ã€‚ </li>
<li>å¼‚æ­¥å¤„ç†ï¼š æœ€ä½³æ€§èƒ½å’Œèµ„æºä½¿ç”¨ï¼Œåœ¨å‡ºç°é”™è¯¯çš„æƒ…å†µä¸‹å¯ä»¥å¾ˆå¥½åœ°æ§åˆ¶ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// singleMessagePublish(); //2329ms</span></span><br><span class="line">    <span class="comment">// batchMessagePublish();  // 376ms</span></span><br><span class="line">    asyncPublishMessage();     <span class="comment">// 102ms</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="äº¤æ¢æœº-1"><a href="#äº¤æ¢æœº-1" class="headerlink" title="äº¤æ¢æœº"></a>äº¤æ¢æœº</h3><p>â€‹		å°†æ¶ˆæ¯ä¼ è¾¾ç»™å¤šä¸ªæ¶ˆè´¹è€…ã€‚è¿™ç§æ¨¡å¼ ç§°ä¸º â€å‘å¸ƒ&#x2F;è®¢é˜…â€.</p>
<p>ç¤ºä¾‹ï¼š</p>
<p>â€‹		æ„å»ºä¸€ä¸ªç®€å•çš„æ—¥å¿—ç³»ç»Ÿã€‚å®ƒå°†ç”±ä¸¤ä¸ªç¨‹åºç»„æˆï¼šç¬¬ä¸€ä¸ªç¨‹åºå°†å‘å‡ºæ—¥å¿—æ¶ˆæ¯ï¼Œç¬¬äºŒä¸ªç¨‹åºæ˜¯æ¶ˆè´¹è€…ã€‚å…¶ä¸­æˆ‘ä»¬ä¼šå¯åŠ¨ä¸¤ä¸ªæ¶ˆè´¹è€…ï¼Œå…¶ä¸­ä¸€ä¸ªæ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯åæŠŠæ—¥å¿—å­˜å‚¨åœ¨ç£ç›˜ï¼Œå¦å¤–ä¸€ä¸ªæ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯åæŠŠæ¶ˆæ¯æ‰“å°åœ¨å±å¹•ä¸Šï¼Œäº‹å®ä¸Šç¬¬ä¸€ä¸ªç¨‹åºå‘å‡ºçš„æ—¥å¿—æ¶ˆæ¯å°†å¹¿æ’­ç»™æ‰€æœ‰æ¶ˆè´¹è€…ã€‚</p>
<img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221015124909401.png" alt="image-20221015124909401" style="zoom:80%;">



<p><img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221015124836840.png" alt="image-20221015124836840"></p>
<h4 id="Exchanges-æ¦‚å¿µ"><a href="#Exchanges-æ¦‚å¿µ" class="headerlink" title="Exchanges æ¦‚å¿µ"></a>Exchanges æ¦‚å¿µ</h4><p>â€‹		RabbitMQ æ¶ˆæ¯ä¼ é€’æ¨¡å‹çš„æ ¸å¿ƒæ€æƒ³æ˜¯: <strong>ç”Ÿäº§è€…ç”Ÿäº§çš„æ¶ˆæ¯ä»ä¸ä¼šç›´æ¥å‘é€åˆ°é˜Ÿåˆ—</strong>ã€‚å®é™…ä¸Šï¼Œé€šå¸¸ç”Ÿäº§è€…ç”šè‡³éƒ½ä¸çŸ¥é“è¿™äº›æ¶ˆæ¯ä¼ é€’ä¼ é€’åˆ°äº†å“ªäº›é˜Ÿåˆ—ä¸­ã€‚ ç›¸åï¼Œç”Ÿäº§è€…åªèƒ½å°†æ¶ˆæ¯å‘é€åˆ°äº¤æ¢æœºï¼ˆexchangeï¼‰ï¼Œäº¤æ¢æœºå·¥ä½œçš„å†…å®¹éå¸¸ç®€å•ï¼Œä¸€æ–¹é¢å®ƒæ¥æ”¶æ¥è‡ªç”Ÿäº§è€…çš„æ¶ˆæ¯ï¼Œå¦ä¸€æ–¹é¢å°†å®ƒä»¬æ¨å…¥é˜Ÿåˆ—ã€‚äº¤æ¢æœºå¿…é¡»ç¡®åˆ‡çŸ¥é“å¦‚ä½•å¤„ç†æ”¶åˆ°çš„æ¶ˆæ¯ã€‚æ˜¯åº”è¯¥æŠŠè¿™äº›æ¶ˆæ¯æ”¾åˆ°ç‰¹å®šé˜Ÿåˆ—è¿˜æ˜¯è¯´æ”¾åˆ°è®¸å¤šé˜Ÿåˆ—ä¸­è¿˜æ˜¯è¯´åº”è¯¥ä¸¢å¼ƒå®ƒä»¬ï¼Œè¿™å°±çš„ç”±äº¤æ¢æœºçš„ç±»å‹æ¥å†³å®šã€‚</p>
<h5 id="Exchanges-çš„ç±»å‹"><a href="#Exchanges-çš„ç±»å‹" class="headerlink" title="Exchanges çš„ç±»å‹"></a>Exchanges çš„ç±»å‹</h5><p>â€‹		ç›´æ¥ï¼ˆdirectï¼‰, ä¸»é¢˜ï¼ˆtopicï¼‰ ,æ ‡é¢˜ï¼ˆheadersï¼‰ , æ‰‡å‡ºï¼ˆfanoutï¼‰</p>
<h5 id="é»˜è®¤exchange"><a href="#é»˜è®¤exchange" class="headerlink" title="é»˜è®¤exchange"></a>é»˜è®¤exchange</h5><p>â€‹		é»˜è®¤äº¤æ¢æœºä½¿ç”¨ç©ºä¸²è¿›è¡Œæ ‡è¯†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">channel.basicPublish(<span class="string">&quot;&quot;</span>, queue_name, <span class="literal">null</span>, String.valueOf(i).getBytes());</span><br></pre></td></tr></table></figure>

<p>â€‹		ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯äº¤æ¢æœºçš„åç§°ã€‚ç©ºå­—ç¬¦ä¸²è¡¨ç¤ºé»˜è®¤æˆ–æ— åç§°äº¤æ¢æœºï¼šæ¶ˆæ¯èƒ½è·¯ç”±å‘é€åˆ°é˜Ÿåˆ—ä¸­å…¶å®æ˜¯ç”± routingKeyï¼ˆbindingkeyï¼‰ç»‘å®š key æŒ‡å®šçš„ï¼Œå¦‚æœå®ƒå­˜åœ¨çš„è¯ã€‚</p>
<h5 id="ä¸´æ—¶é˜Ÿåˆ—"><a href="#ä¸´æ—¶é˜Ÿåˆ—" class="headerlink" title="ä¸´æ—¶é˜Ÿåˆ—"></a>ä¸´æ—¶é˜Ÿåˆ—</h5><p>â€‹		æ¯å½“æˆ‘ä»¬è¿æ¥åˆ° Rabbit æ—¶ï¼Œæˆ‘ä»¬éƒ½éœ€è¦ä¸€ä¸ªå…¨æ–°çš„ç©ºé˜Ÿåˆ—ï¼Œä¸ºæ­¤æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªå…·æœ‰éšæœºåç§°çš„é˜Ÿåˆ—ï¼Œæˆ–è€…èƒ½è®©æœåŠ¡å™¨ä¸ºæˆ‘ä»¬é€‰æ‹©ä¸€ä¸ªéšæœºé˜Ÿåˆ—åç§°ã€‚å…¶æ¬¡ä¸€æ—¦æˆ‘ä»¬æ–­å¼€äº†æ¶ˆè´¹è€…çš„è¿æ¥ï¼Œé˜Ÿåˆ—å°†è¢«è‡ªåŠ¨åˆ é™¤ã€‚</p>
<p>åˆ›å»ºä¸´æ—¶é˜Ÿåˆ—çš„æ–¹å¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> channel.queueDeclare().getQueue();</span><br></pre></td></tr></table></figure>

<h5 id="ç»‘å®šï¼ˆbindingsï¼‰"><a href="#ç»‘å®šï¼ˆbindingsï¼‰" class="headerlink" title="ç»‘å®šï¼ˆbindingsï¼‰"></a>ç»‘å®šï¼ˆbindingsï¼‰</h5><p>â€‹		binding å…¶å®æ˜¯ exchange å’Œ queue ä¹‹é—´çš„æ¡¥æ¢ï¼Œå®ƒå‘Šè¯‰æˆ‘ä»¬ exchange å’Œé‚£ä¸ªé˜Ÿåˆ—è¿›è¡Œäº†ç»‘å®šå…³ç³»ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">channel.queueBind(queueName, EXCHANGE_NAME, <span class="string">&quot;&quot;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="Fanout"><a href="#Fanout" class="headerlink" title="Fanout"></a>Fanout</h4><p>â€‹		Fanout æ˜¯å°†æ¥æ”¶åˆ°çš„æ‰€æœ‰æ¶ˆæ¯å¹¿æ’­åˆ°å®ƒçŸ¥é“çš„æ‰€æœ‰é˜Ÿåˆ—ä¸­ï¼Œç³»ç»Ÿä¸­é»˜è®¤æœ‰äº› exchange ç±»å‹ã€‚</p>
<img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221015192457355.png" alt="image-20221015192457355" style="zoom:80%;">

<p>ç¤ºä¾‹ï¼š</p>
<p>â€‹		ç”Ÿäº§è€…å‘é€æ—¥å¿—ä¿¡æ¯åˆ° broker ä¸Šé¢ï¼Œæ¶ˆè´¹è€…ä¸€å°†ä¿¡æ¯æ˜¾ç¤ºåˆ°æ§åˆ¶å°ä¸Šï¼Œæ¶ˆè´¹è€…äºŒå°†æ—¥å¿—ä¿¡æ¯å­˜å…¥ç£ç›˜ã€‚</p>
<p>ReceiveLogs01 å°†æ¥æ”¶åˆ°çš„æ¶ˆæ¯æ‰“å°åœ¨æ§åˆ¶å°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æµ‹è¯•äº¤æ¢æœºç±»å‹</span></span><br><span class="line"><span class="comment"> * å°†æ¥æ”¶åˆ°çš„æ¶ˆæ¯æ‰“å°åˆ°æ§åˆ¶å°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReceiveLogs01</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;logs&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitConnectUtil.getChannel();</span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.FANOUT);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * ç”Ÿæˆä¸€ä¸ªéšæœºé˜Ÿåˆ—ï¼šå½“æ¶ˆè´¹è€…æ–­å¼€å’Œè¯¥é˜Ÿåˆ—çš„è¿æ¥æ—¶é˜Ÿåˆ—è‡ªåŠ¨åˆ é™¤</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> channel.queueDeclare().getQueue();</span><br><span class="line">        <span class="comment">// ç»‘å®šé˜Ÿåˆ—ä¸äº¤æ¢æœºï¼Œå…¶ä¸­routingkey(ä¹Ÿç§°ä¹‹ä¸º binding key)è®¾ç½®ä¸ºç©ºå­—ç¬¦ä¸²</span></span><br><span class="line">        channel.queueBind(queueName, EXCHANGE_NAME, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;ReceiveLogs01ç­‰å¾…æ¥å—æ¶ˆæ¯...&quot;</span>);</span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DeliverCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s, Delivery delivery)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;æ§åˆ¶å°æ‰“å°æ¶ˆæ¯ï¼š&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">CancelCallback</span> <span class="variable">cancelCallback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CancelCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        channel.basicConsume(queueName, <span class="literal">true</span>, deliverCallback, cancelCallback);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ReceiveLogs02 å°†æ¥æ”¶åˆ°çš„æ¶ˆæ¯å­˜å‚¨åœ¨ç£ç›˜ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æµ‹è¯•äº¤æ¢æœºç±»å‹</span></span><br><span class="line"><span class="comment"> * å°†æ¥æ”¶åˆ°çš„æ¶ˆæ¯å†™å…¥æ–‡ä»¶</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReceiveLogs02</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;logs&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitConnectUtil.getChannel();</span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.FANOUT);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * ç”Ÿæˆä¸€ä¸ªéšæœºé˜Ÿåˆ—ï¼šå½“æ¶ˆè´¹è€…æ–­å¼€å’Œè¯¥é˜Ÿåˆ—çš„è¿æ¥æ—¶é˜Ÿåˆ—è‡ªåŠ¨åˆ é™¤</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> channel.queueDeclare().getQueue();</span><br><span class="line">        <span class="comment">// ç»‘å®šé˜Ÿåˆ—ä¸äº¤æ¢æœºï¼Œå…¶ä¸­routingkey(ä¹Ÿç§°ä¹‹ä¸º binding key)è®¾ç½®ä¸ºç©ºå­—ç¬¦ä¸²</span></span><br><span class="line">        channel.queueBind(queueName, EXCHANGE_NAME, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;ReceiveLogs01ç­‰å¾…æ¥å—æ¶ˆæ¯...&quot;</span>);</span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DeliverCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s, Delivery delivery)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody());</span><br><span class="line">                FileUtils.writeStringToFile(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;C:\\rabbit.txt&quot;</span>), message);</span><br><span class="line">                System.out.println(<span class="string">&quot;æ•°æ®å†™å…¥æ–‡ä»¶æˆåŠŸ&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">CancelCallback</span> <span class="variable">cancelCallback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CancelCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        channel.basicConsume(queueName, <span class="literal">true</span>, deliverCallback, cancelCallback);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>EmitLog å‘é€æ¶ˆæ¯ç»™ä¸¤ä¸ªæ¶ˆè´¹è€…æ¥æ”¶ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * äº¤æ¢æœºæµ‹è¯•ï¼š</span></span><br><span class="line"><span class="comment"> * æäº¤æ—¥å¿—</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmitLog</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;logs&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitConnectUtil.getChannel();</span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.FANOUT);</span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">sc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">        <span class="keyword">while</span> (sc.hasNext()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> sc.nextLine();</span><br><span class="line">            channel.basicPublish(EXCHANGE_NAME, <span class="string">&quot;&quot;</span>, <span class="literal">null</span>, message.getBytes());</span><br><span class="line">            System.out.println(<span class="string">&quot;æ¶ˆæ¯å‘é€å®Œæˆï¼š&quot;</span> + message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Direct-exchange"><a href="#Direct-exchange" class="headerlink" title="Direct exchange"></a>Direct exchange</h4><p>â€‹		ä¸Šé¢å¯ä»¥å‘è®¸å¤šæ¥æ”¶è€…å¹¿æ’­æ—¥å¿—æ¶ˆæ¯ã€‚ä½†å¦‚ä½•åªè®©æŸä¸ªæ¶ˆè´¹è€…è®¢é˜…å‘å¸ƒçš„éƒ¨åˆ†æ¶ˆæ¯ã€‚ä¾‹å¦‚åªæŠŠä¸¥é‡é”™è¯¯æ¶ˆæ¯å®šå‘å­˜å‚¨åˆ°æ—¥å¿—æ–‡ä»¶ï¼ŒåŒæ—¶ä»ç„¶èƒ½å¤Ÿåœ¨æ§åˆ¶å°ä¸Šæ‰“å°æ‰€æœ‰æ—¥å¿—æ¶ˆæ¯ã€‚å¯¹äº bindingsï¼Œé˜Ÿåˆ—åªå¯¹å®ƒç»‘å®šçš„äº¤æ¢æœºçš„æ¶ˆæ¯æ„Ÿå…´è¶£ã€‚</p>
<p>ç»‘å®šå‚æ•°ï¼šroutingKey ï¼Œä¹Ÿå¯ç§°è¯¥å‚æ•°ä¸º binding keyï¼Œ åˆ›å»ºç»‘å®šä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">channel.queueBind(queueName, EXCHANGE_NAME, <span class="string">&quot;routingKey&quot;</span>);</span><br></pre></td></tr></table></figure>

<h5 id="Direct-exchange-ä»‹ç»"><a href="#Direct-exchange-ä»‹ç»" class="headerlink" title="Direct exchange ä»‹ç»"></a>Direct exchange ä»‹ç»</h5><p>â€‹		å¸Œæœ›å°†æ—¥å¿—æ¶ˆæ¯å†™å…¥ç£ç›˜çš„ç¨‹åºä»…æ¥æ”¶ä¸¥é‡é”™è¯¯ï¼ˆerrrosï¼‰ï¼Œè€Œä¸å­˜å‚¨å“ªäº›è­¦å‘Šï¼ˆwarningï¼‰æˆ–ä¿¡æ¯ï¼ˆinfoï¼‰æ—¥å¿—æ¶ˆæ¯é¿å…æµªè´¹ç£ç›˜ç©ºé—´ã€‚<strong>Fanout è¿™ç§äº¤æ¢ç±»å‹å¹¶ä¸èƒ½ç»™æˆ‘ä»¬å¸¦æ¥å¾ˆå¤§çš„çµæ´»æ€§ï¼Œå®ƒåªèƒ½è¿›è¡Œæ— æ„è¯†çš„å¹¿æ’­</strong>ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å°†ä½¿ç”¨ direct è¿™ç§ç±»å‹æ¥è¿›è¡Œæ›¿æ¢ï¼Œè¿™ç§ç±»å‹çš„å·¥ä½œæ–¹å¼æ˜¯ï¼Œæ¶ˆæ¯åªå»åˆ°å®ƒç»‘å®šçš„ routingKey é˜Ÿåˆ—ä¸­å»ã€‚</p>
<img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221015195638838.png" alt="image-20221015195638838" style="zoom:60%;">

<p>â€‹		åœ¨ä¸Šé¢è¿™å¼ å›¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° X ç»‘å®šäº†ä¸¤ä¸ªé˜Ÿåˆ—ï¼Œç»‘å®šç±»å‹æ˜¯ directã€‚é˜Ÿåˆ— Q1 ç»‘å®šé”®ä¸º orangeï¼Œ é˜Ÿåˆ— Q2 ç»‘å®šé”®æœ‰ä¸¤ä¸ªï¼šä¸€ä¸ªç»‘å®šé”®ä¸º blackï¼Œå¦ä¸€ä¸ªç»‘å®šé”®ä¸º greenã€‚åœ¨è¿™ç§ç»‘å®šæƒ…å†µä¸‹ï¼Œç”Ÿäº§è€…å‘å¸ƒæ¶ˆæ¯åˆ° exchange ä¸Šï¼Œç»‘å®šé”®ä¸º orange çš„æ¶ˆæ¯ä¼šè¢«å‘å¸ƒåˆ°é˜Ÿåˆ— Q1ã€‚ç»‘å®šé”®ä¸º black å’Œ greençš„æ¶ˆæ¯ä¼šè¢«å‘å¸ƒåˆ°é˜Ÿåˆ— Q2ï¼Œå…¶ä»–æ¶ˆæ¯ç±»å‹çš„æ¶ˆæ¯å°†è¢«ä¸¢å¼ƒã€‚</p>
<h5 id="å¤šé‡ç»‘å®š"><a href="#å¤šé‡ç»‘å®š" class="headerlink" title="å¤šé‡ç»‘å®š"></a>å¤šé‡ç»‘å®š</h5><img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221015195852282.png" alt="image-20221015195852282" style="zoom:67%;">

<p>â€‹		å¦‚æœ exchange çš„ç»‘å®šç±»å‹æ˜¯ directï¼Œä½†æ˜¯å®ƒç»‘å®šçš„å¤šä¸ªé˜Ÿåˆ—çš„ key å¦‚æœéƒ½ç›¸åŒï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹è™½ç„¶ç»‘å®šç±»å‹æ˜¯ direct ä½†æ˜¯å®ƒè¡¨ç°çš„å°±å’Œ fanout æœ‰ç‚¹ç±»ä¼¼äº†ï¼Œå°±è·Ÿå¹¿æ’­å·®ä¸å¤šã€‚</p>
<h5 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h5><img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221015195948064.png" alt="image-20221015195948064" style="zoom:67%;">

<p>ReceiveLogsDirect01ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * äº¤æ¢æœºç±»å‹ï¼šdirect</span></span><br><span class="line"><span class="comment"> * æ¥æ”¶errorç±»å‹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReceiveLogsDirect01</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;direct_logs&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitConnectUtil.getChannel();</span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);</span><br><span class="line">        <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;disk&quot;</span>;</span><br><span class="line">        channel.queueDeclare(queueName, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        channel.queueBind(queueName, EXCHANGE_NAME, <span class="string">&quot;error&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;ç­‰å¾…æ¥æ”¶æ¶ˆæ¯...&quot;</span>);</span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DeliverCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s, Delivery delivery)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;routingKey: &quot;</span> + delivery.getEnvelope().getRoutingKey() + <span class="string">&quot; : &quot;</span> + <span class="string">&quot;æ¶ˆæ¯ï¼š&quot;</span> + delivery.getEnvelope();</span><br><span class="line">                FileUtils.writeStringToFile(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;C:\\rabbit.txt&quot;</span>), message);</span><br><span class="line">                System.out.println(<span class="string">&quot;é”™è¯¯æ—¥å¿—å·²ç»æ¥æ”¶...&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">CancelCallback</span> <span class="variable">cancelCallback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CancelCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        channel.basicConsume(queueName, <span class="literal">true</span>, deliverCallback, cancelCallback);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ReceiveLogsDirect02ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * äº¤æ¢æœºç±»å‹ï¼šdirect</span></span><br><span class="line"><span class="comment"> * æ¥æ”¶infoï¼Œwarnç±»å‹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReceiveLogsDirect02</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;direct_logs&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitConnectUtil.getChannel();</span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);</span><br><span class="line">        <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;console&quot;</span>;</span><br><span class="line">        channel.queueDeclare(queueName, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        channel.queueBind(queueName, EXCHANGE_NAME, <span class="string">&quot;info&quot;</span>);</span><br><span class="line">        channel.queueBind(queueName, EXCHANGE_NAME, <span class="string">&quot;warn&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;ç­‰å¾…æ¥æ”¶æ¶ˆæ¯...&quot;</span>);</span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DeliverCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s, Delivery delivery)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;routingKey: &quot;</span> + delivery.getEnvelope().getRoutingKey() + <span class="string">&quot; : &quot;</span> + <span class="string">&quot;æ¶ˆæ¯ï¼š&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody());</span><br><span class="line">                System.out.println(message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">CancelCallback</span> <span class="variable">cancelCallback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CancelCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        channel.basicConsume(queueName, <span class="literal">true</span>, deliverCallback, cancelCallback);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>EmitLogDirectï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * äº¤æ¢æœºç±»å‹ï¼šdirect</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmitLogDirect</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;direct_logs&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitConnectUtil.getChannel();</span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);</span><br><span class="line">        Map&lt;String, String&gt; dataBindingMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        dataBindingMap.put(<span class="string">&quot;info&quot;</span>, <span class="string">&quot;info_message&quot;</span>);</span><br><span class="line">        dataBindingMap.put(<span class="string">&quot;error&quot;</span>, <span class="string">&quot;error_message&quot;</span>);</span><br><span class="line">        dataBindingMap.put(<span class="string">&quot;warn&quot;</span>, <span class="string">&quot;warn_message&quot;</span>);</span><br><span class="line">        dataBindingMap.put(<span class="string">&quot;debug&quot;</span>, <span class="string">&quot;debug_message&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : dataBindingMap.entrySet()) &#123;</span><br><span class="line">            channel.basicPublish(EXCHANGE_NAME, entry.getKey(), <span class="literal">null</span>, </span><br><span class="line">                                 entry.getValue().getBytes());</span><br><span class="line">            System.out.println(<span class="string">&quot;ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ï¼š&quot;</span> + entry.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="Topics"><a href="#Topics" class="headerlink" title="Topics"></a>Topics</h4><p>â€‹		å°½ç®¡ä½¿ç”¨ direct äº¤æ¢æœºæ”¹è¿›äº†ç³»ç»Ÿï¼Œä½†æ˜¯å®ƒä»ç„¶å­˜åœ¨å±€é™æ€§ã€‚æ¯”æ–¹è¯´æˆ‘ä»¬æƒ³æ¥æ”¶çš„æ—¥å¿—ç±»å‹æœ‰ info.base å’Œ info.advantageï¼ŒæŸä¸ªé˜Ÿåˆ—åªæƒ³ info.base çš„æ¶ˆæ¯ï¼Œé‚£è¿™ä¸ªæ—¶å€™ direct å°±åŠä¸åˆ°äº†ã€‚è¿™ä¸ªæ—¶å€™ å°±åªèƒ½ä½¿ç”¨ topic ç±»å‹</p>
<h5 id="Topic-çš„è¦æ±‚"><a href="#Topic-çš„è¦æ±‚" class="headerlink" title="Topic çš„è¦æ±‚"></a>Topic çš„è¦æ±‚</h5><p>â€‹		å‘é€åˆ°ç±»å‹æ˜¯ topic äº¤æ¢æœºçš„æ¶ˆæ¯çš„ routing_key ä¸èƒ½éšæ„å†™ï¼Œå¿…é¡»æ»¡è¶³ä¸€å®šçš„è¦æ±‚ï¼Œå®ƒå¿…é¡»æ˜¯ä¸€ä¸ªå•è¯åˆ—è¡¨ï¼Œä»¥ç‚¹å·åˆ†éš”å¼€ã€‚è¿™äº›å•è¯å¯ä»¥æ˜¯ä»»æ„å•è¯ï¼Œæ¯”å¦‚è¯´ï¼šâ€stock.usd.nyseâ€ï¼Œâ€nyse.vmwâ€ï¼Œâ€quick.orange.rabbitâ€ è¿™ç§ç±»å‹çš„ã€‚å½“ç„¶è¿™ä¸ªå•è¯åˆ—è¡¨æœ€å¤šä¸èƒ½è¶…è¿‡ 255 ä¸ªå­—èŠ‚ã€‚ </p>
<p>â€‹		åœ¨è¿™ä¸ªè§„åˆ™åˆ—è¡¨ä¸­ï¼Œ *ï¼ˆæ˜Ÿå·ï¼‰å¯ä»¥ä»£æ›¿ä¸€ä¸ªå•è¯ï¼Œ# å¯ä»¥æ›¿ä»£é›¶ä¸ªæˆ–å¤šä¸ªå•è¯ã€‚</p>
<h5 id="Topics-åŒ¹é…ç¤ºä¾‹"><a href="#Topics-åŒ¹é…ç¤ºä¾‹" class="headerlink" title="Topics åŒ¹é…ç¤ºä¾‹"></a>Topics åŒ¹é…ç¤ºä¾‹</h5><img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221015205310433.png" alt="image-20221015205310433" style="zoom:67%;">

<p>Q1 ç»‘å®šçš„æ˜¯ ä¸­é—´å¸¦ orange å¸¦ 3 ä¸ªå•è¯çš„å­—ç¬¦ä¸²ï¼ˆ*.orange.*ï¼‰</p>
<p>Q2 ç»‘å®šçš„æ˜¯æœ€åä¸€ä¸ªå•è¯æ˜¯ rabbit çš„ 3 ä¸ªå•è¯ï¼ˆ*.*.rabbitï¼‰ ç¬¬ä¸€ä¸ªå•è¯æ˜¯ lazy çš„å¤šä¸ªå•è¯ï¼ˆlazy.#ï¼‰</p>
<ul>
<li>quick.orange.rabbi				è¢«é˜Ÿåˆ— Q1Q2 æ¥æ”¶åˆ° </li>
<li>lazy.orange.elephant 			è¢«é˜Ÿåˆ— Q1Q2 æ¥æ”¶åˆ°</li>
<li>quick.orange.fox					è¢«é˜Ÿåˆ— Q1 æ¥æ”¶åˆ°</li>
<li>lazy.brown.fox						è¢«é˜Ÿåˆ— Q2 æ¥æ”¶åˆ°</li>
<li>lazy.pink.rabbit				   	è™½ç„¶æ»¡è¶³ä¸¤ä¸ªç»‘å®šä½†åªè¢«é˜Ÿåˆ— Q2 æ¥æ”¶ä¸€æ¬¡</li>
<li>quick.brown.fox				 	ä¸åŒ¹é…ä»»ä½•ç»‘å®šä¸ä¼šè¢«ä»»ä½•é˜Ÿåˆ—æ¥æ”¶åˆ°ä¼šè¢«ä¸¢å¼ƒ</li>
<li>quick.orange.male.rabbit 	æ˜¯å››ä¸ªå•è¯ä¸åŒ¹é…ä»»ä½•ç»‘å®šä¼šè¢«ä¸¢å¼ƒ</li>
<li>lazy.orange.male.rabbit		æ˜¯å››ä¸ªå•è¯ä½†åŒ¹é… Q2</li>
</ul>
<p>éœ€è¦æ³¨æ„ï¼š</p>
<ul>
<li>å½“ä¸€ä¸ªé˜Ÿåˆ—ç»‘å®šé”®æ˜¯ #ï¼Œé‚£ä¹ˆè¿™ä¸ªé˜Ÿåˆ—å°†æ¥æ”¶æ‰€æœ‰æ•°æ®ï¼Œç±»ä¼¼äº fanoutã€‚</li>
<li>å¦‚æœé˜Ÿåˆ—ç»‘å®šé”®å½“ä¸­æ²¡æœ‰ # å’Œ * å‡ºç°ï¼Œé‚£ä¹ˆè¯¥é˜Ÿåˆ—ç»‘å®šç±»å‹ç±»ä¼¼äº directã€‚</li>
</ul>
<p>ç¤ºä¾‹ï¼š</p>
<img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221015211233221.png" alt="image-20221015211233221" style="zoom:80%;">

<p>EmitLogTopicï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æµ‹è¯•äº¤æ¢æœº:topic</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmitLogTopic</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;topic_logs&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitConnectUtil.getChannel()) &#123;</span><br><span class="line">            channel.exchangeDeclare(EXCHANGE_NAME, <span class="string">&quot;topic&quot;</span>);</span><br><span class="line">            Map&lt;String, String&gt; bindingKeyMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            bindingKeyMap.put(<span class="string">&quot;quick.orange.rabbit&quot;</span>, <span class="string">&quot;è¢«é˜Ÿåˆ— Q1Q2 æ¥æ”¶åˆ°&quot;</span>);</span><br><span class="line">            bindingKeyMap.put(<span class="string">&quot;lazy.orange.elephant&quot;</span>, <span class="string">&quot;è¢«é˜Ÿåˆ— Q1Q2 æ¥æ”¶åˆ°&quot;</span>);</span><br><span class="line">            bindingKeyMap.put(<span class="string">&quot;quick.orange.fox&quot;</span>, <span class="string">&quot;è¢«é˜Ÿåˆ— Q1 æ¥æ”¶åˆ°&quot;</span>);</span><br><span class="line">            bindingKeyMap.put(<span class="string">&quot;lazy.brown.fox&quot;</span>, <span class="string">&quot;è¢«é˜Ÿåˆ— Q2 æ¥æ”¶åˆ°&quot;</span>);</span><br><span class="line">            bindingKeyMap.put(<span class="string">&quot;lazy.pink.rabbit&quot;</span>, <span class="string">&quot;è™½ç„¶æ»¡è¶³ä¸¤ä¸ªç»‘å®šä½†åªè¢«é˜Ÿåˆ— Q2 æ¥æ”¶ä¸€æ¬¡&quot;</span>);</span><br><span class="line">            bindingKeyMap.put(<span class="string">&quot;quick.brown.fox&quot;</span>, <span class="string">&quot;ä¸åŒ¹é…ä»»ä½•ç»‘å®šä¸ä¼šè¢«ä»»ä½•é˜Ÿåˆ—æ¥æ”¶åˆ°ä¼šè¢«ä¸¢å¼ƒ&quot;</span>);</span><br><span class="line">            bindingKeyMap.put(<span class="string">&quot;quick.orange.male.rabbit&quot;</span>, <span class="string">&quot;æ˜¯å››ä¸ªå•è¯ä¸åŒ¹é…ä»»ä½•ç»‘å®šä¼šè¢«ä¸¢å¼ƒ&quot;</span>);</span><br><span class="line">            bindingKeyMap.put(<span class="string">&quot;lazy.orange.male.rabbit&quot;</span>, <span class="string">&quot;æ˜¯å››ä¸ªå•è¯ä½†åŒ¹é… Q2&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; bindingKeyEntry : bindingKeyMap.entrySet()) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">bindingKey</span> <span class="operator">=</span> bindingKeyEntry.getKey();</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> bindingKeyEntry.getValue();</span><br><span class="line">                channel.basicPublish(EXCHANGE_NAME, bindingKey, <span class="literal">null</span>,</span><br><span class="line">                        message.getBytes(<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">                System.out.println(<span class="string">&quot;ç”Ÿäº§è€…å‘å‡ºæ¶ˆæ¯ï¼š&quot;</span> + message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ReceiveLogsTopic01ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReceiveLogsTopic01</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;topic_logs&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitConnectUtil.getChannel();</span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME, <span class="string">&quot;topic&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;Q1&quot;</span>;</span><br><span class="line">        channel.queueDeclare(queueName, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        channel.queueBind(queueName, EXCHANGE_NAME, <span class="string">&quot;*.orange.*&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;ç­‰å¾…æ¥æ”¶æ¶ˆæ¯...&quot;</span>);</span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> (consumerTag, delivery) -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody(), <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;æ¥æ”¶é˜Ÿåˆ— :&quot;</span> + queueName + <span class="string">&quot; ç»‘å®šé”®:&quot;</span> + </span><br><span class="line">                               delivery.getEnvelope().getRoutingKey() + <span class="string">&quot;, æ¶ˆæ¯:&quot;</span> + message);</span><br><span class="line">        &#125;;</span><br><span class="line">        channel.basicConsume(queueName, <span class="literal">true</span>, deliverCallback, consumerTag -&gt; &#123;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ReceiveLogsTopic02ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReceiveLogsTopic02</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;topic_logs&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitConnectUtil.getChannel();</span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME, <span class="string">&quot;topic&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;Q1&quot;</span>;</span><br><span class="line">        channel.queueDeclare(queueName, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        channel.queueBind(queueName, EXCHANGE_NAME, <span class="string">&quot;*.*.rabbit&quot;</span>);</span><br><span class="line">        channel.queueBind(queueName, EXCHANGE_NAME, <span class="string">&quot;lazy.#&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;ç­‰å¾…æ¥æ”¶æ¶ˆæ¯...&quot;</span>);</span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> (consumerTag, delivery) -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody(), <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;æ¥æ”¶é˜Ÿåˆ— :&quot;</span> + queueName + <span class="string">&quot; ç»‘å®šé”®:&quot;</span> + </span><br><span class="line">                               delivery.getEnvelope().getRoutingKey() + <span class="string">&quot;, æ¶ˆæ¯:&quot;</span> + message);</span><br><span class="line">        &#125;;</span><br><span class="line">        channel.basicConsume(queueName, <span class="literal">true</span>, deliverCallback, consumerTag -&gt; &#123;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æ­»ä¿¡é˜Ÿåˆ—"><a href="#æ­»ä¿¡é˜Ÿåˆ—" class="headerlink" title="æ­»ä¿¡é˜Ÿåˆ—"></a>æ­»ä¿¡é˜Ÿåˆ—</h3><h4 id="æ­»ä¿¡æ¦‚å¿µ"><a href="#æ­»ä¿¡æ¦‚å¿µ" class="headerlink" title="æ­»ä¿¡æ¦‚å¿µ"></a>æ­»ä¿¡æ¦‚å¿µ</h4><p>â€‹		æ­»ä¿¡ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯æ— æ³•è¢«æ¶ˆè´¹çš„æ¶ˆæ¯ï¼Œå­—é¢æ„æ€å¯ä»¥è¿™æ ·ç†è§£ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œproducer å°†æ¶ˆæ¯æŠ•é€’åˆ° broker æˆ–è€…ç›´æ¥åˆ° queue é‡Œäº†ï¼Œconsumer ä» queue å–å‡ºæ¶ˆæ¯è¿›è¡Œæ¶ˆè´¹ï¼Œä½†æŸäº›æ—¶å€™ç”±äºç‰¹å®šçš„åŸå› å¯¼è‡´ queue ä¸­çš„æŸäº›æ¶ˆæ¯æ— æ³•è¢«æ¶ˆè´¹ï¼Œè¿™æ ·çš„æ¶ˆæ¯å¦‚æœæ²¡æœ‰åç»­çš„å¤„ç†ï¼Œå°±å˜æˆäº†æ­»ä¿¡ï¼Œæœ‰æ­»ä¿¡è‡ªç„¶å°±æœ‰äº†æ­»ä¿¡é˜Ÿåˆ—ã€‚</p>
<p>åº”ç”¨åœºæ™¯ï¼šä¸ºäº†ä¿è¯è®¢å•ä¸šåŠ¡çš„æ¶ˆæ¯æ•°æ®ä¸ä¸¢å¤±ï¼Œéœ€è¦ä½¿ç”¨åˆ° RabbitMQ çš„æ­»ä¿¡é˜Ÿåˆ—æœºåˆ¶ï¼Œå½“æ¶ˆæ¯æ¶ˆè´¹å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œå°†æ¶ˆæ¯æŠ•å…¥æ­»ä¿¡é˜Ÿåˆ—ä¸­ï¼Œè¿˜æœ‰æ¯”å¦‚è¯´ï¼šç”¨æˆ·åœ¨å•†åŸä¸‹å•æˆåŠŸå¹¶ç‚¹å‡»å»æ”¯ä»˜ååœ¨æŒ‡å®šæ—¶é—´æœªæ”¯ä»˜æ—¶è‡ªåŠ¨å¤±æ•ˆã€‚</p>
<h4 id="æ­»ä¿¡çš„æ¥æº"><a href="#æ­»ä¿¡çš„æ¥æº" class="headerlink" title="æ­»ä¿¡çš„æ¥æº"></a>æ­»ä¿¡çš„æ¥æº</h4><ul>
<li>æ¶ˆæ¯ TTL è¿‡æœŸ</li>
<li>é˜Ÿåˆ—è¾¾åˆ°æœ€å¤§é•¿åº¦ï¼ˆé˜Ÿåˆ—æ»¡äº†ï¼Œæ— æ³•å†æ·»åŠ æ•°æ®åˆ° mq ä¸­ï¼‰ </li>
<li>æ¶ˆæ¯è¢«æ‹’ç»ï¼ˆbasic.reject æˆ– basic.nackï¼‰å¹¶ä¸” requeue&#x3D;false</li>
</ul>
<img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221015211807927.png" alt="image-20221015211807927" style="zoom:80%;">

<p>è¯´æ˜ï¼š</p>
<p>â€‹		äº¤æ¢æœºç±»å‹ä¸º directï¼Œåç§°ä¸º normal_exchangeï¼Œå‘å¸ƒæ¶ˆæ¯ç»™ normal_queueï¼Œæ¶ˆè´¹è€…C1ç”±äºä»¥ä¸ŠåŸå› ä¸èƒ½æ¶ˆè´¹æ¶ˆæ¯ï¼Œæœªè¢«æ¶ˆè´¹çš„æ¶ˆæ¯æˆä¸ºæ­»ä¿¡ï¼Œæ”¾å…¥é˜Ÿåˆ— dead_queue ä¸­ï¼Œç±»å‹ä¸º directï¼Œç­‰å¾…è¢«å…¶ä»–çš„æ¶ˆè´¹è€…è¿›è¡Œæ¶ˆè´¹ï¼Œè¯¥é˜Ÿåˆ—å³ä¸ºæ­»ä¿¡é˜Ÿåˆ—ã€‚</p>
<h4 id="æ­»ä¿¡é˜Ÿåˆ—ç¤ºä¾‹"><a href="#æ­»ä¿¡é˜Ÿåˆ—ç¤ºä¾‹" class="headerlink" title="æ­»ä¿¡é˜Ÿåˆ—ç¤ºä¾‹"></a>æ­»ä¿¡é˜Ÿåˆ—ç¤ºä¾‹</h4><h5 id="æ¶ˆæ¯-TTL-è¿‡æœŸ"><a href="#æ¶ˆæ¯-TTL-è¿‡æœŸ" class="headerlink" title="æ¶ˆæ¯ TTL è¿‡æœŸ"></a>æ¶ˆæ¯ TTL è¿‡æœŸ</h5><p>ç”Ÿäº§è€…ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ­»ä¿¡é˜Ÿåˆ—ï¼š</span></span><br><span class="line"><span class="comment"> * TTLè¿‡æœŸ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">NORMAL_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;normal_exchange&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitConnectUtil.getChannel();</span><br><span class="line">        channel.exchangeDeclare(NORMAL_EXCHANGE, BuiltinExchangeType.DIRECT);</span><br><span class="line">        <span class="comment">// è®¾ç½®æ¶ˆæ¯çš„TTLè¿‡æœŸæ—¶é—´:10S</span></span><br><span class="line">        AMQP.<span class="type">BasicProperties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AMQP</span>.BasicProperties().builder().expiration(<span class="string">&quot;10000&quot;</span>).build();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;info&quot;</span> + i;</span><br><span class="line">            channel.basicPublish(NORMAL_EXCHANGE, <span class="string">&quot;name&quot;</span>, properties, message.getBytes());</span><br><span class="line">            System.out.println(<span class="string">&quot;ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ï¼š&quot;</span> + message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¶ˆè´¹è€… C1 ä»£ç ï¼ˆå¯åŠ¨ä¹‹åå…³é—­è¯¥æ¶ˆè´¹è€…ï¼Œæ¨¡æ‹Ÿå…¶æ¥æ”¶ä¸åˆ°æ¶ˆæ¯ï¼‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ­»ä¿¡é˜Ÿåˆ—ï¼šTTLè¿‡æœŸ</span></span><br><span class="line"><span class="comment"> * å¯åŠ¨ä¹‹åå…³é—­è¯¥æ¶ˆè´¹è€…ï¼Œæ¨¡æ‹Ÿå…¶æ¥æ”¶ä¸åˆ°æ¶ˆæ¯</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer01</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">NORMAL_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;normal_exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;dead_exchange&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitConnectUtil.getChannel();</span><br><span class="line">        <span class="comment">// å£°æ˜æ™®é€šå¯¹åˆ—å’Œæ­»ä¿¡é˜Ÿåˆ—äº¤æ¢æœº</span></span><br><span class="line">        channel.exchangeDeclare(NORMAL_EXCHANGE, BuiltinExchangeType.DIRECT);</span><br><span class="line">        channel.exchangeDeclare(DEAD_EXCHANGE, BuiltinExchangeType.DIRECT);</span><br><span class="line">        <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;dead-queue&quot;</span>;</span><br><span class="line">        channel.queueDeclare(queueName, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">// ç»‘å®šæ­»ä¿¡é˜Ÿåˆ—å’Œäº¤æ¢æœº</span></span><br><span class="line">        channel.queueBind(queueName, DEAD_EXCHANGE, <span class="string">&quot;name02&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ­£å¸¸é˜Ÿåˆ—è®¾ç½®æ­»ä¿¡äº¤æ¢æœº å‚æ•° key æ˜¯å›ºå®šå€¼</span></span><br><span class="line">        HashMap&lt;String, Object&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        params.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, DEAD_EXCHANGE);</span><br><span class="line">        params.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, <span class="string">&quot;name02&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">normalQueue</span> <span class="operator">=</span> <span class="string">&quot;normal-queue&quot;</span>;</span><br><span class="line">        channel.queueDeclare(normalQueue, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, params);</span><br><span class="line">        channel.queueBind(normalQueue, NORMAL_EXCHANGE, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;ç­‰å¾…æ¥æ”¶æ¶ˆæ¯.....&quot;</span>);</span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DeliverCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s, Delivery delivery)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        channel.basicConsume(normalQueue, <span class="literal">true</span>, deliverCallback, consumerTag -&gt; &#123;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¶ˆè´¹è€… C2 ä»£ç ï¼ˆä»¥ä¸Šæ­¥éª¤å®Œæˆå å¯åŠ¨ C2 æ¶ˆè´¹è€… å®ƒæ¶ˆè´¹æ­»ä¿¡é˜Ÿåˆ—é‡Œé¢çš„æ¶ˆæ¯ï¼‰ </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ­»ä¿¡é˜Ÿåˆ—ï¼šTTLè¿‡æœŸ</span></span><br><span class="line"><span class="comment"> * å¯åŠ¨ C2 æ¶ˆè´¹è€…ï¼Œå®ƒæ¶ˆè´¹æ­»ä¿¡é˜Ÿåˆ—é‡Œé¢çš„æ¶ˆæ¯)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer02</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;dead_exchange&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitConnectUtil.getChannel();</span><br><span class="line">        <span class="comment">// å£°æ˜æ™®é€šå¯¹åˆ—å’Œæ­»ä¿¡é˜Ÿåˆ—äº¤æ¢æœº</span></span><br><span class="line">        channel.exchangeDeclare(DEAD_EXCHANGE, BuiltinExchangeType.DIRECT);</span><br><span class="line">        <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;dead-queue&quot;</span>;</span><br><span class="line">        channel.queueDeclare(queueName, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">// ç»‘å®šæ­»ä¿¡é˜Ÿåˆ—å’Œäº¤æ¢æœº</span></span><br><span class="line">        channel.queueBind(queueName, DEAD_EXCHANGE, <span class="string">&quot;name02&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;ç­‰å¾…æ¥æ”¶æ¶ˆæ¯.....&quot;</span>);</span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DeliverCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s, Delivery delivery)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;æ­»ä¿¡é˜Ÿåˆ—æ¥æ”¶æ¶ˆæ¯ï¼š&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        channel.basicConsume(queueName, <span class="literal">true</span>, deliverCallback, consumerTag -&gt; &#123;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•ï¼š</p>
<p>â€‹		å…ˆå¯åŠ¨æ¶ˆè´¹è€…C1ï¼Œä¹‹åå…³é—­ï¼Œå†å¯åŠ¨ç”Ÿäº§è€…ï¼š</p>
<img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221015232300156.png" alt="image-20221015232300156" style="zoom:80%;">

<p>å‘ç° normal_queue ä¸­çš„æ¶ˆæ¯å·²ç»è½¬ç§»åˆ°dead_queueä¸­ã€‚</p>
<p>æ­¤æ—¶å¯åŠ¨C2æ¶ˆè´¹è€…ï¼Œå‘ç°C2æ¶ˆè´¹äº†æ¶ˆæ¯ã€‚</p>
<h5 id="é˜Ÿåˆ—è¾¾åˆ°æœ€å¤§é•¿åº¦"><a href="#é˜Ÿåˆ—è¾¾åˆ°æœ€å¤§é•¿åº¦" class="headerlink" title="é˜Ÿåˆ—è¾¾åˆ°æœ€å¤§é•¿åº¦"></a>é˜Ÿåˆ—è¾¾åˆ°æœ€å¤§é•¿åº¦</h5><p>æ¶ˆæ¯ç”Ÿäº§è€…ä»£ç å»æ‰ TTL å±æ€§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer02</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">NORMAL_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;normal_exchange&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitConnectUtil.getChannel();</span><br><span class="line">        channel.exchangeDeclare(NORMAL_EXCHANGE, BuiltinExchangeType.DIRECT);</span><br><span class="line">        <span class="comment">// è®¾ç½®æ¶ˆæ¯çš„TTLè¿‡æœŸæ—¶é—´:10S</span></span><br><span class="line">        <span class="comment">// AMQP.BasicProperties properties = new </span></span><br><span class="line">        <span class="comment">// 					AMQP.BasicProperties().builder().expiration(&quot;10000&quot;).build();</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;info&quot;</span> + i;</span><br><span class="line">            channel.basicPublish(NORMAL_EXCHANGE, <span class="string">&quot;name&quot;</span>, <span class="literal">null</span>, message.getBytes());</span><br><span class="line">            System.out.println(<span class="string">&quot;ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ï¼š&quot;</span> + message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¶ˆè´¹è€…C1ä¿®æ”¹é˜Ÿåˆ—é•¿åº¦é™åˆ¶ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HashMap&lt;String, Object&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">      params.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, DEAD_EXCHANGE);</span><br><span class="line">      params.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, <span class="string">&quot;name02&quot;</span>);</span><br><span class="line">      <span class="comment">// è®¾ç½®æ­£å¸¸é˜Ÿåˆ—çš„é•¿åº¦é™åˆ¶</span></span><br><span class="line">      params.put(<span class="string">&quot;x-max-length&quot;</span>, <span class="number">6</span>);</span><br><span class="line">      <span class="type">String</span> <span class="variable">normalQueue</span> <span class="operator">=</span> <span class="string">&quot;normal-queue&quot;</span>;</span><br><span class="line">      channel.queueDeclare(normalQueue, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, params);</span><br><span class="line">      channel.queueBind(normalQueue, NORMAL_EXCHANGE, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">      System.out.println(<span class="string">&quot;ç­‰å¾…æ¥æ”¶æ¶ˆæ¯.....&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>åˆ é™¤åŸå…ˆé˜Ÿåˆ—è¿›è¡Œæµ‹è¯•ï¼š</p>
<p>å‘ç° normal_queue ä¸­æœ‰6æ¡æ•°æ®ï¼Œdead_queue ä¸­æœ‰4æ¡æ•°æ®ã€‚</p>
<p><img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221015233528463.png" alt="image-20221015233528463"></p>
<p>å¯åŠ¨ C2 æ¶ˆè´¹è€…ï¼š</p>
<p><img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221015233649967.png" alt="image-20221015233649967"></p>
<h5 id="æ¶ˆæ¯è¢«æ‹’"><a href="#æ¶ˆæ¯è¢«æ‹’" class="headerlink" title="æ¶ˆæ¯è¢«æ‹’"></a>æ¶ˆæ¯è¢«æ‹’</h5><p>ä¿®æ”¹ C1 æ¶ˆè´¹è€…ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ­»ä¿¡é˜Ÿåˆ—ï¼šæ¶ˆæ¯è¢«æ‹’</span></span><br><span class="line"><span class="comment"> * å¯åŠ¨ä¹‹åå…³é—­è¯¥æ¶ˆè´¹è€…ï¼Œæ¨¡æ‹Ÿå…¶æ¥æ”¶ä¸åˆ°æ¶ˆæ¯</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer03</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">NORMAL_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;normal_exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;dead_exchange&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitConnectUtil.getChannel();</span><br><span class="line">        <span class="comment">// å£°æ˜æ™®é€šå¯¹åˆ—å’Œæ­»ä¿¡é˜Ÿåˆ—äº¤æ¢æœº</span></span><br><span class="line">        channel.exchangeDeclare(NORMAL_EXCHANGE, BuiltinExchangeType.DIRECT);</span><br><span class="line">        channel.exchangeDeclare(DEAD_EXCHANGE, BuiltinExchangeType.DIRECT);</span><br><span class="line">        <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;dead-queue&quot;</span>;</span><br><span class="line">        channel.queueDeclare(queueName, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">// ç»‘å®šæ­»ä¿¡é˜Ÿåˆ—å’Œäº¤æ¢æœº</span></span><br><span class="line">        channel.queueBind(queueName, DEAD_EXCHANGE, <span class="string">&quot;name02&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ­£å¸¸é˜Ÿåˆ—è®¾ç½®æ­»ä¿¡äº¤æ¢æœº å‚æ•° key æ˜¯å›ºå®šå€¼</span></span><br><span class="line">        HashMap&lt;String, Object&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        params.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, DEAD_EXCHANGE);</span><br><span class="line">        params.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, <span class="string">&quot;name02&quot;</span>);</span><br><span class="line">        <span class="comment">// è®¾ç½®æ­£å¸¸é˜Ÿåˆ—çš„é•¿åº¦é™åˆ¶</span></span><br><span class="line">        params.put(<span class="string">&quot;x-max-length&quot;</span>, <span class="number">6</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">normalQueue</span> <span class="operator">=</span> <span class="string">&quot;normal-queue&quot;</span>;</span><br><span class="line">        channel.queueDeclare(normalQueue, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, params);</span><br><span class="line">        channel.queueBind(normalQueue, NORMAL_EXCHANGE, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;ç­‰å¾…æ¥æ”¶æ¶ˆæ¯.....&quot;</span>);</span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DeliverCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s, Delivery delivery)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody());</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;info5&quot;</span>.equals(message)) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;æ¥æ”¶åˆ°æ¶ˆæ¯: &quot;</span> + message + <span class="string">&quot; ï¼Œå¹¶æ‹’ç»ç­¾æ”¶è¯¥æ¶ˆæ¯&quot;</span>);</span><br><span class="line">                    <span class="comment">// requeue è®¾ç½®ä¸º false ä»£è¡¨æ‹’ç»é‡æ–°å…¥é˜Ÿï¼Œè¯¥é˜Ÿåˆ—å¦‚æœé…ç½®äº†æ­»ä¿¡äº¤æ¢æœºå°†å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—ä¸­</span></span><br><span class="line">                    channel.basicReject(delivery.getEnvelope().getDeliveryTag(),<span class="literal">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// æ‰‹åŠ¨åº”ç­”</span></span><br><span class="line">                <span class="keyword">else</span>&#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;æ¥æ”¶åˆ°æ¶ˆæ¯: &quot;</span>+message);</span><br><span class="line">                    channel.basicAck(delivery.getEnvelope().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">autoAck</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        channel.basicConsume(normalQueue, autoAck, deliverCallback, consumerTag -&gt; &#123;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•ï¼š</p>
<p>â€‹		å¯åŠ¨æ¶ˆè´¹è€… C1ï¼ŒC2ï¼Œå†å¯åŠ¨ç”Ÿäº§è€…ï¼Œå‘ç° C2 ç­¾æ”¶äº† C1 æ‹’ç»çš„æ¶ˆæ¯ã€‚</p>
<h3 id="å»¶è¿Ÿé˜Ÿåˆ—"><a href="#å»¶è¿Ÿé˜Ÿåˆ—" class="headerlink" title="å»¶è¿Ÿé˜Ÿåˆ—"></a>å»¶è¿Ÿé˜Ÿåˆ—</h3><h4 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h4><p>â€‹		å»¶æ—¶é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—å†…éƒ¨æ˜¯æœ‰åºçš„ï¼Œæœ€é‡è¦çš„ç‰¹æ€§å°±ä½“ç°åœ¨å®ƒçš„å»¶æ—¶å±æ€§ä¸Šï¼Œå»¶æ—¶é˜Ÿåˆ—ä¸­çš„å…ƒç´ æ˜¯å¸Œæœ›åœ¨æŒ‡å®šæ—¶é—´åˆ°äº†ä»¥åæˆ–ä¹‹å‰å–å‡ºå’Œå¤„ç†ï¼Œç®€å•æ¥è¯´ï¼Œå»¶æ—¶é˜Ÿåˆ—å°±æ˜¯ç”¨æ¥å­˜æ”¾éœ€è¦åœ¨æŒ‡å®šæ—¶é—´è¢«å¤„ç†çš„å…ƒç´ çš„é˜Ÿåˆ—ã€‚</p>
<h4 id="å»¶è¿Ÿé˜Ÿåˆ—ä½¿ç”¨åœºæ™¯"><a href="#å»¶è¿Ÿé˜Ÿåˆ—ä½¿ç”¨åœºæ™¯" class="headerlink" title="å»¶è¿Ÿé˜Ÿåˆ—ä½¿ç”¨åœºæ™¯"></a>å»¶è¿Ÿé˜Ÿåˆ—ä½¿ç”¨åœºæ™¯</h4><ol>
<li>è®¢å•åœ¨ååˆ†é’Ÿä¹‹å†…æœªæ”¯ä»˜åˆ™è‡ªåŠ¨å–æ¶ˆ</li>
<li>æ–°åˆ›å»ºçš„åº—é“ºï¼Œå¦‚æœåœ¨åå¤©å†…éƒ½æ²¡æœ‰ä¸Šä¼ è¿‡å•†å“ï¼Œåˆ™è‡ªåŠ¨å‘é€æ¶ˆæ¯æé†’</li>
<li>ç”¨æˆ·æ³¨å†ŒæˆåŠŸåï¼Œå¦‚æœä¸‰å¤©å†…æ²¡æœ‰ç™»é™†åˆ™è¿›è¡ŒçŸ­ä¿¡æé†’</li>
<li>ç”¨æˆ·å‘èµ·é€€æ¬¾ï¼Œå¦‚æœä¸‰å¤©å†…æ²¡æœ‰å¾—åˆ°å¤„ç†åˆ™é€šçŸ¥ç›¸å…³è¿è¥äººå‘˜</li>
<li>é¢„å®šä¼šè®®åï¼Œéœ€è¦åœ¨é¢„å®šçš„æ—¶é—´ç‚¹å‰ååˆ†é’Ÿé€šçŸ¥å„ä¸ªä¸ä¼šäººå‘˜å‚åŠ ä¼šè®®</li>
</ol>
<p>â€‹		<strong>è¿™äº›åœºæ™¯éƒ½æœ‰ä¸€ä¸ªç‰¹ç‚¹ï¼Œéœ€è¦åœ¨æŸä¸ªäº‹ä»¶å‘ç”Ÿä¹‹åæˆ–è€…ä¹‹å‰çš„æŒ‡å®šæ—¶é—´ç‚¹å®ŒæˆæŸä¸€é¡¹ä»»åŠ¡</strong>ï¼Œå¦‚ï¼š å‘ç”Ÿè®¢å•ç”Ÿæˆäº‹ä»¶ï¼Œåœ¨ååˆ†é’Ÿä¹‹åæ£€æŸ¥è¯¥è®¢å•æ”¯ä»˜çŠ¶æ€ï¼Œç„¶åå°†æœªæ”¯ä»˜çš„è®¢å•è¿›è¡Œå…³é—­ï¼›çœ‹èµ·æ¥ä¼¼ä¹ä½¿ç”¨å®šæ—¶ä»»åŠ¡ï¼Œä¸€ç›´è½®è¯¢æ•°æ®ï¼Œæ¯ç§’æŸ¥ä¸€æ¬¡ï¼Œå–å‡ºéœ€è¦è¢«å¤„ç†çš„æ•°æ®ï¼Œç„¶åå¤„ç†ä¸å°±å®Œäº‹äº†å—ï¼Ÿå¦‚æœ æ•°æ®é‡æ¯”è¾ƒå°‘ï¼Œç¡®å®å¯ä»¥è¿™æ ·åšï¼Œæ¯”å¦‚ï¼šå¯¹äº â€œå¦‚æœè´¦å•ä¸€å‘¨å†…æœªæ”¯ä»˜åˆ™è¿›è¡Œè‡ªåŠ¨ç»“ç®—â€ è¿™æ ·çš„éœ€æ±‚ï¼Œ å¦‚æœå¯¹äºæ—¶é—´ä¸æ˜¯ä¸¥æ ¼é™åˆ¶ï¼Œè€Œæ˜¯å®½æ¾æ„ä¹‰ä¸Šçš„ä¸€å‘¨ï¼Œé‚£ä¹ˆæ¯å¤©æ™šä¸Šè·‘ä¸ªå®šæ—¶ä»»åŠ¡æ£€æŸ¥ä¸€ä¸‹æ‰€æœ‰æœªæ”¯ä»˜çš„è´¦å•ï¼Œç¡®å®ä¹Ÿæ˜¯ä¸€ä¸ªå¯è¡Œçš„æ–¹æ¡ˆã€‚<strong>ä½†å¯¹äºæ•°æ®é‡æ¯”è¾ƒå¤§ï¼Œå¹¶ä¸”æ—¶æ•ˆæ€§è¾ƒå¼ºçš„åœºæ™¯</strong>ï¼Œå¦‚ï¼šâ€œè®¢å•å åˆ†é’Ÿå†…æœªæ”¯ä»˜åˆ™å…³é—­â€œï¼ŒçŸ­æœŸå†…æœªæ”¯ä»˜çš„è®¢å•æ•°æ®å¯èƒ½ä¼šæœ‰å¾ˆå¤šï¼Œæ´»åŠ¨æœŸé—´ç”šè‡³ä¼šè¾¾åˆ°ç™¾ä¸‡ç”šè‡³åƒä¸‡çº§åˆ«ï¼Œå¯¹è¿™ä¹ˆåºå¤§çš„æ•°æ®é‡ä»æ—§ä½¿ç”¨è½®è¯¢çš„æ–¹å¼æ˜¾ç„¶æ˜¯ä¸å¯å–çš„ï¼Œå¾ˆå¯èƒ½åœ¨ä¸€ç§’å†…æ— æ³•å®Œæˆæ‰€æœ‰è®¢å•çš„æ£€æŸ¥ï¼ŒåŒæ—¶ä¼šç»™æ•°æ®åº“å¸¦æ¥å¾ˆå¤§å‹åŠ›ï¼Œæ— æ³•æ»¡è¶³ä¸šåŠ¡è¦æ±‚è€Œä¸”æ€§èƒ½ä½ä¸‹ã€‚</p>
<img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221016001651743.png" alt="image-20221016001651743" style="zoom:80%;">

<h4 id="RabbitMQ-ä¸­çš„-TTL"><a href="#RabbitMQ-ä¸­çš„-TTL" class="headerlink" title="RabbitMQ ä¸­çš„ TTL"></a>RabbitMQ ä¸­çš„ TTL</h4><p>â€‹		TTL æ˜¯ RabbitMQ ä¸­ä¸€ä¸ªæ¶ˆæ¯æˆ–è€…é˜Ÿåˆ—çš„å±æ€§ï¼Œè¡¨æ˜ä¸€æ¡æ¶ˆæ¯æˆ–è€…è¯¥é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰æ¶ˆæ¯çš„æœ€å¤§å­˜æ´»æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’ã€‚æ¢å¥è¯è¯´ï¼Œå¦‚æœä¸€æ¡æ¶ˆæ¯è®¾ç½®äº† TTL å±æ€§æˆ–è€…è¿›å…¥äº†è®¾ç½® TTL å±æ€§çš„é˜Ÿåˆ—ï¼Œé‚£ä¹ˆè¿™æ¡æ¶ˆæ¯å¦‚æœåœ¨ TTL è®¾ç½®çš„æ—¶é—´å†…æ²¡æœ‰è¢«æ¶ˆè´¹ï¼Œåˆ™ä¼šæˆä¸º â€œæ­»ä¿¡â€ã€‚<strong>å¦‚æœåŒæ—¶é…ç½®äº†é˜Ÿåˆ—çš„ TTL å’Œæ¶ˆæ¯çš„ TTLï¼Œé‚£ä¹ˆè¾ƒå°çš„é‚£ä¸ªå€¼å°†ä¼šè¢«ä½¿ç”¨</strong>ï¼Œæœ‰ä¸¤ç§æ–¹å¼è®¾ç½® TTLï¼š</p>
<p>æ¶ˆæ¯è®¾ç½®TTLï¼šï¼ˆé’ˆå¯¹æ¯æ¡æ¶ˆæ¯è®¾ç½® TTLï¼‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rabbitTemplate.convertAndSend(DELAYED_EXCHANGE_NAME, DELAYED_ROUTING_KEY, message, correlationData -&gt; &#123;</span><br><span class="line">            correlationData.getMessageProperties().setExpiration(ttlTime);</span><br><span class="line">            <span class="keyword">return</span> correlationData;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>

<p>é˜Ÿåˆ—è®¾ç½® TTL ï¼šï¼ˆåˆ›å»ºé˜Ÿåˆ—çš„æ—¶å€™è®¾ç½®é˜Ÿåˆ—çš„ â€œx-message-ttlâ€ å±æ€§ï¼‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean(&quot;queueA&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> Queue <span class="title function_">queueA</span><span class="params">()</span> &#123;</span><br><span class="line">       Map&lt;String, Object&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">3</span>);</span><br><span class="line">       <span class="comment">// å£°æ˜å½“å‰é˜Ÿåˆ—ç»‘å®šçš„æ­»ä¿¡äº¤æ¢æœº</span></span><br><span class="line">       params.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, Y_DEAD_LETTER_EXCHANGE);</span><br><span class="line">       <span class="comment">// å£°æ˜å½“å‰é˜Ÿåˆ—çš„æ­»ä¿¡è·¯ç”± key</span></span><br><span class="line">       params.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, DEAD_LETTER_ROUTING_KEY);</span><br><span class="line">       <span class="comment">// å£°æ˜é˜Ÿåˆ—çš„ TTL</span></span><br><span class="line">       params.put(<span class="string">&quot;x-message-ttl&quot;</span>, <span class="number">10000</span>);</span><br><span class="line">       <span class="keyword">return</span> QueueBuilder.durable(QUEUE_A).withArguments(params).build();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>ä¸¤è€…çš„åŒºåˆ«ï¼š</p>
<p>â€‹		å¦‚æœè®¾ç½®äº†é˜Ÿåˆ—çš„ TTL å±æ€§ï¼Œé‚£ä¹ˆä¸€æ—¦æ¶ˆæ¯è¿‡æœŸï¼Œå°±ä¼šè¢«é˜Ÿåˆ—ä¸¢å¼ƒï¼ˆå¦‚æœé…ç½®äº†æ­»ä¿¡é˜Ÿåˆ—è¢«ä¸¢åˆ°æ­»ä¿¡é˜Ÿåˆ—ä¸­ï¼‰ï¼Œè€Œç¬¬äºŒç§æ–¹å¼ï¼Œæ¶ˆæ¯å³ä½¿è¿‡æœŸï¼Œä¹Ÿä¸ä¸€å®šä¼šè¢«é©¬ä¸Šä¸¢å¼ƒï¼Œå› ä¸ºæ¶ˆæ¯æ˜¯å¦è¿‡æœŸæ˜¯åœ¨å³å°†æŠ•é€’åˆ°æ¶ˆè´¹è€…ä¹‹å‰åˆ¤å®šçš„ï¼Œå¦‚æœå½“å‰é˜Ÿåˆ—æœ‰ä¸¥é‡çš„æ¶ˆæ¯ç§¯å‹æƒ…å†µï¼Œåˆ™å·²è¿‡æœŸçš„æ¶ˆæ¯ä¹Ÿè®¸è¿˜èƒ½å­˜æ´»è¾ƒé•¿æ—¶é—´ï¼›å¦å¤–ï¼Œè¿˜éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œå¦‚æœä¸è®¾ç½® TTLï¼Œè¡¨ç¤ºæ¶ˆæ¯æ°¸è¿œä¸ä¼šè¿‡æœŸï¼Œå¦‚æœå°† TTL è®¾ç½®ä¸º 0ï¼Œåˆ™è¡¨ç¤ºé™¤éæ­¤æ—¶å¯ä»¥ç›´æ¥æŠ•é€’è¯¥æ¶ˆæ¯åˆ°æ¶ˆè´¹è€…ï¼Œå¦åˆ™è¯¥æ¶ˆæ¯å°†ä¼šè¢«ä¸¢å¼ƒã€‚</p>
<p>â€‹		å»¶æ—¶é˜Ÿåˆ—ï¼Œä¸å°±æ˜¯æƒ³è¦æ¶ˆæ¯å»¶è¿Ÿå¤šä¹…è¢«å¤„ç†å—ï¼ŒTTL åˆ™åˆšå¥½èƒ½è®©æ¶ˆæ¯åœ¨å»¶è¿Ÿå¤šä¹…ä¹‹åæˆä¸ºæ­»ä¿¡ï¼Œå¦ä¸€æ–¹é¢ï¼Œ æˆä¸ºæ­»ä¿¡çš„æ¶ˆæ¯éƒ½ä¼šè¢«æŠ•é€’åˆ°æ­»ä¿¡é˜Ÿåˆ—é‡Œï¼Œè¿™æ ·åªéœ€è¦æ¶ˆè´¹è€…ä¸€ç›´æ¶ˆè´¹æ­»ä¿¡é˜Ÿåˆ—é‡Œçš„æ¶ˆæ¯å°±å®Œäº‹äº†ï¼Œå› ä¸ºé‡Œé¢çš„æ¶ˆæ¯éƒ½æ˜¯å¸Œæœ›è¢«ç«‹å³å¤„ç†çš„æ¶ˆæ¯ã€‚</p>
<h4 id="æ•´åˆSpringBoot"><a href="#æ•´åˆSpringBoot" class="headerlink" title="æ•´åˆSpringBoot"></a>æ•´åˆSpringBoot</h4><p>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 </span></span></span><br><span class="line"><span class="string"><span class="tag">                             http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>RabbitMQSprintBoot<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--RabbitMQ ä¾èµ–--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.47<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--swagger--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--RabbitMQ æµ‹è¯•ä¾èµ–--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.amqp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-rabbit-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>application.propertiesï¼š</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.rabbitmq.host</span>=<span class="string">192.168.100.100</span></span><br><span class="line"><span class="attr">spring.rabbitmq.port</span>=<span class="string">5672</span></span><br><span class="line"><span class="attr">spring.rabbitmq.username</span>=<span class="string">admin</span></span><br><span class="line"><span class="attr">spring.rabbitmq.password</span>=<span class="string">admin</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># swaggeré«˜ç‰ˆæœ¬é…ç½®</span></span><br><span class="line"><span class="attr">spring.mvc.pathmatch.matching-strategy</span>=<span class="string">ant_path_matcher</span></span><br></pre></td></tr></table></figure>

<p>Swaggerï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableSwagger2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SwaggerConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Docket <span class="title function_">webApiConfig</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Docket</span>(DocumentationType.SWAGGER_2)</span><br><span class="line">                .groupName(<span class="string">&quot;webApi&quot;</span>)</span><br><span class="line">                .apiInfo(webApiInfo())</span><br><span class="line">                .select()</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ApiInfo <span class="title function_">webApiInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ApiInfoBuilder</span>()</span><br><span class="line">                .title(<span class="string">&quot;rabbitmq æ¥å£æ–‡æ¡£&quot;</span>)</span><br><span class="line">                .description(<span class="string">&quot;æœ¬æ–‡æ¡£æè¿°äº† rabbitmq å¾®æœåŠ¡æ¥å£å®šä¹‰&quot;</span>)</span><br><span class="line">                .version(<span class="string">&quot;1.0&quot;</span>)</span><br><span class="line">                .contact(<span class="keyword">new</span> <span class="title class_">Contact</span>(<span class="string">&quot;tom&quot;</span>, <span class="string">&quot;https://gitee.com&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;mineting@163.com&quot;</span>))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MainApplicationï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.rabbitmq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(MainApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="é˜Ÿåˆ—-TTL"><a href="#é˜Ÿåˆ—-TTL" class="headerlink" title="é˜Ÿåˆ— TTL"></a>é˜Ÿåˆ— TTL</h4><p>â€‹		åˆ›å»ºä¸¤ä¸ªé˜Ÿåˆ— QA å’Œ QBï¼Œä¸¤è€…é˜Ÿåˆ— TTL åˆ†åˆ«è®¾ç½®ä¸º 10S å’Œ 40Sï¼Œç„¶ååœ¨åˆ›å»ºä¸€ä¸ªäº¤æ¢æœº X å’Œæ­»ä¿¡äº¤ æ¢æœº Yï¼Œå®ƒä»¬çš„ç±»å‹éƒ½æ˜¯ directï¼Œåˆ›å»ºä¸€ä¸ªæ­»ä¿¡é˜Ÿåˆ— QDï¼Œï¼ˆåªåˆ›å»ºç§ä¿¡é˜Ÿåˆ—ï¼Œé¿å…è¢«å…¶ä»–é˜Ÿåˆ—æ¶ˆè´¹ï¼‰å®ƒä»¬çš„ç»‘å®šå…³ç³»å¦‚ä¸‹ï¼š</p>
<p><img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221019132536740.png" alt="image-20221019132536740"></p>
<h5 id="é…ç½®ç±»"><a href="#é…ç½®ç±»" class="headerlink" title="é…ç½®ç±»"></a>é…ç½®ç±»</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.rabbitmq.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TtlQueueConfig</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">X_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;X&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_A</span> <span class="operator">=</span> <span class="string">&quot;QA&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_B</span> <span class="operator">=</span> <span class="string">&quot;QB&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_A_ROUTING_KEY</span> <span class="operator">=</span> <span class="string">&quot;XA&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_B_ROUTING_KEY</span> <span class="operator">=</span> <span class="string">&quot;XB&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">Y_DEAD_LETTER_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;Y&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_LETTER_QUEUE</span> <span class="operator">=</span> <span class="string">&quot;QD&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_LETTER_ROUTING_KEY</span> <span class="operator">=</span> <span class="string">&quot;YD&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;xExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">xExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(X_EXCHANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;yExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">yExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(Y_DEAD_LETTER_EXCHANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å£°æ˜é˜Ÿåˆ— A ttl ä¸º 10s å¹¶ç»‘å®šåˆ°å¯¹åº”çš„æ­»ä¿¡äº¤æ¢æœº</span></span><br><span class="line">    <span class="meta">@Bean(&quot;queueA&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">queueA</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">3</span>);</span><br><span class="line">        <span class="comment">// å£°æ˜å½“å‰é˜Ÿåˆ—ç»‘å®šçš„æ­»ä¿¡äº¤æ¢æœº</span></span><br><span class="line">        params.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, Y_DEAD_LETTER_EXCHANGE);</span><br><span class="line">        <span class="comment">// å£°æ˜å½“å‰é˜Ÿåˆ—çš„æ­»ä¿¡è·¯ç”± key</span></span><br><span class="line">        params.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, DEAD_LETTER_ROUTING_KEY);</span><br><span class="line">        <span class="comment">// å£°æ˜é˜Ÿåˆ—çš„ TTL</span></span><br><span class="line">        params.put(<span class="string">&quot;x-message-ttl&quot;</span>, <span class="number">10000</span>);</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(QUEUE_A).withArguments(params).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å£°æ˜é˜Ÿåˆ— A ç»‘å®š X äº¤æ¢æœº</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">queueaBindingX</span><span class="params">(<span class="meta">@Qualifier(&quot;queueA&quot;)</span> Queue queueA,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@Qualifier(&quot;xExchange&quot;)</span> DirectExchange xExchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queueA).to(xExchange).with(<span class="string">&quot;XA&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å£°æ˜é˜Ÿåˆ— B ttl ä¸º 40s å¹¶ç»‘å®šåˆ°å¯¹åº”çš„æ­»ä¿¡äº¤æ¢æœº</span></span><br><span class="line">    <span class="meta">@Bean(&quot;queueB&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">queueB</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">3</span>);</span><br><span class="line">        <span class="comment">//å£°æ˜å½“å‰é˜Ÿåˆ—ç»‘å®šçš„æ­»ä¿¡äº¤æ¢æœº</span></span><br><span class="line">        args.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, Y_DEAD_LETTER_EXCHANGE);</span><br><span class="line">        <span class="comment">//å£°æ˜å½“å‰é˜Ÿåˆ—çš„æ­»ä¿¡è·¯ç”± key</span></span><br><span class="line">        args.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, <span class="string">&quot;YD&quot;</span>);</span><br><span class="line">        <span class="comment">//å£°æ˜é˜Ÿåˆ—çš„ TTL</span></span><br><span class="line">        args.put(<span class="string">&quot;x-message-ttl&quot;</span>, <span class="number">40000</span>);</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(QUEUE_B).withArguments(args).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å£°æ˜é˜Ÿåˆ— B ç»‘å®š X äº¤æ¢æœº</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">queuebBindingX</span><span class="params">(<span class="meta">@Qualifier(&quot;queueB&quot;)</span> Queue queue1B,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@Qualifier(&quot;xExchange&quot;)</span> DirectExchange xExchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue1B).to(xExchange).with(<span class="string">&quot;XB&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å£°æ˜æ­»ä¿¡é˜Ÿåˆ— QD</span></span><br><span class="line">    <span class="meta">@Bean(&quot;queueD&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">queueD</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(DEAD_LETTER_QUEUE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å£°æ˜æ­»ä¿¡é˜Ÿåˆ— QD ç»‘å®šå…³ç³»</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">deadLetterBindingQAD</span><span class="params">(<span class="meta">@Qualifier(&quot;queueD&quot;)</span> Queue queueD,</span></span><br><span class="line"><span class="params">                                        <span class="meta">@Qualifier(&quot;yExchange&quot;)</span> DirectExchange yExchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queueD).to(yExchange).with(<span class="string">&quot;YD&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="æ¶ˆæ¯ç”Ÿäº§è€…"><a href="#æ¶ˆæ¯ç”Ÿäº§è€…" class="headerlink" title="æ¶ˆæ¯ç”Ÿäº§è€…"></a>æ¶ˆæ¯ç”Ÿäº§è€…</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.rabbitmq.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;ttl&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SendMsgController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/sendMsg/&#123;message&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMsg</span><span class="params">(<span class="meta">@PathVariable</span> String message)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;å½“å‰æ—¶é—´ï¼š&#123;&#125;,å‘é€ä¸€æ¡ä¿¡æ¯ç»™ä¸¤ä¸ª TTL é˜Ÿåˆ—:&#123;&#125;&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>(), message);</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;X&quot;</span>, <span class="string">&quot;XA&quot;</span>, <span class="string">&quot;æ¶ˆæ¯æ¥è‡ª ttl ä¸º 10S çš„é˜Ÿåˆ—: &quot;</span> + message);</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;X&quot;</span>, <span class="string">&quot;XB&quot;</span>, <span class="string">&quot;æ¶ˆæ¯æ¥è‡ª ttl ä¸º 40S çš„é˜Ÿåˆ—: &quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="æ¶ˆæ¯æ¶ˆè´¹è€…"><a href="#æ¶ˆæ¯æ¶ˆè´¹è€…" class="headerlink" title="æ¶ˆæ¯æ¶ˆè´¹è€…"></a>æ¶ˆæ¯æ¶ˆè´¹è€…</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.rabbitmq.consumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeadLetterQueueConsumer</span> &#123;</span><br><span class="line">    <span class="meta">@RabbitListener(queues = &#123;&quot;QD&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveD</span><span class="params">(Message message, Channel channel)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody());</span><br><span class="line">        log.info(<span class="string">&quot;å½“å‰æ—¶é—´ï¼š&#123;&#125;,æ”¶åˆ°æ­»ä¿¡é˜Ÿåˆ—ä¿¡æ¯&#123;&#125;&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>().toString(), msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•ï¼šå‘é€è¯·æ±‚ <a target="_blank" rel="noopener" href="http://localhost:8080/ttl/sendMsg/HelloWorld">http://localhost:8080/ttl/sendMsg/HelloWorld</a></p>
<p><img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221019134229276.png" alt="image-20221019134229276"></p>
<p>ç¬¬ä¸€æ¡æ¶ˆæ¯åœ¨ 10S åå˜æˆäº†æ­»ä¿¡æ¶ˆæ¯ï¼Œç„¶åè¢«æ¶ˆè´¹è€…æ¶ˆè´¹æ‰ï¼Œç¬¬äºŒæ¡æ¶ˆæ¯åœ¨ 40S ä¹‹åå˜æˆäº†æ­»ä¿¡æ¶ˆæ¯ï¼Œ ç„¶åè¢«æ¶ˆè´¹æ‰ï¼Œè¿™æ ·ä¸€ä¸ªå»¶æ—¶é˜Ÿåˆ—å°±æ‰“é€ å®Œæˆäº†ã€‚</p>
<p>å½“å‰é—®é¢˜ï¼šæ¯å¢åŠ ä¸€ä¸ªæ–°çš„æ—¶é—´éœ€æ±‚ï¼Œå°±è¦æ–°å¢ä¸€ä¸ªé˜Ÿåˆ—</p>
<h4 id="å»¶æ—¶é˜Ÿåˆ—ä¼˜åŒ–"><a href="#å»¶æ—¶é˜Ÿåˆ—ä¼˜åŒ–" class="headerlink" title="å»¶æ—¶é˜Ÿåˆ—ä¼˜åŒ–"></a>å»¶æ—¶é˜Ÿåˆ—ä¼˜åŒ–</h4><p>â€‹		åœ¨è¿™é‡Œæ–°å¢äº†ä¸€ä¸ªé˜Ÿåˆ— QCï¼Œç»‘å®šå…³ç³»å¦‚ä¸‹ï¼Œè¯¥é˜Ÿåˆ—ä¸è®¾ç½® TTL æ—¶é—´ï¼š</p>
<img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221019134322652.png" alt="image-20221019134322652" style="zoom:80%;">

<h5 id="é…ç½®ç±»-1"><a href="#é…ç½®ç±»-1" class="headerlink" title="é…ç½®ç±»"></a>é…ç½®ç±»</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MsgTtlQueueConfig</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">Y_DEAD_LETTER_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;Y&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_C</span> <span class="operator">=</span> <span class="string">&quot;QC&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">X_EXCHANGE_QUEUE_C_ROUTING_KEY</span> <span class="operator">=</span> <span class="string">&quot;XC&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">Y_DEAD_QUEUE_D_ROUTING_KEY</span> <span class="operator">=</span> <span class="string">&quot;YD&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;queueC&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">queueC</span><span class="params">()</span> &#123;</span><br><span class="line">        HashMap&lt;String, Object&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        params.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, Y_DEAD_LETTER_EXCHANGE);</span><br><span class="line">        params.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, Y_DEAD_QUEUE_D_ROUTING_KEY);</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(QUEUE_C).withArguments(params).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">queuecBindingX</span><span class="params">(<span class="meta">@Qualifier(&quot;queueC&quot;)</span> Queue queue, </span></span><br><span class="line"><span class="params">                                  <span class="meta">@Qualifier(&quot;xExchange&quot;)</span> DirectExchange exchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(X_EXCHANGE_QUEUE_C_ROUTING_KEY);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ç”Ÿäº§è€…ä»£ç "><a href="#ç”Ÿäº§è€…ä»£ç " class="headerlink" title="ç”Ÿäº§è€…ä»£ç "></a>ç”Ÿäº§è€…ä»£ç </h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/sendExpirationMsg/&#123;message&#125;/&#123;ttlTime&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMsg</span><span class="params">(<span class="meta">@PathVariable</span> String message, <span class="meta">@PathVariable</span> String ttlTime)</span> &#123;</span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;X&quot;</span>, <span class="string">&quot;XC&quot;</span>, message, (correlationData) -&gt; &#123;</span><br><span class="line">        correlationData.getMessageProperties().setExpiration(ttlTime);</span><br><span class="line">        <span class="keyword">return</span> correlationData;</span><br><span class="line">    &#125;);</span><br><span class="line">    log.info(<span class="string">&quot;å½“å‰æ—¶é—´ï¼š&#123;&#125;,å‘é€ä¸€æ¡æ—¶é•¿&#123;&#125;æ¯«ç§’ TTL ä¿¡æ¯ç»™é˜Ÿåˆ— C:&#123;&#125;&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>(), ttlTime, message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•ï¼šä¾æ¬¡å‘é€è¯·æ±‚ï¼š</p>
<p><a target="_blank" rel="noopener" href="http://localhost:8080/ttl/sendExpirationMsg/hello/20000">http://localhost:8080/ttl/sendExpirationMsg/hello/20000</a></p>
<p><a target="_blank" rel="noopener" href="http://localhost:8080/ttl/sendExpirationMsg/world/2000">http://localhost:8080/ttl/sendExpirationMsg/world/2000</a></p>
<p><img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221019140141136.png" alt="image-20221019140141136"></p>
<p>é—®é¢˜ï¼šå¦‚æœä½¿ç”¨åœ¨æ¶ˆæ¯å±æ€§ä¸Šè®¾ç½® TTL çš„æ–¹å¼ï¼Œæ¶ˆ æ¯å¯èƒ½å¹¶ä¸ä¼šæŒ‰æ—¶ â€œæ­»äº¡â€œï¼Œå› ä¸º RabbitMQ åªä¼šæ£€æŸ¥ç¬¬ä¸€ä¸ªæ¶ˆæ¯æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸåˆ™ä¸¢åˆ°æ­»ä¿¡é˜Ÿåˆ—ï¼Œ å¦‚æœç¬¬ä¸€ä¸ªæ¶ˆæ¯çš„å»¶æ—¶æ—¶é•¿å¾ˆé•¿ï¼Œè€Œç¬¬äºŒä¸ªæ¶ˆæ¯çš„å»¶æ—¶æ—¶é•¿å¾ˆçŸ­ï¼Œç¬¬äºŒä¸ªæ¶ˆæ¯å¹¶ä¸ä¼šä¼˜å…ˆå¾—åˆ°æ‰§è¡Œã€‚</p>
<h4 id="Rabbitmq-æ’ä»¶å®ç°å»¶è¿Ÿé˜Ÿåˆ—"><a href="#Rabbitmq-æ’ä»¶å®ç°å»¶è¿Ÿé˜Ÿåˆ—" class="headerlink" title="Rabbitmq æ’ä»¶å®ç°å»¶è¿Ÿé˜Ÿåˆ—"></a>Rabbitmq æ’ä»¶å®ç°å»¶è¿Ÿé˜Ÿåˆ—</h4><p>â€‹		å¦‚æœä¸èƒ½å®ç°åœ¨æ¶ˆæ¯ç²’åº¦ä¸Šçš„ TTLï¼Œå¹¶ä½¿å…¶åœ¨è®¾ç½®çš„ TTL æ—¶é—´åŠæ—¶æ­»äº¡ï¼Œå°±æ— æ³•è®¾è®¡æˆä¸€ä¸ªé€šç”¨çš„å»¶æ—¶é˜Ÿåˆ—ã€‚é‚£å¦‚ä½•è§£å†³å‘¢ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å»è§£å†³è¯¥é—®é¢˜ã€‚</p>
<h5 id="å®‰è£…å»¶æ—¶é˜Ÿåˆ—æ’ä»¶"><a href="#å®‰è£…å»¶æ—¶é˜Ÿåˆ—æ’ä»¶" class="headerlink" title="å®‰è£…å»¶æ—¶é˜Ÿåˆ—æ’ä»¶"></a>å®‰è£…å»¶æ—¶é˜Ÿåˆ—æ’ä»¶</h5><blockquote>
<p>å®˜ç½‘ä¸‹è½½ rabbitmq_delayed_message_exchange æ’ä»¶</p>
<p>åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/community-plugins.html">https://www.rabbitmq.com/community-plugins.html</a></p>
<p>è§£å‹æ”¾ç½®åˆ° RabbitMQ çš„æ’ä»¶ç›®å½•ã€‚ </p>
<p>è¿›å…¥ RabbitMQ çš„å®‰è£…ç›®å½•ä¸‹çš„ plgins ç›®å½•ï¼Œæ‰§è¡Œä¸‹é¢å‘½ä»¤è®©è¯¥æ’ä»¶ç”Ÿæ•ˆï¼Œç„¶åé‡å¯ RabbitMQã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/lib/rabbitmq/lib/rabbitmq_server-3.8.8/plugins</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å°†ä¸‹è½½å¥½çš„æ’ä»¶æ”¾åœ¨è¿™ä¸ªç›®å½•,æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œä¸å¸¦ç‰ˆæœ¬å·</span></span><br><span class="line">rabbitmq-plugins enable rabbitmq_delayed_message_exchange</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é‡å¯</span></span><br><span class="line">/sbin/service rabbitmq-server start</span><br></pre></td></tr></table></figure>

<p>æ·»åŠ æ’ä»¶ä¹‹å‰ï¼š</p>
<img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221019141132115.png" alt="image-20221019141132115" style="zoom:80%;">

<p>æ·»åŠ æ’ä»¶ä¹‹åï¼š</p>
<img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221019141640637.png" alt="image-20221019141640637" style="zoom:80%;">
</blockquote>
<h5 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h5><p>â€‹		æ–°å¢ä¸€ä¸ªé˜Ÿåˆ— delayed.queue,ä¸€ä¸ªè‡ªå®šä¹‰äº¤æ¢æœº delayed.exchangeï¼Œç»‘å®šå…³ç³»å¦‚ä¸‹ï¼š</p>
<img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221019141846272.png" alt="image-20221019141846272" style="zoom:80%;">

<p>â€‹		åœ¨æˆ‘ä»¬è‡ªå®šä¹‰çš„äº¤æ¢æœºä¸­ï¼Œè¿™æ˜¯ä¸€ç§æ–°çš„äº¤æ¢ç±»å‹ï¼Œè¯¥ç±»å‹æ¶ˆæ¯æ”¯æŒå»¶è¿ŸæŠ•é€’æœºåˆ¶ï¼Œæ¶ˆæ¯ä¼ é€’åå¹¶ä¸ä¼šç«‹å³æŠ•é€’åˆ°ç›®æ ‡é˜Ÿåˆ—ä¸­ï¼Œè€Œæ˜¯å­˜å‚¨åœ¨ mnesiaï¼ˆä¸€ä¸ªåˆ†å¸ƒå¼æ•°æ®ç³»ç»Ÿï¼‰è¡¨ä¸­ï¼Œå½“è¾¾åˆ°æŠ•é€’æ—¶é—´æ—¶ï¼Œæ‰æŠ•é€’åˆ°ç›®æ ‡é˜Ÿåˆ—ä¸­ã€‚</p>
<h5 id="é…ç½®ç±»-2"><a href="#é…ç½®ç±»-2" class="headerlink" title="é…ç½®ç±»"></a>é…ç½®ç±»</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelayedQueueConfig</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DELAYED_QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;delayed.queue&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DELAYED_EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;delayed.exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DELAYED_ROUTING_KEY</span> <span class="operator">=</span> <span class="string">&quot;delayed.routingkey&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">delayedQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(DELAYED_QUEUE_NAME);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CustomExchange <span class="title function_">delayedExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        args.put(<span class="string">&quot;x-delayed-type&quot;</span>, <span class="string">&quot;direct&quot;</span>);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * å»¶è¿Ÿäº¤æ¢æœºåç§°</span></span><br><span class="line"><span class="comment">         * äº¤æ¢æœºç±»å‹</span></span><br><span class="line"><span class="comment">         * æŒä¹…åŒ–</span></span><br><span class="line"><span class="comment">         * è‡ªåŠ¨åˆ é™¤</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomExchange</span>(DELAYED_EXCHANGE_NAME, <span class="string">&quot;x-delayed-message&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingDelayedQueue</span><span class="params">(<span class="meta">@Qualifier(&quot;delayedQueue&quot;)</span> Queue queue,</span></span><br><span class="line"><span class="params">                                       <span class="meta">@Qualifier(&quot;delayedExchange&quot;)</span> CustomExchange delayedExchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(delayedExchange).with(DELAYED_ROUTING_KEY).noargs();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ç”Ÿäº§è€…-1"><a href="#ç”Ÿäº§è€…-1" class="headerlink" title="ç”Ÿäº§è€…"></a>ç”Ÿäº§è€…</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/sendDelayedMsg/&#123;message&#125;/&#123;ttlTime&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendDelayedMsg</span><span class="params">(<span class="meta">@PathVariable</span> String message, <span class="meta">@PathVariable</span> String ttlTime)</span> &#123;</span><br><span class="line">    rabbitTemplate.convertAndSend(DELAYED_EXCHANGE_NAME, DELAYED_ROUTING_KEY, message, correlationData -&gt; &#123;</span><br><span class="line">        correlationData.getMessageProperties().setExpiration(ttlTime);</span><br><span class="line">        <span class="keyword">return</span> correlationData;</span><br><span class="line">    &#125;);</span><br><span class="line">    log.info(<span class="string">&quot;å½“ å‰ æ—¶ é—´ ï¼š &#123;&#125;, å‘é€ä¸€æ¡å»¶è¿Ÿ &#123;&#125; æ¯«ç§’çš„ä¿¡æ¯ç»™é˜Ÿåˆ— delayed.queue:&#123;&#125;&quot;</span>, <span class="keyword">new</span></span><br><span class="line">             <span class="title class_">Date</span>().toString(), ttlTime, message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="æ¶ˆè´¹è€…-1"><a href="#æ¶ˆè´¹è€…-1" class="headerlink" title="æ¶ˆè´¹è€…"></a>æ¶ˆè´¹è€…</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DELAYED_QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;delayed.queue&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(queues = &#123;DELAYED_QUEUE_NAME&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveDelayedQueue</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody());</span><br><span class="line">    log.info(<span class="string">&quot;å½“å‰æ—¶é—´ï¼š&#123;&#125;ï¼Œæ”¶åˆ°å»¶æ—¶é˜Ÿåˆ—çš„æ¶ˆæ¯ï¼š&#123;&#125;&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>().toString(), msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•ï¼šä¾æ¬¡å‘é€è¯·æ±‚ï¼š</p>
<p><a target="_blank" rel="noopener" href="http://localhost:8080/ttl/sendDelayedMsg/Hello/20000">http://localhost:8080/ttl/sendDelayedMsg/Hello/20000</a></p>
<p><a target="_blank" rel="noopener" href="http://localhost:8080/ttl/sendDelayedMsg/world/2000">http://localhost:8080/ttl/sendDelayedMsg/world/2000</a></p>
<p><img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221019144719606.png" alt="image-20221019144719606"></p>
<p>ç¬¬äºŒä¸ªæ¶ˆæ¯è¢«å…ˆæ¶ˆè´¹æ‰äº†ï¼Œç¬¦åˆé¢„æœŸ</p>
<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><blockquote>
<p>å»¶æ—¶é˜Ÿåˆ—åœ¨éœ€è¦å»¶æ—¶å¤„ç†çš„åœºæ™¯ä¸‹éå¸¸æœ‰ç”¨ï¼Œä½¿ç”¨ RabbitMQ æ¥å®ç°å»¶æ—¶é˜Ÿåˆ—å¯ä»¥å¾ˆå¥½çš„åˆ©ç”¨ RabbitMQ çš„ç‰¹æ€§ï¼Œå¦‚ï¼šæ¶ˆæ¯å¯é å‘é€ã€æ¶ˆæ¯å¯é æŠ•é€’ã€æ­»ä¿¡é˜Ÿåˆ—æ¥ä¿éšœæ¶ˆæ¯è‡³å°‘è¢«æ¶ˆè´¹ä¸€æ¬¡ä»¥åŠæœªè¢«æ­£ç¡®å¤„ç†çš„æ¶ˆæ¯ä¸ä¼šè¢«ä¸¢å¼ƒã€‚</p>
<p>å¦å¤–ï¼Œé€šè¿‡ RabbitMQ é›†ç¾¤çš„ç‰¹æ€§ï¼Œå¯ä»¥å¾ˆå¥½çš„è§£å†³å•ç‚¹æ•…éšœé—®é¢˜ï¼Œä¸ä¼šå› ä¸ºå•ä¸ªèŠ‚ç‚¹æŒ‚æ‰å¯¼è‡´å»¶æ—¶é˜Ÿåˆ—ä¸å¯ç”¨æˆ–è€…æ¶ˆæ¯ä¸¢å¤±ã€‚ å½“ç„¶ï¼Œå»¶æ—¶é˜Ÿåˆ—è¿˜æœ‰å¾ˆå¤šå…¶å®ƒé€‰æ‹©ï¼Œæ¯”å¦‚åˆ©ç”¨ Java çš„ DelayQueueï¼Œåˆ©ç”¨ Redis çš„ zsetï¼Œåˆ©ç”¨ Quartz æˆ–è€…åˆ©ç”¨ kafka çš„æ—¶é—´è½®ï¼Œè¿™äº›æ–¹å¼å„æœ‰ç‰¹ç‚¹,çœ‹éœ€è¦é€‚ç”¨çš„åœºæ™¯ã€‚</p>
</blockquote>
<h2 id="å‘å¸ƒç¡®è®¤é«˜çº§"><a href="#å‘å¸ƒç¡®è®¤é«˜çº§" class="headerlink" title="å‘å¸ƒç¡®è®¤é«˜çº§"></a>å‘å¸ƒç¡®è®¤é«˜çº§</h2><blockquote>
<p>â€‹		åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç”±äºä¸€äº›ä¸æ˜åŸå› ï¼Œå¯¼è‡´ rabbitmq é‡å¯ï¼Œåœ¨ RabbitMQ é‡å¯æœŸé—´ç”Ÿäº§è€…æ¶ˆæ¯æŠ•é€’å¤±è´¥ï¼Œ å¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†å’Œæ¢å¤ã€‚äºæ˜¯ï¼Œæˆ‘ä»¬å¼€å§‹æ€è€ƒï¼Œå¦‚ä½•æ‰èƒ½è¿›è¡Œ RabbitMQ çš„æ¶ˆæ¯å¯é æŠ•é€’å‘¢ï¼Ÿ ç‰¹åˆ«æ˜¯åœ¨è¿™æ ·æ¯”è¾ƒæç«¯çš„æƒ…å†µï¼ŒRabbitMQ é›†ç¾¤ä¸å¯ç”¨çš„æ—¶å€™ï¼Œæ— æ³•æŠ•é€’çš„æ¶ˆæ¯è¯¥å¦‚ä½•å¤„ç†ï¼Ÿ</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">åº” ç”¨ [xxx] åœ¨ [08-1516:36:04] å‘ ç”Ÿ [ é”™è¯¯æ—¥å¿—å¼‚å¸¸ ] ï¼Œ alertId=[xxx] ã€‚ ç”±</span><br><span class="line">[org.springframework.amqp.rabbit.listener.BlockingQueueConsumer:start:620] è§¦å‘ã€‚</span><br><span class="line">åº”ç”¨ xxx å¯èƒ½åŸå› å¦‚ä¸‹</span><br><span class="line">æœåŠ¡åä¸ºï¼š</span><br><span class="line">å¼‚å¸¸ä¸ºï¼š org.springframework.amqp.rabbit.listener.BlockingQueueConsumer:start:620,</span><br><span class="line">äº§ ç”Ÿ åŸ å›  å¦‚ ä¸‹ :1.org.springframework.amqp.rabbit.listener.QueuesNotAvailableException:</span><br><span class="line">Cannot prepare queue for listener. Either the queue doesn&#x27;t exist or the broker will not</span><br><span class="line">allow us to use it.||Consumer received fatal=false exception on startup:</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="å‘å¸ƒç¡®è®¤-springboot-ç‰ˆ"><a href="#å‘å¸ƒç¡®è®¤-springboot-ç‰ˆ" class="headerlink" title="å‘å¸ƒç¡®è®¤ springboot ç‰ˆ"></a>å‘å¸ƒç¡®è®¤ springboot ç‰ˆ</h3><h4 id="ç¡®è®¤æœºåˆ¶æ–¹æ¡ˆ"><a href="#ç¡®è®¤æœºåˆ¶æ–¹æ¡ˆ" class="headerlink" title="ç¡®è®¤æœºåˆ¶æ–¹æ¡ˆ"></a>ç¡®è®¤æœºåˆ¶æ–¹æ¡ˆ</h4><img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221019145017768.png" alt="image-20221019145017768" style="zoom:80%;">

<p><strong>ç¤ºä¾‹ï¼š</strong></p>
<img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221019145045146.png" alt="image-20221019145045146" style="zoom:80%;">

<h5 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h5><p>åœ¨é…ç½®æ–‡ä»¶å½“ä¸­éœ€è¦æ·»åŠ  <strong>spring.rabbitmq.publisher-confirm-type&#x3D;correlated</strong></p>
<blockquote>
<ul>
<li>NONE ç¦ç”¨å‘å¸ƒç¡®è®¤æ¨¡å¼ï¼Œæ˜¯é»˜è®¤å€¼</li>
<li>CORRELATED å‘å¸ƒæ¶ˆæ¯æˆåŠŸåˆ°äº¤æ¢å™¨åä¼šè§¦å‘å›è°ƒæ–¹æ³•</li>
<li>SIMPLE</li>
</ul>
<p>ç»æµ‹è¯•æœ‰ä¸¤ç§æ•ˆæœï¼Œå…¶ä¸€æ•ˆæœå’Œ CORRELATED å€¼ä¸€æ ·ä¼šè§¦å‘å›è°ƒæ–¹æ³•ï¼Œ å…¶äºŒåœ¨å‘å¸ƒæ¶ˆæ¯æˆåŠŸåä½¿ç”¨ rabbitTemplate è°ƒç”¨ waitForConfirms æˆ– waitForConfirmsOrDie æ–¹æ³• ç­‰å¾… broker èŠ‚ç‚¹è¿”å›å‘é€ç»“æœï¼Œæ ¹æ®è¿”å›ç»“æœæ¥åˆ¤å®šä¸‹ä¸€æ­¥çš„é€»è¾‘ï¼Œè¦æ³¨æ„çš„ç‚¹æ˜¯ waitForConfirmsOrDie æ–¹æ³•å¦‚æœè¿”å› false åˆ™ä¼šå…³é—­ channelï¼Œåˆ™æ¥ä¸‹æ¥æ— æ³•å‘é€æ¶ˆæ¯åˆ° brokerã€‚</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.rabbitmq.host</span>=<span class="string">192.168.100.100</span></span><br><span class="line"><span class="attr">spring.rabbitmq.port</span>=<span class="string">5672</span></span><br><span class="line"><span class="attr">spring.rabbitmq.username</span>=<span class="string">admin</span></span><br><span class="line"><span class="attr">spring.rabbitmq.password</span>=<span class="string">admin</span></span><br><span class="line"><span class="attr">spring.rabbitmq.publisher-confirm-type</span>=<span class="string">correlated</span></span><br></pre></td></tr></table></figure>
</blockquote>
<h5 id="é…ç½®ç±»-3"><a href="#é…ç½®ç±»-3" class="headerlink" title="é…ç½®ç±»"></a>é…ç½®ç±»</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfirmConfig</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONFIRM_EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;confirm.exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONFIRM_QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;confirm.queue&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;confirmExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">confirmExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(CONFIRM_EXCHANGE_NAME);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;confirmQueue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">confirmQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(CONFIRM_QUEUE_NAME).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">queueBinding</span><span class="params">(<span class="meta">@Qualifier(&quot;confirmQueue&quot;)</span> Queue queue,</span></span><br><span class="line"><span class="params">                                <span class="meta">@Qualifier(&quot;confirmExchange&quot;)</span> DirectExchange exchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="string">&quot;key1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="å›è°ƒæ¥å£"><a href="#å›è°ƒæ¥å£" class="headerlink" title="å›è°ƒæ¥å£"></a>å›è°ƒæ¥å£</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.rabbitmq.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.CorrelationData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyCallBack</span> <span class="keyword">implements</span> <span class="title class_">RabbitTemplate</span>.ConfirmCallback &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ³¨æ„éœ€è¦è®¾ç½® RabbitTemplate.ConfirmCallback çš„å€¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        rabbitTemplate.setConfirmCallback(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">confirm</span><span class="params">(CorrelationData correlationData, <span class="type">boolean</span> ack, String cause)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> correlationData != <span class="literal">null</span> ? correlationData.getId() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (ack) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;äº¤æ¢æœºå·²ç»æ”¶åˆ° id ä¸º:&#123;&#125;çš„æ¶ˆæ¯&quot;</span>, id);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;äº¤æ¢æœºè¿˜æœªæ”¶åˆ° id ä¸º:&#123;&#125;æ¶ˆæ¯,ç”±äºåŸå› :&#123;&#125;&quot;</span>, id, cause);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ç”Ÿäº§è€…-2"><a href="#ç”Ÿäº§è€…-2" class="headerlink" title="ç”Ÿäº§è€…"></a>ç”Ÿäº§è€…</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/confirm&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProduceController</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONFIRM_EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;confirm.exchange&quot;</span>;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;sendMessage/&#123;message&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(<span class="meta">@PathVariable</span> String message)</span> &#123;</span><br><span class="line">        <span class="comment">//æŒ‡å®šæ¶ˆæ¯ id ä¸º 1</span></span><br><span class="line">        <span class="type">CorrelationData</span> <span class="variable">correlationData1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorrelationData</span>(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">routingKey</span> <span class="operator">=</span> <span class="string">&quot;key1&quot;</span>;</span><br><span class="line"></span><br><span class="line">        rabbitTemplate.convertAndSend(CONFIRM_EXCHANGE_NAME, routingKey, message + routingKey, correlationData1);</span><br><span class="line">        <span class="type">CorrelationData</span> <span class="variable">correlationData2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorrelationData</span>(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">        routingKey = <span class="string">&quot;key2&quot;</span>;</span><br><span class="line"></span><br><span class="line">        rabbitTemplate.convertAndSend(CONFIRM_EXCHANGE_NAME, routingKey, message + routingKey, correlationData2);</span><br><span class="line">        log.info(<span class="string">&quot;å‘é€æ¶ˆæ¯å†…å®¹:&#123;&#125;&quot;</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="æ¶ˆè´¹è€…-2"><a href="#æ¶ˆè´¹è€…-2" class="headerlink" title="æ¶ˆè´¹è€…"></a>æ¶ˆè´¹è€…</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfirmConsumer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONFIRM_QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;confirm.queue&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = CONFIRM_QUEUE_NAME)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveMsg</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody());</span><br><span class="line">        log.info(<span class="string">&quot;æ¥å—åˆ°é˜Ÿåˆ— confirm.queue æ¶ˆæ¯:&#123;&#125;&quot;</span>, msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•ï¼š<a target="_blank" rel="noopener" href="http://localhost:8080/confirm/sendMessage/HelloWorld">http://localhost:8080/confirm/sendMessage/HelloWorld</a></p>
<img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221019170646211.png" alt="image-20221019170646211" style="zoom:80%;">

<p>â€‹		å¯ä»¥çœ‹åˆ°ï¼Œå‘é€äº†ä¸¤æ¡æ¶ˆæ¯ï¼Œç¬¬ä¸€æ¡æ¶ˆæ¯çš„ RoutingKey ä¸º â€œkey1â€ï¼Œç¬¬äºŒæ¡æ¶ˆæ¯çš„ RoutingKey ä¸º â€œkey2â€ï¼Œä¸¤æ¡æ¶ˆæ¯éƒ½æˆåŠŸè¢«äº¤æ¢æœºæ¥æ”¶ï¼Œä¹Ÿæ”¶åˆ°äº†äº¤æ¢æœºçš„ç¡®è®¤å›è°ƒï¼Œä½†æ¶ˆè´¹è€…åªæ”¶åˆ°äº†ä¸€æ¡æ¶ˆæ¯ï¼Œå› ä¸º ç¬¬äºŒæ¡æ¶ˆæ¯çš„ RoutingKey ä¸é˜Ÿåˆ—çš„ BindingKey ä¸ä¸€è‡´ï¼Œä¹Ÿæ²¡æœ‰å…¶å®ƒé˜Ÿåˆ—èƒ½æ¥æ”¶è¿™ä¸ªæ¶ˆæ¯ï¼Œæ‰€æœ‰ç¬¬äºŒæ¡ æ¶ˆæ¯è¢«ç›´æ¥ä¸¢å¼ƒäº†ã€‚</p>
<h4 id="å›é€€æ¶ˆæ¯"><a href="#å›é€€æ¶ˆæ¯" class="headerlink" title="å›é€€æ¶ˆæ¯"></a>å›é€€æ¶ˆæ¯</h4><h5 id="Mandatory-å‚æ•°"><a href="#Mandatory-å‚æ•°" class="headerlink" title="Mandatory å‚æ•°"></a>Mandatory å‚æ•°</h5><blockquote>
<p>â€‹		åœ¨ä»…å¼€å¯äº†ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶çš„æƒ…å†µä¸‹ï¼Œäº¤æ¢æœºæ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œä¼šç›´æ¥ç»™æ¶ˆæ¯ç”Ÿäº§è€…å‘é€ç¡®è®¤æ¶ˆæ¯ï¼Œå¦‚æœå‘ç°è¯¥æ¶ˆæ¯ä¸å¯è·¯ç”±ï¼Œé‚£ä¹ˆæ¶ˆæ¯ä¼šè¢«ç›´æ¥ä¸¢å¼ƒï¼Œæ­¤æ—¶ç”Ÿäº§è€…æ˜¯ä¸çŸ¥é“æ¶ˆæ¯è¢«ä¸¢å¼ƒè¿™ä¸ªäº‹ä»¶çš„ã€‚é‚£ä¹ˆå¦‚ä½• è®©æ— æ³•è¢«è·¯ç”±çš„æ¶ˆæ¯å¸®æˆ‘æƒ³åŠæ³•å¤„ç†ä¸€ä¸‹ï¼Ÿæœ€èµ·ç é€šçŸ¥æˆ‘ä¸€å£°ï¼Œæˆ‘å¥½è‡ªå·±å¤„ç†å•Šã€‚é€šè¿‡è®¾ç½® mandatory å‚ æ•°å¯ä»¥åœ¨å½“æ¶ˆæ¯ä¼ é€’è¿‡ç¨‹ä¸­ä¸å¯è¾¾ç›®çš„åœ°æ—¶å°†æ¶ˆæ¯è¿”å›ç»™ç”Ÿäº§è€…ã€‚</p>
</blockquote>
<h5 id="é…ç½®æ–‡ä»¶-1"><a href="#é…ç½®æ–‡ä»¶-1" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h5><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.rabbitmq.host</span>=<span class="string">192.168.100.100</span></span><br><span class="line"><span class="attr">spring.rabbitmq.port</span>=<span class="string">5672</span></span><br><span class="line"><span class="attr">spring.rabbitmq.username</span>=<span class="string">admin</span></span><br><span class="line"><span class="attr">spring.rabbitmq.password</span>=<span class="string">admin</span></span><br><span class="line"><span class="comment"># å‘å¸ƒç¡®è®¤</span></span><br><span class="line"><span class="attr">spring.rabbitmq.publisher-confirm-type</span>=<span class="string">correlated</span></span><br><span class="line"><span class="comment"># å›é€€ç¡®è®¤</span></span><br><span class="line"><span class="attr">spring.rabbitmq.publisher-returns</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>

<h5 id="ç”Ÿäº§è€…-3"><a href="#ç”Ÿäº§è€…-3" class="headerlink" title="ç”Ÿäº§è€…"></a>ç”Ÿäº§è€…</h5><p>æ–¹å¼ä¸€ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageProducer</span> <span class="keyword">implements</span> <span class="title class_">RabbitTemplate</span>.ConfirmCallback,</span><br><span class="line">RabbitTemplate.ReturnCallback &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//rabbitTemplate æ³¨å…¥ä¹‹åå°±è®¾ç½®è¯¥å€¼</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        rabbitTemplate.setConfirmCallback(<span class="built_in">this</span>);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * trueï¼š</span></span><br><span class="line"><span class="comment">         * äº¤æ¢æœºæ— æ³•å°†æ¶ˆæ¯è¿›è¡Œè·¯ç”±æ—¶ï¼Œä¼šå°†è¯¥æ¶ˆæ¯è¿”å›ç»™ç”Ÿäº§è€…</span></span><br><span class="line"><span class="comment">         * falseï¼š</span></span><br><span class="line"><span class="comment">         * å¦‚æœå‘ç°æ¶ˆæ¯æ— æ³•è¿›è¡Œè·¯ç”±ï¼Œåˆ™ç›´æ¥ä¸¢å¼ƒ</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        rabbitTemplate.setMandatory(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//è®¾ç½®å›é€€æ¶ˆæ¯äº¤ç»™è°å¤„ç†</span></span><br><span class="line">        rabbitTemplate.setReturnCallback(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;sendMessage&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        <span class="comment">//è®©æ¶ˆæ¯ç»‘å®šä¸€ä¸ª id å€¼</span></span><br><span class="line">        <span class="type">CorrelationData</span> <span class="variable">correlationData1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorrelationData</span>(UUID.randomUUID().toString());</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;confirm.exchange&quot;</span>, <span class="string">&quot;key1&quot;</span>, message + <span class="string">&quot;key1&quot;</span>, correlationData1)</span><br><span class="line">        ;</span><br><span class="line">        log.info(<span class="string">&quot;å‘é€æ¶ˆæ¯ id ä¸º:&#123;&#125;å†…å®¹ä¸º&#123;&#125;&quot;</span>, correlationData1.getId(), message + <span class="string">&quot;key1&quot;</span>);</span><br><span class="line">        <span class="type">CorrelationData</span> <span class="variable">correlationData2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorrelationData</span>(UUID.randomUUID().toString());</span><br><span class="line"></span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;confirm.exchange&quot;</span>, <span class="string">&quot;key2&quot;</span>, message + <span class="string">&quot;key2&quot;</span>, correlationData2)</span><br><span class="line">        ;</span><br><span class="line">        log.info(<span class="string">&quot;å‘é€æ¶ˆæ¯ id ä¸º:&#123;&#125;å†…å®¹ä¸º&#123;&#125;&quot;</span>, correlationData2.getId(), message + <span class="string">&quot;key2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">confirm</span><span class="params">(CorrelationData correlationData, <span class="type">boolean</span> ack, String cause)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> correlationData != <span class="literal">null</span> ? correlationData.getId() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (ack) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;äº¤æ¢æœºæ”¶åˆ°æ¶ˆæ¯ç¡®è®¤æˆåŠŸ, id:&#123;&#125;&quot;</span>, id);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.error(<span class="string">&quot;æ¶ˆæ¯ id:&#123;&#125;æœªæˆåŠŸæŠ•é€’åˆ°äº¤æ¢æœº,åŸå› æ˜¯:&#123;&#125;&quot;</span>, id, cause);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">returnedMessage</span><span class="params">(Message message, <span class="type">int</span> replyCode, String replyText, String</span></span><br><span class="line"><span class="params">            exchange, String routingKey)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;æ¶ˆæ¯:&#123;&#125;è¢«æœåŠ¡å™¨é€€å›ï¼Œé€€å›åŸå› :&#123;&#125;, äº¤æ¢æœºæ˜¯:&#123;&#125;, è·¯ç”± key:&#123;&#125;&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()), replyText, exchange, routingKey);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ–¹å¼äºŒï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyCallBack</span> <span class="keyword">implements</span> <span class="title class_">RabbitTemplate</span>.ConfirmCallback, RabbitTemplate.ReturnsCallback &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ³¨æ„éœ€è¦è®¾ç½® RabbitTemplate.ConfirmCallback çš„å€¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        rabbitTemplate.setConfirmCallback(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">confirm</span><span class="params">(CorrelationData correlationData, <span class="type">boolean</span> ack, String cause)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> correlationData != <span class="literal">null</span> ? correlationData.getId() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (ack) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;äº¤æ¢æœºå·²ç»æ”¶åˆ° id ä¸º:&#123;&#125;çš„æ¶ˆæ¯&quot;</span>, id);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;äº¤æ¢æœºè¿˜æœªæ”¶åˆ° id ä¸º:&#123;&#125;æ¶ˆæ¯,ç”±äºåŸå› :&#123;&#125;&quot;</span>, id, cause);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">returnedMessage</span><span class="params">(ReturnedMessage returned)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;æ¶ˆæ¯:&#123;&#125;è¢«æœåŠ¡å™¨é€€å›ï¼Œé€€å›åŸå› :&#123;&#125;, äº¤æ¢æœºæ˜¯:&#123;&#125;, è·¯ç”± key:&#123;&#125;&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">String</span>(returned.getMessage().getBody()), returned.getReplyText(), </span><br><span class="line">                 returned.getExchange(), returned.getRoutingKey());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•ï¼š<a target="_blank" rel="noopener" href="http://localhost:8080/confirm/sendMessage02?message=demo">http://localhost:8080/confirm/sendMessage02?message=demo</a></p>
<img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221019172228728.png" alt="image-20221019172228728" style="zoom:67%;">

<h4 id="å¤‡ä»½äº¤æ¢æœº"><a href="#å¤‡ä»½äº¤æ¢æœº" class="headerlink" title="å¤‡ä»½äº¤æ¢æœº"></a>å¤‡ä»½äº¤æ¢æœº</h4><blockquote>
<p>æœ‰äº† mandatory å‚æ•°å’Œå›é€€æ¶ˆæ¯ï¼Œæˆ‘ä»¬è·å¾—äº†å¯¹æ— æ³•æŠ•é€’æ¶ˆæ¯çš„æ„ŸçŸ¥èƒ½åŠ›ï¼Œæœ‰æœºä¼šåœ¨ç”Ÿäº§è€…çš„æ¶ˆæ¯æ— æ³•è¢«æŠ•é€’æ—¶å‘ç°å¹¶å¤„ç†ã€‚ä½†æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬å¹¶ä¸çŸ¥é“è¯¥å¦‚ä½•å¤„ç†è¿™äº›æ— æ³•è·¯ç”±çš„æ¶ˆæ¯ï¼Œæœ€å¤šæ‰“ä¸ªæ—¥å¿—ï¼Œç„¶åè§¦å‘æŠ¥è­¦ï¼Œå†æ¥æ‰‹åŠ¨å¤„ç†ã€‚è€Œé€šè¿‡æ—¥å¿—æ¥å¤„ç†è¿™äº›æ— æ³•è·¯ç”±çš„æ¶ˆæ¯æ˜¯å¾ˆä¸ä¼˜é›…çš„åšæ³•ï¼Œç‰¹åˆ«æ˜¯å½“ç”Ÿäº§è€…æ‰€åœ¨çš„æœåŠ¡æœ‰å¤šå°æœºå™¨çš„æ—¶å€™ï¼Œæ‰‹åŠ¨å¤åˆ¶æ—¥å¿—ä¼šæ›´åŠ éº»çƒ¦è€Œä¸”å®¹æ˜“å‡ºé”™ã€‚è€Œä¸”è®¾ç½® mandatory å‚æ•°ä¼šå¢ åŠ ç”Ÿäº§è€…çš„å¤æ‚æ€§ï¼Œéœ€è¦æ·»åŠ å¤„ç†è¿™äº›è¢«é€€å›çš„æ¶ˆæ¯çš„é€»è¾‘ã€‚å¦‚æœæ—¢ä¸æƒ³ä¸¢å¤±æ¶ˆæ¯ï¼Œåˆä¸æƒ³å¢åŠ ç”Ÿäº§è€…çš„ å¤æ‚æ€§ï¼Œè¯¥æ€ä¹ˆåšå‘¢ï¼Ÿå‰é¢åœ¨è®¾ç½®æ­»ä¿¡é˜Ÿåˆ—çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬æåˆ°ï¼Œå¯ä»¥ä¸ºé˜Ÿåˆ—è®¾ç½®æ­»ä¿¡äº¤æ¢æœºæ¥å­˜å‚¨é‚£äº›å¤„ç†å¤±è´¥çš„æ¶ˆæ¯ï¼Œå¯æ˜¯è¿™äº›ä¸å¯è·¯ç”±æ¶ˆæ¯æ ¹æœ¬æ²¡æœ‰æœºä¼šè¿›å…¥åˆ°é˜Ÿåˆ—ï¼Œå› æ­¤æ— æ³•ä½¿ç”¨æ­»ä¿¡é˜Ÿåˆ—æ¥ä¿å­˜æ¶ˆæ¯ã€‚ </p>
<p>åœ¨ RabbitMQ ä¸­ï¼Œæœ‰ä¸€ç§å¤‡ä»½äº¤æ¢æœºçš„æœºåˆ¶å­˜åœ¨ï¼Œå¯ä»¥å¾ˆå¥½çš„åº”å¯¹è¿™ä¸ªé—®é¢˜ã€‚ä»€ä¹ˆæ˜¯å¤‡ä»½äº¤æ¢æœºå‘¢ï¼Ÿå¤‡ä»½äº¤æ¢æœºå¯ä»¥ç†è§£ä¸º RabbitMQ ä¸­äº¤æ¢æœºçš„â€œå¤‡èƒâ€ï¼Œå½“æˆ‘ä»¬ä¸ºæŸä¸€ä¸ªäº¤æ¢æœºå£°æ˜ä¸€ä¸ªå¯¹åº”çš„å¤‡ä»½äº¤æ¢æœºæ—¶ï¼Œ å°±æ˜¯ä¸ºå®ƒåˆ›å»ºä¸€ä¸ªå¤‡èƒï¼Œ<strong>å½“äº¤æ¢æœºæ¥æ”¶åˆ°ä¸€æ¡ä¸å¯è·¯ç”±æ¶ˆæ¯æ—¶ï¼Œå°†ä¼šæŠŠè¿™æ¡æ¶ˆæ¯è½¬å‘åˆ°å¤‡ä»½äº¤æ¢æœºä¸­ï¼Œç”±å¤‡ä»½äº¤æ¢æœºæ¥è¿›è¡Œè½¬å‘å’Œå¤„ç†ï¼Œé€šå¸¸å¤‡ä»½äº¤æ¢æœºçš„ç±»å‹ä¸º Fanout ï¼Œè¿™æ ·å°±èƒ½æŠŠæ‰€æœ‰æ¶ˆæ¯éƒ½æŠ•é€’åˆ°ä¸å…¶ç»‘å®šçš„é˜Ÿåˆ—ä¸­ï¼Œç„¶åæˆ‘ä»¬åœ¨å¤‡ä»½äº¤æ¢æœºä¸‹ç»‘å®šä¸€ä¸ªé˜Ÿåˆ—ï¼Œè¿™æ ·æ‰€æœ‰é‚£äº›åŸäº¤æ¢æœºæ— æ³•è¢«è·¯ç”±çš„æ¶ˆæ¯ï¼Œå°±ä¼šéƒ½è¿›å…¥è¿™ä¸ªé˜Ÿåˆ—äº†ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å»ºç«‹ä¸€ä¸ªæŠ¥è­¦é˜Ÿåˆ—ï¼Œç”¨ç‹¬ç«‹çš„æ¶ˆè´¹è€…æ¥è¿›è¡Œç›‘æµ‹å’ŒæŠ¥è­¦ã€‚</strong></p>
</blockquote>
<h5 id="åº”ç”¨ç¤ºä¾‹"><a href="#åº”ç”¨ç¤ºä¾‹" class="headerlink" title="åº”ç”¨ç¤ºä¾‹"></a>åº”ç”¨ç¤ºä¾‹</h5><img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221019172602687.png" alt="image-20221019172602687" style="zoom:80%;">

<h5 id="é…ç½®ç±»-4"><a href="#é…ç½®ç±»-4" class="headerlink" title="é…ç½®ç±»"></a>é…ç½®ç±»</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfirmConfig</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONFIRM_EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;confirm.exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONFIRM_QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;confirm.queue&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BACKUP_EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;backup.exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BACKUP_QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;backup.queue&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">WARNING_QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;warning.queue&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å£°æ˜ç¡®è®¤é˜Ÿåˆ—</span></span><br><span class="line">    <span class="meta">@Bean(&quot;confirmQueue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">confirmQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(CONFIRM_QUEUE_NAME).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å£°æ˜ç¡®è®¤é˜Ÿåˆ—ç»‘å®šå…³ç³»</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">queueBinding</span><span class="params">(<span class="meta">@Qualifier(&quot;confirmQueue&quot;)</span> Queue queue,</span></span><br><span class="line"><span class="params">                                <span class="meta">@Qualifier(&quot;confirmExchange&quot;)</span> DirectExchange exchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="string">&quot;key1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å£°æ˜å¤‡ä»½ Exchange</span></span><br><span class="line">    <span class="meta">@Bean(&quot;backupExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> FanoutExchange <span class="title function_">backupExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FanoutExchange</span>(BACKUP_EXCHANGE_NAME);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å£°æ˜ç¡®è®¤ Exchange äº¤æ¢æœºçš„å¤‡ä»½äº¤æ¢æœº</span></span><br><span class="line">    <span class="meta">@Bean(&quot;confirmExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">confirmExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ExchangeBuilder</span> <span class="variable">exchangeBuilder</span> <span class="operator">=</span></span><br><span class="line">                ExchangeBuilder.directExchange(CONFIRM_EXCHANGE_NAME)</span><br><span class="line">                        .durable(<span class="literal">true</span>)</span><br><span class="line">                        <span class="comment">//è®¾ç½®è¯¥äº¤æ¢æœºçš„å¤‡ä»½äº¤æ¢æœº</span></span><br><span class="line">                        .withArgument(<span class="string">&quot;alternate-exchange&quot;</span>, BACKUP_EXCHANGE_NAME);</span><br><span class="line">        <span class="keyword">return</span> (DirectExchange) exchangeBuilder.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å£°æ˜è­¦å‘Šé˜Ÿåˆ—</span></span><br><span class="line">    <span class="meta">@Bean(&quot;warningQueue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">warningQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(WARNING_QUEUE_NAME).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å£°æ˜æŠ¥è­¦é˜Ÿåˆ—ç»‘å®šå…³ç³»</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">warningBinding</span><span class="params">(<span class="meta">@Qualifier(&quot;warningQueue&quot;)</span> Queue queue,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@Qualifier(&quot;backupExchange&quot;)</span> FanoutExchange</span></span><br><span class="line"><span class="params">                                          backupExchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(backupExchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å£°æ˜å¤‡ä»½é˜Ÿåˆ—</span></span><br><span class="line">    <span class="meta">@Bean(&quot;backQueue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">backQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(BACKUP_QUEUE_NAME).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å£°æ˜å¤‡ä»½é˜Ÿåˆ—ç»‘å®šå…³ç³»</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">backupBinding</span><span class="params">(<span class="meta">@Qualifier(&quot;backQueue&quot;)</span> Queue queue,</span></span><br><span class="line"><span class="params">                                 <span class="meta">@Qualifier(&quot;backupExchange&quot;)</span> FanoutExchange backupExchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(backupExchange);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="æŠ¥è­¦æ¶ˆè´¹è€…"><a href="#æŠ¥è­¦æ¶ˆè´¹è€…" class="headerlink" title="æŠ¥è­¦æ¶ˆè´¹è€…"></a>æŠ¥è­¦æ¶ˆè´¹è€…</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WarningConsumer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">WARNING_QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;warning.queue&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = WARNING_QUEUE_NAME)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveWarningMsg</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody());</span><br><span class="line">        log.error(<span class="string">&quot;æŠ¥è­¦å‘ç°ä¸å¯è·¯ç”±æ¶ˆæ¯ï¼š&#123;&#125;&quot;</span>, msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h5><p>æ³¨æ„ï¼šæ—¶å€™éœ€è¦æŠŠåŸæ¥çš„ confirm.exchange åˆ é™¤å› ä¸ºæˆ‘ä»¬ä¿®æ”¹äº†å…¶ç»‘å®šå±æ€§ï¼Œä¸ç„¶æŠ¥é”™ã€‚</p>
<img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221019173231358.png" alt="image-20221019173231358" style="zoom:80%;">

<p>â€‹		mandatory å‚æ•°ä¸å¤‡ä»½äº¤æ¢æœºå¯ä»¥ä¸€èµ·ä½¿ç”¨çš„æ—¶å€™ï¼Œå¦‚æœä¸¤è€…åŒæ—¶å¼€å¯ï¼Œæ¶ˆæ¯ç©¶ç«Ÿä½•å»ä½•ä»ï¼Ÿè°ä¼˜å…ˆçº§é«˜ï¼Œç»è¿‡ä¸Šé¢ç»“æœæ˜¾ç¤ºç­”æ¡ˆæ˜¯å¤‡ä»½äº¤æ¢æœºä¼˜å…ˆçº§é«˜ã€‚</p>
<h3 id="RabbitMQ-ç›¸å…³å«ä¹‰"><a href="#RabbitMQ-ç›¸å…³å«ä¹‰" class="headerlink" title="RabbitMQ ç›¸å…³å«ä¹‰"></a>RabbitMQ ç›¸å…³å«ä¹‰</h3><h4 id="å¹‚ç­‰æ€§"><a href="#å¹‚ç­‰æ€§" class="headerlink" title="å¹‚ç­‰æ€§"></a>å¹‚ç­‰æ€§</h4><blockquote>
<p><strong>æ¦‚å¿µ</strong></p>
<p>â€‹		ç”¨æˆ·å¯¹äºåŒä¸€æ“ä½œå‘èµ·çš„ä¸€æ¬¡è¯·æ±‚æˆ–è€…å¤šæ¬¡è¯·æ±‚çš„ç»“æœæ˜¯ä¸€è‡´çš„ï¼Œä¸ä¼šå› ä¸ºå¤šæ¬¡ç‚¹å‡»è€Œäº§ç”Ÿäº†å‰¯ä½œç”¨ã€‚ ä¸¾ä¸ªæœ€ç®€å•çš„ä¾‹å­ï¼Œé‚£å°±æ˜¯æ”¯ä»˜ï¼Œç”¨æˆ·è´­ä¹°å•†å“åæ”¯ä»˜ï¼Œæ”¯ä»˜æ‰£æ¬¾æˆåŠŸï¼Œä½†æ˜¯è¿”å›ç»“æœçš„æ—¶å€™ç½‘ç»œå¼‚å¸¸ï¼Œ æ­¤æ—¶é’±å·²ç»æ‰£äº†ï¼Œç”¨æˆ·å†æ¬¡ç‚¹å‡»æŒ‰é’®ï¼Œæ­¤æ—¶ä¼šè¿›è¡Œç¬¬äºŒæ¬¡æ‰£æ¬¾ï¼Œè¿”å›ç»“æœæˆåŠŸï¼Œç”¨æˆ·æŸ¥è¯¢ä½™é¢å‘ç°å¤šæ‰£é’± äº†ï¼Œæµæ°´è®°å½•ä¹Ÿå˜æˆäº†ä¸¤æ¡ã€‚åœ¨ä»¥å‰çš„å•åº”ç”¨ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠæ•°æ®æ“ä½œæ”¾å…¥äº‹åŠ¡ä¸­å³å¯ï¼Œå‘ç”Ÿé”™è¯¯ ç«‹å³å›æ»šï¼Œä½†æ˜¯å†å“åº”å®¢æˆ·ç«¯çš„æ—¶å€™ä¹Ÿæœ‰å¯èƒ½å‡ºç°ç½‘ç»œä¸­æ–­æˆ–è€…å¼‚å¸¸ç­‰ã€‚</p>
<p><strong>æ¶ˆæ¯é‡å¤æ¶ˆè´¹</strong></p>
<p>â€‹		æ¶ˆè´¹è€…åœ¨æ¶ˆè´¹ MQ ä¸­çš„æ¶ˆæ¯æ—¶ï¼ŒMQ å·²æŠŠæ¶ˆæ¯å‘é€ç»™æ¶ˆè´¹è€…ï¼Œæ¶ˆè´¹è€…åœ¨ç»™ MQ è¿”å› ack æ—¶ç½‘ç»œä¸­æ–­ï¼Œ æ•… MQ æœªæ”¶åˆ°ç¡®è®¤ä¿¡æ¯ï¼Œè¯¥æ¡æ¶ˆæ¯ä¼šé‡æ–°å‘ç»™å…¶ä»–çš„æ¶ˆè´¹è€…ï¼Œæˆ–è€…åœ¨ç½‘ç»œé‡è¿åå†æ¬¡å‘é€ç»™è¯¥æ¶ˆè´¹è€…ï¼Œä½†å®é™…ä¸Šè¯¥æ¶ˆè´¹è€…å·²æˆåŠŸæ¶ˆè´¹äº†è¯¥æ¡æ¶ˆæ¯ï¼Œé€ æˆæ¶ˆè´¹è€…æ¶ˆè´¹äº†é‡å¤çš„æ¶ˆæ¯ã€‚</p>
<p><strong>è§£å†³æ€è·¯</strong> </p>
<p>â€‹		MQ æ¶ˆè´¹è€…çš„å¹‚ç­‰æ€§çš„è§£å†³ä¸€èˆ¬ä½¿ç”¨å…¨å±€ ID æˆ–è€…å†™ä¸ªå”¯ä¸€æ ‡è¯†æ¯”å¦‚æ—¶é—´æˆ³ æˆ–è€… UUID æˆ–è€…è®¢å•æ¶ˆè´¹ è€…æ¶ˆè´¹ MQ ä¸­çš„æ¶ˆæ¯ä¹Ÿå¯åˆ©ç”¨ MQ çš„è¯¥ id æ¥åˆ¤æ–­ï¼Œæˆ–è€…å¯æŒ‰è‡ªå·±çš„è§„åˆ™ç”Ÿæˆä¸€ä¸ªå…¨å±€å”¯ä¸€ idï¼Œæ¯æ¬¡æ¶ˆè´¹æ¶ˆ æ¯æ—¶ç”¨è¯¥ id å…ˆåˆ¤æ–­è¯¥æ¶ˆæ¯æ˜¯å¦å·²æ¶ˆè´¹è¿‡ã€‚</p>
<p><strong>æ¶ˆè´¹ç«¯çš„å¹‚ç­‰æ€§ä¿éšœ</strong> </p>
<p>â€‹		åœ¨æµ·é‡è®¢å•ç”Ÿæˆçš„ä¸šåŠ¡é«˜å³°æœŸï¼Œç”Ÿäº§ç«¯æœ‰å¯èƒ½å°±ä¼šé‡å¤å‘ç”Ÿäº†æ¶ˆæ¯ï¼Œè¿™æ—¶å€™æ¶ˆè´¹ç«¯å°±è¦å®ç°å¹‚ç­‰æ€§ï¼Œ è¿™å°±æ„å‘³ç€æˆ‘ä»¬çš„æ¶ˆæ¯æ°¸è¿œä¸ä¼šè¢«æ¶ˆè´¹å¤šæ¬¡ï¼Œå³ä½¿æˆ‘ä»¬æ”¶åˆ°äº†ä¸€æ ·çš„æ¶ˆæ¯ã€‚ä¸šç•Œä¸»æµçš„å¹‚ç­‰æ€§æœ‰ä¸¤ç§æ“ä½œï¼ša. å”¯ä¸€ ID+æŒ‡çº¹ç æœºåˆ¶,åˆ©ç”¨æ•°æ®åº“ä¸»é”®å»é‡, b.åˆ©ç”¨ redis çš„åŸå­æ€§å»å®ç°ã€‚</p>
<p><strong>å”¯ä¸€ ID+æŒ‡çº¹ç æœºåˆ¶</strong></p>
<p>â€‹		æŒ‡çº¹ç ï¼šæˆ‘ä»¬çš„ä¸€äº›è§„åˆ™æˆ–è€…æ—¶é—´æˆ³åŠ åˆ«çš„æœåŠ¡ç»™åˆ°çš„å”¯ä¸€ä¿¡æ¯ç ,å®ƒå¹¶ä¸ä¸€å®šæ˜¯æˆ‘ä»¬ç³»ç»Ÿç”Ÿæˆçš„ï¼ŒåŸºæœ¬éƒ½æ˜¯ç”±æˆ‘ä»¬çš„ä¸šåŠ¡è§„åˆ™æ‹¼æ¥è€Œæ¥ï¼Œä½†æ˜¯ä¸€å®šè¦ä¿è¯å”¯ä¸€æ€§ï¼Œç„¶åå°±åˆ©ç”¨æŸ¥è¯¢è¯­å¥è¿›è¡Œåˆ¤æ–­è¿™ä¸ª id æ˜¯å¦å­˜åœ¨æ•°æ®åº“ä¸­ï¼Œä¼˜åŠ¿å°±æ˜¯å®ç°ç®€å•å°±ä¸€ä¸ªæ‹¼æ¥ï¼Œç„¶åæŸ¥è¯¢åˆ¤æ–­æ˜¯å¦é‡å¤ï¼›åŠ£åŠ¿å°±æ˜¯åœ¨é«˜å¹¶å‘æ—¶ï¼Œå¦‚æœæ˜¯å•ä¸ªæ•°æ®åº“å°±ä¼šæœ‰å†™å…¥æ€§èƒ½ç“¶é¢ˆå½“ç„¶ä¹Ÿå¯ä»¥é‡‡ç”¨åˆ†åº“åˆ†è¡¨æå‡æ€§èƒ½ï¼Œä½†ä¹Ÿä¸æ˜¯æˆ‘ä»¬æœ€æ¨èçš„æ–¹å¼ã€‚ </p>
<p><strong>Redis åŸå­æ€§</strong></p>
<p>â€‹		åˆ©ç”¨ redis æ‰§è¡Œ setnx å‘½ä»¤ï¼Œå¤©ç„¶å…·æœ‰å¹‚ç­‰æ€§ã€‚ä»è€Œå®ç°ä¸é‡å¤æ¶ˆè´¹ã€‚</p>
</blockquote>
<h4 id="ä¼˜å…ˆçº§é˜Ÿåˆ—"><a href="#ä¼˜å…ˆçº§é˜Ÿåˆ—" class="headerlink" title="ä¼˜å…ˆçº§é˜Ÿåˆ—"></a>ä¼˜å…ˆçº§é˜Ÿåˆ—</h4><h5 id="ä½¿ç”¨åœºæ™¯"><a href="#ä½¿ç”¨åœºæ™¯" class="headerlink" title="ä½¿ç”¨åœºæ™¯"></a>ä½¿ç”¨åœºæ™¯</h5><blockquote>
<p>â€‹		åœ¨æˆ‘ä»¬ç³»ç»Ÿä¸­æœ‰ä¸€ä¸ªè®¢å•å‚¬ä»˜çš„åœºæ™¯ï¼Œæˆ‘ä»¬çš„å®¢æˆ·åœ¨å¤©çŒ«ä¸‹çš„è®¢å•,æ·˜å®ä¼šåŠæ—¶å°†è®¢å•æ¨é€ç»™æˆ‘ä»¬ï¼Œå¦‚æœåœ¨ç”¨æˆ·è®¾å®šçš„æ—¶é—´å†…æœªä»˜æ¬¾é‚£ä¹ˆå°±ä¼šç»™ç”¨æˆ·æ¨é€ä¸€æ¡çŸ­ä¿¡æé†’ï¼Œå¾ˆç®€å•çš„ä¸€ä¸ªåŠŸèƒ½å¯¹å§ï¼Œä½†æ˜¯ï¼Œtmall å•†å®¶å¯¹æˆ‘ä»¬æ¥è¯´ï¼Œè‚¯å®šæ˜¯è¦åˆ†å¤§å®¢æˆ·å’Œå°å®¢æˆ·çš„å¯¹å§ï¼Œæ¯”å¦‚åƒè‹¹æœï¼Œå°ç±³è¿™æ ·å¤§å•†å®¶ä¸€å¹´èµ·ç èƒ½ç»™æˆ‘ä»¬åˆ›é€ å¾ˆå¤§çš„åˆ©æ¶¦ï¼Œæ‰€ä»¥ç†åº”å½“ç„¶ï¼Œä»–ä»¬çš„è®¢å•å¿…é¡»å¾—åˆ°ä¼˜å…ˆå¤„ç†ï¼Œè€Œæ›¾ç»æˆ‘ä»¬çš„åç«¯ç³»ç»Ÿæ˜¯ä½¿ç”¨ redis æ¥å­˜æ”¾çš„å®šæ—¶è½®è¯¢ï¼Œå¤§å®¶éƒ½çŸ¥é“ redis åªèƒ½ç”¨ List åšä¸€ä¸ªç®€ç®€å•å•çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¹¶ä¸èƒ½å®ç°ä¸€ä¸ªä¼˜å…ˆçº§çš„åœºæ™¯ï¼Œæ‰€ä»¥è®¢å•é‡å¤§äº†åé‡‡ç”¨ RabbitMQ è¿›è¡Œæ”¹é€ å’Œä¼˜åŒ–,å¦‚æœå‘ç°æ˜¯å¤§å®¢æˆ·çš„è®¢å•ç»™ä¸€ä¸ªç›¸å¯¹æ¯”è¾ƒé«˜çš„ä¼˜å…ˆçº§ï¼Œ å¦åˆ™å°±æ˜¯é»˜è®¤ä¼˜å…ˆçº§ã€‚</p>
</blockquote>
<h5 id="å¦‚ä½•æ·»åŠ "><a href="#å¦‚ä½•æ·»åŠ " class="headerlink" title="å¦‚ä½•æ·»åŠ "></a>å¦‚ä½•æ·»åŠ </h5><p><strong>æ§åˆ¶å°é¡µé¢æ·»åŠ </strong></p>
<img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221019173732175.png" alt="image-20221019173732175" style="zoom:80%;">

<p><strong>é˜Ÿåˆ—ä¸­ä»£ç æ·»åŠ ä¼˜å…ˆçº§</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, Object&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">params.put(<span class="string">&quot;x-max-priority&quot;</span>, <span class="number">10</span>);</span><br><span class="line">channel.queueDeclare(<span class="string">&quot;hello&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, params);</span><br></pre></td></tr></table></figure>

<p><strong>æ¶ˆæ¯ä¸­ä»£ç æ·»åŠ ä¼˜å…ˆçº§</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AMQP.<span class="type">BasicProperties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AMQP</span>.BasicProperties().builder().priority(<span class="number">5</span>).build();</span><br></pre></td></tr></table></figure>

<p><strong>æ³¨æ„äº‹é¡¹</strong></p>
<blockquote>
<p>â€‹		è¦è®©é˜Ÿåˆ—å®ç°ä¼˜å…ˆçº§éœ€è¦åšçš„äº‹æƒ…æœ‰å¦‚ä¸‹äº‹æƒ…:é˜Ÿåˆ—éœ€è¦è®¾ç½®ä¸ºä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œæ¶ˆæ¯éœ€è¦è®¾ç½®æ¶ˆæ¯çš„ä¼˜å…ˆ çº§ï¼Œæ¶ˆè´¹è€…éœ€è¦ç­‰å¾…æ¶ˆæ¯å·²ç»å‘é€åˆ°é˜Ÿåˆ—ä¸­æ‰å»æ¶ˆè´¹å› ä¸ºï¼Œè¿™æ ·æ‰æœ‰æœºä¼šå¯¹æ¶ˆæ¯è¿›è¡Œæ’åºã€‚</p>
</blockquote>
<h5 id="åº”ç”¨å®ä¾‹"><a href="#åº”ç”¨å®ä¾‹" class="headerlink" title="åº”ç”¨å®ä¾‹"></a>åº”ç”¨å®ä¾‹</h5><p>ç”Ÿäº§è€…ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitConnectUtil.getChannel();) &#123;</span><br><span class="line">            <span class="comment">//ç»™æ¶ˆæ¯èµ‹äºˆä¸€ä¸ª priority å±æ€§</span></span><br><span class="line">            AMQP.<span class="type">BasicProperties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line">                    <span class="title class_">AMQP</span>.BasicProperties().builder().priority(<span class="number">5</span>).build();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; <span class="number">11</span>; i++) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;info&quot;</span> + i;</span><br><span class="line">                <span class="keyword">if</span> (i == <span class="number">5</span>) &#123;</span><br><span class="line">                    channel.basicPublish(<span class="string">&quot;&quot;</span>, QUEUE_NAME, properties, message.getBytes());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    channel.basicPublish(<span class="string">&quot;&quot;</span>, QUEUE_NAME, <span class="literal">null</span>, message.getBytes());</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">&quot;å‘é€æ¶ˆæ¯å®Œæˆ:&quot;</span> + message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¶ˆè´¹è€…ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitConnectUtil.getChannel();</span><br><span class="line">        <span class="comment">//è®¾ç½®é˜Ÿåˆ—çš„æœ€å¤§ä¼˜å…ˆçº§ æœ€å¤§å¯ä»¥è®¾ç½®åˆ° 255 å®˜ç½‘æ¨è 1-10 å¦‚æœè®¾ç½®å¤ªé«˜æ¯”è¾ƒåƒå†…å­˜å’Œ CPU</span></span><br><span class="line">        Map&lt;String, Object&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        params.put(<span class="string">&quot;x-max-priority&quot;</span>, <span class="number">10</span>);</span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, params);</span><br><span class="line">        System.out.println(<span class="string">&quot;æ¶ˆè´¹è€…å¯åŠ¨ç­‰å¾…æ¶ˆè´¹......&quot;</span>);</span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> (consumerTag, delivery) -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">receivedMessage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody());</span><br><span class="line">            System.out.println(<span class="string">&quot;æ¥æ”¶åˆ°æ¶ˆæ¯:&quot;</span> + receivedMessage);</span><br><span class="line">        &#125;;</span><br><span class="line">        channel.basicConsume(QUEUE_NAME, <span class="literal">true</span>, deliverCallback, (consumerTag) -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;æ¶ˆè´¹è€…æ— æ³•æ¶ˆè´¹æ¶ˆæ¯æ—¶è°ƒç”¨ï¼Œå¦‚é˜Ÿåˆ—è¢«åˆ é™¤&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="æƒ°æ€§é˜Ÿåˆ—"><a href="#æƒ°æ€§é˜Ÿåˆ—" class="headerlink" title="æƒ°æ€§é˜Ÿåˆ—"></a>æƒ°æ€§é˜Ÿåˆ—</h4><h5 id="ä½¿ç”¨åœºæ™¯-1"><a href="#ä½¿ç”¨åœºæ™¯-1" class="headerlink" title="ä½¿ç”¨åœºæ™¯"></a>ä½¿ç”¨åœºæ™¯</h5><blockquote>
<p>RabbitMQ ä» 3.6.0 ç‰ˆæœ¬å¼€å§‹å¼•å…¥äº†æƒ°æ€§é˜Ÿåˆ—çš„æ¦‚å¿µã€‚æƒ°æ€§é˜Ÿåˆ—ä¼šå°½å¯èƒ½çš„å°†æ¶ˆæ¯å­˜å…¥ç£ç›˜ä¸­ï¼Œè€Œåœ¨æ¶ˆè´¹è€…æ¶ˆè´¹åˆ°ç›¸åº”çš„æ¶ˆæ¯æ—¶æ‰ä¼šè¢«åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå®ƒçš„ä¸€ä¸ªé‡è¦çš„è®¾è®¡ç›®æ ‡æ˜¯èƒ½å¤Ÿæ”¯æŒæ›´é•¿çš„é˜Ÿåˆ—ï¼Œå³æ”¯æŒæ›´å¤šçš„æ¶ˆæ¯å­˜å‚¨ã€‚å½“æ¶ˆè´¹è€…ç”±äºå„ç§å„æ ·çš„åŸå› ï¼ˆæ¯”å¦‚æ¶ˆè´¹è€…ä¸‹çº¿ã€å®•æœºäº¦æˆ–è€…æ˜¯ç”±äºç»´æŠ¤è€Œå…³é—­ç­‰ï¼‰è€Œè‡´ä½¿é•¿æ—¶é—´å†…ä¸èƒ½æ¶ˆè´¹æ¶ˆæ¯é€ æˆå †ç§¯æ—¶ï¼Œæƒ°æ€§é˜Ÿåˆ—å°±å¾ˆæœ‰å¿…è¦äº†ã€‚ </p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“ç”Ÿäº§è€…å°†æ¶ˆæ¯å‘é€åˆ° RabbitMQ çš„æ—¶å€™ï¼Œé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ä¼šå°½å¯èƒ½çš„å­˜å‚¨åœ¨å†…å­˜ä¹‹ä¸­ï¼Œ è¿™æ ·å¯ä»¥æ›´åŠ å¿«é€Ÿçš„å°†æ¶ˆæ¯å‘é€ç»™æ¶ˆè´¹è€…ã€‚å³ä½¿æ˜¯æŒä¹…åŒ–çš„æ¶ˆæ¯ï¼Œåœ¨è¢«å†™å…¥ç£ç›˜çš„åŒæ—¶ä¹Ÿä¼šåœ¨å†…å­˜ä¸­é©»ç•™ ä¸€ä»½å¤‡ä»½ã€‚å½“ RabbitMQ éœ€è¦é‡Šæ”¾å†…å­˜çš„æ—¶å€™ï¼Œä¼šå°†å†…å­˜ä¸­çš„æ¶ˆæ¯æ¢é¡µè‡³ç£ç›˜ä¸­ï¼Œè¿™ä¸ªæ“ä½œä¼šè€—è´¹è¾ƒé•¿çš„æ—¶é—´ï¼Œä¹Ÿä¼šé˜»å¡é˜Ÿåˆ—çš„æ“ä½œï¼Œè¿›è€Œæ— æ³•æ¥æ”¶æ–°çš„æ¶ˆæ¯ã€‚è™½ç„¶ RabbitMQ çš„å¼€å‘è€…ä»¬ä¸€ç›´åœ¨å‡çº§ç›¸å…³çš„ç®—æ³•ï¼Œ ä½†æ˜¯æ•ˆæœå§‹ç»ˆä¸å¤ªç†æƒ³ï¼Œå°¤å…¶æ˜¯åœ¨æ¶ˆæ¯é‡ç‰¹åˆ«å¤§çš„æ—¶å€™ã€‚</p>
</blockquote>
<h5 id="ä¸¤ç§æ¨¡å¼"><a href="#ä¸¤ç§æ¨¡å¼" class="headerlink" title="ä¸¤ç§æ¨¡å¼"></a>ä¸¤ç§æ¨¡å¼</h5><blockquote>
<p>é˜Ÿåˆ—å…·å¤‡ä¸¤ç§æ¨¡å¼ï¼šdefault å’Œ lazyã€‚é»˜è®¤çš„ä¸º default æ¨¡å¼ï¼Œåœ¨ 3.6.0 ä¹‹å‰çš„ç‰ˆæœ¬æ— éœ€åšä»»ä½•å˜æ›´ã€‚lazy æ¨¡å¼å³ä¸ºæƒ°æ€§é˜Ÿåˆ—çš„æ¨¡å¼ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨ channel.queueDeclare æ–¹æ³•çš„æ—¶å€™åœ¨å‚æ•°ä¸­è®¾ç½®ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ Policy çš„æ–¹å¼è®¾ç½®ï¼Œå¦‚æœä¸€ä¸ªé˜Ÿåˆ—åŒæ—¶ä½¿ç”¨è¿™ä¸¤ç§æ–¹å¼è®¾ç½®çš„è¯ï¼Œé‚£ä¹ˆ Policy çš„æ–¹å¼å…·å¤‡æ›´é«˜çš„ä¼˜å…ˆçº§ã€‚ å¦‚æœè¦é€šè¿‡å£°æ˜çš„æ–¹å¼æ”¹å˜å·²æœ‰é˜Ÿåˆ—çš„æ¨¡å¼çš„è¯ï¼Œé‚£ä¹ˆåªèƒ½å…ˆåˆ é™¤é˜Ÿåˆ—ï¼Œç„¶åå†é‡æ–°å£°æ˜ä¸€ä¸ªæ–°çš„ã€‚ åœ¨é˜Ÿåˆ—å£°æ˜çš„æ—¶å€™å¯ä»¥é€šè¿‡â€œx-queue-modeâ€å‚æ•°æ¥è®¾ç½®é˜Ÿåˆ—çš„æ¨¡å¼ï¼Œå–å€¼ä¸ºâ€œdefaultâ€å’Œâ€œlazyâ€ã€‚ä¸‹é¢ç¤ºä¾‹ä¸­æ¼”ç¤ºäº†ä¸€ä¸ªæƒ°æ€§é˜Ÿåˆ—çš„å£°æ˜ç»†èŠ‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, Object&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">args.put(<span class="string">&quot;x-queue-mode&quot;</span>, <span class="string">&quot;lazy&quot;</span>);</span><br><span class="line">channel.queueDeclare(<span class="string">&quot;myqueue&quot;</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, args);</span><br></pre></td></tr></table></figure>
</blockquote>
<h5 id="å†…å­˜å¼€é”€å¯¹æ¯”"><a href="#å†…å­˜å¼€é”€å¯¹æ¯”" class="headerlink" title="å†…å­˜å¼€é”€å¯¹æ¯”"></a>å†…å­˜å¼€é”€å¯¹æ¯”</h5><img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221019174449152.png" alt="image-20221019174449152" style="zoom:80%;">

<p>â€‹	åœ¨å‘é€ 1 ç™¾ä¸‡æ¡æ¶ˆæ¯ï¼Œæ¯æ¡æ¶ˆæ¯å¤§æ¦‚å  1KB çš„æƒ…å†µä¸‹ï¼Œæ™®é€šé˜Ÿåˆ—å ç”¨å†…å­˜æ˜¯ 1.2GBï¼Œè€Œæƒ°æ€§é˜Ÿåˆ—ä»…ä»… å ç”¨ 1.5MBã€‚</p>
<h3 id="RabbitMQ-é›†ç¾¤"><a href="#RabbitMQ-é›†ç¾¤" class="headerlink" title="RabbitMQ é›†ç¾¤"></a>RabbitMQ é›†ç¾¤</h3><h4 id="clustering"><a href="#clustering" class="headerlink" title="clustering"></a>clustering</h4><h5 id="ä½¿ç”¨é›†ç¾¤çš„åŸå› "><a href="#ä½¿ç”¨é›†ç¾¤çš„åŸå› " class="headerlink" title="ä½¿ç”¨é›†ç¾¤çš„åŸå› "></a>ä½¿ç”¨é›†ç¾¤çš„åŸå› </h5><blockquote>
<p>æœ€å¼€å§‹æˆ‘ä»¬ä»‹ç»äº†å¦‚ä½•å®‰è£…åŠè¿è¡Œ RabbitMQ æœåŠ¡ï¼Œä¸è¿‡è¿™äº›æ˜¯å•æœºç‰ˆçš„ï¼Œæ— æ³•æ»¡è¶³ç›®å‰çœŸå®åº”ç”¨çš„ è¦æ±‚ã€‚å¦‚æœ RabbitMQ æœåŠ¡å™¨é‡åˆ°å†…å­˜å´©æºƒã€æœºå™¨æ‰ç”µæˆ–è€…ä¸»æ¿æ•…éšœç­‰æƒ…å†µï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿå•å° RabbitMQ æœåŠ¡å™¨å¯ä»¥æ»¡è¶³æ¯ç§’ 1000 æ¡æ¶ˆæ¯çš„ååé‡ï¼Œé‚£ä¹ˆå¦‚æœåº”ç”¨éœ€è¦ RabbitMQ æœåŠ¡æ»¡è¶³æ¯ç§’ 10 ä¸‡æ¡æ¶ˆæ¯çš„ååé‡å‘¢ï¼Ÿè´­ä¹°æ˜‚è´µçš„æœåŠ¡å™¨æ¥å¢å¼ºå•æœº RabbitMQ åŠ¡çš„æ€§èƒ½æ˜¾å¾—æ‰è¥Ÿè§è‚˜ï¼Œæ­å»ºä¸€ä¸ª RabbitMQ é›†ç¾¤æ‰æ˜¯ è§£å†³å®é™…é—®é¢˜çš„å…³é”®ã€‚</p>
</blockquote>
<h5 id="æ­å»ºæ­¥éª¤"><a href="#æ­å»ºæ­¥éª¤" class="headerlink" title="æ­å»ºæ­¥éª¤"></a>æ­å»ºæ­¥éª¤</h5><blockquote>
<p>1.ä¿®æ”¹ 3 å°æœºå™¨çš„ä¸»æœºåç§° vim &#x2F;etc&#x2F;hostname 2.é…ç½®å„ä¸ªèŠ‚ç‚¹çš„ hosts æ–‡ä»¶ï¼Œè®©å„ä¸ªèŠ‚ç‚¹éƒ½èƒ½äº’ç›¸è¯†åˆ«å¯¹æ–¹ vim &#x2F;etc&#x2F;hosts 10.211.55.74 node1 10.211.55.75 node2 10.211.55.76 node3</p>
<p>3.ä»¥ç¡®ä¿å„ä¸ªèŠ‚ç‚¹çš„ cookie æ–‡ä»¶ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªå€¼ åœ¨ node1 ä¸Šæ‰§è¡Œè¿œç¨‹æ“ä½œå‘½ä»¤ scp &#x2F;var&#x2F;lib&#x2F;rabbitmq&#x2F;.erlang.cookie root@node2:&#x2F;var&#x2F;lib&#x2F;rabbitmq&#x2F;.erlang.cookie scp &#x2F;var&#x2F;lib&#x2F;rabbitmq&#x2F;.erlang.cookie root@node3:&#x2F;var&#x2F;lib&#x2F;rabbitmq&#x2F;.erlang.cookie 4.å¯åŠ¨ RabbitMQ æœåŠ¡,é¡ºå¸¦å¯åŠ¨ Erlang è™šæ‹Ÿæœºå’Œ RbbitMQ åº”ç”¨æœåŠ¡(åœ¨ä¸‰å°èŠ‚ç‚¹ä¸Šåˆ†åˆ«æ‰§è¡Œä»¥ ä¸‹å‘½ä»¤) rabbitmq-server -detached 5.åœ¨èŠ‚ç‚¹ 2 æ‰§è¡Œ rabbitmqctl stop_app (rabbitmqctl stop ä¼šå°† Erlang è™šæ‹Ÿæœºå…³é—­ï¼Œrabbitmqctl stop_app åªå…³é—­ RabbitMQ æœåŠ¡) rabbitmqctl reset rabbitmqctl join_cluster rabbit@node1 rabbitmqctl start_app(åªå¯åŠ¨åº”ç”¨æœåŠ¡)</p>
<p>6.åœ¨èŠ‚ç‚¹ 3 æ‰§è¡Œ</p>
<p>rabbitmqctl stop_app rabbitmqctl reset rabbitmqctl join_cluster rabbit@node2 rabbitmqctl start_app</p>
<p>7.é›†ç¾¤çŠ¶æ€ rabbitmqctl cluster_status 8.éœ€è¦é‡æ–°è®¾ç½®ç”¨æˆ· åˆ›å»ºè´¦å· rabbitmqctl add_user admin 123 è®¾ç½®ç”¨æˆ·è§’è‰² rabbitmqctl set_user_tags admin administrator è®¾ç½®ç”¨æˆ·æƒé™ rabbitmqctl set_permissions -p â€œ&#x2F;â€œ admin â€œ.<em>â€œ â€œ.</em>â€œ â€œ.*â€ 9.è§£é™¤é›†ç¾¤èŠ‚ç‚¹(node2 å’Œ node3 æœºå™¨åˆ†åˆ«æ‰§è¡Œ)</p>
<p>rabbitmqctl stop_app rabbitmqctl reset rabbitmqctl start_app rabbitmqctl cluster_status rabbitmqctl forget_cluster_node rabbit@node2(node1 æœºå™¨ä¸Šæ‰§è¡Œ)</p>
</blockquote>
<h4 id="é•œåƒé˜Ÿåˆ—"><a href="#é•œåƒé˜Ÿåˆ—" class="headerlink" title="é•œåƒé˜Ÿåˆ—"></a>é•œåƒé˜Ÿåˆ—</h4><h5 id="ä½¿ç”¨é•œåƒçš„åŸå› "><a href="#ä½¿ç”¨é•œåƒçš„åŸå› " class="headerlink" title="ä½¿ç”¨é•œåƒçš„åŸå› "></a>ä½¿ç”¨é•œåƒçš„åŸå› </h5><blockquote>
<p>å¦‚æœ RabbitMQ é›†ç¾¤ä¸­åªæœ‰ä¸€ä¸ª Broker èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¯¥èŠ‚ç‚¹çš„å¤±æ•ˆå°†å¯¼è‡´æ•´ä½“æœåŠ¡çš„ä¸´æ—¶æ€§ä¸å¯ç”¨ï¼Œå¹¶ ä¸”ä¹Ÿå¯èƒ½ä¼šå¯¼è‡´æ¶ˆæ¯çš„ä¸¢å¤±ã€‚å¯ä»¥å°†æ‰€æœ‰æ¶ˆæ¯éƒ½è®¾ç½®ä¸ºæŒä¹…åŒ–ï¼Œå¹¶ä¸”å¯¹åº”é˜Ÿåˆ—çš„durableå±æ€§ä¹Ÿè®¾ç½®ä¸ºtrueï¼Œ ä½†æ˜¯è¿™æ ·ä»ç„¶æ— æ³•é¿å…ç”±äºç¼“å­˜å¯¼è‡´çš„é—®é¢˜ï¼šå› ä¸ºæ¶ˆæ¯åœ¨å‘é€ä¹‹åå’Œè¢«å†™å…¥ç£ç›˜äº•æ‰§è¡Œåˆ·ç›˜åŠ¨ä½œä¹‹é—´å­˜åœ¨ ä¸€ä¸ªçŸ­æš‚å´ä¼šäº§ç”Ÿé—®é¢˜çš„æ—¶é—´çª—ã€‚é€šè¿‡ publisherconfirm æœºåˆ¶èƒ½å¤Ÿç¡®ä¿å®¢æˆ·ç«¯çŸ¥é“å“ªäº›æ¶ˆæ¯å·±ç»å­˜å…¥ç£ç›˜ï¼Œ å°½ç®¡å¦‚æ­¤ï¼Œä¸€èˆ¬ä¸å¸Œæœ›é‡åˆ°å› å•ç‚¹æ•…éšœå¯¼è‡´çš„æœåŠ¡ä¸å¯ç”¨ã€‚</p>
<p>å¼•å…¥é•œåƒé˜Ÿåˆ—(Mirror Queue)çš„æœºåˆ¶ï¼Œå¯ä»¥å°†é˜Ÿåˆ—é•œåƒåˆ°é›†ç¾¤ä¸­çš„å…¶ä»– Broker èŠ‚ç‚¹ä¹‹ä¸Šï¼Œå¦‚æœé›†ç¾¤ä¸­ çš„ä¸€ä¸ªèŠ‚ç‚¹å¤±æ•ˆäº†ï¼Œé˜Ÿåˆ—èƒ½è‡ªåŠ¨åœ°åˆ‡æ¢åˆ°é•œåƒä¸­çš„å¦ä¸€ä¸ªèŠ‚ç‚¹ä¸Šä»¥ä¿è¯æœåŠ¡çš„å¯ç”¨æ€§ã€‚</p>
</blockquote>
<h5 id="æ­å»ºæ­¥éª¤-1"><a href="#æ­å»ºæ­¥éª¤-1" class="headerlink" title="æ­å»ºæ­¥éª¤"></a>æ­å»ºæ­¥éª¤</h5><blockquote>
<p>1.å¯åŠ¨ä¸‰å°é›†ç¾¤èŠ‚ç‚¹ 2.éšä¾¿æ‰¾ä¸€ä¸ªèŠ‚ç‚¹æ·»åŠ  policy</p>
<img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221019175905823.png" alt="image-20221019175905823" style="zoom:67%;">

<p>3.åœ¨ node1 ä¸Šåˆ›å»ºä¸€ä¸ªé˜Ÿåˆ—å‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œé˜Ÿåˆ—å­˜åœ¨é•œåƒé˜Ÿåˆ—</p>
<img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221019175923182.png" alt="image-20221019175923182" style="zoom:60%;">

<p>4.åœæ‰ node1 ä¹‹åå‘ç° node2 æˆä¸ºé•œåƒé˜Ÿåˆ—</p>
<p>5.å°±ç®—æ•´ä¸ªé›†ç¾¤åªå‰©ä¸‹ä¸€å°æœºå™¨äº† ä¾ç„¶èƒ½æ¶ˆè´¹é˜Ÿåˆ—é‡Œé¢çš„æ¶ˆæ¯ è¯´æ˜é˜Ÿåˆ—é‡Œé¢çš„æ¶ˆæ¯è¢«é•œåƒé˜Ÿåˆ—ä¼ é€’åˆ°ç›¸åº”æœºå™¨é‡Œé¢äº†</p>
<img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221019175951448.png" alt="image-20221019175951448" style="zoom:50%;">
</blockquote>
<h4 id="Haproxy-Keepalive-å®ç°é«˜å¯ç”¨è´Ÿè½½å‡è¡¡"><a href="#Haproxy-Keepalive-å®ç°é«˜å¯ç”¨è´Ÿè½½å‡è¡¡" class="headerlink" title="Haproxy+Keepalive å®ç°é«˜å¯ç”¨è´Ÿè½½å‡è¡¡"></a>Haproxy+Keepalive å®ç°é«˜å¯ç”¨è´Ÿè½½å‡è¡¡</h4><h5 id="æ¶æ„å›¾"><a href="#æ¶æ„å›¾" class="headerlink" title="æ¶æ„å›¾"></a>æ¶æ„å›¾</h5><img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221019175419543.png" alt="image-20221019175419543" style="zoom:67%;">

<h5 id="Haproxy-å®ç°è´Ÿè½½å‡è¡¡"><a href="#Haproxy-å®ç°è´Ÿè½½å‡è¡¡" class="headerlink" title="Haproxy å®ç°è´Ÿè½½å‡è¡¡"></a>Haproxy å®ç°è´Ÿè½½å‡è¡¡</h5><blockquote>
<p>HAProxy æä¾›é«˜å¯ç”¨æ€§ã€è´Ÿè½½å‡è¡¡åŠåŸºäº TCPHTTP åº”ç”¨çš„ä»£ç†ï¼Œæ”¯æŒè™šæ‹Ÿä¸»æœºï¼Œå®ƒæ˜¯å…è´¹ã€å¿«é€Ÿå¹¶ ä¸”å¯é çš„ä¸€ç§è§£å†³æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ Twitter,Reddit,StackOverflow,GitHub åœ¨å†…çš„å¤šå®¶çŸ¥åäº’è”ç½‘å…¬å¸åœ¨ä½¿ç”¨ã€‚ HAProxy å®ç°äº†ä¸€ç§äº‹ä»¶é©±åŠ¨ã€å•ä¸€è¿›ç¨‹æ¨¡å‹ï¼Œæ­¤æ¨¡å‹æ”¯æŒéå¸¸å¤§çš„äº•å‘è¿æ¥æ•°ã€‚ </p>
<p>æ‰©å±• nginx,lvs,haproxy ä¹‹é—´çš„åŒºåˆ«ï¼š<a target="_blank" rel="noopener" href="http://www.ha97.com/5646.html">http://www.ha97.com/5646.html</a></p>
</blockquote>
<h5 id="æ­å»ºæ­¥éª¤-2"><a href="#æ­å»ºæ­¥éª¤-2" class="headerlink" title="æ­å»ºæ­¥éª¤"></a>æ­å»ºæ­¥éª¤</h5><blockquote>
<p>1.ä¸‹è½½ haproxy(åœ¨ node1 å’Œ node2) yum -y install haproxy</p>
<p>2.ä¿®æ”¹ node1 å’Œ node2 çš„ haproxy.cfg</p>
<p>vim &#x2F;etc&#x2F;haproxy&#x2F;haproxy.cfg éœ€è¦ä¿®æ”¹çº¢è‰² IP ä¸ºå½“å‰æœºå™¨ IP</p>
<p>3.åœ¨ä¸¤å°èŠ‚ç‚¹å¯åŠ¨ haproxy haproxy -f &#x2F;etc&#x2F;haproxy&#x2F;haproxy.cfg ps -ef | grep haproxy </p>
<p>4.è®¿é—®åœ°å€ <a target="_blank" rel="noopener" href="http://10.211.55.71:8888/stats">http://10.211.55.71:8888/stats</a></p>
</blockquote>
<h5 id="Keepalived-å®ç°åŒæœº-ä¸»å¤‡-çƒ­å¤‡"><a href="#Keepalived-å®ç°åŒæœº-ä¸»å¤‡-çƒ­å¤‡" class="headerlink" title="Keepalived å®ç°åŒæœº(ä¸»å¤‡)çƒ­å¤‡"></a>Keepalived å®ç°åŒæœº(ä¸»å¤‡)çƒ­å¤‡</h5><blockquote>
<p>è¯•æƒ³å¦‚æœå‰é¢é…ç½®çš„ HAProxy ä¸»æœºçªç„¶å®•æœºæˆ–è€…ç½‘å¡å¤±æ•ˆï¼Œé‚£ä¹ˆè™½ç„¶ RbbitMQ é›†ç¾¤æ²¡æœ‰ä»»ä½•æ•…éšœä½†æ˜¯ å¯¹äºå¤–ç•Œçš„å®¢æˆ·ç«¯æ¥è¯´æ‰€æœ‰çš„è¿æ¥éƒ½ä¼šè¢«æ–­å¼€ç»“æœå°†æ˜¯ç¾éš¾æ€§çš„ä¸ºäº†ç¡®ä¿è´Ÿè½½å‡è¡¡æœåŠ¡çš„å¯é æ€§åŒæ ·æ˜¾å¾— ååˆ†é‡è¦ï¼Œè¿™é‡Œå°±è¦å¼•å…¥ Keepalived å®ƒèƒ½å¤Ÿé€šè¿‡è‡ªèº«å¥åº·æ£€æŸ¥ã€èµ„æºæ¥ç®¡åŠŸèƒ½åšé«˜å¯ç”¨(åŒæœºçƒ­å¤‡)ï¼Œå®ç°æ•…éšœè½¬ç§»ã€‚</p>
</blockquote>
<h5 id="æ­å»ºæ­¥éª¤-3"><a href="#æ­å»ºæ­¥éª¤-3" class="headerlink" title="æ­å»ºæ­¥éª¤"></a>æ­å»ºæ­¥éª¤</h5><blockquote>
<p>1.ä¸‹è½½ keepalived yum -y install keepalived </p>
<p>2.èŠ‚ç‚¹ node1 é…ç½®æ–‡ä»¶ vim &#x2F;etc&#x2F;keepalived&#x2F;keepalived.conf æŠŠèµ„æ–™é‡Œé¢çš„ keepalived.conf ä¿®æ”¹ä¹‹åæ›¿æ¢ </p>
<p>3.èŠ‚ç‚¹ node2 é…ç½®æ–‡ä»¶ éœ€è¦ä¿®æ”¹ global_defs çš„ router_id,å¦‚:nodeB å…¶æ¬¡è¦ä¿®æ”¹ vrrp_instance_VI ä¸­ state ä¸ºâ€BACKUPâ€ï¼› æœ€åè¦å°† priority è®¾ç½®ä¸ºå°äº 100 çš„å€¼ </p>
<p>4.æ·»åŠ  haproxy_chk.sh (ä¸ºäº†é˜²æ­¢ HAProxy æœåŠ¡æŒ‚æ‰ä¹‹å Keepalived è¿˜åœ¨æ­£å¸¸å·¥ä½œè€Œæ²¡æœ‰åˆ‡æ¢åˆ° Backup ä¸Šï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦ç¼–å†™ä¸€ä¸ªè„šæœ¬æ¥æ£€æµ‹ HAProxy åŠ¡çš„çŠ¶æ€,å½“ HAProxy æœåŠ¡æŒ‚æ‰ä¹‹åè¯¥è„šæœ¬ä¼šè‡ªåŠ¨é‡å¯ HAProxy çš„æœåŠ¡ï¼Œå¦‚æœä¸æˆåŠŸåˆ™å…³é—­ Keepalived æœåŠ¡ï¼Œè¿™æ ·ä¾¿å¯ä»¥åˆ‡æ¢åˆ° Backup ç»§ç»­å·¥ä½œ) vim &#x2F;etc&#x2F;keepalived&#x2F;haproxy_chk.sh(å¯ä»¥ç›´æ¥ä¸Šä¼ æ–‡ä»¶) ä¿®æ”¹æƒé™ chmod 777 &#x2F;etc&#x2F;keepalived&#x2F;haproxy_chk.sh </p>
<p>5.å¯åŠ¨ keepalive å‘½ä»¤(node1 å’Œ node2 å¯åŠ¨) systemctl start keepalived </p>
<p>6.è§‚å¯Ÿ Keepalived çš„æ—¥å¿— tail -f &#x2F;var&#x2F;log&#x2F;messages -n 200 </p>
<p>7.è§‚å¯Ÿæœ€æ–°æ·»åŠ çš„ vip ip add show </p>
<p>8.node1 æ¨¡æ‹Ÿ keepalived å…³é—­çŠ¶æ€ systemctl stop keepalived </p>
<p>9.ä½¿ç”¨ vip åœ°å€æ¥è®¿é—® rabbitmq é›†ç¾¤</p>
</blockquote>
<h4 id="Federation-Exchange"><a href="#Federation-Exchange" class="headerlink" title="Federation Exchange"></a>Federation Exchange</h4><h5 id="ä½¿ç”¨å®ƒçš„åŸå› "><a href="#ä½¿ç”¨å®ƒçš„åŸå› " class="headerlink" title="ä½¿ç”¨å®ƒçš„åŸå› "></a>ä½¿ç”¨å®ƒçš„åŸå› </h5><blockquote>
<p>(broker åŒ—äº¬)ï¼Œ(broker æ·±åœ³)å½¼æ­¤ä¹‹é—´ç›¸è·ç”šè¿œï¼Œç½‘ç»œå»¶è¿Ÿæ˜¯ä¸€ä¸ªä¸å¾—ä¸é¢å¯¹çš„é—®é¢˜ã€‚æœ‰ä¸€ä¸ªåœ¨åŒ—äº¬ çš„ä¸šåŠ¡(Client åŒ—äº¬) éœ€è¦è¿æ¥(broker åŒ—äº¬)ï¼Œå‘å…¶ä¸­çš„äº¤æ¢å™¨ exchangeA å‘é€æ¶ˆæ¯ï¼Œæ­¤æ—¶çš„ç½‘ç»œå»¶è¿Ÿå¾ˆå°ï¼Œ (Client åŒ—äº¬)å¯ä»¥è¿…é€Ÿå°†æ¶ˆæ¯å‘é€è‡³ exchangeA ä¸­ï¼Œå°±ç®—åœ¨å¼€å¯äº† publisherconfirm æœºåˆ¶æˆ–è€…äº‹åŠ¡æœºåˆ¶çš„ æƒ…å†µä¸‹ï¼Œä¹Ÿå¯ä»¥è¿…é€Ÿæ”¶åˆ°ç¡®è®¤ä¿¡æ¯ã€‚æ­¤æ—¶åˆæœ‰ä¸ªåœ¨æ·±åœ³çš„ä¸šåŠ¡(Client æ·±åœ³)éœ€è¦å‘ exchangeA å‘é€æ¶ˆæ¯ï¼Œ é‚£ä¹ˆ(Client æ·±åœ³) (broker åŒ—äº¬)ä¹‹é—´æœ‰å¾ˆå¤§çš„ç½‘ç»œå»¶è¿Ÿï¼Œ(Client æ·±åœ³) å°†å‘é€æ¶ˆæ¯è‡³ exchangeA ä¼šç»å†ä¸€ å®šçš„å»¶è¿Ÿï¼Œå°¤å…¶æ˜¯åœ¨å¼€å¯äº† publisherconfirm æœºåˆ¶æˆ–è€…äº‹åŠ¡æœºåˆ¶çš„æƒ…å†µä¸‹ï¼Œ(Client æ·±åœ³) ä¼šç­‰å¾…å¾ˆé•¿çš„å»¶ è¿Ÿæ—¶é—´æ¥æ¥æ”¶(broker åŒ—äº¬)çš„ç¡®è®¤ä¿¡æ¯ï¼Œè¿›è€Œå¿…ç„¶é€ æˆè¿™æ¡å‘é€çº¿ç¨‹çš„æ€§èƒ½é™ä½ï¼Œç”šè‡³é€ æˆä¸€å®šç¨‹åº¦ä¸Šçš„ é˜»å¡ã€‚ å°†ä¸šåŠ¡(Client æ·±åœ³)éƒ¨ç½²åˆ°åŒ—äº¬çš„æœºæˆ¿å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯å¦‚æœ(Client æ·±åœ³)è°ƒç”¨çš„å¦äº›æœåŠ¡éƒ½éƒ¨ ç½²åœ¨æ·±åœ³ï¼Œé‚£ä¹ˆåˆä¼šå¼•å‘æ–°çš„æ—¶å»¶é—®é¢˜ï¼Œæ€»ä¸è§å¾—å°†æ‰€æœ‰ä¸šåŠ¡å…¨éƒ¨éƒ¨ç½²åœ¨ä¸€ä¸ªæœºæˆ¿ï¼Œé‚£ä¹ˆå®¹ç¾åˆä½•ä»¥å®ç°ï¼Ÿ è¿™é‡Œä½¿ç”¨ Federation æ’ä»¶å°±å¯ä»¥å¾ˆå¥½åœ°è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221019180047485.png" alt="image-20221019180047485" style="zoom:80%;">
</blockquote>
<h5 id="æ­å»ºæ­¥éª¤-4"><a href="#æ­å»ºæ­¥éª¤-4" class="headerlink" title="æ­å»ºæ­¥éª¤"></a>æ­å»ºæ­¥éª¤</h5><blockquote>
<p>1.éœ€è¦ä¿è¯æ¯å°èŠ‚ç‚¹å•ç‹¬è¿è¡Œ 2.åœ¨æ¯å°æœºå™¨ä¸Šå¼€å¯ federation ç›¸å…³æ’ä»¶ rabbitmq-plugins enable rabbitmq_federation rabbitmq-plugins enable rabbitmq_federation_management 3.åŸç†å›¾(å…ˆè¿è¡Œ consumer åœ¨ node2 åˆ›å»º fed_exchange)</p>
<img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221019180132367.png" alt="image-20221019180132367" style="zoom:80%;">

<p>4.åœ¨ downstream(node2)é…ç½® upstream(node1)</p>
<p><img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221019180156711.png" alt="image-20221019180156711"></p>
<p>4.æ·»åŠ  policy</p>
<p><img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221019180221926.png" alt="image-20221019180221926"></p>
<p>5.æˆåŠŸçš„å‰æ</p>
<p><img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221019180242475.png" alt="image-20221019180242475"></p>
</blockquote>
<h4 id="Federation-Queue"><a href="#Federation-Queue" class="headerlink" title="Federation Queue"></a>Federation Queue</h4><h5 id="ä½¿ç”¨å®ƒçš„åŸå› -1"><a href="#ä½¿ç”¨å®ƒçš„åŸå› -1" class="headerlink" title="ä½¿ç”¨å®ƒçš„åŸå› "></a>ä½¿ç”¨å®ƒçš„åŸå› </h5><blockquote>
<p>è”é‚¦é˜Ÿåˆ—å¯ä»¥åœ¨å¤šä¸ª Broker èŠ‚ç‚¹(æˆ–è€…é›†ç¾¤)ä¹‹é—´ä¸ºå•ä¸ªé˜Ÿåˆ—æä¾›å‡è¡¡è´Ÿè½½çš„åŠŸèƒ½ã€‚ä¸€ä¸ªè”é‚¦é˜Ÿåˆ—å¯ä»¥ è¿æ¥ä¸€ä¸ªæˆ–è€…å¤šä¸ªä¸Šæ¸¸é˜Ÿåˆ—(upstream queue)ï¼Œå¹¶ä»è¿™äº›ä¸Šæ¸¸é˜Ÿåˆ—ä¸­è·å–æ¶ˆæ¯ä»¥æ»¡è¶³æœ¬åœ°æ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯ çš„éœ€æ±‚ã€‚</p>
</blockquote>
<h5 id="æ­å»ºæ­¥éª¤-5"><a href="#æ­å»ºæ­¥éª¤-5" class="headerlink" title="æ­å»ºæ­¥éª¤"></a>æ­å»ºæ­¥éª¤</h5><blockquote>
<p>åŸç†å›¾ï¼š</p>
<img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221019180344936.png" alt="image-20221019180344936" style="zoom:67%;">

<p>æ·»åŠ  upstream(åŒä¸Š)</p>
<p>æ·»åŠ  policy</p>
<img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221019180407746.png" alt="image-20221019180407746" style="zoom:80%;">
</blockquote>
<h4 id="Shovel"><a href="#Shovel" class="headerlink" title="Shovel"></a>Shovel</h4><h5 id="ä½¿ç”¨å®ƒçš„åŸå› -2"><a href="#ä½¿ç”¨å®ƒçš„åŸå› -2" class="headerlink" title="ä½¿ç”¨å®ƒçš„åŸå› "></a>ä½¿ç”¨å®ƒçš„åŸå› </h5><blockquote>
<p>Federation å…·å¤‡çš„æ•°æ®è½¬å‘åŠŸèƒ½ç±»ä¼¼ï¼ŒShovel å¤Ÿå¯é ã€æŒç»­åœ°ä»ä¸€ä¸ª Broker ä¸­çš„é˜Ÿåˆ—(ä½œä¸ºæºç«¯ï¼Œå³ source)æ‹‰å–æ•°æ®å¹¶è½¬å‘è‡³å¦ä¸€ä¸ª Broker ä¸­çš„äº¤æ¢å™¨(ä½œä¸ºç›®çš„ç«¯ï¼Œå³ destination)ã€‚ä½œä¸ºæºç«¯çš„é˜Ÿåˆ—å’Œä½œ ä¸ºç›®çš„ç«¯çš„äº¤æ¢å™¨å¯ä»¥åŒæ—¶ä½äºåŒä¸€ä¸ª Brokerï¼Œä¹Ÿå¯ä»¥ä½äºä¸åŒçš„ Broker ä¸Šã€‚Shovel å¯ä»¥ç¿»è¯‘ä¸ºâ€é“²å­â€ï¼Œ æ˜¯ä¸€ç§æ¯”è¾ƒå½¢è±¡çš„æ¯”å–»ï¼Œè¿™ä¸ªâ€é“²å­â€å¯ä»¥å°†æ¶ˆæ¯ä»ä¸€æ–¹â€é“²å­â€å¦ä¸€æ–¹ã€‚Shovel è¡Œä¸ºå°±åƒä¼˜ç§€çš„å®¢æˆ·ç«¯åº”ç”¨ ç¨‹åºèƒ½å¤Ÿè´Ÿè´£è¿æ¥æºå’Œç›®çš„åœ°ã€è´Ÿè´£æ¶ˆæ¯çš„è¯»å†™åŠè´Ÿè´£è¿æ¥å¤±è´¥é—®é¢˜çš„å¤„ç†ã€‚</p>
</blockquote>
<h5 id="æ­å»ºæ­¥éª¤-6"><a href="#æ­å»ºæ­¥éª¤-6" class="headerlink" title="æ­å»ºæ­¥éª¤"></a>æ­å»ºæ­¥éª¤</h5><blockquote>
<p>1.å¼€å¯æ’ä»¶(éœ€è¦çš„æœºå™¨éƒ½å¼€å¯) rabbitmq-plugins enable rabbitmq_shovel rabbitmq-plugins enable rabbitmq_shovel_management 2.åŸç†å›¾(åœ¨æºå¤´å‘é€çš„æ¶ˆæ¯ç›´æ¥å›è¿›å…¥åˆ°ç›®çš„åœ°é˜Ÿåˆ—)</p>
<img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221019180511955.png" alt="image-20221019180511955" style="zoom:67%;">

<p>æ·»åŠ  shovel æºå’Œç›®çš„åœ° </p>
<img src="/2023/03/20/RabbitMQ/Java\RabbitMQ\RabbitMQ.assets\image-20221019180529256.png" alt="image-20221019180529256" style="zoom:67%;">
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Fei</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">44</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Fei</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
